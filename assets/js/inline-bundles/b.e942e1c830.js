function closeScam(){const t=(new Date).toISOString().slice(0,10);localStorage.setItem("scam_popup_date",t);const e=document.getElementById("scamPopup");e&&(e.style.display="none")}function scrollToCalc(){document.getElementById("calcCard")?.scrollIntoView({behavior:"smooth",block:"start"})}!function(){const t=(new Date).toISOString().slice(0,10);if(localStorage.getItem("scam_popup_date")!==t){const t=document.getElementById("scamPopup");t&&(t.style.display="flex")}}();const CHECKLIST_POOL=["라인 급변 경기(갑자기 내려간 배당)는 이유부터 확인하기","마진(수수료) 높은 경기면 한 단계 보수적으로 접근하기","1회 배팅금은 자본의 1~3% 범위로 제한하기","선발/결장/로테 뉴스 체크 후 배당 변동 재확인하기","연패/연승 팀은 '시장 과열' 구간인지 먼저 보기","변동성 큰 리그는 단폴/소액으로 테스트하기","아시안 라인(푸시) 가능 구간은 '무효 리스크'도 같이 고려하기"];function refreshChecklist(){const t=[...CHECKLIST_POOL].sort(()=>Math.random()-.5).slice(0,3),e=document.getElementById("checklistText");e&&(e.innerHTML="• "+t.join("<br>• "))}refreshChecklist();const LS_KEY="88_analysis_multi_v3",HIST_KEY="88_analysis_history_v1",SNAP_KEY="88_analysis_snaps_v1",SNAP_META_KEY="88_analysis_snaps_meta_v1";let LAST_TEXT="",LAST_ONE_LINE="",LAST_RECORD=null,MAIN_MODE_OVERRIDE=null,__PASTE_MULTI=[],__PASTE_SORT="input",__PASTE_CHAIN_RUNNING=!1,__PASTE_CHAIN_ABORT=!1,__PASTE_SAVED_SIGS=new Set;const CHAIN_PACK_PREFIX="88_chain_pack_";function chainPackKey(t){return"88_chain_pack_"+(t||todayStr())}function readChainPack(t){try{const e=localStorage.getItem(chainPackKey(t));if(!e)return[];const n=JSON.parse(e);return Array.isArray(n)?n:[]}catch(t){return[]}}function writeChainPack(t,e){try{localStorage.setItem(chainPackKey(t),JSON.stringify((e||[]).slice(0,80)))}catch(t){}}function pushChainPackFromRecord(t){if(!t)return;const e=t.date||todayStr(),n=readChainPack(e);let a="";try{a=getShareLink()}catch(t){a=location.origin+location.pathname}const o=String(LAST_ONE_LINE||"").replace(/^요약\s*:\s*/," ").trim(),s={ts:Date.now(),id:t.id||null,sig:t.sig||null,date:e,time:t.time||null,sport:t.sport||null,league:t.league||"",teams:t.teams||"",mainMode:t.mainMode||null,mainMarginPct:t.markets&&t.markets.main&&"number"==typeof t.markets.main.marginPct?t.markets.main.marginPct:null,bestEVPct:"number"==typeof t.bestEVPct?t.bestEVPct:null,oneLine:o,link:a};writeChainPack(e,[s,...n.filter(t=>t&&t.sig&&s.sig?t.sig!==s.sig:t.link!==s.link)]);try{updateBundleButton()}catch(t){}}function getChainPackCountToday(){try{return readChainPack(todayStr()).length}catch(t){return 0}}function updateBundleButton(){const t=document.getElementById("btnBundleShare");if(!t)return;const e=getChainPackCountToday();t.textContent=e>0?`오늘 수집 묶음 (${Math.min(80,e)})`:"오늘 수집 묶음"}const SPORT_CFG={soccer:{name:"축구",main:"3way",labels:{H:"홈",D:"무",A:"원정"},hint:"축구는 기본 3배당(홈/무/원정). 중급/고급에서 오버언더를 같이 보는 걸 추천합니다.",template:{openHandicap:!1,openTotal:!0},defaults:{ouPush:6,hcPush:2}},basketball:{name:"농구",main:"2way",labels:{A:"승",B:"패"},hint:"농구는 2배당(승/패) 중심. 중급/고급에서는 핸디+오버언더를 함께 추천.",template:{openHandicap:!0,openTotal:!0},defaults:{ouPush:3,hcPush:3}},baseball:{name:"야구",main:"2way",labels:{A:"승",B:"패"},hint:"야구는 승/패(2배당) + 오버언더/핸디(런라인)를 함께 보는 경우가 많습니다.",template:{openHandicap:!0,openTotal:!0},defaults:{ouPush:4,hcPush:2}},volleyball:{name:"배구",main:"2way",labels:{A:"승",B:"패"},hint:"배구는 2배당(승/패) 중심. 중급/고급에서 핸디/OU를 함께 확인하세요.",template:{openHandicap:!0,openTotal:!0},defaults:{ouPush:1,hcPush:1}},esports:{name:"e스포츠",main:"2way",labels:{A:"승",B:"패"},hint:"e스포츠는 매치 승/패(2배당) 중심. 고급에서 EV/비중 계산이 가능합니다.",template:{openHandicap:!1,openTotal:!1},defaults:{ouPush:0,hcPush:0}},hockey:{name:"하키",main:"2way",labels:{A:"승",B:"패"},hint:"하키는 2배당(승/패) 기본. 중급/고급에서 오버언더가 도움이 됩니다.",template:{openHandicap:!1,openTotal:!0},defaults:{ouPush:4,hcPush:2}}};function labels2Way(t){return{A:t&&t.labels&&t.labels.A?t.labels.A:t&&t.labels&&t.labels.H?t.labels.H:"A",B:t&&t.labels&&t.labels.B?t.labels.B:t&&t.labels&&t.labels.A?t.labels.A:"B"}}function effectiveMainMode(t){return"2way"===MAIN_MODE_OVERRIDE?"2way":"3way"===MAIN_MODE_OVERRIDE||t&&"3way"===t.main?"3way":"2way"}function setMainModeOverride(t){MAIN_MODE_OVERRIDE=t||null;try{onSportChange(!0)}catch(t){}try{saveState()}catch(t){}}const MARGIN_RULE={soccer:{main:[6,8,10],ou:[5.5,7.5,9.5],hc:[5.5,7.5,9.5]},basketball:{main:[4,6,8],ou:[4.5,6.5,8.5],hc:[4.5,6.5,8.5]},baseball:{main:[4.5,6.5,8.5],ou:[4.5,6.5,8.5],hc:[4.5,6.5,8.5]},volleyball:{main:[4,6,8],ou:[4,6,8],hc:[4,6,8]},esports:{main:[4,6,8],ou:[4,6,8],hc:[4,6,8]},hockey:{main:[4.5,6.5,8.5],ou:[4.5,6.5,8.5],hc:[4.5,6.5,8.5]}};function $(t){return document.getElementById(t)}function val(t){const e=$(t);return e?e.value:""}function setVal(t,e){const n=$(t);n&&null!=e&&(n.value=e)}function todayStr(){return(new Date).toISOString().slice(0,10)}function nowTimeStr(){const t=new Date;return`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}function saveState(){const t={sport:val("sport"),level:val("level"),mainModeOverride:MAIN_MODE_OVERRIDE,league:val("league"),teams:val("teams"),main2OddsA:val("main2OddsA"),main2OddsB:val("main2OddsB"),main3OddsH:val("main3OddsH"),main3OddsD:val("main3OddsD"),main3OddsA:val("main3OddsA"),myProb:val("myProb"),stake:val("stake"),handicapLine:val("handicapLine"),handicapOddsA:val("handicapOddsA"),handicapOddsB:val("handicapOddsB"),handicapPush:val("handicapPush"),totalLine:val("totalLine"),overOdds:val("overOdds"),underOdds:val("underOdds"),ouPush:val("ouPush"),myOverProb:val("myOverProb"),handicapCollapsed:isCollapsed("handicapBody"),totalCollapsed:isCollapsed("totalBody")};return t.__savedAt=Date.now(),localStorage.setItem(LS_KEY,JSON.stringify(t)),updateSaveBadge(t.__savedAt),maybePushSnapshot(t,!1),t}function loadState(){try{const t=localStorage.getItem(LS_KEY);if(!t)return;const e=JSON.parse(t);e.sport&&setVal("sport",e.sport),e.level&&setVal("level",e.level),void 0!==e.mainModeOverride&&(MAIN_MODE_OVERRIDE=e.mainModeOverride||null),onSportChange(!0),onLevelChange(!0),syncToggleLabels(),setVal("league",e.league),setVal("teams",e.teams),setVal("main2OddsA",e.main2OddsA),setVal("main2OddsB",e.main2OddsB),setVal("main3OddsH",e.main3OddsH),setVal("main3OddsD",e.main3OddsD),setVal("main3OddsA",e.main3OddsA),setVal("myProb",e.myProb),setVal("stake",e.stake),setVal("handicapLine",e.handicapLine),setVal("handicapOddsA",e.handicapOddsA),setVal("handicapOddsB",e.handicapOddsB),setVal("handicapPush",e.handicapPush),setVal("totalLine",e.totalLine),setVal("overOdds",e.overOdds),setVal("underOdds",e.underOdds),setVal("ouPush",e.ouPush),setVal("myOverProb",e.myOverProb),"boolean"==typeof e.handicapCollapsed&&setCollapsed("handicapBody",e.handicapCollapsed),"boolean"==typeof e.totalCollapsed&&setCollapsed("totalBody",e.totalCollapsed)}catch(t){}}function b64urlEncode(t){try{return btoa(unescape(encodeURIComponent(t))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(t){return""}}function b64urlDecode(t){try{let e=String(t||"").replace(/-/g,"+").replace(/_/g,"/");for(;e.length%4;)e+="=";return decodeURIComponent(escape(atob(e)))}catch(t){return""}}function buildPermalinkState(){try{const t=saveState(),e={v:1,sport:t.sport,level:t.level,league:t.league,teams:t.teams,fields:{main2OddsA:t.main2OddsA,main2OddsB:t.main2OddsB,main3OddsH:t.main3OddsH,main3OddsD:t.main3OddsD,main3OddsA:t.main3OddsA,myProb:t.myProb,stake:t.stake,handicapLine:t.handicapLine,handicapOddsA:t.handicapOddsA,handicapOddsB:t.handicapOddsB,handicapPush:t.handicapPush,totalLine:t.totalLine,overOdds:t.overOdds,underOdds:t.underOdds,ouPush:t.ouPush,myOverProb:t.myOverProb}};return b64urlEncode(JSON.stringify(e))}catch(t){return""}}function restoreFromPermalink(){try{const t=new URL(location.href).searchParams.get("st");if(!t)return!1;const e=b64urlDecode(t);if(!e)return!1;const n=JSON.parse(e);if(!n||!n.fields)return!1;n.sport&&setVal("sport",n.sport),n.level&&setVal("level",n.level),onSportChange(!0),onLevelChange(!0),setVal("league",n.league||""),setVal("teams",n.teams||"");const a=n.fields||{};["main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA","myProb","stake","handicapLine","handicapOddsA","handicapOddsB","handicapPush","totalLine","overOdds","underOdds","ouPush","myOverProb"].forEach(t=>setVal(t,a[t])),saveState();try{track("permalink_open",{has_state:!0})}catch(t){}const o="3way"===effectiveMainMode(SPORT_CFG[val("sport")]||SPORT_CFG.soccer);return(o?null!=parseOdds(val("main3OddsH"))&&null!=parseOdds(val("main3OddsD"))&&null!=parseOdds(val("main3OddsA")):null!=parseOdds(val("main2OddsA"))&&null!=parseOdds(val("main2OddsB")))&&setTimeout(()=>{try{calc()}catch(t){}},50),!0}catch(t){return!1}}function updateLineCompareUI(t){const e="3way"===effectiveMainMode(t=t||SPORT_CFG[val("sport")]||SPORT_CFG.soccer),n=document.getElementById("lcA2"),a=document.getElementById("lcB2"),o=document.getElementById("lcA3"),s=document.getElementById("lcB3");if(n&&(n.style.display=e?"none":"block"),a&&(a.style.display=e?"none":"block"),o&&(o.style.display=e?"block":"none"),s&&(s.style.display=e?"block":"none"),e){const e=t.labels.H||"홈",n=t.labels.D||"무",a=t.labels.A||"원정";[["lcA3LabelH",`${e} 배당`],["lcA3LabelD",`${n} 배당`],["lcA3LabelA",`${a} 배당`],["lcB3LabelH",`${e} 배당`],["lcB3LabelD",`${n} 배당`],["lcB3LabelA",`${a} 배당`]].forEach(([t,e])=>{const n=document.getElementById(t);n&&(n.innerText=e)})}else{const e=t.labels.A||"A",n=t.labels.B||"B";[["lcA2LabelA",`${e} 배당`],["lcA2LabelB",`${n} 배당`],["lcB2LabelA",`${e} 배당`],["lcB2LabelB",`${n} 배당`]].forEach(([t,e])=>{const n=document.getElementById(t);n&&(n.innerText=e)})}}function getLineCompareSet(t){if(!("3way"===effectiveMainMode(SPORT_CFG[val("sport")]||SPORT_CFG.soccer))){const e=parseOdds(val("A"===t?"lcA2OddsA":"lcB2OddsA")),n=parseOdds(val("A"===t?"lcA2OddsB":"lcB2OddsB"));if(null==e||null==n)return null;return{is3:!1,odds:[e,n],out:compute2Way(e,n,0)}}const e=parseOdds(val("A"===t?"lcA3OddsH":"lcB3OddsH")),n=parseOdds(val("A"===t?"lcA3OddsD":"lcB3OddsD")),a=parseOdds(val("A"===t?"lcA3OddsA":"lcB3OddsA"));if(null==e||null==n||null==a)return null;return{is3:!0,odds:[e,n,a],out:compute3Way(e,n,a)}}function fmtFairFromProbs(t){try{return t.map(t=>t>0?(1/t).toFixed(2):"-").join(" / ")}catch(t){return"-"}}function runLineCompare(){const t=SPORT_CFG[val("sport")]||SPORT_CFG.soccer,e=document.getElementById("lineCompareOut");if(!e)return;const n=getLineCompareSet("A"),a=getLineCompareSet("B");if(!n||!a){e.style.display="block",e.innerHTML='<div class="k">안내</div><div class="v warn">라인 A/B 배당을 모두 입력해줘.</div>';try{track("line_compare",{ok:0})}catch(t){}return}const o=n.out.marginPct,s=a.out.marginPct,r=o<=s?"A":"B",l=Math.abs(o-s),c=n.is3?[t.labels.H||"H",t.labels.D||"D",t.labels.A||"A"]:[t.labels.A||"A",t.labels.B||"B"],i=fmtFairFromProbs(n.out.probs),d=fmtFairFromProbs(a.out.probs);e.style.display="block",e.innerHTML=`\n    <div class="k">비교 결과</div>\n    <div class="v">\n      • 라인 A 마진: <b>${o.toFixed(2)}%</b> · 공정배당(${c.join("/")}): <b>${i}</b><br>\n      • 라인 B 마진: <b>${s.toFixed(2)}%</b> · 공정배당(${c.join("/")}): <b>${d}</b><br>\n      • 더 낮은 마진: <b class="${"A"===r?"good":"warn"}">라인 ${r}</b> (차이 ${l.toFixed(2)}%p)\n    </div>\n  `;try{track("line_compare",{ok:1,best:r,delta_pp:+l.toFixed(4)})}catch(t){}}function applyLineCompare(t){if("3way"===effectiveMainMode(SPORT_CFG[val("sport")]||SPORT_CFG.soccer)){const e=val("A"===t?"lcA3OddsH":"lcB3OddsH"),n=val("A"===t?"lcA3OddsD":"lcB3OddsD"),a=val("A"===t?"lcA3OddsA":"lcB3OddsA");setVal("main3OddsH",e),setVal("main3OddsD",n),setVal("main3OddsA",a)}else{const e=val("A"===t?"lcA2OddsA":"lcB2OddsA"),n=val("A"===t?"lcA2OddsB":"lcB2OddsB");setVal("main2OddsA",e),setVal("main2OddsB",n)}saveState();try{calc()}catch(t){}try{track("line_apply",{which:t})}catch(t){}try{quickJump("result")}catch(t){}}function prefillLineCompare(){"3way"===effectiveMainMode(SPORT_CFG[val("sport")]||SPORT_CFG.soccer)?(setVal("lcA3OddsH",val("main3OddsH")),setVal("lcA3OddsD",val("main3OddsD")),setVal("lcA3OddsA",val("main3OddsA")),setVal("lcB3OddsH",""),setVal("lcB3OddsD",""),setVal("lcB3OddsA","")):(setVal("lcA2OddsA",val("main2OddsA")),setVal("lcA2OddsB",val("main2OddsB")),setVal("lcB2OddsA",""),setVal("lcB2OddsB",""));const t=document.getElementById("lineCompareOut");t&&(t.style.display="none",t.innerHTML="");try{track("line_prefill",{})}catch(t){}}function onSportChange(t){const e=val("sport"),n=SPORT_CFG[e]||SPORT_CFG.soccer;t||(MAIN_MODE_OVERRIDE=null),$("sportHint").innerText=`선택 종목: ${n.name} · ${n.hint}`;const a="3way"===effectiveMainMode(n);if($("main2").style.display=a?"none":"block",$("main3").style.display=a?"block":"none",a)$("mainMarketTitle").innerText=`메인 배당 (${n.labels.H||"H"}/${n.labels.D||"D"}/${n.labels.A||"A"})`;else{const t=labels2Way(n);$("mainMarketTitle").innerText=`메인 배당 (${t.A}/${t.B})`}if(a)$("main3LabelH").innerText=`${n.labels.H} 배당`,$("main3LabelD").innerText=`${n.labels.D} 배당`,$("main3LabelA").innerText=`${n.labels.A} 배당`;else{const t=labels2Way(n);$("main2LabelA").innerText=`${t.A} 배당`,$("main2LabelB").innerText=`${t.B} 배당`}$("handicapOddsALabel").innerText=`핸디 ${n.labels.A||"선택A"} 배당`,$("handicapOddsBLabel").innerText=`반대 ${n.labels.B||"선택B"} 배당`,val("ouPush")||setVal("ouPush",n.defaults.ouPush),val("handicapPush")||setVal("handicapPush",n.defaults.hcPush),applyTemplate(),updateMyProbHints(n,val("level")),updateLineCompareUI(n),t||hideResult(),renderMarginDash(),saveState()}function onLevelChange(t){const e=val("level"),n="simple"===e,a="adv"===e;document.body.classList.toggle("simple",n),document.body.dataset.level=e,document.querySelectorAll(".settingsHint, .small-hint").forEach(t=>{t.style.display=n?"none":""});const o=document.getElementById("metaToggleBtn"),s=document.getElementById("metaFields");o&&s&&(n?(o.style.display="inline-flex",s.style.display="none"):(o.style.display="none",s.style.display="block")),$("valueInputs").style.display=n?"none":"block",$("totalBox").style.display=n?"none":"block",$("handicapBox").style.display=n?"none":"block";const r=document.getElementById("lineCompareBox");r&&(r.style.display=a?"block":"none");const l=document.getElementById("appTabbar");if(l){const t={main:!0,total:!n,handicap:!n,result:!0,history:!0};l.querySelectorAll(".st-tab").forEach(e=>{const n=e.getAttribute("data-jump"),a=!1!==t[n];if(e.style.display=a?"":"none",!a&&e.classList.contains("on")){const t=l.querySelector('.st-tab[data-jump="main"]');t&&t.click()}})}const c=document.getElementById("pasteBox");if(c){const t=[...c.querySelectorAll("button")].find(t=>(t.textContent||"").includes("여러 경기"));t&&(t.style.display=n?"none":"")}const i=SPORT_CFG[val("sport")]||SPORT_CFG.soccer,d=document.getElementById("levelPoint");d&&(d.innerHTML=n?'<span class="k">간단</span> <b>메인 배당만</b> 넣고 마진/공정확률을 빠르게 확인합니다. (OU/핸디/EV 입력은 숨김)':"mid"===e?'<span class="k">중급</span> 메인 + <b>OU/핸디(선택)</b>까지 같이 계산합니다. <b>내확률</b>을 넣으면 EV/권장비중도 함께 봅니다.':'<span class="k">고급</span> 라인 비교/확률 입력/EV/켈리까지 <b>전체 기능</b>을 모두 사용합니다.');const u=document.getElementById("mainPoint");u&&(u.innerHTML='<span class="k">필수</span> 배당만 정확히 입력하면 됩니다. <b>오버라운드(마진)</b>가 낮을수록 비용이 낮은 편입니다.');const p=document.getElementById("totalPoint");p&&(p.innerHTML='<span class="k">선택</span> 오버/언더 배당을 넣으면 <b>OU 마진</b>과 공정확률을 따로 계산합니다.');const m=document.getElementById("handicapPoint");m&&(m.innerHTML='<span class="k">선택</span> 핸디 라인/양쪽 배당 입력 시 <b>핸디 마진</b>과 공정확률을 확인합니다.'),updateMyProbHints(i,e),applyTemplate(),t||hideResult(),renderMarginDash(),saveState()}function updateMyProbHints(t,e){const n="3way"===effectiveMainMode(t);if("simple"===e)return $("myProbLabel").innerText="내 예상 확률(선택) %",void($("myProbHint").innerText="");n?($("myProbLabel").innerText=`내 예상 확률(${t.labels.H}/${t.labels.D}/${t.labels.A}) % (선택)`,$("myProbHint").innerText="쉼표/공백/슬래시로 3개 입력 (예: 45,28,27) · 합 100 아니면 자동 정규화"):($("myProbLabel").innerText=`내 예상 확률(${t.labels.A}) % (선택)`,$("myProbHint").innerText="예: 55 (단일 값) · EV/권장비중 계산용")}function applyTemplate(){const t=val("level"),e=SPORT_CFG[val("sport")]||SPORT_CFG.soccer;"simple"!==t&&(setCollapsed("handicapBody",!e.template.openHandicap),setCollapsed("totalBody",!e.template.openTotal))}function toggleBox(t){setCollapsed(t,!isCollapsed(t)),syncToggleLabels();try{saveState()}catch(t){}}function syncToggleLabels(){document.querySelectorAll(".toggle[data-target]").forEach(t=>{const e=t.getAttribute("data-target");t.textContent=isCollapsed(e)?"펼치기":"접기"})}function toggleMeta(){const t=document.getElementById("metaFields"),e=document.getElementById("metaToggleBtn");if(!t||!e)return;const n="none"!==t.style.display;t.style.display=n?"none":"block",e.textContent=n?"추가 정보 입력(선택) ▾":"추가 정보 닫기 ▴"}function isCollapsed(t){const e=$(t);return!!e&&"none"===e.style.display}function setCollapsed(t,e){const n=$(t);n&&(n.style.display=e?"none":"block")}function parseOdds(t){if(!t)return null;const e=Number(String(t).replace(/,/g,".").trim());return!isFinite(e)||e<=1?null:e}function parsePct(t){if(null==t||""===t)return null;const e=Number(String(t).replace(/,/g,".").trim());return!isFinite(e)||e<0||e>100?null:e/100}["sport","level","league","teams","main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA","myProb","stake","handicapLine","handicapOddsA","handicapOddsB","handicapPush","totalLine","overOdds","underOdds","ouPush","myOverProb"].forEach(t=>{const e=$(t);e&&e.addEventListener("input",saveState)});let LAST_MYPROB_SUM=null,LAST_MYPROB_RAW=null;function parsePctList(t){if(LAST_MYPROB_SUM=null,LAST_MYPROB_RAW=null,!t)return null;const e=String(t).trim().split(/[\s,\/|]+/).map(t=>t.trim()).filter(Boolean);if(3!==e.length)return null;const n=parsePct(e[0]),a=parsePct(e[1]),o=parsePct(e[2]);if(null==n||null==a||null==o)return null;const s=n+a+o;return!isFinite(s)||s<=0?null:(LAST_MYPROB_SUM=s,LAST_MYPROB_RAW=[n,a,o],[n/s,a/s,o/s])}function parseMoney(t){if(!t)return null;const e=Number(String(t).replace(/[^\d]/g,""));return!isFinite(e)||e<=0?null:e}function setupPasteBox(){const t=$("pasteInput");t&&t.addEventListener("keydown",t=>{if((t.ctrlKey||t.metaKey)&&"Enter"===t.key)if(t.preventDefault(),t.shiftKey)try{parsePasteMulti()}catch(t){applyPaste(!0)}else applyPaste(!0)})}function clearPaste(){setVal("pasteInput",""),setPasteBadge("","");const t=$("pasteHint");t&&(t.innerText="")}function fillPasteExample(){setVal("pasteInput","3way"===effectiveMainMode(SPORT_CFG[val("sport")]||SPORT_CFG.soccer)?"맨시티 vs 리버풀  승 1.85 무 3.40 패 4.20 / 오버 2.5 1.95 언더 1.85 / 핸디 -1.5 1.90 1.95":"레이커스 vs 워리어스 승 1.87 패 2.03 / 오버 228.5 1.93 언더 1.87 / 핸디 -3.5 1.90 1.95");try{$("pasteInput").focus()}catch(t){}}function setPasteBadge(t,e){const n=$("pasteBadgeOk"),a=$("pasteBadgeWarn");n&&(t?(n.style.display="inline-flex",n.textContent=t):(n.style.display="none",n.textContent="")),a&&(e?(a.style.display="inline-flex",a.textContent=e):(a.style.display="none",a.textContent=""))}function normalizePasteText(t){if(!t)return"";let e=String(t).replace(/ /g," ");return e=e.replace(/\s+/g," ").trim(),e=e.replace(/(\d),(\d{1,3})(?!\d)/g,(t,e,n)=>`${e}.${n}`),e}function extractNextNumberTokens(t,e,n){const a=[],o=/[+-]?\d+(?:\.\d+)?/g;let s;for(o.lastIndex=e;(s=o.exec(t))&&a.length<n;){const t=Number(s[0]);isFinite(t)&&a.push({v:t,start:s.index,end:s.index+s[0].length,raw:s[0]})}return a}function extractTeamsFromText(t){const e=/([^0-9]{2,40}?)\s*(?:vs|v|VS|대)\s*([^0-9]{2,40}?)(?=\s|$|\/)/.exec(t);if(!e)return null;const n=e[1].replace(/[\[\]<>]/g,"").trim(),a=e[2].replace(/[\[\]<>]/g,"").trim();return n.length<2||a.length<2?null:`${n} vs ${a}`}function parseOUFromText(t){let e=t;let n=null,a=null,o=-1;const s=/(?:오버|over)/i.exec(e);if(s){const t=extractNextNumberTokens(e,s.index+s[0].length,3);if(t.length>=2){const a=t[0].v,r=t[1].v;isFinite(a)&&isFinite(r)&&r>1&&(n={line:a,odds:r},o=Math.max(o,t[1].end),e=e.slice(0,s.index)+" "+e.slice(t[1].end))}else if(t.length>=1){const a=t[0].v;isFinite(a)&&a>1&&(n={line:null,odds:a},o=Math.max(o,t[0].end),e=e.slice(0,s.index)+" "+e.slice(t[0].end))}}const r=/(?:언더|under)/i.exec(e);if(r){const t=extractNextNumberTokens(e,r.index+r[0].length,3);if(t.length>=2){const n=t[0].v,s=t[1].v;isFinite(n)&&isFinite(s)&&s>1&&(a={line:n,odds:s},o=Math.max(o,t[1].end),e=e.slice(0,r.index)+" "+e.slice(t[1].end))}else if(t.length>=1){const n=t[0].v;isFinite(n)&&n>1&&(a={line:null,odds:n},o=Math.max(o,t[0].end),e=e.slice(0,r.index)+" "+e.slice(t[0].end))}}return{full:!!(n&&a&&n.odds&&a.odds),line:n&&null!=n.line?n.line:a&&null!=a.line?a.line:null,overOdds:n?n.odds:null,underOdds:a?a.odds:null,cleanedText:e}}function parseHCFromText(t){let e=t;const n=/(?:핸디캡|핸디|handicap|ah)/i.exec(e);if(!n)return{full:!1,line:null,a:null,b:null,cleanedText:e};const a=extractNextNumberTokens(e,n.index+n[0].length,5);if(a.length<3)return{full:!1,line:null,a:null,b:null,cleanedText:e};const o=a[0].v,s=a[1].v,r=a[2].v,l=isFinite(o)&&Math.abs(o)<=50&&isFinite(s)&&isFinite(r)&&s>1&&r>1;return l?(e=e.slice(0,n.index)+" "+e.slice(a[2].end),{full:l,line:o,a:s,b:r,cleanedText:e}):{full:!1,line:null,a:null,b:null,cleanedText:e}}function extractOddsCandidates(t){const e=/[1-9]\d*(?:\.\d+)?/g,n=[];let a;for(;a=e.exec(t);){const t=Number(a[0]);isFinite(t)&&(t>1&&t<=200&&n.push(t))}return n}function parseMainFromText(t,e){const n=t;if(e){const t=/(?:홈|승|1)\s*[:\-]?\s*([1-9]\d*(?:\.\d+)?)[\s\S]{0,60}?(?:무|x|draw)\s*[:\-]?\s*([1-9]\d*(?:\.\d+)?)[\s\S]{0,60}?(?:원정|패|2)\s*[:\-]?\s*([1-9]\d*(?:\.\d+)?)/i.exec(n);if(t){const e=Number(t[1]),n=Number(t[2]),a=Number(t[3]);if(isFinite(e)&&isFinite(n)&&isFinite(a)&&e>1&&n>1&&a>1)return{found:!0,odds:[e,n,a]}}const e=extractOddsCandidates(n);return e.length>=3?{found:!0,odds:[e[0],e[1],e[2]],extra:e.length-3}:{found:!1,odds:[]}}const a=/(?:승|홈|1)\s*[:\-]?\s*([1-9]\d*(?:\.\d+)?)[\s\S]{0,60}?(?:패|원정|2)\s*[:\-]?\s*([1-9]\d*(?:\.\d+)?)/i.exec(n);if(a){const t=Number(a[1]),e=Number(a[2]);if(isFinite(t)&&isFinite(e)&&t>1&&e>1)return{found:!0,odds:[t,e]}}const o=extractOddsCandidates(n);return o.length>=2?{found:!0,odds:[o[0],o[1]],extra:o.length-2}:{found:!1,odds:[]}}function applyPaste(t){const e=normalizePasteText(val("pasteInput"));if(!e)return void setPasteBadge("","텍스트를 붙여넣어줘.");try{if(!val("teams")){const t=extractTeamsFromText(e);t&&setVal("teams",t)}}catch(t){}let n=e;const a=parseOUFromText_v2(n);n=a.cleanedText;const o=parseHCFromText_v2(n);n=o.cleanedText;(function(){const t=$("pasteAutoLevel");return!!t&&t.checked})()&&"simple"===val("level")&&(a.full||o.full)&&(setVal("level","mid"),onLevelChange(!0));const s=SPORT_CFG[val("sport")]||SPORT_CFG.soccer,r=$("pasteMainMode"),l=r?r.value:"auto",c="3way"===s.main,i=t=>parseMainFromText_robust(n,t);let d="3"===l||"2"!==l&&c,u=i(d);if(!(u&&u.found||"auto"!==l)){const t=i(!d);t&&t.found&&(d=!d,u=t)}if(!u||!u.found){let t="메인 배당을 찾지 못했어.";t+="3"===l?" 예: 승 1.85 무 3.40 패 4.20":"2"===l?" 예: 승 1.87 패 2.03":" 예: 승 1.85 무 3.40 패 4.20 (3배당) 또는 승 1.87 패 2.03 (2배당)",setPasteBadge("",t);const e=$("pasteHint");return void(e&&(e.innerText="팁: '팀A vs 팀B' 뒤에 배당 숫자(소수점 포함)가 같이 있어야 자동 인식돼요."))}try{setMainModeOverride(d?"3way":"2way")}catch(t){}d?(setVal("main3OddsH",String(u.odds[0])),setVal("main3OddsD",String(u.odds[1])),setVal("main3OddsA",String(u.odds[2]))):(setVal("main2OddsA",String(u.odds[0])),setVal("main2OddsB",String(u.odds[1]))),a.full&&(null!=a.line&&setVal("totalLine",String(a.line)),null!=a.overOdds&&setVal("overOdds",String(a.overOdds)),null!=a.underOdds&&setVal("underOdds",String(a.underOdds))),o.full&&(setVal("handicapLine",String(o.line)),setVal("handicapOddsA",String(o.a)),setVal("handicapOddsB",String(o.b)));try{prefillLineCompare()}catch(t){}hideResult(),renderMarginDash(),saveState();let p=`메인 ${d?"3배당":"2배당"} 입력됨`;a.full&&(p+=` · OU ${null!=a.line?a.line:""}`),o.full&&(p+=` · 핸디 ${o.line}`),setPasteBadge(p,"");const m=$("pasteHint");m&&(m.innerText="단축키: Ctrl+Enter = 자동 입력+계산 · Ctrl+Shift+Enter = 여러 경기 리스트");try{track("paste_apply",{auto_calc:t?1:0,main:d?"3":"2",has_ou:a.full?1:0,has_hc:o.full?1:0})}catch(t){}if(t){try{calc()}catch(t){}try{quickJump("result")}catch(t){}}}function normalizePasteTextMulti(t){if(!t)return"";let e=String(t).replace(/\r\n?/g,"\n");return e=e.replace(/\t/g," "),e=e.replace(/\u00a0/g," "),e=e.replace(/(\d),(\d{1,3})(?!\d)/g,(t,e,n)=>`${e}.${n}`),e=e.replace(/[|｜]/g," / "),e=e.split("\n").map(t=>t.replace(/\s+/g," ").trim()).join("\n"),e.trim()}function hasVsToken(t){return/(?:\bvs\b|\bv\b|대|@)/i.test(t)}function splitLineByRepeatedVs(t){const e=[],n=/([^\d]{2,40}?\s*(?:vs|VS|\bv\b|V|대|@)\s*[^\d]{2,40}?)/g;let a,o=[];for(;a=n.exec(t);)o.push(a.index);if(o.length<=1)return[t];for(let n=0;n<o.length;n++){const a=o[n],s=n+1<o.length?o[n+1]:t.length,r=t.slice(a,s).trim();r&&e.push(r)}return e.length?e:[t]}function splitPasteBlocks(t){const e=normalizePasteTextMulti(t);if(!e)return[];let n=e.split("\n").map(t=>t.trim()).filter(Boolean),a=[];for(const t of n){const e=splitLineByRepeatedVs(t);for(const t of e)a.push(t)}n=a;if(!n.some(hasVsToken))return n;const o=[];let s=[];for(const t of n)hasVsToken(t)&&s.length&&s.some(hasVsToken)?(o.push(s.join(" / ")),s=[t]):s.push(t);return s.length&&o.push(s.join(" / ")),o}function findEarliestMatch(t,e){let n=null;for(const a of e){const e=a.exec(t);e&&(null==n||e.index<n.index)&&(n={m:e,index:e.index,re:a})}return n}function parseOUFromText_v2(t){let e=t;let n=null,a=null;const o=findEarliestMatch(e,[/오버/i,/\bover\b/i,/(?:^|[\s\/])O(?=[\s\/]|$)/i,/O\s*\/\s*U/i,/\bOU\b/i]);if(o){const t=extractNextNumberTokens(e,o.index+o.m[0].length,3);if(t.length>=2){const a=t[0].v,s=t[1].v;isFinite(a)&&isFinite(s)&&s>1&&(n={line:a,odds:s},e=e.slice(0,o.index)+" "+e.slice(t[1].end))}else if(t.length>=1){const a=t[0].v;isFinite(a)&&a>1&&(n={line:null,odds:a},e=e.slice(0,o.index)+" "+e.slice(t[0].end))}}const s=findEarliestMatch(e,[/언더/i,/\bunder\b/i,/(?:^|[\s\/])U(?=[\s\/]|$)/i]);if(s){const t=extractNextNumberTokens(e,s.index+s.m[0].length,3);if(t.length>=2){const n=t[0].v,o=t[1].v;isFinite(n)&&isFinite(o)&&o>1&&(a={line:n,odds:o},e=e.slice(0,s.index)+" "+e.slice(t[1].end))}else if(t.length>=1){const n=t[0].v;isFinite(n)&&n>1&&(a={line:null,odds:n},e=e.slice(0,s.index)+" "+e.slice(t[0].end))}}return{full:!!(n&&a&&n.odds&&a.odds),line:n&&null!=n.line?n.line:a&&null!=a.line?a.line:null,overOdds:n?n.odds:null,underOdds:a?a.odds:null,cleanedText:e}}function parseHCFromText_v2(t){let e=t;const n=/(?:핸디캡|핸디|handicap|ah|hdp|spread|스프레드)/i.exec(e);if(n){const t=extractNextNumberTokens(e,n.index+n[0].length,5);if(t.length>=3){const a=t[0].v,o=t[1].v,s=t[2].v,r=isFinite(a)&&Math.abs(a)<=2e3&&isFinite(o)&&isFinite(s)&&o>1&&s>1;if(r)return e=e.slice(0,n.index)+" "+e.slice(t[2].end),{full:r,line:a,a:o,b:s,cleanedText:e}}}const a=/([+-]?\d+(?:\.\d+)?)\s+([1-9]\d*(?:\.\d+)?)\s+([1-9]\d*(?:\.\d+)?)/.exec(e);if(a){const t=Number(a[1]),n=Number(a[2]),o=Number(a[3]);if(isFinite(t)&&Math.abs(t)<=30&&isFinite(n)&&isFinite(o)&&n>1&&o>1&&(String(a[1]).startsWith("+")||String(a[1]).startsWith("-"))){const s=a.index,r=a.index+a[0].length;return{full:!0,line:t,a:n,b:o,cleanedText:e.slice(0,s)+" "+e.slice(r)}}}return{full:!1,line:null,a:null,b:null,cleanedText:e}}function parseMainFromText_robust(t,e){const n=parseMainFromText(t,e);if(n.found)return{...n,conf:"high",method:"keyword"};let a=0;try{const e=/([^0-9]{2,40}?)\s*(?:vs|v|VS|대|@)\s*([^0-9]{2,40}?)(?=\s|$|\/)/.exec(t);e&&(a=e.index+e[0].length)}catch(t){}const o=extractOddsCandidates(t.slice(a));if(e){if(o.length>=3)return{found:!0,odds:[o[0],o[1],o[2]],extra:Math.max(0,o.length-3),conf:3===o.length?"mid":"low",method:"after_team"}}else if(o.length>=2)return o.length>=3?{found:!0,odds:[o[0],o[2]],extra:Math.max(0,o.length-2),conf:"low",method:"skip_mid"}:{found:!0,odds:[o[0],o[1]],extra:Math.max(0,o.length-2),conf:"mid",method:"after_team"};const s=extractOddsCandidates(t);if(e){if(s.length>=3)return{found:!0,odds:[s[0],s[1],s[2]],extra:Math.max(0,s.length-3),conf:"low",method:"fallback"}}else if(s.length>=2)return{found:!0,odds:[s[0],s[1]],extra:Math.max(0,s.length-2),conf:"low",method:"fallback"};return{found:!1,odds:[],conf:"low",method:"none"}}function parseGameBlock(t){const e=SPORT_CFG[val("sport")]||SPORT_CFG.soccer,n=normalizePasteText(t);if(!n)return null;const a=extractTeamsFromText(n);let o=n;const s=parseOUFromText_v2(o);o=s.cleanedText;const r=parseHCFromText_v2(o);o=r.cleanedText;const l=$("pasteMainMode"),c=l?l.value:"auto",i="3way"===e.main,d=t=>parseMainFromText_robust(o,t);let u="3"===c||"2"!==c&&i,p=d(u);if(!(p&&p.found||"auto"!==c)){const t=d(!u);t&&t.found&&(u=!u,p=t)}if(!p||!p.found)return null;const m=p.conf||"low",f=p.extra||0,h="low"===m||f>=2;let v=null,b=null;try{if(u){const t=compute3Way(Number(p.odds[0]),Number(p.odds[1]),Number(p.odds[2]));v=t.over,b=t.marginPct}else{const t=compute2Way(Number(p.odds[0]),Number(p.odds[1]),0);v=t.over,b=t.marginPct}}catch(t){}const _=function(){const t=t=>String(t??"").toLowerCase().replace(/\s+/g,""),e=t=>{const e=Number(t);return Number.isFinite(e)?e.toFixed(4):""},n=[t(val("sport")),u?"3way":"2way",t(a||"")];return u?n.push(e(p.odds[0]),e(p.odds[1]),e(p.odds[2])):n.push(e(p.odds[0]),e(p.odds[1])),s&&s.full&&n.push("ou:"+t(s.line)+":"+e(s.overOdds)+":"+e(s.underOdds)),r&&r.full&&n.push("hc:"+t(r.line)+":"+e(r.a)+":"+e(r.b)),n.join("|")}();return{id:Math.random().toString(36).slice(2),raw:n,teams:a,is3:u,mainOdds:p.odds,mainOver:v,mainMarginPct:b,ou:s,hc:r,conf:m,method:p.method||"",warn:h,extra:f,sig:_}}function fmtOddsArr(t){return(t||[]).map(t=>Number(t).toFixed(2)).join(" / ")}function confLabel(t){return"high"===t?"높음":"mid"===t?"중간":"낮음"}function renderPasteList(t){const e=$("pasteListWrap"),n=$("pasteList"),a=$("pasteListMeta");if(!e||!n)return;if(__PASTE_MULTI=t||[],!__PASTE_MULTI.length)return e.style.display="none",n.innerHTML="",void(a&&(a.textContent=""));e.style.display="block",a&&(a.textContent=`${__PASTE_MULTI.length}개 감지 · ${isPasteChainMode()?"클릭=연속 저장":"클릭=원문 토글"} · 버튼으로 즉시 적용 가능`);const o=__PASTE_MULTI.map((t,e)=>({g:t,idx:e}));"margin"===__PASTE_SORT&&o.sort((t,e)=>("number"==typeof t.g.mainMarginPct?t.g.mainMarginPct:9999)-("number"==typeof e.g.mainMarginPct?e.g.mainMarginPct:9999)),n.innerHTML=o.map(({g:t,idx:e})=>{const n=t.teams?safeText(t.teams):`경기 ${e+1}`,a=t.is3?`메인(3): ${fmtOddsArr(t.mainOdds)}`:`메인(2): ${fmtOddsArr(t.mainOdds)}`,o=[];if("number"==typeof t.mainMarginPct){const e=classifyMargin(val("sport"),"main",t.mainMarginPct);o.push(`<span class="paste-chip ${"ok"===e.cls?"ok":(e.cls,"warn")}">예상 ${safeText(e.label)}</span>`)}return o.push(`<span class="paste-chip ${t.warn?"warn":"ok"}">정확도 ${confLabel(t.conf)}</span>`),t.extra&&o.push(`<span class="paste-chip warn">추가 숫자 ${t.extra}개</span>`),t.ou&&t.ou.full&&o.push(`<span class="paste-chip ok">OU ${null!=t.ou.line?t.ou.line:""} · ${Number(t.ou.overOdds).toFixed(2)}/${Number(t.ou.underOdds).toFixed(2)}</span>`),t.hc&&t.hc.full&&o.push(`<span class="paste-chip ok">핸디 ${t.hc.line} · ${Number(t.hc.a).toFixed(2)}/${Number(t.hc.b).toFixed(2)}</span>`),`\n      <div class="paste-item" id="pasteItem_${e}">\n        <div class="left" onclick="onPasteItemClick(${e})">\n          <div class="t">${n}</div>\n          <div class="s">${safeText(a)}</div>\n          <div class="chips">${o.join("")}</div>\n          <div class="paste-raw">${safeText(t.raw)}</div>\n        </div>\n        <div class="right">\n          <div class="btns">\n            <button class="btn primary mini" type="button" onclick="applyParsedGame(${e}, true, false); event.stopPropagation();">적용+계산</button>\n            <button class="btn secondary mini" type="button" onclick="applyParsedGame(${e}, false, false); event.stopPropagation();">적용만</button>\n            <button class="btn ghost mini" type="button" onclick="togglePasteItem(${e}); event.stopPropagation();">원문</button>\n          </div>\n          <div class="paste-stat" id="pasteStat_${e}" style="display:none;"></div>\n        </div>\n      </div>\n    `}).join("");try{0===__PASTE_SAVED_SIGS.size&&buildSavedSigSet()}catch(t){}try{__PASTE_MULTI.forEach((t,e)=>{if(t&&pasteAlreadySaved(t)){const t=$("pasteItem_"+e);t&&t.classList.add("is-saved");const n=$("pasteStat_"+e);n&&(n.innerHTML="저장됨",n.style.display="block")}})}catch(t){}}function togglePasteItem(t){const e=$(`pasteItem_${t}`);e&&e.classList.toggle("is-open")}function clearPasteList(){__PASTE_MULTI=[];const t=$("pasteListWrap"),e=$("pasteList"),n=$("pasteListMeta");e&&(e.innerHTML=""),n&&(n.textContent=""),t&&(t.style.display="none");try{track("paste_multi_clear",{})}catch(t){}}function parsePasteMulti(){const t=normalizePasteTextMulti(val("pasteInput"));if(!t)return void setPasteBadge("","텍스트를 붙여넣어줘.");const e=splitPasteBlocks(t),n=[];for(const t of e){const e=parseGameBlock(t);e&&n.push(e)}if(!n.length){/%|퍼센트|확률/i.test(t)?setPasteBadge("","확률(%)이 아니라 배당(1.85 같은 값)이 필요해."):setPasteBadge("","경기를 찾지 못했어. (팀 vs 팀 + 배당 숫자 포함 필요)");const e=$("pasteHint");return e&&(e.innerText="팁: 각 경기마다 ‘팀A vs 팀B’ 또는 줄바꿈으로 구분해줘. 숫자만 있어도 돼요. 예: 맨시티 vs 리버풀 1.85 3.40 4.20"),void renderPasteList([])}setPasteBadge(`${n.length}경기 감지됨`,"");const a=$("pasteHint");a&&(a.innerText="리스트에서 경기 선택 → 자동 입력(선택: 계산). 정확도 낮음 표시가 뜨면 적용 후 숫자만 한 번 확인!"),renderPasteList(n);try{track("paste_multi_parse",{count:n.length,main:(SPORT_CFG[val("sport")]||SPORT_CFG.soccer).main})}catch(t){}}function isPasteChainMode(){const t=$("pasteChainMode");return!!t&&t.checked}function isPasteSkipLow(){const t=$("pasteSkipLow");return!!t&&t.checked}function getPasteChainCount(){const t=$("pasteChainCount"),e=t?parseInt(t.value,10):10;return isFinite(e)&&e>0?Math.min(30,Math.max(1,e)):10}function buildSavedSigSet(){try{const t=t=>String(t??"").toLowerCase().replace(/\s+/g,""),e=t=>{const e=Number(t);return Number.isFinite(e)?e.toFixed(4):""},n=readHistory();for(const a of n)if(a)if(a.sig)__PASTE_SAVED_SIGS.add(a.sig);else try{const n=a.mainMode?a.mainMode:"3way"===(SPORT_CFG[a.sport]||SPORT_CFG.soccer).main?"3way":"2way",o=[t(a.sport),n,t(a.teams)];"3way"===n?o.push(e(a.inputs?.main3OddsH),e(a.inputs?.main3OddsD),e(a.inputs?.main3OddsA)):o.push(e(a.inputs?.main2OddsA),e(a.inputs?.main2OddsB)),a.inputs?.totalLine&&o.push("ou:"+t(a.inputs.totalLine)+":"+e(a.inputs.overOdds)+":"+e(a.inputs.underOdds)),a.inputs?.handicapLine&&o.push("hc:"+t(a.inputs.handicapLine)+":"+e(a.inputs.handicapOddsA)+":"+e(a.inputs.handicapOddsB)),__PASTE_SAVED_SIGS.add(o.join("|"))}catch(t){}}catch(t){}}function setPasteItemSaved(t,e){const n=__PASTE_MULTI[t];if(!n)return;n.__saved=!0,e&&e.sig&&__PASTE_SAVED_SIGS.add(e.sig);const a=$("pasteItem_"+t);a&&a.classList.add("is-saved");const o=$("pasteStat_"+t);if(o){const t=e&&e.markets&&e.markets.main&&"number"==typeof e.markets.main.marginPct?e.markets.main.marginPct:"number"==typeof n.mainMarginPct?n.mainMarginPct:null,a=e&&"number"==typeof e.bestEVPct?e.bestEVPct:null,s=[];null!=t&&s.push(`마진 <b>${t.toFixed(2)}%</b>`),null!=a&&s.push(`EV <b>${a>=0?"+":"-"}${Math.abs(a).toFixed(2)}%</b>`),o.innerHTML=`저장됨 · ${s.join(" · ")}`,o.style.display="block"}try{e&&(isPasteChainMode()||__PASTE_CHAIN_RUNNING)&&pushChainPackFromRecord(e)}catch(t){}}function pasteAlreadySaved(t){return!!t&&(!!t.__saved||!(!t.sig||!__PASTE_SAVED_SIGS.has(t.sig)))}function applyParsedGame(t,e,n){const a=__PASTE_MULTI[t];if(!a)return;try{setMainModeOverride(a.is3?"3way":"2way")}catch(t){}try{a.teams&&setVal("teams",a.teams)}catch(t){}a.is3?(setVal("main3OddsH",String(a.mainOdds[0])),setVal("main3OddsD",String(a.mainOdds[1])),setVal("main3OddsA",String(a.mainOdds[2]))):(setVal("main2OddsA",String(a.mainOdds[0])),setVal("main2OddsB",String(a.mainOdds[1]))),a.ou&&a.ou.full&&(null!=a.ou.line&&setVal("totalLine",String(a.ou.line)),null!=a.ou.overOdds&&setVal("overOdds",String(a.ou.overOdds)),null!=a.ou.underOdds&&setVal("underOdds",String(a.ou.underOdds))),a.hc&&a.hc.full&&(setVal("handicapLine",String(a.hc.line)),setVal("handicapOddsA",String(a.hc.a)),setVal("handicapOddsB",String(a.hc.b)));(function(){const t=$("pasteAutoLevel");return!!t&&t.checked})()&&"simple"===val("level")&&(a.ou&&a.ou.full||a.hc&&a.hc.full)&&(setVal("level","mid"),onLevelChange(!0));try{prefillLineCompare()}catch(t){}hideResult(),renderMarginDash(),saveState();try{track("paste_multi_apply",{idx:t,auto_calc:e?1:0,keep_view:n?1:0,conf:a.conf,has_ou:a.ou&&a.ou.full?1:0,has_hc:a.hc&&a.hc.full?1:0})}catch(t){}if(e){try{calc()}catch(t){}try{setPasteItemSaved(t,LAST_RECORD)}catch(t){}if(!n)try{quickJump("result")}catch(t){}}else if(!n)try{quickJump("main")}catch(t){}}function onPasteItemClick(t){const e=__PASTE_MULTI[t];if(e)return isPasteChainMode()?isPasteSkipLow()&&"low"===e.conf?void toast("정확도 낮음 항목은 제외 설정이에요."):pasteAlreadySaved(e)?(setPasteItemSaved(t,null),void toast("이미 저장된 항목이에요.")):void applyParsedGame(t,!0,!0):void togglePasteItem(t)}function startChainSave(){if(__PASTE_CHAIN_RUNNING)return void toast("이미 연속 저장 중이에요.");if(!__PASTE_MULTI.length)return void toast("먼저 '여러 경기 만들기'로 리스트를 만들어줘.");0===__PASTE_SAVED_SIGS.size&&buildSavedSigSet();const t=getPasteChainCount();__PASTE_CHAIN_RUNNING=!0,__PASTE_CHAIN_ABORT=!1;const e=$("pasteChainStop");e&&(e.style.display="inline-flex");const n=__PASTE_MULTI.map((t,e)=>({g:t,i:e}));"margin"===__PASTE_SORT&&n.sort((t,e)=>("number"==typeof t.g.mainMarginPct?t.g.mainMarginPct:9999)-("number"==typeof e.g.mainMarginPct?e.g.mainMarginPct:9999));let a=n.map(t=>t.i);isPasteSkipLow()&&(a=a.filter(t=>__PASTE_MULTI[t]&&"low"!==__PASTE_MULTI[t].conf)),a=a.filter(t=>!pasteAlreadySaved(__PASTE_MULTI[t]));const o=Math.min(t,a.length);if(o<=0)return toast("저장할 항목이 없어요. (이미 저장됨/정확도 낮음 제외)"),__PASTE_CHAIN_RUNNING=!1,void(e&&(e.style.display="none"));const s=$("pasteListMeta");let r=0;const l=()=>{if(__PASTE_CHAIN_ABORT)return __PASTE_CHAIN_RUNNING=!1,e&&(e.style.display="none"),s&&(s.textContent=`연속 저장 중지됨 · ${r}/${o} 저장`),void toast(`연속 저장 중지 (${r}/${o})`);if(r>=o){__PASTE_CHAIN_RUNNING=!1,e&&(e.style.display="none"),s&&(s.textContent=`연속 저장 완료 · ${r}/${o} 저장`),toast(`연속 저장 완료 (${r}/${o})`);try{track("paste_chain_done",{done:r,total:o})}catch(t){}return}const t=a[r];s&&(s.textContent=`연속 저장 중... ${r+1}/${o}`),applyParsedGame(t,!0,!0),r+=1,setTimeout(l,140)};try{track("paste_chain_start",{target_total:o,requested:t,sort:__PASTE_SORT})}catch(t){}l()}function stopChainSave(){if(__PASTE_CHAIN_RUNNING){__PASTE_CHAIN_ABORT=!0;try{track("paste_chain_stop",{})}catch(t){}}else toast("진행 중인 연속 저장이 없어요.")}function togglePasteSort(){__PASTE_SORT="margin"===__PASTE_SORT?"input":"margin";document.querySelectorAll(".paste-list-tools .btn.ghost.mini");try{const t=document.querySelector(".paste-list-tools .btn.ghost.mini");t&&(t.textContent="margin"===__PASTE_SORT?"정렬: 입력순":"정렬: 마진 낮은순")}catch(t){}renderPasteList(__PASTE_MULTI)}function pct(t){return(100*t).toFixed(1)+"%"}function money(t){return Math.round(t).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+"원"}function expectedValue(t,e,n){return t*(e*(n-1)-(1-e))}function quarterKelly(t,e){const n=(t*e-1)/(e-1)/4;return Math.max(0,Math.min(.25,n))}function compute2Way(t,e,n){const a=1/t,o=1/e,s=a+o,r=Math.max(0,Math.min(.35,n||0)),l=1-r,c=s/l;return{over:c,marginPct:100*(c-1),probs:[a/s*l,o/s*l],push:r}}function compute3Way(t,e,n){const a=1/t,o=1/e,s=1/n,r=a+o+s;return{over:r,marginPct:100*(r-1),probs:[a/r,o/r,s/r]}}function classifyMargin(t,e,n){const a=(MARGIN_RULE[t]||MARGIN_RULE.soccer)[e]||[5,7,9],[o,s,r]=a;return n<=o?{label:`마진 낮음 (${n.toFixed(2)}%)`,cls:"ok"}:n<=s?{label:`보통 (${n.toFixed(2)}%)`,cls:"mid"}:n<=r?{label:`주의 (${n.toFixed(2)}%)`,cls:"mid"}:{label:`고마진 (${n.toFixed(2)}%)`,cls:"bad"}}function clsToTextColor(t){return"ok"===t?"good":"mid"===t?"mid":"warn"}function setEvFlag(t){const e=todayStr();localStorage.setItem("88_ev_date",e),localStorage.setItem("88_ev_positive",t?"1":"0")}function levelLabel(t){return"simple"===t?"간단":"mid"===t?"중급":"고급"}function calc(){const t=val("sport"),e=val("level"),n=SPORT_CFG[t]||SPORT_CFG.soccer,a="3way"===effectiveMainMode(n),o=[],s=[];s.push(`[88 커뮤니티] ${n.name} 분석 (${levelLabel(e)})`);const r=val("league").trim(),l=val("teams").trim();r&&s.push(`리그: ${r}`),l&&s.push(`경기: ${l}`);const c={id:Date.now().toString(36)+Math.random().toString(36).slice(2,7),date:todayStr(),time:nowTimeStr(),sport:t,level:e,league:r,teams:l,mainMode:"3way"===effectiveMainMode(n)?"3way":"2way",inputs:{},markets:{},evPositive:!1,bestEVPct:null};try{track("analysis_start",{sport:t,level:e,market_type:a?"3way":"2way",odds_count:a?3:2,has_league:!!r,has_teams:!!l})}catch(t){}let i=null,d=null,u=null;if(a){const a=parseOdds(val("main3OddsH")),r=parseOdds(val("main3OddsD")),l=parseOdds(val("main3OddsA"));if(null==a||null==r||null==l)return clearInvalid(),markInvalid(["main3OddsH","main3OddsD","main3OddsA"]),showError("메인 배당(홈/무/원정)을 1.01 이상 숫자로 입력해줘.");const p=compute3Way(a,r,l);d=p.over,i=p.marginPct,u=p.probs,o.push([`승리 확률(배당 기반·추정, ${n.labels.H})`,pct(p.probs[0])]),o.push([`승리 확률(배당 기반·추정, ${n.labels.D})`,pct(p.probs[1])]),o.push([`승리 확률(배당 기반·추정, ${n.labels.A})`,pct(p.probs[2])]),o.push(["오버라운드(마진 추정)",p.over.toFixed(4)]);const m=classifyMargin(t,"main",p.marginPct);if(o.push(["메인 마진 판정",`<span class="${clsToTextColor(m.cls)}">${m.label}</span>`]),s.push(`메인 배당(${n.labels.H}/${n.labels.D}/${n.labels.A}): ${a} / ${r} / ${l}`),c.inputs.main3OddsH=val("main3OddsH"),c.inputs.main3OddsD=val("main3OddsD"),c.inputs.main3OddsA=val("main3OddsA"),c.markets.main={over:p.over,marginPct:p.marginPct},"simple"!==e){const t=parsePctList(val("myProb")),i=parseMoney(val("stake"));if(t){const d=t[0]*(a-1)-(1-t[0]),u=t[1]*(r-1)-(1-t[1]),p=t[2]*(l-1)-(1-t[2]);o.push([`내 예상 확률(${n.labels.H}/${n.labels.D}/${n.labels.A})`,`${pct(t[0])} / ${pct(t[1])} / ${pct(t[2])}`]),LAST_MYPROB_SUM&&Math.abs(LAST_MYPROB_SUM-1)>.005&&o.push(["내 확률 합계",`${(100*LAST_MYPROB_SUM).toFixed(1)}% → 100%로 자동 정규화`]),o.push(["EV(홈/무/원정, 1원당)",`${(100*d).toFixed(2)}% / ${(100*u).toFixed(2)}% / ${(100*p).toFixed(2)}%`]);const m=[{k:n.labels.H,ev:d,odds:a,p:t[0]},{k:n.labels.D,ev:u,odds:r,p:t[1]},{k:n.labels.A,ev:p,odds:l,p:t[2]}].sort((t,e)=>e.ev-t.ev)[0];o.push(["가장 높은 EV",`${m.k} (${(100*m.ev).toFixed(2)}%)`]),null!=i&&o.push(["기대값(EV, 최고 EV 기준)",money(expectedValue(i,m.p,m.odds))]),"adv"===e&&o.push(["권장 비중(보수적 1/4 Kelly, 최고 EV 기준)",(100*quarterKelly(m.p,m.odds)).toFixed(1)+"%"]),o.push(["판단",m.ev>0?"밸류(+EV) 가능성":"밸류(-EV) 가능성"]),c.bestEVPct=100*m.ev,c.evPositive=m.ev>0,setEvFlag(c.evPositive),s.push(`내 예상 확률: ${(100*t[0]).toFixed(1)}% / ${(100*t[1]).toFixed(1)}% / ${(100*t[2]).toFixed(1)}%`),null!=i&&s.push(`베팅금: ${money(i)}`)}else o.push(["Tip","중급/고급에서는 내 예상 확률(예: 45,28,27)을 입력하면 EV가 계산됩니다. (선택사항)"]),setEvFlag(!1)}else setEvFlag(!1)}else{const a=parseOdds(val("main2OddsA")),r=parseOdds(val("main2OddsB"));if(null==a||null==r)return clearInvalid(),markInvalid(["main2OddsA","main2OddsB"]),showError("메인 배당을 1.01 이상 숫자로 입력해줘.");const l=compute2Way(a,r,0);d=l.over,i=l.marginPct,u=l.probs;const p=labels2Way(n);o.push([`승리 확률(배당 기반·추정, ${p.A})`,pct(l.probs[0])]),o.push([`승리 확률(배당 기반·추정, ${p.B})`,pct(l.probs[1])]),o.push(["오버라운드(마진 추정)",l.over.toFixed(4)]);const m=classifyMargin(t,"main",l.marginPct);o.push(["메인 마진 판정",`<span class="${clsToTextColor(m.cls)}">${m.label}</span>`]);const f=labels2Way(n);if(s.push(`메인 배당(${f.A}/${f.B}): ${a} / ${r}`),c.inputs.main2OddsA=val("main2OddsA"),c.inputs.main2OddsB=val("main2OddsB"),c.markets.main={over:l.over,marginPct:l.marginPct},"simple"!==e){const t=parsePct(val("myProb")),r=parseMoney(val("stake"));if(null!=t){const l=t*(a-1)-(1-t);if(o.push([`내 예상 확률(${n.labels.A})`,pct(t)]),o.push(["EV(1원당)",(100*l).toFixed(2)+"%"]),s.push(`내 예상 확률(${n.labels.A}): ${(100*t).toFixed(1)}%`),null!=r&&(o.push(["기대값(EV)",money(expectedValue(r,t,a))]),s.push(`베팅금: ${money(r)}`)),"adv"===e){const e=quarterKelly(t,a);o.push(["권장 비중(보수적 1/4 Kelly)",(100*e).toFixed(1)+"%"])}o.push(["판단",l>0?"밸류(+EV) 가능성":"밸류(-EV) 가능성"]),c.bestEVPct=100*l,c.evPositive=l>0,setEvFlag(c.evPositive)}else o.push(["Tip","중급/고급에서는 '내 예상 확률'을 입력하면 EV가 계산됩니다. (선택사항)"]),setEvFlag(!1)}else setEvFlag(!1)}try{if("number"==typeof i&&u&&u.length){const t=a?[n.labels.H||"H",n.labels.D||"D",n.labels.A||"A"]:[n.labels.A||"A",n.labels.B||"B"],e=u.map(t=>t>0?1/t:null).map(t=>t&&isFinite(t)?t.toFixed(2):"-").join(" / "),o="number"!=typeof c.bestEVPct?"EV 미입력":c.bestEVPct>0?"+EV 가능":"-EV 가능";LAST_ONE_LINE=`요약: 마진 ${i.toFixed(1)}% · 공정배당(${t.join("/")}) ${e} · ${o}`,s.push(LAST_ONE_LINE)}else LAST_ONE_LINE=""}catch(t){LAST_ONE_LINE=""}let p=null;const m=val("totalLine").trim(),f=parseOdds(val("overOdds")),h=parseOdds(val("underOdds")),v=parsePct(val("myOverProb")),b=parsePct(val("ouPush"))??null;if(m&&null!=f&&null!=h){let n=b;if(null==n){n=((SPORT_CFG[t]||SPORT_CFG.soccer).defaults.ouPush||0)/100}const a=compute2Way(f,h,n);p=a.marginPct,o.push([`오버/언더(기준 ${m}) 승리 확률(배당 기반·추정)`,`오버 ${pct(a.probs[0])} / 언더 ${pct(a.probs[1])}${a.push>0?` / 푸시 ${(100*a.push).toFixed(1)}%`:""}`]),o.push(["오버/언더 오버라운드(보정)",a.over.toFixed(4)]);const r=classifyMargin(t,"ou",a.marginPct);if(o.push(["오버/언더 마진 판정",`<span class="${clsToTextColor(r.cls)}">${r.label}</span>`]),s.push(`오버언더 ${m}: 오버 ${f} / 언더 ${h}${a.push>0?` (푸시 근사 ${(100*a.push).toFixed(1)}%)`:""}`),c.inputs.totalLine=val("totalLine"),c.inputs.overOdds=val("overOdds"),c.inputs.underOdds=val("underOdds"),c.inputs.ouPush=val("ouPush"),c.markets.ou={over:a.over,marginPct:a.marginPct,push:a.push},"adv"===e&&null!=v){const t=parseMoney(val("stake"))||null,e=v,n=a.push,s=e*(f-1)-Math.max(0,1-e-n);o.push(["내 예상 확률(오버)",pct(v)]),o.push(["오버 EV(1원당, 푸시 근사)",(100*s).toFixed(2)+"%"]),null!=t&&o.push(["오버 기대값(EV)",money(t*s)]),o.push(["오버 권장 비중(1/4 Kelly, 참고)",(100*quarterKelly(v,f)).toFixed(1)+"%"]),o.push(["오버 판단",s>0?"밸류(+EV) 가능성":"밸류(-EV) 가능성"])}}let _=null;const y=val("handicapLine").trim(),O=parseOdds(val("handicapOddsA")),S=parseOdds(val("handicapOddsB")),g=parsePct(val("handicapPush"))??null;if(y&&null!=O&&null!=S){let e=g;if(null==e){e=((SPORT_CFG[t]||SPORT_CFG.soccer).defaults.hcPush||0)/100}const a=compute2Way(O,S,e);_=a.marginPct,o.push([`핸디캡(라인 ${y}) 승리 확률(배당 기반·추정)`,`${n.labels.A||"A"} ${pct(a.probs[0])} / ${n.labels.B||"B"} ${pct(a.probs[1])}${a.push>0?` / 푸시 ${(100*a.push).toFixed(1)}%`:""}`]),o.push(["핸디캡 오버라운드(보정)",a.over.toFixed(4)]);const r=classifyMargin(t,"hc",a.marginPct);o.push(["핸디캡 마진 판정",`<span class="${clsToTextColor(r.cls)}">${r.label}</span>`]),s.push(`핸디 ${y}: ${n.labels.A||"A"} ${O} / ${n.labels.B||"B"} ${S}${a.push>0?` (푸시 근사 ${(100*a.push).toFixed(1)}%)`:""}`),c.inputs.handicapLine=val("handicapLine"),c.inputs.handicapOddsA=val("handicapOddsA"),c.inputs.handicapOddsB=val("handicapOddsB"),c.inputs.handicapPush=val("handicapPush"),c.markets.hc={over:a.over,marginPct:a.marginPct,push:a.push}}c.advice=adviceKeyFromMetrics(c.bestEVPct,c.markets?.main?.marginPct),c.sig=function(){const t=t=>String(t??"").toLowerCase().replace(/\s+/g,""),e=t=>{const e=Number(t);return Number.isFinite(e)?e.toFixed(4):""},n=[];return n.push(t(c.sport)),n.push(c.mainMode||""),n.push(t(c.teams)),"3way"===c.mainMode?(n.push(e(c.inputs.main3OddsH)),n.push(e(c.inputs.main3OddsD)),n.push(e(c.inputs.main3OddsA))):(n.push(e(c.inputs.main2OddsA)),n.push(e(c.inputs.main2OddsB))),c.inputs.totalLine&&n.push("ou:"+t(c.inputs.totalLine)+":"+e(c.inputs.overOdds)+":"+e(c.inputs.underOdds)),c.inputs.handicapLine&&n.push("hc:"+t(c.inputs.handicapLine)+":"+e(c.inputs.handicapOddsA)+":"+e(c.inputs.handicapOddsB)),n.join("|")}(),LAST_RECORD=c,renderResult(n.name,e,o,s),renderMarginDash({sport:t,main:i,ou:p,hc:_});try{const n={sport:t,level:e,market_type:a?"3way":"2way",odds_count:a?3:2,ev_positive:c.evPositive?1:0};"number"==typeof i&&(n.main_margin_pct=+i.toFixed(4)),"number"==typeof d&&(n.main_overround=+d.toFixed(6)),"number"==typeof p&&(n.ou_margin_pct=+p.toFixed(4)),"number"==typeof _&&(n.hc_margin_pct=+_.toFixed(4)),"number"==typeof c.bestEVPct&&(n.best_ev_pct=+c.bestEVPct.toFixed(4)),track("analysis_complete",n)}catch(t){}addHistory(c),renderTop3();maybePushSnapshot(saveState(),!0),renderSnaps();try{maybeShowAdPopupAfterComplete()}catch(t){}}function renderResult(t,e,n,a){const o=$("result"),s=t=>String(t??"").replace(/<[^>]*>/g,"").trim(),r=t=>{const e=s(t).replace(/,/g,"").replace("%",""),n=parseFloat(e);return Number.isFinite(n)?n:null},l=n.find(([t])=>"오버라운드(마진 추정)"===t),c=l?r(l[1]):null,i=null!=c?100*(c-1):null;let d=null,u="mid";const p=n.find(([t])=>"메인 마진 판정"===t);if(p){const t=String(p[1]??"");d=s(t);const e=t.match(/class="([^"]+)"/),n=e?e[1]:"";u=n.includes("good")?"ok":n.includes("warn")?"bad":"mid"}const m=n.filter(([t])=>String(t).includes("승리 확률(배당 기반·추정"));let f=null;try{const t=m.map(t=>({k:s(t[0]),v:r(t[1])})).filter(t=>null!=t.v);t.length&&(f=t.reduce((t,e)=>t.v>e.v?t:e).v)}catch(t){}let h=null;try{const t=n.find(([t])=>String(t).includes("공정배당"));if(t){const e=s(t[1]).match(/([0-9]+\.[0-9]+)/);e&&(h=e[1])}}catch(t){}let v=null;m.forEach(([t,e])=>{const n=r(e);if(null==n)return;const a=String(t).match(/,\s*([^)]+)\)/),o=a?a[1]:String(t);(!v||n>v.p)&&(v={label:o,p:n})});const b=n.find(([t])=>"EV(1원당)"===t),_=b?r(b[1]):null;let y={cls:u,text:d?`메인 마진: ${d}`:"결과 요약"},O=null;null!=_&&(y={cls:_>=0?"ok":"bad",text:`밸류(${_>=0?"+":"-"}EV) ${Math.abs(_).toFixed(2)}%`},d&&(O={cls:u,text:`메인 마진: ${d}${null!=i?` (${i.toFixed(1)}%)`:""}`}));let S={cls:"warn",icon:"⚠️",text:"주의 · 입력값/근거를 확인하세요"};null!=_?S=_>=2?{cls:"good",icon:"✅",text:`추천 · +EV ${_.toFixed(2)}%`}:_>=0?{cls:"warn",icon:"⚠️",text:`주의 · 소폭 +EV ${_.toFixed(2)}%`}:{cls:"bad",icon:"⛔",text:`PASS · -EV ${Math.abs(_).toFixed(2)}%`}:null!=i&&(S=i<=3?{cls:"good",icon:"✅",text:`추천 · 마진 낮음 ${i.toFixed(1)}%`}:i<=6?{cls:"warn",icon:"⚠️",text:`주의 · 마진 보통 ${i.toFixed(1)}%`}:{cls:"bad",icon:"⛔",text:`PASS · 마진 높음 ${i.toFixed(1)}%`});const g=buildTrustLineHtml("good"===S.cls?"rec":"bad"===S.cls?"pass":"caution"),P=!(!LAST_RECORD||!LAST_RECORD.id),T=(()=>{const t=[];if(null!=_&&t.push(`EV ${(_>=0?"+":"")+_.toFixed(2)}%`),null!=i&&t.push(`마진 ${i.toFixed(1)}%`),v&&t.push(`시장 ${v.label} ${v.p.toFixed(1)}%`),!t.length)return"";let e="";return null!=_?e=_>=2?" · 밸류 구간":_>=0?" · 소폭 밸류":" · -EV":null!=i&&(e=i<=3?" · 마진 낮음":i<=6?" · 마진 보통":" · 마진 높음"),"근거: "+t.join(" · ")+e})(),A=`\n    <div class="kpiHero">\n      <div class="kpiGrid">\n        <div class="kpiItem">\n          <div class="kpiLabel">마진</div>\n          <div class="kpiValue">${null!=i?i.toFixed(1)+"%":"-"}</div>\n        </div>\n        <div class="kpiItem">\n          <div class="kpiLabel">EV</div>\n          <div class="kpiValue">${null!=_?(_>=0?"+":"-")+Math.abs(_).toFixed(2)+"%":"-"}</div>\n        </div>\n        <div class="kpiItem">\n          <div class="kpiLabel">최고확률</div>\n          <div class="kpiValue">${null!=f?f.toFixed(1)+"%":"-"}</div>\n        </div>\n        <div class="kpiItem">\n          <div class="kpiLabel">공정배당</div>\n          <div class="kpiValue">${null!=h?h:"-"}</div>\n        </div>\n      </div>\n      <div class="kpiNote">간단 레벨은 <b>메인</b>만 기준으로 빠르게 요약합니다. OU/핸디는 중급부터 확인하세요.</div>\n    </div>\n  `,L="simple"===e?A:`\n\n    <div class="resultHero">\n      <div class="heroTop">\n        <div class="heroText">\n          <div class="heroTitle">${t} · ${levelLabel(e)} 결과</div>\n          <div class="heroSub">입력값 기반 요약 · 아래 상세표로 근거를 확인하세요</div>\n        </div>\n        <div class="heroRight">\n          <div class="heroBadges">\n            <span class="chip big ${y.cls}">${y.text}</span>\n            ${O?`<span class="chip ${O.cls}">${O.text}</span>`:""}\n          </div>\n          <div class="heroConclusion ${S.cls}">\n            <span class="cIcon">${S.icon}</span>\n            <span class="cText">${S.text}</span>\n          </div>\n          <div class="trustLine">${g}</div>\n          ${T?`<div class="heroReason">${T}</div>`:""}\n          <div class="outcomeBar" ${P?"":'style="display:none;"'}>\n            <button class="oBtn" type="button" onclick="markOutcome('W')">✅ 적중</button>\n            <button class="oBtn" type="button" onclick="markOutcome('L')">❌ 미적중</button>\n            <button class="oBtn" type="button" onclick="markOutcome('V')">⚪ 취소</button>\n            <button class="oBtn" type="button" onclick="markOutcome('')">↩︎ 미기록</button>\n          </div>\n        </div>\n      </div>\n\n      <div class="heroStats">\n        <div class="statCard">\n          <div class="statK">메인 마진</div>\n          <div class="statV">${null!=i?i.toFixed(1)+"%":"—"}</div>\n          <div class="statS">${null!=c?"오버라운드 "+c.toFixed(4):"오버라운드 —"}</div>\n        </div>\n\n        <div class="statCard">\n          <div class="statK">시장 최고확률</div>\n          <div class="statV">${v?`${v.label} ${v.p.toFixed(1)}%`:"—"}</div>\n          <div class="statS">배당 역수 정규화</div>\n        </div>\n\n        <div class="statCard">\n          <div class="statK">EV</div>\n          <div class="statV">${null!=_?(_>=0?"+":"")+_.toFixed(2)+"%":"미입력"}</div>\n          <div class="statS">${null!=_?"내 예상 확률 기준":"고급모드에서 입력"}</div>\n        </div>\n      </div>\n    </div>\n  \n`,E=n.map(([t,e])=>{let n="";const a=String(e);return t.includes("판단")&&a.includes("-EV")&&(n="warn"),t.includes("판단")&&a.includes("+EV")&&(n="good"),`<div class="kv"><div class="k">${t}</div><div class="v ${n}">${e}</div></div>`}).join(""),k=document.getElementById("tplResultCard");if(k&&k.content){o.innerHTML="";const t=k.content.cloneNode(!0),e=t.querySelector('[data-r-panel="summary"]'),n=t.querySelector('[data-r-panel="detail"]'),a=t.querySelector("#resultMeta"),s=null!=_?`EV ${_>=0?"+":""}${_.toFixed(2)}%`:null!=i?`마진 ${i.toFixed(1)}%`:"";a&&(a.textContent=s),e&&(e.innerHTML=L),n&&(n.innerHTML=`\n      <div class="detailHead">상세 지표</div>\n      ${E}\n      <hr class="sep">\n      <div class="resultNote" style="font-size:12px;color:#9a9a9a;line-height:1.5;">\n        ※ “승리 확률(배당 기반·추정)”은 배당 역수를 정규화한 값(시장 기반 추정)입니다.<br>\n        ※ EV/비중은 사용자가 입력한 “내 예상 확률” 기반의 참고 지표이며 승률을 보장하지 않습니다.<br>\n        ※ 아시안(푸시) 근사는 사용자가 입력한 푸시 확률(또는 종목 기본값)로 근사합니다.\n      </div>\n    `),o.appendChild(t),initResultTabs(o)}else o.innerHTML=`\n      ${L}\n      <div class="detailHead">상세 지표</div>\n      ${E}\n      <hr class="sep">\n      <div style="font-size:12px;color:#9a9a9a;line-height:1.5;">\n        ※ “승리 확률(배당 기반·추정)”은 배당 역수를 정규화한 값(시장 기반 추정)입니다.<br>\n        ※ EV/비중은 사용자가 입력한 “내 예상 확률” 기반의 참고 지표이며 승률을 보장하지 않습니다.<br>\n        ※ 아시안(푸시) 근사는 사용자가 입력한 푸시 확률(또는 종목 기본값)로 근사합니다.\n      </div>\n    `;o.style.display="block";const R=document.getElementById("resultDock");R&&(R.style.display="flex");try{const t=document.querySelector('a[data-cta="analysis_to_vendors"]');if(t&&LAST_RECORD&&LAST_RECORD.markets&&LAST_RECORD.markets.main){const e=+LAST_RECORD.markets.main.marginPct,n=(MARGIN_RULE[LAST_RECORD.sport]||MARGIN_RULE.soccer).main||[5,7,9],a=isFinite(e)&&e<=n[0],o=!!LAST_RECORD.evPositive||a;t.classList.remove("gold","secondary","primary"),t.classList.add(o?"gold":"secondary"),t.textContent=o?"추천 업체 카드":"업체 카드"}}catch(t){}a.push(`링크: ${getShareLink()}`),LAST_TEXT=a.join("\n")+"\n\n"+n.map(t=>`${t[0]}: ${String(t[1]).replace(/<[^>]*>/g,"")}`).join("\n")}function initResultTabs(t){if(!t)return;const e=t.querySelector('[data-role="result"]');if(!e||e.__tabsBound)return;e.__tabsBound=!0;const n=Array.from(e.querySelectorAll("[data-r-tab]")),a=Array.from(e.querySelectorAll("[data-r-panel]"));function o(t){n.forEach(e=>{const n=e.getAttribute("data-r-tab")===t;e.classList.toggle("on",n),e.setAttribute("aria-selected",n?"true":"false"),e.tabIndex=n?0:-1}),a.forEach(e=>{const n=e.getAttribute("data-r-panel")===t;e.hidden=!n})}n.length&&a.length&&(o("summary"),n.forEach(t=>{t.addEventListener("click",()=>o(t.getAttribute("data-r-tab"))),t.addEventListener("keydown",t=>{if("ArrowLeft"!==t.key&&"ArrowRight"!==t.key)return;t.preventDefault();const e=n.indexOf(document.activeElement);if(e<0)return;const a="ArrowRight"===t.key?(e+1)%n.length:(e-1+n.length)%n.length;n[a].focus()})}))}function showError(t){const e=document.getElementById("resultDock");e&&(e.style.display="none");const n=$("result");n.innerHTML=`<div class="kv"><div class="k">안내</div><div class="v warn">${t}</div></div>`,n.style.display="block",LAST_TEXT=`[88 커뮤니티] 안내\n${t}\n링크: ${getShareLink()}`;try{const e=String(t||"").replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim().slice(0,80);track("analysis_error",{reason:e})}catch(t){}}function hideResult(){const t=document.getElementById("resultDock");t&&(t.style.display="none");const e=$("result");e.style.display="none",e.innerHTML="",LAST_TEXT=""}function resetAll(){["league","teams","main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA","myProb","stake","handicapLine","handicapOddsA","handicapOddsB","handicapPush","totalLine","overOdds","underOdds","ouPush","myOverProb"].forEach(t=>{const e=$(t);e&&(e.value="")}),hideResult(),localStorage.removeItem(LS_KEY),setEvFlag(!1),renderMarginDash(),toast("초기화 완료")}async function copyResult(){if(!LAST_TEXT)return showError("먼저 '계산하기'를 눌러 결과를 만든 뒤 복사할 수 있어요.");try{await navigator.clipboard.writeText(LAST_TEXT),toast("결과가 복사되었습니다.")}catch(t){prompt("아래 내용을 복사하세요:",LAST_TEXT)}}async function shareResult(){if(!LAST_TEXT)return showError("먼저 '계산하기'를 눌러 결과를 만든 뒤 공유할 수 있어요.");try{navigator.share?await navigator.share({title:"88 커뮤니티 분석 결과",text:LAST_TEXT}):await copyResult()}catch(t){}}function updateSaveBadge(t){const e=document.getElementById("saveBadge");if(!e)return;if(!t)return void(e.innerHTML='<span class="dot"></span>자동 저장');const n=new Date(t),a=String(n.getHours()).padStart(2,"0"),o=String(n.getMinutes()).padStart(2,"0");e.innerHTML=`<span class="dot"></span>자동 저장 · ${a}:${o}`}function toggleMiniGuide(){const t=document.getElementById("miniGuideBody"),e=document.getElementById("miniGuidePill");if(!t||!e)return;const n=!("block"===t.style.display);t.style.display=n?"block":"none",e.textContent=n?"닫기":"열기",e.setAttribute("aria-expanded",n?"true":"false");try{localStorage.setItem("88_mini_guide_open",n?"1":"0")}catch(t){}}function restoreMiniGuide(){try{const t=localStorage.getItem("88_mini_guide_open"),e=document.getElementById("miniGuideBody"),n=document.getElementById("miniGuidePill");if(!e||!n)return;const a="1"===t;e.style.display=a?"block":"none",n.textContent=a?"닫기":"열기",n.setAttribute("aria-expanded",a?"true":"false")}catch(t){}}function clearInvalid(){document.querySelectorAll(".is-invalid").forEach(t=>t.classList.remove("is-invalid"))}function markInvalid(t){t.forEach(t=>{const e=document.getElementById(t);e&&e.classList.add("is-invalid")});const e=document.querySelector(".is-invalid");if(e)try{e.scrollIntoView({behavior:"smooth",block:"center"})}catch(t){}}function quickJump(t){if("top"===t){try{window.scrollTo({top:0,behavior:"smooth"})}catch(t){window.scrollTo(0,0)}return}const e={main:"mainBox",total:"totalBox",handicap:"handicapBox",result:"result",history:"historyList"}[t],n=document.getElementById(e);if(n){"total"===t&&setCollapsed("totalBody",!1),"handicap"===t&&setCollapsed("handicapBody",!1);try{n.scrollIntoView({behavior:"smooth",block:"start"})}catch(t){}}}function setAppTabActive(t){const e=document.getElementById("appTabbar");e&&e.querySelectorAll(".st-tab").forEach(e=>{const n=e.getAttribute("data-jump")===t;e.classList.toggle("on",n),e.setAttribute("aria-selected",n?"true":"false")})}function initAppTabbar(){const t=document.getElementById("appTabbar");if(t&&!t.__bound){t.__bound=!0,t.addEventListener("click",t=>{const e=t.target.closest(".st-tab[data-jump]");if(!e)return;const n=e.getAttribute("data-jump");n&&(setAppTabActive(n),quickJump(n))});try{const t={main:document.getElementById("mainBox"),total:document.getElementById("totalBox"),handicap:document.getElementById("handicapBox"),result:document.getElementById("result"),history:document.getElementById("historyList")},e=Object.keys(t).filter(e=>t[e]);if(!e.length)return;const n=new IntersectionObserver(n=>{let a=null;n.forEach(n=>{if(!n.isIntersecting)return;const o=e.find(e=>t[e]===n.target);if(!o)return;const s=n.intersectionRatio;(!a||s>a.score)&&(a={which:o,score:s})}),a&&a.which&&setAppTabActive(a.which)},{root:null,threshold:[.08,.18,.28],rootMargin:"-45% 0px -50% 0px"});e.forEach(e=>{try{n.observe(t[e])}catch(t){}})}catch(t){}}}function openShareCard(){const t=document.getElementById("shareCardModal"),e=document.getElementById("result");if(t){if(!e||"none"===e.style.display||!e.innerText.trim())return showError("먼저 '계산하기'로 결과를 만든 뒤 공유 카드를 생성할 수 있어요.");try{updateBundlePromo(items)}catch(t){}t.style.display="flex",drawShareCard();try{track("share_open",{page_path:location.pathname})}catch(t){}}}function closeShareCard(){const t=document.getElementById("shareCardModal");t&&(t.style.display="none")}function getShareLink(){try{const t=new URL(location.origin+location.pathname),e=buildPermalinkState();e&&t.searchParams.set("st",e);try{if("function"==typeof getUtmQuery){const e=getUtmQuery();if(e){new URLSearchParams(e.replace(/^\?/,"")).forEach((e,n)=>{t.searchParams.get(n)||t.searchParams.set(n,e)})}}}catch(t){}return t.toString()}catch(t){return location.origin+location.pathname}}function extractResultLines(){const t=document.getElementById("result");if(!t)return[];const e=t.querySelectorAll(".kv"),n=[];return e.forEach(t=>{const e=t.querySelector(".k")?.innerText?.trim(),a=t.querySelector(".v")?.innerText?.trim();e&&a&&n.push(`${e}: ${a}`)}),n}function roundRect(t,e,n,a,o,s,r,l){const c=Math.min(s,a/2,o/2);t.beginPath(),t.moveTo(e+c,n),t.arcTo(e+a,n,e+a,n+o,c),t.arcTo(e+a,n+o,e,n+o,c),t.arcTo(e,n+o,e,n,c),t.arcTo(e,n,e+a,n,c),t.closePath(),r&&t.fill(),l&&t.stroke()}function getActiveTheme(){try{const t=document.documentElement.dataset.theme;if("light"===t||"dark"===t)return t}catch(t){}return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function getCssVar(t,e){try{return getComputedStyle(document.documentElement).getPropertyValue(t).trim()||e||""}catch(t){return e||""}}function normalizeRgb(t,e){let n=String(t||"").trim();n||(n=String(e||"")),n=n.replace(/[()]/g,"").trim();const a=n.match(/\d+/g);return!a||a.length<3?String(e||"245,226,122"):`${a[0]},${a[1]},${a[2]}`}function rgbaFrom(t,e){return`rgba(${t},${e})`}function rgbaAccent(t){return rgbaFrom(normalizeRgb(getCssVar("--accent-rgb",getCssVar("--accentRGB","245,226,122")),"245,226,122"),t)}function rgbaBlue(t){return rgbaFrom(normalizeRgb(getCssVar("--blue-rgb","90,160,255"),"90,160,255"),t)}function palette(){const t=getActiveTheme();return"light"===t?{t:t,bg0:"#ffffff",bg1:"#f2f6ff",bg2:"#ffffff",cardFill:"rgba(0,0,0,0.035)",cardStroke:"rgba(18,20,28,0.10)",text:"rgba(18,20,28,0.92)",text2:"rgba(18,20,28,0.76)",text3:"rgba(18,20,28,0.60)"}:{t:t,bg0:"#0b0b0b",bg1:"#121212",bg2:"#07070a",cardFill:"rgba(255,255,255,0.06)",cardStroke:"rgba(255,255,255,0.10)",text:"rgba(255,255,255,0.92)",text2:"rgba(255,255,255,0.80)",text3:"rgba(255,255,255,0.55)"}}function drawShareCard(){const t=document.getElementById("shareCardCanvas");if(!t)return;const e=t.getContext("2d"),n=t.width,a=t.height,o=palette(),s=e.createLinearGradient(0,0,n,a);s.addColorStop(0,o.bg0),s.addColorStop(.55,o.bg1),s.addColorStop(1,o.bg2),e.fillStyle=s,e.fillRect(0,0,n,a),e.fillStyle=rgbaAccent("light"===o.t?.1:.12),e.beginPath(),e.arc(.6*n,.15*a,330,0,2*Math.PI),e.fill(),e.fillStyle=rgbaBlue("light"===o.t?.06:.08),e.beginPath(),e.arc(.18*n,.25*a,260,0,2*Math.PI),e.fill();const r=70;e.fillStyle=o.cardFill,roundRect(e,r,r,n-140,a-140,34,!0,!1),e.strokeStyle=o.cardStroke,e.lineWidth=2,roundRect(e,r,r,n-140,a-140,34,!1,!0),e.fillStyle="#60A5FA",e.font="900 54px system-ui, -apple-system, Segoe UI, Roboto",e.fillText("88 분석 결과",110,165),e.fillStyle=o.text2,e.font="700 28px system-ui, -apple-system, Segoe UI, Roboto";const l=new Date;e.fillText(l.toLocaleString("ko-KR"),110,215);let c=!1;try{const t=(LAST_ONE_LINE||"").replace(/^요약\s*:\s*/,"").trim();if(t){const n=t.length>70?t.slice(0,70)+"…":t;e.fillStyle=o.text,e.font="900 24px system-ui, -apple-system, Segoe UI, Roboto",e.fillText(n,110,310),c=!0}}catch(t){c=!1}let i="";try{const t=document.getElementById("evFlag");t&&t.innerText&&(i=t.innerText.trim())}catch(t){}if(i){const t=110,n=240,a=340,o=54;e.fillStyle=rgbaAccent(.18),roundRect(e,t,n,a,o,999,!0,!1),e.strokeStyle=rgbaAccent(.35),e.lineWidth=2,roundRect(e,t,n,a,o,999,!1,!0),e.fillStyle="#fff",e.font="900 26px system-ui, -apple-system, Segoe UI, Roboto",e.fillText(i,t+18,n+36)}const d=extractResultLines().slice(0,12);let u=c?380:340;e.fillStyle=o.text,e.font="800 30px system-ui, -apple-system, Segoe UI, Roboto",d.forEach(t=>{const n=t.length>46?t.slice(0,46)+"…":t;e.fillText("• "+n,110,u),u+=48}),e.fillStyle=o.text2,e.font="800 26px system-ui, -apple-system, Segoe UI, Roboto",e.fillText("링크: "+getShareLink(),110,a-r-70),e.fillStyle=o.text3,e.font="700 22px system-ui, -apple-system, Segoe UI, Roboto",e.fillText("※ 판단 보조용 / 결과를 보장하지 않습니다.",110,a-r-30)}async function copyShareLink(){const t=getShareLink();try{await navigator.clipboard.writeText(t),toast("링크를 복사했습니다");try{track("share_copy_link",{page_path:location.pathname})}catch(t){}}catch(t){toast("복사 실패")}}async function copyShareText(){if(!LAST_TEXT)return showError("먼저 '계산하기'로 결과를 만든 뒤 복사할 수 있어요.");try{await navigator.clipboard.writeText(LAST_TEXT+"\n"+getShareLink()),toast("문구를 복사했습니다");try{track("share_copy_text",{page_path:location.pathname})}catch(t){}}catch(t){toast("복사 실패")}}function downloadShareCard(){const t=document.getElementById("shareCardCanvas");if(t)try{t.toBlob(t=>{if(!t)return;const e=document.createElement("a"),n=URL.createObjectURL(t);e.href=n,e.download="88-analysis-card.png",document.body.appendChild(e),e.click(),e.remove(),setTimeout(()=>URL.revokeObjectURL(n),800),toast("이미지를 저장했습니다");try{track("share_download_image",{page_path:location.pathname})}catch(t){}},"image/png",1)}catch(t){toast("저장 실패")}}function truncateText(t,e){const n=String(t||"").trim();return n?n.length>e?n.slice(0,e-1)+"…":n:""}function getBundleItems(t){const e=(readChainPack(todayStr())||[]).filter(t=>t&&t.link),n=new Set,a=[];for(const t of e)n.has(t.link)||(n.add(t.link),a.push(t));return a.sort((t,e)=>{const n="number"==typeof t.mainMarginPct?t.mainMarginPct:9999,a="number"==typeof e.mainMarginPct?e.mainMarginPct:9999;return n!==a?n-a:(e.ts||0)-(t.ts||0)}),a.slice(0,t||10)}function bundleTop3OneLine(t){const e=(t||[]).slice(0,3);if(!e.length)return"";return`TOP3: ${e.map((t,e)=>{const n=(t=>{const e=String(t||"").replace(/\s+/g," ").trim();if(!e)return"팀명";if(e.length<=14)return e;const n=e.split(/\s+vs\s+|\s+VS\s+|\s+-\s+|\s+v\s+/i);if(n.length>=2){const t=n[0].trim(),e=n[1].trim();return`${t.length>8?t.slice(0,8)+"…":t} vs ${e.length>8?e.slice(0,8)+"…":e}`}return e.slice(0,13)+"…"})(t.teams);return`${e+1}) ${n}(${"number"==typeof t.mainMarginPct?t.mainMarginPct.toFixed(2)+"%":"-"})`}).join(" / ")}`}function buildBundleText(t){const e=todayStr(),n=[];n.push(`[88ST] 오늘 수집 ${t.length}경기 (마진 낮은 순) · ${e}`),n.push("분석기: https://88st.cloud/analysis/");const a=bundleTop3OneLine(t);return"none"===linksMode&&commentOn&&(compact,n.push(commentCtaLine(channelKey))),a&&n.push(a),n.push(""),t.forEach((t,e)=>{const a=(SPORT_CFG[t.sport]||SPORT_CFG.soccer).name||t.sport||"",o=t.teams&&t.teams.trim()?t.teams.trim():"팀명 미입력",s="number"==typeof t.mainMarginPct?`마진 ${t.mainMarginPct.toFixed(2)}%`:"마진 -",r="number"==typeof t.bestEVPct?`EV ${t.bestEVPct>=0?"+":"-"}${Math.abs(t.bestEVPct).toFixed(2)}%`:"EV 미입력";n.push(`${e+1}) ${o}`),n.push(`   ${a} · ${s} · ${r}`),n.push(`   ${t.link}`),n.push("")}),n.push("※ 판단 보조용 / 결과를 보장하지 않습니다."),n.join("\n")}function buildBundleLinks(t){return t.map(t=>t.link).join("\n")}function drawBundleCard(t){const e=document.getElementById("bundleCanvas");if(!e)return;const n=e.getContext("2d"),a=e.width,o=e.height,s=palette(),r=n.createLinearGradient(0,0,a,o);r.addColorStop(0,s.bg0),r.addColorStop(.55,s.bg1),r.addColorStop(1,s.bg2),n.fillStyle=r,n.fillRect(0,0,a,o),n.fillStyle=rgbaAccent("light"===s.t?.1:.12),n.beginPath(),n.arc(.62*a,.18*o,330,0,2*Math.PI),n.fill(),n.fillStyle=rgbaBlue("light"===s.t?.06:.08),n.beginPath(),n.arc(.18*a,.28*o,260,0,2*Math.PI),n.fill();const l=70;n.fillStyle=s.cardFill,roundRect(n,l,l,a-140,o-140,34,!0,!1),n.strokeStyle=s.cardStroke,n.lineWidth=2,roundRect(n,l,l,a-140,o-140,34,!1,!0),n.fillStyle="#60A5FA",n.font="900 50px system-ui, -apple-system, Segoe UI, Roboto",n.fillText("88 오늘 수집",110,162),n.fillStyle=s.text2,n.font="800 26px system-ui, -apple-system, Segoe UI, Roboto",n.fillText(`${todayStr()} · 마진 낮은 순 TOP${t.length}`,110,210);const c=bundleTop3OneLine(t);let i=280;if(c){n.fillStyle=s.text3,n.font="900 22px system-ui, -apple-system, Segoe UI, Roboto";const t=truncateText(c,54);n.fillText(t,110,248),i=312}let d=i;t.slice(0,10).forEach((t,e)=>{const a=truncateText(t.teams&&t.teams.trim()?t.teams.trim():"팀명 미입력",28),o=(SPORT_CFG[t.sport]||SPORT_CFG.soccer).name||t.sport||"",s="number"==typeof t.mainMarginPct?`마진 ${t.mainMarginPct.toFixed(2)}%`:"마진 -",r="number"==typeof t.bestEVPct?`EV ${t.bestEVPct>=0?"+":"-"}${Math.abs(t.bestEVPct).toFixed(2)}%`:"EV 미입력";n.fillStyle="rgba(255,255,255,0.94)",n.font="900 30px system-ui, -apple-system, Segoe UI, Roboto",n.fillText(`${e+1}. ${a}`,110,d),n.fillStyle="rgba(255,255,255,0.78)",n.font="800 22px system-ui, -apple-system, Segoe UI, Roboto",n.fillText(`${o} · ${s} · ${r}`,110,d+34),d+=74}),n.fillStyle="rgba(255,255,255,0.70)",n.font="800 24px system-ui, -apple-system, Segoe UI, Roboto",n.fillText("88st.cloud/analysis",110,o-l-58),n.fillStyle=s.text3,n.font="700 20px system-ui, -apple-system, Segoe UI, Roboto",n.fillText("※ 텍스트에 각 경기 복원 링크 포함",110,o-l-28)}function openBundleShare(){const t=getBundleItems(10);if(!t.length)return void toast("오늘 수집된 항목이 아직 없어요. (텍스트 붙여넣기에서 '연속 저장' 또는 '클릭=연속 저장'을 사용해줘)");const e=document.getElementById("bundleShareModal");if(!e)return;const n=document.getElementById("bundleTitle"),a=document.getElementById("bundleMeta"),o=document.getElementById("bundleText");if(n&&(n.textContent=`오늘 수집 묶음 (${t.length}경기)`),o&&(o.value=buildBundleText(t)),a){const e=t.map(t=>"number"==typeof t.mainMarginPct?t.mainMarginPct:null).filter(t=>null!=t),n=e.length?Math.min(...e):null,o=e.length?e.reduce((t,e)=>t+e,0)/e.length:null,s=t.filter(t=>"number"==typeof t.bestEVPct&&t.bestEVPct>0).length,r=t=>`<span class="bundle-pill">${t}</span>`,l=bundleTop3OneLine(t);a.innerHTML=`<div class="bundle-mini"><b>${todayStr()}</b> · ${t.length}개</div><div class="bundle-mini">`+r(null!=n?`최저 마진 ${n.toFixed(2)}%`:"최저 마진 -")+r(null!=o?`평균 마진 ${o.toFixed(2)}%`:"평균 마진 -")+r(`+EV ${s}개`)+"</div>"+(l?`<div class="bundle-mini">${safeText(l)}</div>`:"")}e.style.display="flex",drawBundleCard(t);try{track("bundle_open",{count:t.length,page_path:location.pathname})}catch(t){}}async function copyBundleTop3(){const t=getBundleItems(10);if(!t.length)return;const e=bundleTop3OneLine(t);if(e)try{await navigator.clipboard.writeText(e),toast("TOP3 요약을 복사했습니다");try{track("bundle_copy_top3",{page_path:location.pathname})}catch(t){}}catch(t){toast("복사 실패")}}function resetBundleToday(){if(confirm("오늘 수집 묶음을 초기화할까요?\n\n• 히스토리(저장 기록)는 유지됩니다\n• '오늘 수집 묶음'만 비워집니다")){try{localStorage.removeItem(chainPackKey(todayStr()))}catch(t){}try{updateBundleButton()}catch(t){}toast("오늘 수집 묶음을 초기화했습니다");try{track("bundle_reset",{page_path:location.pathname})}catch(t){}try{closeBundleShare()}catch(t){}}}function closeBundleShare(){const t=document.getElementById("bundleShareModal");t&&(t.style.display="none")}async function copyBundleText(){const t=document.getElementById("bundleText");if(t&&t.value)try{await navigator.clipboard.writeText(t.value),toast("묶음 문구를 복사했습니다");try{track("bundle_copy_text",{page_path:location.pathname})}catch(t){}}catch(t){toast("복사 실패")}}async function copyBundleLinks(){const t=getBundleItems(10);if(!t.length)return;const e=buildBundleLinks(t);try{await navigator.clipboard.writeText(e),toast("링크만 복사했습니다");try{track("bundle_copy_links",{count:t.length,page_path:location.pathname})}catch(t){}}catch(t){toast("복사 실패")}}const BUNDLE_PROMO_LS_CH="88_bundle_promo_channel",BUNDLE_PROMO_LS_STYLE="88_bundle_promo_style",BUNDLE_PROMO_LS_LINKS="88_bundle_promo_links",BUNDLE_PROMO_LS_SHORTURL="88_bundle_promo_short_url",BUNDLE_PROMO_LS_COMPACT="88_bundle_promo_compact",BUNDLE_PROMO_LS_VENDOR="88_bundle_promo_vendor",BUNDLE_PROMO_LS_ONE_TGT="88_bundle_promo_one_target",BUNDLE_PROMO_LS_VAR="88_bundle_promo_variant",BUNDLE_PROMO_LS_PRESET="88_bundle_promo_preset",BUNDLE_PROMO_LS_COMMENT="88_bundle_promo_comment",BUNDLE_PROMO_LS_VTHR_M="88_bundle_promo_vthr_margin",BUNDLE_PROMO_LS_VTHR_EVC="88_bundle_promo_vthr_evcount",BUNDLE_PROMO_LS_ADV_OPEN="88_bundle_promo_adv_open",BUNDLE_PROMO_CHANNELS=[{key:"tochatsa",label:"토찾사",source:"tochatsa",medium:"community",preset:{style:"promo",links:"top3",compact:!1,shortUrl:!1,vendor:!0,oneTarget:"analysis",comment:!1,enforce:{}},forbidden:[]},{key:"toto_hot",label:"토토핫",source:"toto_hot",medium:"community",preset:{style:"promo",links:"top3",compact:!1,shortUrl:!1,vendor:!0,oneTarget:"analysis",comment:!1,enforce:{}},forbidden:[]},{key:"mt_dajava",label:"먹튀다자바",source:"mt_dajava",medium:"community",preset:{style:"info",links:"one",compact:!0,shortUrl:!0,vendor:!1,oneTarget:"analysis",comment:!1,enforce:{links:!0,vendor:!0,style:!1,compact:!1,shortUrl:!1,comment:!1}},forbidden:["홍보","가입","쿠폰","코드","추천","🎁"]},{key:"meokjab",label:"먹잡",source:"meokjab",medium:"community",preset:{style:"info",links:"one",compact:!0,shortUrl:!0,vendor:!1,oneTarget:"analysis",comment:!1,enforce:{links:!0,vendor:!0,style:!1,compact:!1,shortUrl:!1,comment:!1}},forbidden:["홍보","가입","쿠폰","코드","추천","🎁"]},{key:"toto_town",label:"토토타운",source:"toto_town",medium:"community",preset:{style:"promo",links:"top3",compact:!1,shortUrl:!1,vendor:!0,oneTarget:"analysis",comment:!1,enforce:{}},forbidden:[]},{key:"chongpan_guard",label:"총판구조대",source:"chongpan_guard",medium:"community",preset:{style:"promo",links:"top5",compact:!0,shortUrl:!1,vendor:!0,oneTarget:"analysis",comment:!1,enforce:{}},forbidden:["무료"]},{key:"powerball_auto",label:"파워볼오토",source:"powerball_auto",medium:"community",preset:{style:"promo",links:"one",compact:!0,shortUrl:!0,vendor:!0,oneTarget:"analysis",comment:!1,enforce:{}},forbidden:[]},{key:"daumde",label:"다음드",source:"daumde",medium:"community",preset:{style:"promo",links:"top3",compact:!1,shortUrl:!1,vendor:!0,oneTarget:"analysis",comment:!1,enforce:{}},forbidden:[]},{key:"tg_freepromo",label:"텔레그램 토토자유홍보방",source:"tg_freepromo",medium:"telegram",preset:{style:"tg",links:"top3",compact:!0,shortUrl:!1,vendor:!0,oneTarget:"analysis",comment:!1,enforce:{}},forbidden:["댓글"]},{key:"etc",label:"기타",source:"etc",medium:"community",preset:{style:"promo",links:"top3",compact:!1,shortUrl:!1,vendor:!0,oneTarget:"analysis",comment:!1,enforce:{}},forbidden:[]}];function getPromoChannel(t){return BUNDLE_PROMO_CHANNELS.find(e=>e.key===t)||BUNDLE_PROMO_CHANNELS[0]}function promoUtm(t,e){const n=getPromoChannel(t),a=n.source||n.key||t||"community";return{utm_source:a,utm_medium:n.medium||"community",utm_campaign:"bundle_w1",utm_content:`${a}_${e}_${todayStr().replace(/-/g,"")}`}}function stripUtmFromUrl(t){try{const e=new URL(t,location.origin),n=[...e.searchParams.keys()];for(const t of n)/^utm_/i.test(t)&&e.searchParams.delete(t);return e.toString()}catch(e){return t}}function applyUtmToUrl(t,e){try{const n=new URL(stripUtmFromUrl(t),location.origin);for(const[t,a]of Object.entries(e||{}))null!=a&&""!==a&&n.searchParams.set(t,a);return n.toString()}catch(e){return t}}function fmtUrlForBoard(t,e){if(!t)return"";let n=String(t);return e&&(n=stripUtmFromUrl(n),n=n.replace(/^https?:\/\//i,""),n=n.replace(/\/$/,"")),n}const PROMO_VARIANTS=3,PROMO_TEMPLATES={promo:{titles:[(t,e)=>`무료 배당분석기 · 오늘 마진 낮은 경기 TOP${t} (복원 링크)`,(t,e)=>`[무료] 오버라운드(마진) 낮은 경기 TOP${t} · ${e}`,(t,e)=>`마진 낮은 배당만 빠르게 정리 (TOP${t}) · ${e}`],leads:[()=>"배당 2~3개 입력하면 마진/공정배당/EV를 한 번에 정리합니다. 아래는 오늘 수집(마진 낮은 순)입니다.",()=>"예측이 아니라 “판단 비용 절감”용 정리입니다. 링크를 열면 입력/결과가 그대로 복원됩니다.",()=>"커뮤니티에 근거 남기기 편하게 만들었습니다. 텍스트 붙여넣기 → 자동 계산/저장됩니다."],headers:[t=>`오늘 수집 ${t}경기 (마진 낮은 순)`,t=>`오늘 정리 ${t}경기 · 마진 기준`,t=>`오늘 TOP${t} · 마진 정렬`]},info:{titles:[(t,e)=>`오버라운드(마진) 낮은 경기 TOP${t} 정리 · ${e}`,(t,e)=>`배당 ‘비용(마진)’ 낮은 라인 모음(TOP${t}) · ${e}`,(t,e)=>`마진/공정배당/EV 빠른 체크(TOP${t}) · ${e}`],leads:[()=>"마진(오버라운드)이 낮을수록 동일 배당에서도 비용이 적은 편입니다. 아래 링크는 열면 동일 결과가 복원됩니다.",()=>"배당을 ‘예측’하는 게 아니라, 숫자로 정리해서 판단을 빠르게 하는 도구입니다. 복원 링크 포함.",()=>"마진/공정배당/EV를 한 번에 계산합니다. 커뮤니티 공유용으로 복원 링크를 같이 붙였습니다."],headers:[t=>`TOP${t} (마진 낮은 순)`,t=>`오늘 체크한 TOP${t}`,t=>`마진 기준 TOP${t}`]},tg:{titles:[(t,e)=>`무료 배당 마진(오버라운드) · 오늘 TOP${t} (복원 링크)`,(t,e)=>`오늘 경기 정리 TOP${t} · 마진/EV (복원 링크)`,(t,e)=>`텍스트 붙여넣기 수집 · 오늘 TOP${t} (복원 링크)`],leads:[()=>"텍스트 붙여넣기로 수집한 오늘 경기들입니다. 링크 열면 결과 그대로 복원됩니다.",()=>"무료 분석기: 마진/공정배당/EV 정리용. 아래는 오늘 수집 TOP입니다.",()=>"오늘 체크용으로 정리해둔 리스트 공유합니다. 복원 링크 포함."],headers:[t=>`오늘 TOP${t} (마진 낮은 순)`,t=>`TOP${t} 리스트`,t=>`오늘 수집 TOP${t}`]}};function nextPromoVariant(){let t=0;try{t=parseInt(localStorage.getItem(BUNDLE_PROMO_LS_VAR)||"0",10)||0}catch(e){t=0}const e=Math.floor(3*Math.random()),n=e===t?(e+1)%3:e;try{localStorage.setItem(BUNDLE_PROMO_LS_VAR,String(n))}catch(t){}return n}function currentPromoVariant(){let t=0;try{t=parseInt(localStorage.getItem(BUNDLE_PROMO_LS_VAR)||"0",10)||0}catch(e){t=0}return(t<0||t>=3)&&(t=0),t}function pickTemplate(t,e,n){const a=PROMO_TEMPLATES[t]||PROMO_TEMPLATES.promo,o=todayStr(),s=Math.max(0,Math.min(2,0|e));return{title:a.titles[s](n,o),lead:a.leads[s](),header:a.headers[s](n)}}const PROMO_VENDOR_POOL=["card10","card11","card8","card7"],PROMO_VENDOR_FIXED=["card1","card2","card3","card4"],PROMO_VENDOR_DATA={card1:{title:"어느날",benefit:"입플 5+2 / 10+3 / 20+4 · 첫충 10% (고액전용)"},card2:{title:"OK Bet",benefit:"신규 77만원 · 코인 입/출금 · 업데이트"},card3:{title:"SPEED Bet",benefit:"신규 77만원 · 코인 입/출금 · 업데이트"},card4:{title:"VEGAS",benefit:"고액전용 · 입플 최대 30% · 카지노 입플"},card7:{title:"CAPS",benefit:"미겜 첫충 5% · 페이백 5% · 출석 30만원"},card8:{title:"BETZY",benefit:"스포츠 첫충 10% · 페이백 5% · 출석 30만원"},card10:{title:"RED HULK",benefit:"신규 30% · 매충 10% · 페이백 5%"},card11:{title:"TOP GUN",benefit:"신규 30% · 매충 10% · 페이백 5%"}};function hashStr(t){t=String(t||"");let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e=Math.imul(e,16777619);return e>>>0}function getVendorThresholds(){const t=document.getElementById("bundleVendorMargin"),e=document.getElementById("bundleVendorEv");let n=null,a=null;if(t&&(n=parseFloat(t.value)),e&&(a=parseInt(e.value,10)),!(n>=0)){const t=localStorage.getItem(BUNDLE_PROMO_LS_VTHR_M);null!=t&&(n=parseFloat(t))}if(!(a>=0)){const t=localStorage.getItem(BUNDLE_PROMO_LS_VTHR_EVC);null!=t&&(a=parseInt(t,10))}return n>=0||(n=3.2),a>=0||(a=1),{marginMax:n,posEvMin:a}}function shouldInsertVendor(t,e){e=e||getVendorThresholds();const n=(t||[]).map(t=>"number"==typeof t.mainMarginPct?t.mainMarginPct:null).filter(t=>null!=t),a=n.length?Math.min(...n):null,o=(t||[]).filter(t=>"number"==typeof t.bestEVPct&&t.bestEVPct>0).length;return null!=a&&a<=e.marginMax||o>=e.posEvMin}function pickVendorId(t){const e=hashStr(`${todayStr()}|${t}|vendor`)%PROMO_VENDOR_POOL.length;return PROMO_VENDOR_POOL[e]||"card2"}function vendorLine(t,e,n,a){const o=PROMO_VENDOR_DATA[a]||PROMO_VENDOR_DATA.card2,s=applyUtmToUrl((location&&location.origin?location.origin:"https://88st.cloud").replace(/\/$/,"")+`/cert/?v=${a}`,t),r=n?fmtUrlForBoard(s,e):"",l=o.benefit?o.benefit:"";return r?`🎁 인증업체 1개(조건부): ${o.title} · ${l} · ${r}`:`🎁 인증업체 1개(조건부): ${o.title} · ${l}`}function buildBundlePromo(t,e){e=e||{};const n=document.getElementById("bundlePromoChannel"),a=document.getElementById("bundlePromoStyle"),o=document.getElementById("bundlePromoLinks"),s=document.getElementById("bundlePromoShortUrl"),r=document.getElementById("bundlePromoCompact"),l=document.getElementById("bundlePromoVendor"),c=document.getElementById("bundlePromoOneTarget"),i=document.getElementById("bundlePromoPreset"),d=document.getElementById("bundlePromoComment"),u=!(!i||!i.checked),p=(!d||d.checked,n?n.value:"tochatsa");let m=a?a.value:"promo";try{clearPresetEnforcement(),applyPresetToUI(p,u)}catch(t){}m=a?a.value:"promo";const f=o?o.value:"top3",h=!(!s||!s.checked),v=!(!r||!r.checked),b=!(!l||!l.checked),_=c?c.value:"analysis",y=promoUtm(p,m),O=applyUtmToUrl((location&&location.origin?location.origin:"https://88st.cloud").replace(/\/$/,"")+"/analysis/",y),S=Math.min(10,(t||[]).length),g="top5"===f?5:"all"===f?S:3,P=pickTemplate(m,e.advanceVariant?nextPromoVariant():currentPromoVariant(),Math.min(g,S)),$=bundleTop3OneLine(t),T="none"!==f,A="one"===f,L="top3"===f||"top5"===f||"all"===f,E=T&&(!A||"analysis"===_),k=T&&(!A||"vendor"===_),R=[];if(R.push(P.title),E){const t=fmtUrlForBoard(O,h);v?R.push(`${P.lead} · 분석기: ${t}`):(R.push(P.lead),R.push(`분석기(무료): ${t}`))}else{const t="none"===f?"88st[dot]cloud 접속 → /analysis":"분석기: 88st[dot]cloud/analysis";v?R.push(`${P.lead} · ${t}`):(R.push(P.lead),R.push(t))}$&&(v?R.push($.replace(/^TOP3:\s*/,"TOP3: ")):R.push($));let M=!1;if(b&&shouldInsertVendor(t,getVendorThresholds())){const t=vendorLine(y,h,k,pickVendorId(p));v?R.push(t):(R.push(""),R.push(t),R.push("")),M=!0}else v||R.push("");const B=P.header||`오늘 수집 ${S}경기`;R.push(B);const V=(t||[]).slice(0,S);for(let t=0;t<V.length;t++){const e=V[t],n=(SPORT_CFG[e.sport]||SPORT_CFG.soccer).name||e.sport||"",a=e.teams&&String(e.teams).trim()?String(e.teams).trim():`경기 ${t+1}`,o="number"==typeof e.mainMarginPct?`마진 ${e.mainMarginPct.toFixed(2)}%`:"마진 -",s="number"==typeof e.bestEVPct?`EV ${e.bestEVPct>=0?"+":"-"}${Math.abs(e.bestEVPct).toFixed(2)}%`:"EV 미입력";let r="tg"===m?`${t+1}) ${a} · ${o} · ${s}`:`${t+1}) ${a} (${n}) · ${o} · ${s}`;if(L&&t<g){const t=fmtUrlForBoard(applyUtmToUrl(e.link||"",y),h);if(t){if(!v){R.push(r),R.push(`   링크: ${t}`),v||R.push("");continue}r+=` · 링크 ${t}`}}R.push(r),v||R.push("")}L?g<S&&R.push(`※ 링크는 TOP${g}만 포함(게시판 규칙/필터 대응).`):(v||R.push(""),R.push("※ 복원 링크는 분석기에서 ‘오늘 수집 묶음’ → ‘문구/링크 복사’로 얻을 수 있어요.")),R.push("※ 링크 열면 입력/결과가 그대로 복원됩니다(st)");let C=R.join("\n");return C=v?C.replace(/\n{2,}/g,"\n").trim():C.replace(/\n{3,}/g,"\n\n").trim(),C=sanitizePromoText(C,p,u),{title:P.title,lead:P.lead,text:C,channelKey:p,styleKey:m,linksMode:f,shortUrl:h,compact:v,vendorInserted:M,oneTarget:_}}function updateBundlePromo(t,e){const n=document.getElementById("bundlePromoText");if(!n)return;const a=buildBundlePromo(t||getBundleItems(10),e||{});n.value=a.text||""}function toggleBundlePromoAdv(){const t=document.getElementById("bundlePromoAdv"),e=document.getElementById("btnPromoAdv");if(!t)return;const n="none"!==t.style.display;t.style.display=n?"none":"",e&&(e.textContent=n?"고급":"고급 닫기");try{localStorage.setItem(BUNDLE_PROMO_LS_ADV_OPEN,n?"0":"1")}catch(t){}}function regenBundlePromo(){try{updateBundlePromo(getBundleItems(10),{advanceVariant:!0}),toast("새 문구로 바꿨어요")}catch(t){}}async function copyBundlePromo(){const t=getBundleItems(10);if(!t.length)return;const e=buildBundlePromo(t,{advanceVariant:!0});try{await navigator.clipboard.writeText(e.text),toast("홍보글을 복사했습니다");try{track("bundle_copy_promo",{channel:e.channelKey,tone:e.styleKey,links:e.linksMode,short_url:e.shortUrl?1:0,compact:e.compact?1:0,vendor:e.vendorInserted?1:0,page_path:location.pathname})}catch(t){}}catch(t){toast("복사 실패")}}async function copyBundlePromoTitle(){const t=getBundleItems(10);if(!t.length)return;const e=buildBundlePromo(t);try{await navigator.clipboard.writeText(e.title),toast("제목을 복사했습니다");try{track("bundle_copy_promo_title",{channel:e.channelKey,tone:e.styleKey,page_path:location.pathname})}catch(t){}}catch(t){toast("복사 실패")}}async function copyBundlePromoLead(){const t=getBundleItems(10);if(!t.length)return;const e=buildBundlePromo(t);try{await navigator.clipboard.writeText(e.lead),toast("말머리를 복사했습니다");try{track("bundle_copy_promo_lead",{channel:e.channelKey,tone:e.styleKey,page_path:location.pathname})}catch(t){}}catch(t){toast("복사 실패")}}function setupBundlePromo(){const t=document.getElementById("bundlePromoChannel"),e=document.getElementById("bundlePromoStyle"),n=document.getElementById("bundlePromoLinks"),a=document.getElementById("bundlePromoOneTarget"),o=document.getElementById("bundlePromoShortUrl"),s=document.getElementById("bundlePromoCompact"),r=document.getElementById("bundlePromoVendor"),l=document.getElementById("bundlePromoPreset"),c=document.getElementById("bundlePromoComment"),i=document.getElementById("bundleVendorMargin"),d=document.getElementById("bundleVendorEv"),u=document.getElementById("bundleVendorMarginVal"),p=document.getElementById("bundleVendorEvVal"),m=document.getElementById("bundlePromoAdv"),f=document.getElementById("btnPromoAdv");if(!t||!e||!n)return;if(!t.options.length)for(const e of BUNDLE_PROMO_CHANNELS){const n=document.createElement("option");n.value=e.key,n.textContent=e.label,t.appendChild(n)}const h=localStorage.getItem(BUNDLE_PROMO_LS_CH)||"tochatsa",v=localStorage.getItem(BUNDLE_PROMO_LS_STYLE),b=localStorage.getItem(BUNDLE_PROMO_LS_LINKS)||"top3",_=localStorage.getItem(BUNDLE_PROMO_LS_SHORTURL),y=localStorage.getItem(BUNDLE_PROMO_LS_COMPACT),O=localStorage.getItem(BUNDLE_PROMO_LS_VENDOR),S=localStorage.getItem(BUNDLE_PROMO_LS_ONE_TGT)||"analysis",g=localStorage.getItem(BUNDLE_PROMO_LS_PRESET),P=localStorage.getItem(BUNDLE_PROMO_LS_COMMENT),$=localStorage.getItem(BUNDLE_PROMO_LS_VTHR_M),T=localStorage.getItem(BUNDLE_PROMO_LS_VTHR_EVC),A=localStorage.getItem(BUNDLE_PROMO_LS_ADV_OPEN);[...t.options].some(t=>t.value===h)&&(t.value=h);const L=getPromoChannel(t.value),E=L&&L.defaultStyle?L.defaultStyle:"promo";v&&[...e.options].some(t=>t.value===v)?e.value=v:e.value=E;try{clearPresetEnforcement(),applyPresetToUI(t.value,!(!l||!l.checked))}catch(t){}if([...n.options].some(t=>t.value===b)&&(n.value=b),a&&[...a.options].some(t=>t.value===S)&&(a.value=S),o&&(o.checked="1"===_||"true"===_),s&&(s.checked="1"===y||"true"===y),r&&(r.checked=null==O||("1"===O||"true"===O)),l&&(l.checked=null==g||("1"===g||"true"===g)),c&&(c.checked="1"===P||"true"===P),i){const t=null!=$?parseFloat($):parseFloat(i.value);t>=0&&(i.value=String(t)),u&&(u.textContent=parseFloat(i.value).toFixed(1))}if(d){const t=null!=T?parseInt(T,10):parseInt(d.value,10);t>=0&&(d.value=String(t)),p&&(p.textContent=String(parseInt(d.value,10)))}if(m){const t="1"===A||"true"===A;m.style.display=t?"":"none",f&&(f.textContent=t?"고급 닫기":"고급")}try{clearPresetEnforcement(),applyPresetToUI(t.value,!(!l||!l.checked))}catch(t){}if(l&&(l.checked=null==g||("1"===g||"true"===g)),c&&(c.checked="1"===P||"true"===P),i){const t=null!=$?parseFloat($):parseFloat(i.value);t>=0&&(i.value=String(t))}if(d){const t=null!=T?parseInt(T,10):parseInt(d.value,10);t>=0&&(d.value=String(t))}u&&i&&(u.textContent=parseFloat(i.value).toFixed(1)),p&&d&&(p.textContent=String(parseInt(d.value,10)));try{const t=document.getElementById("bundlePromoAdv"),e=document.getElementById("btnPromoAdv"),n="1"===A||"true"===A;t&&(t.style.display=n?"":"none"),e&&(e.textContent=n?"고급 닫기":"고급")}catch(t){}const k=(m=!1)=>{try{localStorage.setItem(BUNDLE_PROMO_LS_CH,t.value)}catch(t){}try{localStorage.setItem(BUNDLE_PROMO_LS_STYLE,e.value)}catch(t){}try{localStorage.setItem(BUNDLE_PROMO_LS_LINKS,n.value)}catch(t){}try{o&&localStorage.setItem(BUNDLE_PROMO_LS_SHORTURL,o.checked?"1":"0")}catch(t){}try{s&&localStorage.setItem(BUNDLE_PROMO_LS_COMPACT,s.checked?"1":"0")}catch(t){}try{r&&localStorage.setItem(BUNDLE_PROMO_LS_VENDOR,r.checked?"1":"0")}catch(t){}try{a&&localStorage.setItem(BUNDLE_PROMO_LS_ONE_TGT,a.value)}catch(t){}try{l&&localStorage.setItem(BUNDLE_PROMO_LS_PRESET,l.checked?"1":"0")}catch(t){}try{c&&localStorage.setItem(BUNDLE_PROMO_LS_COMMENT,c.checked?"1":"0")}catch(t){}try{i&&localStorage.setItem(BUNDLE_PROMO_LS_VTHR_M,String(parseFloat(i.value)))}catch(t){}try{d&&localStorage.setItem(BUNDLE_PROMO_LS_VTHR_EVC,String(parseInt(d.value,10)))}catch(t){}try{u&&i&&(u.textContent=parseFloat(i.value).toFixed(1))}catch(t){}try{p&&d&&(p.textContent=String(parseInt(d.value,10)))}catch(t){}a&&(a.style.display="one"===n.value?"":"none");try{clearPresetEnforcement(),applyPresetToUI(t.value,!(!l||!l.checked))}catch(t){}try{updateBundlePromo(getBundleItems(10),{advanceVariant:!!m})}catch(t){}};t.addEventListener("change",()=>{const n=getPromoChannel(t.value);!!(!l||!l.checked)&&n&&n.defaultStyle&&(e.value=n.defaultStyle),k(!0)}),e.addEventListener("change",()=>k(!0)),n.addEventListener("change",()=>{try{c&&"none"===n.value&&null==localStorage.getItem(BUNDLE_PROMO_LS_COMMENT)&&(c.checked=!0)}catch(t){}k(!0)}),a&&a.addEventListener("change",()=>k(!0)),o&&o.addEventListener("change",()=>k(!0)),s&&s.addEventListener("change",()=>k(!0)),r&&r.addEventListener("change",()=>k(!0)),k(!1)}function downloadBundleCard(){const t=document.getElementById("bundleCanvas");if(t)try{t.toBlob(t=>{if(!t)return;const e=document.createElement("a"),n=URL.createObjectURL(t);e.href=n,e.download="88-bundle-today.png",document.body.appendChild(e),e.click(),e.remove(),setTimeout(()=>URL.revokeObjectURL(n),800),toast("이미지를 저장했습니다");try{track("bundle_download_image",{page_path:location.pathname})}catch(t){}},"image/png",1)}catch(t){toast("저장 실패")}}function setupBundleBackdropClose(){const t=document.getElementById("bundleShareModal");t&&(t.addEventListener("click",e=>{e.target===t&&closeBundleShare()}),document.addEventListener("keydown",e=>{if("Escape"===e.key)try{"flex"===t.style.display&&closeBundleShare()}catch(t){}}))}function setupShareCardBackdropClose(){const t=document.getElementById("shareCardModal");t&&t.addEventListener("click",e=>{e.target===t&&closeShareCard()})}let toastTimer=null;function toast(t){const e=document.getElementById("toast88");e&&(e.textContent=t,e.style.opacity="1",toastTimer&&clearTimeout(toastTimer),toastTimer=setTimeout(()=>{e.style.opacity="0"},1400))}function renderMarginDash(t){const e=t?.sport||val("sport")||"soccer",n=SPORT_CFG[e]||SPORT_CFG.soccer,a="3way"===n.main;let o=null;try{if(a){const t=parseOdds(val("main3OddsH")),e=parseOdds(val("main3OddsD")),n=parseOdds(val("main3OddsA"));t&&e&&n&&(o=compute3Way(t,e,n).marginPct)}else{const t=parseOdds(val("main2OddsA")),e=parseOdds(val("main2OddsB"));t&&e&&(o=compute2Way(t,e,0).marginPct)}}catch(t){}let s=null;try{const t=parseOdds(val("overOdds")),e=parseOdds(val("underOdds"));if(t&&e){let a=parsePct(val("ouPush"));null==a&&(a=(n.defaults.ouPush||0)/100),s=compute2Way(t,e,a).marginPct}}catch(t){}let r=null;try{const t=parseOdds(val("handicapOddsA")),e=parseOdds(val("handicapOddsB"));if(t&&e){let a=parsePct(val("handicapPush"));null==a&&(a=(n.defaults.hcPush||0)/100),r=compute2Way(t,e,a).marginPct}}catch(t){}t&&("number"==typeof t.main&&(o=t.main),"number"==typeof t.ou&&(s=t.ou),"number"==typeof t.hc&&(r=t.hc));const l=[{key:"main",title:"메인",margin:o},{key:"ou",title:"오버/언더",margin:s},{key:"hc",title:"핸디캡",margin:r}].map(t=>{if("number"!=typeof t.margin)return`\n        <div class="m-card">\n          <div class="m-head">\n            <div class="m-name">${t.title}</div>\n            <div class="chip mid">미입력</div>\n          </div>\n          <div class="m-lines">배당을 입력하면 마진/판정이 표시됩니다.</div>\n        </div>\n      `;const n=classifyMargin(e,t.key,t.margin);return`\n      <div class="m-card">\n        <div class="m-head">\n          <div class="m-name">${t.title}</div>\n          <div class="chip ${n.cls}">${n.label}</div>\n        </div>\n        <div class="m-lines">\n          기준(낮음/보통/주의): <b>${MARGIN_RULE[e][t.key][0]}%</b> / <b>${MARGIN_RULE[e][t.key][1]}%</b> / <b>${MARGIN_RULE[e][t.key][2]}%</b>\n        </div>\n      </div>\n    `}).join(""),c=document.getElementById("marginDash");c&&(c.innerHTML=l)}function readHistory(){try{const t=localStorage.getItem(HIST_KEY);if(!t)return[];const e=JSON.parse(t);return Array.isArray(e)?e:[]}catch(t){return[]}}function writeHistory(t){localStorage.setItem(HIST_KEY,JSON.stringify(t.slice(0,50)))}function addHistory(t){const e=readHistory();e.unshift(t),writeHistory(e);try{track("save_history",{sport:t.sport,level:t.level,market_type:t.mainMode?t.mainMode:"3way"===(SPORT_CFG[t.sport]||SPORT_CFG.soccer).main?"3way":"2way"})}catch(t){}renderHistory(),syncToggleLabels()}function clearHistory(){confirm("히스토리를 모두 삭제할까요?")&&(localStorage.removeItem(HIST_KEY),renderHistory(),renderTop3(),toast("히스토리 삭제 완료"))}function adviceKeyFromMetrics(t,e){const n="number"==typeof t?t:null,a="number"==typeof e?e:null;return null!=n?n>=2?"rec":n>=0?"caution":"pass":null!=a?a<=3?"rec":a<=6?"caution":"pass":"caution"}function adviceKeyForRecord(t){return adviceKeyFromMetrics(t?.bestEVPct,t?.markets?.main?.marginPct)}function adviceInfoForKey(t){return"rec"===t?{text:"추천",cls:"good"}:"pass"===t?{text:"PASS",cls:"bad"}:{text:"주의",cls:"warn"}}function outcomeInfo(t){return"W"===t?{text:"✅ 적중",cls:"win"}:"L"===t?{text:"❌ 미적중",cls:"lose"}:"V"===t?{text:"⚪ 취소",cls:"void"}:{text:"미기록",cls:"none"}}function setOutcome(t,e){const n=readHistory(),a=n.findIndex(e=>e.id===t);if(a<0)return void toast("히스토리에서 항목을 찾지 못했어요.");const o="W"===e||"L"===e||"V"===e?e:"";n[a].outcome=o||null,n[a].outcomeAt=o?Date.now():null,n[a].advice||(n[a].advice=adviceKeyForRecord(n[a])),writeHistory(n),renderHistory(),refreshTrustLine(),toast(o?"결과 기록 완료":"기록 해제 완료")}function markOutcome(t){LAST_RECORD&&LAST_RECORD.id?setOutcome(LAST_RECORD.id,t):toast("먼저 계산 결과를 만든 뒤 기록할 수 있어요.")}function computePerfStats(){const t=readHistory(),e={total:{w:0,l:0,v:0,n:0,rate:null},by:{rec:{w:0,l:0,v:0,n:0,rate:null},caution:{w:0,l:0,v:0,n:0,rate:null},pass:{w:0,l:0,v:0,n:0,rate:null}}};t.forEach(t=>{const n=t.advice||adviceKeyForRecord(t),a=e.by[n]||e.by.caution,o=e.total,s=t.outcome;"W"===s?(a.w++,o.w++):"L"===s?(a.l++,o.l++):"V"===s&&(a.v++,o.v++)});const n=t=>(t.n=t.w+t.l,t.rate=t.n>0?t.w/t.n:null,t);return n(e.total),Object.keys(e.by).forEach(t=>n(e.by[t])),e}function pct(t){return null==t?"—":Math.round(100*t)+"%"}function renderPerfBox(){const t=document.getElementById("perfBox"),e=document.getElementById("perfGrid"),n=document.getElementById("perfSub"),a=document.getElementById("perfMeta");if(!(t&&e&&n&&a))return;const o=computePerfStats(),s=o.total.n;if(s<=0&&o.total.v<=0)return void(t.style.display="none");t.style.display="block",a.textContent=`표본 ${s} · 취소 ${o.total.v}`,n.innerHTML="내가 <b>결과(적중/미적중)</b>를 체크한 항목만 집계됩니다. 표본이 적으면 수치는 참고용입니다.";const r=(t,e)=>{const n=o.by[e],a=adviceInfoForKey(e);return`\n      <div class="perf-tile">\n        <div class="perf-k">${t} <span class="${a.cls}"><b>${a.text}</b></span></div>\n        <div class="perf-v">${pct(n.rate)}</div>\n        <div class="perf-n">n=${n.n} (적중 ${n.w} / 미적중 ${n.l})</div>\n      </div>\n    `};e.innerHTML=`\n    ${r("추천일 때","rec")}\n    ${r("주의일 때","caution")}\n    ${r("PASS일 때","pass")}\n  `}function buildTrustLineHtml(t){const e=computePerfStats(),n=e.by[t]||e.by.caution,a=adviceInfoForKey(t);return n.n<10?`내 기록 기준: <b>표본 부족</b> (현재 n=${n.n}). 아래 <b>상세 지표</b>까지 확인하세요.`:`내 기록 기준: <span class="${a.cls}"><b>${a.text}</b></span> 구간 적중률 <b>${pct(n.rate)}</b> (n=${n.n}).`}function refreshTrustLine(){const t=document.querySelector(".trustLine"),e=document.querySelector(".heroConclusion");if(!t||!e)return;let n="caution";e.classList.contains("good")?n="rec":e.classList.contains("bad")&&(n="pass"),t.innerHTML=buildTrustLineHtml(n)}function readSnaps(){try{const t=localStorage.getItem(SNAP_KEY);if(!t)return[];const e=JSON.parse(t);return Array.isArray(e)?e:[]}catch(t){return[]}}function writeSnaps(t){localStorage.setItem(SNAP_KEY,JSON.stringify(t.slice(0,5)))}function stateSig(t){const e={};return["sport","level","league","teams","main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA","totalLine","overOdds","underOdds","handicapLine","handicapOddsA","handicapOddsB","myProb","myOverProb"].forEach(n=>e[n]=t?.[n]??""),JSON.stringify(e)}function maybePushSnapshot(t,e){if(t)try{const n=Date.now(),a=stateSig(t),o=localStorage.getItem(SNAP_META_KEY),s=o?JSON.parse(o):{};if(!e){if(n-(s?.lastAt||0)<2e4)return;if(a===(s?.lastSig||""))return}const r=readSnaps(),l=n.toString(36)+Math.random().toString(36).slice(2,6);r.unshift({id:l,at:n,sport:t.sport,level:t.level,league:t.league,teams:t.teams,state:t}),writeSnaps(r),localStorage.setItem(SNAP_META_KEY,JSON.stringify({lastAt:n,lastSig:a}))}catch(t){}}function renderSnaps(){const t=document.getElementById("snapWrap"),e=document.getElementById("snapList"),n=document.getElementById("snapMeta");if(!t||!e||!n)return;const a=readSnaps();if(view.length){t.style.display="block",n.textContent=`총 ${a.length}개`,e.innerHTML=a.map(t=>{const e=new Date(t.at),n=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0"),o=SPORT_CFG[t.sport]||{name:t.sport||"-"},s=levelLabel(t.level),r=`${n}:${a} · ${o.name} · ${s}`,l=t.teams||t.league?escapeHtml(t.teams||t.league):"";return`<button class="snap-chip" type="button" onclick="restoreSnapshot('${t.id}')">${r}${l?` <span class="snap-meta">· ${l}</span>`:""}</button>`}).join("");try{0===__PASTE_SAVED_SIGS.size&&buildSavedSigSet()}catch(t){}try{__PASTE_MULTI.forEach((t,e)=>{if(t&&pasteAlreadySaved(t)){const t=$("pasteItem_"+e);t&&t.classList.add("is-saved");const n=$("pasteStat_"+e);n&&(n.innerHTML="저장됨",n.style.display="block")}})}catch(t){}}else t.style.display="none"}function restoreSnapshot(t){const e=readSnaps().find(e=>e.id===t);if(!e||!e.state)return void toast("스냅샷을 찾지 못했어요.");const n=e.state;setVal("sport",n.sport||"soccer"),setVal("level",n.level||"simple"),setVal("league",n.league||""),setVal("teams",n.teams||""),setVal("main2OddsA",n.main2OddsA||""),setVal("main2OddsB",n.main2OddsB||""),setVal("main3OddsH",n.main3OddsH||""),setVal("main3OddsD",n.main3OddsD||""),setVal("main3OddsA",n.main3OddsA||""),setVal("totalLine",n.totalLine||""),setVal("overOdds",n.overOdds||""),setVal("underOdds",n.underOdds||""),setVal("ouPush",n.ouPush||""),setVal("handicapLine",n.handicapLine||""),setVal("handicapOddsA",n.handicapOddsA||""),setVal("handicapOddsB",n.handicapOddsB||""),setVal("handicapPush",n.handicapPush||""),setVal("myProb",n.myProb||""),setVal("myOverProb",n.myOverProb||""),setVal("stake",n.stake||""),"boolean"==typeof n.handicapCollapsed&&setCollapsed("handicapBody",!!n.handicapCollapsed),"boolean"==typeof n.totalCollapsed&&setCollapsed("totalBody",!!n.totalCollapsed),onSportChange(!0),onLevelChange(!0),hideResult(),renderMarginDash(),saveState(),toast("최근 입력을 복원했어요.");try{quickJump("main")}catch(t){}}let _vTimer=null;function setupValidation(){const t=["main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA","overOdds","underOdds","handicapOddsA","handicapOddsB"],e=["totalLine","handicapLine"],n=["ouPush","handicapPush"],a=["stake"],o=["myOverProb"],s="myProb",r=t.concat(e).concat(n).concat(a).concat([s]).concat(o),l=()=>{_vTimer&&clearTimeout(_vTimer),_vTimer=setTimeout(()=>{validateInputs()},80)};function c(t){const e=t.split(".");return e.length<=2?t:e[0]+"."+e.slice(1).join("")}r.forEach(r=>{const i=document.getElementById(r);i&&(i.addEventListener("input",i=>{let d=String(i.target.value||"");t.includes(r)||n.includes(r)?(d=d.replace(/,/g,".").replace(/[^\d.]/g,""),d=c(d)):e.includes(r)?(d=d.replace(/,/g,".").replace(/[^\d.\-]/g,""),d=function(t){return(t=t.replace(/(?!^)-/g,"")).startsWith("--")&&(t="-"+t.slice(2).replace(/-/g,"")),t}(d),d=c(d)):a.includes(r)?d=d.replace(/[^\d]/g,""):r===s?(d=d.replace(/[^\d.,\/\s%]/g,""),d=d.replace(/%/g,""),d=d.replace(/，/g,","),d=d.replace(/\s+/g," ")):o.includes(r)&&(d=d.replace(/,/g,".").replace(/[^\d.]/g,""),d=c(d)),i.target.value=d,l()}),i.addEventListener("blur",()=>{l()}))}),validateInputs()}function setInvalid(t,e){const n=document.getElementById(t);n&&(e?n.classList.add("invalid"):n.classList.remove("invalid"))}function showInputWarn(t){const e=document.getElementById("inputWarn");if(e){if(!t)return e.style.display="none",void(e.innerHTML="");e.style.display="block",e.innerHTML=t}}function validateInputs(){["main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA","overOdds","underOdds","handicapOddsA","handicapOddsB","totalLine","handicapLine","myProb","myOverProb"].forEach(t=>setInvalid(t,!1));const t=val("sport"),e=(SPORT_CFG[t]||SPORT_CFG.soccer).main;let n=!0,a="";const o=t=>{const e=parseOdds(val(t));return null!=e&&e>=1.01&&e<=200};if("2way"===e){const t=o("main2OddsA"),e=o("main2OddsB");t||(setInvalid("main2OddsA",!0),n=!1),e||(setInvalid("main2OddsB",!0),n=!1),n||(a="메인 배당(2개)을 먼저 입력하세요. 예: <b>1.85</b> / <b>2.05</b>")}else{const t=o("main3OddsH"),e=o("main3OddsD"),s=o("main3OddsA");t||(setInvalid("main3OddsH",!0),n=!1),e||(setInvalid("main3OddsD",!0),n=!1),s||(setInvalid("main3OddsA",!0),n=!1),n||(a="메인 배당(3개)을 먼저 입력하세요. 예: <b>2.10</b> / <b>3.20</b> / <b>3.40</b>")}const s=!!(val("totalLine")||val("overOdds")||val("underOdds")),r=!s||!!val("totalLine")&&o("overOdds")&&o("underOdds");s&&!r&&(val("totalLine")||setInvalid("totalLine",!0),o("overOdds")||setInvalid("overOdds",!0),o("underOdds")||setInvalid("underOdds",!0));const l=!!(val("handicapLine")||val("handicapOddsA")||val("handicapOddsB")),c=!l||!!val("handicapLine")&&o("handicapOddsA")&&o("handicapOddsB");l&&!c&&(val("handicapLine")||setInvalid("handicapLine",!0),o("handicapOddsA")||setInvalid("handicapOddsA",!0),o("handicapOddsB")||setInvalid("handicapOddsB",!0));let i="";"simple"!==val("level")&&((()=>{const t=String(val("myProb")||"").trim();return!t||("2way"!==e?!!parsePctList(t):null!=parsePct(t))})()||(setInvalid("myProb",!0),i="2way"!==e?"내 예상 확률은 <b>쉼표/공백/슬래시</b>로 3개 입력하세요. 예: <b>45,28,27</b>":"내 예상 확률은 <b>0~100</b> 사이 숫자로 입력하세요."),(()=>{const t=String(val("myOverProb")||"").trim();return!t||null!=parsePct(t)})()||(setInvalid("myOverProb",!0),i||(i="오버 예상 확률은 <b>0~100</b> 사이 숫자로 입력하세요.")));const d=document.getElementById("btnCalc");d&&(d.disabled=!n);const u=[];return n||u.push(a),s&&!r&&u.push("오버·언더는 <b>기준점 + 오버/언더 배당</b>을 모두 채우면 분석됩니다."),l&&!c&&u.push("핸디캡은 <b>라인 + 양쪽 배당</b>을 모두 채우면 분석됩니다."),i&&u.push(i),showInputWarn(u.length?"⚠️ 입력 확인<br>"+u.map(t=>"• "+t).join("<br>"):""),n}let pickSet=new Set,historyFilter="all";function setHistoryFilter(t,e){historyFilter=t,pickSet.clear();const n=document.querySelector(".history-filters");n&&n.querySelectorAll(".seg").forEach(t=>t.classList.remove("on")),e&&e.classList.add("on"),renderHistory()}function updatePickUI(){const t=pickSet.size,e=document.getElementById("pickCount");e&&(e.textContent=String(t));const n=document.getElementById("btnDeleteSelected");n&&(n.disabled=0===t);const a=document.getElementById("btnCompare");a&&(a.disabled=2!==t)}function deleteSelected(){const t=Array.from(pickSet);if(0===t.length)return void toast("삭제할 항목을 선택하세요");if(!confirm(`선택한 ${t.length}개 항목을 삭제할까요?`))return;let e=readHistory();e=e.filter(t=>!pickSet.has(t.id)),writeHistory(e),pickSet.clear(),renderHistory(),renderTop3(),toast("선택 삭제 완료")}function renderHistory(){const t=document.getElementById("historyList");if(!t)return;const e=readHistory(),n=new Set(e.map(t=>t.id));pickSet=new Set(Array.from(pickSet).filter(t=>n.has(t)));let a=e;"rec"===historyFilter?a=e.filter(t=>"rec"===(t.advice||adviceKeyForRecord(t))):"untracked"===historyFilter&&(a=e.filter(t=>!t.outcome));const o=(e,n,a)=>{const o=document.getElementById("tplHistoryEmpty");if(t.innerHTML="",o&&o.content){const s=o.content.cloneNode(!0),r=s.querySelector('[data-slot="title"]'),l=s.querySelector('[data-slot="desc"]');if(r&&(r.textContent=e),l&&(l.innerHTML=n),"filtered"===a){const t=s.querySelector(".demo-btns");t&&(t.style.display="none");const e=s.querySelector(".demo-note");e&&(e.innerHTML="필터를 바꾸거나 <b>전체</b>로 되돌려 보세요.")}t.appendChild(s)}else t.innerHTML=`\n        <div class="demo-empty">\n          <div class="demo-title">${escapeHtml(e)}</div>\n          <div class="demo-desc">${n}</div>\n        </div>`};if(!e.length)return o("히스토리가 비어있어요.","아래 <b>예시 버튼</b>을 눌러 입력을 자동 채우고, 바로 계산까지 실행해볼 수 있어요.","empty"),renderPerfBox(),updatePickUI(),void initHistoryListEvents();if(!a.length)return o("조건에 맞는 기록이 없어요.","필터 조건에 맞는 기록이 없습니다. <b>전체</b>로 바꾸거나 새로 계산해보세요.","filtered"),renderPerfBox(),updatePickUI(),void initHistoryListEvents();t.innerHTML="";const s=document.getElementById("tplHistoryItem"),r=document.createDocumentFragment();a.forEach(t=>{const e=SPORT_CFG[t.sport]||{name:t.sport||"-"},n=t.markets?.main?.marginPct,a=t.markets?.ou?.marginPct,o=t.markets?.hc?.marginPct,l="number"==typeof n?classifyMargin(t.sport,"main",n):null,c="number"==typeof a?classifyMargin(t.sport,"ou",a):null,i="number"==typeof o?classifyMargin(t.sport,"hc",o):null,d="number"==typeof t.bestEVPct?`${t.bestEVPct.toFixed(2)}%`:"-",u=t.evPositive?"good":"warn",p=adviceInfoForKey(t.advice||adviceKeyForRecord(t)),m=outcomeInfo(t.outcome);let f;if(s&&s.content){const n=s.content.cloneNode(!0);if(f=n.querySelector('[data-role="history-item"]'),f){f.dataset.id=t.id;const n=f.querySelector('[data-slot="title"]'),a=f.querySelector('[data-slot="sub"]'),o=f.querySelector('[data-slot="outTag"]'),s=f.querySelector('input[data-h-action="pick"]');n&&(n.textContent=`${t.time} · ${e.name} · ${levelLabel(t.level)}${t.teams?` · ${cleanTeam(t.teams)}`:""}`),a&&(a.innerHTML=`\n          메인: ${l?`<span class="${clsToTextColor(l.cls)}">${l.label}</span>`:"-"} /\n          OU: ${c?`<span class="${clsToTextColor(c.cls)}">${c.label}</span>`:"-"} /\n          핸디: ${i?`<span class="${clsToTextColor(i.cls)}">${i.label}</span>`:"-"}\n          <br>\n          최고 EV: <span class="${u}"><b>${d}</b></span> ·\n          판단: <span class="${p.cls}"><b>${p.text}</b></span>\n        `),o&&(o.className=`outTag ${m.cls}`,o.textContent=m.text),f.querySelectorAll('button[data-h-action="outcome"]').forEach(e=>{const n=e.getAttribute("data-outcome")||"",a=n&&t.outcome===n||!n&&!t.outcome;e.classList.toggle("on",!!a)}),s&&(s.checked=pickSet.has(t.id))}r.appendChild(n)}}),t.appendChild(r),renderPerfBox(),updatePickUI(),initHistoryListEvents()}function initHistoryListEvents(){const t=document.getElementById("historyList");t&&!t.__bound&&(t.__bound=!0,t.addEventListener("click",t=>{const e=t.target.closest("[data-demo]");if(e){const t=e.getAttribute("data-demo");return void("soccer"===t?loadDemo("soccer"):"basketball"===t&&loadDemo("basketball"))}const n=t.target.closest("[data-h-action]");if(n){const t=n.closest('[data-role="history-item"]'),e=t?.dataset?.id,a=n.getAttribute("data-h-action");if("outcome"===a){if(!e)return;return void setOutcome(e,n.getAttribute("data-outcome")||"")}if("restoreCalc"===a){if(!e)return;return void restoreFromHistory(e,!0)}if("restoreOnly"===a){if(!e)return;return void restoreFromHistory(e,!1)}return}const a=t.target.closest('[data-role="history-item"]');a&&a.dataset.id&&onHistoryClick(null,a.dataset.id)}),t.addEventListener("change",t=>{const e=t.target.closest('input[data-h-action="pick"]');if(!e)return;const n=e.closest('[data-role="history-item"]'),a=n?.dataset?.id;a&&togglePick(a,e.checked)}),t.addEventListener("keydown",t=>{if("Enter"!==t.key&&" "!==t.key)return;const e=t.target.closest('[data-role="history-item"]');e&&e.dataset.id&&(!t.target||"BUTTON"!==t.target.tagName&&"INPUT"!==t.target.tagName)&&(t.preventDefault(),onHistoryClick(null,e.dataset.id))}))}function onHistoryClick(t,e){try{track("history_open",{page_path:location.pathname})}catch(t){}restoreFromHistory(e,!0)}function togglePick(t,e){e?pickSet.add(t):pickSet.delete(t),updatePickUI()}function restoreFromHistory(t,e){const n=readHistory().find(e=>e.id===t);n&&(setVal("sport",n.sport),setVal("level",n.level),onSportChange(!0),onLevelChange(!0),setVal("league",n.league||""),setVal("teams",n.teams||""),null!=n.inputs.main2OddsA&&setVal("main2OddsA",n.inputs.main2OddsA),null!=n.inputs.main2OddsB&&setVal("main2OddsB",n.inputs.main2OddsB),null!=n.inputs.main3OddsH&&setVal("main3OddsH",n.inputs.main3OddsH),null!=n.inputs.main3OddsD&&setVal("main3OddsD",n.inputs.main3OddsD),null!=n.inputs.main3OddsA&&setVal("main3OddsA",n.inputs.main3OddsA),null!=n.inputs.myProb&&setVal("myProb",n.inputs.myProb),null!=n.inputs.stake&&setVal("stake",n.inputs.stake),null!=n.inputs.handicapLine&&setVal("handicapLine",n.inputs.handicapLine),null!=n.inputs.handicapOddsA&&setVal("handicapOddsA",n.inputs.handicapOddsA),null!=n.inputs.handicapOddsB&&setVal("handicapOddsB",n.inputs.handicapOddsB),null!=n.inputs.handicapPush&&setVal("handicapPush",n.inputs.handicapPush),null!=n.inputs.totalLine&&setVal("totalLine",n.inputs.totalLine),null!=n.inputs.overOdds&&setVal("overOdds",n.inputs.overOdds),null!=n.inputs.underOdds&&setVal("underOdds",n.inputs.underOdds),null!=n.inputs.ouPush&&setVal("ouPush",n.inputs.ouPush),null!=n.inputs.myOverProb&&setVal("myOverProb",n.inputs.myOverProb),saveState(),renderMarginDash(),scrollToCalc(),e?(calc(),toast("복원 후 재계산 완료")):toast("입력 복원 완료"))}function openCompare(){const t=Array.from(pickSet);if(2!==t.length)return void toast("비교할 항목 2개를 체크해 주세요");const e=readHistory(),n=e.find(e=>e.id===t[0]),a=e.find(e=>e.id===t[1]);if(!n||!a)return void toast("선택한 항목을 찾지 못했습니다");const o=document.getElementById("compareGrid");o&&(o.innerHTML=`\n    ${renderCompareCol(n,"A")}\n    ${renderCompareCol(a,"B")}\n  `,document.getElementById("compareModal").style.display="flex")}function closeCompare(){document.getElementById("compareModal").style.display="none"}function renderCompareCol(t,e){const n=SPORT_CFG[t.sport]||SPORT_CFG.soccer,a=t.markets?.main?.marginPct,o=t.markets?.ou?.marginPct,s=t.markets?.hc?.marginPct,r="number"==typeof a?classifyMargin(t.sport,"main",a):null,l="number"==typeof o?classifyMargin(t.sport,"ou",o):null,c="number"==typeof s?classifyMargin(t.sport,"hc",s):null,i="number"==typeof t.bestEVPct?`${t.bestEVPct.toFixed(2)}%`:"-";return`\n    <div class="compare-col">\n      <div class="ct">${e} · ${t.time} · ${n.name} · ${levelLabel(t.level)}</div>\n      <div class="line"><div class="k">리그</div><div class="v">${t.league?escapeHtml(t.league):"-"}</div></div>\n      <div class="line"><div class="k">경기</div><div class="v">${t.teams?escapeHtml(t.teams):"-"}</div></div>\n      <div class="line"><div class="k">메인 마진</div><div class="v">${r?`<span class="${clsToTextColor(r.cls)}">${r.label}</span>`:"-"}</div></div>\n      <div class="line"><div class="k">OU 마진</div><div class="v">${l?`<span class="${clsToTextColor(l.cls)}">${l.label}</span>`:"-"}</div></div>\n      <div class="line"><div class="k">핸디 마진</div><div class="v">${c?`<span class="${clsToTextColor(c.cls)}">${c.label}</span>`:"-"}</div></div>\n      <div class="line"><div class="k">최고 EV</div><div class="v">${t.evPositive?`<span class="good">${i}</span>`:`<span class="warn">${i}</span>`}</div></div>\n\n      <div class="mini-actions">\n        <button class="restore" type="button" onclick="restoreFromHistory('${t.id}', true)">이 항목 복원+재계산</button>\n        <button class="close" type="button" onclick="closeCompare()">닫기</button>\n      </div>\n    </div>\n  `}function escapeHtml(t){return String(t).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function renderTop3(){const t=readHistory().filter(t=>t.date===todayStr()),e=t.filter(t=>"number"==typeof t.markets?.main?.marginPct).sort((t,e)=>t.markets.main.marginPct-e.markets.main.marginPct).slice(0,3),n=t.filter(t=>"number"==typeof t.markets?.ou?.marginPct).sort((t,e)=>t.markets.ou.marginPct-e.markets.ou.marginPct).slice(0,3),a=t.filter(t=>"number"==typeof t.markets?.hc?.marginPct).sort((t,e)=>t.markets.hc.marginPct-e.markets.hc.marginPct).slice(0,3);renderTopList("topMain",e,"main"),renderTopList("topOU",n,"ou"),renderTopList("topHC",a,"hc")}function renderTopList(t,e,n){const a=document.getElementById(t);a&&(e.length?a.innerHTML=e.map((t,e)=>{const a=SPORT_CFG[t.sport]||SPORT_CFG.soccer,o=t.markets[n].marginPct,s=classifyMargin(t.sport,n,o),r=`${e+1}) ${t.time} · ${a.name}${t.teams?` · ${escapeHtml(t.teams)}`:""} · ${s.label}`;return`<div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06);">\n      <a href="#calcCard" onclick="restoreFromHistory('${t.id}', true)" style="color:inherit;text-decoration:none;">\n        <span class="${clsToTextColor(s.cls)}"><b>${r}</b></span>\n      </a>\n    </div>`}).join("").replace(/border-bottom:1px solid rgba\(255,255,255,.06\);\"><\/div>$/,'">'):a.innerHTML="오늘 저장된 데이터가 없습니다.")}let _AD_PREPARED=!1;function prepareAdPopup(){if(_AD_PREPARED)return;let t={};try{t=JSON.parse(localStorage.getItem("88_card_clicks")||"{}")||{}}catch(e){t={}}const e=[{key:"card1",title:"베가스",sub:"가입코드 6789 · 안전 체크",href:"https://las403.com",badge:"인증"},{key:"card3",title:"777",sub:"가입코드 6767 · 안전 체크",href:"https://82clf.com/?code=6767",badge:"인증"}].sort((e,n)=>Number(t[n.key]||0)-Number(t[e.key]||0)).slice(0,2),n=document.getElementById("adGrid");n&&(n.innerHTML=e.map(t=>`\n    <div class="ad-item" onclick="goAd('${t.href}')">\n      <div class="name">${t.title}</div>\n      <div class="sub">${t.sub}</div>\n      <div class="badge">${t.badge}</div>\n    </div>\n  `).join(""),_AD_PREPARED=!0)}function maybeShowAdPopupAfterComplete(){const t=(new Date).toISOString().slice(0,10);try{if(localStorage.getItem("88_analysis_adpopup_date")===t)return}catch(t){}const e=document.getElementById("adPopup");if(e){prepareAdPopup(),e.style.display="flex";try{track("ad_popup_view",{page_path:location.pathname,trigger:"after_complete"})}catch(t){}}}function goAd(t){try{const t=(new Date).toISOString().slice(0,10);localStorage.setItem("88_analysis_adpopup_date",t)}catch(t){}if("string"!=typeof t)return;const e=t.trim();e.toLowerCase().startsWith("javascript:")||(location.href=e)}function closeAdPopup(t){const e=document.getElementById("adPopup");if(e&&(e.style.display="none"),t)try{const t=(new Date).toISOString().slice(0,10);localStorage.setItem("88_analysis_adpopup_date",t)}catch(t){}}function loadDemo(t){try{"soccer"===t?(setVal("sport","soccer"),onSportChange(!0),setVal("level","simple"),onLevelChange(!0),setVal("league","프리미어리그 (예시)"),setVal("teams","홈팀 vs 원정팀"),setVal("main3OddsH","1.95"),setVal("main3OddsD","3.55"),setVal("main3OddsA","3.95"),setVal("totalLine","2.5"),setVal("overOdds","1.90"),setVal("underOdds","1.95"),setVal("handicapLine","-0.5"),setVal("handicapOddsA","1.88"),setVal("handicapOddsB","1.96")):"basketball"===t&&(setVal("sport","basketball"),onSportChange(!0),setVal("level","simple"),onLevelChange(!0),setVal("league","NBA (예시)"),setVal("teams","홈팀 vs 원정팀"),setVal("main2OddsA","1.78"),setVal("main2OddsB","2.05"),setVal("totalLine","223.5"),setVal("overOdds","1.91"),setVal("underOdds","1.91"),setVal("handicapLine","-3.5"),setVal("handicapOddsA","1.92"),setVal("handicapOddsB","1.90")),calc(),quickJump("result")}catch(t){console.error(t),toast("예시 로딩에 실패했어요")}}const ONB_KEY="onboard88_analysis_v1_done";let onbIdx=0;const onbSteps=[{target:"mainBox",title:"배당부터 입력",body:"메인 배당을 먼저 입력해요. (축구는 홈/무/원정, 다른 종목은 승/패) — 입력하면 아래 결과가 더 정확하게 정리돼요."},{target:"btnCalc",title:"계산하기",body:"배당 입력 후 <b>계산하기</b>를 눌러 결과를 확인해요. 결과는 자동으로 히스토리에 저장됩니다."},{target:"historyCard",title:"히스토리로 재계산/비교",body:"저장된 히스토리를 클릭하면 <b>입력 복원 + 즉시 재계산</b>돼요. 체크 2개 선택 → 비교(2개 나란히)도 가능해요."}];function onbHighlightClear(){document.querySelectorAll(".onb-highlight").forEach(t=>t.classList.remove("onb-highlight"))}function onbPositionPopover(t){const e=document.getElementById("onbPopover");if(!e||!t)return;const n=t.getBoundingClientRect(),a=Math.max(document.documentElement.clientWidth,window.innerWidth||0),o=Math.max(document.documentElement.clientHeight,window.innerHeight||0),s=Math.min(340,a-36);e.style.width=s+"px";let r=n.bottom+12,l=Math.min(a-s-12,Math.max(12,n.left));const c=e.offsetHeight||180;r+c>o-12&&(r=Math.max(12,n.top-c-12)),e.style.top=r+"px",e.style.left=l+"px"}function onbRender(){const t=document.getElementById("onbPopover"),e=document.getElementById("onbTitle"),n=document.getElementById("onbStep"),a=document.getElementById("onbBody");if(!(t&&e&&n&&a))return;const o=onbSteps[onbIdx],s=document.getElementById(o.target);s?(onbHighlightClear(),s.classList.add("onb-highlight"),e.innerText=o.title,n.innerText=`${onbIdx+1}/${onbSteps.length}`,a.innerHTML=o.body,t.style.display="block",requestAnimationFrame(()=>onbPositionPopover(s))):onbNext()}function onbStart(){try{"1"===new URLSearchParams(location.search).get("onboard")&&localStorage.removeItem(ONB_KEY)}catch(t){}"1"!==localStorage.getItem(ONB_KEY)&&(onbIdx=0,onbRender(),window.addEventListener("scroll",onbOnScroll,{passive:!0}),window.addEventListener("resize",onbOnScroll,{passive:!0}),document.addEventListener("keydown",onbOnKey))}function onbFinish(){localStorage.setItem(ONB_KEY,"1"),onbClose()}function onbClose(){const t=document.getElementById("onbPopover");t&&(t.style.display="none"),onbHighlightClear(),window.removeEventListener("scroll",onbOnScroll),window.removeEventListener("resize",onbOnScroll),document.removeEventListener("keydown",onbOnKey)}function onbOnScroll(){const t=onbSteps[onbIdx],e=document.getElementById(t.target);e&&onbPositionPopover(e)}function onbOnKey(t){"Escape"===t.key&&onbSkip(),"ArrowRight"!==t.key&&"Enter"!==t.key||onbNext(),"ArrowLeft"===t.key&&onbPrev()}function onbNext(){if(onbIdx>=onbSteps.length-1)return void onbFinish();onbIdx++;const t=document.getElementById(onbSteps[onbIdx].target);if(t){try{t.scrollIntoView({behavior:"smooth",block:"center"})}catch(e){t.scrollIntoView()}setTimeout(onbRender,200)}else onbRender()}function onbPrev(){if(onbIdx<=0)return onbIdx=0,void onbRender();onbIdx--;const t=document.getElementById(onbSteps[onbIdx].target);if(t){try{t.scrollIntoView({behavior:"smooth",block:"center"})}catch(e){t.scrollIntoView()}setTimeout(onbRender,200)}else onbRender()}function onbSkip(){onbFinish()}function boot(){try{saveUtmFromUrl()}catch(t){}const t=restoreFromPermalink();t||loadState(),t||localStorage.getItem(LS_KEY)||(setVal("sport","soccer"),setVal("level","simple")),onSportChange(!0),onLevelChange(!0),initAppTabbar(),renderHistory(),renderTop3(),renderMarginDash(),restoreMiniGuide(),setTimeout(()=>{try{onbStart()}catch(t){}},450),setupShareCardBackdropClose(),setupBundleBackdropClose();try{setupBundlePromo()}catch(t){}try{updateBundleButton()}catch(t){}setupValidation(),setupPasteBox(),renderSnaps(),renderPerfBox(),document.querySelectorAll("input,select").forEach(t=>{t.addEventListener("input",()=>t.classList.remove("is-invalid")),t.addEventListener("change",()=>t.classList.remove("is-invalid"))});try{const t=localStorage.getItem(LS_KEY);if(t){const e=JSON.parse(t);updateSaveBadge(e&&e.__savedAt)}else updateSaveBadge(null)}catch(t){updateSaveBadge(null)}}boot(),function(){var t;t=function(){try{const t=document.getElementById("pasteBox"),e=document.getElementById("appTabbar");t&&e&&e.parentNode&&e.parentNode.insertBefore(t,e)}catch(t){}try{const t=document.getElementById("pasteInput");t&&!t.dataset.autoRunBound&&(t.dataset.autoRunBound="1",t.addEventListener("paste",function(){setTimeout(function(){const t="function"==typeof val?val("level"):(document.getElementById("level")||{}).value,e=document.getElementById("pasteAutoRun");if("simple"===t&&e&&e.checked)try{applyPaste(!0)}catch(t){}},60)}))}catch(t){}try{const t=document.getElementById("calcCard");if(t&&!t.querySelector(".app-layout")){const e=t.querySelector(".calc-divider"),n=t.querySelector(".controls-settings");if(e&&n){const a=document.createElement("div");a.className="app-layout is-two",a.id="appLayout";const o=document.createElement("div");o.className="app-left",o.id="appLeft";const s=document.createElement("div");s.className="app-right",s.id="appRight",a.appendChild(o),a.appendChild(s),e.insertAdjacentElement("afterend",a);let r=n;const l=t.querySelector(".footer-links"),c=document.getElementById("result"),i=document.getElementById("resultDock");for(;r;){const t=r.nextSibling;if(r===a)break;if(r===c||r===i||o.appendChild(r),r===l)break;r=t}c&&s.appendChild(c),i&&s.appendChild(i)}}}catch(t){}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()}();