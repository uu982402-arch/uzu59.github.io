!function(){"use strict";const t="88st_casino_calc_settings_v1",e="88st_casino_sessions_v1",n=["martingale","paroli","dalembert","oscar","fibonacci","labouchere"],$=t=>document.getElementById(t);function clamp(t,e,n){return Math.max(e,Math.min(n,t))}function lsRead(t,e){try{const n=localStorage.getItem(t);return n?function safeJsonParse(t,e){try{return JSON.parse(t)}catch(t){return e}}(n,e):e}catch(t){return e}}function lsWrite(t,e){try{localStorage.setItem(t,JSON.stringify(e))}catch(t){}}function numFromInput(t){const e=String(t.value||"").trim();if(!e)return 0;const n=e.replace(/,/g,"").replace(/%/g,"").replace(/원/g,"").replace(/[^0-9.\-]/g,"");if(!n)return 0;const s=Number(n);return Number.isFinite(s)?s:0}function fmtMoney(t){return(t<0?"-":"")+Math.abs(Math.round(t)).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function getOdds(t){const e=Number(t.odds);return Number.isFinite(e)&&e>1?e:2}function parseSeq(t){const e=String(t||"").split(/[ ,]+/).map(t=>Number(String(t).trim())).filter(t=>Number.isFinite(t)&&t>0).map(t=>Math.floor(t));return e.length?e:[1,2,3,4]}function now(){return Date.now()}function saveSettings(e){lsWrite(t,e)}function initSession(t){return{id:"s_"+Math.random().toString(36).slice(2,10)+"_"+Date.now(),tsStart:now(),settings:Object.assign({},t),actions:[]}}function profitFor(t,e,n){return"W"===n?t*(e-1):-t}function computeTargetProfit(t){const e=getOdds(t);return"manual"===t.targetMode?Math.max(0,Number(t.targetProfit||0)):Math.max(0,t.baseBet*(e-1))}function replay(t){const e=t.settings,n=getOdds(e),s=Math.max(1,e.increment||1),a=Math.max(1,e.baseBet||1),r=computeTargetProfit(e),i={odds:n,inc:s,base:a,targetProfit:r,step:0,bet:a,pl:0,peakPL:0,mdd:0,maxBet:a,mart_cumLoss:0,par_streak:0,dal_bet:a,osc_cyclePL:0,fib_i:0,lab_seq:parseSeq(e.labSeq),lab_init:parseSeq(e.labSeq)};function setBet(t){i.bet=Math.max(a,function roundUp(t,e){const n=Math.max(1,Math.floor(e||1));return Math.ceil(t/n)*n}(t,s)),i.maxBet=Math.max(i.maxBet,i.bet)}function recalcLabBet(){const t=i.lab_seq,s=a,r=t.length<=1?t[0]||1:t[0]+t[t.length-1];if(e.labOddsAdjust){setBet(r*s/Math.max(1e-4,n-1))}else setBet(r*s);i.lab_units=r}function recalcFibBet(){const t=a,s=function fib(t){if((t=Math.max(0,Math.floor(t||0)))<=1)return 1;let e=1,n=1;for(let s=2;s<=t;s++){const t=e+n;if(e=n,n=t,n>1e9)break}return n}(i.fib_i);if(e.fibOddsAdjust){setBet(s*t/Math.max(1e-4,n-1))}else setBet(s*t);i.fib_units=s}switch(e.strategy){case"martingale":case"paroli":setBet(a);break;case"dalembert":i.dal_bet=a,setBet(a);break;case"oscar":i.osc_cyclePL=0,setBet(a);break;case"fibonacci":i.fib_i=0,recalcFibBet();break;case"labouchere":recalcLabBet()}for(const s of t.actions){i.step+=1;const t=i.bet,o=profitFor(t,n,s.outcome);switch(i.pl+=o,i.peakPL=Math.max(i.peakPL,i.pl),i.mdd=Math.max(i.mdd,i.peakPL-i.pl),i.maxBet=Math.max(i.maxBet,t),e.strategy){case"martingale":if("L"===s.outcome){i.mart_cumLoss+=t;setBet((i.mart_cumLoss+r)/Math.max(1e-4,n-1))}else i.mart_cumLoss=0,setBet(a);break;case"paroli":if("W"===s.outcome){i.par_streak+=1;const n=Math.floor(e.paroliCap||0);if(n>0&&i.par_streak>=n)i.par_streak=0,setBet(a);else{setBet(t*clamp(Number(e.paroliMult||2),1.1,10))}}else i.par_streak=0,setBet(a);break;case"dalembert":"L"===s.outcome?i.dal_bet=t+a:i.dal_bet=Math.max(a,t-a),setBet(i.dal_bet);break;case"oscar":if("L"===s.outcome)i.osc_cyclePL+=o,setBet(t);else{i.osc_cyclePL+=o;const e=a*(n-1);i.osc_cyclePL>=e-1e-9?(i.osc_cyclePL=0,setBet(a)):setBet(t+a)}break;case"fibonacci":"L"===s.outcome?i.fib_i+=1:i.fib_i=Math.max(0,i.fib_i-2),i.fib_i=clamp(i.fib_i,0,30),recalcFibBet();break;case"labouchere":{const t=i.lab_seq,e=t.length<=1?t[0]||1:t[0]+t[t.length-1];"W"===s.outcome?(1===t.length||t.shift(),t.pop(),0===t.length&&(i.lab_seq=i.lab_init.slice())):t.push(e),recalcLabBet();break}}}let o=null;("martingale"===e.strategy||"labouchere"===e.strategy&&e.labOddsAdjust)&&(o=i.bet);let l=null;return Number(e.bankroll)>0&&(l=Number(e.bankroll)+i.pl),{tracker:i,recoverBet:o,bankrollLeft:l,targetProfit:r}}function buildStrategyOptions(t){const e=$("csStrategyOptions");if(!e)return;const n=getOdds(t),s=computeTargetProfit(t);function chip(t,e,n){return`<button class="cs-chip ${n?"on":""}" type="button" id="${t}">${e}</button>`}let a="";"paroli"===t.strategy?a=`\n        <div class="cs-row">\n          <div class="cs-field" style="min-width:180px;">\n            <label>배수 (WIN 시)</label>\n            <input id="csParoliMult" inputmode="decimal" value="${t.paroliMult}"/>\n          </div>\n          <div class="cs-field" style="min-width:180px;">\n            <label>연승 캡 (0=없음)</label>\n            <input id="csParoliCap" inputmode="numeric" value="${t.paroliCap}"/>\n          </div>\n        </div>\n        <div class="small" style="margin-top:8px;">WIN이면 배수로 올리고, LOSE면 기본 베팅으로 리셋합니다.</div>\n      `:"fibonacci"===t.strategy?a=`\n        <div class="cs-row" style="align-items:center;">\n          <div class="cs-field" style="min-width:220px;">\n            <label>배당 보정</label>\n            <div class="cs-preset">\n              ${chip("csFibAdj",t.fibOddsAdjust?"ON":"OFF",t.fibOddsAdjust)}\n              <span class="small">ON이면 수열 유닛 이익을 (배당-1)로 보정합니다.</span>\n            </div>\n          </div>\n        </div>\n      `:"labouchere"===t.strategy?a=`\n        <div class="cs-row">\n          <div class="cs-field" style="min-width:220px; flex:1.2;">\n            <label>리스트(유닛)</label>\n            <input id="csLabSeq" inputmode="text" value="${String(t.labSeq||"1,2,3,4").replace(/"/g,"&quot;")}"/>\n          </div>\n        </div>\n        <div class="cs-row" style="align-items:center; margin-top:10px;">\n          <div class="cs-field" style="min-width:220px;">\n            <label>배당 보정</label>\n            <div class="cs-preset">\n              ${chip("csLabAdj",t.labOddsAdjust?"ON":"OFF",t.labOddsAdjust)}\n              <span class="small">ON이면 리스트 목표 유닛 이익을 (배당-1)로 보정합니다.</span>\n            </div>\n          </div>\n        </div>\n      `:"martingale"===t.strategy?a=`\n        <div class="small">마틴게일은 누적손실 + 목표이익을 1승으로 회복하도록 다음 베팅을 계산합니다. (배당 반영)</div>\n        <div class="small" style="margin-top:6px;">현재 배당 <b>${n.toFixed(2)}</b>, 목표이익 <b>${fmtMoney(s)}</b></div>\n      `:"oscar"===t.strategy?a=`\n        <div class="small">오스카 그라인드는 “1유닛 목표”를 달성할 때까지 WIN이면 +1유닛, LOSE면 유지(기본형)합니다.</div>\n        <div class="small" style="margin-top:6px;">현재 목표(기본 1승 수익) <b>${fmtMoney(s)}</b></div>\n      `:"dalembert"===t.strategy&&(a='\n        <div class="small">달랑베르는 LOSE면 +1유닛, WIN이면 -1유닛(기본 이하로는 내려가지 않음)으로 완만하게 조정합니다.</div>\n      '),e.innerHTML=a,$("csParoliMult")&&$("csParoliMult").addEventListener("input",()=>{t.paroliMult=clamp(Number(numFromInput($("csParoliMult"))||2),1.1,10),saveSettings(t),render(),$("csPlanBody")&&renderPlan()}),$("csParoliCap")&&$("csParoliCap").addEventListener("input",()=>{t.paroliCap=clamp(Math.floor(numFromInput($("csParoliCap"))||0),0,12),saveSettings(t),render()}),$("csFibAdj")&&$("csFibAdj").addEventListener("click",()=>{t.fibOddsAdjust=!t.fibOddsAdjust,saveSettings(t),buildStrategyOptions(t),render()}),$("csLabAdj")&&$("csLabAdj").addEventListener("click",()=>{t.labOddsAdjust=!t.labOddsAdjust,saveSettings(t),buildStrategyOptions(t),render()}),$("csLabSeq")&&$("csLabSeq").addEventListener("input",()=>{t.labSeq=$("csLabSeq").value,saveSettings(t),render()})}let s=null,a=null;function syncInputs(){$("csOdds").value=Number(getOdds(s)).toFixed(2),$("csBaseBet").value=String(s.baseBet),$("csBankroll").value=s.bankroll?String(s.bankroll):"",$("csIncrement").value=String(s.increment),$("csTargetMode").value=s.targetMode,$("csTargetProfit").disabled="manual"!==s.targetMode,$("csTargetProfit").value="manual"===s.targetMode?String(s.targetProfit||0):"";const t="PLAYER"===s.preset;$("csPresetPlayer").classList.toggle("on",t),$("csPresetBanker").classList.toggle("on",!t);const e=Array.from($("csTabs").querySelectorAll("button[data-strategy]"));for(const t of e)t.classList.toggle("on",t.getAttribute("data-strategy")===s.strategy)}function updateSettingsFromCommonInputs(){s.odds=clamp(Number(numFromInput($("csOdds"))||s.odds),1.01,20),s.baseBet=Math.max(1,Math.floor(numFromInput($("csBaseBet"))||s.baseBet)),s.bankroll=Math.max(0,Math.floor(numFromInput($("csBankroll"))||0)),s.increment=Math.max(1,Math.floor(numFromInput($("csIncrement"))||s.increment)),s.targetMode="manual"===$("csTargetMode").value?"manual":"auto",s.targetProfit=Math.max(0,Math.floor(numFromInput($("csTargetProfit"))||0)),saveSettings(s)}function render(){if(!s||!a)return;a.settings=Object.assign({},s);const t=replay(a),e=t.tracker;$("csNextBet").textContent=fmtMoney(e.bet),$("csStep").textContent=String(e.step),$("csPL").textContent=fmtMoney(e.pl),$("csMDD").textContent=fmtMoney(e.mdd),$("csRecoverBet").textContent=t.recoverBet?fmtMoney(t.recoverBet):"—";const n=document.getElementById("csBankrollLeft");n&&(Number(s.bankroll)>0&&Number.isFinite(t.bankrollLeft)?(n.textContent=fmtMoney(t.bankrollLeft),n.classList.toggle("neg",t.bankrollLeft<0)):(n.textContent="—",n.classList.remove("neg")));const r=$("csLogBody"),i=a.actions;if(i.length){const t=i.slice(-8);r.innerHTML=t.map((e,n)=>{const s=i.length-t.length+n+1,a=e.bet,r=e.profit;return`<tr>\n          <td>${s}</td>\n          <td>${"W"===e.outcome?"WIN":"LOSE"}</td>\n          <td>${fmtMoney(a)}</td>\n          <td>${fmtMoney(r)}</td>\n        </tr>`}).join("")}else r.innerHTML='<tr><td colspan="4" style="color:var(--muted, rgba(255,255,255,.62)); font-weight:900;">아직 기록이 없습니다. WIN/LOSE로 시작하세요.</td></tr>';renderRecentSessions()}function applyOutcome(e){updateSettingsFromCommonInputs();const n=replay(a).tracker,r=n.bet,i=profitFor(r,n.odds,e);a.actions.push({ts:now(),outcome:e,bet:r,profit:i}),lsWrite(t,s),render()}function loadSessions(){const t=lsRead(e,[]);return Array.isArray(t)?t:[]}function saveSessions(t){lsWrite(e,t.slice(0,5))}function saveSession(){if(!a.actions.length)return;const t=loadSessions(),e=function summarizeSession(t){const e=replay(t).tracker;return{id:t.id,tsStart:t.tsStart,tsEnd:now(),strategy:t.settings.strategy,preset:t.settings.preset,odds:getOdds(t.settings),baseBet:t.settings.baseBet,rounds:t.actions.length,pl:Math.round(e.pl),mdd:Math.round(e.mdd),maxBet:Math.round(e.maxBet),settings:t.settings,actions:t.actions}}(a),n=t.filter(t=>t&&t.id!==e.id);n.unshift(e),saveSessions(n)}function renderRecentSessions(){const t=$("csRecentList");if(!t)return;const e=loadSessions();e.length?(t.innerHTML=e.slice(0,5).map(t=>`<div class="item">\n        <div class="top">\n          <div>\n            <div class="t">${{martingale:"마틴게일",paroli:"파롤리",dalembert:"달랑베르",oscar:"오스카",fibonacci:"피보나치",labouchere:"라부셰르"}[t.strategy]||t.strategy}</div>\n            <div class="m">${`${t.preset} ${Number(t.odds).toFixed(2)} · 기본 ${fmtMoney(t.baseBet)} · ${t.rounds}R`}</div>\n          </div>\n          <div class="m" style="text-align:right;">P/L <b style="color:var(--text, #f4f6ff);">${fmtMoney(t.pl)}</b><br/>MDD ${fmtMoney(t.mdd)}</div>\n        </div>\n        <div class="btns">\n          <button class="cs-chip cs-mini-btn" type="button" data-load="${t.id}">불러오기</button>\n          <button class="cs-chip cs-mini-btn" type="button" data-del="${t.id}">삭제</button>\n        </div>\n      </div>`).join(""),t.querySelectorAll("button[data-load]").forEach(t=>{t.addEventListener("click",()=>{const e=t.getAttribute("data-load"),n=loadSessions().find(t=>t&&t.id===e);n&&(s=Object.assign({preset:"PLAYER",odds:2,baseBet:1e4,bankroll:0,increment:1e3,targetMode:"auto",targetProfit:0,strategy:"martingale",paroliMult:2,paroliCap:3,fibOddsAdjust:!1,labOddsAdjust:!0,labSeq:"1,2,3,4"},n.settings||{}),s.odds=getOdds(s),a=initSession(s),a.actions=Array.isArray(n.actions)?n.actions.map(t=>({ts:t.ts,outcome:t.outcome,bet:t.bet,profit:t.profit})):[],syncInputs(),buildStrategyOptions(s),render())})}),t.querySelectorAll("button[data-del]").forEach(t=>{t.addEventListener("click",()=>{const e=t.getAttribute("data-del");saveSessions(loadSessions().filter(t=>t&&t.id!==e)),renderRecentSessions()})})):t.innerHTML='<div class="item"><div class="t">저장된 세션이 없습니다.</div><div class="m" style="margin-top:6px;">WIN/LOSE로 진행 후 “세션 저장”을 눌러주세요.</div></div>'}function setPreset(t){s.preset=t,"PLAYER"===t&&(s.odds=2),"BANKER"===t&&(s.odds=1.97),saveSettings(s),syncInputs(),buildStrategyOptions(s),render()}function setStrategy(t){n.includes(t)&&(s.strategy=t,saveSettings(s),a=initSession(s),syncInputs(),buildStrategyOptions(s),render())}function renderPlan(){const t=$("csPlanBody"),e=$("csPlanSummary");if(!t)return;const n=$("csPlanMaxSteps")?$("csPlanMaxSteps").value:12,a=$("csPlanMddLimit")?toMoney($("csPlanMddLimit").value):null,r=function buildPlan(t,e){t=clamp(parseInt(t||12,10)||12,1,50);const n=Number.isFinite(e)?Math.max(0,e):null,a=[];for(let e=1;e<=t;e++){const t=replay({settings:Object.assign({},s),actions:Array(e-1).fill({outcome:"L"})}).tracker.bet,r=replay({settings:Object.assign({},s),actions:Array(e).fill({outcome:"L"})}),i=r.tracker.pl,o=r.tracker.mdd,l=Math.max(0,-i),c=Math.max(0,s.bankroll||0);let d="OK",u="ok";const m=[];c&&l>c&&(d="자금 부족",u="bad",m.push("자금")),null!=n&&o>n&&(d="OK"===d?"손절 초과":d+" / 손절",u="bad",m.push("손절")),r.tracker.maxBet>c&&c&&"bad"!==u&&(d="단일 베팅 과다",u="warn"),a.push({step:e,bet:t,pl:i,mdd:o,need:l,verdict:d,cls:u})}return{rows:a}}(n,a),i=Math.max(0,s.bankroll||0),o=Number.isFinite(a)?a:null;t.innerHTML=r.rows.map(t=>{const e="bad"===t.cls?"cs-tag bad":"warn"===t.cls?"cs-tag warn":"cs-tag ok";return`\n        <tr>\n          <td>${t.step}</td>\n          <td class="cs-right"><b>${fmtMoney(t.bet)}</b></td>\n          <td class="cs-right">${fmtMoney(t.pl)}</td>\n          <td class="cs-right">${fmtMoney(t.mdd)}</td>\n          <td><span class="${e}">${t.verdict}</span></td>\n        </tr>\n      `}).join("");const l=r.rows.reduce((t,e)=>t.need>e.need?t:e,r.rows[0]),c=r.rows.reduce((t,e)=>t.bet>e.bet?t:e,r.rows[0]),d=[];d.push(`<div>• 최대 단계 <b>${r.rows.length}</b> 기준: 최악 연패 시 필요한 누적자금 <b>${fmtMoney(l.need)}</b></div>`),d.push(`<div>• 연패 구간 최대 단일 베팅: <b>${fmtMoney(c.bet)}</b></div>`),i&&d.push(`<div>• 입력 자금: <b>${fmtMoney(i)}</b> (${l.need<=i?"OK":"부족"})</div>`),null!=o&&d.push(`<div>• 손절(MDD) 한도: <b>${fmtMoney(o)}</b> (${l.mdd<=o?"OK":"초과"})</div>`),e.innerHTML=d.join("")}document.addEventListener("DOMContentLoaded",function boot(){function formatMoneyInput(t,e){if(!t)return;const n=numFromInput(t);if(n)if(e){const e=Math.round(100*n)/100;t.value=String(e)}else t.value=fmtMoney(Math.floor(n));else t.value=""}s=function loadSettings(){const e=Object.assign({preset:"PLAYER",odds:2,baseBet:1e4,bankroll:0,increment:1e3,targetMode:"auto",targetProfit:0,strategy:"martingale",paroliMult:2,paroliCap:3,fibOddsAdjust:!1,labOddsAdjust:!0,labSeq:"1,2,3,4"},lsRead(t,{}));return n.includes(e.strategy)||(e.strategy="martingale"),e.odds=getOdds(e),e.baseBet=Math.max(1,Math.floor(e.baseBet||1e4)),e.increment=Math.max(1,Math.floor(e.increment||1e3)),e.paroliMult=clamp(Number(e.paroliMult||2),1.1,10),e.paroliCap=clamp(Math.floor(e.paroliCap||3),0,12),e}(),a=initSession(s);const e=(location.hash||"").replace(/^#/,"").trim();e&&n.includes(e)&&(s.strategy=e),$("csPresetPlayer").addEventListener("click",()=>setPreset("PLAYER")),$("csPresetBanker").addEventListener("click",()=>setPreset("BANKER")),$("csOdds").addEventListener("input",()=>{updateSettingsFromCommonInputs(),buildStrategyOptions(s),render()}),$("csOdds").addEventListener("blur",()=>{formatMoneyInput($("csOdds"),!0),updateSettingsFromCommonInputs(),buildStrategyOptions(s),render()}),$("csBaseBet").addEventListener("blur",()=>{formatMoneyInput($("csBaseBet"),!1),updateSettingsFromCommonInputs(),buildStrategyOptions(s),render()}),$("csBankroll").addEventListener("blur",()=>{formatMoneyInput($("csBankroll"),!1),updateSettingsFromCommonInputs(),render()}),$("csIncrement").addEventListener("blur",()=>{formatMoneyInput($("csIncrement"),!1),updateSettingsFromCommonInputs(),buildStrategyOptions(s),render()}),$("csBaseBet").addEventListener("input",()=>{updateSettingsFromCommonInputs(),buildStrategyOptions(s),render()}),$("csBankroll").addEventListener("input",()=>{updateSettingsFromCommonInputs(),render()}),$("csIncrement").addEventListener("input",()=>{updateSettingsFromCommonInputs(),buildStrategyOptions(s),render()}),$("csTargetMode").addEventListener("change",()=>{s.targetMode="manual"===$("csTargetMode").value?"manual":"auto",$("csTargetProfit").disabled="manual"!==s.targetMode,"manual"!==s.targetMode&&(s.targetProfit=0),saveSettings(s),buildStrategyOptions(s),render()}),$("csTargetProfit").addEventListener("input",()=>{updateSettingsFromCommonInputs(),buildStrategyOptions(s),render()}),$("csTargetProfit").addEventListener("blur",()=>{formatMoneyInput($("csTargetProfit"),!1),updateSettingsFromCommonInputs(),buildStrategyOptions(s),render()}),$("csTabs").addEventListener("click",t=>{const e=t.target&&t.target.closest("button[data-strategy]");if(!e)return;const n=e.getAttribute("data-strategy");history.replaceState(null,"","#"+n),setStrategy(n)}),$("csWin").addEventListener("click",()=>applyOutcome("W")),$("csLose").addEventListener("click",()=>applyOutcome("L")),$("csUndo").addEventListener("click",()=>function undo(){a.actions.length&&(a.actions.pop(),render())}()),$("csReset").addEventListener("click",()=>function resetSession(t){t&&saveSession(),a=initSession(s),render()}(!0)),$("csSaveSession").addEventListener("click",()=>{saveSession(),renderRecentSessions()}),$("csPlanGenerate")&&$("csPlanGenerate").addEventListener("click",()=>{renderPlan()}),$("csPlanMaxSteps")&&$("csPlanMaxSteps").addEventListener("input",debounce(()=>{renderPlan()},120)),$("csPlanMddLimit")&&$("csPlanMddLimit").addEventListener("input",debounce(()=>{renderPlan()},120)),syncInputs(),buildStrategyOptions(s),render(),window.addEventListener("hashchange",()=>{const t=(location.hash||"").replace(/^#/,"").trim();n.includes(t)&&setStrategy(t)})})}();