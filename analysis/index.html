<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>ìŠ¤í¬ì¸  ë°°ë‹¹ ë¶„ì„ê¸° | 88 ì»¤ë®¤ë‹ˆí‹°</title>
<meta name="description" content="ì¢…ëª©(ì¶•êµ¬/ë†êµ¬/ì•¼êµ¬/ë°°êµ¬/eìŠ¤í¬ì¸ /í•˜í‚¤)ë³„ ë°°ë‹¹ ì…ë ¥ìœ¼ë¡œ ìŠ¹ë¦¬ í™•ë¥ (ë°°ë‹¹ ê¸°ë°˜Â·ì¶”ì •), ì˜¤ë²„ë¼ìš´ë“œ, ë§ˆì§„, ë°¸ë¥˜(EV), ê¶Œì¥ ë¹„ì¤‘(ë³´ìˆ˜ì  Kelly), ë©”ì¸/ì˜¤ë²„ì–¸ë”/í•¸ë”” ë§ˆì§„ì„ í†µí•© ê³„ì‚°í•˜ê³  íˆìŠ¤í† ë¦¬/ë¹„êµê¹Œì§€ ì§€ì›í•˜ëŠ” ë¶„ì„ê¸°ì…ë‹ˆë‹¤. (íŒë‹¨ ë³´ì¡°ìš©)" />
<link rel="canonical" href="https://88st.cloud/analysis/" />
<meta name="robots" content="index,follow" />

<style>
*{box-sizing:border-box}
:root{
  /* Theme (auto/preset) */
  --accent1:#d4af37;
  --accent2:#f5e27a;
  --accentRGB:212,175,55;
  --accentText:#000;
  --accentOn:#00121a;

  /* Glass intensity */
  --glassA:.84;
  --glassStrongA:.94;
  --glassSoftA:.26;
  --glassBorder:rgba(255,255,255,.06);

  /* Backward-compat */
  --gold: var(--accent1);
  --gold2: var(--accent2);

  --bg:#0b0b0b;
  --panel:#121212;
  --panel2:#0f0f0f;
--muted:#bdbdbd;

  --ok:#b7ffcf;
  --warn:#ffcf99;
  --bad:#ffb3b3;
  --chip:#1f1f1f;
}
html{scroll-behavior:smooth}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;
  background:
    radial-gradient(1200px 500px at 50% -10%, rgba(var(--accentRGB),.14), transparent 55%),
    radial-gradient(900px 500px at 10% 20%, rgba(90,160,255,.08), transparent 60%),
    linear-gradient(180deg, #07070a, var(--bg));
  color:#fff;
}

/* ===== ìƒë‹¨ ê³µì§€/ì´ë²¤íŠ¸ ë°°ë„ˆ (ìë™ ìˆœí™˜) ===== */
.notice-bar{
  position:sticky;
  top:10px;
  z-index:1600;

  /* glass + rounded */
  width:min(980px, calc(100% - 24px));
  margin:10px auto 0;
  border-radius:999px;

  background:rgba(20,20,24,.38);
  border:1px solid rgba(255,255,255,.14);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);

  color:rgba(255,255,255,.92);
  font-weight:900;
  font-size:13px;
  padding:10px 12px;
  text-align:center;

  box-shadow:0 10px 30px rgba(0,0,0,.35);
  display:flex;
  align-items:center;
  gap:10px;

  transition:padding .18s ease, font-size .18s ease, box-shadow .18s ease,
             background .18s ease, border-color .18s ease, opacity .18s ease;
}
.notice-bar a{
  color:rgba(255,255,255,.92);
  text-decoration:none;
  flex:1;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.notice-toggle{
  flex:0 0 auto;
  width:34px;
  height:28px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.08);
  color:#fff;
  font-weight:1000;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  line-height:1;
  transition:transform .18s ease, background .18s ease, border-color .18s ease;
}
.notice-toggle:hover{ background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.26); }
.notice-toggle:active{ transform:scale(.98); }

.notice-icon{
  flex:0 0 auto;
  width:28px;
  height:28px;
  border-radius:999px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.16);
  display:flex;
  align-items:center;
  justify-content:center;
  line-height:1;
  box-shadow:0 6px 16px rgba(0,0,0,.22);
}
.notice-mini-text{
  display:none;
  font-weight:950;
  letter-spacing:-.2px;
}

/* (ì˜µì…˜) ì´ˆìŠ¬ë¦¼/ë¯¸ë‹ˆ í˜•íƒœ - ê¸°ì¡´ í´ë˜ìŠ¤ ìœ ì§€ */
.notice-bar.is-mini{
  padding:7px 10px;
  font-size:12px;
  background:rgba(20,20,24,.22);
  border-color:rgba(255,255,255,.10);
  opacity:.88;
  box-shadow:0 8px 22px rgba(0,0,0,.25);
}
.notice-bar.is-mini a{
  text-align:left;
  display:flex;
  align-items:center;
}
.notice-bar.is-mini #noticeText{ display:none; }
.notice-bar.is-mini .notice-mini-text{
  display:block;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.notice-bar.is-mini .notice-toggle{ display:none; }

/* ìŠ¤í¬ë¡¤/ì ‘í˜ ìƒíƒœ: ë” íˆ¬ëª… + ë” ì»´íŒ©íŠ¸ */
.notice-bar.is-collapsed{
  padding:7px 10px;
  font-size:12px;
  background:rgba(20,20,24,.20);
  border-color:rgba(255,255,255,.10);
  opacity:.88;
  box-shadow:0 8px 22px rgba(0,0,0,.25);
}

@media (max-width:520px){
  .notice-bar{ top:8px; width:calc(100% - 20px); margin:8px auto 0; }
  .notice-toggle{ width:32px; height:26px; }
}

/* ===== ì‚¬ì¹­ì£¼ì˜ íŒì—… (1ì¼ 1íšŒ) ===== */
.scam-popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:3000;
  padding:18px;
}
.scam-box{
  background:rgba(17,17,17,.95);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  padding:22px;
  width:100%;
  max-width:380px;
  text-align:center;
  box-shadow:0 18px 60px rgba(0,0,0,.75);
  backdrop-filter: blur(10px);
}
.scam-box h3{ color:#ff6b6b; margin:0 0 10px; font-weight:900; }
.scam-box p{ font-size:13px; color:#ddd; line-height:1.55; margin:0; }
.scam-box .btn{
  margin-top:12px;
  padding:12px;
  border-radius:12px;
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  color:#000;
  font-weight:900;
  cursor:pointer;
  user-select:none;
}

/* ìƒë‹¨ */
.header{ text-align:center; padding:14px 0 10px; }
.logo-link{display:inline-block;text-decoration:none}
.logo-img{
  display:block; margin:0 auto 6px;
  width:180px; max-width:72%; height:auto;
  filter:drop-shadow(0 0 10px rgba(var(--accentRGB),.25));
}
@media(max-width:480px){ .logo-img{width:150px;max-width:82%} }
.sub{ font-size:12px; color:#9a9a9a; }

/* ë ˆì´ì•„ì›ƒ */
.wrap{ max-width:980px; margin:0 auto; padding:10px 14px 34px; }
.card{
  background:rgba(18,18,18,.86);
  border:1px solid rgba(255,255,255,.06);
  border-radius:18px; padding:14px;
  box-shadow:0 10px 26px rgba(0,0,0,.45);
  margin-bottom:14px;
  backdrop-filter: blur(10px);
}
.title{ font-weight:900; color:var(--gold2); margin-bottom:10px; font-size:14px; display:flex; align-items:center; gap:8px; }
.badge{
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  font-size:11px;
  font-weight:900;
  color:#000;
  background:linear-gradient(135deg,var(--gold),var(--gold2));
}
.note{ color:#bdbdbd; font-size:12px; line-height:1.5; margin-top:8px; }
.small-hint{ font-size:11px; color:#8f8f8f; margin-top:6px; line-height:1.4; }

/* ì»¨íŠ¸ë¡¤ */
.controls{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
@media(max-width:560px){ .controls{ grid-template-columns:1fr; } }
.select, .textinput{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.08);
  background:var(--panel2);
  color:#fff;
  outline:none;
  font-weight:800;
}
.textinput{ font-weight:700; }
.row2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:10px;
}
@media(max-width:560px){ .row2{ grid-template-columns:1fr; } }

/* ì…ë ¥ */
.grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
@media(max-width:560px){ .grid{grid-template-columns:1fr} }
.field label{ display:block; font-size:12px; color:#bbb; margin:2px 0 6px; }
.field input{
  width:100%; padding:12px; border-radius:14px;
  border:1px solid rgba(255,255,255,.08);
  background:var(--panel2); color:#fff; outline:none;
}
.field input::placeholder{color:#555}

/* ì„¹ì…˜ ë°•ìŠ¤ */
.box{
  margin-top:12px;
  padding:12px;
  border-radius:16px;
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.06);
}
.box-title{ font-weight:900; margin:0 0 8px; color:var(--gold2); font-size:13px; }
.box-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.toggle{
  cursor:pointer; font-size:12px; color:#cfcfcf;
  user-select:none; padding:6px 10px; border-radius:999px;
  border:1px solid rgba(255,255,255,.08); background:rgba(0,0,0,.25);
}

/* ì•¡ì…˜ */
.actions{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
.btn{
  flex:1; min-width:160px;
  border:none; border-radius:14px; padding:12px;
  font-weight:900; cursor:pointer;
}
.primary{ background:linear-gradient(135deg,#1da1f2,#78d6ff); color:#00121a; }
.secondary{ background:var(--chip); color:#fff; border:1px solid rgba(255,255,255,.06); }
.gold{ background:linear-gradient(135deg,var(--gold),var(--gold2)); color:#111; }

/* ê²°ê³¼ */
.result{
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.06);
  border-radius:16px;
  padding:12px;
  margin-top:12px;
}

/* ê²°ê³¼ ìš”ì•½ ì¹´ë“œ(ì²« í™”ë©´ ê°•ì¡°) */
.resultHero{
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(600px 200px at 0% 0%, rgba(90,160,255,.10), transparent 55%),
    radial-gradient(600px 200px at 100% 0%, rgba(var(--accentRGB),.10), transparent 55%),
    rgba(255,255,255,.03);
  border-radius:18px;
  padding:14px;
  box-shadow: 0 14px 34px rgba(0,0,0,.35);
  margin-bottom:10px;
  animation:popIn .22s ease-out;
}
@keyframes popIn{ from{ transform:translateY(6px); opacity:0;} to{transform:none; opacity:1;} }
.heroTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; }
.heroText{ min-width:240px; }
.heroTitle{ font-weight:1000; font-size:15px; color:#fff; letter-spacing:-.2px; }
.heroSub{ margin-top:3px; font-size:12px; color:#bdbdbd; line-height:1.35; }
.heroBadges{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

.heroRight{ display:flex; flex-direction:column; align-items:flex-end; gap:8px; }
.heroConclusion{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);
  max-width:340px;
}
.heroConclusion .cIcon{ font-size:16px; line-height:1; }
.heroConclusion .cText{ font-size:13px; font-weight:900; letter-spacing:-.2px; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.heroConclusion.good{ border-color: rgba(48,209,88,.35); background: rgba(48,209,88,.12); }
.heroConclusion.warn{ border-color: rgba(255,193,7,.35); background: rgba(255,193,7,.12); }
.heroConclusion.bad{ border-color: rgba(255,59,48,.35); background: rgba(255,59,48,.12); }
@media (max-width:520px){
  .heroRight{ width:100%; align-items:flex-start; }
  .heroBadges{ justify-content:flex-start; }
  .heroConclusion{ max-width:100%; width:100%; }
  .heroConclusion .cText{ white-space:normal; }
}
.chip.big{ padding:8px 12px; font-size:13px; }
.heroStats{
  margin-top:12px;
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap:10px;
}
.statCard{
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.22);
  border-radius:14px;
  padding:10px 10px;
}
.statK{ font-size:11px; color:#bdbdbd; }
.statV{ margin-top:4px; font-size:16px; font-weight:1000; color:#fff; letter-spacing:-.2px; }
.statS{ margin-top:2px; font-size:11px; color:#9a9a9a; }
.detailHead{
  margin:10px 0 4px;
  font-weight:900;
  font-size:13px;
  color:#fff;
  display:flex; align-items:center; gap:8px;
}
.detailHead:before{
  content:"";
  width:8px; height:8px; border-radius:99px;
  background:rgba(var(--accentRGB),.9);
  box-shadow:0 0 0 4px rgba(var(--accentRGB),.12);
}
@media (max-width:520px){
  .heroStats{ grid-template-columns: 1fr; }
  .heroText{ min-width: 0; }
  .heroBadges{ justify-content:flex-start; }
}

.kv{
  display:flex; justify-content:space-between; gap:10px;
  padding:8px 0; border-bottom:1px solid rgba(255,255,255,.06);
  font-size:13px;
}
.kv:last-child{border-bottom:none}
.k{color:#cfcfcf}
.v{font-weight:900}
.warn{color:var(--bad)}
.good{color:var(--ok)}
.mid{color:var(--warn)}

hr.sep{ border:none; height:1px; background:rgba(255,255,255,.06); margin:12px 0; }

.footer-links{ display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }
.linkbtn{
  flex:1; min-width:160px;
  display:block; text-align:center; padding:12px;
  border-radius:14px; text-decoration:none; font-weight:900;
  background:var(--chip); color:#fff;
  border:1px solid rgba(255,255,255,.06);
}

/* ì²´í¬ë¦¬ìŠ¤íŠ¸ */
.checklist{
  color:#cfcfcf;
  font-size:13px;
  line-height:1.55;
}
.checklist strong{ color:#fff; }

/* ë§ˆì§„ ëŒ€ì‹œë³´ë“œ */
.m-grid{
  display:grid; gap:10px;
  grid-template-columns:1fr 1fr 1fr;
}
@media(max-width:800px){ .m-grid{ grid-template-columns:1fr; } }
.m-card{
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.25);
  border-radius:16px;
  padding:12px;
}
.m-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
.m-name{ font-weight:900; color:#fff; font-size:13px; }
.chip{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);
}
.chip.ok{ color:var(--ok); }
.chip.mid{ color:var(--warn); }
.chip.bad{ color:var(--bad); }
.m-lines{ margin-top:10px; font-size:12px; color:#cfcfcf; line-height:1.45; }
.m-lines b{ color:#fff; }

/* íˆìŠ¤í† ë¦¬ */
.history-toolbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:8px;
}
.history-toolbar .btn{ min-width:0; flex:1; }

.history-toolbar .btn.danger{
  border-color:rgba(255,80,80,.35);
  color:#ffd1d1;
}
.history-toolbar .btn.danger:hover{
  border-color:rgba(255,80,80,.55);
  background:rgba(255,80,80,.08);
}
.history-filters{
  margin-top:10px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}
.history-filters .seg{
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
  color:#ddd;
  font-weight:900;
  cursor:pointer;
}
.history-filters .seg.on{
  background:linear-gradient(135deg, rgba(255,203,66,.22), rgba(255,176,60,.12));
  border-color:rgba(255,203,66,.35);
  color:#fff;
}
.pick-ind{
  margin-left:auto;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.03);
  color:#cfcfcf;
  font-size:12px;
  font-weight:800;
}
.pick-ind b{ color:#fff; }
@media (max-width:420px){
  .pick-ind{ margin-left:0; }
}

.h-list{ margin-top:10px; display:grid; gap:10px; }
.h-item{
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.25);
  border-radius:16px;
  padding:10px 12px;
}
.h-top{
  display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
}
.h-title{
  font-weight:900; font-size:13px;
}
.h-sub{
  margin-top:4px;
  font-size:12px; color:#cfcfcf; line-height:1.4;
}
.h-actions{
  display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
}
.h-actions button{
  border-radius:12px;
  padding:8px 10px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.25);
  color:#fff;
  font-weight:900;
  cursor:pointer;
  font-size:12px;
}
.h-actions button.primary2{
  background:linear-gradient(135deg,#1da1f2,#78d6ff);
  color:#00121a;
  border:none;
}
.h-actions .pick{
  display:flex; align-items:center; gap:6px; font-size:12px; color:#cfcfcf;
}
.h-actions input[type="checkbox"]{ transform:scale(1.15); }

/* ë¹„êµ ëª¨ë‹¬ */
.modal{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  z-index:3200;
  padding:16px;
  background:rgba(0,0,0,.75);
}
.modal-box{
  width:100%;
  max-width:980px;
  background:rgba(17,17,17,.95);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  box-shadow:0 18px 60px rgba(0,0,0,.75);
  backdrop-filter: blur(10px);
  padding:14px;
}
.modal-head{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  margin-bottom:10px;
}
.modal-head .t{ font-weight:900; color:var(--gold2); }
.modal-close{
  cursor:pointer; user-select:none;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.25);
  font-weight:900;
}
.compare-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
@media(max-width:760px){ .compare-grid{ grid-template-columns:1fr; } }
.compare-col{
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.25);
  border-radius:16px;
  padding:12px;
}
.compare-col .ct{ font-weight:900; margin-bottom:8px; }
.compare-col .line{ display:flex; justify-content:space-between; gap:10px; font-size:12px; padding:6px 0; border-bottom:1px solid rgba(255,255,255,.06); }
.compare-col .line:last-child{ border-bottom:none; }
.compare-col .line .k{ color:#cfcfcf; }
.compare-col .line .v{ font-weight:900; }
.compare-col .mini-actions{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
.compare-col .mini-actions button{
  flex:1; min-width:120px;
  border:none; border-radius:12px; padding:10px;
  font-weight:900; cursor:pointer;
}
.compare-col .mini-actions .restore{ background:linear-gradient(135deg,#1da1f2,#78d6ff); color:#00121a; }
.compare-col .mini-actions .close{ background:#1f1f1f; color:#fff; border:1px solid rgba(255,255,255,.06); }

/* í† ìŠ¤íŠ¸ */
#toast88{
  position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
  background:rgba(0,0,0,.85); color:#fff;
  padding:10px 12px; border-radius:12px; font-size:12px;
  z-index:4000; border:1px solid rgba(255,255,255,.08);
  opacity:0; pointer-events:none; transition:opacity .2s ease;
}

/* ===== ë¶„ì„ê¸° ì§„ì… ê´‘ê³  íŒì—… (Aì•ˆ: 1ì¼ 1íšŒ, 2ê°œ ë…¸ì¶œ) ===== */
.ad-popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.78);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2600;
  padding:18px;
}
.ad-box{
  width:100%;
  max-width:420px;
  background:rgba(17,17,17,.95);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  padding:18px;
  box-shadow:0 18px 60px rgba(0,0,0,.75);
  backdrop-filter: blur(10px);
}
.ad-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}
.ad-title{
  font-weight:900;
  color:var(--gold2);
  font-size:14px;
}
.ad-close{
  cursor:pointer;
  user-select:none;
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.28);
  color:#fff;
}
.ad-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
@media(max-width:360px){
  .ad-grid{ grid-template-columns:1fr; }
}
.ad-item{
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.25);
  border-radius:14px;
  padding:12px;
  cursor:pointer;
}
.ad-item .name{ font-weight:900; font-size:13px; }
.ad-item .sub{ font-size:11px; color:#bdbdbd; margin-top:4px; line-height:1.4; }
.ad-item .badge{
  display:inline-block;
  margin-top:8px;
  font-size:11px;
  font-weight:900;
  padding:4px 8px;
  border-radius:999px;
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  color:#111;
}
.ad-actions{
  display:flex;
  gap:10px;
  margin-top:12px;
}
.ad-actions .btnx{
  flex:1;
  text-align:center;
  padding:10px 12px;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
  border:1px solid rgba(255,255,255,.08);
  background:#1f1f1f;
  color:#fff;
  text-decoration:none;
}
.ad-actions .btnx.primary{
  background:linear-gradient(135deg,#1da1f2,#78d6ff);
  color:#00121a;
  border:none;
}
.ad-note{
  margin-top:10px;
  font-size:11px;
  color:#9a9a9a;
  line-height:1.4;
}

/* ===== UX Add-ons (non-breaking) ===== */
.save-badge{
  margin-left:auto;
  font-size:11px;
  font-weight:900;
  color:rgba(255,255,255,.86);
  letter-spacing:.2px;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.save-badge .dot{
  width:8px; height:8px; border-radius:999px;
  background:rgba(255,255,255,.55);
  box-shadow:0 0 0 3px rgba(255,255,255,.08);
}
.quick-nav{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:10px;
}
.quick-nav .chip{
  border:1px solid rgba(var(--accentRGB),.28);
  background:rgba(255,255,255,.06);
  color:#fff;
  padding:8px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  cursor:pointer;
  transition:transform .12s ease, background .12s ease;
}
.quick-nav .chip:hover{ transform:translateY(-1px); background:rgba(255,255,255,.09); }
.mini-guide{
  margin-top:10px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.04);
  border-radius:14px;
  overflow:hidden;
}
.mini-guide .head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  cursor:pointer;
  user-select:none;
  font-weight:900;
}
.mini-guide .head .pill{
  font-size:11px;
  font-weight:900;
  background:rgba(var(--accentRGB),.18);
  border:1px solid rgba(var(--accentRGB),.28);
  padding:6px 10px;
  border-radius:999px;
}
.mini-guide .body{
  display:none;
  padding:10px 12px 12px;
  color:#d7d7d7;
  font-size:12px;
  line-height:1.5;
}
.mini-guide .body b{ color:#fff; }
.is-invalid{
  outline:2px solid rgba(255,90,90,.75) !important;
  box-shadow:0 0 0 6px rgba(255,90,90,.12) !important;
  border-color:rgba(255,90,90,.6) !important;
}
.modal-box.share{
  max-width:560px;
  max-height:92vh;
  overflow:auto;
}
.share-canvas-wrap{
  margin-top:12px;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:10px;
}
.share-canvas{
  width:100%;
  height:auto;
  border-radius:12px;
  display:block;
}

/* ===== ë¬¶ìŒ ê³µìœ (ì˜¤ëŠ˜ ìˆ˜ì§‘) ===== */
.bundle-meta{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-top:10px;
  padding:10px 12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  border-radius:14px;
  color:rgba(255,255,255,.86);
  font-size:12px;
}
.bundle-meta b{ color:#fff; }
.bundle-ta{
  width:100%;
  min-height:160px;
  margin-top:10px;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.28);
  color:#fff;
  font-size:12px;
  line-height:1.5;
  resize:vertical;
}
.bundle-ta:focus{ outline:2px solid rgba(var(--accentRGB),.26); box-shadow:0 0 0 8px rgba(var(--accentRGB),.10); }
.bundle-mini{
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.bundle-pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(var(--accentRGB),.28);
  background:rgba(var(--accentRGB),.14);
  color:#fff;
  font-weight:900;
  font-size:11px;
}

.bundle-promo{
  margin-top:12px;
  padding-top:12px;
  border-top:1px dashed rgba(255,255,255,.10);
}
.bundle-promo-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.bundle-promo-title{
  font-weight:900;
  font-size:13px;
  color:#fff;
}
.bundle-promo-ctrl{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.inp.mini{
  padding:8px 10px;
  font-size:12px;
  border-radius:12px;
}
.bundle-ta--promo{
  min-height:140px;
}

.bundle-switch{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
  border-radius:999px;
  font-size:12px;
  color:rgba(255,255,255,.92);
  cursor:pointer;
  user-select:none;
}
.bundle-switch input{
  width:14px; height:14px;
  accent-color:#d4af37;
}
.bundle-switch span{ font-weight:900; }

@media (max-width:560px){
  body{ padding-bottom: calc(env(safe-area-inset-bottom) + 72px); }
  .mobile-dock{
    position:fixed;
    left:0; right:0; bottom:0;
    z-index:1700;
    display:flex;
    gap:10px;
    padding:10px 12px calc(env(safe-area-inset-bottom) + 12px);
    background:linear-gradient(180deg, rgba(10,10,12,0), rgba(10,10,12,.72) 30%, rgba(10,10,12,.94));
    backdrop-filter: blur(10px);
  }
  .mobile-dock .dock-btn{
    flex:1;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.06);
    color:#fff;
    border-radius:14px;
    padding:12px 10px;
    font-weight:1000;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    min-height:44px;
  }
  .mobile-dock .dock-btn.primary{
    background:linear-gradient(135deg, var(--gold), var(--gold2));
    color:#000;
    border-color:rgba(0,0,0,.08);
  }
}
@media (min-width:561px){
  .mobile-dock{ display:none; }
}



/* ===== Empty History Demo ===== */
.demo-empty{
  border:1px dashed rgba(255,255,255,.18);
  background:rgba(255,255,255,.03);
  padding:14px;
  border-radius:14px;
}
.demo-title{ font-weight:900; font-size:14px; margin-bottom:6px; }
.demo-desc{ font-size:12px; color:#cfcfcf; line-height:1.5; }
.demo-btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
.demo-btns .btn{ flex:1; min-width:170px; }
.demo-note{ margin-top:10px; font-size:11px; color:#9aa0a6; line-height:1.45; }

/* ===== First-Visit Onboarding ===== */
.onb-highlight{
  position:relative;
  z-index:9998 !important;
  border-radius:16px !important;
  box-shadow: 0 0 0 9999px rgba(0,0,0,.68), 0 0 0 2px rgba(255,255,255,.18) !important;
}
#onbPopover{
  position:fixed;
  z-index:9999;
  max-width:340px;
  width:calc(100vw - 36px);
  background:rgba(14,16,20,.96);
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  box-shadow: 0 10px 30px rgba(0,0,0,.45);
  padding:14px;
  display:none;
}
#onbPopover .onb-hd{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
#onbPopover .onb-title{
  font-weight:900; font-size:14px;
}
#onbPopover .onb-step{
  font-size:11px; color:#9aa0a6;
}
#onbPopover .onb-body{
  margin-top:8px;
  font-size:12px; color:#cfcfcf; line-height:1.55;
}
#onbPopover .onb-actions{
  display:flex; gap:8px; margin-top:12px; justify-content:flex-end; flex-wrap:wrap;
}
#onbPopover .onb-actions .btn{ min-width:0; }
#onbPopover .onb-skip{
  margin-right:auto;
  font-size:12px;
  background:transparent;
  border:1px solid rgba(255,255,255,.16);
  color:#cfcfcf;
}


/* ===== ì…ë ¥ ê²€ì¦ ===== */
.invalid{
  border-color: rgba(255,90,90,.95) !important;
  box-shadow: 0 0 0 3px rgba(255,90,90,.18) !important;
}
.input-warn{
  margin-top:10px;
  padding:10px 12px;
  border-radius:14px;
  background:rgba(255,90,90,.10);
  border:1px solid rgba(255,90,90,.25);
  color:#ffd1d1;
  font-size:12px;
  line-height:1.45;
  display:none;
}
.input-warn b{ color:#fff; }

/* ===== ìµœê·¼ ì…ë ¥ ìŠ¤ëƒ…ìƒ· ===== */
.snap-wrap{
  margin-top:12px;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.22);
}
.snap-head{
  font-size:12px;
  color:#cfcfcf;
  font-weight:800;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.snap-list{
  margin-top:8px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.snap-chip{
  cursor:pointer;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.06);
  color:#fff;
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  font-weight:800;
}
.snap-chip:hover{
  transform: translateY(-1px);
  border-color: rgba(255,255,255,.28);
}
.snap-meta{ color:#cfcfcf; font-weight:700; margin-left:6px; font-size:11px; }

/* ===== ë‚´ í†µê³„(ì„±ê³¼) ===== */
.perf-box{
  margin-top:12px;
  border-radius:16px;
  padding:12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.22);
}
.perf-title{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  font-weight:900; font-size:13px;
}
.perf-sub{
  margin-top:6px;
  font-size:12px; color:#cfcfcf; line-height:1.45;
}
.perf-grid{
  margin-top:10px;
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap:10px;
}
.perf-tile{
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.05);
  border-radius:14px;
  padding:10px;
}
.perf-k{ font-size:12px; color:#cfcfcf; font-weight:800; }
.perf-v{ margin-top:4px; font-size:16px; font-weight:900; }
.perf-n{ margin-top:4px; font-size:11px; color:#bfbfbf; font-weight:700; }

.outTag{
  display:inline-flex; align-items:center; gap:6px;
  border-radius:999px;
  padding:4px 10px;
  font-size:11px;
  font-weight:900;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:#fff;
}
.outTag.win{ border-color: rgba(67,226,164,.40); background: rgba(67,226,164,.12); }
.outTag.lose{ border-color: rgba(255,90,90,.40); background: rgba(255,90,90,.12); }
.outTag.void{ border-color: rgba(255,208,72,.40); background: rgba(255,208,72,.10); }
.outTag.none{ border-color: rgba(255,255,255,.14); background: rgba(255,255,255,.06); color:#cfcfcf; }

.outBtns{
  margin-top:8px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.oBtn{
  cursor:pointer;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:#fff;
  border-radius:12px;
  padding:6px 10px;
  font-size:12px;
  font-weight:900;
}
.oBtn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.24); }
.oBtn.on{ border-color: rgba(255,255,255,.40); background:rgba(255,255,255,.12); }

.h-outcome{
  margin-top:10px;
  padding-top:10px;
  border-top:1px dashed rgba(255,255,255,.12);
}
.h-outcome .row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}
.h-outcome .row .label{ font-size:12px; color:#cfcfcf; font-weight:800; }

/* ===== ê²°ê³¼ ìƒë‹¨ ê¸°ë¡/ì‹ ë¢° ===== */
.trustLine{
  margin-top:10px;
  font-size:12px;
  color:#cfcfcf;
  line-height:1.45;
}
.trustLine b{ color:#fff; }

.heroReason{
  margin-top:8px;
  font-size:12px;
  color:#d9d9d9;
  line-height:1.45;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.04);
}

.outcomeBar{
  margin-top:8px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.outcomeBar .oBtn{ border-radius:999px; padding:8px 12px; }



/* ===== Settings spotlight (calcCard) ===== */
#calcCard{
  border:1px solid rgba(var(--accentRGB),.24) !important;
  background:
    radial-gradient(110% 160% at 12% 0%, rgba(var(--accentRGB),.16), rgba(0,0,0,0) 55%),
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.015));
  box-shadow: 0 18px 45px rgba(0,0,0,.62), 0 0 0 1px rgba(var(--accentRGB),.08) inset;
  position:relative;
  overflow:hidden;
}
#calcCard:before{
  content:"";
  position:absolute; inset:-2px;
  background:linear-gradient(90deg, rgba(var(--accentRGB),.30), rgba(255,255,255,0), rgba(var(--accentRGB),.12));
  opacity:.25;
  pointer-events:none;
  transform:skewX(-14deg) translateX(-40%);
  filter:blur(0px);
}
#calcCard .title{
  font-size:18px !important;
  letter-spacing:.2px;
}
#calcCard .pill-need{
  font-size:11px;
  font-weight:950;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(var(--accentRGB),.30);
  color:rgba(255,255,255,.92);
  background:rgba(var(--accentRGB),.10);
  display:inline-flex;
  align-items:center;
  gap:6px;
  white-space:nowrap;
  margin-left:6px;
}
#calcCard .controls-settings{
  margin-top:12px;
}
#calcCard .selectWrap{
  position:relative;
}
#calcCard .fieldLabel{
  display:flex;
  align-items:center;
  gap:8px;
  margin:0 0 6px 6px;
  font-size:12px;
  font-weight:900;
  color:rgba(255,255,255,.82);
}
#calcCard .stepBubble{
  width:18px; height:18px;
  border-radius:999px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:11px;
  font-weight:950;
  color:#111;
  background:linear-gradient(135deg, var(--gold), var(--gold2));
  box-shadow:0 8px 18px rgba(var(--accentRGB),.18);
}
#calcCard .select{
  border:1px solid rgba(var(--accentRGB),.30) !important;
  background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02)) !important;
  padding:14px 12px !important;
  font-weight:900 !important;
}
#calcCard .select:focus{
  box-shadow:0 0 0 3px rgba(var(--accentRGB),.18);
}
#calcCard .settingsHint{
  margin-top:10px;
  padding:10px 12px;
  border-radius:14px;
  border:1px dashed rgba(255,255,255,.12);
  background:rgba(255,255,255,.03);
  font-size:12px;
  color:rgba(255,255,255,.78);
}
#calcCard .row2{
  margin-top:12px !important;
  padding-top:10px;
  border-top:1px solid rgba(255,255,255,.08);
}
@keyframes calcGlow{
  0%,100%{ box-shadow: 0 18px 45px rgba(0,0,0,.62), 0 0 0 1px rgba(var(--accentRGB),.08) inset; }
  50%{ box-shadow: 0 22px 55px rgba(0,0,0,.68), 0 0 0 1px rgba(var(--accentRGB),.14) inset, 0 0 26px rgba(var(--accentRGB),.08); }
}
#calcCard{ animation:calcGlow 4.2s ease-in-out infinite; }
@media (prefers-reduced-motion: reduce){
  #calcCard{ animation:none; }
  #calcCard:before{ display:none; }
}



/* 88 logo spotlight */
.logoImg, .logo-img{
  width:min(170px,52vw) !important;
  height:auto;
  display:block;
  padding:10px;
  border-radius:20px;
  background:rgba(20,20,24,var(--glassSoftA));
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 0 0 1px rgba(255,255,255,.06), 0 14px 40px rgba(0,0,0,.42), 0 0 26px rgba(var(--accentRGB), .22);
}
@media(max-width:480px){
  .logoImg, .logo-img{ width:min(150px,72vw) !important; padding:9px; }
}



/* ===== v14: ì„¹ì…˜ íƒ€ì´í‹€ ì •ë¦¬ + ë¶„ì„ê¸° UX/UI ì—…ê·¸ë ˆì´ë“œ ===== */
.sr-only{
  position:absolute;
  width:1px;height:1px;
  padding:0;margin:-1px;
  overflow:hidden;clip:rect(0,0,0,0);
  white-space:nowrap;border:0;
}

/* ì¹´ë“œ: ë¶„ì„ê¸°(ìµœìƒë‹¨) ê°•ì¡° */
.card--hero{
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(900px 260px at 0% 0%, rgba(202,152,66,.16), transparent 58%),
    radial-gradient(700px 240px at 100% 0%, rgba(90,160,255,.10), transparent 60%),
    rgba(18,18,18,.86);
}

/* ìƒë‹¨ íˆì–´ë¡œ */
.calc-hero{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}
@media(max-width:560px){
  .calc-hero{ flex-direction:column; }
}
.calc-kicker{ font-size:12px; color:#bdbdbd; letter-spacing:.2px; }
.calc-headline{
  margin-top:4px;
  font-size:16px;
  font-weight:1000;
  color:#fff;
  line-height:1.25;
}
.calc-headline .accent{ color:var(--gold2); }
.calc-tags{ display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
.tag{
  display:inline-flex; align-items:center;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  color:#fff;
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.10);
}
.calc-hero-right{
  display:flex;
  flex-direction:column;
  gap:10px;
  align-items:flex-end;
  min-width:170px;
}
@media(max-width:560px){
  .calc-hero-right{
    width:100%;
    flex-direction:row;
    justify-content:space-between;
    align-items:center;
  }
}
.autosave{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:14px;
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.10);
}
.autosave-label{ font-size:12px; color:#cfcfcf; font-weight:900; }
.calc-divider{
  height:1px;
  background:rgba(255,255,255,.08);
  margin:12px 0 10px;
}

/* ë²„íŠ¼: ê³ ê¸‰/ì„¸ë ¨/ëˆˆì— ë„ê²Œ */
.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
  color:#fff;
  font-weight:950;
  letter-spacing:.2px;
  cursor:pointer;
  transition:transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}
.btn:hover{ transform:translateY(-1px); box-shadow:0 12px 22px rgba(0,0,0,.40); }
.btn:active{ transform:translateY(0); box-shadow:0 8px 16px rgba(0,0,0,.28); }
.btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

.btn.primary{
  background:linear-gradient(135deg, var(--gold), var(--gold2));
  color:#0a0a0a;
  border-color:rgba(0,0,0,.10);
  box-shadow:0 14px 26px rgba(0,0,0,.45);
}
.btn.primary:hover{
  box-shadow:0 18px 32px rgba(0,0,0,.55), 0 0 18px rgba(202,152,66,.22);
}
.btn.secondary{
  background:rgba(0,0,0,.22);
  border-color:rgba(255,255,255,.12);
}
.btn.gold{
  background:rgba(0,0,0,.12);
  border-color:rgba(202,152,66,.35);
  color:var(--gold2);
}
.btn.danger{
  border-color:rgba(255,90,90,.45);
  color:#ffd0d0;
}
.btn.mini{ padding:10px 12px; border-radius:12px; font-size:12px; }

/* ì•¡ì…˜ ì˜ì—­: ì²« ë°©ë¬¸ìë„ ë°”ë¡œ ì“°ê¸° ì¢‹ê²Œ */
.actions{ gap:10px; }
.actions .btn.primary{ flex:2; min-width:220px; }
.actions .btn{ min-width:140px; }

/* TOP3 + ê¸°ì¤€/ì˜ˆì‹œ ë°˜ë°˜ ë ˆì´ì•„ì›ƒ */
.split{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  align-items:start;
}
@media(max-width:860px){ .split{ grid-template-columns:1fr; } }
.split-col{
  padding:12px;
  border-radius:16px;
  background:rgba(255,255,255,.02);
  border:1px solid rgba(255,255,255,.06);
}
.subhead{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:10px;
  font-weight:1000;
  color:#fff;
  font-size:13px;
}
.mini-badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:4px 8px;
  border-radius:999px;
  font-size:11px;
  font-weight:1000;
  background:linear-gradient(135deg, var(--gold), var(--gold2));
  color:#111;
  border:1px solid rgba(0,0,0,.10);
}

/* Result action dock */
.result-dock{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
.result-dock .btn{ flex:1; min-width:150px; }
@media(max-width:560px){ .result-dock .btn{ min-width:0; } }


<!-- ===== GA4 (ê³µí†µ) ===== -->


<script>
</script>

<script src="../assets/theme-preset.js" defer></script>

<style id="v13_1_theme_override">
/* === v13.1 look unify (from main index) === */
:root{
  /* unify accent (blue) */
  --accent1:#5fb2ff !important;
  --accent2:#a8dcff !important;
  --accentRGB:95,178,255 !important;  /* for rgba(var(--accentRGB), .xx) */
  --accentText:#00121a !important;
  --accentOn:#00121a !important;

  /* unify tokens */
  --bg:#05060b !important;
  --panel:rgba(12,14,22,.62) !important;
  --glassA:.72 !important;
  --glassStrongA:.86 !important;
  --glassSoftA:.18 !important;
  --glassBorder:rgba(255,255,255,.10) !important;

  /* backward compat */
  --gold: var(--accent1) !important;
  --gold2: var(--accent2) !important;
}

/* premium midnight background */
body{
  background:
    radial-gradient(1200px 620px at 50% -10%, rgba(var(--accentRGB),.18), transparent 58%),
    radial-gradient(900px 540px at 15% 25%, rgba(120,170,255,.10), transparent 55%),
    radial-gradient(900px 640px at 85% 35%, rgba(80,140,255,.08), transparent 55%),
    linear-gradient(180deg, #05060b 0%, #060612 60%, #040408 100%) !important;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,system-ui;
}

/* remove small label badges (TODAY/MAIN/NEW...) */
.title .badge,
.section-title .badge,
h1 .badge,
h2 .badge,
h3 .badge{ display:none !important; }

/* panel unification (safe selectors) */
.section, .panel, .box, .card, .wrap, .container, .hero, header{
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}

/* inputs */
input, select, textarea{
  background: rgba(0,0,0,.28) !important;
  border:1px solid rgba(255,255,255,.14) !important;
  color:#fff !important;
  border-radius:14px !important;
  outline:none;
}
input:focus, select:focus, textarea:focus{
  border-color: rgba(var(--accentRGB), .38) !important;
  box-shadow: 0 0 0 3px rgba(var(--accentRGB), .12) !important;
}

/* buttons: less-blue, premium glass */
.btn, button, a.btn{
  background: rgba(255,255,255,.06) !important;
  border:1px solid rgba(255,255,255,.14) !important;
  color: rgba(255,255,255,.92) !important;
  box-shadow: 0 12px 34px rgba(0,0,0,.38) !important;
}
.btn:hover, button:hover, a.btn:hover{ filter: brightness(1.06); }
.btn.primary, .btn.go{
  border-color: rgba(var(--accentRGB), .22) !important;
  background: rgba(255,255,255,.08) !important;
}
.btn.secondary, .btn.ghost{
  background: rgba(0,0,0,.18) !important;
}

/* links */
a{ color:inherit; }

/* line compare */
.lc-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;}
@media(max-width:820px){.lc-grid{grid-template-columns:1fr;}}
.lc-col{border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:12px;background:rgba(0,0,0,.18);} 
.lc-head{font-weight:900;font-size:13px;color:rgba(245,226,122,.92);margin-bottom:8px;}
.lc-fields .field{margin-top:0;}
.lc-out{margin-top:10px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);padding:12px;line-height:1.55;font-size:13px;}
.lc-out .k{color:rgba(255,255,255,.62);font-weight:900;}
.lc-out .v{color:rgba(255,255,255,.92);}


/* ===== í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°(ìë™ ì…ë ¥) ===== */
.paste-area{display:flex;flex-direction:column;gap:10px}
.paste-ta{width:100%;min-height:96px;resize:vertical;padding:12px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.22);color:#fff;font-size:13px;line-height:1.45;outline:none}
.paste-ta:focus{border-color:rgba(var(--accentRGB),.35);box-shadow:0 0 0 3px rgba(var(--accentRGB),.12)}
.paste-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.paste-badge{font-size:12px;color:rgba(255,255,255,.78);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04)}
.paste-badge.good{border-color:rgba(183,255,207,.25);color:rgba(183,255,207,.92)}
.paste-badge.warn{border-color:rgba(255,207,153,.25);color:rgba(255,207,153,.92)}
.paste-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.paste-inline .chk{display:flex;gap:6px;align-items:center;font-size:12px;color:rgba(255,255,255,.82)}
.paste-inline input[type=checkbox]{width:16px;height:16px;accent-color:var(--accent1)}

/* multi paste list */
.paste-list-wrap{margin-top:10px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);overflow:hidden}
.paste-list-head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
.paste-list-head .k{font-weight:950;color:rgba(245,226,122,.95)}
.paste-list-head .m{font-size:12px;color:rgba(255,255,255,.68)}
.paste-list{display:flex;flex-direction:column}
.paste-item{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
.paste-item:last-child{border-bottom:none}
.paste-item .left{min-width:0}
.paste-item .t{font-weight:950;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.paste-item .s{margin-top:4px;font-size:12px;color:rgba(255,255,255,.72);line-height:1.35}
.paste-item .chips{margin-top:6px;display:flex;flex-wrap:wrap;gap:6px}
.paste-chip{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:rgba(255,255,255,.78)}
.paste-chip.ok{border-color:rgba(183,255,207,.22);color:rgba(183,255,207,.90)}
.paste-chip.warn{border-color:rgba(255,207,153,.22);color:rgba(255,207,153,.90)}
.paste-item .right{display:flex;flex-direction:column;gap:8px;align-items:flex-end;flex:0 0 auto}
.paste-item .btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.paste-item .mini{padding:8px 10px;border-radius:12px;font-size:12px}
.paste-raw{margin-top:8px;font-size:12px;white-space:pre-wrap;line-height:1.45;color:rgba(255,255,255,.70);border-top:1px dashed rgba(255,255,255,.12);padding-top:8px;display:none}
.paste-item.is-open .paste-raw{display:block}


/* paste list tools + chain save */
.paste-select{height:30px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:#fff;font-size:12px;padding:0 10px;outline:none}
.paste-select:focus{border-color:rgba(var(--accentRGB),.35);box-shadow:0 0 0 3px rgba(var(--accentRGB),.10)}
.paste-list-tools{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.paste-mini-label{display:flex;align-items:center;gap:6px;font-size:12px;color:rgba(255,255,255,.72)}
.paste-num{width:64px;height:30px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:#fff;font-size:12px;padding:0 10px;outline:none}
.paste-num:focus{border-color:rgba(var(--accentRGB),.35);box-shadow:0 0 0 3px rgba(var(--accentRGB),.10)}
.paste-item .left{cursor:pointer}
.paste-item.is-saved{background:rgba(183,255,207,.05)}
.paste-item.is-saved .t{color:rgba(183,255,207,.92)}
.paste-stat{font-size:12px;color:rgba(255,255,255,.72);line-height:1.35;text-align:right}
.paste-stat b{color:rgba(255,255,255,.92)}

</style>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "í™ˆ",
      "item": "https://88st.cloud/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "ë¶„ì„ê¸°",
      "item": "https://88st.cloud/analysis/"
    }
  ]
}
</script>

<script src="/assets/js/88st-analytics.js"></script>
</head>

<body>

<!-- âœ… ìƒë‹¨ ê³µì§€/ì´ë²¤íŠ¸ ë°°ë„ˆ(ìë™ ìˆœí™˜) -->
<div class="notice-bar" id="noticeBar" role="region" aria-label="ìƒë‹¨ ê³µì§€">
  <span class="notice-icon" aria-hidden="true">ğŸ””</span>
  <a href="https://t.me/UZU59" target="_blank" rel="noopener" aria-label="ê³µì§€ ì—´ê¸° (í…”ë ˆê·¸ë¨)">
    <span id="noticeText"></span>
    <span class="notice-mini-text" id="noticeMiniText">ì‚¬ì¹­ ì£¼ì˜ Â· @UZU59</span>
  </a>
  <button class="notice-toggle" id="noticeToggle" type="button" aria-label="ê³µì§€ ì ‘ê¸°/í¼ì¹˜ê¸°" title="ê³µì§€ ì ‘ê¸°/í¼ì¹˜ê¸°">â–¾</button>
</div>

<!-- âœ… ì‚¬ì¹­ì£¼ì˜ íŒì—… (1ì¼ 1íšŒ) -->
<div class="scam-popup" id="scamPopup">
  <div class="scam-box">
    <h3>âš ï¸ ì‚¬ì¹­ ì£¼ì˜ ì•ˆë‚´</h3>
    <p>
      88 ì»¤ë®¤ë‹ˆí‹° ê³µì‹ ê´€ë¦¬ì í…”ë ˆê·¸ë¨ì€<br>
      <b>@UZU59</b> ë‹¨ í•˜ë‚˜ì…ë‹ˆë‹¤.<br><br>
      ê·¸ ì™¸ ê³„ì •ì€ ì‚¬ì¹­ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ<br>
      ë°˜ë“œì‹œ ì£¼ì˜í•´ ì£¼ì„¸ìš”.
    </p>
    <div class="btn primary" onclick="closeScam()">í™•ì¸</div>
  </div>
</div>

<!-- âœ… ë¶„ì„ê¸° ì§„ì… ê´‘ê³  íŒì—… (1ì¼ 1íšŒ) -->
<div class="ad-popup" id="adPopup">
  <div class="ad-box">
    <div class="ad-head">
      <div class="ad-title">ğŸ ì§€ê¸ˆ ë§ì´ ì°¾ëŠ” ì¶”ì²œ ë†€ì´í„°</div>
      <div class="ad-close" onclick="closeAdPopup(true)">ì˜¤ëŠ˜ ê·¸ë§Œ ë³´ê¸°</div>
    </div>

    <div class="ad-grid" id="adGrid"></div>

    <div class="ad-actions">
      <a class="btnx primary" href="/#vendorTop" aria-label="ì¸ì¦ ë†€ì´í„° ë³´ê¸°">ì¸ì¦ ë†€ì´í„° ë³´ê¸°</a>
      <a class="btnx" href="https://t.me/UZU59" target="_blank" rel="noopener">ë¬¸ì˜</a>
    </div>

    <div class="ad-note">â€» íŒì—…ì€ 1ì¼ 1íšŒë§Œ í‘œì‹œë©ë‹ˆë‹¤. (ì›ì¹˜ ì•Šìœ¼ë©´ ë‹«ê¸°)</div>
    <div class="ad-close" style="margin-top:10px;text-align:center;" onclick="closeAdPopup(false)">ë‹«ê¸°</div>
  </div>
</div>


<div class="header">
  <a class="logo-link" href="/" aria-label="í™ˆìœ¼ë¡œ ì´ë™">
    <img src="/img/logo.png" alt="88 ì»¤ë®¤ë‹ˆí‹°" class="logo-img logoImg">
  </a>
  <div class="sub">ìŠ¤í¬ì¸  ë°°ë‹¹ ë¶„ì„ê¸° (ì™„ì „ì²´ Â· í†µí•© ë§ˆì§„/EV/íˆìŠ¤í† ë¦¬ Â· íŒë‹¨ ë³´ì¡°ìš©)</div>
</div>

<div class="wrap">

  <div class="card card--hero" id="calcCard">
      <h2 class="sr-only">ìŠ¤í¬ì¸  ë°°ë‹¹ ë¶„ì„ê¸°</h2>
      <div class="calc-hero">
        <div class="calc-hero-left">
          <div class="calc-kicker">88 ì»¤ë®¤ë‹ˆí‹° Â· ë°°ë‹¹ ë¶„ì„ê¸°</div>
          <div class="calc-headline">ë§ˆì§„ Â· EV Â· ì¼ˆë¦¬ Â· ë¼ì¸ë³„ ë§ˆì§„ê¹Œì§€ <span class="accent">í•œ ë²ˆì—</span></div>
          <div class="calc-tags" aria-label="ì£¼ìš” ê¸°ëŠ¥">
            <span class="tag">ë©”ì¸/OU/í•¸ë”” í†µí•©</span>
            <span class="tag">íˆìŠ¤í† ë¦¬Â·ë¹„êµ</span>
            <span class="tag">ê³µìœ Â·ê³µìœ ì¹´ë“œ</span>
          </div>
        </div>
        <div class="calc-hero-right">
          <div class="autosave" aria-label="ìë™ ì €ì¥ ìƒíƒœ">
            <span class="autosave-label">ìë™ ì €ì¥</span>
            <span id="saveBadge" class="save-badge" aria-live="polite"></span>
          </div>
          <button class="btn secondary mini" type="button" onclick="toggleMiniGuide()">10ì´ˆ ê°€ì´ë“œ</button>
        </div>
      </div>
      <div class="calc-divider" aria-hidden="true"></div>

  <div class="controls controls-settings">
        <div class="selectWrap">
          <div class="fieldLabel"><span class="stepBubble">1</span> ì¢…ëª©</div>
          <select id="sport" class="select" onchange="onSportChange()">
          <option value="soccer">ì¶•êµ¬</option>
          <option value="basketball">ë†êµ¬</option>
          <option value="baseball">ì•¼êµ¬</option>
          <option value="volleyball">ë°°êµ¬</option>
          <option value="esports">eìŠ¤í¬ì¸ </option>
          <option value="hockey">í•˜í‚¤</option>
        </select>
        </div>
        <div class="selectWrap">
          <div class="fieldLabel"><span class="stepBubble">2</span> ë¶„ì„ ë ˆë²¨</div>
          <select id="level" class="select" onchange="onLevelChange()">
          <option value="simple">ê°„ë‹¨</option>
          <option value="mid">ì¤‘ê¸‰</option>
          <option value="adv">ê³ ê¸‰</option>
        </select>
        </div>
      </div>
      <div class="settingsHint">ğŸ‘‡ ë¨¼ì € <b>ì¢…ëª©</b>ê³¼ <b>ë ˆë²¨</b>ì„ ì„ íƒí•˜ë©´, ì•„ë˜ ì…ë ¥ í¼(ë©”ì¸/ì˜¤ë²„Â·ì–¸ë”/í•¸ë””)ì´ ìë™ìœ¼ë¡œ ìµœì í™”ë©ë‹ˆë‹¤.</div>


      <!-- âœ… íŒ€/ë¦¬ê·¸ ì…ë ¥(ì„ íƒ) -->
      <div class="row2">
        <div>
          <input id="league" class="textinput" placeholder="ë¦¬ê·¸/ëŒ€íšŒëª… (ì„ íƒ)">
          <div class="small-hint">â€» ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ë¶„ì„ ê°€ëŠ¥ / ê³µìœ  ì‹œ ì…ë ¥í•œ ë‚´ìš©ë§Œ í¬í•¨ë©ë‹ˆë‹¤.</div>
        </div>
        <div>
          <input id="teams" class="textinput" placeholder="íŒ€ëª… (ì„ íƒ) ì˜ˆ: ë§¨ì‹œí‹° vs ë¦¬ë²„í’€">
          <div class="small-hint">â€» íŒ€/ë¦¬ê·¸ëŠ” ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤.</div>
        </div>
      </div>

      <div class="small-hint" id="sportHint" style="margin-top:10px;"></div>
      <div class="quick-nav" id="quickNav">
        <button class="chip" type="button" onclick="quickJump('main')">ë©”ì¸</button>
        <button class="chip" type="button" onclick="quickJump('total')">ì˜¤ë²„Â·ì–¸ë”</button>
        <button class="chip" type="button" onclick="quickJump('handicap')">í•¸ë””ìº¡</button>
        <button class="chip" type="button" onclick="quickJump('result')">ê²°ê³¼</button>
        <button class="chip" type="button" onclick="quickJump('history')">íˆìŠ¤í† ë¦¬</button>
      </div>

      <div class="mini-guide" id="miniGuide">
        <div class="head" onclick="toggleMiniGuide()">
          <div>ğŸ’¡ ì²˜ìŒì´ë©´ <b>10ì´ˆ ê°€ì´ë“œ</b></div>
          <div class="pill" id="miniGuidePill">ì—´ê¸°</div>
        </div>
        <div class="body" id="miniGuideBody">
          1) <b>ì¢…ëª©/ëª¨ë“œ</b> ì„ íƒ â†’ 2) <b>ë©”ì¸ ë°°ë‹¹</b> ì…ë ¥(í•„ìˆ˜) â†’ 3) ì˜¤ë²„Â·ì–¸ë”/í•¸ë””(ì„ íƒ) â†’ 4) <b>ì¤‘ê¸‰/ê³ ê¸‰</b>ì´ë©´ <b>ë‚´ ì˜ˆìƒ í™•ë¥ </b> ì…ë ¥ ì‹œ EV/ì¼ˆë¦¬ê¹Œì§€ ê³„ì‚°ë©ë‹ˆë‹¤.<br>
          â€¢ ê²°ê³¼ëŠ” <b>íŒë‹¨ ë³´ì¡°ìš©</b>ì´ë©°, ë§ˆì§„ì´ ë†’ì„ìˆ˜ë¡ ì¥ê¸° ê¸°ëŒ€ê°’ì´ ë¶ˆë¦¬í•´ì§ˆ ìˆ˜ ìˆì–´ìš”.<br>
          â€¢ íˆìŠ¤í† ë¦¬ í•­ëª© í´ë¦­í•˜ë©´ <b>ì…ë ¥ ìë™ ë³µì› + ì¬ê³„ì‚°</b>ë©ë‹ˆë‹¤.
        </div>
      </div>

      <!-- âœ… ìµœê·¼ ì…ë ¥ ìŠ¤ëƒ…ìƒ·(ìµœê·¼ 5ê°œ) -->
      <div class="snap-wrap" id="snapWrap" style="display:none;">
        <div class="snap-head">
          <div>ğŸ•˜ ìµœê·¼ ì…ë ¥</div>
          <div class="snap-meta" id="snapMeta"></div>
        </div>
        <div class="snap-list" id="snapList"></div>
      </div>






      <!-- ===== í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° (ìë™ ì…ë ¥) ===== -->
      <div class="box" id="pasteBox">
        <div class="box-head">
          <div class="box-title" style="margin:0;">í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° (ìë™ ì…ë ¥)</div>
          <div class="toggle" onclick="toggleBox('pasteBody')">ì ‘ê¸°/í¼ì¹˜ê¸°</div>
        </div>
        <div id="pasteBody">
          <div class="small-hint" style="margin-top:4px;">
            ì»¤ë®¤ë‹ˆí‹° ê¸€/ë°°ë‹¹í‘œ í…ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ë©´ <b>ë©”ì¸/ì˜¤ë²„Â·ì–¸ë”/í•¸ë””</b> ë°°ë‹¹ì„ ìë™ìœ¼ë¡œ ì±„ì›Œì¤ë‹ˆë‹¤. (ì§€ì›: 2ë°°ë‹¹/3ë°°ë‹¹, ì˜¤ë²„Â·ì–¸ë”, í•¸ë””)
          </div>
          <div class="paste-area" style="margin-top:10px;">
            <textarea id="pasteInput" class="paste-ta" placeholder="ì˜ˆ) ë§¨ì‹œí‹° vs ë¦¬ë²„í’€  ìŠ¹ 1.85 ë¬´ 3.40 íŒ¨ 4.20 / ì˜¤ë²„ 2.5 1.95 ì–¸ë” 1.85 / í•¸ë”” -1.5 1.90 1.95"></textarea>
            <div class="paste-actions">
              <button class="btn primary" type="button" onclick="applyPaste(true)">ìë™ ì…ë ¥</button>
              <button class="btn secondary" type="button" onclick="applyPaste(false)">ì…ë ¥ë§Œ</button>
              <button class="btn secondary" type="button" onclick="parsePasteMulti()">ì—¬ëŸ¬ ê²½ê¸° ë§Œë“¤ê¸°</button>
              <button class="btn ghost" type="button" onclick="fillPasteExample()">ì˜ˆì‹œ</button>
              <button class="btn ghost" type="button" onclick="clearPaste()">ì§€ìš°ê¸°</button>
              <button class="btn ghost" type="button" onclick="clearPasteList()">ë¦¬ìŠ¤íŠ¸ ì§€ìš°ê¸°</button>
              <span class="paste-badge good" id="pasteBadgeOk" style="display:none;"></span>
              <span class="paste-badge warn" id="pasteBadgeWarn" style="display:none;"></span>
              <div class="paste-inline" style="margin-left:auto;">
                <label class="chk">ë©”ì¸ íƒ€ì…
                  <select id="pasteMainMode" class="paste-select" title="ë©”ì¸ ë°°ë‹¹ íƒ€ì…">
                    <option value="auto">ìë™</option>
                    <option value="2">2ë°°ë‹¹</option>
                    <option value="3">3ë°°ë‹¹</option>
                  </select>
                </label>
                <label class="chk"><input type="checkbox" id="pasteAutoLevel" checked> OU/í•¸ë”” ê°ì§€ ì‹œ ë ˆë²¨ ìë™ ì „í™˜</label>
                <label class="chk"><input type="checkbox" id="pasteChainMode" checked> í´ë¦­=ì—°ì† ì €ì¥</label>
                <label class="chk"><input type="checkbox" id="pasteSkipLow" checked> ì •í™•ë„ ë‚®ìŒ ì œì™¸</label>
              </div>
            </div>
            <div class="small-hint" id="pasteHint"></div>

            <div class="paste-list-wrap" id="pasteListWrap" style="display:none;">
              <div class="paste-list-head">
                <div class="k">ê°ì§€ëœ ê²½ê¸°</div>
                <div class="m" id="pasteListMeta"></div>
                <div class="paste-list-tools">
                  <button class="btn ghost mini" type="button" onclick="togglePasteSort()">ì •ë ¬: ë§ˆì§„ ë‚®ì€ìˆœ</button>
                  <label class="paste-mini-label">ì—°ì†
                    <input id="pasteChainCount" class="paste-num" type="number" min="1" max="30" value="10">
                    ê°œ
                  </label>
                  <button class="btn primary mini" type="button" onclick="startChainSave()">ì—°ì† ì €ì¥</button>
                  <button class="btn ghost mini" type="button" onclick="stopChainSave()" id="pasteChainStop" style="display:none;">ì¤‘ì§€</button>
                  <button class="btn secondary mini" type="button" onclick="openBundleShare()" id="btnBundleShare">ì˜¤ëŠ˜ ìˆ˜ì§‘ ë¬¶ìŒ</button>
                  <button class="btn danger mini" type="button" onclick="resetBundleToday()" title="ì˜¤ëŠ˜ ìˆ˜ì§‘ ë¬¶ìŒ(ì—°ì† ì €ì¥ìœ¼ë¡œ ëˆ„ì ëœ í•­ëª©)ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.">ì´ˆê¸°í™”</button>
                </div>
              </div>
              <div class="paste-list" id="pasteList"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== ë©”ì¸ ì‹œì¥ ===== -->
      <div class="box" id="mainBox">
        <div class="box-title" id="mainMarketTitle">ë©”ì¸ ë°°ë‹¹</div>

        <!-- 2-way -->
        <div id="main2" style="display:none;">
          <div class="grid">
            <div class="field">
              <label id="main2LabelA">ì„ íƒ A ë°°ë‹¹</label>
              <input id="main2OddsA" inputmode="decimal" placeholder="ì˜ˆ: 1.85">
            </div>
            <div class="field">
              <label id="main2LabelB">ì„ íƒ B ë°°ë‹¹</label>
              <input id="main2OddsB" inputmode="decimal" placeholder="ì˜ˆ: 2.05">
            </div>
          </div>
        </div>

        <!-- 3-way -->
        <div id="main3" style="display:none;">
          <div class="grid">
            <div class="field">
              <label id="main3LabelH">í™ˆ ë°°ë‹¹</label>
              <input id="main3OddsH" inputmode="decimal" placeholder="ì˜ˆ: 2.10">
            </div>
            <div class="field">
              <label id="main3LabelD">ë¬´ ë°°ë‹¹</label>
              <input id="main3OddsD" inputmode="decimal" placeholder="ì˜ˆ: 3.20">
            </div>
            <div class="field">
              <label id="main3LabelA">ì›ì • ë°°ë‹¹</label>
              <input id="main3OddsA" inputmode="decimal" placeholder="ì˜ˆ: 3.40">
            </div>
            <div class="field">
              <label> </label>
              <input disabled value="â€» ì¶•êµ¬ëŠ” 3ë°°ë‹¹ì´ ê¸°ë³¸ì…ë‹ˆë‹¤">
            </div>
          </div>
        </div>

        <!-- ì¤‘ê¸‰/ê³ ê¸‰: ë‚´ í™•ë¥ /ë² íŒ…ê¸ˆ -->
        <div id="valueInputs" style="display:none;">
          <div class="grid">
            <div class="field">
              <label id="myProbLabel">ë‚´ ì˜ˆìƒ í™•ë¥ (ì„ íƒ) %</label>
              <input id="myProb" inputmode="decimal" placeholder="ì˜ˆ: 55  ë˜ëŠ”  45,28,27">
              <div class="small-hint" id="myProbHint"></div>
            </div>
            <div class="field">
              <label>ë² íŒ…ê¸ˆ(ì„ íƒ)</label>
              <input id="stake" inputmode="numeric" placeholder="ì˜ˆ: 100000">
              <div class="small-hint">â€» ì…ë ¥ ì‹œ ê¸°ëŒ€ê°’(EV)ì„ ì› ë‹¨ìœ„ë¡œë„ í‘œì‹œí•©ë‹ˆë‹¤.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== ë¼ì¸ ë¹„êµ (A vs B) ===== -->
      <div class="box" id="lineCompareBox">
        <div class="box-head">
          <div class="box-title" style="margin:0;">ë¼ì¸ ë¹„êµ (A vs B)</div>
          <div class="toggle" onclick="toggleBox('lineCompareBody')">ì ‘ê¸°/í¼ì¹˜ê¸°</div>
        </div>
        <div id="lineCompareBody">
          <div class="small-hint" style="margin-top:4px;">
            ë‘ ì—…ì²´(ë˜ëŠ” ë‘ ë¼ì¸) ë°°ë‹¹ì„ ë„£ê³  <b>ë§ˆì§„/ê³µì •ë°°ë‹¹</b>ì„ ë¹„êµí•˜ì„¸ìš”. ê°™ì€ ì¡°ê±´ì´ë©´ ë§ˆì§„ì´ ë‚®ì€ ìª½ì´ ìœ ë¦¬í•œ ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤.
          </div>

          <div class="lc-grid">
            <div class="lc-col">
              <div class="lc-head">ë¼ì¸ A</div>

              <div id="lcA2" class="grid lc-fields" style="display:none;">
                <div class="field">
                  <label id="lcA2LabelA">ì„ íƒ A ë°°ë‹¹</label>
                  <input id="lcA2OddsA" inputmode="decimal" placeholder="ì˜ˆ: 1.85">
                </div>
                <div class="field">
                  <label id="lcA2LabelB">ì„ íƒ B ë°°ë‹¹</label>
                  <input id="lcA2OddsB" inputmode="decimal" placeholder="ì˜ˆ: 2.05">
                </div>
              </div>

              <div id="lcA3" class="grid lc-fields" style="display:none;">
                <div class="field">
                  <label id="lcA3LabelH">í™ˆ ë°°ë‹¹</label>
                  <input id="lcA3OddsH" inputmode="decimal" placeholder="ì˜ˆ: 2.10">
                </div>
                <div class="field">
                  <label id="lcA3LabelD">ë¬´ ë°°ë‹¹</label>
                  <input id="lcA3OddsD" inputmode="decimal" placeholder="ì˜ˆ: 3.20">
                </div>
                <div class="field">
                  <label id="lcA3LabelA">ì›ì • ë°°ë‹¹</label>
                  <input id="lcA3OddsA" inputmode="decimal" placeholder="ì˜ˆ: 3.40">
                </div>
                <div class="field">
                  <label> </label>
                  <input disabled value="(A) 3ë°°ë‹¹ ì…ë ¥">
                </div>
              </div>

              <button class="btn secondary" type="button" onclick="applyLineCompare('A')">Aë¥¼ ë©”ì¸ì— ì ìš©</button>
            </div>

            <div class="lc-col">
              <div class="lc-head">ë¼ì¸ B</div>

              <div id="lcB2" class="grid lc-fields" style="display:none;">
                <div class="field">
                  <label id="lcB2LabelA">ì„ íƒ A ë°°ë‹¹</label>
                  <input id="lcB2OddsA" inputmode="decimal" placeholder="ì˜ˆ: 1.85">
                </div>
                <div class="field">
                  <label id="lcB2LabelB">ì„ íƒ B ë°°ë‹¹</label>
                  <input id="lcB2OddsB" inputmode="decimal" placeholder="ì˜ˆ: 2.05">
                </div>
              </div>

              <div id="lcB3" class="grid lc-fields" style="display:none;">
                <div class="field">
                  <label id="lcB3LabelH">í™ˆ ë°°ë‹¹</label>
                  <input id="lcB3OddsH" inputmode="decimal" placeholder="ì˜ˆ: 2.10">
                </div>
                <div class="field">
                  <label id="lcB3LabelD">ë¬´ ë°°ë‹¹</label>
                  <input id="lcB3OddsD" inputmode="decimal" placeholder="ì˜ˆ: 3.20">
                </div>
                <div class="field">
                  <label id="lcB3LabelA">ì›ì • ë°°ë‹¹</label>
                  <input id="lcB3OddsA" inputmode="decimal" placeholder="ì˜ˆ: 3.40">
                </div>
                <div class="field">
                  <label> </label>
                  <input disabled value="(B) 3ë°°ë‹¹ ì…ë ¥">
                </div>
              </div>

              <button class="btn secondary" type="button" onclick="applyLineCompare('B')">Bë¥¼ ë©”ì¸ì— ì ìš©</button>
            </div>
          </div>

          <div id="lineCompareOut" class="lc-out" style="display:none;"></div>

          <div class="actionRow" style="margin-top:10px;">
            <button class="btn" type="button" onclick="runLineCompare()">ë¹„êµ ê³„ì‚°</button>
            <button class="btn ghost" type="button" onclick="prefillLineCompare()">í˜„ì¬ ë©”ì¸ê°’ìœ¼ë¡œ ì±„ìš°ê¸°</button>
          </div>
        </div>
      </div>

      <!-- ===== í•¸ë””ìº¡ (ì •ë°€: ì–‘ìª½ ë°°ë‹¹) ===== -->
      <div class="box" id="handicapBox" style="display:none;">
        <div class="box-head">
          <div class="box-title" style="margin:0;">í•¸ë””ìº¡ (ì„ íƒ Â· ì •ë°€ ë§ˆì§„)</div>
          <div class="toggle" onclick="toggleBox('handicapBody')">ì ‘ê¸°/í¼ì¹˜ê¸°</div>
        </div>
        <div id="handicapBody">
          <div class="grid">
            <div class="field">
              <label id="handicapLineLabel">í•¸ë”” ë¼ì¸ (ì˜ˆ: -1.5, +3.5)</label>
              <input id="handicapLine" inputmode="decimal" placeholder="ì˜ˆ: -1.5">
            </div>
            <div class="field">
              <label id="handicapOddsALabel">í•¸ë”” ì„ íƒA ë°°ë‹¹</label>
              <input id="handicapOddsA" inputmode="decimal" placeholder="ì˜ˆ: 1.90">
            </div>
            <div class="field">
              <label id="handicapOddsBLabel">ë°˜ëŒ€(ì„ íƒB) ë°°ë‹¹</label>
              <input id="handicapOddsB" inputmode="decimal" placeholder="ì˜ˆ: 1.95">
            </div>
            <div class="field">
              <label>ì•„ì‹œì•ˆ(í‘¸ì‹œ) ê·¼ì‚¬(ì„ íƒ)</label>
              <input id="handicapPush" inputmode="decimal" placeholder="í‘¸ì‹œ í™•ë¥  % (ì˜ˆ: 2)">
            </div>
          </div>
          <div class="small-hint">
            â€» â€œì–‘ìª½ ë°°ë‹¹â€ì´ ìˆì–´ì•¼ í•¸ë”” ë§ˆì§„ì„ ì •ë°€ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ë‹¨ì¼ ë°°ë‹¹ë§Œ ìˆìœ¼ë©´ ì°¸ê³  ìˆ˜ì¤€)
          </div>
        </div>
      </div>

      <!-- ===== ì˜¤ë²„ì–¸ë” ===== -->
      <div class="box" id="totalBox" style="display:none;">
        <div class="box-head">
          <div class="box-title" style="margin:0;">ì˜¤ë²„/ì–¸ë” (ì„ íƒ Â· ì•„ì‹œì•ˆ ê·¼ì‚¬ ì§€ì›)</div>
          <div class="toggle" onclick="toggleBox('totalBody')">ì ‘ê¸°/í¼ì¹˜ê¸°</div>
        </div>
        <div id="totalBody">
          <div class="grid">
            <div class="field">
              <label>ê¸°ì¤€ì  (ì˜ˆ: 2.5, 7.5, 2.0)</label>
              <input id="totalLine" inputmode="decimal" placeholder="ì˜ˆ: 2.5">
            </div>
            <div class="field">
              <label>ì˜¤ë²„ ë°°ë‹¹</label>
              <input id="overOdds" inputmode="decimal" placeholder="ì˜ˆ: 1.95">
            </div>
            <div class="field">
              <label>ì–¸ë” ë°°ë‹¹</label>
              <input id="underOdds" inputmode="decimal" placeholder="ì˜ˆ: 1.85">
            </div>
            <div class="field">
              <label>ì•„ì‹œì•ˆ(í‘¸ì‹œ) ê·¼ì‚¬(ì„ íƒ)</label>
              <input id="ouPush" inputmode="decimal" placeholder="í‘¸ì‹œ í™•ë¥  % (ì˜ˆ: 6)">
            </div>
            <div class="field">
              <label>ë‚´ ì˜ˆìƒ í™•ë¥ (ì˜¤ë²„) % (ê³ ê¸‰)</label>
              <input id="myOverProb" inputmode="decimal" placeholder="ì˜ˆ: 52">
            </div>
            <div class="field">
              <label> </label>
              <input disabled value="â€» í‘¸ì‹œ í™•ë¥  ë¯¸ì…ë ¥ ì‹œ ì¢…ëª© ê¸°ë³¸ê°’ìœ¼ë¡œ ê·¼ì‚¬í•©ë‹ˆë‹¤">
            </div>
          </div>
          <div class="small-hint">â€» ê³ ê¸‰ì—ì„œ ë‚´ ì˜ˆìƒ í™•ë¥ (ì˜¤ë²„)ì„ ë„£ìœ¼ë©´ ì˜¤ë²„ EV/ë¹„ì¤‘ ê³„ì‚°ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        </div>
      </div>


      <div class="input-warn" id="inputWarn" aria-live="polite"></div>

      <div class="actions">
        <button class="btn primary" id="btnCalc" onclick="calc()">ê³„ì‚°í•˜ê¸°</button>
        <button class="btn secondary" onclick="resetAll()">ì´ˆê¸°í™”</button>
      </div>

      <div class="note">
        â€» ë³¸ ë„êµ¬ëŠ” â€œíŒë‹¨ ë³´ì¡°ìš©â€ì…ë‹ˆë‹¤. ìŠ¹ë¥ ì„ ë³´ì¥í•˜ì§€ ì•Šìœ¼ë©°, ì†ì‹¤ì„ ê°ë‹¹ ê°€ëŠ¥í•œ ë²”ìœ„ ë‚´ì—ì„œ ì´ìš©í•˜ì„¸ìš”.
      </div>

      <!-- âœ… í†µí•© ë§ˆì§„ ëŒ€ì‹œë³´ë“œ -->
      <div class="box" style="margin-top:12px;">
        <div class="box-title">í†µí•© ë§ˆì§„ ëŒ€ì‹œë³´ë“œ (ë©”ì¸/OU/í•¸ë””)</div>
        <div class="m-grid" id="marginDash">
          <!-- JS ë Œë” -->
        </div>
        <div class="small-hint" style="margin-top:10px;">
          â€» ìƒ‰ìƒ: <span class="good">ë‚®ìŒ</span> / <span class="mid">ë³´í†µÂ·ì£¼ì˜</span> / <span class="warn">ê³ ë§ˆì§„</span>
        </div>
      </div>

      <div class="result" id="result" style="display:none;"></div>

      <div class="result-dock" id="resultDock" style="display:none;" aria-label="ì €ì¥/ê³µìœ /ì—…ì²´ ë°”ë¡œê°€ê¸°">
        <button class="btn secondary" type="button" onclick="quickJump('history')">ì €ì¥ë¨ Â· íˆìŠ¤í† ë¦¬</button>
        <button class="btn gold" type="button" onclick="openShareCard()">ê³µìœ </button>
        <a class="btn secondary" href="/#vendorTop" data-cta="analysis_to_vendors" data-no-auto-outbound="1">ì—…ì²´ ì¹´ë“œ</a>
      </div>

      <div class="footer-links">
        <a class="linkbtn" href="/">í™ˆìœ¼ë¡œ</a>
        <a class="linkbtn" href="https://t.me/UZU59" target="_blank" rel="noopener">ë¬¸ì˜ (í…”ë ˆê·¸ë¨)</a>
      </div>
    </div>

  <!-- âœ… TOP3 + ê¸°ì¤€/ì˜ˆì‹œ (ë°˜ë°˜) -->
  <div class="card" id="topInfoCard">
    <h2 class="sr-only">ì˜¤ëŠ˜ ë§ˆì§„ ë‚®ì€ TOP3 ë° ë§ˆì§„ ê¸°ì¤€</h2>
    <div class="split">
      <section class="split-col" aria-label="ì˜¤ëŠ˜ ë§ˆì§„ ë‚®ì€ ê³„ì‚° TOP3">
        <div class="subhead"><span class="mini-badge">TOP3</span>ì˜¤ëŠ˜ ë§ˆì§„ ë‚®ì€ ê³„ì‚° TOP3</div>
<div class="small-hint">â€» ì˜¤ëŠ˜ ì €ì¥ëœ íˆìŠ¤í† ë¦¬ì—ì„œ â€œë§ˆì§„%â€ê°€ ê°€ì¥ ë‚®ì€ ìˆœìœ¼ë¡œ ìë™ ì •ë ¬ë©ë‹ˆë‹¤.</div>
    <div class="box" style="margin-top:10px;">
      <div class="box-title">ë©”ì¸ ë§ˆì§„ TOP3</div>
      <div id="topMain" class="small-hint"></div>
    </div>
    <div class="box">
      <div class="box-title">ì˜¤ë²„/ì–¸ë” ë§ˆì§„ TOP3</div>
      <div id="topOU" class="small-hint"></div>
    </div>
    <div class="box">
      <div class="box-title">í•¸ë””ìº¡ ë§ˆì§„ TOP3</div>
      <div id="topHC" class="small-hint"></div>
    </div>
      </section>

      <section class="split-col" aria-label="ë§ˆì§„ ë‚®ì€ ê²½ê¸° ê¸°ì¤€ê³¼ ì˜ˆì‹œ">
        <div class="subhead"><span class="mini-badge">INFO</span>â€œë§ˆì§„ ë‚®ì€ ê²½ê¸°â€ ê¸°ì¤€ & ì˜ˆì‹œ</div>
<div class="note" style="margin-top:0;">
      â€¢ ë§ˆì§„(ìˆ˜ìˆ˜ë£Œ)ì€ <b>ì˜¤ë²„ë¼ìš´ë“œ-1</b>ì„ %ë¡œ í‘œí˜„í•œ ê°’ì…ë‹ˆë‹¤.<br>
      â€¢ ì¢…ëª©/ìœ í˜•ë³„ë¡œ ì¼ë°˜ì ì¸ ë§ˆì§„ ë²”ìœ„ê°€ ë‹¬ë¼ì„œ, ì´ í˜ì´ì§€ëŠ” <b>ì¢…ëª©+ìœ í˜•ë³„ ê¸°ì¤€</b>ìœ¼ë¡œ â€œë‚®ìŒ/ë³´í†µ/ì£¼ì˜/ê³ ë§ˆì§„â€ì„ íŒì •í•©ë‹ˆë‹¤.<br>
      â€¢ ì•„ë˜ ê¸°ì¤€ì€ â€œëŒ€ëµì ì¸ ì²´ê°â€ì„ ë¹ ë¥´ê²Œ ë•ê¸° ìœ„í•œ ìš©ë„ì´ë©°, ì‹¤ì œ ë¼ì¸/ì—…ì²´/ì‹œì¥ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆì–´ìš”.
    </div>
    <div class="box" style="margin-top:10px;">
      <div class="box-title">ì˜ˆì‹œ (ì¶•êµ¬ 1X2)</div>
      <div class="small-hint">
        ë°°ë‹¹: <b>1.70 / 3.20 / 3.40</b> â†’ ì˜¤ë²„ë¼ìš´ë“œê°€ ì»¤ì ¸ <b>ê³ ë§ˆì§„</b>ìœ¼ë¡œ ëœ° ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
        ë°˜ëŒ€ë¡œ ë™ì¼ ì‹œì¥ì—ì„œ ì˜¤ë²„ë¼ìš´ë“œê°€ 1.05 ê·¼ì²˜ë©´ ëŒ€ì²´ë¡œ <b>ë§ˆì§„ ë‚®ìŒ</b>ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
      </div>
    </div>
      </section>
    </div>
  </div>

  <div class="card" id="historyCard">
      <h2 class="sr-only">ìµœê·¼ ê³„ì‚° íˆìŠ¤í† ë¦¬</h2>

  <div class="small-hint">
        â€¢ íˆìŠ¤í† ë¦¬ í•­ëª© í´ë¦­ â†’ <b>ì…ë ¥ ìë™ ë³µì› + ì¦‰ì‹œ ì¬ê³„ì‚°</b><br>
        â€¢ ì²´í¬ 2ê°œ ì„ íƒ â†’ <b>ë¹„êµ(2ê°œ ë‚˜ë€íˆ)</b> ê°€ëŠ¥
      </div>
      <div class="history-actions">
        <div class="history-toolbar">
          <button class="btn secondary danger" type="button" id="btnDeleteSelected" onclick="deleteSelected()" disabled>ì„ íƒ ì‚­ì œ</button>
          <button class="btn secondary" type="button" onclick="clearHistory()">ì „ì²´ ì‚­ì œ</button>
          <button class="btn secondary" type="button" id="btnCompare" onclick="openCompare()" disabled>ë¹„êµ</button>
          <button class="btn secondary" type="button" onclick="renderTop3()">TOP3</button>
        </div>

        <div class="history-filters" aria-label="íˆìŠ¤í† ë¦¬ í•„í„°">
          <button class="seg on" type="button" data-filter="all" onclick="setHistoryFilter('all', this)">ì „ì²´</button>
          <button class="seg" type="button" data-filter="rec" onclick="setHistoryFilter('rec', this)">ì¶”ì²œ</button>
          <button class="seg" type="button" data-filter="untracked" onclick="setHistoryFilter('untracked', this)">ë¯¸ê¸°ë¡</button>
          <div class="pick-ind">ì„ íƒ <b id="pickCount">0</b></div>
        </div>
      </div>
  <div class="perf-box" id="perfBox" style="display:none;">
        <div class="perf-title">
          <div>ğŸ“Š ë‚´ ì„±ê³¼</div>
          <div class="snap-meta" id="perfMeta"></div>
        </div>
        <div class="perf-sub" id="perfSub"></div>
        <div class="perf-grid" id="perfGrid"></div>
      </div>

      <div class="h-list" id="historyList"></div>
    </div>
</div>

<!-- ë¹„êµ ëª¨ë‹¬ -->
<div class="modal" id="compareModal">
  <div class="modal-box">
    <div class="modal-head">
      <div class="t">ë¹„êµ (2ê°œ ë‚˜ë€íˆ)</div>
      <div class="modal-close" onclick="closeCompare()">ë‹«ê¸°</div>
    </div>
    <div class="small-hint" style="margin-bottom:10px;">
      íˆìŠ¤í† ë¦¬ì—ì„œ ì²´í¬ë°•ìŠ¤ë¡œ 2ê°œ ì„ íƒ í›„ â€œë¹„êµ ì—´ê¸°â€ë¥¼ ëˆ„ë¥´ì„¸ìš”.
    </div>
    <div class="compare-grid" id="compareGrid"></div>
  </div>
</div>


<!-- ê³µìœ  ì¹´ë“œ ëª¨ë‹¬ (ì´ë¯¸ì§€ ì €ì¥) -->
<div class="modal" id="shareCardModal" style="display:none;">
  <div class="modal-box share">
    <div class="modal-head">
      <div class="t">ê³µìœ  ì¹´ë“œ (ì´ë¯¸ì§€ ì €ì¥)</div>
      <div class="modal-close" onclick="closeShareCard()">ë‹«ê¸°</div>
    </div>
    <div class="small-hint" style="margin-bottom:10px;">
      ê²°ê³¼ê°€ ìƒì„±ëœ ìƒíƒœì—ì„œë§Œ ì¹´ë“œê°€ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤. (í…ìŠ¤íŠ¸/ë§í¬ë„ í•¨ê»˜ ë³µì‚¬ ê°€ëŠ¥)
    </div>
    <div class="share-canvas-wrap">
      <canvas id="shareCardCanvas" class="share-canvas" width="1080" height="1080" aria-label="ê³µìœ  ì¹´ë“œ ìº”ë²„ìŠ¤"></canvas>
    </div>
    <div class="history-toolbar" style="margin-top:12px;">
      <button class="btn secondary" type="button" onclick="copyShareLink()">ë§í¬ ë³µì‚¬</button>
      <button class="btn gold" type="button" onclick="downloadShareCard()">ì´ë¯¸ì§€ ì €ì¥</button>
      <button class="btn secondary" type="button" onclick="copyShareText()">ë¬¸êµ¬ ë³µì‚¬</button>
    </div>
  </div>
</div>

<!-- ì˜¤ëŠ˜ ìˆ˜ì§‘ ë¬¶ìŒ ê³µìœ  ëª¨ë‹¬ (ì—°ì† ì €ì¥/í´ë¦­ ì €ì¥ ê²°ê³¼ ë¬¶ìŒ) -->
<div class="modal" id="bundleShareModal" style="display:none;">
  <div class="modal-box share">
    <div class="modal-head">
      <div class="t" id="bundleTitle">ì˜¤ëŠ˜ ìˆ˜ì§‘ ë¬¶ìŒ</div>
      <div class="modal-close" onclick="closeBundleShare()">ë‹«ê¸°</div>
    </div>
    <div class="small-hint" style="margin-bottom:10px;">
      ì—°ì† ì €ì¥(ë˜ëŠ” í´ë¦­=ì—°ì† ì €ì¥)ìœ¼ë¡œ ëª¨ì€ í•­ëª©ì„ <b>í•œ ë²ˆì— ê³µìœ </b>í•©ë‹ˆë‹¤. (ê° í•­ëª© ë§í¬ëŠ” ì—´ë©´ ë™ì¼ ê²°ê³¼ë¡œ ë³µì›ë©ë‹ˆë‹¤)
    </div>
    <div class="bundle-meta" id="bundleMeta"></div>
    <div class="share-canvas-wrap">
      <canvas id="bundleCanvas" class="share-canvas" width="1080" height="1080" aria-label="ì˜¤ëŠ˜ ìˆ˜ì§‘ ë¬¶ìŒ ê³µìœ  ì¹´ë“œ"></canvas>
    </div>
    <textarea id="bundleText" class="bundle-ta" readonly></textarea>
<div class="bundle-promo">
  <div class="bundle-promo-head">
    <div class="bundle-promo-title">í™ë³´ê¸€ ìë™ ìƒì„±</div>
    <div class="bundle-promo-ctrl">
      <select id="bundlePromoChannel" class="inp mini" aria-label="í™ë³´ ì±„ë„ ì„ íƒ"></select>
      <select id="bundlePromoStyle" class="inp mini" aria-label="í™ë³´ í†¤ ì„ íƒ">
        <option value="promo">í™ë³´í˜•</option>
        <option value="info">ì •ë³´í˜•</option>
        <option value="tg">í…”ë ˆê·¸ë¨í˜•</option>
      </select>
      <select id="bundlePromoLinks" class="inp mini" aria-label="ë§í¬ ë²”ìœ„ ì„ íƒ">
        <option value="top3">ë§í¬ TOP3(ê¶Œì¥)</option>
        <option value="top5">ë§í¬ TOP5</option>
        <option value="all">ë§í¬ ì „ì²´</option>
        <option value="one">ë§í¬ 1ê°œë§Œ</option>
        <option value="none">ë§í¬ 0ê°œ</option>
      </select>
      <select id="bundlePromoOneTarget" class="inp mini" aria-label="ë§í¬ 1ê°œ ëŒ€ìƒ" style="display:none;">
        <option value="analysis">ë¶„ì„ê¸° ë§í¬</option>
        <option value="vendor">ì—…ì²´ ì¹´ë“œ ë§í¬</option>
      </select>
      <label class="bundle-switch" title="UTMì„ ì œê±°í•˜ê³  https://ë¥¼ ìƒëµí•´ URLì„ ì§§ê²Œ í‘œì‹œí•©ë‹ˆë‹¤. (ì¶”ì  ì •í™•ë„ëŠ” ë‚®ì•„ì§ˆ ìˆ˜ ìˆì–´ìš”)">
        <input type="checkbox" id="bundlePromoShortUrl">
        <span>URL ì¤„ì´ê¸°</span>
      </label>
      <label class="bundle-switch" title="ì¤„ë°”ê¿ˆì„ ìµœì†Œí™”í•´ ê²Œì‹œíŒ ê·œì¹™/í•„í„°ì— ë” ì˜ ë§ê²Œ ë§Œë“­ë‹ˆë‹¤.">
        <input type="checkbox" id="bundlePromoCompact">
        <span>ì¤„ë°”ê¿ˆ ìµœì†Œ</span>
      </label>
      <label class="bundle-switch" title="ë§ˆì§„ ë‚®ìŒ ë˜ëŠ” +EV ì¡°ê±´ì„ ë§Œì¡±í•  ë•Œë§Œ ì—…ì²´ í‹°ì € 1ê°œë¥¼ í¬í•¨í•©ë‹ˆë‹¤.">
        <input type="checkbox" id="bundlePromoVendor" checked>
        <span>ì—…ì²´ 1ê°œ(ì¡°ê±´ë¶€)</span>
      </label>
      <button class="btn ghost mini" type="button" onclick="regenBundlePromo()" title="ë¬¸êµ¬ ë³€í˜•(3ì¢…) ì¤‘ ë‹¤ìŒ í…œí”Œë¦¿ìœ¼ë¡œ ë°”ê¿‰ë‹ˆë‹¤">ìƒˆ ë¬¸êµ¬</button>
    </div>
  </div>
  <div class="small-hint" style="margin-top:8px;">
    ì±„ë„/í†¤/ì˜µì…˜ì„ ë°”ê¾¸ë©´ í™ë³´ ë¬¸êµ¬ê°€ ìë™ ìƒì„±ë©ë‹ˆë‹¤. (ê²Œì‹œíŒ ê·œì¹™ì— ë§ì¶° ë§í¬ 0~ì „ì²´/URL ì§§ê²Œ/ì¤„ë°”ê¿ˆ ìµœì†Œë¥¼ ì„ íƒ ê°€ëŠ¥)
  </div>
  <textarea id="bundlePromoText" class="bundle-ta bundle-ta--promo" readonly></textarea>
  <div class="history-toolbar" style="margin-top:10px;">
    <button class="btn secondary" type="button" onclick="copyBundlePromo()">í™ë³´ê¸€ ë³µì‚¬</button>
    <button class="btn ghost" type="button" onclick="copyBundlePromoTitle()">ì œëª© ë³µì‚¬</button>
    <button class="btn ghost" type="button" onclick="copyBundlePromoLead()">ë§ë¨¸ë¦¬ ë³µì‚¬</button>
  </div>
</div>
    <div class="history-toolbar" style="margin-top:12px;">
      <button class="btn secondary" type="button" onclick="copyBundleText()">ë¬¸êµ¬ ë³µì‚¬</button>
      <button class="btn secondary" type="button" onclick="copyBundleLinks()">ë§í¬ë§Œ ë³µì‚¬</button>
      <button class="btn ghost" type="button" onclick="copyBundleTop3()">TOP3 ìš”ì•½ ë³µì‚¬</button>
      <button class="btn gold" type="button" onclick="downloadBundleCard()">ì´ë¯¸ì§€ ì €ì¥</button>
      <button class="btn danger" type="button" onclick="resetBundleToday()">ì˜¤ëŠ˜ ë¬¶ìŒ ì´ˆê¸°í™”</button>
    </div>
  </div>
</div>

<!-- ëª¨ë°”ì¼ í•˜ë‹¨ ë„í¬ -->
<div class="mobile-dock" id="mobileDock" aria-label="ë¹ ë¥¸ ë™ì‘">
  <button class="dock-btn primary" type="button" onclick="calc()">ê³„ì‚°</button>
  <button class="dock-btn" type="button" onclick="quickJump('history')">ì €ì¥</button>
  <button class="dock-btn" type="button" onclick="openShareCard()">ê³µìœ </button>
  <a class="dock-btn" href="/#vendorTop" data-cta="analysis_dock_vendors" data-no-auto-outbound="1">ì—…ì²´</a>
</div>

<div id="toast88"></div>

<script>
/* =========================
   ê³µì§€/ì‚¬ì¹­ì£¼ì˜
========================= */
const NOTICE_LIST = [
  "ğŸ”” 88 ì»¤ë®¤ë‹ˆí‹° ê³µì‹ ì•ˆë‚´ Â· ê´€ë¦¬ì ì‚¬ì¹­ ì£¼ì˜ (@UZU59)",
  "ğŸ“Š ë¶„ì„ê¸°: ìŠ¹ë¦¬ í™•ë¥ (ë°°ë‹¹ ê¸°ë°˜Â·ì¶”ì •) / ë§ˆì§„ / EV / Kellyê¹Œì§€",
  "â­ íˆìŠ¤í† ë¦¬ ì €ì¥ + TOP3 ìë™ ë…¸ì¶œ",
  "âš ï¸ ë³¸ í˜ì´ì§€ëŠ” íŒë‹¨ ë³´ì¡°ìš©ì´ë©° ê²°ê³¼ë¥¼ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
];
let noticeIndex = 0;
function rotateNotice(){
  const el = document.getElementById("noticeText");
  if(!el) return;
  el.innerText = NOTICE_LIST[noticeIndex];
  const mini = document.getElementById("noticeMiniText");
  if(mini) mini.innerText = "ì‚¬ì¹­ ì£¼ì˜ Â· @UZU59";
  noticeIndex = (noticeIndex + 1) % NOTICE_LIST.length;
}
rotateNotice();
setInterval(rotateNotice, 4000);

/* ê³µì§€ ë°°ë„ˆ: ìŠ¤í¬ë¡¤ ì‹œ ìë™ìœ¼ë¡œ ìŠ¬ë¦¼í•˜ê²Œ(ê°€ì‹œì„± + ì²« í™”ë©´ í™•ë³´) */
(function initNoticeBar(){
  const bar = document.getElementById("noticeBar");
  const tgl = document.getElementById("noticeToggle");
  if(!bar || !tgl) return;

  let manual = null; // null=ìë™, true=ì ‘í˜, false=í¼ì¹¨

  const apply = (collapsed)=>{
    bar.classList.toggle("is-collapsed", collapsed);
    tgl.innerText = collapsed ? "â–¾" : "â–´";
    tgl.setAttribute("aria-label", collapsed ? "ê³µì§€ í¼ì¹˜ê¸°" : "ê³µì§€ ì ‘ê¸°");
  };

  const onScroll = ()=>{
    if(manual !== null) return;
    const y = window.scrollY || document.documentElement.scrollTop || 0;
    apply(y > 18);
  };

  window.addEventListener("scroll", onScroll, {passive:true});
  onScroll();

  tgl.addEventListener("click", (e)=>{
    e.preventDefault();
    e.stopPropagation();
    const now = bar.classList.contains("is-collapsed");
    manual = !now; // ì‚¬ìš©ìê°€ ì„ íƒí•œ ìƒíƒœë¡œ ê³ ì •
    apply(!now);
  });
})();


/* ì‚¬ì¹­ì£¼ì˜ (1ì¼ 1íšŒ) */
(function(){
  const key="scam_popup_date";
  const today=new Date().toISOString().slice(0,10);
  if(localStorage.getItem(key)!==today){
    const pop=document.getElementById("scamPopup");
    if(pop) pop.style.display="flex";
  }
})();
function closeScam(){
  const today=new Date().toISOString().slice(0,10);
  localStorage.setItem("scam_popup_date",today);
  const pop=document.getElementById("scamPopup");
  if(pop) pop.style.display="none";
}

/* ìŠ¤í¬ë¡¤ */
function scrollToCalc(){
  document.getElementById("calcCard")?.scrollIntoView({behavior:"smooth", block:"start"});
}

/* =========================
   ì²´í¬ë¦¬ìŠ¤íŠ¸
========================= */
const CHECKLIST_POOL = [
  "ë¼ì¸ ê¸‰ë³€ ê²½ê¸°(ê°‘ìê¸° ë‚´ë ¤ê°„ ë°°ë‹¹)ëŠ” ì´ìœ ë¶€í„° í™•ì¸í•˜ê¸°",
  "ë§ˆì§„(ìˆ˜ìˆ˜ë£Œ) ë†’ì€ ê²½ê¸°ë©´ í•œ ë‹¨ê³„ ë³´ìˆ˜ì ìœ¼ë¡œ ì ‘ê·¼í•˜ê¸°",
  "1íšŒ ë°°íŒ…ê¸ˆì€ ìë³¸ì˜ 1~3% ë²”ìœ„ë¡œ ì œí•œí•˜ê¸°",
  "ì„ ë°œ/ê²°ì¥/ë¡œí…Œ ë‰´ìŠ¤ ì²´í¬ í›„ ë°°ë‹¹ ë³€ë™ ì¬í™•ì¸í•˜ê¸°",
  "ì—°íŒ¨/ì—°ìŠ¹ íŒ€ì€ 'ì‹œì¥ ê³¼ì—´' êµ¬ê°„ì¸ì§€ ë¨¼ì € ë³´ê¸°",
  "ë³€ë™ì„± í° ë¦¬ê·¸ëŠ” ë‹¨í´/ì†Œì•¡ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ê¸°",
  "ì•„ì‹œì•ˆ ë¼ì¸(í‘¸ì‹œ) ê°€ëŠ¥ êµ¬ê°„ì€ 'ë¬´íš¨ ë¦¬ìŠ¤í¬'ë„ ê°™ì´ ê³ ë ¤í•˜ê¸°"
];
function refreshChecklist(){
  const pool = [...CHECKLIST_POOL].sort(()=>Math.random()-0.5);
  const pick = pool.slice(0,3);
  const el = document.getElementById("checklistText");
  if(el) el.innerHTML = "â€¢ " + pick.join("<br>â€¢ ");
}
refreshChecklist();

/* =========================
   ìƒíƒœ/ì €ì¥(ê¸°ì¡´ ìœ ì§€ + í™•ì¥)
========================= */
const LS_KEY = "88_analysis_multi_v3";            // ì…ë ¥ ìƒíƒœ
const HIST_KEY = "88_analysis_history_v1";        // íˆìŠ¤í† ë¦¬
const SNAP_KEY = "88_analysis_snaps_v1";          // ìµœê·¼ ì…ë ¥ ìŠ¤ëƒ…ìƒ·
const SNAP_META_KEY = "88_analysis_snaps_meta_v1";
let LAST_TEXT = "";
let LAST_ONE_LINE = "";      // ê³µìœ ìš© í•œ ì¤„ ìš”ì•½
let LAST_RECORD = null;

let MAIN_MODE_OVERRIDE = null; // "2way" | "3way" | null

// ë©€í‹° ë¶™ì—¬ë„£ê¸°: ì—°ì† ì €ì¥(íˆìŠ¤í† ë¦¬ ìë™ ëˆ„ì )ìš© ìƒíƒœ
let __PASTE_MULTI = [];
let __PASTE_SORT = "input"; // "margin" | "input"
let __PASTE_CHAIN_RUNNING = false;
let __PASTE_CHAIN_ABORT = false;
let __PASTE_SAVED_SIGS = new Set();

// ===== ì˜¤ëŠ˜ ìˆ˜ì§‘(ì—°ì† ì €ì¥) ë¬¶ìŒ ì €ì¥ì†Œ (ì„œë²„ ì—†ì´, localStorage) =====
const CHAIN_PACK_PREFIX = "88_chain_pack_"; // date(YYYY-MM-DD)ë³„
function chainPackKey(dateStr){ return CHAIN_PACK_PREFIX + (dateStr || todayStr()); }
function readChainPack(dateStr){
  try{
    const raw = localStorage.getItem(chainPackKey(dateStr));
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}
function writeChainPack(dateStr, arr){
  try{ localStorage.setItem(chainPackKey(dateStr), JSON.stringify((arr||[]).slice(0,80))); }catch(e){}
}
function pushChainPackFromRecord(record){
  if(!record) return;
  const dateStr = record.date || todayStr();
  const items = readChainPack(dateStr);
  let link = "";
  try{ link = getShareLink(); }catch(e){ link = location.origin + location.pathname; }
  const oneLine = String(LAST_ONE_LINE||"").replace(/^ìš”ì•½\s*:\s*/," ").trim();
  const item = {
    ts: Date.now(),
    id: record.id || null,
    sig: record.sig || null,
    date: dateStr,
    time: record.time || null,
    sport: record.sport || null,
    league: record.league || "",
    teams: record.teams || "",
    mainMode: record.mainMode || null,
    mainMarginPct: (record.markets && record.markets.main && typeof record.markets.main.marginPct==="number") ? record.markets.main.marginPct : null,
    bestEVPct: (typeof record.bestEVPct==="number") ? record.bestEVPct : null,
    oneLine,
    link
  };
  const next = [item, ...items.filter(x=> (x && (x.sig && item.sig) ? x.sig!==item.sig : x.link!==item.link))];
  writeChainPack(dateStr, next);
  try{ updateBundleButton(); }catch(e){}
}
function getChainPackCountToday(){
  try{ return readChainPack(todayStr()).length; }catch(e){ return 0; }
}
function updateBundleButton(){
  const btn = document.getElementById("btnBundleShare");
  if(!btn) return;
  const n = getChainPackCountToday();
  btn.textContent = n>0 ? `ì˜¤ëŠ˜ ìˆ˜ì§‘ ë¬¶ìŒ (${Math.min(80,n)})` : "ì˜¤ëŠ˜ ìˆ˜ì§‘ ë¬¶ìŒ";
}

const SPORT_CFG = {
  soccer: {
    name: "ì¶•êµ¬",
    main: "3way",
    labels: {H:"í™ˆ", D:"ë¬´", A:"ì›ì •"},
    hint: "ì¶•êµ¬ëŠ” ê¸°ë³¸ 3ë°°ë‹¹(í™ˆ/ë¬´/ì›ì •). ì¤‘ê¸‰/ê³ ê¸‰ì—ì„œ ì˜¤ë²„ì–¸ë”ë¥¼ ê°™ì´ ë³´ëŠ” ê±¸ ì¶”ì²œí•©ë‹ˆë‹¤.",
    template: { openHandicap:false, openTotal:true },
    defaults: { ouPush: 6, hcPush: 2 }
  },
  basketball: {
    name:"ë†êµ¬",
    main:"2way",
    labels:{A:"ìŠ¹", B:"íŒ¨"},
    hint:"ë†êµ¬ëŠ” 2ë°°ë‹¹(ìŠ¹/íŒ¨) ì¤‘ì‹¬. ì¤‘ê¸‰/ê³ ê¸‰ì—ì„œëŠ” í•¸ë””+ì˜¤ë²„ì–¸ë”ë¥¼ í•¨ê»˜ ì¶”ì²œ.",
    template: { openHandicap:true, openTotal:true },
    defaults: { ouPush: 3, hcPush: 3 }
  },
  baseball: {
    name:"ì•¼êµ¬",
    main:"2way",
    labels:{A:"ìŠ¹", B:"íŒ¨"},
    hint:"ì•¼êµ¬ëŠ” ìŠ¹/íŒ¨(2ë°°ë‹¹) + ì˜¤ë²„ì–¸ë”/í•¸ë””(ëŸ°ë¼ì¸)ë¥¼ í•¨ê»˜ ë³´ëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤.",
    template: { openHandicap:true, openTotal:true },
    defaults: { ouPush: 4, hcPush: 2 }
  },
  volleyball: {
    name:"ë°°êµ¬",
    main:"2way",
    labels:{A:"ìŠ¹", B:"íŒ¨"},
    hint:"ë°°êµ¬ëŠ” 2ë°°ë‹¹(ìŠ¹/íŒ¨) ì¤‘ì‹¬. ì¤‘ê¸‰/ê³ ê¸‰ì—ì„œ í•¸ë””/OUë¥¼ í•¨ê»˜ í™•ì¸í•˜ì„¸ìš”.",
    template: { openHandicap:true, openTotal:true },
    defaults: { ouPush: 1, hcPush: 1 }
  },
  esports: {
    name:"eìŠ¤í¬ì¸ ",
    main:"2way",
    labels:{A:"ìŠ¹", B:"íŒ¨"},
    hint:"eìŠ¤í¬ì¸ ëŠ” ë§¤ì¹˜ ìŠ¹/íŒ¨(2ë°°ë‹¹) ì¤‘ì‹¬. ê³ ê¸‰ì—ì„œ EV/ë¹„ì¤‘ ê³„ì‚°ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.",
    template: { openHandicap:false, openTotal:false },
    defaults: { ouPush: 0, hcPush: 0 }
  },
  hockey: {
    name:"í•˜í‚¤",
    main:"2way",
    labels:{A:"ìŠ¹", B:"íŒ¨"},
    hint:"í•˜í‚¤ëŠ” 2ë°°ë‹¹(ìŠ¹/íŒ¨) ê¸°ë³¸. ì¤‘ê¸‰/ê³ ê¸‰ì—ì„œ ì˜¤ë²„ì–¸ë”ê°€ ë„ì›€ì´ ë©ë‹ˆë‹¤.",
    template: { openHandicap:false, openTotal:true },
    defaults: { ouPush: 4, hcPush: 2 }
  }
};

/* âœ… ì¢…ëª©/ìœ í˜•ë³„ â€œë§ˆì§„ ë‚®ìŒâ€ íŒì • ê¸°ì¤€ (ë§ˆì§„% ê¸°ì¤€) */

function labels2Way(cfg){
  // 2ë°°ë‹¹ ë¼ë²¨: cfg.labels.A/Bê°€ ì—†ìœ¼ë©´(ì¶•êµ¬ ë“±) H/Aë¥¼ A/Bë¡œ ë§¤í•‘
  const A = (cfg && cfg.labels && cfg.labels.A) ? cfg.labels.A : ((cfg && cfg.labels && cfg.labels.H) ? cfg.labels.H : "A");
  const B = (cfg && cfg.labels && cfg.labels.B) ? cfg.labels.B : ((cfg && cfg.labels && cfg.labels.A) ? cfg.labels.A : "B");
  return {A, B};
}
function effectiveMainMode(cfg){
  if(MAIN_MODE_OVERRIDE==="2way") return "2way";
  if(MAIN_MODE_OVERRIDE==="3way") return "3way";
  return (cfg && cfg.main==="3way") ? "3way" : "2way";
}
function setMainModeOverride(mode){
  // mode: "2way" | "3way" | null
  MAIN_MODE_OVERRIDE = mode || null;
  try{ onSportChange(true); }catch(e){}
  try{ saveState(); }catch(e){}
}

const MARGIN_RULE = {
  soccer:     { main:[6, 8, 10], ou:[5.5, 7.5, 9.5], hc:[5.5, 7.5, 9.5] },
  basketball: { main:[4, 6, 8],  ou:[4.5, 6.5, 8.5], hc:[4.5, 6.5, 8.5] },
  baseball:   { main:[4.5, 6.5, 8.5], ou:[4.5, 6.5, 8.5], hc:[4.5, 6.5, 8.5] },
  volleyball: { main:[4, 6, 8],  ou:[4, 6, 8],  hc:[4, 6, 8] },
  esports:    { main:[4, 6, 8],  ou:[4, 6, 8],  hc:[4, 6, 8] },
  hockey:     { main:[4.5, 6.5, 8.5], ou:[4.5, 6.5, 8.5], hc:[4.5, 6.5, 8.5] }
};

function $(id){ return document.getElementById(id); }
function val(id){ const el=$(id); return el?el.value:""; }
function setVal(id,v){ const el=$(id); if(el && v!=null) el.value=v; }
function todayStr(){ return new Date().toISOString().slice(0,10); }
function nowTimeStr(){
  const d=new Date();
  const hh=String(d.getHours()).padStart(2,"0");
  const mm=String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}

function saveState(){
  const state = {
    sport: val("sport"),
    level: val("level"),
    mainModeOverride: MAIN_MODE_OVERRIDE,
    league: val("league"),
    teams: val("teams"),
    main2OddsA: val("main2OddsA"),
    main2OddsB: val("main2OddsB"),
    main3OddsH: val("main3OddsH"),
    main3OddsD: val("main3OddsD"),
    main3OddsA: val("main3OddsA"),
    myProb: val("myProb"),
    stake: val("stake"),
    handicapLine: val("handicapLine"),
    handicapOddsA: val("handicapOddsA"),
    handicapOddsB: val("handicapOddsB"),
    handicapPush: val("handicapPush"),
    totalLine: val("totalLine"),
    overOdds: val("overOdds"),
    underOdds: val("underOdds"),
    ouPush: val("ouPush"),
    myOverProb: val("myOverProb"),
    handicapCollapsed: isCollapsed("handicapBody"),
    totalCollapsed: isCollapsed("totalBody")
  };
  state.__savedAt = Date.now();
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  updateSaveBadge(state.__savedAt);
  maybePushSnapshot(state, false);
  return state;
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const s = JSON.parse(raw);

    if(s.sport) setVal("sport", s.sport);
    if(s.level) setVal("level", s.level);
    if(typeof s.mainModeOverride !== "undefined") MAIN_MODE_OVERRIDE = s.mainModeOverride || null;

    onSportChange(true);
    onLevelChange(true);

    setVal("league", s.league);
    setVal("teams", s.teams);
    setVal("main2OddsA", s.main2OddsA);
    setVal("main2OddsB", s.main2OddsB);
    setVal("main3OddsH", s.main3OddsH);
    setVal("main3OddsD", s.main3OddsD);
    setVal("main3OddsA", s.main3OddsA);
    setVal("myProb", s.myProb);
    setVal("stake", s.stake);
    setVal("handicapLine", s.handicapLine);
    setVal("handicapOddsA", s.handicapOddsA);
    setVal("handicapOddsB", s.handicapOddsB);
    setVal("handicapPush", s.handicapPush);
    setVal("totalLine", s.totalLine);
    setVal("overOdds", s.overOdds);
    setVal("underOdds", s.underOdds);
    setVal("ouPush", s.ouPush);
    setVal("myOverProb", s.myOverProb);

    if(typeof s.handicapCollapsed === "boolean") setCollapsed("handicapBody", s.handicapCollapsed);
    if(typeof s.totalCollapsed === "boolean") setCollapsed("totalBody", s.totalCollapsed);
  }catch(e){}
}

/* =========================
   í¼ë¨¸ë§í¬(ê³µìœ  ë§í¬) ìƒíƒœ ë³µì›
   - st=base64url(JSON)
========================= */
function b64urlEncode(str){
  try{
    return btoa(unescape(encodeURIComponent(str)))
      .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }catch(e){ return ""; }
}
function b64urlDecode(str){
  try{
    let s = String(str||"").replace(/-/g,'+').replace(/_/g,'/');
    while(s.length % 4) s += "=";
    return decodeURIComponent(escape(atob(s)));
  }catch(e){ return ""; }
}

function buildPermalinkState(){
  try{
    // saveState()ê°€ ìŠ¤ëƒ…ìƒ·/ë°°ì§€ê¹Œì§€ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ ê³µìœ  ì§ì „ì—” í•­ìƒ í˜¸ì¶œ
    const st = saveState();
    const payload = {
      v:1,
      sport: st.sport,
      level: st.level,
      league: st.league,
      teams: st.teams,
      fields: {
        main2OddsA: st.main2OddsA, main2OddsB: st.main2OddsB,
        main3OddsH: st.main3OddsH, main3OddsD: st.main3OddsD, main3OddsA: st.main3OddsA,
        myProb: st.myProb, stake: st.stake,
        handicapLine: st.handicapLine, handicapOddsA: st.handicapOddsA, handicapOddsB: st.handicapOddsB, handicapPush: st.handicapPush,
        totalLine: st.totalLine, overOdds: st.overOdds, underOdds: st.underOdds, ouPush: st.ouPush,
        myOverProb: st.myOverProb
      }
    };
    const json = JSON.stringify(payload);
    return b64urlEncode(json);
  }catch(e){ return ""; }
}

function restoreFromPermalink(){
  try{
    const u = new URL(location.href);
    const st = u.searchParams.get("st");
    if(!st) return false;
    const json = b64urlDecode(st);
    if(!json) return false;
    const data = JSON.parse(json);
    if(!data || !data.fields) return false;

    // ìš°ì„ ìˆœìœ„: ê³µìœ  ë§í¬(st) > localStorage
    if(data.sport) setVal("sport", data.sport);
    if(data.level) setVal("level", data.level);
    onSportChange(true);
    onLevelChange(true);
    setVal("league", data.league || "");
    setVal("teams", data.teams || "");

    const f = data.fields || {};
    [
      "main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA",
      "myProb","stake",
      "handicapLine","handicapOddsA","handicapOddsB","handicapPush",
      "totalLine","overOdds","underOdds","ouPush","myOverProb"
    ].forEach(k=> setVal(k, f[k]));

    saveState();
    try{ track("permalink_open", { has_state: true }); }catch(e){}

    // ë§í¬ë¥¼ ì—´ë©´ ë°”ë¡œ ê²°ê³¼ë¥¼ ë³´ì—¬ì¤˜ì•¼ í•¨
    const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
    const is3 = (effectiveMainMode(cfg) === "3way");
    const ok = is3
      ? (parseOdds(val("main3OddsH"))!=null && parseOdds(val("main3OddsD"))!=null && parseOdds(val("main3OddsA"))!=null)
      : (parseOdds(val("main2OddsA"))!=null && parseOdds(val("main2OddsB"))!=null);
    if(ok){
      setTimeout(()=>{ try{ calc(); }catch(e){} }, 50);
    }
    return true;
  }catch(e){ return false; }
}

/* ì…ë ¥ ì´ë²¤íŠ¸ ìë™ ì €ì¥ */
[
  "sport","level","league","teams",
  "main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA",
  "myProb","stake",
  "handicapLine","handicapOddsA","handicapOddsB","handicapPush",
  "totalLine","overOdds","underOdds","ouPush","myOverProb"
].forEach(id=>{
  const el=$(id);
  if(el) el.addEventListener("input", saveState);
});

/* =========================
   UI: í…œí”Œë¦¿ + ë‚œì´ë„
========================= */

/* =========================
   ë¼ì¸ ë¹„êµ (A vs B)
========================= */
function updateLineCompareUI(cfg){
  cfg = cfg || (SPORT_CFG[val("sport")] || SPORT_CFG.soccer);
  const is3 = (effectiveMainMode(cfg) === "3way");
  const a2 = document.getElementById("lcA2");
  const b2 = document.getElementById("lcB2");
  const a3 = document.getElementById("lcA3");
  const b3 = document.getElementById("lcB3");
  if(a2) a2.style.display = is3 ? "none" : "block";
  if(b2) b2.style.display = is3 ? "none" : "block";
  if(a3) a3.style.display = is3 ? "block" : "none";
  if(b3) b3.style.display = is3 ? "block" : "none";

  if(!is3){
    const la = cfg.labels.A||"A", lb = cfg.labels.B||"B";
    const ids = [
      ["lcA2LabelA", `${la} ë°°ë‹¹`], ["lcA2LabelB", `${lb} ë°°ë‹¹`],
      ["lcB2LabelA", `${la} ë°°ë‹¹`], ["lcB2LabelB", `${lb} ë°°ë‹¹`]
    ];
    ids.forEach(([id,txt])=>{ const el=document.getElementById(id); if(el) el.innerText = txt; });
  }else{
    const lh = cfg.labels.H||"í™ˆ", ld = cfg.labels.D||"ë¬´", la = cfg.labels.A||"ì›ì •";
    const ids = [
      ["lcA3LabelH", `${lh} ë°°ë‹¹`], ["lcA3LabelD", `${ld} ë°°ë‹¹`], ["lcA3LabelA", `${la} ë°°ë‹¹`],
      ["lcB3LabelH", `${lh} ë°°ë‹¹`], ["lcB3LabelD", `${ld} ë°°ë‹¹`], ["lcB3LabelA", `${la} ë°°ë‹¹`]
    ];
    ids.forEach(([id,txt])=>{ const el=document.getElementById(id); if(el) el.innerText = txt; });
  }
}

function getLineCompareSet(which){
  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
  const is3 = (effectiveMainMode(cfg) === "3way");
  if(!is3){
    const o1 = parseOdds(val(which==="A" ? "lcA2OddsA" : "lcB2OddsA"));
    const o2 = parseOdds(val(which==="A" ? "lcA2OddsB" : "lcB2OddsB"));
    if(o1==null || o2==null) return null;
    const out = compute2Way(o1,o2,0);
    return { is3:false, odds:[o1,o2], out };
  }
  const h = parseOdds(val(which==="A" ? "lcA3OddsH" : "lcB3OddsH"));
  const d = parseOdds(val(which==="A" ? "lcA3OddsD" : "lcB3OddsD"));
  const a = parseOdds(val(which==="A" ? "lcA3OddsA" : "lcB3OddsA"));
  if(h==null || d==null || a==null) return null;
  const out = compute3Way(h,d,a);
  return { is3:true, odds:[h,d,a], out };
}

function fmtFairFromProbs(probs){
  try{
    return probs.map(p=> (p>0 ? (1/p).toFixed(2) : "-")).join(" / ");
  }catch(e){ return "-"; }
}

function runLineCompare(){
  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
  const outEl = document.getElementById("lineCompareOut");
  if(!outEl) return;
  const A = getLineCompareSet("A");
  const B = getLineCompareSet("B");
  if(!A || !B){
    outEl.style.display = "block";
    outEl.innerHTML = `<div class="k">ì•ˆë‚´</div><div class="v warn">ë¼ì¸ A/B ë°°ë‹¹ì„ ëª¨ë‘ ì…ë ¥í•´ì¤˜.</div>`;
    try{ track("line_compare", { ok:0 }); }catch(e){}
    return;
  }
  const mA = A.out.marginPct;
  const mB = B.out.marginPct;
  const best = (mA <= mB) ? "A" : "B";
  const delta = Math.abs(mA - mB);
  const labels = A.is3 ? [cfg.labels.H||"H", cfg.labels.D||"D", cfg.labels.A||"A"] : [cfg.labels.A||"A", cfg.labels.B||"B"];
  const fairA = fmtFairFromProbs(A.out.probs);
  const fairB = fmtFairFromProbs(B.out.probs);
  outEl.style.display = "block";
  outEl.innerHTML = `
    <div class="k">ë¹„êµ ê²°ê³¼</div>
    <div class="v">
      â€¢ ë¼ì¸ A ë§ˆì§„: <b>${mA.toFixed(2)}%</b> Â· ê³µì •ë°°ë‹¹(${labels.join("/")}): <b>${fairA}</b><br>
      â€¢ ë¼ì¸ B ë§ˆì§„: <b>${mB.toFixed(2)}%</b> Â· ê³µì •ë°°ë‹¹(${labels.join("/")}): <b>${fairB}</b><br>
      â€¢ ë” ë‚®ì€ ë§ˆì§„: <b class="${best==='A'?'good':'warn'}">ë¼ì¸ ${best}</b> (ì°¨ì´ ${delta.toFixed(2)}%p)
    </div>
  `;
  try{ track("line_compare", { ok:1, best, delta_pp:+delta.toFixed(4) }); }catch(e){}
}

function applyLineCompare(which){
  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
  const is3 = (effectiveMainMode(cfg) === "3way");
  if(!is3){
    const a = val(which==="A" ? "lcA2OddsA" : "lcB2OddsA");
    const b = val(which==="A" ? "lcA2OddsB" : "lcB2OddsB");
    setVal("main2OddsA", a);
    setVal("main2OddsB", b);
  }else{
    const h = val(which==="A" ? "lcA3OddsH" : "lcB3OddsH");
    const d = val(which==="A" ? "lcA3OddsD" : "lcB3OddsD");
    const a = val(which==="A" ? "lcA3OddsA" : "lcB3OddsA");
    setVal("main3OddsH", h);
    setVal("main3OddsD", d);
    setVal("main3OddsA", a);
  }
  saveState();
  try{ calc(); }catch(e){}
  try{ track("line_apply", { which }); }catch(e){}
  try{ quickJump('result'); }catch(e){}
}

function prefillLineCompare(){
  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
  const is3 = (effectiveMainMode(cfg) === "3way");
  if(!is3){
    setVal("lcA2OddsA", val("main2OddsA"));
    setVal("lcA2OddsB", val("main2OddsB"));
    setVal("lcB2OddsA", "");
    setVal("lcB2OddsB", "");
  }else{
    setVal("lcA3OddsH", val("main3OddsH"));
    setVal("lcA3OddsD", val("main3OddsD"));
    setVal("lcA3OddsA", val("main3OddsA"));
    setVal("lcB3OddsH", "");
    setVal("lcB3OddsD", "");
    setVal("lcB3OddsA", "");
  }
  const outEl = document.getElementById("lineCompareOut");
  if(outEl){ outEl.style.display="none"; outEl.innerHTML=""; }
  try{ track("line_prefill", {}); }catch(e){}
}

function onSportChange(silent){
  const sport = val("sport");
  const cfg = SPORT_CFG[sport] || SPORT_CFG.soccer;

  // ì‚¬ìš©ìê°€ ì¢…ëª©ì„ ì§ì ‘ ë°”ê¾¸ë©´ ë©”ì¸ íƒ€ì… ì˜¤ë²„ë¼ì´ë“œëŠ” ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹
  if(!silent) MAIN_MODE_OVERRIDE = null;

  $("sportHint").innerText = `ì„ íƒ ì¢…ëª©: ${cfg.name} Â· ${cfg.hint}`;

  const is3 = (effectiveMainMode(cfg) === "3way");
  $("main2").style.display = is3 ? "none" : "block";
  $("main3").style.display = is3 ? "block" : "none";
  if(is3){
    $("mainMarketTitle").innerText = `ë©”ì¸ ë°°ë‹¹ (${cfg.labels.H||"H"}/${cfg.labels.D||"D"}/${cfg.labels.A||"A"})`;
  }else{
    const L2t = labels2Way(cfg);
    $("mainMarketTitle").innerText = `ë©”ì¸ ë°°ë‹¹ (${L2t.A}/${L2t.B})`;
  }

  if(!is3){
    const L2 = labels2Way(cfg);
    $("main2LabelA").innerText = `${L2.A} ë°°ë‹¹`;
    $("main2LabelB").innerText = `${L2.B} ë°°ë‹¹`;
  }else{
    $("main3LabelH").innerText = `${cfg.labels.H} ë°°ë‹¹`;
    $("main3LabelD").innerText = `${cfg.labels.D} ë°°ë‹¹`;
    $("main3LabelA").innerText = `${cfg.labels.A} ë°°ë‹¹`;
  }

  // í•¸ë”” ë¼ë²¨ ì—…ë°ì´íŠ¸
  $("handicapOddsALabel").innerText = `í•¸ë”” ${cfg.labels.A || "ì„ íƒA"} ë°°ë‹¹`;
  $("handicapOddsBLabel").innerText = `ë°˜ëŒ€ ${cfg.labels.B || "ì„ íƒB"} ë°°ë‹¹`;

  // ê¸°ë³¸ í‘¸ì‹œ ê·¼ì‚¬ê°’(ë¯¸ì…ë ¥ì¼ ë•Œë§Œ ì±„ì›Œë„£ê¸°)
  if(!val("ouPush")) setVal("ouPush", cfg.defaults.ouPush);
  if(!val("handicapPush")) setVal("handicapPush", cfg.defaults.hcPush);

  applyTemplate();
  updateMyProbHints(cfg, val("level"));
  updateLineCompareUI(cfg);

  if(!silent) hideResult();
  renderMarginDash(); // ì¢…ëª© ë°”ë€Œë©´ ê¸°ì¤€í‘œ/ëŒ€ì‹œë³´ë“œ ì¦‰ì‹œ ë°˜ì˜
  saveState();
}

function onLevelChange(silent){
  const level = val("level");
  $("valueInputs").style.display = (level === "simple") ? "none" : "block";
  $("handicapBox").style.display = (level === "simple") ? "none" : "block";
  $("totalBox").style.display = (level === "simple") ? "none" : "block";

  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
  updateMyProbHints(cfg, level);
  applyTemplate();

  if(!silent) hideResult();
  renderMarginDash();
  saveState();
}

function updateMyProbHints(cfg, level){
  const is3 = (effectiveMainMode(cfg) === "3way");
  if(level === "simple"){
    $("myProbLabel").innerText = "ë‚´ ì˜ˆìƒ í™•ë¥ (ì„ íƒ) %";
    $("myProbHint").innerText = "";
    return;
  }
  if(is3){
    $("myProbLabel").innerText = `ë‚´ ì˜ˆìƒ í™•ë¥ (${cfg.labels.H}/${cfg.labels.D}/${cfg.labels.A}) % (ì„ íƒ)`;
    $("myProbHint").innerText = `ì‰¼í‘œë¡œ 3ê°œ ì…ë ¥ (ì˜ˆ: 45,28,27) Â· í•© 100 ê¶Œì¥`;
  }else{
    $("myProbLabel").innerText = `ë‚´ ì˜ˆìƒ í™•ë¥ (${cfg.labels.A}) % (ì„ íƒ)`;
    $("myProbHint").innerText = `ì˜ˆ: 55 (ë‹¨ì¼ ê°’) Â· EV/ê¶Œì¥ë¹„ì¤‘ ê³„ì‚°ìš©`;
  }
}

/* í…œí”Œë¦¿: ì¢…ëª©ë³„ OU/í•¸ë”” ê¸°ë³¸ í¼ì¹¨ */
function applyTemplate(){
  const level = val("level");
  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
  if(level === "simple") return;
  setCollapsed("handicapBody", !cfg.template.openHandicap);
  setCollapsed("totalBody", !cfg.template.openTotal);
}

/* ì ‘ê¸°/í¼ì¹˜ê¸° */
function toggleBox(id){
  const now = isCollapsed(id);
  setCollapsed(id, !now);
  saveState();
}
function isCollapsed(id){
  const el = $(id);
  return el ? el.style.display === "none" : false;
}
function setCollapsed(id, collapsed){
  const el = $(id);
  if(!el) return;
  el.style.display = collapsed ? "none" : "block";
}

/* =========================
   ê³„ì‚° ìœ í‹¸
========================= */
function parseOdds(v){
  if(!v) return null;
  const x = Number(String(v).replace(/,/g,".").trim());
  if(!isFinite(x) || x<=1) return null;
  return x;
}
function parsePct(v){
  if(v==null || v==="") return null;
  const x = Number(String(v).replace(/,/g,".").trim());
  if(!isFinite(x) || x<0 || x>100) return null;
  return x/100;
}
function parsePctList(str){
  if(!str) return null;
  const parts = str.split(",").map(s=>s.trim()).filter(Boolean);
  if(parts.length !== 3) return null;
  const p1=parsePct(parts[0]), p2=parsePct(parts[1]), p3=parsePct(parts[2]);
  if(p1==null || p2==null || p3==null) return null;
  return [p1,p2,p3];
}
function parseMoney(v){
  if(!v) return null;
  const x = Number(String(v).replace(/[^\d]/g,""));
  if(!isFinite(x) || x<=0) return null;
  return x;
}

/* =========================
   í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° íŒŒì„œ (MVP)
   - ì»¤ë®¤ë‹ˆí‹°/ë°°ë‹¹í‘œ í…ìŠ¤íŠ¸ì—ì„œ ë©”ì¸/OU/í•¸ë””ë¥¼ ìë™ ì¶”ì¶œ
   - ì „ë¶€ í´ë¼ì´ì–¸íŠ¸ì—ì„œë§Œ ì²˜ë¦¬(ì„œë²„/ë¹„ìš© 0)
========================= */
function setupPasteBox(){
  const ta = $("pasteInput");
  if(!ta) return;
  ta.addEventListener("keydown", (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key === "Enter"){
      e.preventDefault();
      if(e.shiftKey){
        // Ctrl+Shift+Enter: ë©€í‹° íŒŒì‹±
        try{ parsePasteMulti(); }catch(err){ applyPaste(true); }
      }else{
        // Ctrl+Enter: ë‹¨ì¼ ì ìš©+ê³„ì‚°
        applyPaste(true);
      }
    }
  });
}

function clearPaste(){
  setVal("pasteInput", "");
  setPasteBadge("", "");
  const hint = $("pasteHint");
  if(hint) hint.innerText = "";
}

function fillPasteExample(){
  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
  const is3 = (effectiveMainMode(cfg) === "3way");
  const ex = is3
    ? "ë§¨ì‹œí‹° vs ë¦¬ë²„í’€  ìŠ¹ 1.85 ë¬´ 3.40 íŒ¨ 4.20 / ì˜¤ë²„ 2.5 1.95 ì–¸ë” 1.85 / í•¸ë”” -1.5 1.90 1.95"
    : "ë ˆì´ì»¤ìŠ¤ vs ì›Œë¦¬ì–´ìŠ¤ ìŠ¹ 1.87 íŒ¨ 2.03 / ì˜¤ë²„ 228.5 1.93 ì–¸ë” 1.87 / í•¸ë”” -3.5 1.90 1.95";
  setVal("pasteInput", ex);
  try{ $("pasteInput").focus(); }catch(e){}
}

function setPasteBadge(okMsg, warnMsg){
  const ok = $("pasteBadgeOk");
  const warn = $("pasteBadgeWarn");
  if(ok){
    if(okMsg){ ok.style.display = "inline-flex"; ok.textContent = okMsg; }
    else{ ok.style.display = "none"; ok.textContent = ""; }
  }
  if(warn){
    if(warnMsg){ warn.style.display = "inline-flex"; warn.textContent = warnMsg; }
    else{ warn.style.display = "none"; warn.textContent = ""; }
  }
}

function normalizePasteText(s){
  if(!s) return "";
  let t = String(s).replace(/Â /g, " ");
  t = t.replace(/\s+/g, " ").trim();
  // decimal comma -> dot (1,85)
  t = t.replace(/(\d),(\d{1,3})(?!\d)/g, (m,a,b)=>`${a}.${b}`);
  return t;
}

function extractNextNumberTokens(text, startIndex, maxCount){
  const out = [];
  const re = /[+-]?\d+(?:\.\d+)?/g;
  re.lastIndex = startIndex;
  let m;
  while((m = re.exec(text)) && out.length < maxCount){
    const v = Number(m[0]);
    if(!isFinite(v)) continue;
    out.push({ v, start: m.index, end: m.index + m[0].length, raw: m[0] });
  }
  return out;
}

function extractTeamsFromText(text){
  // "A vs B" / "A v B" / "A ëŒ€ B" í˜•íƒœë¥¼ ê°€ë³ê²Œ ì¶”ì¶œ
  const re = /([^0-9]{2,40}?)\s*(?:vs|v|VS|ëŒ€)\s*([^0-9]{2,40}?)(?=\s|$|\/)/;
  const m = re.exec(text);
  if(!m) return null;
  const a = m[1].replace(/[\[\]<>]/g, "").trim();
  const b = m[2].replace(/[\[\]<>]/g, "").trim();
  if(a.length < 2 || b.length < 2) return null;
  return `${a} vs ${b}`;
}

function parseOUFromText(text){
  let t = text;
  const overKW = /(?:ì˜¤ë²„|over)/i;
  const underKW = /(?:ì–¸ë”|under)/i;

  let over = null, under = null;
  let cutEnd = -1;

  const mo = overKW.exec(t);
  if(mo){
    const toks = extractNextNumberTokens(t, mo.index + mo[0].length, 3);
    if(toks.length >= 2){
      // ì˜¤ë²„ {ë¼ì¸} {ë°°ë‹¹}
      const line = toks[0].v;
      const odds = toks[1].v;
      if(isFinite(line) && isFinite(odds) && odds > 1){
        over = { line, odds };
        cutEnd = Math.max(cutEnd, toks[1].end);
        t = t.slice(0, mo.index) + " " + t.slice(toks[1].end);
      }
    }else if(toks.length >= 1){
      // ë¼ì¸ ëˆ„ë½ ê°€ëŠ¥: ì˜¤ë²„ {ë°°ë‹¹}
      const odds = toks[0].v;
      if(isFinite(odds) && odds > 1){
        over = { line: null, odds };
        cutEnd = Math.max(cutEnd, toks[0].end);
        t = t.slice(0, mo.index) + " " + t.slice(toks[0].end);
      }
    }
  }

  const mu = underKW.exec(t);
  if(mu){
    const toks = extractNextNumberTokens(t, mu.index + mu[0].length, 3);
    if(toks.length >= 2){
      const line = toks[0].v;
      const odds = toks[1].v;
      if(isFinite(line) && isFinite(odds) && odds > 1){
        under = { line, odds };
        cutEnd = Math.max(cutEnd, toks[1].end);
        t = t.slice(0, mu.index) + " " + t.slice(toks[1].end);
      }
    }else if(toks.length >= 1){
      const odds = toks[0].v;
      if(isFinite(odds) && odds > 1){
        under = { line: null, odds };
        cutEnd = Math.max(cutEnd, toks[0].end);
        t = t.slice(0, mu.index) + " " + t.slice(toks[0].end);
      }
    }
  }

  const full = !!(over && under && over.odds && under.odds);
  const line = (over && over.line != null) ? over.line : (under && under.line != null ? under.line : null);
  return { full, line, overOdds: over ? over.odds : null, underOdds: under ? under.odds : null, cleanedText: t };
}

function parseHCFromText(text){
  let t = text;
  const kw = /(?:í•¸ë””ìº¡|í•¸ë””|handicap|ah)/i;
  const m = kw.exec(t);
  if(!m) return { full:false, line:null, a:null, b:null, cleanedText:t };

  const toks = extractNextNumberTokens(t, m.index + m[0].length, 5);
  if(toks.length < 3) return { full:false, line:null, a:null, b:null, cleanedText:t };

  const line = toks[0].v;
  const a = toks[1].v;
  const b = toks[2].v;
  const full = (isFinite(line) && Math.abs(line) <= 50 && isFinite(a) && isFinite(b) && a > 1 && b > 1);

  if(full){
    t = t.slice(0, m.index) + " " + t.slice(toks[2].end);
    return { full, line, a, b, cleanedText:t };
  }
  return { full:false, line:null, a:null, b:null, cleanedText:t };
}

function extractOddsCandidates(text){
  const re = /[1-9]\d*(?:\.\d+)?/g;
  const out=[];
  let m;
  while((m=re.exec(text))){
    const v = Number(m[0]);
    if(!isFinite(v)) continue;
    if(v > 1 && v <= 200) out.push(v);
  }
  return out;
}

function parseMainFromText(text, is3){
  const t = text;
  if(is3){
    const re = /(?:í™ˆ|ìŠ¹|1)\s*[:\-]?\s*([1-9]\d*(?:\.\d+)?)[\s\S]{0,60}?(?:ë¬´|x|draw)\s*[:\-]?\s*([1-9]\d*(?:\.\d+)?)[\s\S]{0,60}?(?:ì›ì •|íŒ¨|2)\s*[:\-]?\s*([1-9]\d*(?:\.\d+)?)/i;
    const m = re.exec(t);
    if(m){
      const h = Number(m[1]), d = Number(m[2]), a = Number(m[3]);
      if(isFinite(h) && isFinite(d) && isFinite(a) && h>1 && d>1 && a>1) return { found:true, odds:[h,d,a] };
    }
    const c = extractOddsCandidates(t);
    if(c.length >= 3) return { found:true, odds:[c[0],c[1],c[2]], extra:c.length-3 };
    return { found:false, odds:[] };
  }
  // 2-way
  const re2 = /(?:ìŠ¹|í™ˆ|1)\s*[:\-]?\s*([1-9]\d*(?:\.\d+)?)[\s\S]{0,60}?(?:íŒ¨|ì›ì •|2)\s*[:\-]?\s*([1-9]\d*(?:\.\d+)?)/i;
  const m2 = re2.exec(t);
  if(m2){
    const a = Number(m2[1]), b = Number(m2[2]);
    if(isFinite(a) && isFinite(b) && a>1 && b>1) return { found:true, odds:[a,b] };
  }
  const c = extractOddsCandidates(t);
  if(c.length >= 2) return { found:true, odds:[c[0],c[1]], extra:c.length-2 };
  return { found:false, odds:[] };
}

function applyPaste(autoCalc){
  const raw = val("pasteInput");
  const txt = normalizePasteText(raw);
  if(!txt){
    setPasteBadge("", "í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ì–´ì¤˜.");
    return;
  }

  // 1) íŒ€ëª… ìë™ ì¶”ì¶œ(ì…ë ¥ì´ ë¹„ì–´ìˆì„ ë•Œë§Œ)
  try{
    if(!val("teams")){
      const teams = extractTeamsFromText(txt);
      if(teams) setVal("teams", teams);
    }
  }catch(e){}

  // 2) OU/í•¸ë”” ë¨¼ì € ì¶”ì¶œí•˜ê³  í…ìŠ¤íŠ¸ì—ì„œ ì œê±°(ë©”ì¸ ì˜¤ì¸ì‹ ë°©ì§€)
  let working = txt;
  const ou = parseOUFromText_v2(working);
  working = ou.cleanedText;
  const hc = parseHCFromText_v2(working);
  working = hc.cleanedText;

  // 3) OU/í•¸ë””ê°€ ìˆìœ¼ë©´ ë ˆë²¨ ìë™ ì „í™˜(ì„ íƒ)
  const wantsAutoLevel = (function(){ const el=$("pasteAutoLevel"); return el ? el.checked : false; })();
  if(wantsAutoLevel && val("level") === "simple" && (ou.full || hc.full)){
    setVal("level", "mid");
    onLevelChange(true);
  }

  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
  const modeEl = $("pasteMainMode");
  const mode = modeEl ? modeEl.value : "auto";
  const prefer3 = (cfg.main === "3way");
  const tryMain = (is3)=> parseMainFromText_robust(working, is3);

  let is3 = (mode==="3") ? true : (mode==="2") ? false : prefer3;
  let main = tryMain(is3);

  if(!main || !main.found){
    if(mode==="auto"){
      const alt = tryMain(!is3);
      if(alt && alt.found){ is3 = !is3; main = alt; }
    }
  }

  // 4) ë©”ì¸ ë°°ë‹¹ ì¶”ì¶œ
  if(!main || !main.found){
    let msg = "ë©”ì¸ ë°°ë‹¹ì„ ì°¾ì§€ ëª»í–ˆì–´.";
    if(mode==="3") msg += " ì˜ˆ: ìŠ¹ 1.85 ë¬´ 3.40 íŒ¨ 4.20";
    else if(mode==="2") msg += " ì˜ˆ: ìŠ¹ 1.87 íŒ¨ 2.03";
    else msg += " ì˜ˆ: ìŠ¹ 1.85 ë¬´ 3.40 íŒ¨ 4.20 (3ë°°ë‹¹) ë˜ëŠ” ìŠ¹ 1.87 íŒ¨ 2.03 (2ë°°ë‹¹)";
    setPasteBadge("", msg);
    const hint=$("pasteHint");
    if(hint) hint.innerText = "íŒ: 'íŒ€A vs íŒ€B' ë’¤ì— ë°°ë‹¹ ìˆ«ì(ì†Œìˆ˜ì  í¬í•¨)ê°€ ê°™ì´ ìˆì–´ì•¼ ìë™ ì¸ì‹ë¼ìš”.";
    return;
  }

  // (ì„ íƒ) ë©”ì¸ íƒ€ì… ì˜¤ë²„ë¼ì´ë“œ ë°˜ì˜ (ì¶•êµ¬ 2ë°°ë‹¹ ë“±)
  try{ setMainModeOverride(is3 ? "3way" : "2way"); }catch(e){}

  // 5) ì…ë ¥ ì ìš©
  if(is3){
    setVal("main3OddsH", String(main.odds[0]));
    setVal("main3OddsD", String(main.odds[1]));
    setVal("main3OddsA", String(main.odds[2]));
  }else{
    setVal("main2OddsA", String(main.odds[0]));
    setVal("main2OddsB", String(main.odds[1]));
  }

  if(ou.full){
    if(ou.line != null) setVal("totalLine", String(ou.line));
    if(ou.overOdds != null) setVal("overOdds", String(ou.overOdds));
    if(ou.underOdds != null) setVal("underOdds", String(ou.underOdds));
  }
  if(hc.full){
    setVal("handicapLine", String(hc.line));
    setVal("handicapOddsA", String(hc.a));
    setVal("handicapOddsB", String(hc.b));
  }

  // ë¼ì¸ ë¹„êµ ì…ë ¥ë„ ê°™ì´ ì±„ì›Œë‘ê¸°(í¸ì˜)
  try{ prefillLineCompare(); }catch(e){}

  hideResult();
  renderMarginDash();
  saveState();

  // 6) í”¼ë“œë°±
  let okMsg = `ë©”ì¸ ${is3 ? "3ë°°ë‹¹" : "2ë°°ë‹¹"} ì…ë ¥ë¨`;
  if(ou.full) okMsg += ` Â· OU ${ou.line != null ? ou.line : ""}`;
  if(hc.full) okMsg += ` Â· í•¸ë”” ${hc.line}`;
  setPasteBadge(okMsg, "");

  const hint = $("pasteHint");
  if(hint){
    hint.innerText = "ë‹¨ì¶•í‚¤: Ctrl+Enter = ìë™ ì…ë ¥+ê³„ì‚° Â· Ctrl+Shift+Enter = ì—¬ëŸ¬ ê²½ê¸° ë¦¬ìŠ¤íŠ¸";
  }

  try{
    track("paste_apply", { auto_calc: autoCalc?1:0, main: is3?"3":"2", has_ou: ou.full?1:0, has_hc: hc.full?1:0 });
  }catch(e){}

  if(autoCalc){
    try{ calc(); }catch(e){}
    try{ quickJump('result'); }catch(e){}
  }
}

/* =========================
   ë©€í‹° ë¶™ì—¬ë„£ê¸° (2ë‹¨ê³„)
   - ì—¬ëŸ¬ ê²½ê¸° í…ìŠ¤íŠ¸ë¥¼ í•œ ë²ˆì— ë¶™ì—¬ë„£ê¸° â†’ ê²½ê¸° ë¦¬ìŠ¤íŠ¸ ìë™ ìƒì„±
   - ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ í´ë¦­ â†’ ë¶„ì„ê¸° ì…ë ¥ ìë™ ì ìš©(ì„ íƒ: ìë™ ê³„ì‚°)
   - ì‚¬ìš©ì ì…ë ¥ í¸ì°¨(ìˆœì„œ/êµ¬ë¶„ì/ì•½ì–´)ë¥¼ ìµœëŒ€í•œ í¡ìˆ˜
========================= */

function normalizePasteTextMulti(s){
  if(!s) return "";
  let t = String(s).replace(/\r\n?/g, "\n");
  t = t.replace(/\t/g, " ");
  t = t.replace(/\u00a0/g, " ");
  // decimal comma -> dot (1,85)
  t = t.replace(/(\d),(\d{1,3})(?!\d)/g, (m,a,b)=>`${a}.${b}`);
  // normalize separators
  t = t.replace(/[|ï½œ]/g, " / ");
  t = t.split("\n").map(l=>l.replace(/\s+/g," ").trim()).join("\n");
  return t.trim();
}

function hasVsToken(s){
  return /(?:\bvs\b|\bv\b|ëŒ€|@)/i.test(s);
}

function splitLineByRepeatedVs(line){
  // í•œ ì¤„ì— ê²½ê¸° ì—¬ëŸ¬ ê°œê°€ ë“¤ì–´ì˜¨ ê²½ìš°ë¥¼ ê°€ë³ê²Œ ë¶„ë¦¬
  // ex) A vs B 1.8 3.4 4.2  C vs D 1.9 3.2 3.8
  const parts = [];
  const re = /([^\d]{2,40}?\s*(?:vs|VS|\bv\b|V|ëŒ€|@)\s*[^\d]{2,40}?)/g;
  let idxs = [];
  let m;
  while((m = re.exec(line))){
    idxs.push(m.index);
  }
  if(idxs.length <= 1) return [line];
  for(let i=0;i<idxs.length;i++){
    const start = idxs[i];
    const end = (i+1<idxs.length) ? idxs[i+1] : line.length;
    const seg = line.slice(start, end).trim();
    if(seg) parts.push(seg);
  }
  return parts.length ? parts : [line];
}

function splitPasteBlocks(text){
  const t = normalizePasteTextMulti(text);
  if(!t) return [];
  let lines = t.split("\n").map(l=>l.trim()).filter(Boolean);
  // 1) í•œ ì¤„ì— ê²½ê¸° ì—¬ëŸ¬ ê°œë©´ ë¶„ë¦¬
  let expanded = [];
  for(const ln of lines){
    const segs = splitLineByRepeatedVs(ln);
    for(const s of segs) expanded.push(s);
  }
  lines = expanded;

  const anyVs = lines.some(hasVsToken);
  if(!anyVs){
    // VS í† í°ì´ ì—†ìœ¼ë©´ ì¤„ ë‹¨ìœ„ë¡œ ì²˜ë¦¬
    return lines;
  }

  const blocks = [];
  let cur = [];
  for(const ln of lines){
    if(hasVsToken(ln) && cur.length && cur.some(hasVsToken)){
      blocks.push(cur.join(" / "));
      cur = [ln];
    }else{
      cur.push(ln);
    }
  }
  if(cur.length) blocks.push(cur.join(" / "));
  return blocks;
}

function findEarliestMatch(text, regexList){
  let best = null;
  for(const re of regexList){
    const m = re.exec(text);
    if(m){
      if(best == null || m.index < best.index){
        best = { m, index:m.index, re };
      }
    }
  }
  return best;
}

function parseOUFromText_v2(text){
  // ê¸°ì¡´ parseOUFromText í™•ì¥: O/U ì•½ì–´ë„ í—ˆìš©
  let t = text;
  const overMatches = [
    /ì˜¤ë²„/i,
    /\bover\b/i,
    /(?:^|[\s\/])O(?=[\s\/]|$)/i,
    /O\s*\/\s*U/i,
    /\bOU\b/i
  ];
  const underMatches = [
    /ì–¸ë”/i,
    /\bunder\b/i,
    /(?:^|[\s\/])U(?=[\s\/]|$)/i
  ];

  let over = null, under = null;

  const mo = findEarliestMatch(t, overMatches);
  if(mo){
    const toks = extractNextNumberTokens(t, mo.index + mo.m[0].length, 3);
    if(toks.length >= 2){
      const line = toks[0].v;
      const odds = toks[1].v;
      if(isFinite(line) && isFinite(odds) && odds > 1){
        over = { line, odds };
        t = t.slice(0, mo.index) + " " + t.slice(toks[1].end);
      }
    }else if(toks.length >= 1){
      const odds = toks[0].v;
      if(isFinite(odds) && odds > 1){
        over = { line:null, odds };
        t = t.slice(0, mo.index) + " " + t.slice(toks[0].end);
      }
    }
  }

  const mu = findEarliestMatch(t, underMatches);
  if(mu){
    const toks = extractNextNumberTokens(t, mu.index + mu.m[0].length, 3);
    if(toks.length >= 2){
      const line = toks[0].v;
      const odds = toks[1].v;
      if(isFinite(line) && isFinite(odds) && odds > 1){
        under = { line, odds };
        t = t.slice(0, mu.index) + " " + t.slice(toks[1].end);
      }
    }else if(toks.length >= 1){
      const odds = toks[0].v;
      if(isFinite(odds) && odds > 1){
        under = { line:null, odds };
        t = t.slice(0, mu.index) + " " + t.slice(toks[0].end);
      }
    }
  }

  const full = !!(over && under && over.odds && under.odds);
  const line = (over && over.line != null) ? over.line : (under && under.line != null ? under.line : null);
  return { full, line, overOdds: over ? over.odds : null, underOdds: under ? under.odds : null, cleanedText: t };
}

function parseHCFromText_v2(text){
  let t = text;
  const kw = /(?:í•¸ë””ìº¡|í•¸ë””|handicap|ah|hdp|spread|ìŠ¤í”„ë ˆë“œ)/i;
  const m = kw.exec(t);
  if(m){
    const toks = extractNextNumberTokens(t, m.index + m[0].length, 5);
    if(toks.length >= 3){
      const line = toks[0].v;
      const a = toks[1].v;
      const b = toks[2].v;
      const full = (isFinite(line) && Math.abs(line) <= 2000 && isFinite(a) && isFinite(b) && a > 1 && b > 1);
      if(full){
        t = t.slice(0, m.index) + " " + t.slice(toks[2].end);
        return { full, line, a, b, cleanedText: t };
      }
    }
  }

  // í‚¤ì›Œë“œê°€ ì—†ì–´ë„ "-3.5 1.90 1.95" ê°™ì€ ìŠ¤í”„ë ˆë“œ íŒ¨í„´ì„ ê°€ë³ê²Œ ì¸ì‹
  const re = /([+-]?\d+(?:\.\d+)?)\s+([1-9]\d*(?:\.\d+)?)\s+([1-9]\d*(?:\.\d+)?)/;
  const m2 = re.exec(t);
  if(m2){
    const line = Number(m2[1]);
    const a = Number(m2[2]);
    const b = Number(m2[3]);
    if(isFinite(line) && Math.abs(line) <= 30 && isFinite(a) && isFinite(b) && a>1 && b>1 && (String(m2[1]).startsWith("+") || String(m2[1]).startsWith("-")) ){
      const cutStart = m2.index;
      const cutEnd = m2.index + m2[0].length;
      const cleaned = t.slice(0, cutStart) + " " + t.slice(cutEnd);
      return { full:true, line, a, b, cleanedText: cleaned };
    }
  }
  return { full:false, line:null, a:null, b:null, cleanedText:t };
}

function parseMainFromText_robust(text, is3){
  // 1) ê¸°ì¡´ í‚¤ì›Œë“œ ê¸°ë°˜
  const r1 = parseMainFromText(text, is3);
  if(r1.found) return { ...r1, conf:"high", method:"keyword" };

  // 2) íŒ€ëª… ì´í›„ë¥¼ ìš°ì„ 
  let startIdx = 0;
  try{
    const re = /([^0-9]{2,40}?)\s*(?:vs|v|VS|ëŒ€|@)\s*([^0-9]{2,40}?)(?=\s|$|\/)/;
    const m = re.exec(text);
    if(m) startIdx = m.index + m[0].length;
  }catch(e){}
  const after = text.slice(startIdx);
  const c = extractOddsCandidates(after);
  if(is3){
    if(c.length >= 3) return { found:true, odds:[c[0],c[1],c[2]], extra: Math.max(0,c.length-3), conf: c.length===3?"mid":"low", method:"after_team" };
  }else{
    if(c.length >= 2){
      // 2-wayì¸ë° 3ê°œë©´ ì¤‘ê°„(draw) ë¼ì–´ìˆì„ ìˆ˜ ìˆì–´ì„œ ì²«/ë§ˆì§€ë§‰ ìš°ì„ 
      if(c.length >= 3) return { found:true, odds:[c[0],c[2]], extra: Math.max(0,c.length-2), conf:"low", method:"skip_mid" };
      return { found:true, odds:[c[0],c[1]], extra: Math.max(0,c.length-2), conf:"mid", method:"after_team" };
    }
  }

  // 3) ë§ˆì§€ë§‰ fallback: ë¬¸ì¥ ì „ì²´ì—ì„œ ìˆœì°¨ ì¶”ì¶œ
  const c2 = extractOddsCandidates(text);
  if(is3){
    if(c2.length >= 3) return { found:true, odds:[c2[0],c2[1],c2[2]], extra: Math.max(0,c2.length-3), conf:"low", method:"fallback" };
  }else{
    if(c2.length >= 2) return { found:true, odds:[c2[0],c2[1]], extra: Math.max(0,c2.length-2), conf:"low", method:"fallback" };
  }
  return { found:false, odds:[], conf:"low", method:"none" };
}

function parseGameBlock(blockText){
  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;

  const raw = normalizePasteText(blockText);
  if(!raw) return null;

  // íŒ€ëª… ì¶”ì¶œ (ì—†ìœ¼ë©´ null)
  const teams = extractTeamsFromText(raw);

  // OU/HC ë¨¼ì € ì œê±°(ë©”ì¸ ì˜¤ì¸ì‹ ë°©ì§€)
  let working = raw;
  const ou = parseOUFromText_v2(working);
  working = ou.cleanedText;
  const hc = parseHCFromText_v2(working);
  working = hc.cleanedText;

  // ë©”ì¸ íƒ€ì…(ìœ ì € ì…ë ¥ í¸ì°¨ ëŒ€ì‘): ìë™/2ë°°ë‹¹/3ë°°ë‹¹
  const modeEl = $("pasteMainMode");
  const mode = modeEl ? modeEl.value : "auto";
  const prefer3 = (cfg.main === "3way"); // ì¢…ëª© ê¸°ë³¸ ì„ í˜¸(ì¶•êµ¬ 3way ë“±)
  const tryMain = (is3)=> parseMainFromText_robust(working, is3);

  let is3 = (mode==="3") ? true : (mode==="2") ? false : prefer3;
  let main = tryMain(is3);

  if(!main || !main.found){
    if(mode==="auto"){
      const alt = tryMain(!is3);
      if(alt && alt.found){ is3 = !is3; main = alt; }
    }
  }
  if(!main || !main.found) return null;

  const conf = main.conf || "low";
  const extra = main.extra || 0;
  const warn = (conf === "low" || extra >= 2);

  // ì˜ˆìƒ ë§ˆì§„(ë©”ì¸) â€” ë¦¬ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°ìš©
  let mainOver = null, mainMarginPct = null;
  try{
    if(is3){
      const out = compute3Way(Number(main.odds[0]), Number(main.odds[1]), Number(main.odds[2]));
      mainOver = out.over; mainMarginPct = out.marginPct;
    }else{
      const out = compute2Way(Number(main.odds[0]), Number(main.odds[1]), 0);
      mainOver = out.over; mainMarginPct = out.marginPct;
    }
  }catch(e){}

  const sig = (function(){
    const norm=(x)=>String(x??"").toLowerCase().replace(/\s+/g,"");
    const f=(n)=>{ const v=Number(n); return Number.isFinite(v)?v.toFixed(4):""; };
    const parts=[norm(val("sport")), is3?"3way":"2way", norm(teams||"")];
    if(is3){ parts.push(f(main.odds[0]), f(main.odds[1]), f(main.odds[2])); }
    else { parts.push(f(main.odds[0]), f(main.odds[1])); }
    if(ou && ou.full) parts.push("ou:"+norm(ou.line)+":"+f(ou.overOdds)+":"+f(ou.underOdds));
    if(hc && hc.full) parts.push("hc:"+norm(hc.line)+":"+f(hc.a)+":"+f(hc.b));
    return parts.join("|");
  })();

  return {
    id: Math.random().toString(36).slice(2),
    raw,
    teams,
    is3,
    mainOdds: main.odds,
    mainOver,
    mainMarginPct,
    ou,
    hc,
    conf,
    method: main.method || "",
    warn,
    extra,
    sig
  };
}


function fmtOddsArr(arr){
  return (arr||[]).map(x=>Number(x).toFixed(2)).join(" / ");
}

function confLabel(c){
  if(c === "high") return "ë†’ìŒ";
  if(c === "mid") return "ì¤‘ê°„";
  return "ë‚®ìŒ";
}

function renderPasteList(games){
  const wrap = $("pasteListWrap");
  const list = $("pasteList");
  const meta = $("pasteListMeta");
  if(!wrap || !list) return;

  __PASTE_MULTI = games || [];
  if(!__PASTE_MULTI.length){
    wrap.style.display = "none";
    list.innerHTML = "";
    if(meta) meta.textContent = "";
    return;
  }

  wrap.style.display = "block";
  if(meta) meta.textContent = `${__PASTE_MULTI.length}ê°œ ê°ì§€ Â· ${isPasteChainMode()?"í´ë¦­=ì—°ì† ì €ì¥":"í´ë¦­=ì›ë¬¸ í† ê¸€"} Â· ë²„íŠ¼ìœ¼ë¡œ ì¦‰ì‹œ ì ìš© ê°€ëŠ¥`;

  const view = __PASTE_MULTI.map((g, idx)=>({g, idx}));
  if(__PASTE_SORT==="margin"){
    view.sort((a,b)=>{
      const ma = (typeof a.g.mainMarginPct==="number") ? a.g.mainMarginPct : 9999;
      const mb = (typeof b.g.mainMarginPct==="number") ? b.g.mainMarginPct : 9999;
      return ma-mb;
    });
  }

  list.innerHTML = view.map(({g, idx})=>{
    const title = g.teams ? safeText(g.teams) : `ê²½ê¸° ${idx+1}`;
    const mainTxt = g.is3 ? `ë©”ì¸(3): ${fmtOddsArr(g.mainOdds)}` : `ë©”ì¸(2): ${fmtOddsArr(g.mainOdds)}`;
    const chips = [];
    // ì˜ˆìƒ ë§ˆì§„(ë©”ì¸)
    if(typeof g.mainMarginPct==="number"){
      const íŒì • = classifyMargin(val("sport"), "main", g.mainMarginPct);
      chips.push(`<span class="paste-chip ${íŒì •.cls==="ok"?"ok":(íŒì •.cls==="mid"?"warn":"warn")}">ì˜ˆìƒ ${safeText(íŒì •.label)}</span>`);
    }
    chips.push(`<span class="paste-chip ${g.warn?"warn":"ok"}">ì •í™•ë„ ${confLabel(g.conf)}</span>`);
    if(g.extra) chips.push(`<span class="paste-chip warn">ì¶”ê°€ ìˆ«ì ${g.extra}ê°œ</span>`);
    if(g.ou && g.ou.full) chips.push(`<span class="paste-chip ok">OU ${g.ou.line!=null?g.ou.line:""} Â· ${Number(g.ou.overOdds).toFixed(2)}/${Number(g.ou.underOdds).toFixed(2)}</span>`);
    if(g.hc && g.hc.full) chips.push(`<span class="paste-chip ok">í•¸ë”” ${g.hc.line} Â· ${Number(g.hc.a).toFixed(2)}/${Number(g.hc.b).toFixed(2)}</span>`);
    return `
      <div class="paste-item" id="pasteItem_${idx}">
        <div class="left" onclick="onPasteItemClick(${idx})">
          <div class="t">${title}</div>
          <div class="s">${safeText(mainTxt)}</div>
          <div class="chips">${chips.join("")}</div>
          <div class="paste-raw">${safeText(g.raw)}</div>
        </div>
        <div class="right">
          <div class="btns">
            <button class="btn primary mini" type="button" onclick="applyParsedGame(${idx}, true, false); event.stopPropagation();">ì ìš©+ê³„ì‚°</button>
            <button class="btn secondary mini" type="button" onclick="applyParsedGame(${idx}, false, false); event.stopPropagation();">ì ìš©ë§Œ</button>
            <button class="btn ghost mini" type="button" onclick="togglePasteItem(${idx}); event.stopPropagation();">ì›ë¬¸</button>
          </div>
          <div class="paste-stat" id="pasteStat_${idx}" style="display:none;"></div>
        </div>
      </div>
    `;
  }).join("");

  // ì´ë¯¸ ì €ì¥ëœ í•­ëª© í‘œì‹œ
  try{ if(__PASTE_SAVED_SIGS.size===0) buildSavedSigSet(); }catch(e){}
  try{
    __PASTE_MULTI.forEach((g, idx)=>{
      if(!g) return;
      if(pasteAlreadySaved(g)){
        const el = $("pasteItem_"+idx);
        if(el) el.classList.add("is-saved");
        const stat = $("pasteStat_"+idx);
        if(stat){ stat.innerHTML = "ì €ì¥ë¨"; stat.style.display="block"; }
      }
    });
  }catch(e){}
}

function togglePasteItem(idx){
  const el = $(`pasteItem_${idx}`);
  if(!el) return;
  el.classList.toggle("is-open");
}

function clearPasteList(){
  __PASTE_MULTI = [];
  const wrap = $("pasteListWrap");
  const list = $("pasteList");
  const meta = $("pasteListMeta");
  if(list) list.innerHTML = "";
  if(meta) meta.textContent = "";
  if(wrap) wrap.style.display = "none";
  try{ track("paste_multi_clear", {}); }catch(e){}
}

function parsePasteMulti(){
  const raw = val("pasteInput");
  const t = normalizePasteTextMulti(raw);
  if(!t){
    setPasteBadge("", "í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ì–´ì¤˜.");
    return;
  }
  const blocks = splitPasteBlocks(t);
  const games = [];
  for(const b of blocks){
    const g = parseGameBlock(b);
    if(g) games.push(g);
  }
  if(!games.length){
    // í”í•œ ì˜¤ì…ë ¥: í™•ë¥ (%) ë˜ëŠ” ë°°ë‹¹ì´ ì•„ë‹Œ ìˆ«ìë§Œ í¬í•¨
    if(/%|í¼ì„¼íŠ¸|í™•ë¥ /i.test(t)){
      setPasteBadge("", "í™•ë¥ (%)ì´ ì•„ë‹ˆë¼ ë°°ë‹¹(1.85 ê°™ì€ ê°’)ì´ í•„ìš”í•´.");
    }else{
      setPasteBadge("", "ê²½ê¸°ë¥¼ ì°¾ì§€ ëª»í–ˆì–´. (íŒ€ vs íŒ€ + ë°°ë‹¹ ìˆ«ì í¬í•¨ í•„ìš”)");
    }
    const hint = $("pasteHint");
    if(hint) hint.innerText = "íŒ: ê° ê²½ê¸°ë§ˆë‹¤ â€˜íŒ€A vs íŒ€Bâ€™ ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•´ì¤˜. ìˆ«ìë§Œ ìˆì–´ë„ ë¼ìš”. ì˜ˆ: ë§¨ì‹œí‹° vs ë¦¬ë²„í’€ 1.85 3.40 4.20";
    renderPasteList([]);
    return;
  }
  setPasteBadge(`${games.length}ê²½ê¸° ê°ì§€ë¨`, "");
  const hint = $("pasteHint");
  if(hint) hint.innerText = "ë¦¬ìŠ¤íŠ¸ì—ì„œ ê²½ê¸° ì„ íƒ â†’ ìë™ ì…ë ¥(ì„ íƒ: ê³„ì‚°). ì •í™•ë„ ë‚®ìŒ í‘œì‹œê°€ ëœ¨ë©´ ì ìš© í›„ ìˆ«ìë§Œ í•œ ë²ˆ í™•ì¸!";
  renderPasteList(games);
  try{ track("paste_multi_parse", { count: games.length, main: (SPORT_CFG[val("sport")]||SPORT_CFG.soccer).main }); }catch(e){}
}

function isPasteChainMode(){ const el=$("pasteChainMode"); return el ? el.checked : false; }
function isPasteSkipLow(){ const el=$("pasteSkipLow"); return el ? el.checked : false; }
function getPasteChainCount(){ const el=$("pasteChainCount"); const n = el ? parseInt(el.value,10) : 10; return (isFinite(n)&&n>0)? Math.min(30, Math.max(1,n)) : 10; }

function buildSavedSigSet(){
  try{
    const norm = (x)=>String(x??"").toLowerCase().replace(/\s+/g,"");
    const f = (n)=>{ const v=Number(n); return Number.isFinite(v)?v.toFixed(4):""; };
    const arr = readHistory();
    for(const h of arr){
      if(!h) continue;
      if(h.sig){ __PASTE_SAVED_SIGS.add(h.sig); continue; }
      // êµ¬ë²„ì „ íˆìŠ¤í† ë¦¬(ì‹œê·¸ë‹ˆì²˜ ì—†ë˜ ì‹œì ˆ)ë„ ìµœëŒ€í•œ ë³µì›
      try{
        const mode = h.mainMode ? h.mainMode : (((SPORT_CFG[h.sport]||SPORT_CFG.soccer).main==="3way") ? "3way" : "2way");
        const parts=[norm(h.sport), mode, norm(h.teams)];
        if(mode==="3way"){
          parts.push(f(h.inputs?.main3OddsH), f(h.inputs?.main3OddsD), f(h.inputs?.main3OddsA));
        }else{
          parts.push(f(h.inputs?.main2OddsA), f(h.inputs?.main2OddsB));
        }
        if(h.inputs?.totalLine) parts.push("ou:"+norm(h.inputs.totalLine)+":"+f(h.inputs.overOdds)+":"+f(h.inputs.underOdds));
        if(h.inputs?.handicapLine) parts.push("hc:"+norm(h.inputs.handicapLine)+":"+f(h.inputs.handicapOddsA)+":"+f(h.inputs.handicapOddsB));
        __PASTE_SAVED_SIGS.add(parts.join("|"));
      }catch(e){}
    }
  }catch(e){}
}

function setPasteItemSaved(idx, record){
  const g = __PASTE_MULTI[idx];
  if(!g) return;
  g.__saved = true;
  if(record && record.sig) __PASTE_SAVED_SIGS.add(record.sig);
  const el = $("pasteItem_"+idx);
  if(el) el.classList.add("is-saved");
  const stat = $("pasteStat_"+idx);
  if(stat){
    const m = (record && record.markets && record.markets.main && typeof record.markets.main.marginPct==="number") ? record.markets.main.marginPct : (typeof g.mainMarginPct==="number" ? g.mainMarginPct : null);
    const ev = (record && typeof record.bestEVPct==="number") ? record.bestEVPct : null;
    const parts = [];
    if(m!=null) parts.push(`ë§ˆì§„ <b>${m.toFixed(2)}%</b>`);
    if(ev!=null) parts.push(`EV <b>${(ev>=0?"+":"-")}${Math.abs(ev).toFixed(2)}%</b>`);
    stat.innerHTML = `ì €ì¥ë¨ Â· ${parts.join(" Â· ")}`;
    stat.style.display = "block";
  }
  // ì—°ì† ì €ì¥/í´ë¦­ ì €ì¥ìœ¼ë¡œ ì €ì¥ëœ ê²½ìš°: ì˜¤ëŠ˜ ìˆ˜ì§‘ ë¬¶ìŒì—ë„ ëˆ„ì 
  try{
    if(record && (isPasteChainMode() || __PASTE_CHAIN_RUNNING)){
      pushChainPackFromRecord(record);
    }
  }catch(e){}

}

function pasteAlreadySaved(g){
  if(!g) return false;
  if(g.__saved) return true;
  if(g.sig && __PASTE_SAVED_SIGS.has(g.sig)) return true;
  return false;
}

function applyParsedGame(idx, autoCalc, keepView){
  const g = __PASTE_MULTI[idx];
  if(!g) return;

  // ì—°ì† ì €ì¥(ë˜ëŠ” ë§í¬ ë³µì›) ì‹œ: ë©”ì¸ íƒ€ì… ì˜¤ë²„ë¼ì´ë“œ ë°˜ì˜
  try{ setMainModeOverride(g.is3 ? "3way" : "2way"); }catch(e){}

  // íŒ€ëª… ë°˜ì˜
  try{ if(g.teams) setVal("teams", g.teams); }catch(e){}

  const is3 = g.is3;
  if(is3){
    setVal("main3OddsH", String(g.mainOdds[0]));
    setVal("main3OddsD", String(g.mainOdds[1]));
    setVal("main3OddsA", String(g.mainOdds[2]));
  }else{
    setVal("main2OddsA", String(g.mainOdds[0]));
    setVal("main2OddsB", String(g.mainOdds[1]));
  }

  if(g.ou && g.ou.full){
    if(g.ou.line != null) setVal("totalLine", String(g.ou.line));
    if(g.ou.overOdds != null) setVal("overOdds", String(g.ou.overOdds));
    if(g.ou.underOdds != null) setVal("underOdds", String(g.ou.underOdds));
  }
  if(g.hc && g.hc.full){
    setVal("handicapLine", String(g.hc.line));
    setVal("handicapOddsA", String(g.hc.a));
    setVal("handicapOddsB", String(g.hc.b));
  }

  // OU/í•¸ë”” ê°ì§€ ì‹œ ë ˆë²¨ ìë™ ì „í™˜ ì˜µì…˜
  const wantsAutoLevel = (function(){ const el=$("pasteAutoLevel"); return el ? el.checked : false; })();
  if(wantsAutoLevel && val("level") === "simple" && ((g.ou && g.ou.full) || (g.hc && g.hc.full))){
    setVal("level", "mid");
    onLevelChange(true);
  }

  try{ prefillLineCompare(); }catch(e){}
  hideResult();
  renderMarginDash();
  saveState();

  try{ track("paste_multi_apply", { idx, auto_calc: autoCalc?1:0, keep_view: keepView?1:0, conf: g.conf, has_ou: g.ou&&g.ou.full?1:0, has_hc: g.hc&&g.hc.full?1:0 }); }catch(e){}

  if(autoCalc){
    try{ calc(); }catch(e){}
    // calc() ì•ˆì—ì„œ íˆìŠ¤í† ë¦¬ ì €ì¥ê¹Œì§€ ìˆ˜í–‰ë¨
    try{ setPasteItemSaved(idx, LAST_RECORD); }catch(e){}
    if(!keepView){
      try{ quickJump('result'); }catch(e){}
    }
  }else{
    if(!keepView){
      try{ quickJump('main'); }catch(e){}
    }
  }
}

function onPasteItemClick(idx){
  const g = __PASTE_MULTI[idx];
  if(!g) return;
  if(isPasteChainMode()){
    if(isPasteSkipLow() && g.conf==="low"){
      toast("ì •í™•ë„ ë‚®ìŒ í•­ëª©ì€ ì œì™¸ ì„¤ì •ì´ì—ìš”.");
      return;
    }
    if(pasteAlreadySaved(g)){
      setPasteItemSaved(idx, null);
      toast("ì´ë¯¸ ì €ì¥ëœ í•­ëª©ì´ì—ìš”.");
      return;
    }
    applyParsedGame(idx, true, true);
    return;
  }
  togglePasteItem(idx);
}

function startChainSave(){
  if(__PASTE_CHAIN_RUNNING){
    toast("ì´ë¯¸ ì—°ì† ì €ì¥ ì¤‘ì´ì—ìš”.");
    return;
  }
  if(!__PASTE_MULTI.length){
    toast("ë¨¼ì € 'ì—¬ëŸ¬ ê²½ê¸° ë§Œë“¤ê¸°'ë¡œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ì¤˜.");
    return;
  }
  if(__PASTE_SAVED_SIGS.size===0) buildSavedSigSet();

  const n = getPasteChainCount();
  __PASTE_CHAIN_RUNNING = true;
  __PASTE_CHAIN_ABORT = false;
  const stopBtn = $("pasteChainStop");
  if(stopBtn) stopBtn.style.display = "inline-flex";

  // í˜„ì¬ ì •ë ¬ ê¸°ì¤€ìœ¼ë¡œ ì¸ë±ìŠ¤ ëª©ë¡ ìƒì„±
  const view = __PASTE_MULTI.map((g,i)=>({g,i}));
  if(__PASTE_SORT==="margin"){
    view.sort((a,b)=>{
      const ma = (typeof a.g.mainMarginPct==="number") ? a.g.mainMarginPct : 9999;
      const mb = (typeof b.g.mainMarginPct==="number") ? b.g.mainMarginPct : 9999;
      return ma-mb;
    });
  }
  let targets = view.map(x=>x.i);

  // ì •í™•ë„ ë‚®ìŒ ì œì™¸(ì˜µì…˜)
  if(isPasteSkipLow()){
    targets = targets.filter(i => __PASTE_MULTI[i] && __PASTE_MULTI[i].conf!=="low");
  }
  // ì´ë¯¸ ì €ì¥ëœ ê²ƒ ì œì™¸
  targets = targets.filter(i => !pasteAlreadySaved(__PASTE_MULTI[i]));

  const total = Math.min(n, targets.length);
  if(total<=0){
    toast("ì €ì¥í•  í•­ëª©ì´ ì—†ì–´ìš”. (ì´ë¯¸ ì €ì¥ë¨/ì •í™•ë„ ë‚®ìŒ ì œì™¸)");
    __PASTE_CHAIN_RUNNING = false;
    if(stopBtn) stopBtn.style.display = "none";
    return;
  }

  const meta = $("pasteListMeta");
  let done = 0;

  const step = ()=>{
    if(__PASTE_CHAIN_ABORT){
      __PASTE_CHAIN_RUNNING = false;
      if(stopBtn) stopBtn.style.display = "none";
      if(meta) meta.textContent = `ì—°ì† ì €ì¥ ì¤‘ì§€ë¨ Â· ${done}/${total} ì €ì¥`;
      toast(`ì—°ì† ì €ì¥ ì¤‘ì§€ (${done}/${total})`);
      return;
    }
    if(done >= total){
      __PASTE_CHAIN_RUNNING = false;
      if(stopBtn) stopBtn.style.display = "none";
      if(meta) meta.textContent = `ì—°ì† ì €ì¥ ì™„ë£Œ Â· ${done}/${total} ì €ì¥`;
      toast(`ì—°ì† ì €ì¥ ì™„ë£Œ (${done}/${total})`);
      try{ track("paste_chain_done", { done, total }); }catch(e){}
      return;
    }
    const idx = targets[done];
    if(meta) meta.textContent = `ì—°ì† ì €ì¥ ì¤‘... ${done+1}/${total}`;
    applyParsedGame(idx, true, true); // keepView=true
    done += 1;
    // UI/ìŠ¤í† ë¦¬ì§€ ë°˜ì˜ ì—¬ìœ 
    setTimeout(step, 140);
  };

  try{ track("paste_chain_start", { target_total: total, requested: n, sort: __PASTE_SORT }); }catch(e){}
  step();
}

function stopChainSave(){
  if(!__PASTE_CHAIN_RUNNING){
    toast("ì§„í–‰ ì¤‘ì¸ ì—°ì† ì €ì¥ì´ ì—†ì–´ìš”.");
    return;
  }
  __PASTE_CHAIN_ABORT = true;
  try{ track("paste_chain_stop", {}); }catch(e){}
}

function togglePasteSort(){
  __PASTE_SORT = (__PASTE_SORT==="margin") ? "input" : "margin";
  const btns = document.querySelectorAll('.paste-list-tools .btn.ghost.mini');
  // ì²« ë²„íŠ¼ í…ìŠ¤íŠ¸ë§Œ ë°”ê¿ˆ
  try{
    const head = document.querySelector('.paste-list-tools .btn.ghost.mini');
    if(head) head.textContent = (__PASTE_SORT==="margin") ? "ì •ë ¬: ì…ë ¥ìˆœ" : "ì •ë ¬: ë§ˆì§„ ë‚®ì€ìˆœ";
  }catch(e){}
  renderPasteList(__PASTE_MULTI);
}


function pct(x){ return (x*100).toFixed(1) + "%"; }
function money(x){
  const n = Math.round(x);
  return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "ì›";
}
function expectedValue(stake, p, odds){
  return stake * (p*(odds-1) - (1-p));
}
function quarterKelly(p, odds){
  const b = odds - 1;
  const f = (p*odds - 1) / b;
  const q = f/4;
  return Math.max(0, Math.min(0.25, q));
}

/* 2-way + í‘¸ì‹œ ê·¼ì‚¬ (ì•„ì‹œì•ˆ ë¼ì¸) */
function compute2Way(oddsA, oddsB, pushP){ // pushP: 0~1
  const ia=1/oddsA, ib=1/oddsB;
  const sum = ia+ib;
  const push = Math.max(0, Math.min(0.35, pushP || 0)); // ì•ˆì „ë²”ìœ„
  const factor = (1 - push);
  const pA = (ia/sum) * factor;
  const pB = (ib/sum) * factor;
  const overAdj = sum / factor;          // push í¬í•¨ ë³´ì • ì˜¤ë²„ë¼ìš´ë“œ
  const marginPct = (overAdj - 1) * 100; // %
  return { over: overAdj, marginPct, probs:[pA,pB], push };
}

/* 3-way */
function compute3Way(odds1,odds2,odds3){
  const i1=1/odds1, i2=1/odds2, i3=1/odds3;
  const over=i1+i2+i3;
  const p1=i1/over, p2=i2/over, p3=i3/over;
  const marginPct=(over-1)*100;
  return { over, marginPct, probs:[p1,p2,p3] };
}

function classifyMargin(sport, type, marginPct){
  const rule = (MARGIN_RULE[sport] || MARGIN_RULE.soccer)[type] || [5,7,9];
  const [low, mid, high] = rule;
  if(marginPct <= low) return { label:`ë§ˆì§„ ë‚®ìŒ (${marginPct.toFixed(2)}%)`, cls:"ok" };
  if(marginPct <= mid) return { label:`ë³´í†µ (${marginPct.toFixed(2)}%)`, cls:"mid" };
  if(marginPct <= high) return { label:`ì£¼ì˜ (${marginPct.toFixed(2)}%)`, cls:"mid" };
  return { label:`ê³ ë§ˆì§„ (${marginPct.toFixed(2)}%)`, cls:"bad" };
}
function clsToTextColor(cls){
  if(cls==="ok") return "good";
  if(cls==="mid") return "mid";
  return "warn";
}

/* =========================
   +EV í”Œë˜ê·¸ ì €ì¥ (index ìë™í•„í„°ìš©)
========================= */
function setEvFlag(isPositive){
  const d = todayStr();
  localStorage.setItem("88_ev_date", d);
  localStorage.setItem("88_ev_positive", isPositive ? "1" : "0");
}

/* =========================
   ê³„ì‚° ë©”ì¸ (ê¸°ì¡´ ê¸°ëŠ¥ 100% ìœ ì§€ + í™•ì¥)
========================= */
function levelLabel(level){
  return level==="simple" ? "ê°„ë‹¨" : (level==="mid" ? "ì¤‘ê¸‰" : "ê³ ê¸‰");
}

function calc(){
  const sport = val("sport");
  const level = val("level");
  const cfg = SPORT_CFG[sport] || SPORT_CFG.soccer;
  const is3 = (effectiveMainMode(cfg) === "3way");

  const rows = [];
  const copyLines = [];
  copyLines.push(`[88 ì»¤ë®¤ë‹ˆí‹°] ${cfg.name} ë¶„ì„ (${levelLabel(level)})`);

  const league = val("league").trim();
  const teams  = val("teams").trim();
  if(league) copyLines.push(`ë¦¬ê·¸: ${league}`);
  if(teams)  copyLines.push(`ê²½ê¸°: ${teams}`);

  // ê²°ê³¼/íˆìŠ¤í† ë¦¬ìš© ë©”íƒ€
  const record = {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2,7),
    date: todayStr(),
    time: nowTimeStr(),
    sport, level, league, teams,
    mainMode: (effectiveMainMode(cfg) === "3way") ? "3way" : "2way",
    inputs:{},
    markets:{},
    evPositive:false,
    bestEVPct:null
  };

  // GA: ë¶„ì„ ì‹œì‘
  try{
    track("analysis_start", {
      sport,
      level,
      market_type: (is3 ? "3way" : "2way"),
      odds_count: (is3 ? 3 : 2),
      has_league: !!league,
      has_teams: !!teams
    });
  }catch(e){}


  // ---- ë©”ì¸ ----
  let mainMargin = null;
  let mainOver = null;
  let mainProbs = null;

  if(!is3){
    const a = parseOdds(val("main2OddsA"));
    const b = parseOdds(val("main2OddsB"));
    if(a==null || b==null){ clearInvalid(); markInvalid(["main2OddsA","main2OddsB"]); return showError("ë©”ì¸ ë°°ë‹¹ì„ 1.01 ì´ìƒ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜."); }

    const out = compute2Way(a,b,0);
    mainOver = out.over;
    mainMargin = out.marginPct;
    mainProbs = out.probs;

    const L2 = labels2Way(cfg);
    rows.push([`ìŠ¹ë¦¬ í™•ë¥ (ë°°ë‹¹ ê¸°ë°˜Â·ì¶”ì •, ${L2.A})`, pct(out.probs[0])]);
    rows.push([`ìŠ¹ë¦¬ í™•ë¥ (ë°°ë‹¹ ê¸°ë°˜Â·ì¶”ì •, ${L2.B})`, pct(out.probs[1])]);
    rows.push(["ì˜¤ë²„ë¼ìš´ë“œ(ë§ˆì§„ ì¶”ì •)", out.over.toFixed(4)]);

    const íŒì • = classifyMargin(sport,"main",out.marginPct);
    rows.push(["ë©”ì¸ ë§ˆì§„ íŒì •", `<span class="${clsToTextColor(íŒì •.cls)}">${íŒì •.label}</span>`]);

    const L2b = labels2Way(cfg);
    copyLines.push(`ë©”ì¸ ë°°ë‹¹(${L2b.A}/${L2b.B}): ${a} / ${b}`);

    record.inputs.main2OddsA = val("main2OddsA");
    record.inputs.main2OddsB = val("main2OddsB");
    record.markets.main = { over: out.over, marginPct: out.marginPct };

    if(level !== "simple"){
      const myP = parsePct(val("myProb"));
      const stake = parseMoney(val("stake"));

      if(myP!=null){
        const evPer1 = (myP*(a-1) - (1-myP));
        rows.push([`ë‚´ ì˜ˆìƒ í™•ë¥ (${cfg.labels.A})`, pct(myP)]);
        rows.push(["EV(1ì›ë‹¹)", (evPer1*100).toFixed(2) + "%"]);
        copyLines.push(`ë‚´ ì˜ˆìƒ í™•ë¥ (${cfg.labels.A}): ${(myP*100).toFixed(1)}%`);
        if(stake!=null){
          rows.push(["ê¸°ëŒ€ê°’(EV)", money(expectedValue(stake, myP, a))]);
          copyLines.push(`ë² íŒ…ê¸ˆ: ${money(stake)}`);
        }
        if(level === "adv"){
          const k = quarterKelly(myP, a);
          rows.push(["ê¶Œì¥ ë¹„ì¤‘(ë³´ìˆ˜ì  1/4 Kelly)", (k*100).toFixed(1) + "%"]);
        }
        rows.push(["íŒë‹¨", evPer1>0 ? "ë°¸ë¥˜(+EV) ê°€ëŠ¥ì„±" : "ë°¸ë¥˜(-EV) ê°€ëŠ¥ì„±"]);

        record.bestEVPct = evPer1*100;
        record.evPositive = evPer1>0;
        setEvFlag(record.evPositive);
      }else{
        rows.push(["Tip", "ì¤‘ê¸‰/ê³ ê¸‰ì—ì„œëŠ” 'ë‚´ ì˜ˆìƒ í™•ë¥ 'ì„ ì…ë ¥í•˜ë©´ EVê°€ ê³„ì‚°ë©ë‹ˆë‹¤. (ì„ íƒì‚¬í•­)"]);
        setEvFlag(false);
      }
    }else{
      setEvFlag(false);
    }
  }else{
    const h = parseOdds(val("main3OddsH"));
    const d = parseOdds(val("main3OddsD"));
    const a = parseOdds(val("main3OddsA"));
    if(h==null || d==null || a==null){ clearInvalid(); markInvalid(["main3OddsH","main3OddsD","main3OddsA"]); return showError("ë©”ì¸ ë°°ë‹¹(í™ˆ/ë¬´/ì›ì •)ì„ 1.01 ì´ìƒ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜."); }

    const out = compute3Way(h,d,a);
    mainOver = out.over;
    mainMargin = out.marginPct;
    mainProbs = out.probs;

    rows.push([`ìŠ¹ë¦¬ í™•ë¥ (ë°°ë‹¹ ê¸°ë°˜Â·ì¶”ì •, ${cfg.labels.H})`, pct(out.probs[0])]);
    rows.push([`ìŠ¹ë¦¬ í™•ë¥ (ë°°ë‹¹ ê¸°ë°˜Â·ì¶”ì •, ${cfg.labels.D})`, pct(out.probs[1])]);
    rows.push([`ìŠ¹ë¦¬ í™•ë¥ (ë°°ë‹¹ ê¸°ë°˜Â·ì¶”ì •, ${cfg.labels.A})`, pct(out.probs[2])]);
    rows.push(["ì˜¤ë²„ë¼ìš´ë“œ(ë§ˆì§„ ì¶”ì •)", out.over.toFixed(4)]);

    const íŒì • = classifyMargin(sport,"main",out.marginPct);
    rows.push(["ë©”ì¸ ë§ˆì§„ íŒì •", `<span class="${clsToTextColor(íŒì •.cls)}">${íŒì •.label}</span>`]);

    copyLines.push(`ë©”ì¸ ë°°ë‹¹(${cfg.labels.H}/${cfg.labels.D}/${cfg.labels.A}): ${h} / ${d} / ${a}`);

    record.inputs.main3OddsH = val("main3OddsH");
    record.inputs.main3OddsD = val("main3OddsD");
    record.inputs.main3OddsA = val("main3OddsA");
    record.markets.main = { over: out.over, marginPct: out.marginPct };

    if(level !== "simple"){
      const my = parsePctList(val("myProb"));
      const stake = parseMoney(val("stake"));

      if(my){
        const evH = (my[0]*(h-1) - (1-my[0]));
        const evD = (my[1]*(d-1) - (1-my[1]));
        const evA = (my[2]*(a-1) - (1-my[2]));

        rows.push([`ë‚´ ì˜ˆìƒ í™•ë¥ (${cfg.labels.H}/${cfg.labels.D}/${cfg.labels.A})`,
          `${pct(my[0])} / ${pct(my[1])} / ${pct(my[2])}`]);

        rows.push(["EV(í™ˆ/ë¬´/ì›ì •, 1ì›ë‹¹)", `${(evH*100).toFixed(2)}% / ${(evD*100).toFixed(2)}% / ${(evA*100).toFixed(2)}%`]);

        const best = [
          {k:cfg.labels.H, ev:evH, odds:h, p:my[0]},
          {k:cfg.labels.D, ev:evD, odds:d, p:my[1]},
          {k:cfg.labels.A, ev:evA, odds:a, p:my[2]}
        ].sort((x,y)=>y.ev-x.ev)[0];

        rows.push(["ê°€ì¥ ë†’ì€ EV", `${best.k} (${(best.ev*100).toFixed(2)}%)`]);
        if(stake!=null) rows.push(["ê¸°ëŒ€ê°’(EV, ìµœê³  EV ê¸°ì¤€)", money(expectedValue(stake, best.p, best.odds))]);

        if(level === "adv"){
          rows.push(["ê¶Œì¥ ë¹„ì¤‘(ë³´ìˆ˜ì  1/4 Kelly, ìµœê³  EV ê¸°ì¤€)", (quarterKelly(best.p, best.odds)*100).toFixed(1) + "%"]);
        }
        rows.push(["íŒë‹¨", best.ev>0 ? "ë°¸ë¥˜(+EV) ê°€ëŠ¥ì„±" : "ë°¸ë¥˜(-EV) ê°€ëŠ¥ì„±"]);

        record.bestEVPct = best.ev*100;
        record.evPositive = best.ev>0;
        setEvFlag(record.evPositive);

        copyLines.push(`ë‚´ ì˜ˆìƒ í™•ë¥ : ${(my[0]*100).toFixed(1)}% / ${(my[1]*100).toFixed(1)}% / ${(my[2]*100).toFixed(1)}%`);
        if(stake!=null) copyLines.push(`ë² íŒ…ê¸ˆ: ${money(stake)}`);
      }else{
        rows.push(["Tip", "ì¤‘ê¸‰/ê³ ê¸‰ì—ì„œëŠ” ë‚´ ì˜ˆìƒ í™•ë¥ (ì˜ˆ: 45,28,27)ì„ ì…ë ¥í•˜ë©´ EVê°€ ê³„ì‚°ë©ë‹ˆë‹¤. (ì„ íƒì‚¬í•­)"]);
        setEvFlag(false);
      }
    }else{
      setEvFlag(false);
    }
  }

  // ---- ê³µìœ ìš© í•œ ì¤„ ìš”ì•½(+ ê³µì •ë°°ë‹¹) ----
  try{
    if(typeof mainMargin === "number" && mainProbs && mainProbs.length){
      const labels = is3
        ? [cfg.labels.H||"H", cfg.labels.D||"D", cfg.labels.A||"A"]
        : [cfg.labels.A||"A", cfg.labels.B||"B"];
      const fair = mainProbs.map(p=> (p>0 ? (1/p) : null));
      const fairText = fair.map(o=> (o && isFinite(o) ? o.toFixed(2) : "-")).join(" / ");
      const evText = (typeof record.bestEVPct !== "number") ? "EV ë¯¸ì…ë ¥" : (record.bestEVPct>0 ? "+EV ê°€ëŠ¥" : "-EV ê°€ëŠ¥");
      LAST_ONE_LINE = `ìš”ì•½: ë§ˆì§„ ${mainMargin.toFixed(1)}% Â· ê³µì •ë°°ë‹¹(${labels.join("/")}) ${fairText} Â· ${evText}`;
      copyLines.push(LAST_ONE_LINE);
    }else{
      LAST_ONE_LINE = "";
    }
  }catch(e){ LAST_ONE_LINE = ""; }

  // ---- ì˜¤ë²„ì–¸ë” (2-way + í‘¸ì‹œ ê·¼ì‚¬) ----
  let ouMargin = null;
  const tLine = val("totalLine").trim();
  const oOdds = parseOdds(val("overOdds"));
  const uOdds = parseOdds(val("underOdds"));
  const myOver = parsePct(val("myOverProb"));
  const ouPushPct = parsePct(val("ouPush")) ?? null; // ì…ë ¥ ê°’ì´ %ì´ë©´ parsePctê°€ 0~1ë¡œ
  // parsePct expects 0~100; but we want % input; ok

  if(tLine && oOdds!=null && uOdds!=null){
    // í‘¸ì‹œ í™•ë¥ : ì…ë ¥ê°’ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì¢…ëª© ê¸°ë³¸ê°’
    let push = ouPushPct;
    if(push==null){
      const cfg2 = SPORT_CFG[sport] || SPORT_CFG.soccer;
      push = (cfg2.defaults.ouPush || 0) / 100;
    }
    const outOU = compute2Way(oOdds, uOdds, push);
    ouMargin = outOU.marginPct;

    rows.push([`ì˜¤ë²„/ì–¸ë”(ê¸°ì¤€ ${tLine}) ìŠ¹ë¦¬ í™•ë¥ (ë°°ë‹¹ ê¸°ë°˜Â·ì¶”ì •)`,
      `ì˜¤ë²„ ${pct(outOU.probs[0])} / ì–¸ë” ${pct(outOU.probs[1])}${outOU.push>0?` / í‘¸ì‹œ ${(outOU.push*100).toFixed(1)}%`:``}`]);
    rows.push([`ì˜¤ë²„/ì–¸ë” ì˜¤ë²„ë¼ìš´ë“œ(ë³´ì •)`, outOU.over.toFixed(4)]);
    const íŒì •OU = classifyMargin(sport,"ou",outOU.marginPct);
    rows.push([`ì˜¤ë²„/ì–¸ë” ë§ˆì§„ íŒì •`, `<span class="${clsToTextColor(íŒì •OU.cls)}">${íŒì •OU.label}</span>`]);

    copyLines.push(`ì˜¤ë²„ì–¸ë” ${tLine}: ì˜¤ë²„ ${oOdds} / ì–¸ë” ${uOdds}${outOU.push>0?` (í‘¸ì‹œ ê·¼ì‚¬ ${ (outOU.push*100).toFixed(1)}%)`:``}`);

    record.inputs.totalLine = val("totalLine");
    record.inputs.overOdds = val("overOdds");
    record.inputs.underOdds = val("underOdds");
    record.inputs.ouPush = val("ouPush");
    record.markets.ou = { over: outOU.over, marginPct: outOU.marginPct, push: outOU.push };

    if(level === "adv" && myOver!=null){
      const stake = parseMoney(val("stake")) || null;
      // í‘¸ì‹œ í¬í•¨ EV: EV = pWin*(odds-1) - pLose + pPush*0
      const pWin = myOver;
      const pPush = outOU.push; // ê·¼ì‚¬
      const pLose = Math.max(0, 1 - pWin - pPush);
      const evPer1 = (pWin*(oOdds-1) - pLose);

      rows.push([`ë‚´ ì˜ˆìƒ í™•ë¥ (ì˜¤ë²„)`, pct(myOver)]);
      rows.push([`ì˜¤ë²„ EV(1ì›ë‹¹, í‘¸ì‹œ ê·¼ì‚¬)`, (evPer1*100).toFixed(2) + "%"]);
      if(stake!=null) rows.push([`ì˜¤ë²„ ê¸°ëŒ€ê°’(EV)`, money(stake * evPer1)]);
      rows.push([`ì˜¤ë²„ ê¶Œì¥ ë¹„ì¤‘(1/4 Kelly, ì°¸ê³ )`, (quarterKelly(myOver, oOdds)*100).toFixed(1) + "%"]);
      rows.push([`ì˜¤ë²„ íŒë‹¨`, evPer1>0 ? "ë°¸ë¥˜(+EV) ê°€ëŠ¥ì„±" : "ë°¸ë¥˜(-EV) ê°€ëŠ¥ì„±"]);
    }
  }

  // ---- í•¸ë””ìº¡ (ì •ë°€ 2-way + í‘¸ì‹œ ê·¼ì‚¬) ----
  let hcMargin = null;
  const hLine = val("handicapLine").trim();
  const hOA = parseOdds(val("handicapOddsA"));
  const hOB = parseOdds(val("handicapOddsB"));
  const hcPushPct = parsePct(val("handicapPush")) ?? null;

  if(hLine && hOA!=null && hOB!=null){
    let push = hcPushPct;
    if(push==null){
      const cfg2 = SPORT_CFG[sport] || SPORT_CFG.soccer;
      push = (cfg2.defaults.hcPush || 0) / 100;
    }
    const outHC = compute2Way(hOA, hOB, push);
    hcMargin = outHC.marginPct;

    rows.push([`í•¸ë””ìº¡(ë¼ì¸ ${hLine}) ìŠ¹ë¦¬ í™•ë¥ (ë°°ë‹¹ ê¸°ë°˜Â·ì¶”ì •)`,
      `${cfg.labels.A||"A"} ${pct(outHC.probs[0])} / ${cfg.labels.B||"B"} ${pct(outHC.probs[1])}${outHC.push>0?` / í‘¸ì‹œ ${(outHC.push*100).toFixed(1)}%`:``}`]);
    rows.push([`í•¸ë””ìº¡ ì˜¤ë²„ë¼ìš´ë“œ(ë³´ì •)`, outHC.over.toFixed(4)]);
    const íŒì •HC = classifyMargin(sport,"hc",outHC.marginPct);
    rows.push([`í•¸ë””ìº¡ ë§ˆì§„ íŒì •`, `<span class="${clsToTextColor(íŒì •HC.cls)}">${íŒì •HC.label}</span>`]);

    copyLines.push(`í•¸ë”” ${hLine}: ${cfg.labels.A||"A"} ${hOA} / ${cfg.labels.B||"B"} ${hOB}${outHC.push>0?` (í‘¸ì‹œ ê·¼ì‚¬ ${ (outHC.push*100).toFixed(1)}%)`:``}`);

    record.inputs.handicapLine = val("handicapLine");
    record.inputs.handicapOddsA = val("handicapOddsA");
    record.inputs.handicapOddsB = val("handicapOddsB");
    record.inputs.handicapPush = val("handicapPush");
    record.markets.hc = { over: outHC.over, marginPct: outHC.marginPct, push: outHC.push };
  }

  // ---- ëŒ€ì‹œë³´ë“œ/íˆìŠ¤í† ë¦¬ ë°˜ì˜ ----
  // (í‘œí˜„/í†µê³„ìš©) í˜„ì¬ ê¸°ë¡ì˜ ë¶„ë¥˜ ë©”íƒ€ â€” ê³„ì‚° ë¡œì§ì—ëŠ” ì˜í–¥ ì—†ìŒ
  record.advice = adviceKeyFromMetrics(record.bestEVPct, record.markets?.main?.marginPct);
  record.sig = (function(){
    // ì…ë ¥ ì‹œê·¸ë‹ˆì²˜(ì¤‘ë³µ ë°©ì§€/ì—°ì† ì €ì¥ í‘œì‹œìš©) â€” ê³„ì‚°ê°’ì—ëŠ” ì˜í–¥ ì—†ìŒ
    const norm = (x)=>String(x??"").toLowerCase().replace(/\s+/g,"");
    const f2 = (n)=>{ const v = Number(n); return Number.isFinite(v) ? v.toFixed(4) : ""; };
    const parts = [];
    parts.push(norm(record.sport));
    parts.push(record.mainMode || "");
    parts.push(norm(record.teams));
    if(record.mainMode==="3way"){
      parts.push(f2(record.inputs.main3OddsH)); parts.push(f2(record.inputs.main3OddsD)); parts.push(f2(record.inputs.main3OddsA));
    }else{
      parts.push(f2(record.inputs.main2OddsA)); parts.push(f2(record.inputs.main2OddsB));
    }
    if(record.inputs.totalLine) parts.push("ou:"+norm(record.inputs.totalLine)+":"+f2(record.inputs.overOdds)+":"+f2(record.inputs.underOdds));
    if(record.inputs.handicapLine) parts.push("hc:"+norm(record.inputs.handicapLine)+":"+f2(record.inputs.handicapOddsA)+":"+f2(record.inputs.handicapOddsB));
    return parts.join("|");
  })();

  LAST_RECORD = record;

  renderResult(cfg.name, level, rows, copyLines);
  renderMarginDash({sport, main:mainMargin, ou:ouMargin, hc:hcMargin});


  // GA: ë¶„ì„ ì™„ë£Œ
  try{
    const p = {
      sport,
      level,
      market_type: (is3 ? "3way" : "2way"),
      odds_count: (is3 ? 3 : 2),
      ev_positive: record.evPositive ? 1 : 0
    };
    if (typeof mainMargin === "number") p.main_margin_pct = +mainMargin.toFixed(4);
    if (typeof mainOver === "number") p.main_overround = +mainOver.toFixed(6);
    if (typeof ouMargin === "number") p.ou_margin_pct = +ouMargin.toFixed(4);
    if (typeof hcMargin === "number") p.hc_margin_pct = +hcMargin.toFixed(4);
    if (typeof record.bestEVPct === "number") p.best_ev_pct = +record.bestEVPct.toFixed(4);
    track("analysis_complete", p);
  }catch(e){}

  // íˆìŠ¤í† ë¦¬ ì €ì¥
  addHistory(record);

  // TOP3 ê°±ì‹ 
  renderTop3();

  const st = saveState();
  maybePushSnapshot(st, true);
  renderSnaps();

  // ë¶„ì„ ì™„ë£Œ ì´í›„(1ì¼ 1íšŒ) ì¶”ì²œ íŒì—… ë…¸ì¶œ
  try{ maybeShowAdPopupAfterComplete(); }catch(e){}
}

/* =========================
   ê²°ê³¼ ë Œë”(ê¸°ì¡´ ìœ ì§€)
========================= */
function renderResult(sportName, level, rows, copyLines){
  const box = $("result");

  // ---- ìš”ì•½ ì¹´ë“œ(ìƒë‹¨) ë°ì´í„° ì¶”ì¶œ ----
  const clean = (x)=>String(x ?? "").replace(/<[^>]*>/g,"").trim();
  const num = (x)=>{
    const t = clean(x).replace(/,/g,"").replace("%","");
    const n = parseFloat(t);
    return Number.isFinite(n) ? n : null;
  };

  const overRow = rows.find(([k])=>k==="ì˜¤ë²„ë¼ìš´ë“œ(ë§ˆì§„ ì¶”ì •)");
  const over = overRow ? num(overRow[1]) : null;
  const marginPct = (over!=null) ? (over - 1) * 100 : null;

  // ë©”ì¸ ë§ˆì§„ íŒì •(ë¼ë²¨/ìƒ‰ìƒ) ì¶”ì¶œ
  let marginLabel = null;
  let marginChip = "mid";
  const mRow = rows.find(([k])=>k==="ë©”ì¸ ë§ˆì§„ íŒì •");
  if(mRow){
    const raw = String(mRow[1] ?? "");
    marginLabel = clean(raw);
    const clsMatch = raw.match(/class="([^"]+)"/);
    const tcls = clsMatch ? clsMatch[1] : "";
    if(tcls.includes("good")) marginChip = "ok";
    else if(tcls.includes("warn")) marginChip = "bad";
    else marginChip = "mid";
  }

  // ì‹œì¥ ìµœê³  í™•ë¥ (ë©”ì¸) ì¶”ì¶œ
  const probRows = rows.filter(([k])=>String(k).includes("ìŠ¹ë¦¬ í™•ë¥ (ë°°ë‹¹ ê¸°ë°˜Â·ì¶”ì •"));
  let topProb = null;
  probRows.forEach(([k,v])=>{
    const p = num(v);
    if(p==null) return;
    const m = String(k).match(/,\s*([^)]+)\)/);
    const label = m ? m[1] : String(k);
    if(!topProb || p > topProb.p) topProb = { label, p };
  });

  // EV ì¶”ì¶œ(ê³ ê¸‰ëª¨ë“œì—ì„œë§Œ ì¡´ì¬í•  ìˆ˜ ìˆìŒ)
  const evRow = rows.find(([k])=>k==="EV(1ì›ë‹¹)");
  const evPct = evRow ? num(evRow[1]) : null;

  // ë°°ì§€(ìš”ì•½)
  let primary = { cls: marginChip, text: marginLabel ? `ë©”ì¸ ë§ˆì§„: ${marginLabel}` : "ê²°ê³¼ ìš”ì•½" };
  let secondary = null;

  if(evPct!=null){
    primary = { cls: (evPct>=0 ? "ok" : "bad"), text: `ë°¸ë¥˜(${evPct>=0?"+":"-"}EV) ${Math.abs(evPct).toFixed(2)}%` };
    if(marginLabel){
      secondary = { cls: marginChip, text: `ë©”ì¸ ë§ˆì§„: ${marginLabel}${marginPct!=null ? ` (${marginPct.toFixed(1)}%)` : ""}` };
    }
  }


  // í•œì¤„ ê²°ë¡ (í‘œí˜„ìš©: ë¡œì§ì€ ë³€ê²½í•˜ì§€ ì•Šê³ , ê³„ì‚°ëœ ê°’ìœ¼ë¡œë§Œ ì•ˆë‚´)
  let conclusion = { cls:"warn", icon:"âš ï¸", text:"ì£¼ì˜ Â· ì…ë ¥ê°’/ê·¼ê±°ë¥¼ í™•ì¸í•˜ì„¸ìš”" };
  if(evPct!=null){
    if(evPct >= 2){
      conclusion = { cls:"good", icon:"âœ…", text:`ì¶”ì²œ Â· +EV ${evPct.toFixed(2)}%` };
    }else if(evPct >= 0){
      conclusion = { cls:"warn", icon:"âš ï¸", text:`ì£¼ì˜ Â· ì†Œí­ +EV ${evPct.toFixed(2)}%` };
    }else{
      conclusion = { cls:"bad", icon:"â›”", text:`PASS Â· -EV ${Math.abs(evPct).toFixed(2)}%` };
    }
  }else if(marginPct!=null){
    if(marginPct <= 3){
      conclusion = { cls:"good", icon:"âœ…", text:`ì¶”ì²œ Â· ë§ˆì§„ ë‚®ìŒ ${marginPct.toFixed(1)}%` };
    }else if(marginPct <= 6){
      conclusion = { cls:"warn", icon:"âš ï¸", text:`ì£¼ì˜ Â· ë§ˆì§„ ë³´í†µ ${marginPct.toFixed(1)}%` };
    }else{
      conclusion = { cls:"bad", icon:"â›”", text:`PASS Â· ë§ˆì§„ ë†’ìŒ ${marginPct.toFixed(1)}%` };
    }
  }
  const adviceKey = (conclusion.cls==="good") ? "rec" : (conclusion.cls==="bad" ? "pass" : "caution");
  const trustHtml = buildTrustLineHtml(adviceKey);
  const canMark = !!(LAST_RECORD && LAST_RECORD.id);
  const reason = (()=>{
    const parts = [];
    if(evPct != null) parts.push(`EV ${(evPct>=0?"+":"")+evPct.toFixed(2)}%`);
    if(marginPct != null) parts.push(`ë§ˆì§„ ${marginPct.toFixed(1)}%`);
    if(topProb) parts.push(`ì‹œì¥ ${topProb.label} ${topProb.p.toFixed(1)}%`);

    if(!parts.length) return "";

    let tail = "";
    if(evPct != null){
      if(evPct >= 2) tail = " Â· ë°¸ë¥˜ êµ¬ê°„";
      else if(evPct >= 0) tail = " Â· ì†Œí­ ë°¸ë¥˜";
      else tail = " Â· -EV";
    }else if(marginPct != null){
      if(marginPct <= 3) tail = " Â· ë§ˆì§„ ë‚®ìŒ";
      else if(marginPct <= 6) tail = " Â· ë§ˆì§„ ë³´í†µ";
      else tail = " Â· ë§ˆì§„ ë†’ìŒ";
    }
    return "ê·¼ê±°: " + parts.join(" Â· ") + tail;
  })();


  const hero = `
    <div class="resultHero">
      <div class="heroTop">
        <div class="heroText">
          <div class="heroTitle">${sportName} Â· ${levelLabel(level)} ê²°ê³¼</div>
          <div class="heroSub">ì…ë ¥ê°’ ê¸°ë°˜ ìš”ì•½ Â· ì•„ë˜ ìƒì„¸í‘œë¡œ ê·¼ê±°ë¥¼ í™•ì¸í•˜ì„¸ìš”</div>
        </div>
        <div class="heroRight">
          <div class="heroBadges">
            <span class="chip big ${primary.cls}">${primary.text}</span>
            ${secondary ? `<span class="chip ${secondary.cls}">${secondary.text}</span>` : ``}
          </div>
          <div class="heroConclusion ${conclusion.cls}">
            <span class="cIcon">${conclusion.icon}</span>
            <span class="cText">${conclusion.text}</span>
          </div>
          <div class="trustLine">${trustHtml}</div>
          ${reason ? `<div class="heroReason">${reason}</div>` : ``}
          <div class="outcomeBar" ${canMark ? "" : "style=\"display:none;\""}>
            <button class="oBtn" type="button" onclick="markOutcome('W')">âœ… ì ì¤‘</button>
            <button class="oBtn" type="button" onclick="markOutcome('L')">âŒ ë¯¸ì ì¤‘</button>
            <button class="oBtn" type="button" onclick="markOutcome('V')">âšª ì·¨ì†Œ</button>
            <button class="oBtn" type="button" onclick="markOutcome('')">â†©ï¸ ë¯¸ê¸°ë¡</button>
          </div>
        </div>
      </div>

      <div class="heroStats">
        <div class="statCard">
          <div class="statK">ë©”ì¸ ë§ˆì§„</div>
          <div class="statV">${marginPct!=null ? marginPct.toFixed(1)+"%" : "â€”"}</div>
          <div class="statS">${over!=null ? "ì˜¤ë²„ë¼ìš´ë“œ "+over.toFixed(4) : "ì˜¤ë²„ë¼ìš´ë“œ â€”"}</div>
        </div>

        <div class="statCard">
          <div class="statK">ì‹œì¥ ìµœê³ í™•ë¥ </div>
          <div class="statV">${topProb ? `${topProb.label} ${topProb.p.toFixed(1)}%` : "â€”"}</div>
          <div class="statS">ë°°ë‹¹ ì—­ìˆ˜ ì •ê·œí™”</div>
        </div>

        <div class="statCard">
          <div class="statK">EV</div>
          <div class="statV">${evPct!=null ? ((evPct>=0?"+":"")+evPct.toFixed(2)+"%") : "ë¯¸ì…ë ¥"}</div>
          <div class="statS">${evPct!=null ? "ë‚´ ì˜ˆìƒ í™•ë¥  ê¸°ì¤€" : "ê³ ê¸‰ëª¨ë“œì—ì„œ ì…ë ¥"}</div>
        </div>
      </div>
    </div>
  `;

  const html = rows.map(([k,v])=>{
    // vê°€ HTML í¬í•¨í•  ìˆ˜ ìˆìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ
    let cls = "";
    const s = String(v);
    if(k.includes("íŒë‹¨") && s.includes("-EV")) cls = "warn";
    if(k.includes("íŒë‹¨") && s.includes("+EV")) cls = "good";
    return `<div class="kv"><div class="k">${k}</div><div class="v ${cls}">${v}</div></div>`;
  }).join("");

  box.innerHTML = `
    ${hero}
    <div class="detailHead">ìƒì„¸ ì§€í‘œ</div>
    ${html}
    <hr class="sep">
    <div style="font-size:12px;color:#9a9a9a;line-height:1.5;">
      â€» â€œìŠ¹ë¦¬ í™•ë¥ (ë°°ë‹¹ ê¸°ë°˜Â·ì¶”ì •)â€ì€ ë°°ë‹¹ ì—­ìˆ˜ë¥¼ ì •ê·œí™”í•œ ê°’(ì‹œì¥ ê¸°ë°˜ ì¶”ì •)ì…ë‹ˆë‹¤.<br>
      â€» EV/ë¹„ì¤‘ì€ ì‚¬ìš©ìê°€ ì…ë ¥í•œ â€œë‚´ ì˜ˆìƒ í™•ë¥ â€ ê¸°ë°˜ì˜ ì°¸ê³  ì§€í‘œì´ë©° ìŠ¹ë¥ ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
      â€» ì•„ì‹œì•ˆ(í‘¸ì‹œ) ê·¼ì‚¬ëŠ” ì‚¬ìš©ìê°€ ì…ë ¥í•œ í‘¸ì‹œ í™•ë¥ (ë˜ëŠ” ì¢…ëª© ê¸°ë³¸ê°’)ë¡œ ê·¼ì‚¬í•©ë‹ˆë‹¤.
    </div>
  `;
  box.style.display = "block";
  const dock = document.getElementById("resultDock");
  if(dock) dock.style.display = "flex";

  // ì¡°ê±´ë¶€ CTA ê°•í™”: ë§ˆì§„ ë‚®ìŒ or +EVì¼ ë•Œë§Œ ì—…ì²´ ë²„íŠ¼ì„ ë” ê°•í•˜ê²Œ
  try{
    const vbtn = document.querySelector('a[data-cta="analysis_to_vendors"]');
    if(vbtn && LAST_RECORD && LAST_RECORD.markets && LAST_RECORD.markets.main){
      const m = +LAST_RECORD.markets.main.marginPct;
      const rule = ((MARGIN_RULE[LAST_RECORD.sport] || MARGIN_RULE.soccer).main || [5,7,9]);
      const isLow = isFinite(m) && (m <= rule[0]);
      const isBoost = !!LAST_RECORD.evPositive || isLow;
      vbtn.classList.remove("gold","secondary","primary");
      vbtn.classList.add(isBoost ? "gold" : "secondary");
      vbtn.textContent = isBoost ? "ì¶”ì²œ ì—…ì²´ ì¹´ë“œ" : "ì—…ì²´ ì¹´ë“œ";
    }
  }catch(e){}

  copyLines.push(`ë§í¬: ${getShareLink()}`);
  LAST_TEXT = copyLines.join("\n") + "\n\n" + rows.map(r=>`${r[0]}: ${String(r[1]).replace(/<[^>]*>/g,"")}`).join("\n");
}
function showError(msg){
  const dock = document.getElementById("resultDock");
  if(dock) dock.style.display = "none";
  const box = $("result");
  box.innerHTML = `<div class="kv"><div class="k">ì•ˆë‚´</div><div class="v warn">${msg}</div></div>`;
  box.style.display = "block";
  LAST_TEXT = `[88 ì»¤ë®¤ë‹ˆí‹°] ì•ˆë‚´\n${msg}\në§í¬: ${getShareLink()}`;

  try{
    const reason = String(msg||"").replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim().slice(0,80);
    track("analysis_error", { reason });
  }catch(e){}
}
function hideResult(){
  const dock = document.getElementById("resultDock");
  if(dock) dock.style.display = "none";
  const box = $("result");
  box.style.display = "none";
  box.innerHTML = "";
  LAST_TEXT = "";
}
function resetAll(){
  [
    "league","teams",
    "main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA",
    "myProb","stake",
    "handicapLine","handicapOddsA","handicapOddsB","handicapPush",
    "totalLine","overOdds","underOdds","ouPush","myOverProb"
  ].forEach(id=>{ const el=$(id); if(el) el.value=""; });

  hideResult();
  localStorage.removeItem(LS_KEY);
  setEvFlag(false);
  renderMarginDash();
  toast("ì´ˆê¸°í™” ì™„ë£Œ");
}

/* =========================
   ë³µì‚¬/ê³µìœ  (ê¸°ì¡´ ìœ ì§€)
========================= */
async function copyResult(){
  if(!LAST_TEXT) return showError("ë¨¼ì € 'ê³„ì‚°í•˜ê¸°'ë¥¼ ëˆŒëŸ¬ ê²°ê³¼ë¥¼ ë§Œë“  ë’¤ ë³µì‚¬í•  ìˆ˜ ìˆì–´ìš”.");
  try{
    await navigator.clipboard.writeText(LAST_TEXT);
    toast("ê²°ê³¼ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }catch(e){
    prompt("ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì„¸ìš”:", LAST_TEXT);
  }
}
async function shareResult(){
  if(!LAST_TEXT) return showError("ë¨¼ì € 'ê³„ì‚°í•˜ê¸°'ë¥¼ ëˆŒëŸ¬ ê²°ê³¼ë¥¼ ë§Œë“  ë’¤ ê³µìœ í•  ìˆ˜ ìˆì–´ìš”.");
  try{
    if(navigator.share){
      await navigator.share({ title:"88 ì»¤ë®¤ë‹ˆí‹° ë¶„ì„ ê²°ê³¼", text: LAST_TEXT });
    }else{
      await copyResult();
    }
  }catch(e){}
}

/* =========================
   UX Add-ons (non-breaking)
========================= */
function updateSaveBadge(ts){
  const el = document.getElementById("saveBadge");
  if(!el) return;
  if(!ts){
    el.innerHTML = `<span class="dot"></span>ìë™ ì €ì¥`;
    return;
  }
  const d = new Date(ts);
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  el.innerHTML = `<span class="dot"></span>ìë™ ì €ì¥ Â· ${hh}:${mm}`;
}

function toggleMiniGuide(){
  const body = document.getElementById("miniGuideBody");
  const pill = document.getElementById("miniGuidePill");
  if(!body || !pill) return;
  const isOpen = body.style.display === "block";
  const next = !isOpen;
  body.style.display = next ? "block" : "none";
  pill.textContent = next ? "ë‹«ê¸°" : "ì—´ê¸°";
  try{ localStorage.setItem("88_mini_guide_open", next ? "1":"0"); }catch(e){}
}

function restoreMiniGuide(){
  try{
    const v = localStorage.getItem("88_mini_guide_open");
    const body = document.getElementById("miniGuideBody");
    const pill = document.getElementById("miniGuidePill");
    if(!body || !pill) return;
    const open = v === "1";
    body.style.display = open ? "block" : "none";
    pill.textContent = open ? "ë‹«ê¸°" : "ì—´ê¸°";
  }catch(e){}
}

function clearInvalid(){
  document.querySelectorAll(".is-invalid").forEach(el=>el.classList.remove("is-invalid"));
}
function markInvalid(ids){
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.add("is-invalid");
  });
  const first = document.querySelector(".is-invalid");
  if(first){
    try{ first.scrollIntoView({behavior:"smooth", block:"center"}); }catch(e){}
  }
}

function quickJump(which){
  if(which==="top"){
    try{ window.scrollTo({top:0, behavior:"smooth"}); }catch(e){ window.scrollTo(0,0); }
    return;
  }
  const map = {
    main: "mainBox",
    total: "totalBox",
    handicap: "handicapBox",
    result: "result",
    history: "historyList"
  };
  const id = map[which];
  const el = document.getElementById(id);
  if(!el) return;
  if(which==="total"){ setCollapsed("totalBody", false); }
  if(which==="handicap"){ setCollapsed("handicapBody", false); }
  try{ el.scrollIntoView({behavior:"smooth", block:"start"}); }catch(e){}
}

function openShareCard(){
  const modal = document.getElementById("shareCardModal");
  const resultBox = document.getElementById("result");
  if(!modal) return;
  if(!resultBox || resultBox.style.display==="none" || !resultBox.innerText.trim()){
    return showError("ë¨¼ì € 'ê³„ì‚°í•˜ê¸°'ë¡œ ê²°ê³¼ë¥¼ ë§Œë“  ë’¤ ê³µìœ  ì¹´ë“œë¥¼ ìƒì„±í•  ìˆ˜ ìˆì–´ìš”.");
  }
  try{ updateBundlePromo(items); }catch(e){}
  modal.style.display = "flex";
  drawShareCard();
  // Normalize share event names across the site (index â†” analysis)
  try{ track("share_open", { page_path: location.pathname }); }catch(e){}
}
function closeShareCard(){
  const modal = document.getElementById("shareCardModal");
  if(modal) modal.style.display = "none";
}

function getShareLink(){
  try{
    const u = new URL(location.origin + location.pathname);
    const st = buildPermalinkState();
    if(st) u.searchParams.set("st", st);

    // UTMì€ ì €ì¥ëœ ê°’ì„ ìš°ì„  ë¶™ì—¬ì„œ ê³µìœ  ë£¨í”„ ìœ ì§€
    try{
      if(typeof getUtmQuery === "function"){
        const qs = getUtmQuery();
        if(qs){
          const sp = new URLSearchParams(qs.replace(/^\?/,""));
          sp.forEach((v,k)=>{ if(!u.searchParams.get(k)) u.searchParams.set(k,v); });
        }
      }
    }catch(e){}

    return u.toString();
  }catch(e){
    return location.origin + location.pathname;
  }
}

function extractResultLines(){
  const box = document.getElementById("result");
  if(!box) return [];
  const kvs = box.querySelectorAll(".kv");
  const lines = [];
  kvs.forEach(kv=>{
    const k = kv.querySelector(".k")?.innerText?.trim();
    const v = kv.querySelector(".v")?.innerText?.trim();
    if(k && v) lines.push(`${k}: ${v}`);
  });
  return lines;
}

function roundRect(ctx, x, y, w, h, r, fill, stroke){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}

function drawShareCard(){
  const canvas = document.getElementById("shareCardCanvas");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;

  // bg
  const g = ctx.createLinearGradient(0,0,W,H);
  g.addColorStop(0, "#0b0b0b");
  g.addColorStop(0.55, "#121212");
  g.addColorStop(1, "#07070a");
  ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

  // glow
  ctx.fillStyle = "rgba(var(--accentRGB),0.12)";
  ctx.beginPath(); ctx.arc(W*0.60, H*0.15, 330, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = "rgba(90,160,255,0.08)";
  ctx.beginPath(); ctx.arc(W*0.18, H*0.25, 260, 0, Math.PI*2); ctx.fill();

  // card
  const pad = 70;
  const r = 34;
  ctx.fillStyle = "rgba(255,255,255,0.06)";
  roundRect(ctx, pad, pad, W-pad*2, H-pad*2, r, true, false);
  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 2;
  roundRect(ctx, pad, pad, W-pad*2, H-pad*2, r, false, true);

  // header
  ctx.fillStyle = "#f5e27a";
  ctx.font = "900 54px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText("88 ë¶„ì„ ê²°ê³¼", pad+40, pad+95);

  ctx.fillStyle = "rgba(255,255,255,0.80)";
  ctx.font = "700 28px system-ui, -apple-system, Segoe UI, Roboto";
  const ts = new Date();
  ctx.fillText(ts.toLocaleString("ko-KR"), pad+40, pad+145);

  // summary one-line
  let hasSummary = false;
  try{
    const sumRaw = (LAST_ONE_LINE || "").replace(/^ìš”ì•½\s*:\s*/,"").trim();
    if(sumRaw){
      const sum = sumRaw.length > 70 ? (sumRaw.slice(0,70) + "â€¦") : sumRaw;
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.font = "900 24px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillText(sum, pad+40, pad+240);
      hasSummary = true;
    }
  }catch(e){ hasSummary = false; }

  // badge (EV flag)
  let badgeText = "";
  try{
    const evEl = document.getElementById("evFlag");
    if(evEl && evEl.innerText) badgeText = evEl.innerText.trim();
  }catch(e){}
  if(badgeText){
    const bx = pad+40, by = pad+170, bw = 340, bh = 54;
    ctx.fillStyle = "rgba(var(--accentRGB),0.18)";
    roundRect(ctx, bx, by, bw, bh, 999, true, false);
    ctx.strokeStyle = "rgba(var(--accentRGB),0.35)";
    ctx.lineWidth = 2;
    roundRect(ctx, bx, by, bw, bh, 999, false, true);
    ctx.fillStyle = "#fff";
    ctx.font = "900 26px system-ui, -apple-system, Segoe UI, Roboto";
    ctx.fillText(badgeText, bx+18, by+36);
  }

  // lines
  const lines = extractResultLines().slice(0, 12);
  let y = hasSummary ? (pad + 310) : (pad + 270);
  ctx.fillStyle = "rgba(255,255,255,0.92)";
  ctx.font = "800 30px system-ui, -apple-system, Segoe UI, Roboto";
  lines.forEach((line)=>{
    const txt = line.length > 46 ? (line.slice(0,46) + "â€¦") : line;
    ctx.fillText("â€¢ " + txt, pad+40, y);
    y += 48;
  });

  // footer
  ctx.fillStyle = "rgba(255,255,255,0.75)";
  ctx.font = "800 26px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText("ë§í¬: " + getShareLink(), pad+40, H - pad - 70);

  ctx.fillStyle = "rgba(255,255,255,0.55)";
  ctx.font = "700 22px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText("â€» íŒë‹¨ ë³´ì¡°ìš© / ê²°ê³¼ë¥¼ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", pad+40, H - pad - 30);
}

async function copyShareLink(){
  const link = getShareLink();
  try{
    await navigator.clipboard.writeText(link);
    toast("ë§í¬ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤");
    try{ track("share_copy_link", { page_path: location.pathname }); }catch(e){}
  }catch(e){
    toast("ë³µì‚¬ ì‹¤íŒ¨");
  }
}

async function copyShareText(){
  if(!LAST_TEXT) return showError("ë¨¼ì € 'ê³„ì‚°í•˜ê¸°'ë¡œ ê²°ê³¼ë¥¼ ë§Œë“  ë’¤ ë³µì‚¬í•  ìˆ˜ ìˆì–´ìš”.");
  try{
    await navigator.clipboard.writeText(LAST_TEXT + "\n" + getShareLink());
    toast("ë¬¸êµ¬ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤");
    try{ track("share_copy_text", { page_path: location.pathname }); }catch(e){}
  }catch(e){
    toast("ë³µì‚¬ ì‹¤íŒ¨");
  }
}

function downloadShareCard(){
  const canvas = document.getElementById("shareCardCanvas");
  if(!canvas) return;
  try{
    canvas.toBlob((blob)=>{
      if(!blob) return;
      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = "88-analysis-card.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 800);
      toast("ì´ë¯¸ì§€ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤");
      try{ track("share_download_image", { page_path: location.pathname }); }catch(e){}
    }, "image/png", 1.0);
  }catch(e){
    toast("ì €ì¥ ì‹¤íŒ¨");
  }
}



/* =========================
   ì˜¤ëŠ˜ ìˆ˜ì§‘ ë¬¶ìŒ ê³µìœ  (ì—°ì† ì €ì¥/í´ë¦­ ì €ì¥ ëˆ„ì )
   - ì„œë²„ ì—†ì´ localStorage(ì˜¤ëŠ˜ ë‚ ì§œ key)ì— ì €ì¥ëœ ë§í¬ë¥¼ ë¬¶ì–´ì„œ ê³µìœ 
========================= */
function truncateText(s, n){
  const t = String(s||"").trim();
  if(!t) return "";
  return t.length > n ? (t.slice(0,n-1) + "â€¦") : t;
}

function getBundleItems(limit){
  const items = readChainPack(todayStr());
  const clean = (items||[]).filter(x=>x && x.link);
  // dedupe by link
  const seen = new Set();
  const uniq = [];
  for(const it of clean){
    if(seen.has(it.link)) continue;
    seen.add(it.link);
    uniq.push(it);
  }
  // sort: margin asc (then recent)
  uniq.sort((a,b)=>{
    const ma = (typeof a.mainMarginPct === "number") ? a.mainMarginPct : 9999;
    const mb = (typeof b.mainMarginPct === "number") ? b.mainMarginPct : 9999;
    if(ma !== mb) return ma - mb;
    return (b.ts||0) - (a.ts||0);
  });
  return uniq.slice(0, limit || 10);
}

function bundleTop3OneLine(items){
  const top = (items||[]).slice(0,3);
  if(!top.length) return "";
  const shortTeams = (s)=>{
    const t = String(s||"").replace(/\s+/g," ").trim();
    if(!t) return "íŒ€ëª…";
    // ë„ˆë¬´ ê¸¸ë©´ ì•/ë’¤ë¥¼ ë³´ì¡´
    if(t.length <= 14) return t;
    const parts = t.split(/\s+vs\s+|\s+VS\s+|\s+-\s+|\s+v\s+/i);
    if(parts.length>=2){
      const a = parts[0].trim();
      const b = parts[1].trim();
      const aa = a.length>8 ? a.slice(0,8)+"â€¦" : a;
      const bb = b.length>8 ? b.slice(0,8)+"â€¦" : b;
      return `${aa} vs ${bb}`;
    }
    return t.slice(0,13)+"â€¦";
  };
  const parts = top.map((it, i)=>{
    const title = shortTeams(it.teams);
    const m = (typeof it.mainMarginPct === "number") ? it.mainMarginPct.toFixed(2)+"%" : "-";
    return `${i+1}) ${title}(${m})`;
  });
  return `TOP3: ${parts.join(" / ")}`;
}

function buildBundleText(items){
  const d = todayStr();
  const lines = [];
  lines.push(`[88ST] ì˜¤ëŠ˜ ìˆ˜ì§‘ ${items.length}ê²½ê¸° (ë§ˆì§„ ë‚®ì€ ìˆœ) Â· ${d}`);
  lines.push(`ë¶„ì„ê¸°: https://88st.cloud/analysis/`);
  const top3 = bundleTop3OneLine(items);
  if(top3){
    lines.push(top3);
  }
  lines.push("");
  items.forEach((it, i)=>{
    const sportName = (SPORT_CFG[it.sport] || SPORT_CFG.soccer).name || (it.sport||"");
    const title = (it.teams && it.teams.trim()) ? it.teams.trim() : "íŒ€ëª… ë¯¸ì…ë ¥";
    const m = (typeof it.mainMarginPct === "number") ? `ë§ˆì§„ ${it.mainMarginPct.toFixed(2)}%` : "ë§ˆì§„ -";
    const ev = (typeof it.bestEVPct === "number") ? `EV ${(it.bestEVPct>=0?"+":"-")}${Math.abs(it.bestEVPct).toFixed(2)}%` : "EV ë¯¸ì…ë ¥";
    lines.push(`${i+1}) ${title}`);
    lines.push(`   ${sportName} Â· ${m} Â· ${ev}`);
    lines.push(`   ${it.link}`);
    lines.push("");
  });
  lines.push("â€» íŒë‹¨ ë³´ì¡°ìš© / ê²°ê³¼ë¥¼ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
  return lines.join("\n");
}

function buildBundleLinks(items){
  return items.map(it=>it.link).join("\n");
}

function drawBundleCard(items){
  const canvas = document.getElementById("bundleCanvas");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;

  // bg
  const bg = ctx.createLinearGradient(0,0,W,H);
  bg.addColorStop(0, "#0b0b0b");
  bg.addColorStop(0.55, "#121212");
  bg.addColorStop(1, "#07070a");
  ctx.fillStyle = bg; ctx.fillRect(0,0,W,H);

  // glow
  ctx.fillStyle = "rgba(var(--accentRGB),0.12)";
  ctx.beginPath(); ctx.arc(W*0.62, H*0.18, 330, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = "rgba(90,160,255,0.08)";
  ctx.beginPath(); ctx.arc(W*0.18, H*0.28, 260, 0, Math.PI*2); ctx.fill();

  const pad = 70;
  const r = 34;
  ctx.fillStyle = "rgba(255,255,255,0.06)";
  roundRect(ctx, pad, pad, W-pad*2, H-pad*2, r, true, false);
  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 2;
  roundRect(ctx, pad, pad, W-pad*2, H-pad*2, r, false, true);

  // header
  ctx.fillStyle = "#f5e27a";
  ctx.font = "900 50px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText("88 ì˜¤ëŠ˜ ìˆ˜ì§‘", pad+40, pad+92);

  ctx.fillStyle = "rgba(255,255,255,0.82)";
  ctx.font = "800 26px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText(`${todayStr()} Â· ë§ˆì§„ ë‚®ì€ ìˆœ TOP${items.length}`, pad+40, pad+140);

  // TOP3 one-line
  const top3 = bundleTop3OneLine(items);
  let baseY = pad + 210;
  if(top3){
    ctx.fillStyle = "rgba(255,255,255,0.72)";
    ctx.font = "900 22px system-ui, -apple-system, Segoe UI, Roboto";
    const t = truncateText(top3, 54);
    ctx.fillText(t, pad+40, pad+178);
    baseY = pad + 242;
  }

  // list
  let y = baseY;
  const lineH = 74;
  items.slice(0,10).forEach((it, i)=>{
    const title = truncateText((it.teams && it.teams.trim()) ? it.teams.trim() : "íŒ€ëª… ë¯¸ì…ë ¥", 28);
    const sportName = (SPORT_CFG[it.sport] || SPORT_CFG.soccer).name || (it.sport||"");
    const m = (typeof it.mainMarginPct === "number") ? `ë§ˆì§„ ${it.mainMarginPct.toFixed(2)}%` : "ë§ˆì§„ -";
    const ev = (typeof it.bestEVPct === "number") ? `EV ${(it.bestEVPct>=0?"+":"-")}${Math.abs(it.bestEVPct).toFixed(2)}%` : "EV ë¯¸ì…ë ¥";

    ctx.fillStyle = "rgba(255,255,255,0.94)";
    ctx.font = "900 30px system-ui, -apple-system, Segoe UI, Roboto";
    ctx.fillText(`${i+1}. ${title}`, pad+40, y);

    ctx.fillStyle = "rgba(255,255,255,0.78)";
    ctx.font = "800 22px system-ui, -apple-system, Segoe UI, Roboto";
    ctx.fillText(`${sportName} Â· ${m} Â· ${ev}`, pad+40, y + 34);

    y += lineH;
  });

  // footer
  ctx.fillStyle = "rgba(255,255,255,0.70)";
  ctx.font = "800 24px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText("88st.cloud/analysis", pad+40, H - pad - 58);

  ctx.fillStyle = "rgba(255,255,255,0.55)";
  ctx.font = "700 20px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText("â€» í…ìŠ¤íŠ¸ì— ê° ê²½ê¸° ë³µì› ë§í¬ í¬í•¨", pad+40, H - pad - 28);
}

function openBundleShare(){
  const items = getBundleItems(10);
  if(!items.length){
    toast("ì˜¤ëŠ˜ ìˆ˜ì§‘ëœ í•­ëª©ì´ ì•„ì§ ì—†ì–´ìš”. (í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°ì—ì„œ 'ì—°ì† ì €ì¥' ë˜ëŠ” 'í´ë¦­=ì—°ì† ì €ì¥'ì„ ì‚¬ìš©í•´ì¤˜)");
    return;
  }
  const modal = document.getElementById("bundleShareModal");
  if(!modal) return;

  const titleEl = document.getElementById("bundleTitle");
  const metaEl  = document.getElementById("bundleMeta");
  const ta      = document.getElementById("bundleText");

  if(titleEl) titleEl.textContent = `ì˜¤ëŠ˜ ìˆ˜ì§‘ ë¬¶ìŒ (${items.length}ê²½ê¸°)`;
  if(ta) ta.value = buildBundleText(items);

  if(metaEl){
    const ms = items.map(it=> (typeof it.mainMarginPct === "number") ? it.mainMarginPct : null).filter(v=>v!=null);
    const min = ms.length ? Math.min(...ms) : null;
    const avg = ms.length ? (ms.reduce((a,b)=>a+b,0) / ms.length) : null;
    const pos = items.filter(it=> typeof it.bestEVPct === "number" && it.bestEVPct > 0).length;
    const pill = (txt)=>`<span class="bundle-pill">${txt}</span>`;
    const top3 = bundleTop3OneLine(items);
    metaEl.innerHTML = `<div class="bundle-mini"><b>${todayStr()}</b> Â· ${items.length}ê°œ</div>` +
      `<div class="bundle-mini">` +
        pill(min!=null?`ìµœì € ë§ˆì§„ ${min.toFixed(2)}%`:`ìµœì € ë§ˆì§„ -`) +
        pill(avg!=null?`í‰ê·  ë§ˆì§„ ${avg.toFixed(2)}%`:`í‰ê·  ë§ˆì§„ -`) +
        pill(`+EV ${pos}ê°œ`) +
      `</div>` +
      (top3 ? `<div class="bundle-mini">${safeText(top3)}</div>` : "");
  }

  modal.style.display = "flex";
  drawBundleCard(items);
  try{ track("bundle_open", { count: items.length, page_path: location.pathname }); }catch(e){}
}

async function copyBundleTop3(){
  const items = getBundleItems(10);
  if(!items.length) return;
  const t = bundleTop3OneLine(items);
  if(!t) return;
  try{
    await navigator.clipboard.writeText(t);
    toast("TOP3 ìš”ì•½ì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤");
    try{ track("bundle_copy_top3", { page_path: location.pathname }); }catch(e){}
  }catch(e){ toast("ë³µì‚¬ ì‹¤íŒ¨"); }
}

function resetBundleToday(){
  if(!confirm("ì˜¤ëŠ˜ ìˆ˜ì§‘ ë¬¶ìŒì„ ì´ˆê¸°í™”í• ê¹Œìš”?\n\nâ€¢ íˆìŠ¤í† ë¦¬(ì €ì¥ ê¸°ë¡)ëŠ” ìœ ì§€ë©ë‹ˆë‹¤\nâ€¢ 'ì˜¤ëŠ˜ ìˆ˜ì§‘ ë¬¶ìŒ'ë§Œ ë¹„ì›Œì§‘ë‹ˆë‹¤")) return;
  try{ localStorage.removeItem(chainPackKey(todayStr())); }catch(e){}
  try{ updateBundleButton(); }catch(e){}
  toast("ì˜¤ëŠ˜ ìˆ˜ì§‘ ë¬¶ìŒì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤");
  try{ track("bundle_reset", { page_path: location.pathname }); }catch(e){}
  try{ closeBundleShare(); }catch(e){}
}

function closeBundleShare(){
  const modal = document.getElementById("bundleShareModal");
  if(modal) modal.style.display = "none";
}

async function copyBundleText(){
  const ta = document.getElementById("bundleText");
  if(!ta || !ta.value) return;
  try{
    await navigator.clipboard.writeText(ta.value);
    toast("ë¬¶ìŒ ë¬¸êµ¬ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤");
    try{ track("bundle_copy_text", { page_path: location.pathname }); }catch(e){}
  }catch(e){ toast("ë³µì‚¬ ì‹¤íŒ¨"); }
}

async function copyBundleLinks(){
  const items = getBundleItems(10);
  if(!items.length) return;
  const txt = buildBundleLinks(items);
  try{
    await navigator.clipboard.writeText(txt);
    toast("ë§í¬ë§Œ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤");
    try{ track("bundle_copy_links", { count: items.length, page_path: location.pathname }); }catch(e){}
  }catch(e){ toast("ë³µì‚¬ ì‹¤íŒ¨"); }
}


/* ===== ë¬¶ìŒ í™ë³´ê¸€(ì±„ë„/í†¤) ìë™ ìƒì„± ===== */
const BUNDLE_PROMO_LS_CH        = "88_bundle_promo_channel";
const BUNDLE_PROMO_LS_STYLE     = "88_bundle_promo_style";
const BUNDLE_PROMO_LS_LINKS     = "88_bundle_promo_links";
const BUNDLE_PROMO_LS_SHORTURL  = "88_bundle_promo_short_url";
const BUNDLE_PROMO_LS_COMPACT   = "88_bundle_promo_compact";
const BUNDLE_PROMO_LS_VENDOR    = "88_bundle_promo_vendor";
const BUNDLE_PROMO_LS_ONE_TGT   = "88_bundle_promo_one_target";
const BUNDLE_PROMO_LS_VAR       = "88_bundle_promo_variant";

const BUNDLE_PROMO_CHANNELS = [
  { key:"tochatsa",       label:"í† ì°¾ì‚¬",                 source:"tochatsa",       medium:"community", defaultStyle:"promo" },
  { key:"toto_hot",       label:"í† í† í•«",                 source:"toto_hot",       medium:"community", defaultStyle:"promo" },
  { key:"mt_dajava",      label:"ë¨¹íŠ€ë‹¤ìë°”",             source:"mt_dajava",      medium:"community", defaultStyle:"info"  },
  { key:"meokjab",        label:"ë¨¹ì¡",                   source:"meokjab",        medium:"community", defaultStyle:"info"  },
  { key:"toto_town",      label:"í† í† íƒ€ìš´",               source:"toto_town",      medium:"community", defaultStyle:"promo" },
  { key:"chongpan_guard", label:"ì´íŒêµ¬ì¡°ëŒ€",             source:"chongpan_guard", medium:"community", defaultStyle:"promo" },
  { key:"powerball_auto", label:"íŒŒì›Œë³¼ì˜¤í† ",             source:"powerball_auto", medium:"community", defaultStyle:"promo" },
  { key:"daumde",         label:"ë‹¤ìŒë“œ",                 source:"daumde",         medium:"community", defaultStyle:"promo" },
  { key:"tg_freepromo",   label:"í…”ë ˆê·¸ë¨ í† í† ììœ í™ë³´ë°©", source:"tg_freepromo",   medium:"telegram",  defaultStyle:"tg" },
  { key:"etc",            label:"ê¸°íƒ€",                   source:"etc",            medium:"community", defaultStyle:"promo" }
];

function getPromoChannel(key){
  return BUNDLE_PROMO_CHANNELS.find(c=>c.key===key) || BUNDLE_PROMO_CHANNELS[0];
}

function promoUtm(channelKey, styleKey){
  const ch = getPromoChannel(channelKey);
  const source = ch.source || ch.key || channelKey || "community";
  const medium = ch.medium || "community";
  const camp = "bundle_w1";
  const content = `${source}_${styleKey}_${todayStr().replace(/-/g,"")}`;
  return { utm_source:source, utm_medium:medium, utm_campaign:camp, utm_content:content };
}

function stripUtmFromUrl(raw){
  try{
    const u = new URL(raw, location.origin);
    const keys = [...u.searchParams.keys()];
    for(const k of keys){
      if(/^utm_/i.test(k)) u.searchParams.delete(k);
    }
    return u.toString();
  }catch(e){ return raw; }
}

function applyUtmToUrl(raw, utm){
  try{
    const u = new URL(stripUtmFromUrl(raw), location.origin);
    for(const [k,v] of Object.entries(utm||{})){
      if(v==null || v==="") continue;
      u.searchParams.set(k, v);
    }
    return u.toString();
  }catch(e){ return raw; }
}

function fmtUrlForBoard(raw, shortUrl){
  if(!raw) return "";
  let url = String(raw);
  if(shortUrl){
    url = stripUtmFromUrl(url);
    url = url.replace(/^https?:\/\//i, "");
    url = url.replace(/\/$/,"");
  }
  return url;
}

// === 3ì¢… í…œí”Œë¦¿ ìë™ ëœë¤(ì¤‘ë³µ ë°©ì§€) ===
const PROMO_VARIANTS = 3;
const PROMO_TEMPLATES = {
  promo:{
    titles:[
      (n,d)=>`ë¬´ë£Œ ë°°ë‹¹ë¶„ì„ê¸° Â· ì˜¤ëŠ˜ ë§ˆì§„ ë‚®ì€ ê²½ê¸° TOP${n} (ë³µì› ë§í¬)`,
      (n,d)=>`[ë¬´ë£Œ] ì˜¤ë²„ë¼ìš´ë“œ(ë§ˆì§„) ë‚®ì€ ê²½ê¸° TOP${n} Â· ${d}`,
      (n,d)=>`ë§ˆì§„ ë‚®ì€ ë°°ë‹¹ë§Œ ë¹ ë¥´ê²Œ ì •ë¦¬ (TOP${n}) Â· ${d}`
    ],
    leads:[
      ()=>`ë°°ë‹¹ 2~3ê°œ ì…ë ¥í•˜ë©´ ë§ˆì§„/ê³µì •ë°°ë‹¹/EVë¥¼ í•œ ë²ˆì— ì •ë¦¬í•©ë‹ˆë‹¤. ì•„ë˜ëŠ” ì˜¤ëŠ˜ ìˆ˜ì§‘(ë§ˆì§„ ë‚®ì€ ìˆœ)ì…ë‹ˆë‹¤.`,
      ()=>`ì˜ˆì¸¡ì´ ì•„ë‹ˆë¼ â€œíŒë‹¨ ë¹„ìš© ì ˆê°â€ìš© ì •ë¦¬ì…ë‹ˆë‹¤. ë§í¬ë¥¼ ì—´ë©´ ì…ë ¥/ê²°ê³¼ê°€ ê·¸ëŒ€ë¡œ ë³µì›ë©ë‹ˆë‹¤.`,
      ()=>`ì»¤ë®¤ë‹ˆí‹°ì— ê·¼ê±° ë‚¨ê¸°ê¸° í¸í•˜ê²Œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° â†’ ìë™ ê³„ì‚°/ì €ì¥ë©ë‹ˆë‹¤.`
    ],
    headers:[
      (n)=>`ì˜¤ëŠ˜ ìˆ˜ì§‘ ${n}ê²½ê¸° (ë§ˆì§„ ë‚®ì€ ìˆœ)`,
      (n)=>`ì˜¤ëŠ˜ ì •ë¦¬ ${n}ê²½ê¸° Â· ë§ˆì§„ ê¸°ì¤€`,
      (n)=>`ì˜¤ëŠ˜ TOP${n} Â· ë§ˆì§„ ì •ë ¬`
    ]
  },
  info:{
    titles:[
      (n,d)=>`ì˜¤ë²„ë¼ìš´ë“œ(ë§ˆì§„) ë‚®ì€ ê²½ê¸° TOP${n} ì •ë¦¬ Â· ${d}`,
      (n,d)=>`ë°°ë‹¹ â€˜ë¹„ìš©(ë§ˆì§„)â€™ ë‚®ì€ ë¼ì¸ ëª¨ìŒ(TOP${n}) Â· ${d}`,
      (n,d)=>`ë§ˆì§„/ê³µì •ë°°ë‹¹/EV ë¹ ë¥¸ ì²´í¬(TOP${n}) Â· ${d}`
    ],
    leads:[
      ()=>`ë§ˆì§„(ì˜¤ë²„ë¼ìš´ë“œ)ì´ ë‚®ì„ìˆ˜ë¡ ë™ì¼ ë°°ë‹¹ì—ì„œë„ ë¹„ìš©ì´ ì ì€ í¸ì…ë‹ˆë‹¤. ì•„ë˜ ë§í¬ëŠ” ì—´ë©´ ë™ì¼ ê²°ê³¼ê°€ ë³µì›ë©ë‹ˆë‹¤.`,
      ()=>`ë°°ë‹¹ì„ â€˜ì˜ˆì¸¡â€™í•˜ëŠ” ê²Œ ì•„ë‹ˆë¼, ìˆ«ìë¡œ ì •ë¦¬í•´ì„œ íŒë‹¨ì„ ë¹ ë¥´ê²Œ í•˜ëŠ” ë„êµ¬ì…ë‹ˆë‹¤. ë³µì› ë§í¬ í¬í•¨.`,
      ()=>`ë§ˆì§„/ê³µì •ë°°ë‹¹/EVë¥¼ í•œ ë²ˆì— ê³„ì‚°í•©ë‹ˆë‹¤. ì»¤ë®¤ë‹ˆí‹° ê³µìœ ìš©ìœ¼ë¡œ ë³µì› ë§í¬ë¥¼ ê°™ì´ ë¶™ì˜€ìŠµë‹ˆë‹¤.`
    ],
    headers:[
      (n)=>`TOP${n} (ë§ˆì§„ ë‚®ì€ ìˆœ)`,
      (n)=>`ì˜¤ëŠ˜ ì²´í¬í•œ TOP${n}`,
      (n)=>`ë§ˆì§„ ê¸°ì¤€ TOP${n}`
    ]
  },
  tg:{
    titles:[
      (n,d)=>`ë¬´ë£Œ ë°°ë‹¹ ë§ˆì§„(ì˜¤ë²„ë¼ìš´ë“œ) Â· ì˜¤ëŠ˜ TOP${n} (ë³µì› ë§í¬)`,
      (n,d)=>`ì˜¤ëŠ˜ ê²½ê¸° ì •ë¦¬ TOP${n} Â· ë§ˆì§„/EV (ë³µì› ë§í¬)`,
      (n,d)=>`í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° ìˆ˜ì§‘ Â· ì˜¤ëŠ˜ TOP${n} (ë³µì› ë§í¬)`
    ],
    leads:[
      ()=>`í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°ë¡œ ìˆ˜ì§‘í•œ ì˜¤ëŠ˜ ê²½ê¸°ë“¤ì…ë‹ˆë‹¤. ë§í¬ ì—´ë©´ ê²°ê³¼ ê·¸ëŒ€ë¡œ ë³µì›ë©ë‹ˆë‹¤.`,
      ()=>`ë¬´ë£Œ ë¶„ì„ê¸°: ë§ˆì§„/ê³µì •ë°°ë‹¹/EV ì •ë¦¬ìš©. ì•„ë˜ëŠ” ì˜¤ëŠ˜ ìˆ˜ì§‘ TOPì…ë‹ˆë‹¤.`,
      ()=>`ì˜¤ëŠ˜ ì²´í¬ìš©ìœ¼ë¡œ ì •ë¦¬í•´ë‘” ë¦¬ìŠ¤íŠ¸ ê³µìœ í•©ë‹ˆë‹¤. ë³µì› ë§í¬ í¬í•¨.`
    ],
    headers:[
      (n)=>`ì˜¤ëŠ˜ TOP${n} (ë§ˆì§„ ë‚®ì€ ìˆœ)`,
      (n)=>`TOP${n} ë¦¬ìŠ¤íŠ¸`,
      (n)=>`ì˜¤ëŠ˜ ìˆ˜ì§‘ TOP${n}`
    ]
  }
};

function nextPromoVariant(){
  let prev = 0;
  try{ prev = parseInt(localStorage.getItem(BUNDLE_PROMO_LS_VAR)||"0",10) || 0; }catch(e){ prev=0; }
  const r = Math.floor(Math.random()*PROMO_VARIANTS);
  const v = (r===prev) ? ((r+1)%PROMO_VARIANTS) : r;
  try{ localStorage.setItem(BUNDLE_PROMO_LS_VAR, String(v)); }catch(e){}
  return v;
}
function currentPromoVariant(){
  let v = 0;
  try{ v = parseInt(localStorage.getItem(BUNDLE_PROMO_LS_VAR)||"0",10) || 0; }catch(e){ v=0; }
  if(v<0 || v>=PROMO_VARIANTS) v=0;
  return v;
}

function pickTemplate(styleKey, variant, n){
  const t = PROMO_TEMPLATES[styleKey] || PROMO_TEMPLATES.promo;
  const d = todayStr();
  const v = Math.max(0, Math.min(PROMO_VARIANTS-1, variant|0));
  return {
    title: t.titles[v](n,d),
    lead:  t.leads[v](),
    header: t.headers[v](n)
  };
}

// === ì¡°ê±´ë¶€ ì—…ì²´ í‹°ì €(1ê°œ) ===
const PROMO_VENDOR_POOL = ["card10","card11","card8","card7"];
const PROMO_VENDOR_FIXED = ["card1","card2","card3","card4"];
const PROMO_VENDOR_DATA = {
  card1:{ title:"ì–´ëŠë‚ ", benefit:"ì…í”Œ 5+2 / 10+3 / 20+4 Â· ì²«ì¶© 10% (ê³ ì•¡ì „ìš©)" },
  card2:{ title:"OK Bet", benefit:"ì‹ ê·œ 77ë§Œì› Â· ì½”ì¸ ì…/ì¶œê¸ˆ Â· ì—…ë°ì´íŠ¸" },
  card3:{ title:"SPEED Bet", benefit:"ì‹ ê·œ 77ë§Œì› Â· ì½”ì¸ ì…/ì¶œê¸ˆ Â· ì—…ë°ì´íŠ¸" },
  card4:{ title:"VEGAS", benefit:"ê³ ì•¡ì „ìš© Â· ì…í”Œ ìµœëŒ€ 30% Â· ì¹´ì§€ë…¸ ì…í”Œ" },
  card7:{ title:"CAPS", benefit:"ë¯¸ê²œ ì²«ì¶© 5% Â· í˜ì´ë°± 5% Â· ì¶œì„ 30ë§Œì›" },
  card8:{ title:"BETZY", benefit:"ìŠ¤í¬ì¸  ì²«ì¶© 10% Â· í˜ì´ë°± 5% Â· ì¶œì„ 30ë§Œì›" },
  card10:{ title:"RED HULK", benefit:"ì‹ ê·œ 30% Â· ë§¤ì¶© 10% Â· í˜ì´ë°± 5%" },
  card11:{ title:"TOP GUN", benefit:"ì‹ ê·œ 30% Â· ë§¤ì¶© 10% Â· í˜ì´ë°± 5%" }
};

function hashStr(s){
  s = String(s||"");
  let h = 2166136261;
  for(let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h>>>0);
}

function shouldInsertVendor(items){
  const ms = (items||[]).map(it=> (typeof it.mainMarginPct==="number") ? it.mainMarginPct : null).filter(v=>v!=null);
  const min = ms.length ? Math.min(...ms) : null;
  const pos = (items||[]).filter(it=> typeof it.bestEVPct==="number" && it.bestEVPct > 0).length;
  return (min!=null && min<=3.20) || (pos>=1);
}

function pickVendorId(channelKey){
  const seed = `${todayStr()}|${channelKey}|vendor`;
  const idx = hashStr(seed) % PROMO_VENDOR_POOL.length;
  return PROMO_VENDOR_POOL[idx] || "card2";
}

function vendorLine(utm, shortUrl, withLink, vendorId){
  const v = PROMO_VENDOR_DATA[vendorId] || PROMO_VENDOR_DATA.card2;
  const origin = (location && location.origin) ? location.origin : "https://88st.cloud";
  const url = applyUtmToUrl(origin.replace(/\/$/,"") + `/?v=${vendorId}#vendorTop`, utm);
  const link = withLink ? fmtUrlForBoard(url, shortUrl) : "";
  const benefit = v.benefit ? v.benefit : "";
  if(link){
    return `ğŸ ì¸ì¦ì—…ì²´ 1ê°œ(ì¡°ê±´ë¶€): ${v.title} Â· ${benefit} Â· ${link}`;
  }
  return `ğŸ ì¸ì¦ì—…ì²´ 1ê°œ(ì¡°ê±´ë¶€): ${v.title} Â· ${benefit}`;
}

function buildBundlePromo(items, opts){
  opts = opts || {};
  const elCh   = document.getElementById("bundlePromoChannel");
  const elSty  = document.getElementById("bundlePromoStyle");
  const elLn   = document.getElementById("bundlePromoLinks");
  const elShort= document.getElementById("bundlePromoShortUrl");
  const elComp = document.getElementById("bundlePromoCompact");
  const elVend = document.getElementById("bundlePromoVendor");
  const elOneT = document.getElementById("bundlePromoOneTarget");

  const channelKey = elCh ? elCh.value : "tochatsa";
  const styleKey   = elSty ? elSty.value : "promo";
  const linksMode  = elLn ? elLn.value : "top3";
  const shortUrl   = !!(elShort && elShort.checked);
  const compact    = !!(elComp && elComp.checked);
  const vendorOn   = !!(elVend && elVend.checked);
  const oneTarget  = elOneT ? elOneT.value : "analysis";

  const utm = promoUtm(channelKey, styleKey);
  const origin = (location && location.origin) ? location.origin : "https://88st.cloud";
  const analysisUrl = applyUtmToUrl(origin.replace(/\/$/,"") + "/analysis/", utm);

  const nTotal = Math.min(10, (items||[]).length);
  const linkN = (linksMode==="top5") ? 5 : (linksMode==="all" ? nTotal : 3);
  const tplVar = (opts.advanceVariant) ? nextPromoVariant() : currentPromoVariant();
  const tpl = pickTemplate(styleKey, tplVar, Math.min(linkN, nTotal));

  const top3 = bundleTop3OneLine(items);

  // ë§í¬ ì •ì±…
  const allowAnyLink = (linksMode !== "none");
  const singleLinkOnly = (linksMode === "one");
  const allowItemLinks = (linksMode === "top3" || linksMode === "top5" || linksMode === "all");
  const allowAnalysisLink = allowAnyLink && (!singleLinkOnly || oneTarget==="analysis");
  const allowVendorLink = allowAnyLink && (!singleLinkOnly || oneTarget==="vendor");

  const lines = [];
  lines.push(tpl.title);

  // lead + analysis link
  if(allowAnalysisLink){
    const a = fmtUrlForBoard(analysisUrl, shortUrl);
    if(compact){
      lines.push(`${tpl.lead} Â· ë¶„ì„ê¸°: ${a}`);
    }else{
      lines.push(tpl.lead);
      lines.push(`ë¶„ì„ê¸°(ë¬´ë£Œ): ${a}`);
    }
  }else{
    // ë§í¬ 0ê°œ or ë§í¬ 1ê°œ(ì—…ì²´)ì¸ ê²½ìš°: ë§í¬ ëŒ€ì‹  ì•ˆë‚´ ë¬¸êµ¬
    const hint = (linksMode==="none") ? "88st[dot]cloud ì ‘ì† â†’ /analysis" : "ë¶„ì„ê¸°: 88st[dot]cloud/analysis";
    if(compact) lines.push(`${tpl.lead} Â· ${hint}`);
    else{
      lines.push(tpl.lead);
      lines.push(hint);
    }
  }

  if(top3){
    if(compact) lines.push(top3.replace(/^TOP3:\s*/,"TOP3: "));
    else lines.push(top3);
  }

  // ì¡°ê±´ë¶€ ì—…ì²´ í‹°ì € 1ê°œ
  let vendorInserted = false;
  if(vendorOn && shouldInsertVendor(items)){
    const vid = pickVendorId(channelKey);
    const vline = vendorLine(utm, shortUrl, allowVendorLink, vid);
    if(compact) lines.push(vline);
    else{
      lines.push("");
      lines.push(vline);
      lines.push("");
    }
    vendorInserted = true;
  }else{
    if(!compact) lines.push("");
  }

  // list header
  const header = tpl.header || `ì˜¤ëŠ˜ ìˆ˜ì§‘ ${nTotal}ê²½ê¸°`;
  if(!compact) lines.push(header);
  else lines.push(header);

  // list items
  const listItems = (items||[]).slice(0, nTotal);
  for(let i=0;i<listItems.length;i++){
    const it = listItems[i];
    const sportName = (SPORT_CFG[it.sport] || SPORT_CFG.soccer).name || (it.sport||"");
    const teams = (it.teams && String(it.teams).trim()) ? String(it.teams).trim() : `ê²½ê¸° ${i+1}`;
    const m = (typeof it.mainMarginPct==="number") ? `ë§ˆì§„ ${it.mainMarginPct.toFixed(2)}%` : "ë§ˆì§„ -";
    const ev = (typeof it.bestEVPct==="number") ? `EV ${(it.bestEVPct>=0?"+":"-")}${Math.abs(it.bestEVPct).toFixed(2)}%` : "EV ë¯¸ì…ë ¥";

    let line = (styleKey==="tg")
      ? `${i+1}) ${teams} Â· ${m} Â· ${ev}`
      : `${i+1}) ${teams} (${sportName}) Â· ${m} Â· ${ev}`;

    // ë§í¬ í¬í•¨ (ê²Œì‹œíŒ ê·œì¹™ ì˜µì…˜)
    if(allowItemLinks && i < linkN){
      const link = applyUtmToUrl(it.link || "", utm);
      const f = fmtUrlForBoard(link, shortUrl);
      if(f){
        if(compact) line += ` Â· ë§í¬ ${f}`;
        else{
          lines.push(line);
          lines.push(`   ë§í¬: ${f}`);
          if(!compact) lines.push("");
          continue;
        }
      }
    }

    lines.push(line);
    if(!compact) lines.push("");
  }

  if(!allowItemLinks){
    if(!compact) lines.push("");
    lines.push("â€» ë³µì› ë§í¬ëŠ” ë¶„ì„ê¸°ì—ì„œ â€˜ì˜¤ëŠ˜ ìˆ˜ì§‘ ë¬¶ìŒâ€™ â†’ â€˜ë¬¸êµ¬/ë§í¬ ë³µì‚¬â€™ë¡œ ì–»ì„ ìˆ˜ ìˆì–´ìš”.");
  }else if(linkN < nTotal){
    lines.push(`â€» ë§í¬ëŠ” TOP${linkN}ë§Œ í¬í•¨(ê²Œì‹œíŒ ê·œì¹™/í•„í„° ëŒ€ì‘).`);
  }

  lines.push("â€» ë§í¬ ì—´ë©´ ì…ë ¥/ê²°ê³¼ê°€ ê·¸ëŒ€ë¡œ ë³µì›ë©ë‹ˆë‹¤(st)");

  // compact ì •ë¦¬
  let text = lines.join("\n");
  if(compact){
    text = text.replace(/\n{2,}/g,"\n").trim();
  }else{
    text = text.replace(/\n{3,}/g,"\n\n").trim();
  }

  return { title: tpl.title, lead: tpl.lead, text, channelKey, styleKey, linksMode, shortUrl, compact, vendorInserted, oneTarget };
}

function updateBundlePromo(items, opts){
  const ta = document.getElementById("bundlePromoText");
  if(!ta) return;
  const p = buildBundlePromo(items || getBundleItems(10), opts||{});
  ta.value = p.text || "";
}

function regenBundlePromo(){
  try{
    const items = getBundleItems(10);
    updateBundlePromo(items, { advanceVariant:true });
    toast("ìƒˆ ë¬¸êµ¬ë¡œ ë°”ê¿¨ì–´ìš”");
  }catch(e){}
}

async function copyBundlePromo(){
  const items = getBundleItems(10);
  if(!items.length) return;
  const p = buildBundlePromo(items, { advanceVariant:true });
  try{
    await navigator.clipboard.writeText(p.text);
    toast("í™ë³´ê¸€ì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤");
    try{ track("bundle_copy_promo", { channel: p.channelKey, tone: p.styleKey, links: p.linksMode, short_url: p.shortUrl?1:0, compact: p.compact?1:0, vendor: p.vendorInserted?1:0, page_path: location.pathname }); }catch(e){}
  }catch(e){ toast("ë³µì‚¬ ì‹¤íŒ¨"); }
}

async function copyBundlePromoTitle(){
  const items = getBundleItems(10);
  if(!items.length) return;
  const p = buildBundlePromo(items);
  try{
    await navigator.clipboard.writeText(p.title);
    toast("ì œëª©ì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤");
    try{ track("bundle_copy_promo_title", { channel: p.channelKey, tone: p.styleKey, page_path: location.pathname }); }catch(e){}
  }catch(e){ toast("ë³µì‚¬ ì‹¤íŒ¨"); }
}

async function copyBundlePromoLead(){
  const items = getBundleItems(10);
  if(!items.length) return;
  const p = buildBundlePromo(items);
  try{
    await navigator.clipboard.writeText(p.lead);
    toast("ë§ë¨¸ë¦¬ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤");
    try{ track("bundle_copy_promo_lead", { channel: p.channelKey, tone: p.styleKey, page_path: location.pathname }); }catch(e){}
  }catch(e){ toast("ë³µì‚¬ ì‹¤íŒ¨"); }
}

function setupBundlePromo(){
  const sel = document.getElementById("bundlePromoChannel");
  const sty = document.getElementById("bundlePromoStyle");
  const lnk = document.getElementById("bundlePromoLinks");
  const one = document.getElementById("bundlePromoOneTarget");
  const sh  = document.getElementById("bundlePromoShortUrl");
  const cp  = document.getElementById("bundlePromoCompact");
  const vd  = document.getElementById("bundlePromoVendor");
  if(!sel || !sty || !lnk) return;

  // options (only once)
  if(!sel.options.length){
    for(const ch of BUNDLE_PROMO_CHANNELS){
      const opt = document.createElement("option");
      opt.value = ch.key;
      opt.textContent = ch.label;
      sel.appendChild(opt);
    }
  }

  const savedCh    = localStorage.getItem(BUNDLE_PROMO_LS_CH) || "tochatsa";
  const savedStyle = localStorage.getItem(BUNDLE_PROMO_LS_STYLE);
  const savedLinks = localStorage.getItem(BUNDLE_PROMO_LS_LINKS) || "top3";
  const savedShort = localStorage.getItem(BUNDLE_PROMO_LS_SHORTURL);
  const savedComp  = localStorage.getItem(BUNDLE_PROMO_LS_COMPACT);
  const savedVend  = localStorage.getItem(BUNDLE_PROMO_LS_VENDOR);
  const savedOne   = localStorage.getItem(BUNDLE_PROMO_LS_ONE_TGT) || "analysis";

  if([...sel.options].some(o=>o.value===savedCh)) sel.value = savedCh;

  const ch = getPromoChannel(sel.value);
  const defStyle = (ch && ch.defaultStyle) ? ch.defaultStyle : "promo";
  if(savedStyle && [...sty.options].some(o=>o.value===savedStyle)) sty.value = savedStyle;
  else sty.value = defStyle;

  if([...lnk.options].some(o=>o.value===savedLinks)) lnk.value = savedLinks;

  if(one && [...one.options].some(o=>o.value===savedOne)) one.value = savedOne;

  if(sh) sh.checked = (savedShort==="1" || savedShort==="true");
  if(cp) cp.checked = (savedComp==="1"  || savedComp==="true");
  if(vd) vd.checked = (savedVend==null ? true : (savedVend==="1" || savedVend==="true"));

  const refresh = (advanceVariant=false)=>{
    try{ localStorage.setItem(BUNDLE_PROMO_LS_CH, sel.value); }catch(e){}
    try{ localStorage.setItem(BUNDLE_PROMO_LS_STYLE, sty.value); }catch(e){}
    try{ localStorage.setItem(BUNDLE_PROMO_LS_LINKS, lnk.value); }catch(e){}
    try{ if(sh) localStorage.setItem(BUNDLE_PROMO_LS_SHORTURL, sh.checked?"1":"0"); }catch(e){}
    try{ if(cp) localStorage.setItem(BUNDLE_PROMO_LS_COMPACT,  cp.checked?"1":"0"); }catch(e){}
    try{ if(vd) localStorage.setItem(BUNDLE_PROMO_LS_VENDOR,   vd.checked?"1":"0"); }catch(e){}
    try{ if(one) localStorage.setItem(BUNDLE_PROMO_LS_ONE_TGT, one.value); }catch(e){}

    if(one){
      one.style.display = (lnk.value==="one") ? "" : "none";
    }

    try{
      const items = getBundleItems(10);
      updateBundlePromo(items, { advanceVariant: !!advanceVariant });
    }catch(e){}
  };

  sel.addEventListener("change", ()=>{
    const ch2 = getPromoChannel(sel.value);
    if(ch2 && ch2.defaultStyle) sty.value = ch2.defaultStyle;
    refresh(true);
  });
  sty.addEventListener("change", ()=>refresh(true));
  lnk.addEventListener("change", ()=>refresh(true));
  if(one) one.addEventListener("change", ()=>refresh(true));
  if(sh)  sh.addEventListener("change", ()=>refresh(true));
  if(cp)  cp.addEventListener("change", ()=>refresh(true));
  if(vd)  vd.addEventListener("change", ()=>refresh(true));

  refresh(false);
}


function downloadBundleCard(){
  const canvas = document.getElementById("bundleCanvas");
  if(!canvas) return;
  try{
    canvas.toBlob((blob)=>{
      if(!blob) return;
      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = "88-bundle-today.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 800);
      toast("ì´ë¯¸ì§€ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤");
      try{ track("bundle_download_image", { page_path: location.pathname }); }catch(e){}
    }, "image/png", 1.0);
  }catch(e){ toast("ì €ì¥ ì‹¤íŒ¨"); }
}

function setupBundleBackdropClose(){
  const modal = document.getElementById("bundleShareModal");
  if(!modal) return;
  modal.addEventListener("click", (e)=>{
    if(e.target === modal) closeBundleShare();
  });
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      try{ if(modal.style.display === "flex") closeBundleShare(); }catch(err){}
    }
  });
}

function setupShareCardBackdropClose(){
  const modal = document.getElementById("shareCardModal");
  if(modal){
    modal.addEventListener("click", (e)=>{
      if(e.target === modal) closeShareCard();
    });
  }
}

/* =========================
   í† ìŠ¤íŠ¸
========================= */
let toastTimer=null;
function toast(msg){
  const el=document.getElementById("toast88");
  if(!el) return;
  el.textContent=msg;
  el.style.opacity="1";
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{ el.style.opacity="0"; }, 1400);
}

/* =========================
   ë§ˆì§„ ëŒ€ì‹œë³´ë“œ ë Œë”
========================= */
function renderMarginDash(last){
  const sport = last?.sport || val("sport") || "soccer";
  const cfg = SPORT_CFG[sport] || SPORT_CFG.soccer;

  // ì…ë ¥ì—ì„œ ì¦‰ì„ìœ¼ë¡œë„ ê³„ì‚° ê°€ëŠ¥(ê³„ì‚° ì „ì—ë„ ê¸°ë³¸ í‘œì‹œ)
  const is3 = (cfg.main==="3way");
  let main = null;
  try{
    if(is3){
      const h=parseOdds(val("main3OddsH")), d=parseOdds(val("main3OddsD")), a=parseOdds(val("main3OddsA"));
      if(h && d && a) main = compute3Way(h,d,a).marginPct;
    }else{
      const a=parseOdds(val("main2OddsA")), b=parseOdds(val("main2OddsB"));
      if(a && b) main = compute2Way(a,b,0).marginPct;
    }
  }catch(e){}

  let ou = null;
  try{
    const o=parseOdds(val("overOdds")), u=parseOdds(val("underOdds"));
    if(o && u){
      let push = parsePct(val("ouPush"));
      if(push==null) push=(cfg.defaults.ouPush||0)/100;
      ou = compute2Way(o,u,push).marginPct;
    }
  }catch(e){}

  let hc = null;
  try{
    const a=parseOdds(val("handicapOddsA")), b=parseOdds(val("handicapOddsB"));
    if(a && b){
      let push = parsePct(val("handicapPush"));
      if(push==null) push=(cfg.defaults.hcPush||0)/100;
      hc = compute2Way(a,b,push).marginPct;
    }
  }catch(e){}

  if(last){
    if(typeof last.main === "number") main = last.main;
    if(typeof last.ou === "number") ou = last.ou;
    if(typeof last.hc === "number") hc = last.hc;
  }

  const items = [
    { key:"main", title:"ë©”ì¸", margin: main },
    { key:"ou", title:"ì˜¤ë²„/ì–¸ë”", margin: ou },
    { key:"hc", title:"í•¸ë””ìº¡", margin: hc }
  ];

  const html = items.map(it=>{
    if(typeof it.margin !== "number"){
      return `
        <div class="m-card">
          <div class="m-head">
            <div class="m-name">${it.title}</div>
            <div class="chip mid">ë¯¸ì…ë ¥</div>
          </div>
          <div class="m-lines">ë°°ë‹¹ì„ ì…ë ¥í•˜ë©´ ë§ˆì§„/íŒì •ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      `;
    }
    const íŒì • = classifyMargin(sport, it.key, it.margin);
    return `
      <div class="m-card">
        <div class="m-head">
          <div class="m-name">${it.title}</div>
          <div class="chip ${íŒì •.cls}">${íŒì •.label}</div>
        </div>
        <div class="m-lines">
          ê¸°ì¤€(ë‚®ìŒ/ë³´í†µ/ì£¼ì˜): <b>${MARGIN_RULE[sport][it.key][0]}%</b> / <b>${MARGIN_RULE[sport][it.key][1]}%</b> / <b>${MARGIN_RULE[sport][it.key][2]}%</b>
        </div>
      </div>
    `;
  }).join("");

  const box = document.getElementById("marginDash");
  if(box) box.innerHTML = html;
}

/* =========================
   íˆìŠ¤í† ë¦¬ ì €ì¥/ë³µì›/ë¹„êµ
========================= */
function readHistory(){
  try{
    const raw = localStorage.getItem(HIST_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    return [];
  }
}
function writeHistory(arr){
  localStorage.setItem(HIST_KEY, JSON.stringify(arr.slice(0,50)));
}
function addHistory(rec){
  // ë§ˆì§„ ì—†ìœ¼ë©´ ì €ì¥ ì•ˆí•¨? -> ìµœì†Œ ë©”ì¸ ìˆìœ¼ë‹ˆ ì €ì¥
  const arr = readHistory();
  arr.unshift(rec);
  writeHistory(arr);

  try{
    track("save_history", {
      sport: rec.sport,
      level: rec.level,
      market_type: (rec.mainMode ? rec.mainMode : (((SPORT_CFG[rec.sport]||SPORT_CFG.soccer).main === "3way") ? "3way" : "2way"))
    });
  }catch(e){}

  renderHistory();
}
function clearHistory(){
  if(!confirm("íˆìŠ¤í† ë¦¬ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) return;
  localStorage.removeItem(HIST_KEY);
  renderHistory();
  renderTop3();
  toast("íˆìŠ¤í† ë¦¬ ì‚­ì œ ì™„ë£Œ");
}


/* =========================
   ì •ì°©/ì •í™•ë„ ì²´ê°ìš© UX ë ˆì´ì–´
   - ê³„ì‚° ë¡œì§ ë³€ê²½ ì—†ìŒ
   - ì…ë ¥ ê²€ì¦/ìŠ¤ëƒ…ìƒ·/ë‚´ ì„±ê³¼(ìŠ¹íŒ¨ ê¸°ë¡)ë§Œ ì¶”ê°€
========================= */

// íŒë‹¨(ì¶”ì²œ/ì£¼ì˜/PASS) í‚¤
function adviceKeyFromMetrics(bestEVPct, mainMarginPct){
  const ev = (typeof bestEVPct==="number") ? bestEVPct : null; // %
  const m = (typeof mainMarginPct==="number") ? mainMarginPct : null; // %
  if(ev!=null){
    if(ev >= 2) return "rec";
    if(ev >= 0) return "caution";
    return "pass";
  }
  if(m!=null){
    if(m <= 3) return "rec";
    if(m <= 6) return "caution";
    return "pass";
  }
  return "caution";
}
function adviceKeyForRecord(h){
  return adviceKeyFromMetrics(h?.bestEVPct, h?.markets?.main?.marginPct);
}
function adviceInfoForKey(key){
  if(key==="rec") return { text:"ì¶”ì²œ", cls:"good" };
  if(key==="pass") return { text:"PASS", cls:"bad" };
  return { text:"ì£¼ì˜", cls:"warn" };
}

// ìŠ¹/íŒ¨/ì·¨ì†Œ ë¼ë²¨
function outcomeInfo(v){
  if(v==="W") return { text:"âœ… ì ì¤‘", cls:"win" };
  if(v==="L") return { text:"âŒ ë¯¸ì ì¤‘", cls:"lose" };
  if(v==="V") return { text:"âšª ì·¨ì†Œ", cls:"void" };
  return { text:"ë¯¸ê¸°ë¡", cls:"none" };
}

// íˆìŠ¤í† ë¦¬ ê²°ê³¼ ê¸°ë¡(ìŠ¹/íŒ¨/ì·¨ì†Œ)
function setOutcome(id, v){
  const arr = readHistory();
  const idx = arr.findIndex(x=>x.id===id);
  if(idx<0){
    toast("íˆìŠ¤í† ë¦¬ì—ì„œ í•­ëª©ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”.");
    return;
  }
  const next = (v==="W"||v==="L"||v==="V") ? v : "";
  arr[idx].outcome = next || null;
  arr[idx].outcomeAt = next ? Date.now() : null;

  // advice ë©”íƒ€ê°€ ì—†ë˜ ì˜ˆì „ í•­ëª©ë„ ë³´ì •
  if(!arr[idx].advice){
    arr[idx].advice = adviceKeyForRecord(arr[idx]);
  }
  writeHistory(arr);
  renderHistory();         // ë‚´ë¶€ì—ì„œ renderPerfBoxë„ í˜¸ì¶œë¨
  refreshTrustLine();
  toast(next ? "ê²°ê³¼ ê¸°ë¡ ì™„ë£Œ" : "ê¸°ë¡ í•´ì œ ì™„ë£Œ");
}
function markOutcome(v){
  if(!LAST_RECORD || !LAST_RECORD.id){
    toast("ë¨¼ì € ê³„ì‚° ê²°ê³¼ë¥¼ ë§Œë“  ë’¤ ê¸°ë¡í•  ìˆ˜ ìˆì–´ìš”.");
    return;
  }
  setOutcome(LAST_RECORD.id, v);
}

// ë‚´ ì„±ê³¼ ì§‘ê³„
function computePerfStats(){
  const arr = readHistory();
  const init = ()=>({ w:0, l:0, v:0, n:0, rate:null });
  const out = { total:init(), by:{ rec:init(), caution:init(), pass:init() } };

  arr.forEach(h=>{
    const key = (h.advice || adviceKeyForRecord(h));
    const bucket = out.by[key] || out.by.caution;
    const tgtAll = out.total;

    const o = h.outcome;
    if(o==="W"){ bucket.w++; tgtAll.w++; }
    else if(o==="L"){ bucket.l++; tgtAll.l++; }
    else if(o==="V"){ bucket.v++; tgtAll.v++; }
  });

  const finalize = (b)=>{
    b.n = b.w + b.l;
    b.rate = (b.n>0) ? (b.w / b.n) : null;
    return b;
  };
  finalize(out.total);
  Object.keys(out.by).forEach(k=>finalize(out.by[k]));
  return out;
}
function pct(x){
  if(x==null) return "â€”";
  return Math.round(x*100) + "%";
}

// ë‚´ ì„±ê³¼ ë°•ìŠ¤ ë Œë”
function renderPerfBox(){
  const box = document.getElementById("perfBox");
  const grid = document.getElementById("perfGrid");
  const sub = document.getElementById("perfSub");
  const meta = document.getElementById("perfMeta");
  if(!box || !grid || !sub || !meta) return;

  const s = computePerfStats();
  const totalN = s.total.n;
  if(totalN<=0 && (s.total.v<=0)){
    box.style.display = "none";
    return;
  }
  box.style.display = "block";

  meta.textContent = `í‘œë³¸ ${totalN} Â· ì·¨ì†Œ ${s.total.v}`;
  sub.innerHTML = `ë‚´ê°€ <b>ê²°ê³¼(ì ì¤‘/ë¯¸ì ì¤‘)</b>ë¥¼ ì²´í¬í•œ í•­ëª©ë§Œ ì§‘ê³„ë©ë‹ˆë‹¤. í‘œë³¸ì´ ì ìœ¼ë©´ ìˆ˜ì¹˜ëŠ” ì°¸ê³ ìš©ì…ë‹ˆë‹¤.`;

  const makeTile = (label, key)=>{
    const b = s.by[key];
    const info = adviceInfoForKey(key);
    return `
      <div class="perf-tile">
        <div class="perf-k">${label} <span class="${info.cls}"><b>${info.text}</b></span></div>
        <div class="perf-v">${pct(b.rate)}</div>
        <div class="perf-n">n=${b.n} (ì ì¤‘ ${b.w} / ë¯¸ì ì¤‘ ${b.l})</div>
      </div>
    `;
  };

  grid.innerHTML = `
    ${makeTile("ì¶”ì²œì¼ ë•Œ", "rec")}
    ${makeTile("ì£¼ì˜ì¼ ë•Œ", "caution")}
    ${makeTile("PASSì¼ ë•Œ", "pass")}
  `;
}

// ê²°ê³¼ ìƒë‹¨ì— â€œë‚´ ê¸°ë¡ ê¸°ì¤€â€ ì‹ ë¢° ë¼ì¸
function buildTrustLineHtml(adviceKey){
  const s = computePerfStats();
  const b = s.by[adviceKey] || s.by.caution;
  const info = adviceInfoForKey(adviceKey);

  if(b.n < 10){
    return `ë‚´ ê¸°ë¡ ê¸°ì¤€: <b>í‘œë³¸ ë¶€ì¡±</b> (í˜„ì¬ n=${b.n}). ì•„ë˜ <b>ìƒì„¸ ì§€í‘œ</b>ê¹Œì§€ í™•ì¸í•˜ì„¸ìš”.`;
  }
  return `ë‚´ ê¸°ë¡ ê¸°ì¤€: <span class="${info.cls}"><b>${info.text}</b></span> êµ¬ê°„ ì ì¤‘ë¥  <b>${pct(b.rate)}</b> (n=${b.n}).`;
}
function refreshTrustLine(){
  const tl = document.querySelector(".trustLine");
  const hc = document.querySelector(".heroConclusion");
  if(!tl || !hc) return;
  let key = "caution";
  if(hc.classList.contains("good")) key = "rec";
  else if(hc.classList.contains("bad")) key = "pass";
  tl.innerHTML = buildTrustLineHtml(key);
}

// ===== ìµœê·¼ ì…ë ¥ ìŠ¤ëƒ…ìƒ·(ìµœê·¼ 5ê°œ) =====
function readSnaps(){
  try{
    const raw = localStorage.getItem(SNAP_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}
function writeSnaps(arr){
  localStorage.setItem(SNAP_KEY, JSON.stringify(arr.slice(0,5)));
}
function stateSig(state){
  // ë„ˆë¬´ ì¦ì€ ìŠ¤ëƒ…ìƒ·ì„ ë§‰ê¸° ìœ„í•œ ê°„ë‹¨ ì‹œê·¸ë‹ˆì²˜
  const keys = ["sport","level","league","teams","main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA","totalLine","overOdds","underOdds","handicapLine","handicapOddsA","handicapOddsB","myProb","myOverProb"];
  const o = {};
  keys.forEach(k=>o[k]=state?.[k] ?? "");
  return JSON.stringify(o);
}
function maybePushSnapshot(state, force){
  if(!state) return;
  try{
    const now = Date.now();
    const sig = stateSig(state);
    const metaRaw = localStorage.getItem(SNAP_META_KEY);
    const meta = metaRaw ? JSON.parse(metaRaw) : {};
    const lastAt = meta?.lastAt || 0;
    const lastSig = meta?.lastSig || "";

    if(!force){
      if(now - lastAt < 20000) return;  // 20ì´ˆ ì¿¨ë‹¤ìš´
      if(sig === lastSig) return;
    }

    const arr = readSnaps();
    const id = now.toString(36) + Math.random().toString(36).slice(2,6);
    arr.unshift({
      id,
      at: now,
      sport: state.sport,
      level: state.level,
      league: state.league,
      teams: state.teams,
      state
    });
    writeSnaps(arr);

    localStorage.setItem(SNAP_META_KEY, JSON.stringify({ lastAt: now, lastSig: sig }));
  }catch(e){}
}
function renderSnaps(){
  const wrap = document.getElementById("snapWrap");
  const list = document.getElementById("snapList");
  const meta = document.getElementById("snapMeta");
  if(!wrap || !list || !meta) return;

  const arr = readSnaps();
  if(!view.length){
    wrap.style.display = "none";
    return;
  }
  wrap.style.display = "block";
  meta.textContent = `ì´ ${arr.length}ê°œ`;

  list.innerHTML = arr.map(s=>{
    const d = new Date(s.at);
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    const cfg = SPORT_CFG[s.sport] || {name:s.sport||"-"};
    const lev = levelLabel(s.level);
    const label = `${hh}:${mm} Â· ${cfg.name} Â· ${lev}`;
    const extra = (s.teams || s.league) ? escapeHtml(s.teams || s.league) : "";
    return `<button class="snap-chip" type="button" onclick="restoreSnapshot('${s.id}')">${label}${extra?` <span class="snap-meta">Â· ${extra}</span>`:""}</button>`;
  }).join("");

  // ì´ë¯¸ ì €ì¥ëœ í•­ëª© í‘œì‹œ
  try{ if(__PASTE_SAVED_SIGS.size===0) buildSavedSigSet(); }catch(e){}
  try{
    __PASTE_MULTI.forEach((g, idx)=>{
      if(!g) return;
      if(pasteAlreadySaved(g)){
        const el = $("pasteItem_"+idx);
        if(el) el.classList.add("is-saved");
        const stat = $("pasteStat_"+idx);
        if(stat){ stat.innerHTML = "ì €ì¥ë¨"; stat.style.display="block"; }
      }
    });
  }catch(e){}
}
function restoreSnapshot(id){
  const arr = readSnaps();
  const s = arr.find(x=>x.id===id);
  if(!s || !s.state){
    toast("ìŠ¤ëƒ…ìƒ·ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”.");
    return;
  }
  const st = s.state;

  setVal("sport", st.sport || "soccer");
  setVal("level", st.level || "simple");
  setVal("league", st.league || "");
  setVal("teams", st.teams || "");

  setVal("main2OddsA", st.main2OddsA || "");
  setVal("main2OddsB", st.main2OddsB || "");
  setVal("main3OddsH", st.main3OddsH || "");
  setVal("main3OddsD", st.main3OddsD || "");
  setVal("main3OddsA", st.main3OddsA || "");

  setVal("totalLine", st.totalLine || "");
  setVal("overOdds", st.overOdds || "");
  setVal("underOdds", st.underOdds || "");
  setVal("ouPush", st.ouPush || "");

  setVal("handicapLine", st.handicapLine || "");
  setVal("handicapOddsA", st.handicapOddsA || "");
  setVal("handicapOddsB", st.handicapOddsB || "");
  setVal("handicapPush", st.handicapPush || "");

  setVal("myProb", st.myProb || "");
  setVal("myOverProb", st.myOverProb || "");
  setVal("stake", st.stake || "");

  // í¼ì¹¨ ìƒíƒœ ë³µì›
  if(typeof st.handicapCollapsed==="boolean"){
    setCollapsed("handicapBody", !!st.handicapCollapsed);
  }
  if(typeof st.totalCollapsed==="boolean"){
    setCollapsed("totalBody", !!st.totalCollapsed);
  }

  onSportChange(true);
  onLevelChange(true);
  hideResult();
  renderMarginDash();
  saveState();
  toast("ìµœê·¼ ì…ë ¥ì„ ë³µì›í–ˆì–´ìš”.");
  try{ quickJump("main"); }catch(e){}
}

// ===== ì…ë ¥ ê²€ì¦/ê°€ì´ë“œ(ì‹¤ìˆ˜ ê°ì†Œ) =====
let _vTimer = null;
function setupValidation(){
  const oddsIds = ["main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA","overOdds","underOdds","handicapOddsA","handicapOddsB"];
  const probIds = ["myProb","myOverProb"];
  const allIds = oddsIds.concat(probIds).concat(["totalLine","handicapLine","ouPush","handicapPush","stake"]);

  const onAnyInput = ()=>{
    if(_vTimer) clearTimeout(_vTimer);
    _vTimer = setTimeout(()=>{ validateInputs(); }, 80);
  };

  allIds.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener("input", (e)=>{
      const t = String(e.target.value || "");
      // ìˆ«ì ì…ë ¥ ì •ë¦¬: ì‰¼í‘œ -> ì , í—ˆìš©ë¬¸ìë§Œ
      let s = t.replace(/,/g,".").replace(/[^\d.]/g,"");
      // ì  2ê°œ ì´ìƒ ë°©ì§€
      const parts = s.split(".");
      if(parts.length>2){
        s = parts[0] + "." + parts.slice(1).join("");
      }
      e.target.value = s;
      onAnyInput();
    });
    el.addEventListener("blur", ()=>{ onAnyInput(); });
  });

  // ì´ˆê¸° ê²€ì¦
  validateInputs();
}
function setInvalid(id, on){
  const el = document.getElementById(id);
  if(!el) return;
  if(on) el.classList.add("invalid");
  else el.classList.remove("invalid");
}
function showInputWarn(msg){
  const box = document.getElementById("inputWarn");
  if(!box) return;
  if(!msg){
    box.style.display="none";
    box.innerHTML="";
    return;
  }
  box.style.display="block";
  box.innerHTML = msg;
}
function validateInputs(){
  // ê¸°ë³¸: ëª¨ë“  invalid ì œê±°
  ["main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA","overOdds","underOdds","handicapOddsA","handicapOddsB","totalLine","handicapLine","myProb","myOverProb"].forEach(id=>setInvalid(id,false));

  const sport = val("sport");
  const cfg = SPORT_CFG[sport] || SPORT_CFG.soccer;
  const mainType = cfg.main;

  // ë©”ì¸ í•„ìˆ˜ ê²€ì¦
  let mainOk = true;
  let mainMsg = "";

  const oddsOk = (id)=>{
    const x = parseOdds(val(id));
    return (x!=null && x>=1.01 && x<=200);
  };

  if(mainType==="2way"){
    const aOk = oddsOk("main2OddsA");
    const bOk = oddsOk("main2OddsB");
    if(!aOk){ setInvalid("main2OddsA", true); mainOk=false; }
    if(!bOk){ setInvalid("main2OddsB", true); mainOk=false; }
    if(!mainOk) mainMsg = "ë©”ì¸ ë°°ë‹¹(2ê°œ)ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: <b>1.85</b> / <b>2.05</b>";
  }else{
    const hOk = oddsOk("main3OddsH");
    const dOk = oddsOk("main3OddsD");
    const aOk = oddsOk("main3OddsA");
    if(!hOk){ setInvalid("main3OddsH", true); mainOk=false; }
    if(!dOk){ setInvalid("main3OddsD", true); mainOk=false; }
    if(!aOk){ setInvalid("main3OddsA", true); mainOk=false; }
    if(!mainOk) mainMsg = "ë©”ì¸ ë°°ë‹¹(3ê°œ)ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: <b>2.10</b> / <b>3.20</b> / <b>3.40</b>";
  }

  // ì˜µì…˜ ì…ë ¥(ë¶€ë¶„ ì…ë ¥ ì‹œ ê²½ê³ )
  const totalAny = !!(val("totalLine") || val("overOdds") || val("underOdds"));
  const totalOk = !totalAny || (!!val("totalLine") && oddsOk("overOdds") && oddsOk("underOdds"));
  if(totalAny && !totalOk){
    if(!val("totalLine")) setInvalid("totalLine", true);
    if(!oddsOk("overOdds")) setInvalid("overOdds", true);
    if(!oddsOk("underOdds")) setInvalid("underOdds", true);
  }

  const hcAny = !!(val("handicapLine") || val("handicapOddsA") || val("handicapOddsB"));
  const hcOk = !hcAny || (!!val("handicapLine") && oddsOk("handicapOddsA") && oddsOk("handicapOddsB"));
  if(hcAny && !hcOk){
    if(!val("handicapLine")) setInvalid("handicapLine", true);
    if(!oddsOk("handicapOddsA")) setInvalid("handicapOddsA", true);
    if(!oddsOk("handicapOddsB")) setInvalid("handicapOddsB", true);
  }

  // í™•ë¥  ì…ë ¥(ì¤‘ê¸‰/ê³ ê¸‰ì—ì„œë§Œ ì˜ë¯¸)
  const level = val("level");
  const probOk = (id)=>{
    const t = String(val(id) || "").trim();
    if(!t) return true;
    const n = Number(t);
    return isFinite(n) && n>=0 && n<=100;
  };
  let probWarn = "";
  if(level!=="simple"){
    if(!probOk("myProb")){ setInvalid("myProb", true); probWarn = "ë‚´ ì˜ˆìƒ í™•ë¥ ì€ <b>0~100</b> ì‚¬ì´ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”."; }
    if(!probOk("myOverProb")){ setInvalid("myOverProb", true); probWarn = "ì˜¤ë²„ ì˜ˆìƒ í™•ë¥ ì€ <b>0~100</b> ì‚¬ì´ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”."; }
  }

  // ë²„íŠ¼ í™œì„±í™”/ì•ˆë‚´
  const btn = document.getElementById("btnCalc");
  if(btn) btn.disabled = !mainOk;

  const warnMsgs = [];
  if(!mainOk) warnMsgs.push(mainMsg);
  if(totalAny && !totalOk) warnMsgs.push("ì˜¤ë²„Â·ì–¸ë”ëŠ” <b>ê¸°ì¤€ì  + ì˜¤ë²„/ì–¸ë” ë°°ë‹¹</b>ì„ ëª¨ë‘ ì±„ìš°ë©´ ë¶„ì„ë©ë‹ˆë‹¤.");
  if(hcAny && !hcOk) warnMsgs.push("í•¸ë””ìº¡ì€ <b>ë¼ì¸ + ì–‘ìª½ ë°°ë‹¹</b>ì„ ëª¨ë‘ ì±„ìš°ë©´ ë¶„ì„ë©ë‹ˆë‹¤.");
  if(probWarn) warnMsgs.push(probWarn);

  showInputWarn(warnMsgs.length ? ("âš ï¸ ì…ë ¥ í™•ì¸<br>" + warnMsgs.map(s=>"â€¢ "+s).join("<br>")) : "");
  return mainOk;
}

/* íˆìŠ¤í† ë¦¬ UI */
let pickSet = new Set();
let historyFilter = "all";

function setHistoryFilter(f, btn){
  historyFilter = f;
  // í•„í„° ë°”ê¾¸ë©´ ì„ íƒì€ ì´ˆê¸°í™”(í˜¼ë™ ë°©ì§€)
  pickSet.clear();
  const wrap = document.querySelector(".history-filters");
  if(wrap){
    wrap.querySelectorAll(".seg").forEach(x=>x.classList.remove("on"));
  }
  if(btn) btn.classList.add("on");
  renderHistory();
}
function updatePickUI(){
  const n = pickSet.size;
  const c = document.getElementById("pickCount");
  if(c) c.textContent = String(n);
  const del = document.getElementById("btnDeleteSelected");
  if(del) del.disabled = (n===0);
  const cmp = document.getElementById("btnCompare");
  if(cmp) cmp.disabled = (n!==2);
}
function deleteSelected(){
  const ids = Array.from(pickSet);
  if(ids.length===0){
    toast("ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”");
    return;
  }
  if(!confirm(`ì„ íƒí•œ ${ids.length}ê°œ í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?`)) return;

  let arr = readHistory();
  arr = arr.filter(x=>!pickSet.has(x.id));
  writeHistory(arr);
  pickSet.clear();

  renderHistory();
  renderTop3();
  toast("ì„ íƒ ì‚­ì œ ì™„ë£Œ");
}



function renderHistory(){
  const list = document.getElementById("historyList");
  if(!list) return;

  const arr = readHistory();

  // ì„ íƒ ì •ë¦¬(ì‚­ì œ/í•„í„° ë“±ìœ¼ë¡œ ì‚¬ë¼ì§„ í•­ëª© ì œê±°)
  const idset = new Set(arr.map(x=>x.id));
  pickSet = new Set(Array.from(pickSet).filter(id=>idset.has(id)));

  // í•„í„° ì ìš©
  let view = arr;
  if(historyFilter === "rec"){
    view = arr.filter(h => (h.advice || adviceKeyForRecord(h)) === "rec");
  }else if(historyFilter === "untracked"){
    view = arr.filter(h => !h.outcome);
  }
  if(!arr.length){
    list.innerHTML = `
      <div class="demo-empty">
        <div class="demo-title">${(arr.length && historyFilter!=="all") ? "ì¡°ê±´ì— ë§ëŠ” ê¸°ë¡ì´ ì—†ì–´ìš”." : "íˆìŠ¤í† ë¦¬ê°€ ë¹„ì–´ìˆì–´ìš”."}</div>
        <div class="demo-desc">${(arr.length && historyFilter!=="all") ? "í•„í„° ì¡°ê±´ì— ë§ëŠ” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. <b>ì „ì²´</b>ë¡œ ë°”ê¾¸ê±°ë‚˜ ìƒˆë¡œ ê³„ì‚°í•´ë³´ì„¸ìš”." : "ì•„ë˜ <b>ì˜ˆì‹œ ë²„íŠ¼</b>ì„ ëˆŒëŸ¬ ì…ë ¥ì„ ìë™ ì±„ìš°ê³ , ë°”ë¡œ ê³„ì‚°ê¹Œì§€ ì‹¤í–‰í•´ë³¼ ìˆ˜ ìˆì–´ìš”."}</div>
        <div class="demo-btns">
          <button class="btn primary2" type="button" onclick="loadDemo('soccer')">âš½ ì¶•êµ¬ ì˜ˆì‹œë¡œ ê³„ì‚°</button>
          <button class="btn primary2" type="button" onclick="loadDemo('basketball')">ğŸ€ ë†êµ¬ ì˜ˆì‹œë¡œ ê³„ì‚°</button>
        </div>
        <div class="demo-note">â€» ì˜ˆì‹œëŠ” ìƒ˜í”Œ ë°ì´í„°ì´ë©°, ì‹¤ì œ ê²°ê³¼/ìŠ¹ë¥ ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
      </div>`;
    renderPerfBox();
    updatePickUI();
    return;
  }

  list.innerHTML = view.map(h=>{
    const cfg = SPORT_CFG[h.sport] || {name:h.sport||"-"};
    const mMain = h.markets?.main?.marginPct;
    const mOU = h.markets?.ou?.marginPct;
    const mHC = h.markets?.hc?.marginPct;

    const mainTag = (typeof mMain==="number") ? classifyMargin(h.sport,"main",mMain) : null;
    const ouTag = (typeof mOU==="number") ? classifyMargin(h.sport,"ou",mOU) : null;
    const hcTag = (typeof mHC==="number") ? classifyMargin(h.sport,"hc",mHC) : null;

    const evTxt = (typeof h.bestEVPct==="number") ? `${h.bestEVPct.toFixed(2)}%` : "-";
    const evCls = (h.evPositive) ? "good" : "warn";

    const checked = pickSet.has(h.id) ? "checked" : "";

    const adviceKey = (h.advice || adviceKeyForRecord(h));
    const adviceInfo = adviceInfoForKey(adviceKey);

    const out = outcomeInfo(h.outcome);

    return `
      <div class="h-item" onclick="onHistoryClick(event,'${h.id}')">
        <div class="h-top">
          <div>
            <div class="h-title">${h.time} Â· ${cfg.name} Â· ${levelLabel(h.level)} ${h.teams?`Â· ${escapeHtml(h.teams)}`:""}</div>
            <div class="h-sub">
              ë©”ì¸: ${mainTag?`<span class="${clsToTextColor(mainTag.cls)}">${mainTag.label}</span>`:"-"} /
              OU: ${ouTag?`<span class="${clsToTextColor(ouTag.cls)}">${ouTag.label}</span>`:"-"} /
              í•¸ë””: ${hcTag?`<span class="${clsToTextColor(hcTag.cls)}">${hcTag.label}</span>`:"-"}
              <br>
              ìµœê³  EV: <span class="${evCls}"><b>${evTxt}</b></span> Â·
              íŒë‹¨: <span class="${adviceInfo.cls}"><b>${adviceInfo.text}</b></span>
            </div>

            <div class="h-outcome" onclick="event.stopPropagation()">
              <div class="row">
                <div class="label">ê²°ê³¼ ê¸°ë¡</div>
                <span class="outTag ${out.cls}">${out.text}</span>
              </div>
              <div class="outBtns">
                <button class="oBtn ${h.outcome==='W'?'on':''}" type="button" onclick="setOutcome('${h.id}','W')">âœ… ì ì¤‘</button>
                <button class="oBtn ${h.outcome==='L'?'on':''}" type="button" onclick="setOutcome('${h.id}','L')">âŒ ë¯¸ì ì¤‘</button>
                <button class="oBtn ${h.outcome==='V'?'on':''}" type="button" onclick="setOutcome('${h.id}','V')">âšª ì·¨ì†Œ</button>
                <button class="oBtn ${(!h.outcome)?'on':''}" type="button" onclick="setOutcome('${h.id}','')">â†©ï¸ ë¯¸ê¸°ë¡</button>
              </div>
            </div>

          </div>

          <div class="h-actions" onclick="event.stopPropagation()">
            <button class="primary2" type="button" onclick="restoreFromHistory('${h.id}', true)">ë³µì›+ì¬ê³„ì‚°</button>
            <button type="button" onclick="restoreFromHistory('${h.id}', false)">ë³µì›ë§Œ</button>
            <label class="pick">
              <input type="checkbox" ${checked} onchange="togglePick('${h.id}', this.checked)">
              ë¹„êµ
            </label>
          </div>
        </div>
      </div>
    `;
  }).join("");

  renderPerfBox();
  updatePickUI();
}

/* íˆìŠ¤í† ë¦¬ í´ë¦­(ì•„ì´í…œ ì˜ì—­) -> ì¦‰ì‹œ ë³µì›+ì¬ê³„ì‚° */
function onHistoryClick(evt, id){
  try{ track("history_open", { page_path: location.pathname }); }catch(e){}
  // ë‚´ë¶€ ë²„íŠ¼ í´ë¦­ì€ stopPropagation ì²˜ë¦¬ë˜ì–´ ì—¬ê¸° ì•ˆ ì˜´
  restoreFromHistory(id, true);
}

function togglePick(id, on){
  if(on) pickSet.add(id);
  else pickSet.delete(id);
  updatePickUI();
}

function restoreFromHistory(id, doCalc){
  const arr = readHistory();
  const h = arr.find(x=>x.id===id);
  if(!h) return;

  // ê¸°ë³¸ ì…€ë ‰íŠ¸
  setVal("sport", h.sport);
  setVal("level", h.level);
  onSportChange(true);
  onLevelChange(true);

  // í…ìŠ¤íŠ¸
  setVal("league", h.league || "");
  setVal("teams", h.teams || "");

  // ë©”ì¸
  if(h.inputs.main2OddsA!=null) setVal("main2OddsA", h.inputs.main2OddsA);
  if(h.inputs.main2OddsB!=null) setVal("main2OddsB", h.inputs.main2OddsB);
  if(h.inputs.main3OddsH!=null) setVal("main3OddsH", h.inputs.main3OddsH);
  if(h.inputs.main3OddsD!=null) setVal("main3OddsD", h.inputs.main3OddsD);
  if(h.inputs.main3OddsA!=null) setVal("main3OddsA", h.inputs.main3OddsA);

  // EV ì…ë ¥
  if(h.inputs.myProb!=null) setVal("myProb", h.inputs.myProb);
  if(h.inputs.stake!=null) setVal("stake", h.inputs.stake);

  // í•¸ë””
  if(h.inputs.handicapLine!=null) setVal("handicapLine", h.inputs.handicapLine);
  if(h.inputs.handicapOddsA!=null) setVal("handicapOddsA", h.inputs.handicapOddsA);
  if(h.inputs.handicapOddsB!=null) setVal("handicapOddsB", h.inputs.handicapOddsB);
  if(h.inputs.handicapPush!=null) setVal("handicapPush", h.inputs.handicapPush);

  // OU
  if(h.inputs.totalLine!=null) setVal("totalLine", h.inputs.totalLine);
  if(h.inputs.overOdds!=null) setVal("overOdds", h.inputs.overOdds);
  if(h.inputs.underOdds!=null) setVal("underOdds", h.inputs.underOdds);
  if(h.inputs.ouPush!=null) setVal("ouPush", h.inputs.ouPush);
  if(h.inputs.myOverProb!=null) setVal("myOverProb", h.inputs.myOverProb);

  saveState();
  renderMarginDash();

  // ìŠ¤í¬ë¡¤
  scrollToCalc();

  if(doCalc){
    calc();
    toast("ë³µì› í›„ ì¬ê³„ì‚° ì™„ë£Œ");
  }else{
    toast("ì…ë ¥ ë³µì› ì™„ë£Œ");
  }
}

/* ë¹„êµ ëª¨ë‹¬ */
function openCompare(){
  const ids = Array.from(pickSet);
  if(ids.length !== 2){
    toast("ë¹„êµí•  í•­ëª© 2ê°œë¥¼ ì²´í¬í•´ ì£¼ì„¸ìš”");
    return;
  }
  const arr = readHistory();
  const a = arr.find(x=>x.id===ids[0]);
  const b = arr.find(x=>x.id===ids[1]);
  if(!a || !b){
    toast("ì„ íƒí•œ í•­ëª©ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤");
    return;
  }

  const grid = document.getElementById("compareGrid");
  if(!grid) return;

  grid.innerHTML = `
    ${renderCompareCol(a, "A")}
    ${renderCompareCol(b, "B")}
  `;

  document.getElementById("compareModal").style.display="flex";
}
function closeCompare(){
  document.getElementById("compareModal").style.display="none";
}
function renderCompareCol(h, tag){
  const cfg = SPORT_CFG[h.sport] || SPORT_CFG.soccer;

  const mainM = h.markets?.main?.marginPct;
  const ouM = h.markets?.ou?.marginPct;
  const hcM = h.markets?.hc?.marginPct;

  const mainTag = (typeof mainM==="number") ? classifyMargin(h.sport,"main",mainM) : null;
  const ouTag = (typeof ouM==="number") ? classifyMargin(h.sport,"ou",ouM) : null;
  const hcTag = (typeof hcM==="number") ? classifyMargin(h.sport,"hc",hcM) : null;

  const evTxt = (typeof h.bestEVPct==="number") ? `${h.bestEVPct.toFixed(2)}%` : "-";

  return `
    <div class="compare-col">
      <div class="ct">${tag} Â· ${h.time} Â· ${cfg.name} Â· ${levelLabel(h.level)}</div>
      <div class="line"><div class="k">ë¦¬ê·¸</div><div class="v">${h.league?escapeHtml(h.league):"-"}</div></div>
      <div class="line"><div class="k">ê²½ê¸°</div><div class="v">${h.teams?escapeHtml(h.teams):"-"}</div></div>
      <div class="line"><div class="k">ë©”ì¸ ë§ˆì§„</div><div class="v">${mainTag?`<span class="${clsToTextColor(mainTag.cls)}">${mainTag.label}</span>`:"-"}</div></div>
      <div class="line"><div class="k">OU ë§ˆì§„</div><div class="v">${ouTag?`<span class="${clsToTextColor(ouTag.cls)}">${ouTag.label}</span>`:"-"}</div></div>
      <div class="line"><div class="k">í•¸ë”” ë§ˆì§„</div><div class="v">${hcTag?`<span class="${clsToTextColor(hcTag.cls)}">${hcTag.label}</span>`:"-"}</div></div>
      <div class="line"><div class="k">ìµœê³  EV</div><div class="v">${h.evPositive?`<span class="good">${evTxt}</span>`:`<span class="warn">${evTxt}</span>`}</div></div>

      <div class="mini-actions">
        <button class="restore" type="button" onclick="restoreFromHistory('${h.id}', true)">ì´ í•­ëª© ë³µì›+ì¬ê³„ì‚°</button>
        <button class="close" type="button" onclick="closeCompare()">ë‹«ê¸°</button>
      </div>
    </div>
  `;
}

/* ì•ˆì „í•œ í…ìŠ¤íŠ¸ í‘œì‹œ */
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   TOP3 ë Œë” (ë©”ì¸/OU/í•¸ë”” ê°ê°)
========================= */
function renderTop3(){
  const arr = readHistory().filter(x=>x.date===todayStr());
  const topMain = arr.filter(x=>typeof x.markets?.main?.marginPct==="number")
    .sort((a,b)=>a.markets.main.marginPct - b.markets.main.marginPct).slice(0,3);
  const topOU = arr.filter(x=>typeof x.markets?.ou?.marginPct==="number")
    .sort((a,b)=>a.markets.ou.marginPct - b.markets.ou.marginPct).slice(0,3);
  const topHC = arr.filter(x=>typeof x.markets?.hc?.marginPct==="number")
    .sort((a,b)=>a.markets.hc.marginPct - b.markets.hc.marginPct).slice(0,3);

  renderTopList("topMain", topMain, "main");
  renderTopList("topOU", topOU, "ou");
  renderTopList("topHC", topHC, "hc");
}
function renderTopList(id, list, type){
  const el = document.getElementById(id);
  if(!el) return;
  if(!list.length){
    el.innerHTML = "ì˜¤ëŠ˜ ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }
  el.innerHTML = list.map((h,i)=>{
    const cfg = SPORT_CFG[h.sport] || SPORT_CFG.soccer;
    const m = h.markets[type].marginPct;
    const tag = classifyMargin(h.sport, type, m);
    const text = `${i+1}) ${h.time} Â· ${cfg.name}${h.teams?` Â· ${escapeHtml(h.teams)}`:""} Â· ${tag.label}`;
    return `<div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06);">
      <a href="#calcCard" onclick="restoreFromHistory('${h.id}', true)" style="color:#fff;text-decoration:none;">
        <span class="${clsToTextColor(tag.cls)}"><b>${text}</b></span>
      </a>
    </div>`;
  }).join("").replace(/border-bottom:1px solid rgba\(255,255,255,.06\);\"><\/div>$/,"\">");
}

/* =========================
   ì´ˆê¸° êµ¬ë™
========================= */

/* =========================
   ë¶„ì„ê¸° ì§„ì… ê´‘ê³  íŒì—… (ì§€ì—° ë…¸ì¶œ)
   - "ì§„ì…"ì´ ì•„ë‹ˆë¼ "ë¶„ì„ ì™„ë£Œ" ì´í›„ì—ë§Œ 1ì¼ 1íšŒ ë…¸ì¶œ
   - indexì˜ í´ë¦­ íˆìŠ¤í† ë¦¬(ìˆìœ¼ë©´)ë¡œ 2ê°œ ìš°ì„  ë…¸ì¶œ
========================= */

let _AD_PREPARED = false;
function prepareAdPopup(){
  if(_AD_PREPARED) return;

  // index.html í´ë¦­ ì§‘ê³„(ìˆìœ¼ë©´ í™œìš©)
  let clickMap = {};
  try{ clickMap = JSON.parse(localStorage.getItem("88_card_clicks") || "{}") || {}; }
  catch(e){ clickMap = {}; }

  // ë©”ì¸ í˜ì´ì§€ ìƒë‹¨ ìš°ì„  ì—…ì²´ + ê´‘ê³ ëª¨ì§‘ í¬í•¨
  const ads = [
    {key:"card1", title:"SPEED Bet", sub:"ê³ ì•¡ì „ìš© Â· ì…ê¸ˆí”ŒëŸ¬ìŠ¤ ì§€ì›", href:"http://spd-7575.com/?code=88ST", badge:"ì¶”ì²œ"},
    {key:"card2", title:"OK Bet", sub:"ê³ ì•¡ì „ìš© Â· í˜ì´ë°±/ì¶œì„", href:"http://ok-8888.com/?code=88ST", badge:"ì¶”ì²œ"},
    {key:"card3", title:"ì–´ëŠë‚ ", sub:"ê³ ì•¡ì „ìš©Â· ë¯¸ë‹ˆê²Œì„ Â· ë¬´ì œì œ ", href:"/#vendorTop", badge:"ì¶”ì²œ"},
    {key:"card7", title:"ê´‘ê³  ëª¨ì§‘", sub:"ì—¬ê¸°ì— ê´‘ê³ ê°€ ë…¸ì¶œë©ë‹ˆë‹¤", href:"/#vendorTop", badge:"AD"},
    {key:"card8", title:"ê´‘ê³  ëª¨ì§‘", sub:"ë¬¸ì˜ í›„ ë“±ë¡ ê°€ëŠ¥", href:"/#vendorTop", badge:"AD"}
  ];

  const ranked = [...ads].sort((a,b)=> Number(clickMap[b.key]||0) - Number(clickMap[a.key]||0));
  const picks = ranked.slice(0,2);

  const grid = document.getElementById("adGrid");
  if(!grid) return;

  grid.innerHTML = picks.map(x=>`
    <div class="ad-item" onclick="goAd('${x.href}')">
      <div class="name">${x.title}</div>
      <div class="sub">${x.sub}</div>
      <div class="badge">${x.badge}</div>
    </div>
  `).join("");

  _AD_PREPARED = true;
}

function maybeShowAdPopupAfterComplete(){
  const KEY = "88_analysis_adpopup_date";
  const today = new Date().toISOString().slice(0,10);

  try{ if(localStorage.getItem(KEY) === today) return; }catch(e){}

  const pop = document.getElementById("adPopup");
  if(!pop) return;

  prepareAdPopup();
  pop.style.display = "flex";

  try{ track("ad_popup_view", { page_path: location.pathname, trigger: "after_complete" }); }catch(e){}
}

function goAd(href){
  // í´ë¦­ í›„ì—ëŠ” ì˜¤ëŠ˜ í•˜ë£¨ ì¬ë…¸ì¶œ ë°©ì§€(1ì¼ 1íšŒ ì •ì±…)
  try{
    const today = new Date().toISOString().slice(0,10);
    localStorage.setItem("88_analysis_adpopup_date", today);
  }catch(e){}

  // ì•ˆì „ì¥ì¹˜: javascript: ë§í¬ ì°¨ë‹¨
  if(typeof href !== "string") return;
  const h = href.trim();
  if(h.toLowerCase().startsWith("javascript:")) return;

  location.href = h;
}
function closeAdPopup(disableToday){
  const pop = document.getElementById("adPopup");
  if(pop) pop.style.display = "none";
  if(disableToday){
    try{
      const today = new Date().toISOString().slice(0,10);
      localStorage.setItem("88_analysis_adpopup_date", today);
    }catch(e){}
  }
}

/* ===== Demo Loader (for empty history) ===== */
function loadDemo(kind){
  try{
    if(kind==="soccer"){
      setVal("sport","soccer");
      onSportChange(true);

      setVal("level","simple");
      onLevelChange(true);

      setVal("league","í”„ë¦¬ë¯¸ì–´ë¦¬ê·¸ (ì˜ˆì‹œ)");
      setVal("teams","í™ˆíŒ€ vs ì›ì •íŒ€");

      // 3-way ë©”ì¸ ë°°ë‹¹
      setVal("main3OddsH","1.95");
      setVal("main3OddsD","3.55");
      setVal("main3OddsA","3.95");

      // ì˜¤ë²„/ì–¸ë” ì˜ˆì‹œ
      setVal("totalLine","2.5");
      setVal("overOdds","1.90");
      setVal("underOdds","1.95");

      // í•¸ë”” ì˜ˆì‹œ
      setVal("handicapLine","-0.5");
      setVal("handicapOddsA","1.88");
      setVal("handicapOddsB","1.96");

    }else if(kind==="basketball"){
      setVal("sport","basketball");
      onSportChange(true);

      setVal("level","simple");
      onLevelChange(true);

      setVal("league","NBA (ì˜ˆì‹œ)");
      setVal("teams","í™ˆíŒ€ vs ì›ì •íŒ€");

      // 2-way ë©”ì¸ ë°°ë‹¹
      setVal("main2OddsA","1.78");
      setVal("main2OddsB","2.05");

      // ì˜¤ë²„/ì–¸ë” ì˜ˆì‹œ
      setVal("totalLine","223.5");
      setVal("overOdds","1.91");
      setVal("underOdds","1.91");

      // í•¸ë”” ì˜ˆì‹œ
      setVal("handicapLine","-3.5");
      setVal("handicapOddsA","1.92");
      setVal("handicapOddsB","1.90");
    }

    // ë°”ë¡œ ê³„ì‚° + ê²°ê³¼ë¡œ ì´ë™
    calc();
    quickJump("result");
  }catch(e){
    console.error(e);
    toast("ì˜ˆì‹œ ë¡œë”©ì— ì‹¤íŒ¨í–ˆì–´ìš”");
  }
}

/* ===== First-Visit Onboarding (3 tooltips) ===== */
const ONB_KEY = "onboard88_analysis_v1_done";
let onbIdx = 0;
const onbSteps = [
  {
    target: "mainBox",
    title: "ë°°ë‹¹ë¶€í„° ì…ë ¥",
    body: "ë©”ì¸ ë°°ë‹¹ì„ ë¨¼ì € ì…ë ¥í•´ìš”. (ì¶•êµ¬ëŠ” í™ˆ/ë¬´/ì›ì •, ë‹¤ë¥¸ ì¢…ëª©ì€ ìŠ¹/íŒ¨) â€” ì…ë ¥í•˜ë©´ ì•„ë˜ ê²°ê³¼ê°€ ë” ì •í™•í•˜ê²Œ ì •ë¦¬ë¼ìš”."
  },
  {
    target: "btnCalc",
    title: "ê³„ì‚°í•˜ê¸°",
    body: "ë°°ë‹¹ ì…ë ¥ í›„ <b>ê³„ì‚°í•˜ê¸°</b>ë¥¼ ëˆŒëŸ¬ ê²°ê³¼ë¥¼ í™•ì¸í•´ìš”. ê²°ê³¼ëŠ” ìë™ìœ¼ë¡œ íˆìŠ¤í† ë¦¬ì— ì €ì¥ë©ë‹ˆë‹¤."
  },
  {
    target: "historyCard",
    title: "íˆìŠ¤í† ë¦¬ë¡œ ì¬ê³„ì‚°/ë¹„êµ",
    body: "ì €ì¥ëœ íˆìŠ¤í† ë¦¬ë¥¼ í´ë¦­í•˜ë©´ <b>ì…ë ¥ ë³µì› + ì¦‰ì‹œ ì¬ê³„ì‚°</b>ë¼ìš”. ì²´í¬ 2ê°œ ì„ íƒ â†’ ë¹„êµ(2ê°œ ë‚˜ë€íˆ)ë„ ê°€ëŠ¥í•´ìš”."
  }
];

function onbHighlightClear(){
  document.querySelectorAll(".onb-highlight").forEach(el=>el.classList.remove("onb-highlight"));
}

function onbPositionPopover(targetEl){
  const pop = document.getElementById("onbPopover");
  if(!pop || !targetEl) return;

  const r = targetEl.getBoundingClientRect();
  const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
  const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

  const margin = 12;
  const popW = Math.min(340, vw - 36);
  pop.style.width = popW + "px";

  // ê¸°ë³¸: íƒ€ê²Ÿ ì•„ë˜ ìš°ì¸¡ ì •ë ¬, ê³µê°„ ë¶€ì¡±í•˜ë©´ ìœ„ë¡œ
  let top = r.bottom + 12;
  let left = Math.min(vw - popW - margin, Math.max(margin, r.left));

  // ì•„ë˜ ê³µê°„ ë¶€ì¡±í•˜ë©´ ìœ„ë¡œ
  const popH = pop.offsetHeight || 180;
  if(top + popH > vh - margin){
    top = Math.max(margin, r.top - popH - 12);
  }

  pop.style.top = top + "px";
  pop.style.left = left + "px";
}

function onbRender(){
  const pop = document.getElementById("onbPopover");
  const t = document.getElementById("onbTitle");
  const s = document.getElementById("onbStep");
  const b = document.getElementById("onbBody");
  if(!pop || !t || !s || !b) return;

  const step = onbSteps[onbIdx];
  const el = document.getElementById(step.target);
  if(!el){
    // íƒ€ê²Ÿì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
    onbNext();
    return;
  }

  onbHighlightClear();
  el.classList.add("onb-highlight");

  t.innerText = step.title;
  s.innerText = `${onbIdx+1}/${onbSteps.length}`;
  b.innerHTML = step.body;

  pop.style.display = "block";
  // ë‚´ìš©ì´ ë°”ë€ ë’¤ ë†’ì´ë¥¼ ê³„ì‚°í•˜ê¸° ìœ„í•´ ë‹¤ìŒ í”„ë ˆì„ì—ì„œ ìœ„ì¹˜ ê³„ì‚°
  requestAnimationFrame(()=>onbPositionPopover(el));
}

function onbStart(){
  try{
    const qs = new URLSearchParams(location.search);
    if(qs.get('onboard')==='1') localStorage.removeItem(ONB_KEY);
  }catch(e){}
  if(localStorage.getItem(ONB_KEY)==="1") return;
  onbIdx = 0;
  onbRender();
  // ìŠ¤í¬ë¡¤/ë¦¬ì‚¬ì´ì¦ˆ ì‹œ íŒì—… ìœ„ì¹˜ ìœ ì§€
  window.addEventListener("scroll", onbOnScroll, {passive:true});
  window.addEventListener("resize", onbOnScroll, {passive:true});
  document.addEventListener("keydown", onbOnKey);
}

function onbFinish(){
  localStorage.setItem(ONB_KEY,"1");
  onbClose();
}

function onbClose(){
  const pop = document.getElementById("onbPopover");
  if(pop) pop.style.display = "none";
  onbHighlightClear();
  window.removeEventListener("scroll", onbOnScroll);
  window.removeEventListener("resize", onbOnScroll);
  document.removeEventListener("keydown", onbOnKey);
}

function onbOnScroll(){
  const step = onbSteps[onbIdx];
  const el = document.getElementById(step.target);
  if(!el) return;
  onbPositionPopover(el);
}
function onbOnKey(e){
  if(e.key==="Escape") onbSkip();
  if(e.key==="ArrowRight" || e.key==="Enter") onbNext();
  if(e.key==="ArrowLeft") onbPrev();
}

function onbNext(){
  if(onbIdx >= onbSteps.length - 1){
    onbFinish();
    return;
  }
  onbIdx++;
  // íƒ€ê²Ÿì´ í™”ë©´ ë°–ì´ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤
  const el = document.getElementById(onbSteps[onbIdx].target);
  if(el){
    try{ el.scrollIntoView({behavior:"smooth", block:"center"}); }catch(e){ el.scrollIntoView(); }
    setTimeout(onbRender, 200);
  }else{
    onbRender();
  }
}

function onbPrev(){
  if(onbIdx <= 0){
    onbIdx = 0;
    onbRender();
    return;
  }
  onbIdx--;
  const el = document.getElementById(onbSteps[onbIdx].target);
  if(el){
    try{ el.scrollIntoView({behavior:"smooth", block:"center"}); }catch(e){ el.scrollIntoView(); }
    setTimeout(onbRender, 200);
  }else{
    onbRender();
  }
}

function onbSkip(){
  onbFinish();
}

function boot(){
  try{ saveUtmFromUrl(); }catch(e){}
  const restored = restoreFromPermalink();
  if(!restored) loadState();
  if(!restored && !localStorage.getItem(LS_KEY)){
    setVal("sport","soccer");
    setVal("level","simple");
  }
  onSportChange(true);
  onLevelChange(true);
  renderHistory();
  renderTop3();
  renderMarginDash();
  restoreMiniGuide();
  // ì²« ë°©ë¬¸ì 1íšŒ ì˜¨ë³´ë”©(3ìŠ¤í…)
  setTimeout(()=>{ try{ onbStart(); }catch(e){} }, 450);
  setupShareCardBackdropClose();
  setupBundleBackdropClose();
  try{ setupBundlePromo(); }catch(e){}
  try{ updateBundleButton(); }catch(e){}
  setupValidation();
  setupPasteBox();

  renderSnaps();
  renderPerfBox();
  // ì…ë ¥ ì¤‘ ë¹¨ê°„ í•˜ì´ë¼ì´íŠ¸ ìë™ í•´ì œ
  document.querySelectorAll("input,select").forEach(el=>{
    el.addEventListener("input", ()=>el.classList.remove("is-invalid"));
    el.addEventListener("change", ()=>el.classList.remove("is-invalid"));
  });
  // ì €ì¥ ë°°ì§€ ì´ˆê¸°í™”
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      const st = JSON.parse(raw);
      updateSaveBadge(st && st.__savedAt);
    }else{
      updateSaveBadge(null);
    }
  }catch(e){
    updateSaveBadge(null);
  }

}
boot();
</script>

<!-- First-Visit Onboarding Popover -->
<div id="onbPopover" role="dialog" aria-modal="true" aria-label="ì²˜ìŒ ì´ìš© ê°€ì´ë“œ">
  <div class="onb-hd">
    <div class="onb-title" id="onbTitle">ì²˜ìŒ ì´ìš© ê°€ì´ë“œ</div>
    <div class="onb-step" id="onbStep">1/3</div>
  </div>
  <div class="onb-body" id="onbBody"></div>
  <div class="onb-actions">
    <button class="btn onb-skip" type="button" onclick="onbSkip()">ê±´ë„ˆë›°ê¸°</button>
    <button class="btn secondary" type="button" onclick="onbPrev()">ì´ì „</button>
    <button class="btn primary" type="button" onclick="onbNext()">ë‹¤ìŒ</button>
  </div>
</div>

<section aria-label="ê´€ë ¨ ë§í¬" class="rel-links">
  <h2>ê´€ë ¨ ë§í¬</h2>
  <div class="rel-grid">
    <a href="/" data-cta="rel_home">ë©”ì¸</a>
    <a href="/#oddsAnalyzerSection" data-cta="rel_odds">ë°°ë‹¹ êµ¬ì¡° ë¶„ì„ê¸°</a>
    <a href="/tool-margin/" data-cta="rel_margin">ë§ˆì§„ ê³„ì‚°ê¸°</a>
    <a href="/tool-ev/" data-cta="rel_ev">EV ê³„ì‚°ê¸°</a>
    <a href="/tool-odds/" data-cta="rel_odds2">ë°°ë‹¹â†”í™•ë¥  ë³€í™˜</a>
    <a href="/#vendorTop" data-cta="rel_vendors">ë³´ì¦Â·ì¸ì¦ ì—…ì²´</a>
    <a href="/bonus-checklist/" data-cta="rel_bonus">ì…í”Œ ì²´í¬ë¦¬ìŠ¤íŠ¸</a>
    <a href="/landing-a/" data-cta="rel_landing_a">ì…í”ŒÂ·ë³´ë„ˆìŠ¤ ì•ˆë‚´</a>
  </div>
</section>
<style>
  .rel-links{max-width:1080px;margin:26px auto 34px;padding:14px 14px 16px;border-radius:18px;
    border:1px solid rgba(255,255,255,.10);background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
    box-shadow:0 14px 40px rgba(0,0,0,.35);}
  .rel-links h2{margin:0 0 10px;font-size:13px;letter-spacing:.02em;color:rgba(245,226,122,.92);font-weight:900;}
  .rel-grid{display:flex;flex-wrap:wrap;gap:8px;}
  .rel-grid a{text-decoration:none;color:rgba(255,255,255,.82);font-size:12px;padding:8px 10px;border-radius:999px;
    border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);}
  .rel-grid a:hover{border-color:rgba(245,226,122,.25);color:rgba(245,226,122,.92);}
</style>
</body>
</html>
