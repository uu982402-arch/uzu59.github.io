<!DOCTYPE html>

<html data-theme="light" lang="ko">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Ïä§Ìè¨Ï∏† Î∞∞Îãπ Î∂ÑÏÑùÍ∏∞ | 88 Ïª§ÎÆ§ÎãàÌã∞</title>
<meta content="Ï¢ÖÎ™©(Ï∂ïÍµ¨/ÎÜçÍµ¨/ÏïºÍµ¨/Î∞∞Íµ¨/eÏä§Ìè¨Ï∏†/ÌïòÌÇ§)Î≥Ñ Î∞∞Îãπ ÏûÖÎ†•ÏúºÎ°ú ÏäπÎ¶¨ ÌôïÎ•†(Î∞∞Îãπ Í∏∞Î∞ò¬∑Ï∂îÏ†ï), Ïò§Î≤ÑÎùºÏö¥Îìú, ÎßàÏßÑ, Î∞∏Î•ò(EV), Í∂åÏû• ÎπÑÏ§ë(Î≥¥ÏàòÏ†Å Kelly), Î©îÏù∏/Ïò§Î≤ÑÏñ∏Îçî/Ìï∏Îîî ÎßàÏßÑÏùÑ ÌÜµÌï© Í≥ÑÏÇ∞ÌïòÍ≥† ÌûàÏä§ÌÜ†Î¶¨/ÎπÑÍµêÍπåÏßÄ ÏßÄÏõêÌïòÎäî Î∂ÑÏÑùÍ∏∞ÏûÖÎãàÎã§. (ÌåêÎã® Î≥¥Ï°∞Ïö©)" name="description"/>
<meta content="Ïä§Ìè¨Ï∏† Î∂ÑÏÑùÍ∏∞, Ïä§Ìè¨Ï∏† Î∞∞Îãπ Î∂ÑÏÑùÍ∏∞, Î∞∞Îãπ ÎßàÏßÑ, Ïò§Î≤ÑÎùºÏö¥Îìú, Í≥µÏ†ïÌôïÎ•†, Í≥µÏ†ïÎ∞∞Îãπ, EV, Ìï∏ÎîîÏ∫°, Ïñ∏ÎçîÏò§Î≤Ñ" name="keywords"/>
<link href="https://88st.cloud/analysis/" rel="canonical"/>
<meta content="index,follow" name="robots"/>
<style>
*{box-sizing:border-box}
:root{
  /* Theme (auto/preset) */
  --accent1:#d4af37;
  --accent2:#f5e27a;
  --accentRGB:212,175,55;
  --accentText:#000;
  --accentOn:#00121a;

  /* Glass intensity */
  --glassA:.84;
  --glassStrongA:.94;
  --glassSoftA:.26;
  --glassBorder:rgba(255,255,255,.06);

  /* Backward-compat */
  --gold: var(--accent1);
  --gold2: var(--accent2);

  /* follow global theme tokens (casino-style unified) */
  --panel2: var(--panel-2);
  /* keep tool-specific chip surface but theme-aware */
  --chip: color-mix(in srgb, var(--panel-2) 92%, transparent);

  --ok:#b7ffcf;
  --warn:#ffcf99;
  --bad:#ffb3b3;
  /* --chip moved above */
}
html{scroll-behavior:smooth}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;
  background: var(--bg);
  color:var(--text);
}

/* ===== ÏÇ¨Ïπ≠Ï£ºÏùò ÌåùÏóÖ (1Ïùº 1Ìöå) ===== */
.scam-popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:3000;
  padding:18px;
}
.scam-box{
  background:rgba(17,17,17,.95);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  padding:22px;
  width:100%;
  max-width:380px;
  text-align:center;
  box-shadow:0 18px 60px rgba(0,0,0,.75);
  backdrop-filter: blur(10px);
}
.scam-box h3{ color:#ff6b6b; margin:0 0 10px; font-weight:900; }
.scam-box p{ font-size:13px; color:#ddd; line-height:1.55; margin:0; }
.scam-box .btn{
  margin-top:12px;
  padding:12px;
  border-radius:12px;
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  color:#000;
  font-weight:900;
  cursor:pointer;
  user-select:none;
}

/* ÏÉÅÎã® */
.header{ text-align:center; padding:14px 0 10px; }
.logo-link{display:inline-block;text-decoration:none}
.logo-img{
  display:block; margin:0 auto 6px;
  width:180px; max-width:72%; height:auto;
  filter:drop-shadow(0 0 10px rgba(var(--accentRGB),.25));
}
@media(max-width:480px){ .logo-img{width:150px;max-width:82%} }
.sub{ font-size:12px; color:#9a9a9a; }

/* Î†àÏù¥ÏïÑÏõÉ */
.wrap{ max-width:980px; margin:0 auto; padding:10px 14px 34px; }
.card{
  background:rgba(18,18,18,.86);
  border:1px solid rgba(255,255,255,.06);
  border-radius:18px; padding:14px;
  box-shadow:0 10px 26px rgba(0,0,0,.45);
  margin-bottom:14px;
  backdrop-filter: blur(10px);
}
.title{ font-weight:900; color:var(--gold2); margin-bottom:10px; font-size:14px; display:flex; align-items:center; gap:8px; }
.badge{
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  font-size:11px;
  font-weight:900;
  color:#000;
  background:linear-gradient(135deg,var(--gold),var(--gold2));
}
.note{ color:#bdbdbd; font-size:12px; line-height:1.5; margin-top:8px; }
.small-hint{ font-size:11px; color:#8f8f8f; margin-top:6px; line-height:1.4; }

/* Ïª®Ìä∏Î°§ */
.controls{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
@media(max-width:560px){ .controls{ grid-template-columns:1fr; } }
.select, .textinput{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.08);
  background:var(--panel2);
  color:var(--text);
  outline:none;
  font-weight:800;
}
.textinput{ font-weight:700; }
.row2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:10px;
}
@media(max-width:560px){ .row2{ grid-template-columns:1fr; } }

/* ÏûÖÎ†• */
.grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
@media(max-width:560px){ .grid{grid-template-columns:1fr} }
.field label{ display:block; font-size:12px; color:#bbb; margin:2px 0 6px; }
.field input{
  width:100%; padding:12px; border-radius:14px;
  border:1px solid rgba(255,255,255,.08);
  background:var(--panel2); color:var(--text); outline:none;
}
.field input::placeholder{color:#555}

/* ÏÑπÏÖò Î∞ïÏä§ */
.box{
  margin-top:12px;
  padding:12px;
  border-radius:16px;
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.06);
}
.box-title{ font-weight:900; margin:0 0 8px; color:var(--gold2); font-size:13px; }
.box-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.toggle{
  appearance:none; -webkit-appearance:none;
  cursor:pointer; font-size:12px; color:#cfcfcf;
  user-select:none; padding:6px 10px; border-radius:999px;
  border:1px solid rgba(255,255,255,.08); background:rgba(0,0,0,.25);
  appearance:none; -webkit-appearance:none; font: inherit;
}

/* Ïï°ÏÖò */
.actions{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
.btn{
  flex:1; min-width:160px;
  border:none; border-radius:14px; padding:12px;
  font-weight:900; cursor:pointer;
}
.primary{ background:linear-gradient(135deg,#1da1f2,#78d6ff); color:#00121a; }
.secondary{ background:var(--chip); color:var(--text); border:1px solid rgba(255,255,255,.06); }
.gold{ background:linear-gradient(135deg,var(--gold),var(--gold2)); color:#111; }

/* Í≤∞Í≥º */
.result{
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.06);
  border-radius:16px;
  padding:12px;
  margin-top:12px;
}

/* v2.1: Í≤∞Í≥º Ïπ¥Îìú/ÌÉ≠ Íµ¨Ï°∞ Ïª¥Ìè¨ÎÑåÌä∏ */
.st-result{ display:block; }
.st-r-tabs{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
  padding:10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.20);
  margin-bottom:10px;
}
.st-r-tab{
  appearance:none;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
  color:var(--text);
  padding:8px 11px;
  border-radius:999px;
  font-weight:950;
  font-size:12px;
  cursor:pointer;
  transition:transform .13s cubic-bezier(.2,.9,.2,1), filter .13s ease, border-color .13s ease, background .13s ease;
}
.st-r-tab:hover{ transform:translateY(-1px); filter:brightness(1.06); border-color:rgba(var(--accentRGB),.22); }
.st-r-tab:active{ transform:translateY(0) scale(.99); }
.st-r-tab.on{ background:rgba(var(--accentRGB),.16); border-color:rgba(var(--accentRGB),.30); }
.st-r-tab:focus-visible{ outline:2px solid rgba(var(--accentRGB),.55); outline-offset:2px; }
.st-r-meta{ margin-left:auto; font-size:11px; font-weight:900; color:var(--muted); }

.st-r-panel{ display:block; }
.st-r-panel[hidden]{ display:none; }

/* Í≤∞Í≥º ÏöîÏïΩ Ïπ¥Îìú(Ï≤´ ÌôîÎ©¥ Í∞ïÏ°∞) */
.resultHero{
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(600px 200px at 0% 0%, rgba(90,160,255,.10), transparent 55%),
    radial-gradient(600px 200px at 100% 0%, rgba(var(--accentRGB),.10), transparent 55%),
    rgba(255,255,255,.03);
  border-radius:18px;
  padding:14px;
  box-shadow: 0 14px 34px rgba(0,0,0,.35);
  margin-bottom:10px;
  animation:popIn .22s ease-out;
}
@keyframes popIn{ from{ transform:translateY(6px); opacity:0;} to{transform:none; opacity:1;} }
.heroTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; }
.heroText{ min-width:240px; }
.heroTitle{ font-weight:1000; font-size:15px; color:var(--text); letter-spacing:-.2px; }
.heroSub{ margin-top:3px; font-size:12px; color:#bdbdbd; line-height:1.35; }
.heroBadges{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

.heroRight{ display:flex; flex-direction:column; align-items:flex-end; gap:8px; }
.heroConclusion{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);
  max-width:340px;
}
.heroConclusion .cIcon{ font-size:16px; line-height:1; }
.heroConclusion .cText{ font-size:13px; font-weight:900; letter-spacing:-.2px; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.heroConclusion.good{ border-color: rgba(48,209,88,.35); background: rgba(48,209,88,.12); }
.heroConclusion.warn{ border-color: rgba(255,193,7,.35); background: rgba(255,193,7,.12); }
.heroConclusion.bad{ border-color: rgba(255,59,48,.35); background: rgba(255,59,48,.12); }
@media (max-width:520px){
  .heroRight{ width:100%; align-items:flex-start; }
  .heroBadges{ justify-content:flex-start; }
  .heroConclusion{ max-width:100%; width:100%; }
  .heroConclusion .cText{ white-space:normal; }
}
.chip.big{ padding:8px 12px; font-size:13px; }
.heroStats{
  margin-top:12px;
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap:10px;
}
.statCard{
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.22);
  border-radius:14px;
  padding:10px 10px;
}
.statK{ font-size:11px; color:#bdbdbd; }
.statV{ margin-top:4px; font-size:16px; font-weight:1000; color:var(--text); letter-spacing:-.2px; }
.statS{ margin-top:2px; font-size:11px; color:#9a9a9a; }
.detailHead{
  margin:10px 0 4px;
  font-weight:900;
  font-size:13px;
  color:var(--text);
  display:flex; align-items:center; gap:8px;
}
.detailHead:before{
  content:"";
  width:8px; height:8px; border-radius:99px;
  background:rgba(var(--accentRGB),.9);
  box-shadow:0 0 0 4px rgba(var(--accentRGB),.12);
}
@media (max-width:520px){
  .heroStats{ grid-template-columns: 1fr; }
  .heroText{ min-width: 0; }
  .heroBadges{ justify-content:flex-start; }
}

.kv{
  display:flex; justify-content:space-between; gap:10px;
  padding:8px 0; border-bottom:1px solid rgba(255,255,255,.06);
  font-size:13px;
}
.kv:last-child{border-bottom:none}
.k{color:#cfcfcf}
.v{font-weight:900}
.warn{color:var(--bad)}
.good{color:var(--ok)}
.mid{color:var(--warn)}

hr.sep{ border:none; height:1px; background:rgba(255,255,255,.06); margin:12px 0; }

.footer-links{ display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }
.linkbtn{
  flex:1; min-width:160px;
  display:block; text-align:center; padding:12px;
  border-radius:14px; text-decoration:none; font-weight:900;
  background:var(--chip); color:var(--text);
  border:1px solid rgba(255,255,255,.06);
}

/* Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ */
.checklist{
  color:#cfcfcf;
  font-size:13px;
  line-height:1.55;
}
.checklist strong{ color:var(--text); }

/* ÎßàÏßÑ ÎåÄÏãúÎ≥¥Îìú */
.m-grid{
  display:grid; gap:10px;
  grid-template-columns:1fr 1fr 1fr;
}
@media(max-width:800px){ .m-grid{ grid-template-columns:1fr; } }
.m-card{
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.25);
  border-radius:16px;
  padding:12px;
}
.m-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
.m-name{ font-weight:900; color:var(--text); font-size:13px; }
.chip{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);
}
.chip.ok{ color:var(--ok); }
.chip.mid{ color:var(--warn); }
.chip.bad{ color:var(--bad); }
.m-lines{ margin-top:10px; font-size:12px; color:rgba(255,255,255,.86); line-height:1.45; }
.m-lines b{ color:var(--text); }

/* ÌûàÏä§ÌÜ†Î¶¨ */
.history-toolbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:8px;
}
.history-toolbar .btn{ min-width:0; flex:1; }

.history-toolbar .btn.danger{
  border-color:rgba(255,80,80,.35);
  color:#ffd1d1;
}
.history-toolbar .btn.danger:hover{
  border-color:rgba(255,80,80,.55);
  background:rgba(255,80,80,.08);
}
.history-filters{
  margin-top:10px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}
.history-filters .seg{
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
  color:#ddd;
  font-weight:900;
  cursor:pointer;
}
.history-filters .seg.on{
  background:linear-gradient(135deg, rgba(255,203,66,.22), rgba(255,176,60,.12));
  border-color:rgba(255,203,66,.35);
  color:var(--text);
}
.pick-ind{
  margin-left:auto;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.03);
  color:#cfcfcf;
  font-size:12px;
  font-weight:800;
}
.pick-ind b{ color:var(--text); }
@media (max-width:420px){
  .pick-ind{ margin-left:0; }
}

.h-list{ margin-top:10px; display:grid; gap:10px; }
.h-item{
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.25);
  border-radius:16px;
  padding:10px 12px;
  cursor:pointer;
  transition:transform .13s cubic-bezier(.2,.9,.2,1), border-color .13s ease, filter .13s ease;
}
.h-item:hover{ transform:translateY(-1px); border-color:rgba(var(--accentRGB),.16); filter:brightness(1.03); }
.h-item:active{ transform:translateY(0) scale(.995); }
.h-item:focus-visible{ outline:2px solid rgba(var(--accentRGB),.55); outline-offset:3px; }
.h-top{
  display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
}
.h-title{
  font-weight:900; font-size:13px;
}
.h-sub{
  margin-top:4px;
  font-size:12px; color:#cfcfcf; line-height:1.4;
}
.h-actions{
  display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
}
.h-actions button{
  border-radius:12px;
  padding:8px 10px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.25);
  color:var(--text);
  font-weight:900;
  cursor:pointer;
  font-size:12px;
}
.h-actions button.primary2{
  background:linear-gradient(135deg,#1da1f2,#78d6ff);
  color:#00121a;
  border:none;
}
.h-actions .pick{
  display:flex; align-items:center; gap:6px; font-size:12px; color:#cfcfcf;
}
.h-actions input[type="checkbox"]{ transform:scale(1.15); }

/* ÎπÑÍµê Î™®Îã¨ */
.modal{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  z-index:3200;
  padding:16px;
  background:rgba(0,0,0,.75);
}
.modal-box{
  width:100%;
  max-width:980px;
  background:rgba(17,17,17,.95);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  box-shadow:0 18px 60px rgba(0,0,0,.75);
  backdrop-filter: blur(10px);
  padding:14px;
}
.modal-head{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  margin-bottom:10px;
}
.modal-head .t{ font-weight:900; color:var(--gold2); }
.modal-close{
  cursor:pointer; user-select:none;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.25);
  font-weight:900;
}
.compare-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
@media(max-width:760px){ .compare-grid{ grid-template-columns:1fr; } }
.compare-col{
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.25);
  border-radius:16px;
  padding:12px;
}
.compare-col .ct{ font-weight:900; margin-bottom:8px; }
.compare-col .line{ display:flex; justify-content:space-between; gap:10px; font-size:12px; padding:6px 0; border-bottom:1px solid rgba(255,255,255,.06); }
.compare-col .line:last-child{ border-bottom:none; }
.compare-col .line .k{ color:#cfcfcf; }
.compare-col .line .v{ font-weight:900; }
.compare-col .mini-actions{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
.compare-col .mini-actions button{
  flex:1; min-width:120px;
  border:none; border-radius:12px; padding:10px;
  font-weight:900; cursor:pointer;
}
.compare-col .mini-actions .restore{ background:linear-gradient(135deg,#1da1f2,#78d6ff); color:#00121a; }
.compare-col .mini-actions .close{ background:#1f1f1f; color:var(--text); border:1px solid rgba(255,255,255,.06); }

/* ÌÜ†Ïä§Ìä∏ */
#toast88{
  position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
  background:rgba(0,0,0,.85); color:var(--text);
  padding:10px 12px; border-radius:12px; font-size:12px;
  z-index:4000; border:1px solid rgba(255,255,255,.08);
  opacity:0; pointer-events:none; transition:opacity .2s ease;
}

/* ===== Î∂ÑÏÑùÍ∏∞ ÏßÑÏûÖ Í¥ëÍ≥† ÌåùÏóÖ (AÏïà: 1Ïùº 1Ìöå, 2Í∞ú ÎÖ∏Ï∂ú) ===== */
.ad-popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.78);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2600;
  padding:18px;
}
.ad-box{
  width:100%;
  max-width:420px;
  background:rgba(17,17,17,.95);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  padding:18px;
  box-shadow:0 18px 60px rgba(0,0,0,.75);
  backdrop-filter: blur(10px);
}
.ad-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}
.ad-title{
  font-weight:900;
  color:var(--gold2);
  font-size:14px;
}
.ad-close{
  cursor:pointer;
  user-select:none;
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.28);
  color:var(--text);
}
.ad-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
@media(max-width:360px){
  .ad-grid{ grid-template-columns:1fr; }
}
.ad-item{
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.25);
  border-radius:14px;
  padding:12px;
  cursor:pointer;
}
.ad-item .name{ font-weight:900; font-size:13px; }
.ad-item .sub{ font-size:11px; color:#bdbdbd; margin-top:4px; line-height:1.4; }
.ad-item .badge{
  display:inline-block;
  margin-top:8px;
  font-size:11px;
  font-weight:900;
  padding:4px 8px;
  border-radius:999px;
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  color:#111;
}
.ad-actions{
  display:flex;
  gap:10px;
  margin-top:12px;
}
.ad-actions .btnx{
  flex:1;
  text-align:center;
  padding:10px 12px;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
  border:1px solid rgba(255,255,255,.08);
  background:#1f1f1f;
  color:var(--text);
  text-decoration:none;
}
.ad-actions .btnx.primary{
  background:linear-gradient(135deg,#1da1f2,#78d6ff);
  color:#00121a;
  border:none;
}
.ad-note{
  margin-top:10px;
  font-size:11px;
  color:#9a9a9a;
  line-height:1.4;
}

/* ===== UX Add-ons (non-breaking) ===== */
.save-badge{
  margin-left:auto;
  font-size:11px;
  font-weight:900;
  color:var(--text-2);
  letter-spacing:.2px;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.save-badge .dot{
  width:8px; height:8px; border-radius:999px;
  background:rgba(255,255,255,.55);
  box-shadow:0 0 0 3px rgba(255,255,255,.08);
}
.quick-nav{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:10px;
}
.quick-nav .chip{
  border:1px solid rgba(var(--accentRGB),.28);
  background:rgba(255,255,255,.06);
  color:var(--text);
  padding:8px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  cursor:pointer;
  transition:transform .12s ease, background .12s ease;
}
.quick-nav .chip:hover{ transform:translateY(-1px); background:rgba(255,255,255,.09); }

/* v2.1: ÏÑπÏÖò ÌÉ≠(HTML Ïª¥Ìè¨ÎÑåÌä∏Ìôî) */
.st-tabbar{
  position:sticky;
  top:calc(var(--shell-h, 62px) + 10px);
  z-index:1100;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
  padding:10px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.22);
  backdrop-filter: blur(12px);
}
.st-tab{
  appearance:none;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
  color:var(--text);
  padding:9px 12px;
  border-radius:999px;
  font-weight:950;
  font-size:12px;
  cursor:pointer;
  transition:transform .13s cubic-bezier(.2,.9,.2,1), filter .13s ease, border-color .13s ease, background .13s ease;
}
.st-tab:hover{ transform:translateY(-1px); filter:brightness(1.06); border-color:rgba(var(--accentRGB),.22); }
.st-tab:active{ transform:translateY(0) scale(.99); }
.st-tab.on{
  background:linear-gradient(135deg, rgba(var(--accentRGB),.22), rgba(90,160,255,.10));
  border-color:rgba(var(--accentRGB),.30);
}
.st-tab:focus-visible{ outline:2px solid rgba(var(--accentRGB),.55); outline-offset:2px; }

@media (max-width:520px){
  .st-tabbar{ padding:8px; }
  .st-tab{ padding:8px 10px; }
}

.mini-guide{
  margin-top:10px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.04);
  border-radius:14px;
  overflow:hidden;
}
.mini-guide .head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  cursor:pointer;
  user-select:none;
  font-weight:900;
}
.mini-guide .head .pill{
  appearance:none; -webkit-appearance:none;
  font-size:11px;
  font-weight:900;
  color:var(--text);
  background:rgba(var(--accentRGB),.18);
  border:1px solid rgba(var(--accentRGB),.28);
  padding:6px 10px;
  border-radius:999px;
  cursor:pointer;
}
.mini-guide .body{
  display:none;
  padding:10px 12px 12px;
  color:#d7d7d7;
  font-size:12px;
  line-height:1.5;
}
.mini-guide .body b{ color:var(--text); }
.is-invalid{
  outline:2px solid rgba(255,90,90,.75) !important;
  box-shadow:0 0 0 6px rgba(255,90,90,.12) !important;
  border-color:rgba(255,90,90,.6) !important;
}
.modal-box.share{
  max-width:560px;
  max-height:92vh;
  overflow:auto;
}
.share-canvas-wrap{
  margin-top:12px;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:10px;
}
.share-canvas{
  width:100%;
  height:auto;
  border-radius:12px;
  display:block;
}

/* ===== Î¨∂Ïùå Í≥µÏú†(Ïò§Îäò ÏàòÏßë) ===== */
.bundle-meta{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-top:10px;
  padding:10px 12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  border-radius:14px;
  color:var(--text-2);
  font-size:12px;
}
.bundle-meta b{ color:var(--text); }
.bundle-ta{
  width:100%;
  min-height:160px;
  margin-top:10px;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.28);
  color:var(--text);
  font-size:12px;
  line-height:1.5;
  resize:vertical;
}
.bundle-ta:focus{ outline:2px solid rgba(var(--accentRGB),.26); box-shadow:0 0 0 8px rgba(var(--accentRGB),.10); }
.bundle-mini{
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.bundle-pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(var(--accentRGB),.28);
  background:rgba(var(--accentRGB),.14);
  color:var(--text);
  font-weight:900;
  font-size:11px;
}

.bundle-promo{
  margin-top:12px;
  padding-top:12px;
  border-top:1px dashed rgba(255,255,255,.10);
}
.bundle-promo-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.bundle-promo-title{
  font-weight:900;
  font-size:13px;
  color:var(--text);
}
.bundle-promo-ctrl{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.inp.mini{
  padding:8px 10px;
  font-size:12px;
  border-radius:12px;
}
.bundle-ta--promo{
  min-height:140px;
}

.bundle-switch{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
  border-radius:999px;
  font-size:12px;
  color:var(--text);
  cursor:pointer;
  user-select:none;
}
.bundle-switch input{
  width:14px; height:14px;
  accent-color:#d4af37;
}
.bundle-switch span{ font-weight:900; }


.bundle-promo-adv{
  margin-top:10px;
  padding:10px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  border-radius:16px;
}
.bundle-adv-row{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}
.bundle-adv-label{
  font-weight:900;
  font-size:12px;
  color:var(--text);
  min-width:140px;
}
.bundle-adv-controls{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
  flex:1;
}
.bundle-range{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.18);
  border-radius:14px;
  color:var(--text);
  font-size:12px;
  font-weight:900;
}
.bundle-range input[type="range"]{
  width:180px;
  max-width:40vw;
}
#bundlePresetHint{
  border-color: rgba(var(--accentRGB), .35);
  background: rgba(var(--accentRGB), .12);
}

@media (max-width:560px){
  body{ padding-bottom: calc(env(safe-area-inset-bottom) + 72px); }
  .mobile-dock{
    position:fixed;
    left:0; right:0; bottom:0;
    z-index:1700;
    display:flex;
    gap:10px;
    padding:10px 12px calc(env(safe-area-inset-bottom) + 12px);
    background:linear-gradient(180deg, rgba(10,10,12,0), rgba(10,10,12,.72) 30%, rgba(10,10,12,.94));
    backdrop-filter: blur(10px);
  }
  .mobile-dock .dock-btn{
    flex:1;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.06);
    color:var(--text);
    border-radius:14px;
    padding:12px 10px;
    font-weight:1000;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    min-height:44px;
  }
  .mobile-dock .dock-btn.primary{
    background:linear-gradient(135deg, var(--gold), var(--gold2));
    color:#000;
    border-color:rgba(0,0,0,.08);
  }
}
@media (min-width:561px){
  .mobile-dock{ display:none; }
}



/* ===== Empty History Demo ===== */
.demo-empty{
  border:1px dashed rgba(255,255,255,.18);
  background:rgba(255,255,255,.03);
  padding:14px;
  border-radius:14px;
}
.demo-title{ font-weight:900; font-size:14px; margin-bottom:6px; }
.demo-desc{ font-size:12px; color:#cfcfcf; line-height:1.5; }
.demo-btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
.demo-btns .btn{ flex:1; min-width:170px; }
.demo-note{ margin-top:10px; font-size:11px; color:#9aa0a6; line-height:1.45; }

/* ===== First-Visit Onboarding ===== */
.onb-highlight{
  position:relative;
  z-index:9998 !important;
  border-radius:16px !important;
  box-shadow: 0 0 0 9999px rgba(0,0,0,.68), 0 0 0 2px rgba(255,255,255,.18) !important;
}
#onbPopover{
  position:fixed;
  z-index:9999;
  max-width:340px;
  width:calc(100vw - 36px);
  background:rgba(14,16,20,.96);
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  box-shadow: 0 10px 30px rgba(0,0,0,.45);
  padding:14px;
  display:none;
}
#onbPopover .onb-hd{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
#onbPopover .onb-title{
  font-weight:900; font-size:14px;
}
#onbPopover .onb-step{
  font-size:11px; color:#9aa0a6;
}
#onbPopover .onb-body{
  margin-top:8px;
  font-size:12px; color:#cfcfcf; line-height:1.55;
}
#onbPopover .onb-actions{
  display:flex; gap:8px; margin-top:12px; justify-content:flex-end; flex-wrap:wrap;
}
#onbPopover .onb-actions .btn{ min-width:0; }
#onbPopover .onb-skip{
  margin-right:auto;
  font-size:12px;
  background:transparent;
  border:1px solid rgba(255,255,255,.16);
  color:#cfcfcf;
}


/* ===== ÏûÖÎ†• Í≤ÄÏ¶ù ===== */
.invalid{
  border-color: rgba(255,90,90,.95) !important;
  box-shadow: 0 0 0 3px rgba(255,90,90,.18) !important;
}
.input-warn{
  margin-top:10px;
  padding:10px 12px;
  border-radius:14px;
  background:rgba(255,90,90,.10);
  border:1px solid rgba(255,90,90,.25);
  color:#ffd1d1;
  font-size:12px;
  line-height:1.45;
  display:none;
}
.input-warn b{ color:var(--text); }

/* ===== ÏµúÍ∑º ÏûÖÎ†• Ïä§ÎÉÖÏÉ∑ ===== */
.snap-wrap{
  margin-top:12px;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.22);
}
.snap-head{
  font-size:12px;
  color:#cfcfcf;
  font-weight:800;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.snap-list{
  margin-top:8px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.snap-chip{
  cursor:pointer;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.06);
  color:var(--text);
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  font-weight:800;
}
.snap-chip:hover{
  transform: translateY(-1px);
  border-color:var(--muted-2);
}
.snap-meta{ color:#cfcfcf; font-weight:700; margin-left:6px; font-size:11px; }

/* ===== ÎÇ¥ ÌÜµÍ≥Ñ(ÏÑ±Í≥º) ===== */
.perf-box{
  margin-top:12px;
  border-radius:16px;
  padding:12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.22);
}
.perf-title{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  font-weight:900; font-size:13px;
}
.perf-sub{
  margin-top:6px;
  font-size:12px; color:#cfcfcf; line-height:1.45;
}
.perf-grid{
  margin-top:10px;
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap:10px;
}
.perf-tile{
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.05);
  border-radius:14px;
  padding:10px;
}
.perf-k{ font-size:12px; color:#cfcfcf; font-weight:800; }
.perf-v{ margin-top:4px; font-size:16px; font-weight:900; }
.perf-n{ margin-top:4px; font-size:11px; color:#bfbfbf; font-weight:700; }

.outTag{
  display:inline-flex; align-items:center; gap:6px;
  border-radius:999px;
  padding:4px 10px;
  font-size:11px;
  font-weight:900;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
}
.outTag.win{ border-color: rgba(67,226,164,.40); background: rgba(67,226,164,.12); }
.outTag.lose{ border-color: rgba(255,90,90,.40); background: rgba(255,90,90,.12); }
.outTag.void{ border-color: rgba(255,208,72,.40); background: rgba(255,208,72,.10); }
.outTag.none{ border-color:var(--muted-2); background: rgba(255,255,255,.06); color:#cfcfcf; }

.outBtns{
  margin-top:8px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.oBtn{
  cursor:pointer;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
  border-radius:12px;
  padding:6px 10px;
  font-size:12px;
  font-weight:900;
}
.oBtn:hover{ transform: translateY(-1px); border-color:var(--muted-2); }
.oBtn.on{ border-color:var(--muted-2); background:rgba(255,255,255,.12); }

.h-outcome{
  margin-top:10px;
  padding-top:10px;
  border-top:1px dashed rgba(255,255,255,.12);
}
.h-outcome .row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}
.h-outcome .row .label{ font-size:12px; color:#cfcfcf; font-weight:800; }

/* ===== Í≤∞Í≥º ÏÉÅÎã® Í∏∞Î°ù/Ïã†Î¢∞ ===== */
.trustLine{
  margin-top:10px;
  font-size:12px;
  color:#cfcfcf;
  line-height:1.45;
}
.trustLine b{ color:var(--text); }

.heroReason{
  margin-top:8px;
  font-size:12px;
  color:#d9d9d9;
  line-height:1.45;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.04);
}

.outcomeBar{
  margin-top:8px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.outcomeBar .oBtn{ border-radius:999px; padding:8px 12px; }



/* ===== Settings spotlight (calcCard) ===== */
#calcCard{
  border:1px solid rgba(var(--accentRGB),.24) !important;
  background:
    radial-gradient(110% 160% at 12% 0%, rgba(var(--accentRGB),.16), rgba(0,0,0,0) 55%),
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.015));
  box-shadow: 0 18px 45px rgba(0,0,0,.62), 0 0 0 1px rgba(var(--accentRGB),.08) inset;
  position:relative;
  overflow:hidden;
}
#calcCard:before{
  content:"";
  position:absolute; inset:-2px;
  background:linear-gradient(90deg, rgba(var(--accentRGB),.30), rgba(255,255,255,0), rgba(var(--accentRGB),.12));
  opacity:.25;
  pointer-events:none;
  transform:skewX(-14deg) translateX(-40%);
  filter:blur(0px);
}
#calcCard .title{
  font-size:18px !important;
  letter-spacing:.2px;
}
#calcCard .pill-need{
  font-size:11px;
  font-weight:950;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(var(--accentRGB),.30);
  color:var(--text);
  background:rgba(var(--accentRGB),.10);
  display:inline-flex;
  align-items:center;
  gap:6px;
  white-space:nowrap;
  margin-left:6px;
}
#calcCard .controls-settings{
  margin-top:12px;
}
#calcCard .selectWrap{
  position:relative;
}
#calcCard .fieldLabel{
  display:flex;
  align-items:center;
  gap:8px;
  margin:0 0 6px 6px;
  font-size:12px;
  font-weight:900;
  color:var(--text-2);
}
#calcCard .stepBubble{
  width:18px; height:18px;
  border-radius:999px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:11px;
  font-weight:950;
  color:#111;
  background:linear-gradient(135deg, var(--gold), var(--gold2));
  box-shadow:0 8px 18px rgba(var(--accentRGB),.18);
}
#calcCard .select{
  border:1px solid rgba(var(--accentRGB),.30) !important;
  background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02)) !important;
  padding:14px 12px !important;
  font-weight:900 !important;
}
#calcCard .select:focus{
  box-shadow:0 0 0 3px rgba(var(--accentRGB),.18);
}
#calcCard .settingsHint{
  margin-top:10px;
  padding:10px 12px;
  border-radius:14px;
  border:1px dashed rgba(255,255,255,.12);
  background:rgba(255,255,255,.03);
  font-size:12px;
  color:var(--text-2);
}
#calcCard .row2{
  margin-top:12px !important;
  padding-top:10px;
  border-top:1px solid rgba(255,255,255,.08);
}
@keyframes calcGlow{
  0%,100%{ box-shadow: 0 18px 45px rgba(0,0,0,.62), 0 0 0 1px rgba(var(--accentRGB),.08) inset; }
  50%{ box-shadow: 0 22px 55px rgba(0,0,0,.68), 0 0 0 1px rgba(var(--accentRGB),.14) inset, 0 0 26px rgba(var(--accentRGB),.08); }
}
#calcCard{ animation:calcGlow 4.2s ease-in-out infinite; }
@media (prefers-reduced-motion: reduce){
  #calcCard{ animation:none; }
  #calcCard:before{ display:none; }
}



/* 88 logo spotlight */
.logoImg, .logo-img{
  width:min(170px,52vw) !important;
  height:auto;
  display:block;
  padding:10px;
  border-radius:20px;
  background:rgba(20,20,24,var(--glassSoftA));
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 0 0 1px rgba(255,255,255,.06), 0 14px 40px rgba(0,0,0,.42), 0 0 26px rgba(var(--accentRGB), .22);
}
@media(max-width:480px){
  .logoImg, .logo-img{ width:min(150px,72vw) !important; padding:9px; }
}



/* ===== v14: ÏÑπÏÖò ÌÉÄÏù¥ÌãÄ Ï†ïÎ¶¨ + Î∂ÑÏÑùÍ∏∞ UX/UI ÏóÖÍ∑∏Î†àÏù¥Îìú ===== */
.sr-only{
  position:absolute;
  width:1px;height:1px;
  padding:0;margin:-1px;
  overflow:hidden;clip:rect(0,0,0,0);
  white-space:nowrap;border:0;
}

/* Ïπ¥Îìú: Î∂ÑÏÑùÍ∏∞(ÏµúÏÉÅÎã®) Í∞ïÏ°∞ */
.card--hero{
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(900px 260px at 0% 0%, rgba(202,152,66,.16), transparent 58%),
    radial-gradient(700px 240px at 100% 0%, rgba(90,160,255,.10), transparent 60%),
    rgba(18,18,18,.86);
}

/* ÏÉÅÎã® ÌûàÏñ¥Î°ú */
.calc-hero{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}
@media(max-width:560px){
  .calc-hero{ flex-direction:column; }
}
.calc-kicker{ font-size:12px; color:#bdbdbd; letter-spacing:.2px; }
.calc-headline{
  margin-top:4px;
  font-size:16px;
  font-weight:1000;
  color:var(--text);
  line-height:1.25;
}
.calc-headline .accent{ color:var(--gold2); }
.calc-tags{ display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
.tag{
  display:inline-flex; align-items:center;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  color:var(--text);
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.10);
}
.calc-hero-right{
  display:flex;
  flex-direction:column;
  gap:10px;
  align-items:flex-end;
  min-width:170px;
}
@media(max-width:560px){
  .calc-hero-right{
    width:100%;
    flex-direction:row;
    justify-content:space-between;
    align-items:center;
  }
}
.autosave{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:14px;
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.10);
}
.autosave-label{ font-size:12px; color:#cfcfcf; font-weight:900; }
.calc-divider{
  height:1px;
  background:rgba(255,255,255,.08);
  margin:12px 0 10px;
}

/* Î≤ÑÌäº: Í≥†Í∏â/ÏÑ∏Î†®/ÎààÏóê ÎùÑÍ≤å */
.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:950;
  letter-spacing:.2px;
  cursor:pointer;
  transition:transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}
.btn:hover{ transform:translateY(-1px); box-shadow:0 12px 22px rgba(0,0,0,.40); }
.btn:active{ transform:translateY(0); box-shadow:0 8px 16px rgba(0,0,0,.28); }
.btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

.btn.primary{
  background:linear-gradient(135deg, var(--gold), var(--gold2));
  color:#0a0a0a;
  border-color:rgba(0,0,0,.10);
  box-shadow:0 14px 26px rgba(0,0,0,.45);
}
.btn.primary:hover{
  box-shadow:0 18px 32px rgba(0,0,0,.55), 0 0 18px rgba(202,152,66,.22);
}
.btn.secondary{
  background:rgba(0,0,0,.22);
  border-color:var(--muted-2);
}
.btn.gold{
  background:rgba(0,0,0,.12);
  border-color:rgba(202,152,66,.35);
  color:var(--gold2);
}
.btn.danger{
  border-color:rgba(255,90,90,.45);
  color:#ffd0d0;
}
.btn.mini{ padding:10px 12px; border-radius:12px; font-size:12px; }

/* Ïï°ÏÖò ÏòÅÏó≠: Ï≤´ Î∞©Î¨∏ÏûêÎèÑ Î∞îÎ°ú Ïì∞Í∏∞ Ï¢ãÍ≤å */
.actions{ gap:10px; }
.actions .btn.primary{ flex:2; min-width:220px; }
.actions .btn{ min-width:140px; }

/* TOP3 + Í∏∞Ï§Ä/ÏòàÏãú Î∞òÎ∞ò Î†àÏù¥ÏïÑÏõÉ */
.split{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  align-items:start;
}
@media(max-width:860px){ .split{ grid-template-columns:1fr; } }
.split-col{
  padding:12px;
  border-radius:16px;
  background:rgba(255,255,255,.02);
  border:1px solid rgba(255,255,255,.06);
}
.subhead{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:10px;
  font-weight:1000;
  color:var(--text);
  font-size:13px;
}
.mini-badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:4px 8px;
  border-radius:999px;
  font-size:11px;
  font-weight:1000;
  background:linear-gradient(135deg, var(--gold), var(--gold2));
  color:#111;
  border:1px solid rgba(0,0,0,.10);
}

/* Result action dock */
.result-dock{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
.result-dock .btn{ flex:1; min-width:150px; }
@media(max-width:560px){ .result-dock .btn{ min-width:0; } }

<!-- ===== GA4 (Í≥µÌÜµ) ===== -->


<style id="v13_1_theme_override">
/* === v13.1 look unify (from main index) === */
:root{
  /* unify accent (blue) */
  --accent1:#d4af37;
  --accent2:#f5e27a;
  --accentRGB:212,175,55;  /* for rgba(var(--accentRGB), .xx) */
  --accentText:#00121a;
  --accentOn:#00121a;

  /* unify tokens */
  --bg:#f5f6f8;
  --panel:rgba(255,255,255,.92);
  --glassA:.72;
  --glassStrongA:.86;
  --glassSoftA:.18;
  --glassBorder:rgba(18,20,28,.10);

  /* backward compat */
  --gold: var(--accent1);
  --gold2: var(--accent2);
}

/* premium midnight background */
body{
  background:
    radial-gradient(1200px 620px at 50% -10%, rgba(var(--accentRGB),.18), transparent 58%),
    radial-gradient(900px 540px at 15% 25%, rgba(120,170,255,.10), transparent 55%),
    radial-gradient(900px 640px at 85% 35%, rgba(80,140,255,.08), transparent 55%),
    linear-gradient(180deg, #05060b 0%, #060612 60%, #040408 100%) !important;
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,system-ui;
}

/* remove small label badges (TODAY/MAIN/NEW...) */
.title .badge,
.section-title .badge,
h1 .badge,
h2 .badge,
h3 .badge{ display:none !important; }

/* panel unification (safe selectors) */
.section, .panel, .box, .card, .wrap, .container, .hero, header{
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}

/* inputs */
input, select, textarea{
  background: rgba(0,0,0,.28) !important;
  border:1px solid rgba(255,255,255,.14) !important;
  color:var(--text) !important;
  border-radius:14px !important;
  outline:none;
}
input:focus, select:focus, textarea:focus{
  border-color: rgba(var(--accentRGB), .38) !important;
  box-shadow: 0 0 0 3px rgba(var(--accentRGB), .12) !important;
}

/* buttons: less-blue, premium glass */
.btn, button, a.btn{
  background: rgba(255,255,255,.06) !important;
  border:1px solid rgba(255,255,255,.14) !important;
  color:var(--text) !important;
  box-shadow: 0 12px 34px rgba(0,0,0,.38) !important;
}
.btn:hover, button:hover, a.btn:hover{ filter: brightness(1.06); }
.btn.primary, .btn.go{
  border-color: rgba(var(--accentRGB), .22) !important;
  background: rgba(255,255,255,.08) !important;
}
.btn.secondary, .btn.ghost{
  background: rgba(0,0,0,.18) !important;
}

/* links */
a{ color:inherit; }

/* line compare */
.lc-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;}
@media(max-width:820px){.lc-grid{grid-template-columns:1fr;}}
.lc-col{border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:12px;background:rgba(0,0,0,.18);} 
.lc-head{font-weight:900;font-size:13px;color:rgba(245,226,122,.92);margin-bottom:8px;}
.lc-fields .field{margin-top:0;}
.lc-out{margin-top:10px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);padding:12px;line-height:1.55;font-size:13px;}
.lc-out .k{color:var(--muted);font-weight:900;}
.lc-out .v{color:var(--text);}


/* ===== ÌÖçÏä§Ìä∏ Î∂ôÏó¨ÎÑ£Í∏∞(ÏûêÎèô ÏûÖÎ†•) ===== */
.paste-area{display:flex;flex-direction:column;gap:10px}
.paste-ta{width:100%;min-height:96px;resize:vertical;padding:12px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.22);color:var(--text);font-size:13px;line-height:1.45;outline:none}
.paste-ta:focus{border-color:rgba(var(--accentRGB),.35);box-shadow:0 0 0 3px rgba(var(--accentRGB),.12)}
.paste-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.paste-badge{font-size:12px;color:var(--text-2);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04)}
.paste-badge.good{border-color:rgba(183,255,207,.25);color:rgba(183,255,207,.92)}
.paste-badge.warn{border-color:rgba(255,207,153,.25);color:rgba(255,207,153,.92)}
.paste-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.paste-inline .chk{display:flex;gap:6px;align-items:center;font-size:12px;color:var(--text-2)}
.paste-inline input[type=checkbox]{width:16px;height:16px;accent-color:var(--accent1)}

/* multi paste list */
.paste-list-wrap{margin-top:10px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);overflow:hidden}
.paste-list-head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
.paste-list-head .k{font-weight:950;color:rgba(245,226,122,.95)}
.paste-list-head .m{font-size:12px;color:var(--muted)}
.paste-list{display:flex;flex-direction:column}
.paste-item{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
.paste-item:last-child{border-bottom:none}
.paste-item .left{min-width:0}
.paste-item .t{font-weight:950;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.paste-item .s{margin-top:4px;font-size:12px;color:var(--muted);line-height:1.35}
.paste-item .chips{margin-top:6px;display:flex;flex-wrap:wrap;gap:6px}
.paste-chip{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:var(--text-2)}
.paste-chip.ok{border-color:rgba(183,255,207,.22);color:rgba(183,255,207,.90)}
.paste-chip.warn{border-color:rgba(255,207,153,.22);color:rgba(255,207,153,.90)}
.paste-item .right{display:flex;flex-direction:column;gap:8px;align-items:flex-end;flex:0 0 auto}
.paste-item .btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.paste-item .mini{padding:8px 10px;border-radius:12px;font-size:12px}
.paste-raw{margin-top:8px;font-size:12px;white-space:pre-wrap;line-height:1.45;color:var(--muted);border-top:1px dashed rgba(255,255,255,.12);padding-top:8px;display:none}
.paste-item.is-open .paste-raw{display:block}


/* paste list tools + chain save */
.paste-select{height:30px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:var(--text);font-size:12px;padding:0 10px;outline:none}
.paste-select:focus{border-color:rgba(var(--accentRGB),.35);box-shadow:0 0 0 3px rgba(var(--accentRGB),.10)}
.paste-list-tools{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.paste-mini-label{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
.paste-num{width:64px;height:30px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:var(--text);font-size:12px;padding:0 10px;outline:none}
.paste-num:focus{border-color:rgba(var(--accentRGB),.35);box-shadow:0 0 0 3px rgba(var(--accentRGB),.10)}
.paste-item .left{cursor:pointer}
.paste-item.is-saved{background:rgba(183,255,207,.05)}
.paste-item.is-saved .t{color:rgba(183,255,207,.92)}
.paste-stat{font-size:12px;color:var(--muted);line-height:1.35;text-align:right}
.paste-stat b{color:var(--text)}


/* KPI HERO */
.kpiHero{padding:14px 14px 12px;border-radius:16px;background:rgba(0,0,0,.03);border:1px solid rgba(0,0,0,.06);margin:8px 0 4px}
html[data-theme="dark"] .kpiHero{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.10)}
.kpiGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media(min-width:780px){.kpiGrid{grid-template-columns:repeat(4,minmax(0,1fr));}}
.kpiItem{padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.06)}
html[data-theme="dark"] .kpiItem{background:rgba(0,0,0,.18);border-color:rgba(255,255,255,.10)}
.kpiLabel{font-size:11px;opacity:.7;font-weight:800;letter-spacing:-.2px}
.kpiValue{font-size:16px;font-weight:1000;margin-top:2px;letter-spacing:-.3px}
.kpiNote{margin-top:10px;font-size:12px;opacity:.78;line-height:1.4}


/* Meta toggle */
#metaToggleBtn{margin-top:6px;padding:10px 12px;border-radius:14px}
#metaFields{margin-top:8px}
.simple #metaFields{display:none}
.simple #metaToggleBtn{display:inline-flex}
body:not(.simple) #metaToggleBtn{display:none}

.simple .kpiHero{position:sticky;top:72px;z-index:30}

/* ===== Îç∞Ïä§ÌÅ¨ÌÉë 2Ìå®ÎÑê(Ï§ëÍ∏â/Í≥†Í∏â) ===== */
.app-layout{display:block;}
.app-left{min-width:0;}
.app-right{min-width:0;}
@media (min-width:1024px){
  body.mid .app-layout.is-two,
  body.adv .app-layout.is-two{display:flex;gap:16px;align-items:flex-start;}
  body.mid .app-left,
  body.adv .app-left{flex:1;min-width:620px;}
  body.mid .app-right,
  body.adv .app-right{width:380px;position:sticky;top:88px;}
  body.mid .app-right .result,
  body.adv .app-right .result{max-height:calc(100vh - 120px);overflow:auto;}
}

/* ===== Î∂ôÏó¨ÎÑ£Í∏∞: Í∞ÑÎã® Î†àÎ≤®ÏóêÏÑú ÏõêÌÑ∞Ïπò Ï§ëÏã¨ ===== */
body.simple #pasteBox{border-width:2px;}
body.simple #pasteBox .box-title{font-size:16px;font-weight:1000;}
body.simple .paste-actions .paste-adv{display:none !important;}
body.simple .paste-inline .chk:not(.simple-only){display:none !important;}


</style>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Ìôà",
      "item": "https://88st.cloud/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Î∂ÑÏÑùÍ∏∞",
      "item": "https://88st.cloud/analysis/"
    }
  ]
}
</script>
<script src="/assets/js/88st-analytics.js?v=VIP4_20260214_15"></script>
<link href="/assets/88st-theme.css?v=VIP4_20260214_15" rel="stylesheet"/>
<link href="/assets/88st-tool-history.css?v=VIP4_20260214_15" rel="stylesheet"/>
<script defer="" src="/assets/js/88st-history-hub.js?v=VIP4_20260214_15"></script>
<link href="/assets/88st-shell.css?v=VIP4_20260214_15" rel="stylesheet"/>
<script defer="" src="/assets/js/88st-shell.js?v=VIP4_20260214_15"></script>
</head>
<body>
<!-- ‚úÖ ÏÇ¨Ïπ≠Ï£ºÏùò ÌåùÏóÖ (1Ïùº 1Ìöå) -->
<div class="scam-popup" id="scamPopup">
<div class="scam-box">
<h3>‚ö†Ô∏è ÏÇ¨Ïπ≠ Ï£ºÏùò ÏïàÎÇ¥</h3>
<p>
      88 Ïª§ÎÆ§ÎãàÌã∞ Í≥µÏãù Í¥ÄÎ¶¨Ïûê ÌÖîÎ†àÍ∑∏Îû®ÏùÄ<br/>
<b>@UZU59</b> Îã® ÌïòÎÇòÏûÖÎãàÎã§.<br/><br/>
      Í∑∏ Ïô∏ Í≥ÑÏ†ïÏùÄ ÏÇ¨Ïπ≠Ïùº Ïàò ÏûàÏúºÎãà<br/>
      Î∞òÎìúÏãú Ï£ºÏùòÌï¥ Ï£ºÏÑ∏Ïöî.
    </p>
<div class="btn primary" onclick="closeScam()">ÌôïÏù∏</div>
</div>
</div>
<!-- ‚úÖ Î∂ÑÏÑùÍ∏∞ ÏßÑÏûÖ Í¥ëÍ≥† ÌåùÏóÖ (1Ïùº 1Ìöå) -->
<div class="ad-popup" id="adPopup">
<div class="ad-box">
<div class="ad-head">
<div class="ad-title">üéÅ ÏßÄÍ∏à ÎßéÏù¥ Ï∞æÎäî Ï∂îÏ≤ú ÎÜÄÏù¥ÌÑ∞</div>
<div class="ad-close" onclick="closeAdPopup(true)">Ïò§Îäò Í∑∏Îßå Î≥¥Í∏∞</div>
</div>
<div class="ad-grid" id="adGrid"></div>
<div class="ad-actions">
<a aria-label="Ïù∏Ï¶ù ÎÜÄÏù¥ÌÑ∞ Î≥¥Í∏∞" class="btnx primary" href="/cert/">Ïù∏Ï¶ù ÎÜÄÏù¥ÌÑ∞ Î≥¥Í∏∞</a>
<a class="btnx" href="https://t.me/UZU59" rel="noopener" target="_blank">Î¨∏Ïùò</a>
</div>
<div class="ad-note">‚Äª ÌåùÏóÖÏùÄ 1Ïùº 1ÌöåÎßå ÌëúÏãúÎê©ÎãàÎã§. (ÏõêÏπò ÏïäÏúºÎ©¥ Îã´Í∏∞)</div>
<div class="ad-close" onclick="closeAdPopup(false)" style="margin-top:10px;text-align:center;">Îã´Í∏∞</div>
</div>
</div>
<div class="header">
<a aria-label="ÌôàÏúºÎ°ú Ïù¥Îèô" class="logo-link" href="/">
<img alt="88 Ïª§ÎÆ§ÎãàÌã∞" class="logo-img logoImg" src="/img/logo.png"/>
</a>
<div class="sub">Ïä§Ìè¨Ï∏† Î∞∞Îãπ Î∂ÑÏÑùÍ∏∞ (ÏôÑÏ†ÑÏ≤¥ ¬∑ ÌÜµÌï© ÎßàÏßÑ/EV/ÌûàÏä§ÌÜ†Î¶¨ ¬∑ ÌåêÎã® Î≥¥Ï°∞Ïö©)</div>
</div>
<div class="wrap">
<div class="card card--hero" id="calcCard">
<h2 class="sr-only">Ïä§Ìè¨Ï∏† Î∞∞Îãπ Î∂ÑÏÑùÍ∏∞</h2>
<div class="calc-hero">
<div class="calc-hero-left">
<div class="calc-kicker">88 Ïª§ÎÆ§ÎãàÌã∞ ¬∑ Î∞∞Îãπ Î∂ÑÏÑùÍ∏∞</div>
<div class="calc-headline">ÎßàÏßÑ ¬∑ EV ¬∑ ÏºàÎ¶¨ ¬∑ ÎùºÏù∏Î≥Ñ ÎßàÏßÑÍπåÏßÄ <span class="accent">Ìïú Î≤àÏóê</span></div>
<div aria-label="Ï£ºÏöî Í∏∞Îä•" class="calc-tags">
<span class="tag">Î©îÏù∏/OU/Ìï∏Îîî ÌÜµÌï©</span>
<span class="tag">ÌûàÏä§ÌÜ†Î¶¨¬∑ÎπÑÍµê</span>
<span class="tag">Í≥µÏú†¬∑Í≥µÏú†Ïπ¥Îìú</span>
</div>
</div>
<div class="calc-hero-right">
<div aria-label="ÏûêÎèô Ï†ÄÏû• ÏÉÅÌÉú" class="autosave">
<span class="autosave-label">ÏûêÎèô Ï†ÄÏû•</span>
<span aria-live="polite" class="save-badge" id="saveBadge"></span>
</div>
<button class="btn secondary mini" onclick="toggleMiniGuide()" type="button">10Ï¥à Í∞ÄÏù¥Îìú</button>
</div>
</div>
<div aria-hidden="true" class="calc-divider"></div>
<div class="controls controls-settings">
<div class="selectWrap">
<div class="fieldLabel"><span class="stepBubble">1</span> Ï¢ÖÎ™©</div>
<select class="select" id="sport" onchange="onSportChange()">
<option value="soccer">Ï∂ïÍµ¨</option>
<option value="basketball">ÎÜçÍµ¨</option>
<option value="baseball">ÏïºÍµ¨</option>
<option value="volleyball">Î∞∞Íµ¨</option>
<option value="esports">eÏä§Ìè¨Ï∏†</option>
<option value="hockey">ÌïòÌÇ§</option>
</select>
</div>
<div class="selectWrap">
<div class="fieldLabel"><span class="stepBubble">2</span> Î∂ÑÏÑù Î†àÎ≤®</div>
<select class="select" id="level" onchange="onLevelChange()">
<option value="simple">Í∞ÑÎã®</option>
<option value="mid">Ï§ëÍ∏â</option>
<option value="adv">Í≥†Í∏â</option>
</select>
</div>
</div>
<div class="settingsHint">üëá Î®ºÏ†Ä <b>Ï¢ÖÎ™©</b>Í≥º <b>Î†àÎ≤®</b>ÏùÑ ÏÑ†ÌÉùÌïòÎ©¥, ÏïÑÎûò ÏûÖÎ†• Ìèº(Î©îÏù∏/Ïò§Î≤Ñ¬∑Ïñ∏Îçî/Ìï∏Îîî)Ïù¥ ÏûêÎèôÏúºÎ°ú ÏµúÏ†ÅÌôîÎê©ÎãàÎã§.</div>
<!-- ‚úÖ ÌåÄ/Î¶¨Í∑∏ ÏûÖÎ†•(ÏÑ†ÌÉù) -->
<button class="btn ghost" id="metaToggleBtn" onclick="toggleMeta()" type="button">Ï∂îÍ∞Ä Ï†ïÎ≥¥ ÏûÖÎ†•(ÏÑ†ÌÉù) ‚ñæ</button><div id="metaFields"><div class="row2">
<div>
<input class="textinput" id="league" placeholder="Î¶¨Í∑∏/ÎåÄÌöåÎ™Ö (ÏÑ†ÌÉù)"/>
<div class="small-hint">‚Äª ÏûÖÎ†•ÌïòÏßÄ ÏïäÏïÑÎèÑ Î∂ÑÏÑù Í∞ÄÎä• / Í≥µÏú† Ïãú ÏûÖÎ†•Ìïú ÎÇ¥Ïö©Îßå Ìè¨Ìï®Îê©ÎãàÎã§.</div>
</div>
<div>
<input class="textinput" id="teams" placeholder="ÌåÄÎ™Ö (ÏÑ†ÌÉù) Ïòà: Îß®ÏãúÌã∞ vs Î¶¨Î≤ÑÌíÄ"/>
<div class="small-hint">‚Äª ÌåÄ/Î¶¨Í∑∏Îäî ÏÑ†ÌÉùÏÇ¨Ìï≠ÏûÖÎãàÎã§.</div>
</div>
</div></div>
<div class="small-hint" id="sportHint" style="margin-top:10px;"></div>
<nav aria-label="Î∂ÑÏÑùÍ∏∞ ÏÑπÏÖò" class="st-tabbar" id="appTabbar" role="tablist">
<button aria-selected="true" class="st-tab on" data-jump="main" role="tab" type="button">Î©îÏù∏</button>
<button aria-selected="false" class="st-tab" data-jump="total" role="tab" type="button">Ïò§Î≤Ñ¬∑Ïñ∏Îçî</button>
<button aria-selected="false" class="st-tab" data-jump="handicap" role="tab" type="button">Ìï∏ÎîîÏ∫°</button>
<button aria-selected="false" class="st-tab" data-jump="result" role="tab" type="button">Í≤∞Í≥º</button>
<button aria-selected="false" class="st-tab" data-jump="history" role="tab" type="button">ÌûàÏä§ÌÜ†Î¶¨</button>
</nav>
<div class="mini-guide" id="miniGuide">
<div class="head" onclick="toggleMiniGuide()">
<div>üí° Ï≤òÏùåÏù¥Î©¥ <b>10Ï¥à Í∞ÄÏù¥Îìú</b></div>
<button aria-expanded="false" class="pill" id="miniGuidePill" type="button">Ïó¥Í∏∞</button>
</div>
<div class="body" id="miniGuideBody">
          1) <b>Ï¢ÖÎ™©/Î™®Îìú</b> ÏÑ†ÌÉù ‚Üí 2) <b>Î©îÏù∏ Î∞∞Îãπ</b> ÏûÖÎ†•(ÌïÑÏàò) ‚Üí 3) Ïò§Î≤Ñ¬∑Ïñ∏Îçî/Ìï∏Îîî(ÏÑ†ÌÉù) ‚Üí 4) <b>Ï§ëÍ∏â/Í≥†Í∏â</b>Ïù¥Î©¥ <b>ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†</b> ÏûÖÎ†• Ïãú EV/ÏºàÎ¶¨ÍπåÏßÄ Í≥ÑÏÇ∞Îê©ÎãàÎã§.<br/>
          ‚Ä¢ Í≤∞Í≥ºÎäî <b>ÌåêÎã® Î≥¥Ï°∞Ïö©</b>Ïù¥Î©∞, ÎßàÏßÑÏù¥ ÎÜíÏùÑÏàòÎ°ù Ïû•Í∏∞ Í∏∞ÎåÄÍ∞íÏù¥ Î∂àÎ¶¨Ìï¥Ïßà Ïàò ÏûàÏñ¥Ïöî.<br/>
          ‚Ä¢ ÌûàÏä§ÌÜ†Î¶¨ Ìï≠Î™© ÌÅ¥Î¶≠ÌïòÎ©¥ <b>ÏûÖÎ†• ÏûêÎèô Î≥µÏõê + Ïû¨Í≥ÑÏÇ∞</b>Îê©ÎãàÎã§.
        </div>
</div>
<!-- ‚úÖ ÏµúÍ∑º ÏûÖÎ†• Ïä§ÎÉÖÏÉ∑(ÏµúÍ∑º 5Í∞ú) -->
<div class="snap-wrap" id="snapWrap" style="display:none;">
<div class="snap-head">
<div>üïò ÏµúÍ∑º ÏûÖÎ†•</div>
<div class="snap-meta" id="snapMeta"></div>
</div>
<div class="snap-list" id="snapList"></div>
</div>
<!-- ===== ÌÖçÏä§Ìä∏ Î∂ôÏó¨ÎÑ£Í∏∞ (ÏûêÎèô ÏûÖÎ†•) ===== -->
<div class="box" id="pasteBox">
<div class="box-head">
<div class="box-title" style="margin:0;">ÌÖçÏä§Ìä∏ Î∂ôÏó¨ÎÑ£Í∏∞ (ÏûêÎèô ÏûÖÎ†•)</div>
<button class="toggle" data-target="pasteBody" onclick="toggleBox('pasteBody')" type="button">Ï†ëÍ∏∞</button>
</div>
<div id="pasteBody">
<div class="small-hint" style="margin-top:4px;">
            Ïª§ÎÆ§ÎãàÌã∞ Í∏Ä/Î∞∞ÎãπÌëú ÌÖçÏä§Ìä∏Î•º Í∑∏ÎåÄÎ°ú Î∂ôÏó¨ÎÑ£ÏúºÎ©¥ <b>Î©îÏù∏/Ïò§Î≤Ñ¬∑Ïñ∏Îçî/Ìï∏Îîî</b> Î∞∞ÎãπÏùÑ ÏûêÎèôÏúºÎ°ú Ï±ÑÏõåÏ§çÎãàÎã§. (ÏßÄÏõê: 2Î∞∞Îãπ/3Î∞∞Îãπ, Ïò§Î≤Ñ¬∑Ïñ∏Îçî, Ìï∏Îîî)
          </div>
<div class="paste-area" style="margin-top:10px;">
<textarea class="paste-ta" id="pasteInput" placeholder="Ïòà) Îß®ÏãúÌã∞ vs Î¶¨Î≤ÑÌíÄ  Ïäπ 1.85 Î¨¥ 3.40 Ìå® 4.20 / Ïò§Î≤Ñ 2.5 1.95 Ïñ∏Îçî 1.85 / Ìï∏Îîî -1.5 1.90 1.95"></textarea>
<div class="paste-actions">

<button class="btn primary" id="btnPasteOneTap" onclick="applyPaste(true)" type="button">ÏõêÌÑ∞Ïπò ÏûêÎèô ÏûÖÎ†•+Í≤∞Í≥º</button>
<button class="btn primary paste-adv" onclick="applyPaste(true)" type="button">ÏûêÎèô ÏûÖÎ†•</button>
<button class="btn secondary paste-adv" onclick="applyPaste(false)" type="button">ÏûÖÎ†•Îßå</button>
<button class="btn secondary paste-adv" onclick="parsePasteMulti()" type="button">Ïó¨Îü¨ Í≤ΩÍ∏∞ ÎßåÎì§Í∏∞</button>
<button class="btn ghost" onclick="fillPasteExample()" type="button">ÏòàÏãú</button>
<button class="btn ghost" onclick="clearPaste()" type="button">ÏßÄÏö∞Í∏∞</button>
<button class="btn ghost paste-adv" onclick="clearPasteList()" type="button">Î¶¨Ïä§Ìä∏ ÏßÄÏö∞Í∏∞</button>
<span class="paste-badge good" id="pasteBadgeOk" style="display:none;"></span>
<span class="paste-badge warn" id="pasteBadgeWarn" style="display:none;"></span>
<div class="paste-inline" style="margin-left:auto;">
<label class="chk simple-only"><input checked="" id="pasteAutoRun" type="checkbox"/> Î∂ôÏó¨ÎÑ£ÏûêÎßàÏûê Í≥ÑÏÇ∞</label>
<label class="chk">Î©îÏù∏ ÌÉÄÏûÖ
                  <select class="paste-select" id="pasteMainMode" title="Î©îÏù∏ Î∞∞Îãπ ÌÉÄÏûÖ">
<option value="auto">ÏûêÎèô</option>
<option value="2">2Î∞∞Îãπ</option>
<option value="3">3Î∞∞Îãπ</option>
</select>
</label>
<label class="chk"><input checked="" id="pasteAutoLevel" type="checkbox"/> OU/Ìï∏Îîî Í∞êÏßÄ Ïãú Î†àÎ≤® ÏûêÎèô Ï†ÑÌôò</label>
<label class="chk"><input checked="" id="pasteChainMode" type="checkbox"/> ÌÅ¥Î¶≠=Ïó∞ÏÜç Ï†ÄÏû•</label>
<label class="chk"><input checked="" id="pasteSkipLow" type="checkbox"/> Ï†ïÌôïÎèÑ ÎÇÆÏùå Ï†úÏô∏</label>
</div>
</div>
<div class="small-hint" id="pasteHint"></div>
<div class="paste-list-wrap" id="pasteListWrap" style="display:none;">
<div class="paste-list-head">
<div class="k">Í∞êÏßÄÎêú Í≤ΩÍ∏∞</div>
<div class="m" id="pasteListMeta"></div>
<div class="paste-list-tools">
<button class="btn ghost mini" onclick="togglePasteSort()" type="button">Ï†ïÎ†¨: ÎßàÏßÑ ÎÇÆÏùÄÏàú</button>
<label class="paste-mini-label">Ïó∞ÏÜç
                    <input class="paste-num" id="pasteChainCount" max="30" min="1" type="number" value="10"/>
                    Í∞ú
                  </label>
<button class="btn primary mini" onclick="startChainSave()" type="button">Ïó∞ÏÜç Ï†ÄÏû•</button>
<button class="btn ghost mini" id="pasteChainStop" onclick="stopChainSave()" style="display:none;" type="button">Ï§ëÏßÄ</button>
<button class="btn secondary mini" id="btnBundleShare" onclick="openBundleShare()" type="button">Ïò§Îäò ÏàòÏßë Î¨∂Ïùå</button>
<button class="btn danger mini" onclick="resetBundleToday()" title="Ïò§Îäò ÏàòÏßë Î¨∂Ïùå(Ïó∞ÏÜç Ï†ÄÏû•ÏúºÎ°ú ÎàÑÏ†ÅÎêú Ìï≠Î™©)ÏùÑ Ï¥àÍ∏∞ÌôîÌï©ÎãàÎã§." type="button">Ï¥àÍ∏∞Ìôî</button>
</div>
</div>
<div class="paste-list" id="pasteList"></div>
</div>
</div>
</div>
</div>
<!-- ===== Î©îÏù∏ ÏãúÏû• ===== -->
<div class="box" id="mainBox">
<div class="box-title" id="mainMarketTitle">Î©îÏù∏ Î∞∞Îãπ</div>
<div class="st-point" id="mainPoint"></div>
<!-- 2-way -->
<div id="main2" style="display:none;">
<div class="grid">
<div class="field">
<label id="main2LabelA">ÏÑ†ÌÉù A Î∞∞Îãπ</label>
<input id="main2OddsA" inputmode="decimal" placeholder="Ïòà: 1.85"/>
</div>
<div class="field">
<label id="main2LabelB">ÏÑ†ÌÉù B Î∞∞Îãπ</label>
<input id="main2OddsB" inputmode="decimal" placeholder="Ïòà: 2.05"/>
</div>
</div>
</div>
<!-- 3-way -->
<div id="main3" style="display:none;">
<div class="grid">
<div class="field">
<label id="main3LabelH">Ìôà Î∞∞Îãπ</label>
<input id="main3OddsH" inputmode="decimal" placeholder="Ïòà: 2.10"/>
</div>
<div class="field">
<label id="main3LabelD">Î¨¥ Î∞∞Îãπ</label>
<input id="main3OddsD" inputmode="decimal" placeholder="Ïòà: 3.20"/>
</div>
<div class="field">
<label id="main3LabelA">ÏõêÏ†ï Î∞∞Îãπ</label>
<input id="main3OddsA" inputmode="decimal" placeholder="Ïòà: 3.40"/>
</div>
<div class="field">
<label> </label>
<input disabled="" value="‚Äª Ï∂ïÍµ¨Îäî 3Î∞∞ÎãπÏù¥ Í∏∞Î≥∏ÏûÖÎãàÎã§"/>
</div>
</div>
</div>
<!-- Ï§ëÍ∏â/Í≥†Í∏â: ÎÇ¥ ÌôïÎ•†/Î≤†ÌåÖÍ∏à -->
<div id="valueInputs" style="display:none;">
<div class="grid">
<div class="field">
<label id="myProbLabel">ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†(ÏÑ†ÌÉù) %</label>
<input id="myProb" inputmode="decimal" placeholder="Ïòà: 55  ÎòêÎäî  45,28,27"/>
<div class="small-hint" id="myProbHint"></div>
</div>
<div class="field">
<label>Î≤†ÌåÖÍ∏à(ÏÑ†ÌÉù)</label>
<input id="stake" inputmode="numeric" placeholder="Ïòà: 100000"/>
<div class="small-hint">‚Äª ÏûÖÎ†• Ïãú Í∏∞ÎåÄÍ∞í(EV)ÏùÑ Ïõê Îã®ÏúÑÎ°úÎèÑ ÌëúÏãúÌï©ÎãàÎã§.</div>
</div>
</div>
</div>
</div>
<!-- ===== ÎùºÏù∏ ÎπÑÍµê (A vs B) ===== -->
<div class="box" id="lineCompareBox">
<div class="box-head">
<div class="box-title" style="margin:0;">ÎùºÏù∏ ÎπÑÍµê (A vs B)</div>
<button class="toggle" data-target="lineCompareBody" onclick="toggleBox('lineCompareBody')" type="button">ÌéºÏπòÍ∏∞</button>
</div>
<div id="lineCompareBody" style="display:none;">
<div class="small-hint" style="margin-top:4px;">
            Îëê ÏóÖÏ≤¥(ÎòêÎäî Îëê ÎùºÏù∏) Î∞∞ÎãπÏùÑ ÎÑ£Í≥† <b>ÎßàÏßÑ/Í≥µÏ†ïÎ∞∞Îãπ</b>ÏùÑ ÎπÑÍµêÌïòÏÑ∏Ïöî. Í∞ôÏùÄ Ï°∞Í±¥Ïù¥Î©¥ ÎßàÏßÑÏù¥ ÎÇÆÏùÄ Ï™ΩÏù¥ Ïú†Î¶¨Ìïú Í≤ΩÏö∞Í∞Ä ÎßéÏäµÎãàÎã§.
          </div>
<div class="lc-grid">
<div class="lc-col">
<div class="lc-head">ÎùºÏù∏ A</div>
<div class="grid lc-fields" id="lcA2" style="display:none;">
<div class="field">
<label id="lcA2LabelA">ÏÑ†ÌÉù A Î∞∞Îãπ</label>
<input id="lcA2OddsA" inputmode="decimal" placeholder="Ïòà: 1.85"/>
</div>
<div class="field">
<label id="lcA2LabelB">ÏÑ†ÌÉù B Î∞∞Îãπ</label>
<input id="lcA2OddsB" inputmode="decimal" placeholder="Ïòà: 2.05"/>
</div>
</div>
<div class="grid lc-fields" id="lcA3" style="display:none;">
<div class="field">
<label id="lcA3LabelH">Ìôà Î∞∞Îãπ</label>
<input id="lcA3OddsH" inputmode="decimal" placeholder="Ïòà: 2.10"/>
</div>
<div class="field">
<label id="lcA3LabelD">Î¨¥ Î∞∞Îãπ</label>
<input id="lcA3OddsD" inputmode="decimal" placeholder="Ïòà: 3.20"/>
</div>
<div class="field">
<label id="lcA3LabelA">ÏõêÏ†ï Î∞∞Îãπ</label>
<input id="lcA3OddsA" inputmode="decimal" placeholder="Ïòà: 3.40"/>
</div>
<div class="field">
<label> </label>
<input disabled="" value="(A) 3Î∞∞Îãπ ÏûÖÎ†•"/>
</div>
</div>
<button class="btn secondary" onclick="applyLineCompare('A')" type="button">AÎ•º Î©îÏù∏Ïóê Ï†ÅÏö©</button>
</div>
<div class="lc-col">
<div class="lc-head">ÎùºÏù∏ B</div>
<div class="grid lc-fields" id="lcB2" style="display:none;">
<div class="field">
<label id="lcB2LabelA">ÏÑ†ÌÉù A Î∞∞Îãπ</label>
<input id="lcB2OddsA" inputmode="decimal" placeholder="Ïòà: 1.85"/>
</div>
<div class="field">
<label id="lcB2LabelB">ÏÑ†ÌÉù B Î∞∞Îãπ</label>
<input id="lcB2OddsB" inputmode="decimal" placeholder="Ïòà: 2.05"/>
</div>
</div>
<div class="grid lc-fields" id="lcB3" style="display:none;">
<div class="field">
<label id="lcB3LabelH">Ìôà Î∞∞Îãπ</label>
<input id="lcB3OddsH" inputmode="decimal" placeholder="Ïòà: 2.10"/>
</div>
<div class="field">
<label id="lcB3LabelD">Î¨¥ Î∞∞Îãπ</label>
<input id="lcB3OddsD" inputmode="decimal" placeholder="Ïòà: 3.20"/>
</div>
<div class="field">
<label id="lcB3LabelA">ÏõêÏ†ï Î∞∞Îãπ</label>
<input id="lcB3OddsA" inputmode="decimal" placeholder="Ïòà: 3.40"/>
</div>
<div class="field">
<label> </label>
<input disabled="" value="(B) 3Î∞∞Îãπ ÏûÖÎ†•"/>
</div>
</div>
<button class="btn secondary" onclick="applyLineCompare('B')" type="button">BÎ•º Î©îÏù∏Ïóê Ï†ÅÏö©</button>
</div>
</div>
<div class="lc-out" id="lineCompareOut" style="display:none;"></div>
<div class="actionRow" style="margin-top:10px;">
<button class="btn" onclick="runLineCompare()" type="button">ÎπÑÍµê Í≥ÑÏÇ∞</button>
<button class="btn ghost" onclick="prefillLineCompare()" type="button">ÌòÑÏû¨ Î©îÏù∏Í∞íÏúºÎ°ú Ï±ÑÏö∞Í∏∞</button>
</div>
</div>
</div>
<!-- ===== Ìï∏ÎîîÏ∫° (Ï†ïÎ∞Ä: ÏñëÏ™Ω Î∞∞Îãπ) ===== -->
<div class="box" id="handicapBox" style="display:none;">
<div class="box-head">
<div class="box-title" style="margin:0;">Ìï∏ÎîîÏ∫° (ÏÑ†ÌÉù ¬∑ Ï†ïÎ∞Ä ÎßàÏßÑ)</div>
<button class="toggle" data-target="handicapBody" onclick="toggleBox('handicapBody')" type="button">Ï†ëÍ∏∞</button>
</div>
<div id="handicapBody">
<div class="grid">
<div class="field">
<label id="handicapLineLabel">Ìï∏Îîî ÎùºÏù∏ (Ïòà: -1.5, +3.5)</label>
<input id="handicapLine" inputmode="decimal" placeholder="Ïòà: -1.5"/>
</div>
<div class="field">
<label id="handicapOddsALabel">Ìï∏Îîî ÏÑ†ÌÉùA Î∞∞Îãπ</label>
<input id="handicapOddsA" inputmode="decimal" placeholder="Ïòà: 1.90"/>
</div>
<div class="field">
<label id="handicapOddsBLabel">Î∞òÎåÄ(ÏÑ†ÌÉùB) Î∞∞Îãπ</label>
<input id="handicapOddsB" inputmode="decimal" placeholder="Ïòà: 1.95"/>
</div>
<div class="field">
<label>ÏïÑÏãúÏïà(Ìë∏Ïãú) Í∑ºÏÇ¨(ÏÑ†ÌÉù)</label>
<input id="handicapPush" inputmode="decimal" placeholder="Ìë∏Ïãú ÌôïÎ•† % (Ïòà: 2)"/>
</div>
</div>
<div class="small-hint">
            ‚Äª ‚ÄúÏñëÏ™Ω Î∞∞Îãπ‚ÄùÏù¥ ÏûàÏñ¥Ïïº Ìï∏Îîî ÎßàÏßÑÏùÑ Ï†ïÎ∞Ä Í≥ÑÏÇ∞Ìï† Ïàò ÏûàÏäµÎãàÎã§. (Îã®Ïùº Î∞∞ÎãπÎßå ÏûàÏúºÎ©¥ Ï∞∏Í≥† ÏàòÏ§Ä)
          </div>
</div>
</div>
<!-- ===== Ïò§Î≤ÑÏñ∏Îçî ===== -->
<div class="box" id="totalBox" style="display:none;">
<div class="box-head">
<div class="box-title" style="margin:0;">Ïò§Î≤Ñ/Ïñ∏Îçî (ÏÑ†ÌÉù ¬∑ ÏïÑÏãúÏïà Í∑ºÏÇ¨ ÏßÄÏõê)</div>
<button class="toggle" data-target="totalBody" onclick="toggleBox('totalBody')" type="button">Ï†ëÍ∏∞</button>
</div>
<div id="totalBody">
<div class="grid">
<div class="field">
<label>Í∏∞Ï§ÄÏ†ê (Ïòà: 2.5, 7.5, 2.0)</label>
<input id="totalLine" inputmode="decimal" placeholder="Ïòà: 2.5"/>
</div>
<div class="field">
<label>Ïò§Î≤Ñ Î∞∞Îãπ</label>
<input id="overOdds" inputmode="decimal" placeholder="Ïòà: 1.95"/>
</div>
<div class="field">
<label>Ïñ∏Îçî Î∞∞Îãπ</label>
<input id="underOdds" inputmode="decimal" placeholder="Ïòà: 1.85"/>
</div>
<div class="field">
<label>ÏïÑÏãúÏïà(Ìë∏Ïãú) Í∑ºÏÇ¨(ÏÑ†ÌÉù)</label>
<input id="ouPush" inputmode="decimal" placeholder="Ìë∏Ïãú ÌôïÎ•† % (Ïòà: 6)"/>
</div>
<div class="field">
<label>ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†(Ïò§Î≤Ñ) % (Í≥†Í∏â)</label>
<input id="myOverProb" inputmode="decimal" placeholder="Ïòà: 52"/>
</div>
<div class="field">
<label> </label>
<input disabled="" value="‚Äª Ìë∏Ïãú ÌôïÎ•† ÎØ∏ÏûÖÎ†• Ïãú Ï¢ÖÎ™© Í∏∞Î≥∏Í∞íÏúºÎ°ú Í∑ºÏÇ¨Ìï©ÎãàÎã§"/>
</div>
</div>
<div class="small-hint">‚Äª Í≥†Í∏âÏóêÏÑú ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†(Ïò§Î≤Ñ)ÏùÑ ÎÑ£ÏúºÎ©¥ Ïò§Î≤Ñ EV/ÎπÑÏ§ë Í≥ÑÏÇ∞Ïù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.</div>
</div>
</div>
<div aria-live="polite" class="input-warn" id="inputWarn"></div>
<div class="actions">
<button class="btn primary" id="btnCalc" onclick="calc()" type="button">Í≥ÑÏÇ∞ÌïòÍ∏∞</button>
<button class="btn secondary" onclick="resetAll()" type="button">Ï¥àÍ∏∞Ìôî</button>
</div>
<div class="note">
        ‚Äª Î≥∏ ÎèÑÍµ¨Îäî ‚ÄúÌåêÎã® Î≥¥Ï°∞Ïö©‚ÄùÏûÖÎãàÎã§. ÏäπÎ•†ÏùÑ Î≥¥Ïû•ÌïòÏßÄ ÏïäÏúºÎ©∞, ÏÜêÏã§ÏùÑ Í∞êÎãπ Í∞ÄÎä•Ìïú Î≤îÏúÑ ÎÇ¥ÏóêÏÑú Ïù¥Ïö©ÌïòÏÑ∏Ïöî.
      </div>
<!-- ‚úÖ ÌÜµÌï© ÎßàÏßÑ ÎåÄÏãúÎ≥¥Îìú -->
<div class="box" style="margin-top:12px;">
<div class="m-grid" id="marginDash">
<!-- JS Î†åÎçî -->
</div>
<div class="small-hint" style="margin-top:10px;">
          ‚Äª ÏÉâÏÉÅ: <span class="good">ÎÇÆÏùå</span> / <span class="mid">Î≥¥ÌÜµ¬∑Ï£ºÏùò</span> / <span class="warn">Í≥†ÎßàÏßÑ</span>
</div>
</div>
<div class="result" id="result" style="display:none;"></div>
<div aria-label="Ï†ÄÏû•/Í≥µÏú†/ÏóÖÏ≤¥ Î∞îÎ°úÍ∞ÄÍ∏∞" class="result-dock" id="resultDock" style="display:none;">
<button class="btn secondary" onclick="quickJump('history')" type="button">Ï†ÄÏû•Îê® ¬∑ ÌûàÏä§ÌÜ†Î¶¨</button>
<button class="btn gold" onclick="openShareCard()" type="button">Í≥µÏú†</button>
<a class="btn secondary" data-cta="analysis_to_vendors" data-no-auto-outbound="1" href="/cert/">ÏóÖÏ≤¥ Ïπ¥Îìú</a>
</div>
</div>
<!-- ‚úÖ TOP3 + Í∏∞Ï§Ä/ÏòàÏãú (Î∞òÎ∞ò) -->
<div class="card" id="topInfoCard">
<h2 class="sr-only">Ïò§Îäò ÎßàÏßÑ ÎÇÆÏùÄ TOP3 Î∞è ÎßàÏßÑ Í∏∞Ï§Ä</h2>
<div class="split">
<section aria-label="Ïò§Îäò ÎßàÏßÑ ÎÇÆÏùÄ Í≥ÑÏÇ∞ TOP3" class="split-col">
<div class="subhead"><span class="mini-badge">TOP3</span>Ïò§Îäò ÎßàÏßÑ ÎÇÆÏùÄ Í≥ÑÏÇ∞ TOP3</div>
<div class="small-hint">‚Äª Ïò§Îäò Ï†ÄÏû•Îêú ÌûàÏä§ÌÜ†Î¶¨ÏóêÏÑú ‚ÄúÎßàÏßÑ%‚ÄùÍ∞Ä Í∞ÄÏû• ÎÇÆÏùÄ ÏàúÏúºÎ°ú ÏûêÎèô Ï†ïÎ†¨Îê©ÎãàÎã§.</div>
<div class="box" style="margin-top:10px;">
<div class="box-title">Î©îÏù∏ ÎßàÏßÑ TOP3</div>
<div class="small-hint" id="topMain"></div>
</div>
<div class="box">
<div class="box-title">Ïò§Î≤Ñ/Ïñ∏Îçî ÎßàÏßÑ TOP3</div>
<div class="small-hint" id="topOU"></div>
</div>
<div class="box">
<div class="box-title">Ìï∏ÎîîÏ∫° ÎßàÏßÑ TOP3</div>
<div class="small-hint" id="topHC"></div>
</div>
</section>
<section aria-label="ÎßàÏßÑ ÎÇÆÏùÄ Í≤ΩÍ∏∞ Í∏∞Ï§ÄÍ≥º ÏòàÏãú" class="split-col">
<div class="subhead"><span class="mini-badge">INFO</span>‚ÄúÎßàÏßÑ ÎÇÆÏùÄ Í≤ΩÍ∏∞‚Äù Í∏∞Ï§Ä &amp; ÏòàÏãú</div>
<div class="note" style="margin-top:0;">
      ‚Ä¢ ÎßàÏßÑ(ÏàòÏàòÎ£å)ÏùÄ <b>Ïò§Î≤ÑÎùºÏö¥Îìú-1</b>ÏùÑ %Î°ú ÌëúÌòÑÌïú Í∞íÏûÖÎãàÎã§.<br/>
      ‚Ä¢ Ï¢ÖÎ™©/Ïú†ÌòïÎ≥ÑÎ°ú ÏùºÎ∞òÏ†ÅÏù∏ ÎßàÏßÑ Î≤îÏúÑÍ∞Ä Îã¨ÎùºÏÑú, Ïù¥ ÌéòÏù¥ÏßÄÎäî <b>Ï¢ÖÎ™©+Ïú†ÌòïÎ≥Ñ Í∏∞Ï§Ä</b>ÏúºÎ°ú ‚ÄúÎÇÆÏùå/Î≥¥ÌÜµ/Ï£ºÏùò/Í≥†ÎßàÏßÑ‚ÄùÏùÑ ÌåêÏ†ïÌï©ÎãàÎã§.<br/>
      ‚Ä¢ ÏïÑÎûò Í∏∞Ï§ÄÏùÄ ‚ÄúÎåÄÎûµÏ†ÅÏù∏ Ï≤¥Í∞ê‚ÄùÏùÑ Îπ†Î•¥Í≤å ÎèïÍ∏∞ ÏúÑÌïú Ïö©ÎèÑÏù¥Î©∞, Ïã§Ï†ú ÎùºÏù∏/ÏóÖÏ≤¥/ÏãúÏû•Ïóê Îî∞Îùº Îã¨ÎùºÏßà Ïàò ÏûàÏñ¥Ïöî.
    </div>
<div class="box" style="margin-top:10px;">
<div class="box-title">ÏòàÏãú (Ï∂ïÍµ¨ 1X2)</div>
<div class="small-hint">
        Î∞∞Îãπ: <b>1.70 / 3.20 / 3.40</b> ‚Üí Ïò§Î≤ÑÎùºÏö¥ÎìúÍ∞Ä Ïª§Ï†∏ <b>Í≥†ÎßàÏßÑ</b>ÏúºÎ°ú Îú∞ Ïàò ÏûàÏäµÎãàÎã§.<br/>
        Î∞òÎåÄÎ°ú ÎèôÏùº ÏãúÏû•ÏóêÏÑú Ïò§Î≤ÑÎùºÏö¥ÎìúÍ∞Ä 1.05 Í∑ºÏ≤òÎ©¥ ÎåÄÏ≤¥Î°ú <b>ÎßàÏßÑ ÎÇÆÏùå</b>ÏúºÎ°ú ÌëúÏãúÎê©ÎãàÎã§.
      </div>
</div>
</section>
</div>
</div>
<div class="card" id="historyCard">
<h2 class="sr-only">ÏµúÍ∑º Í≥ÑÏÇ∞ ÌûàÏä§ÌÜ†Î¶¨</h2>
<div class="small-hint">
        ‚Ä¢ ÌûàÏä§ÌÜ†Î¶¨ Ìï≠Î™© ÌÅ¥Î¶≠ ‚Üí <b>ÏûÖÎ†• ÏûêÎèô Î≥µÏõê + Ï¶âÏãú Ïû¨Í≥ÑÏÇ∞</b><br/>
        ‚Ä¢ Ï≤¥ÌÅ¨ 2Í∞ú ÏÑ†ÌÉù ‚Üí <b>ÎπÑÍµê(2Í∞ú ÎÇòÎûÄÌûà)</b> Í∞ÄÎä•
      </div>
<div class="history-actions">
<div class="history-toolbar">
<button class="btn secondary danger" disabled="" id="btnDeleteSelected" onclick="deleteSelected()" type="button">ÏÑ†ÌÉù ÏÇ≠Ï†ú</button>
<button class="btn secondary" onclick="clearHistory()" type="button">Ï†ÑÏ≤¥ ÏÇ≠Ï†ú</button>
<button class="btn secondary" disabled="" id="btnCompare" onclick="openCompare()" type="button">ÎπÑÍµê</button>
<button class="btn secondary" onclick="renderTop3()" type="button">TOP3</button>
</div>
<div aria-label="ÌûàÏä§ÌÜ†Î¶¨ ÌïÑÌÑ∞" class="history-filters">
<button class="seg on" data-filter="all" onclick="setHistoryFilter('all', this)" type="button">Ï†ÑÏ≤¥</button>
<button class="seg" data-filter="rec" onclick="setHistoryFilter('rec', this)" type="button">Ï∂îÏ≤ú</button>
<button class="seg" data-filter="untracked" onclick="setHistoryFilter('untracked', this)" type="button">ÎØ∏Í∏∞Î°ù</button>
<div class="pick-ind">ÏÑ†ÌÉù <b id="pickCount">0</b></div>
</div>
</div>
<div class="perf-box" id="perfBox" style="display:none;">
<div class="perf-title">
<div>üìä ÎÇ¥ ÏÑ±Í≥º</div>
<div class="snap-meta" id="perfMeta"></div>
</div>
<div class="perf-sub" id="perfSub"></div>
<div class="perf-grid" id="perfGrid"></div>
</div>
<div class="h-list" id="historyList"></div>
</div>
</div>
<!-- ÎπÑÍµê Î™®Îã¨ -->
<div class="modal" id="compareModal">
<div class="modal-box">
<div class="modal-head">
<div class="t">ÎπÑÍµê (2Í∞ú ÎÇòÎûÄÌûà)</div>
<div class="modal-close" onclick="closeCompare()">Îã´Í∏∞</div>
</div>
<div class="small-hint" style="margin-bottom:10px;">
      ÌûàÏä§ÌÜ†Î¶¨ÏóêÏÑú Ï≤¥ÌÅ¨Î∞ïÏä§Î°ú 2Í∞ú ÏÑ†ÌÉù ÌõÑ ‚ÄúÎπÑÍµê Ïó¥Í∏∞‚ÄùÎ•º ÎàÑÎ•¥ÏÑ∏Ïöî.
    </div>
<div class="compare-grid" id="compareGrid"></div>
</div>
</div>
<!-- Í≥µÏú† Ïπ¥Îìú Î™®Îã¨ (Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•) -->
<div class="modal" id="shareCardModal" style="display:none;">
<div class="modal-box share">
<div class="modal-head">
<div class="t">Í≥µÏú† Ïπ¥Îìú (Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•)</div>
<div class="modal-close" onclick="closeShareCard()">Îã´Í∏∞</div>
</div>
<div class="small-hint" style="margin-bottom:10px;">
      Í≤∞Í≥ºÍ∞Ä ÏÉùÏÑ±Îêú ÏÉÅÌÉúÏóêÏÑúÎßå Ïπ¥ÎìúÍ∞Ä ÎßåÎì§Ïñ¥ÏßëÎãàÎã§. (ÌÖçÏä§Ìä∏/ÎßÅÌÅ¨ÎèÑ Ìï®Íªò Î≥µÏÇ¨ Í∞ÄÎä•)
    </div>
<div class="share-canvas-wrap">
<canvas aria-label="Í≥µÏú† Ïπ¥Îìú Ï∫îÎ≤ÑÏä§" class="share-canvas" height="1080" id="shareCardCanvas" width="1080"></canvas>
</div>
<div class="history-toolbar" style="margin-top:12px;">
<button class="btn secondary" onclick="copyShareLink()" type="button">ÎßÅÌÅ¨ Î≥µÏÇ¨</button>
<button class="btn gold" onclick="downloadShareCard()" type="button">Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•</button>
<button class="btn secondary" onclick="copyShareText()" type="button">Î¨∏Íµ¨ Î≥µÏÇ¨</button>
</div>
</div>
</div>
<!-- Ïò§Îäò ÏàòÏßë Î¨∂Ïùå Í≥µÏú† Î™®Îã¨ (Ïó∞ÏÜç Ï†ÄÏû•/ÌÅ¥Î¶≠ Ï†ÄÏû• Í≤∞Í≥º Î¨∂Ïùå) -->
<div class="modal" id="bundleShareModal" style="display:none;">
<div class="modal-box share">
<div class="modal-head">
<div class="t" id="bundleTitle">Ïò§Îäò ÏàòÏßë Î¨∂Ïùå</div>
<div class="modal-close" onclick="closeBundleShare()">Îã´Í∏∞</div>
</div>
<div class="small-hint" style="margin-bottom:10px;">
      Ïó∞ÏÜç Ï†ÄÏû•(ÎòêÎäî ÌÅ¥Î¶≠=Ïó∞ÏÜç Ï†ÄÏû•)ÏúºÎ°ú Î™®ÏùÄ Ìï≠Î™©ÏùÑ <b>Ìïú Î≤àÏóê Í≥µÏú†</b>Ìï©ÎãàÎã§. (Í∞Å Ìï≠Î™© ÎßÅÌÅ¨Îäî Ïó¥Î©¥ ÎèôÏùº Í≤∞Í≥ºÎ°ú Î≥µÏõêÎê©ÎãàÎã§)
    </div>
<div class="bundle-meta" id="bundleMeta"></div>
<div class="share-canvas-wrap">
<canvas aria-label="Ïò§Îäò ÏàòÏßë Î¨∂Ïùå Í≥µÏú† Ïπ¥Îìú" class="share-canvas" height="1080" id="bundleCanvas" width="1080"></canvas>
</div>
<textarea class="bundle-ta" id="bundleText" readonly=""></textarea>
<div class="bundle-promo">
<div class="bundle-promo-head">
<div class="bundle-promo-title">ÌôçÎ≥¥Í∏Ä ÏûêÎèô ÏÉùÏÑ±</div>
<div class="bundle-promo-ctrl">
<select aria-label="ÌôçÎ≥¥ Ï±ÑÎÑê ÏÑ†ÌÉù" class="inp mini" id="bundlePromoChannel"></select>
<label class="bundle-switch" title="Ï±ÑÎÑêÎ≥Ñ Í≤åÏãúÌåê Í∑úÏπô(ÎßÅÌÅ¨/ÌÜ§/ÌòïÏãù)Ïóê ÎßûÏ∂ò ÌîÑÎ¶¨ÏÖãÏùÑ ÏûêÎèô Ï†ÅÏö©Ìï©ÎãàÎã§. ÌïÑÏöîÌïòÎ©¥ Í∫ºÏÑú ÏßÅÏ†ë Ï°∞Ï†àÌïòÏÑ∏Ïöî.">
<input checked="" id="bundlePromoPreset" type="checkbox"/>
<span>ÌîÑÎ¶¨ÏÖã ÏûêÎèô</span>
</label>
<span class="bundle-pill" id="bundlePresetHint" style="display:none;"></span>
<select aria-label="ÌôçÎ≥¥ ÌÜ§ ÏÑ†ÌÉù" class="inp mini" id="bundlePromoStyle">
<option value="promo">ÌôçÎ≥¥Ìòï</option>
<option value="info">Ï†ïÎ≥¥Ìòï</option>
<option value="tg">ÌÖîÎ†àÍ∑∏Îû®Ìòï</option>
</select>
<select aria-label="ÎßÅÌÅ¨ Î≤îÏúÑ ÏÑ†ÌÉù" class="inp mini" id="bundlePromoLinks">
<option value="top3">ÎßÅÌÅ¨ TOP3(Í∂åÏû•)</option>
<option value="top5">ÎßÅÌÅ¨ TOP5</option>
<option value="all">ÎßÅÌÅ¨ Ï†ÑÏ≤¥</option>
<option value="one">ÎßÅÌÅ¨ 1Í∞úÎßå</option>
<option value="none">ÎßÅÌÅ¨ 0Í∞ú</option>
</select>
<select aria-label="ÎßÅÌÅ¨ 1Í∞ú ÎåÄÏÉÅ" class="inp mini" id="bundlePromoOneTarget" style="display:none;">
<option value="analysis">Î∂ÑÏÑùÍ∏∞ ÎßÅÌÅ¨</option>
<option value="vendor">ÏóÖÏ≤¥ Ïπ¥Îìú ÎßÅÌÅ¨</option>
</select>
<label class="bundle-switch" title="UTMÏùÑ Ï†úÍ±∞ÌïòÍ≥† https://Î•º ÏÉùÎûµÌï¥ URLÏùÑ ÏßßÍ≤å ÌëúÏãúÌï©ÎãàÎã§. (Ï∂îÏ†Å Ï†ïÌôïÎèÑÎäî ÎÇÆÏïÑÏßà Ïàò ÏûàÏñ¥Ïöî)">
<input id="bundlePromoShortUrl" type="checkbox"/>
<span>URL Ï§ÑÏù¥Í∏∞</span>
</label>
<label class="bundle-switch" title="Ï§ÑÎ∞îÍøàÏùÑ ÏµúÏÜåÌôîÌï¥ Í≤åÏãúÌåê Í∑úÏπô/ÌïÑÌÑ∞Ïóê Îçî Ïûò ÎßûÍ≤å ÎßåÎì≠ÎãàÎã§.">
<input id="bundlePromoCompact" type="checkbox"/>
<span>Ï§ÑÎ∞îÍøà ÏµúÏÜå</span>
</label>
<label class="bundle-switch" title="ÎßÅÌÅ¨Î•º Î™ª Ïò¨Î¶¨Îäî Í≤åÏãúÌåê(ÎßÅÌÅ¨ 0Í∞ú)ÏóêÏÑú ÎåìÍ∏ÄÎ°ú ÏöîÏ≤≠ÏùÑ Ïú†ÎèÑÌïòÎäî Î≤ÑÏ†Ñ Î¨∏Íµ¨Î•º Ï∂îÍ∞ÄÌï©ÎãàÎã§.">
<input id="bundlePromoComment" type="checkbox"/>
<span>ÎåìÍ∏Ä Ïú†ÎèÑ</span>
</label>
<label class="bundle-switch" title="ÎßàÏßÑ ÎÇÆÏùå ÎòêÎäî +EV Ï°∞Í±¥ÏùÑ ÎßåÏ°±Ìï† ÎïåÎßå ÏóÖÏ≤¥ Ìã∞Ï†Ä 1Í∞úÎ•º Ìè¨Ìï®Ìï©ÎãàÎã§.">
<input checked="" id="bundlePromoVendor" type="checkbox"/>
<span>ÏóÖÏ≤¥ 1Í∞ú(Ï°∞Í±¥Î∂Ä)</span>
</label>
<button class="btn ghost mini" id="btnPromoAdv" onclick="toggleBundlePromoAdv()" title="ÏóÖÏ≤¥ Ìã∞Ï†Ä Ìè¨Ìï® Ï°∞Í±¥(ÎßàÏßÑ/EV ÏûÑÍ≥ÑÍ∞í)Í≥º ÌîÑÎ¶¨ÏÖã ÏÉÅÌÉúÎ•º ÏÑ∏Î∂Ä Ï°∞Ï†àÌï©ÎãàÎã§." type="button">Í≥†Í∏â</button>
<button class="btn ghost mini" onclick="regenBundlePromo()" title="Î¨∏Íµ¨ Î≥ÄÌòï(3Ï¢Ö) Ï§ë Îã§Ïùå ÌÖúÌîåÎ¶øÏúºÎ°ú Î∞îÍøâÎãàÎã§" type="button">ÏÉà Î¨∏Íµ¨</button>
</div>
</div>
<div class="bundle-promo-adv" id="bundlePromoAdv" style="display:none;">
<div class="bundle-adv-row">
<div class="bundle-adv-label">ÏóÖÏ≤¥ Ìã∞Ï†Ä Ìè¨Ìï® Ï°∞Í±¥</div>
<div class="bundle-adv-controls">
<label class="bundle-range" title="ÏµúÏ†Ä ÎßàÏßÑÏù¥ Ïù¥ Í∞í Ïù¥ÌïòÏù¥Î©¥ ÏóÖÏ≤¥ Ìã∞Ï†ÄÎ•º Ìè¨Ìï®Ìï† Ïàò ÏûàÏäµÎãàÎã§.">
          ÎßàÏßÑ ‚â§ <span id="bundleVendorMarginVal">3.2</span>%
          <input id="bundleVendorMargin" max="6.0" min="2.0" step="0.1" type="range" value="3.2"/>
</label>
<label class="bundle-range" title="+EV(0Î≥¥Îã§ ÌÅ∞ EV)Ïù¥ ÏµúÏÜå Î™á Í∞ú Ïù¥ÏÉÅÏùº Îïå ÏóÖÏ≤¥ Ìã∞Ï†ÄÎ•º Ìè¨Ìï®Ìï†ÏßÄ ÏÑ§Ï†ïÌï©ÎãàÎã§.">
          +EV ‚â• <span id="bundleVendorEvVal">1</span>Í∞ú
          <input id="bundleVendorEv" max="5" min="0" step="1" type="range" value="1"/>
</label>
</div>
</div>
<div class="small-hint" style="margin-top:8px;">
      ÏûÑÍ≥ÑÍ∞íÏùÑ Ïò¨Î¶¨Î©¥ ÏóÖÏ≤¥ Ìã∞Ï†ÄÍ∞Ä Îçî ÏûêÏ£º Ìè¨Ìï®Îê† Ïàò ÏûàÏñ¥Ïöî. (Í≤åÏãúÌåê Í∑úÏπôÏù¥ ÏóÑÍ≤©Ìïú Ï±ÑÎÑêÏùÄ ÌîÑÎ¶¨ÏÖãÏù¥ ÎßÅÌÅ¨/ÌÜ§ÏùÑ ÏûêÎèôÏúºÎ°ú Ï†úÌïúÌï©ÎãàÎã§)
    </div>
</div>
<div class="small-hint" style="margin-top:8px;">
    Ï±ÑÎÑê/ÌÜ§/ÏòµÏÖòÏùÑ Î∞îÍæ∏Î©¥ ÌôçÎ≥¥ Î¨∏Íµ¨Í∞Ä ÏûêÎèô ÏÉùÏÑ±Îê©ÎãàÎã§. (Í≤åÏãúÌåê Í∑úÏπôÏóê ÎßûÏ∂∞ ÎßÅÌÅ¨ 0~Ï†ÑÏ≤¥/URL ÏßßÍ≤å/Ï§ÑÎ∞îÍøà ÏµúÏÜåÎ•º ÏÑ†ÌÉù Í∞ÄÎä•)
  </div>
<textarea class="bundle-ta bundle-ta--promo" id="bundlePromoText" readonly=""></textarea>
<div class="history-toolbar" style="margin-top:10px;">
<button class="btn secondary" onclick="copyBundlePromo()" type="button">ÌôçÎ≥¥Í∏Ä Î≥µÏÇ¨</button>
<button class="btn ghost" onclick="copyBundlePromoTitle()" type="button">Ï†úÎ™© Î≥µÏÇ¨</button>
<button class="btn ghost" onclick="copyBundlePromoLead()" type="button">ÎßêÎ®∏Î¶¨ Î≥µÏÇ¨</button>
</div>
</div>
<div class="history-toolbar" style="margin-top:12px;">
<button class="btn secondary" onclick="copyBundleText()" type="button">Î¨∏Íµ¨ Î≥µÏÇ¨</button>
<button class="btn secondary" onclick="copyBundleLinks()" type="button">ÎßÅÌÅ¨Îßå Î≥µÏÇ¨</button>
<button class="btn ghost" onclick="copyBundleTop3()" type="button">TOP3 ÏöîÏïΩ Î≥µÏÇ¨</button>
<button class="btn gold" onclick="downloadBundleCard()" type="button">Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•</button>
<button class="btn danger" onclick="resetBundleToday()" type="button">Ïò§Îäò Î¨∂Ïùå Ï¥àÍ∏∞Ìôî</button>
</div>
</div>
</div>
<!-- Î™®Î∞îÏùº ÌïòÎã® ÎèÑÌÅ¨ -->
<div aria-label="Îπ†Î•∏ ÎèôÏûë" class="mobile-dock" id="mobileDock">
<button class="dock-btn primary" onclick="calc()" type="button">Í≥ÑÏÇ∞</button>
<button class="dock-btn" onclick="quickJump('history')" type="button">Ï†ÄÏû•</button>
<button class="dock-btn" onclick="openShareCard()" type="button">Í≥µÏú†</button>
<a class="dock-btn" data-cta="analysis_dock_vendors" data-no-auto-outbound="1" href="/cert/">ÏóÖÏ≤¥</a>
</div>
<div id="toast88"></div>
<!-- v2.1: HTML Íµ¨Ï°∞ÍπåÏßÄ Ïª¥Ìè¨ÎÑåÌä∏Ìôî(ÌÖúÌîåÎ¶ø) -->
<template id="tplResultCard">
<section aria-label="Î∂ÑÏÑù Í≤∞Í≥º" class="st-result" data-role="result">
<div aria-label="Í≤∞Í≥º ÌÉ≠" class="st-r-tabs" role="tablist">
<button aria-selected="true" class="st-r-tab on" data-r-tab="summary" role="tab" type="button">ÏöîÏïΩ</button>
<button aria-selected="false" class="st-r-tab" data-r-tab="detail" role="tab" type="button">ÏÉÅÏÑ∏</button>
<div aria-live="polite" class="st-r-meta" id="resultMeta"></div>
</div>
<div class="st-r-panel" data-r-panel="summary"></div>
<div class="st-r-panel" data-r-panel="detail" hidden=""></div>
</section>
</template>
<template id="tplHistoryEmpty">
<div class="demo-empty" data-role="history-empty">
<div class="demo-title" data-slot="title"></div>
<div class="demo-desc" data-slot="desc"></div>
<div class="demo-btns">
<button class="btn primary2" data-demo="soccer" type="button">‚öΩ Ï∂ïÍµ¨ ÏòàÏãúÎ°ú Í≥ÑÏÇ∞</button>
<button class="btn primary2" data-demo="basketball" type="button">üèÄ ÎÜçÍµ¨ ÏòàÏãúÎ°ú Í≥ÑÏÇ∞</button>
</div>
<div class="demo-note">‚Äª ÏòàÏãúÎäî ÏÉòÌîå Îç∞Ïù¥ÌÑ∞Ïù¥Î©∞, Ïã§Ï†ú Í≤∞Í≥º/ÏäπÎ•†ÏùÑ Î≥¥Ïû•ÌïòÏßÄ ÏïäÏäµÎãàÎã§.</div>
</div>
</template>
<template id="tplHistoryItem">
<article class="h-item" data-role="history-item" role="button" tabindex="0">
<div class="h-top">
<div class="h-left">
<div class="h-title" data-slot="title"></div>
<div class="h-sub" data-slot="sub"></div>
<div class="h-outcome" data-role="outcome">
<div class="row">
<div class="label">Í≤∞Í≥º Í∏∞Î°ù</div>
<span class="outTag" data-slot="outTag">ÎØ∏Í∏∞Î°ù</span>
</div>
<div class="outBtns">
<button class="oBtn" data-h-action="outcome" data-outcome="W" type="button">‚úÖ Ï†ÅÏ§ë</button>
<button class="oBtn" data-h-action="outcome" data-outcome="L" type="button">‚ùå ÎØ∏Ï†ÅÏ§ë</button>
<button class="oBtn" data-h-action="outcome" data-outcome="V" type="button">‚ö™ Ï∑®ÏÜå</button>
<button class="oBtn" data-h-action="outcome" data-outcome="" type="button">‚Ü©Ô∏é ÎØ∏Í∏∞Î°ù</button>
</div>
</div>
</div>
<div class="h-actions" data-role="actions">
<button class="primary2" data-h-action="restoreCalc" type="button">Î≥µÏõê+Ïû¨Í≥ÑÏÇ∞</button>
<button data-h-action="restoreOnly" type="button">Î≥µÏõêÎßå</button>
<label class="pick">
<input data-h-action="pick" type="checkbox"/>
          ÎπÑÍµê
        </label>
</div>
</div>
</article>
</template>
<script>
/* ÏÇ¨Ïπ≠Ï£ºÏùò (1Ïùº 1Ìöå) */
(function(){
  const key="scam_popup_date";
  const today=new Date().toISOString().slice(0,10);
  if(localStorage.getItem(key)!==today){
    const pop=document.getElementById("scamPopup");
    if(pop) pop.style.display="flex";
  }
})();
function closeScam(){
  const today=new Date().toISOString().slice(0,10);
  localStorage.setItem("scam_popup_date",today);
  const pop=document.getElementById("scamPopup");
  if(pop) pop.style.display="none";
}

/* Ïä§ÌÅ¨Î°§ */
function scrollToCalc(){
  document.getElementById("calcCard")?.scrollIntoView({behavior:"smooth", block:"start"});
}

/* =========================
   Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
========================= */
const CHECKLIST_POOL = [
  "ÎùºÏù∏ Í∏âÎ≥Ä Í≤ΩÍ∏∞(Í∞ëÏûêÍ∏∞ ÎÇ¥Î†§Í∞Ñ Î∞∞Îãπ)Îäî Ïù¥Ïú†Î∂ÄÌÑ∞ ÌôïÏù∏ÌïòÍ∏∞",
  "ÎßàÏßÑ(ÏàòÏàòÎ£å) ÎÜíÏùÄ Í≤ΩÍ∏∞Î©¥ Ìïú Îã®Í≥Ñ Î≥¥ÏàòÏ†ÅÏúºÎ°ú Ï†ëÍ∑ºÌïòÍ∏∞",
  "1Ìöå Î∞∞ÌåÖÍ∏àÏùÄ ÏûêÎ≥∏Ïùò 1~3% Î≤îÏúÑÎ°ú Ï†úÌïúÌïòÍ∏∞",
  "ÏÑ†Î∞ú/Í≤∞Ïû•/Î°úÌÖå Îâ¥Ïä§ Ï≤¥ÌÅ¨ ÌõÑ Î∞∞Îãπ Î≥ÄÎèô Ïû¨ÌôïÏù∏ÌïòÍ∏∞",
  "Ïó∞Ìå®/Ïó∞Ïäπ ÌåÄÏùÄ 'ÏãúÏû• Í≥ºÏó¥' Íµ¨Í∞ÑÏù∏ÏßÄ Î®ºÏ†Ä Î≥¥Í∏∞",
  "Î≥ÄÎèôÏÑ± ÌÅ∞ Î¶¨Í∑∏Îäî Îã®Ìè¥/ÏÜåÏï°ÏúºÎ°ú ÌÖåÏä§Ìä∏ÌïòÍ∏∞",
  "ÏïÑÏãúÏïà ÎùºÏù∏(Ìë∏Ïãú) Í∞ÄÎä• Íµ¨Í∞ÑÏùÄ 'Î¨¥Ìö® Î¶¨Ïä§ÌÅ¨'ÎèÑ Í∞ôÏù¥ Í≥†Î†§ÌïòÍ∏∞"
];
function refreshChecklist(){
  const pool = [...CHECKLIST_POOL].sort(()=>Math.random()-0.5);
  const pick = pool.slice(0,3);
  const el = document.getElementById("checklistText");
  if(el) el.innerHTML = "‚Ä¢ " + pick.join("<br>‚Ä¢ ");
}
refreshChecklist();

/* =========================
   ÏÉÅÌÉú/Ï†ÄÏû•(Í∏∞Ï°¥ Ïú†ÏßÄ + ÌôïÏû•)
========================= */
const LS_KEY = "88_analysis_multi_v3";            // ÏûÖÎ†• ÏÉÅÌÉú
const HIST_KEY = "88_analysis_history_v1";        // ÌûàÏä§ÌÜ†Î¶¨
const SNAP_KEY = "88_analysis_snaps_v1";          // ÏµúÍ∑º ÏûÖÎ†• Ïä§ÎÉÖÏÉ∑
const SNAP_META_KEY = "88_analysis_snaps_meta_v1";
let LAST_TEXT = "";
let LAST_ONE_LINE = "";      // Í≥µÏú†Ïö© Ìïú Ï§Ñ ÏöîÏïΩ
let LAST_RECORD = null;

let MAIN_MODE_OVERRIDE = null; // "2way" | "3way" | null

// Î©ÄÌã∞ Î∂ôÏó¨ÎÑ£Í∏∞: Ïó∞ÏÜç Ï†ÄÏû•(ÌûàÏä§ÌÜ†Î¶¨ ÏûêÎèô ÎàÑÏ†Å)Ïö© ÏÉÅÌÉú
let __PASTE_MULTI = [];
let __PASTE_SORT = "input"; // "margin" | "input"
let __PASTE_CHAIN_RUNNING = false;
let __PASTE_CHAIN_ABORT = false;
let __PASTE_SAVED_SIGS = new Set();

// ===== Ïò§Îäò ÏàòÏßë(Ïó∞ÏÜç Ï†ÄÏû•) Î¨∂Ïùå Ï†ÄÏû•ÏÜå (ÏÑúÎ≤Ñ ÏóÜÏù¥, localStorage) =====
const CHAIN_PACK_PREFIX = "88_chain_pack_"; // date(YYYY-MM-DD)Î≥Ñ
function chainPackKey(dateStr){ return CHAIN_PACK_PREFIX + (dateStr || todayStr()); }
function readChainPack(dateStr){
  try{
    const raw = localStorage.getItem(chainPackKey(dateStr));
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}
function writeChainPack(dateStr, arr){
  try{ localStorage.setItem(chainPackKey(dateStr), JSON.stringify((arr||[]).slice(0,80))); }catch(e){}
}
function pushChainPackFromRecord(record){
  if(!record) return;
  const dateStr = record.date || todayStr();
  const items = readChainPack(dateStr);
  let link = "";
  try{ link = getShareLink(); }catch(e){ link = location.origin + location.pathname; }
  const oneLine = String(LAST_ONE_LINE||"").replace(/^ÏöîÏïΩ\s*:\s*/," ").trim();
  const item = {
    ts: Date.now(),
    id: record.id || null,
    sig: record.sig || null,
    date: dateStr,
    time: record.time || null,
    sport: record.sport || null,
    league: record.league || "",
    teams: record.teams || "",
    mainMode: record.mainMode || null,
    mainMarginPct: (record.markets && record.markets.main && typeof record.markets.main.marginPct==="number") ? record.markets.main.marginPct : null,
    bestEVPct: (typeof record.bestEVPct==="number") ? record.bestEVPct : null,
    oneLine,
    link
  };
  const next = [item, ...items.filter(x=> (x && (x.sig && item.sig) ? x.sig!==item.sig : x.link!==item.link))];
  writeChainPack(dateStr, next);
  try{ updateBundleButton(); }catch(e){}
}
function getChainPackCountToday(){
  try{ return readChainPack(todayStr()).length; }catch(e){ return 0; }
}
function updateBundleButton(){
  const btn = document.getElementById("btnBundleShare");
  if(!btn) return;
  const n = getChainPackCountToday();
  btn.textContent = n>0 ? `Ïò§Îäò ÏàòÏßë Î¨∂Ïùå (${Math.min(80,n)})` : "Ïò§Îäò ÏàòÏßë Î¨∂Ïùå";
}

const SPORT_CFG = {
  soccer: {
    name: "Ï∂ïÍµ¨",
    main: "3way",
    labels: {H:"Ìôà", D:"Î¨¥", A:"ÏõêÏ†ï"},
    hint: "Ï∂ïÍµ¨Îäî Í∏∞Î≥∏ 3Î∞∞Îãπ(Ìôà/Î¨¥/ÏõêÏ†ï). Ï§ëÍ∏â/Í≥†Í∏âÏóêÏÑú Ïò§Î≤ÑÏñ∏ÎçîÎ•º Í∞ôÏù¥ Î≥¥Îäî Í±∏ Ï∂îÏ≤úÌï©ÎãàÎã§.",
    template: { openHandicap:false, openTotal:true },
    defaults: { ouPush: 6, hcPush: 2 }
  },
  basketball: {
    name:"ÎÜçÍµ¨",
    main:"2way",
    labels:{A:"Ïäπ", B:"Ìå®"},
    hint:"ÎÜçÍµ¨Îäî 2Î∞∞Îãπ(Ïäπ/Ìå®) Ï§ëÏã¨. Ï§ëÍ∏â/Í≥†Í∏âÏóêÏÑúÎäî Ìï∏Îîî+Ïò§Î≤ÑÏñ∏ÎçîÎ•º Ìï®Íªò Ï∂îÏ≤ú.",
    template: { openHandicap:true, openTotal:true },
    defaults: { ouPush: 3, hcPush: 3 }
  },
  baseball: {
    name:"ÏïºÍµ¨",
    main:"2way",
    labels:{A:"Ïäπ", B:"Ìå®"},
    hint:"ÏïºÍµ¨Îäî Ïäπ/Ìå®(2Î∞∞Îãπ) + Ïò§Î≤ÑÏñ∏Îçî/Ìï∏Îîî(Îü∞ÎùºÏù∏)Î•º Ìï®Íªò Î≥¥Îäî Í≤ΩÏö∞Í∞Ä ÎßéÏäµÎãàÎã§.",
    template: { openHandicap:true, openTotal:true },
    defaults: { ouPush: 4, hcPush: 2 }
  },
  volleyball: {
    name:"Î∞∞Íµ¨",
    main:"2way",
    labels:{A:"Ïäπ", B:"Ìå®"},
    hint:"Î∞∞Íµ¨Îäî 2Î∞∞Îãπ(Ïäπ/Ìå®) Ï§ëÏã¨. Ï§ëÍ∏â/Í≥†Í∏âÏóêÏÑú Ìï∏Îîî/OUÎ•º Ìï®Íªò ÌôïÏù∏ÌïòÏÑ∏Ïöî.",
    template: { openHandicap:true, openTotal:true },
    defaults: { ouPush: 1, hcPush: 1 }
  },
  esports: {
    name:"eÏä§Ìè¨Ï∏†",
    main:"2way",
    labels:{A:"Ïäπ", B:"Ìå®"},
    hint:"eÏä§Ìè¨Ï∏†Îäî Îß§Ïπò Ïäπ/Ìå®(2Î∞∞Îãπ) Ï§ëÏã¨. Í≥†Í∏âÏóêÏÑú EV/ÎπÑÏ§ë Í≥ÑÏÇ∞Ïù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.",
    template: { openHandicap:false, openTotal:false },
    defaults: { ouPush: 0, hcPush: 0 }
  },
  hockey: {
    name:"ÌïòÌÇ§",
    main:"2way",
    labels:{A:"Ïäπ", B:"Ìå®"},
    hint:"ÌïòÌÇ§Îäî 2Î∞∞Îãπ(Ïäπ/Ìå®) Í∏∞Î≥∏. Ï§ëÍ∏â/Í≥†Í∏âÏóêÏÑú Ïò§Î≤ÑÏñ∏ÎçîÍ∞Ä ÎèÑÏõÄÏù¥ Îê©ÎãàÎã§.",
    template: { openHandicap:false, openTotal:true },
    defaults: { ouPush: 4, hcPush: 2 }
  }
};

/* ‚úÖ Ï¢ÖÎ™©/Ïú†ÌòïÎ≥Ñ ‚ÄúÎßàÏßÑ ÎÇÆÏùå‚Äù ÌåêÏ†ï Í∏∞Ï§Ä (ÎßàÏßÑ% Í∏∞Ï§Ä) */

function labels2Way(cfg){
  // 2Î∞∞Îãπ ÎùºÎ≤®: cfg.labels.A/BÍ∞Ä ÏóÜÏúºÎ©¥(Ï∂ïÍµ¨ Îì±) H/AÎ•º A/BÎ°ú Îß§Ìïë
  const A = (cfg && cfg.labels && cfg.labels.A) ? cfg.labels.A : ((cfg && cfg.labels && cfg.labels.H) ? cfg.labels.H : "A");
  const B = (cfg && cfg.labels && cfg.labels.B) ? cfg.labels.B : ((cfg && cfg.labels && cfg.labels.A) ? cfg.labels.A : "B");
  return {A, B};
}
function effectiveMainMode(cfg){
  if(MAIN_MODE_OVERRIDE==="2way") return "2way";
  if(MAIN_MODE_OVERRIDE==="3way") return "3way";
  return (cfg && cfg.main==="3way") ? "3way" : "2way";
}
function setMainModeOverride(mode){
  // mode: "2way" | "3way" | null
  MAIN_MODE_OVERRIDE = mode || null;
  try{ onSportChange(true); }catch(e){}
  try{ saveState(); }catch(e){}
}

const MARGIN_RULE = {
  soccer:     { main:[6, 8, 10], ou:[5.5, 7.5, 9.5], hc:[5.5, 7.5, 9.5] },
  basketball: { main:[4, 6, 8],  ou:[4.5, 6.5, 8.5], hc:[4.5, 6.5, 8.5] },
  baseball:   { main:[4.5, 6.5, 8.5], ou:[4.5, 6.5, 8.5], hc:[4.5, 6.5, 8.5] },
  volleyball: { main:[4, 6, 8],  ou:[4, 6, 8],  hc:[4, 6, 8] },
  esports:    { main:[4, 6, 8],  ou:[4, 6, 8],  hc:[4, 6, 8] },
  hockey:     { main:[4.5, 6.5, 8.5], ou:[4.5, 6.5, 8.5], hc:[4.5, 6.5, 8.5] }
};

function $(id){ return document.getElementById(id); }
function val(id){ const el=$(id); return el?el.value:""; }
function setVal(id,v){ const el=$(id); if(el && v!=null) el.value=v; }
function todayStr(){ return new Date().toISOString().slice(0,10); }
function nowTimeStr(){
  const d=new Date();
  const hh=String(d.getHours()).padStart(2,"0");
  const mm=String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}

function saveState(){
  const state = {
    sport: val("sport"),
    level: val("level"),
    mainModeOverride: MAIN_MODE_OVERRIDE,
    league: val("league"),
    teams: val("teams"),
    main2OddsA: val("main2OddsA"),
    main2OddsB: val("main2OddsB"),
    main3OddsH: val("main3OddsH"),
    main3OddsD: val("main3OddsD"),
    main3OddsA: val("main3OddsA"),
    myProb: val("myProb"),
    stake: val("stake"),
    handicapLine: val("handicapLine"),
    handicapOddsA: val("handicapOddsA"),
    handicapOddsB: val("handicapOddsB"),
    handicapPush: val("handicapPush"),
    totalLine: val("totalLine"),
    overOdds: val("overOdds"),
    underOdds: val("underOdds"),
    ouPush: val("ouPush"),
    myOverProb: val("myOverProb"),
    handicapCollapsed: isCollapsed("handicapBody"),
    totalCollapsed: isCollapsed("totalBody")
  };
  state.__savedAt = Date.now();
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  updateSaveBadge(state.__savedAt);
  maybePushSnapshot(state, false);
  return state;
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const s = JSON.parse(raw);

    if(s.sport) setVal("sport", s.sport);
    if(s.level) setVal("level", s.level);
    if(typeof s.mainModeOverride !== "undefined") MAIN_MODE_OVERRIDE = s.mainModeOverride || null;

    onSportChange(true);
    onLevelChange(true);
  syncToggleLabels();

    setVal("league", s.league);
    setVal("teams", s.teams);
    setVal("main2OddsA", s.main2OddsA);
    setVal("main2OddsB", s.main2OddsB);
    setVal("main3OddsH", s.main3OddsH);
    setVal("main3OddsD", s.main3OddsD);
    setVal("main3OddsA", s.main3OddsA);
    setVal("myProb", s.myProb);
    setVal("stake", s.stake);
    setVal("handicapLine", s.handicapLine);
    setVal("handicapOddsA", s.handicapOddsA);
    setVal("handicapOddsB", s.handicapOddsB);
    setVal("handicapPush", s.handicapPush);
    setVal("totalLine", s.totalLine);
    setVal("overOdds", s.overOdds);
    setVal("underOdds", s.underOdds);
    setVal("ouPush", s.ouPush);
    setVal("myOverProb", s.myOverProb);

    if(typeof s.handicapCollapsed === "boolean") setCollapsed("handicapBody", s.handicapCollapsed);
    if(typeof s.totalCollapsed === "boolean") setCollapsed("totalBody", s.totalCollapsed);
  }catch(e){}
}

/* =========================
   ÌçºÎ®∏ÎßÅÌÅ¨(Í≥µÏú† ÎßÅÌÅ¨) ÏÉÅÌÉú Î≥µÏõê
   - st=base64url(JSON)
========================= */
function b64urlEncode(str){
  try{
    return btoa(unescape(encodeURIComponent(str)))
      .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }catch(e){ return ""; }
}
function b64urlDecode(str){
  try{
    let s = String(str||"").replace(/-/g,'+').replace(/_/g,'/');
    while(s.length % 4) s += "=";
    return decodeURIComponent(escape(atob(s)));
  }catch(e){ return ""; }
}

function buildPermalinkState(){
  try{
    // saveState()Í∞Ä Ïä§ÎÉÖÏÉ∑/Î∞∞ÏßÄÍπåÏßÄ ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎØÄÎ°ú Í≥µÏú† ÏßÅÏ†ÑÏóî Ìï≠ÏÉÅ Ìò∏Ï∂ú
    const st = saveState();
    const payload = {
      v:1,
      sport: st.sport,
      level: st.level,
      league: st.league,
      teams: st.teams,
      fields: {
        main2OddsA: st.main2OddsA, main2OddsB: st.main2OddsB,
        main3OddsH: st.main3OddsH, main3OddsD: st.main3OddsD, main3OddsA: st.main3OddsA,
        myProb: st.myProb, stake: st.stake,
        handicapLine: st.handicapLine, handicapOddsA: st.handicapOddsA, handicapOddsB: st.handicapOddsB, handicapPush: st.handicapPush,
        totalLine: st.totalLine, overOdds: st.overOdds, underOdds: st.underOdds, ouPush: st.ouPush,
        myOverProb: st.myOverProb
      }
    };
    const json = JSON.stringify(payload);
    return b64urlEncode(json);
  }catch(e){ return ""; }
}

function restoreFromPermalink(){
  try{
    const u = new URL(location.href);
    const st = u.searchParams.get("st");
    if(!st) return false;
    const json = b64urlDecode(st);
    if(!json) return false;
    const data = JSON.parse(json);
    if(!data || !data.fields) return false;

    // Ïö∞ÏÑ†ÏàúÏúÑ: Í≥µÏú† ÎßÅÌÅ¨(st) > localStorage
    if(data.sport) setVal("sport", data.sport);
    if(data.level) setVal("level", data.level);
    onSportChange(true);
    onLevelChange(true);
    setVal("league", data.league || "");
    setVal("teams", data.teams || "");

    const f = data.fields || {};
    [
      "main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA",
      "myProb","stake",
      "handicapLine","handicapOddsA","handicapOddsB","handicapPush",
      "totalLine","overOdds","underOdds","ouPush","myOverProb"
    ].forEach(k=> setVal(k, f[k]));

    saveState();
    try{ track("permalink_open", { has_state: true }); }catch(e){}

    // ÎßÅÌÅ¨Î•º Ïó¥Î©¥ Î∞îÎ°ú Í≤∞Í≥ºÎ•º Î≥¥Ïó¨Ï§òÏïº Ìï®
    const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
    const is3 = (effectiveMainMode(cfg) === "3way");
    const ok = is3
      ? (parseOdds(val("main3OddsH"))!=null && parseOdds(val("main3OddsD"))!=null && parseOdds(val("main3OddsA"))!=null)
      : (parseOdds(val("main2OddsA"))!=null && parseOdds(val("main2OddsB"))!=null);
    if(ok){
      setTimeout(()=>{ try{ calc(); }catch(e){} }, 50);
    }
    return true;
  }catch(e){ return false; }
}

/* ÏûÖÎ†• Ïù¥Î≤§Ìä∏ ÏûêÎèô Ï†ÄÏû• */
[
  "sport","level","league","teams",
  "main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA",
  "myProb","stake",
  "handicapLine","handicapOddsA","handicapOddsB","handicapPush",
  "totalLine","overOdds","underOdds","ouPush","myOverProb"
].forEach(id=>{
  const el=$(id);
  if(el) el.addEventListener("input", saveState);
});

/* =========================
   UI: ÌÖúÌîåÎ¶ø + ÎÇúÏù¥ÎèÑ
========================= */

/* =========================
   ÎùºÏù∏ ÎπÑÍµê (A vs B)
========================= */
function updateLineCompareUI(cfg){
  cfg = cfg || (SPORT_CFG[val("sport")] || SPORT_CFG.soccer);
  const is3 = (effectiveMainMode(cfg) === "3way");
  const a2 = document.getElementById("lcA2");
  const b2 = document.getElementById("lcB2");
  const a3 = document.getElementById("lcA3");
  const b3 = document.getElementById("lcB3");
  if(a2) a2.style.display = is3 ? "none" : "block";
  if(b2) b2.style.display = is3 ? "none" : "block";
  if(a3) a3.style.display = is3 ? "block" : "none";
  if(b3) b3.style.display = is3 ? "block" : "none";

  if(!is3){
    const la = cfg.labels.A||"A", lb = cfg.labels.B||"B";
    const ids = [
      ["lcA2LabelA", `${la} Î∞∞Îãπ`], ["lcA2LabelB", `${lb} Î∞∞Îãπ`],
      ["lcB2LabelA", `${la} Î∞∞Îãπ`], ["lcB2LabelB", `${lb} Î∞∞Îãπ`]
    ];
    ids.forEach(([id,txt])=>{ const el=document.getElementById(id); if(el) el.innerText = txt; });
  }else{
    const lh = cfg.labels.H||"Ìôà", ld = cfg.labels.D||"Î¨¥", la = cfg.labels.A||"ÏõêÏ†ï";
    const ids = [
      ["lcA3LabelH", `${lh} Î∞∞Îãπ`], ["lcA3LabelD", `${ld} Î∞∞Îãπ`], ["lcA3LabelA", `${la} Î∞∞Îãπ`],
      ["lcB3LabelH", `${lh} Î∞∞Îãπ`], ["lcB3LabelD", `${ld} Î∞∞Îãπ`], ["lcB3LabelA", `${la} Î∞∞Îãπ`]
    ];
    ids.forEach(([id,txt])=>{ const el=document.getElementById(id); if(el) el.innerText = txt; });
  }
}

function getLineCompareSet(which){
  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
  const is3 = (effectiveMainMode(cfg) === "3way");
  if(!is3){
    const o1 = parseOdds(val(which==="A" ? "lcA2OddsA" : "lcB2OddsA"));
    const o2 = parseOdds(val(which==="A" ? "lcA2OddsB" : "lcB2OddsB"));
    if(o1==null || o2==null) return null;
    const out = compute2Way(o1,o2,0);
    return { is3:false, odds:[o1,o2], out };
  }
  const h = parseOdds(val(which==="A" ? "lcA3OddsH" : "lcB3OddsH"));
  const d = parseOdds(val(which==="A" ? "lcA3OddsD" : "lcB3OddsD"));
  const a = parseOdds(val(which==="A" ? "lcA3OddsA" : "lcB3OddsA"));
  if(h==null || d==null || a==null) return null;
  const out = compute3Way(h,d,a);
  return { is3:true, odds:[h,d,a], out };
}

function fmtFairFromProbs(probs){
  try{
    return probs.map(p=> (p>0 ? (1/p).toFixed(2) : "-")).join(" / ");
  }catch(e){ return "-"; }
}

function runLineCompare(){
  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
  const outEl = document.getElementById("lineCompareOut");
  if(!outEl) return;
  const A = getLineCompareSet("A");
  const B = getLineCompareSet("B");
  if(!A || !B){
    outEl.style.display = "block";
    outEl.innerHTML = `<div class="k">ÏïàÎÇ¥</div><div class="v warn">ÎùºÏù∏ A/B Î∞∞ÎãπÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï§ò.</div>`;
    try{ track("line_compare", { ok:0 }); }catch(e){}
    return;
  }
  const mA = A.out.marginPct;
  const mB = B.out.marginPct;
  const best = (mA <= mB) ? "A" : "B";
  const delta = Math.abs(mA - mB);
  const labels = A.is3 ? [cfg.labels.H||"H", cfg.labels.D||"D", cfg.labels.A||"A"] : [cfg.labels.A||"A", cfg.labels.B||"B"];
  const fairA = fmtFairFromProbs(A.out.probs);
  const fairB = fmtFairFromProbs(B.out.probs);
  outEl.style.display = "block";
  outEl.innerHTML = `
    <div class="k">ÎπÑÍµê Í≤∞Í≥º</div>
    <div class="v">
      ‚Ä¢ ÎùºÏù∏ A ÎßàÏßÑ: <b>${mA.toFixed(2)}%</b> ¬∑ Í≥µÏ†ïÎ∞∞Îãπ(${labels.join("/")}): <b>${fairA}</b><br>
      ‚Ä¢ ÎùºÏù∏ B ÎßàÏßÑ: <b>${mB.toFixed(2)}%</b> ¬∑ Í≥µÏ†ïÎ∞∞Îãπ(${labels.join("/")}): <b>${fairB}</b><br>
      ‚Ä¢ Îçî ÎÇÆÏùÄ ÎßàÏßÑ: <b class="${best==='A'?'good':'warn'}">ÎùºÏù∏ ${best}</b> (Ï∞®Ïù¥ ${delta.toFixed(2)}%p)
    </div>
  `;
  try{ track("line_compare", { ok:1, best, delta_pp:+delta.toFixed(4) }); }catch(e){}
}

function applyLineCompare(which){
  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
  const is3 = (effectiveMainMode(cfg) === "3way");
  if(!is3){
    const a = val(which==="A" ? "lcA2OddsA" : "lcB2OddsA");
    const b = val(which==="A" ? "lcA2OddsB" : "lcB2OddsB");
    setVal("main2OddsA", a);
    setVal("main2OddsB", b);
  }else{
    const h = val(which==="A" ? "lcA3OddsH" : "lcB3OddsH");
    const d = val(which==="A" ? "lcA3OddsD" : "lcB3OddsD");
    const a = val(which==="A" ? "lcA3OddsA" : "lcB3OddsA");
    setVal("main3OddsH", h);
    setVal("main3OddsD", d);
    setVal("main3OddsA", a);
  }
  saveState();
  try{ calc(); }catch(e){}
  try{ track("line_apply", { which }); }catch(e){}
  try{ quickJump('result'); }catch(e){}
}

function prefillLineCompare(){
  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
  const is3 = (effectiveMainMode(cfg) === "3way");
  if(!is3){
    setVal("lcA2OddsA", val("main2OddsA"));
    setVal("lcA2OddsB", val("main2OddsB"));
    setVal("lcB2OddsA", "");
    setVal("lcB2OddsB", "");
  }else{
    setVal("lcA3OddsH", val("main3OddsH"));
    setVal("lcA3OddsD", val("main3OddsD"));
    setVal("lcA3OddsA", val("main3OddsA"));
    setVal("lcB3OddsH", "");
    setVal("lcB3OddsD", "");
    setVal("lcB3OddsA", "");
  }
  const outEl = document.getElementById("lineCompareOut");
  if(outEl){ outEl.style.display="none"; outEl.innerHTML=""; }
  try{ track("line_prefill", {}); }catch(e){}
}

function onSportChange(silent){
  const sport = val("sport");
  const cfg = SPORT_CFG[sport] || SPORT_CFG.soccer;

  // ÏÇ¨Ïö©ÏûêÍ∞Ä Ï¢ÖÎ™©ÏùÑ ÏßÅÏ†ë Î∞îÍæ∏Î©¥ Î©îÏù∏ ÌÉÄÏûÖ Ïò§Î≤ÑÎùºÏù¥ÎìúÎäî Í∏∞Î≥∏Í∞íÏúºÎ°ú Î¶¨ÏÖã
  if(!silent) MAIN_MODE_OVERRIDE = null;

  $("sportHint").innerText = `ÏÑ†ÌÉù Ï¢ÖÎ™©: ${cfg.name} ¬∑ ${cfg.hint}`;

  const is3 = (effectiveMainMode(cfg) === "3way");
  $("main2").style.display = is3 ? "none" : "block";
  $("main3").style.display = is3 ? "block" : "none";
  if(is3){
    $("mainMarketTitle").innerText = `Î©îÏù∏ Î∞∞Îãπ (${cfg.labels.H||"H"}/${cfg.labels.D||"D"}/${cfg.labels.A||"A"})`;
  }else{
    const L2t = labels2Way(cfg);
    $("mainMarketTitle").innerText = `Î©îÏù∏ Î∞∞Îãπ (${L2t.A}/${L2t.B})`;
  }

  if(!is3){
    const L2 = labels2Way(cfg);
    $("main2LabelA").innerText = `${L2.A} Î∞∞Îãπ`;
    $("main2LabelB").innerText = `${L2.B} Î∞∞Îãπ`;
  }else{
    $("main3LabelH").innerText = `${cfg.labels.H} Î∞∞Îãπ`;
    $("main3LabelD").innerText = `${cfg.labels.D} Î∞∞Îãπ`;
    $("main3LabelA").innerText = `${cfg.labels.A} Î∞∞Îãπ`;
  }

  // Ìï∏Îîî ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏
  $("handicapOddsALabel").innerText = `Ìï∏Îîî ${cfg.labels.A || "ÏÑ†ÌÉùA"} Î∞∞Îãπ`;
  $("handicapOddsBLabel").innerText = `Î∞òÎåÄ ${cfg.labels.B || "ÏÑ†ÌÉùB"} Î∞∞Îãπ`;

  // Í∏∞Î≥∏ Ìë∏Ïãú Í∑ºÏÇ¨Í∞í(ÎØ∏ÏûÖÎ†•Ïùº ÎïåÎßå Ï±ÑÏõåÎÑ£Í∏∞)
  if(!val("ouPush")) setVal("ouPush", cfg.defaults.ouPush);
  if(!val("handicapPush")) setVal("handicapPush", cfg.defaults.hcPush);

  applyTemplate();
  updateMyProbHints(cfg, val("level"));
  updateLineCompareUI(cfg);

  if(!silent) hideResult();
  renderMarginDash(); // Ï¢ÖÎ™© Î∞îÎÄåÎ©¥ Í∏∞Ï§ÄÌëú/ÎåÄÏãúÎ≥¥Îìú Ï¶âÏãú Î∞òÏòÅ
  saveState();
}

function onLevelChange(silent){
  const level = val("level");
  const isSimple = (level === "simple");
  const isAdv = (level === "adv");

  // Body hooks
  document.body.classList.toggle("simple", isSimple);
  document.body.dataset.level = level;


  // HIDE_HINTS_SIMPLE
  document.querySelectorAll(".settingsHint, .small-hint").forEach(el=>{ el.style.display = isSimple ? "none" : ""; });

  // Meta fields (Î¶¨Í∑∏/ÌåÄ) : Í∞ÑÎã®ÏùÄ Ï†ëÍ∏∞(Î≤ÑÌäºÏúºÎ°ú Ïó¥Í∏∞)
  const metaBtn = document.getElementById("metaToggleBtn");
  const metaFields = document.getElementById("metaFields");
  if(metaBtn && metaFields){
    if(isSimple){
      metaBtn.style.display = "inline-flex";
      // keep collapsed by default
      metaFields.style.display = "none";
    }else{
      metaBtn.style.display = "none";
      metaFields.style.display = "block";
    }
  }


  // Core visibility
  $("valueInputs").style.display = isSimple ? "none" : "block";
  $("totalBox").style.display = isSimple ? "none" : "block";
  $("handicapBox").style.display = isSimple ? "none" : "block";

  // Advanced-only: ÎùºÏù∏ ÎπÑÍµê(Í≥†Í∏â Ï†ÑÏö©ÏúºÎ°ú Ï†ïÎ¶¨)
  const lc = document.getElementById("lineCompareBox");
  if(lc) lc.style.display = isAdv ? "block" : "none";

  // Tabbar: Î†àÎ≤®Ïóê ÎßûÍ≤å ÌÉ≠ ÏûêÏ≤¥ÎèÑ Ïà®ÍπÄ
  const tabbar = document.getElementById("appTabbar");
  if(tabbar){
    const map = {
      main: true,
      total: !isSimple,
      handicap: !isSimple,
      result: true,
      history: true
    };
    tabbar.querySelectorAll(".st-tab").forEach(btn=>{
      const key = btn.getAttribute("data-jump");
      const show = map[key] !== false;
      btn.style.display = show ? "" : "none";
      if(!show && btn.classList.contains("on")){
        // Í∞ïÏ†úÎ°ú Î©îÏù∏ ÌÉ≠ÏúºÎ°ú Î≥µÍ∑Ä
        const mainBtn = tabbar.querySelector('.st-tab[data-jump="main"]');
        if(mainBtn) mainBtn.click();
      }
    });
  }

  // Paste: Í∞ÑÎã® Î™®ÎìúÏóêÏÑúÎäî 'Ïó¨Îü¨ Í≤ΩÍ∏∞ ÎßåÎì§Í∏∞' Ïà®ÍπÄ(Ï¥àÎ≥¥ ÌòºÎûÄ Î∞©ÏßÄ)
  const pasteBox = document.getElementById("pasteBox");
  if(pasteBox){
    const multiBtn = [...pasteBox.querySelectorAll("button")].find(b=> (b.textContent||"").includes("Ïó¨Îü¨ Í≤ΩÍ∏∞"));
    if(multiBtn) multiBtn.style.display = isSimple ? "none" : "";
  }

  // ÌïµÏã¨ Ìè¨Ïù∏Ìä∏(ÌöåÏÉâ Î∞ïÏä§) ÌÖçÏä§Ìä∏
  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;

  const levelPoint = document.getElementById("levelPoint");
  if(levelPoint){
    if(isSimple){
      levelPoint.innerHTML = `<span class="k">Í∞ÑÎã®</span> <b>Î©îÏù∏ Î∞∞ÎãπÎßå</b> ÎÑ£Í≥† ÎßàÏßÑ/Í≥µÏ†ïÌôïÎ•†ÏùÑ Îπ†Î•¥Í≤å ÌôïÏù∏Ìï©ÎãàÎã§. (OU/Ìï∏Îîî/EV ÏûÖÎ†•ÏùÄ Ïà®ÍπÄ)`;
    }else if(level === "mid"){
      levelPoint.innerHTML = `<span class="k">Ï§ëÍ∏â</span> Î©îÏù∏ + <b>OU/Ìï∏Îîî(ÏÑ†ÌÉù)</b>ÍπåÏßÄ Í∞ôÏù¥ Í≥ÑÏÇ∞Ìï©ÎãàÎã§. <b>ÎÇ¥ÌôïÎ•†</b>ÏùÑ ÎÑ£ÏúºÎ©¥ EV/Í∂åÏû•ÎπÑÏ§ëÎèÑ Ìï®Íªò Î¥ÖÎãàÎã§.`;
    }else{
      levelPoint.innerHTML = `<span class="k">Í≥†Í∏â</span> ÎùºÏù∏ ÎπÑÍµê/ÌôïÎ•† ÏûÖÎ†•/EV/ÏºàÎ¶¨ÍπåÏßÄ <b>Ï†ÑÏ≤¥ Í∏∞Îä•</b>ÏùÑ Î™®Îëê ÏÇ¨Ïö©Ìï©ÎãàÎã§.`;
    }
  }

  const mp = document.getElementById("mainPoint");
  if(mp){
    mp.innerHTML = `<span class="k">ÌïÑÏàò</span> Î∞∞ÎãπÎßå Ï†ïÌôïÌûà ÏûÖÎ†•ÌïòÎ©¥ Îê©ÎãàÎã§. <b>Ïò§Î≤ÑÎùºÏö¥Îìú(ÎßàÏßÑ)</b>Í∞Ä ÎÇÆÏùÑÏàòÎ°ù ÎπÑÏö©Ïù¥ ÎÇÆÏùÄ Ìé∏ÏûÖÎãàÎã§.`;
  }
  const tp = document.getElementById("totalPoint");
  if(tp){
    tp.innerHTML = `<span class="k">ÏÑ†ÌÉù</span> Ïò§Î≤Ñ/Ïñ∏Îçî Î∞∞ÎãπÏùÑ ÎÑ£ÏúºÎ©¥ <b>OU ÎßàÏßÑ</b>Í≥º Í≥µÏ†ïÌôïÎ•†ÏùÑ Îî∞Î°ú Í≥ÑÏÇ∞Ìï©ÎãàÎã§.`;
  }
  const hp = document.getElementById("handicapPoint");
  if(hp){
    hp.innerHTML = `<span class="k">ÏÑ†ÌÉù</span> Ìï∏Îîî ÎùºÏù∏/ÏñëÏ™Ω Î∞∞Îãπ ÏûÖÎ†• Ïãú <b>Ìï∏Îîî ÎßàÏßÑ</b>Í≥º Í≥µÏ†ïÌôïÎ•†ÏùÑ ÌôïÏù∏Ìï©ÎãàÎã§.`;
  }

  updateMyProbHints(cfg, level);
  applyTemplate();

  if(!silent) hideResult();
  renderMarginDash();
  saveState();
}

function updateMyProbHints(cfg, level){
  const is3 = (effectiveMainMode(cfg) === "3way");
  if(level === "simple"){
    $("myProbLabel").innerText = "ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†(ÏÑ†ÌÉù) %";
    $("myProbHint").innerText = "";
    return;
  }
  if(is3){
    $("myProbLabel").innerText = `ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†(${cfg.labels.H}/${cfg.labels.D}/${cfg.labels.A}) % (ÏÑ†ÌÉù)`;
    $("myProbHint").innerText = `ÏâºÌëú/Í≥µÎ∞±/Ïä¨ÎûòÏãúÎ°ú 3Í∞ú ÏûÖÎ†• (Ïòà: 45,28,27) ¬∑ Ìï© 100 ÏïÑÎãàÎ©¥ ÏûêÎèô Ï†ïÍ∑úÌôî`;
  }else{
    $("myProbLabel").innerText = `ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†(${cfg.labels.A}) % (ÏÑ†ÌÉù)`;
    $("myProbHint").innerText = `Ïòà: 55 (Îã®Ïùº Í∞í) ¬∑ EV/Í∂åÏû•ÎπÑÏ§ë Í≥ÑÏÇ∞Ïö©`;
  }
}

/* ÌÖúÌîåÎ¶ø: Ï¢ÖÎ™©Î≥Ñ OU/Ìï∏Îîî Í∏∞Î≥∏ ÌéºÏπ® */
function applyTemplate(){
  const level = val("level");
  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
  if(level === "simple") return;
  setCollapsed("handicapBody", !cfg.template.openHandicap);
  setCollapsed("totalBody", !cfg.template.openTotal);
}

/* Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ */
function toggleBox(id){
  const now = isCollapsed(id);
  setCollapsed(id, !now);
  syncToggleLabels();
  try{ saveState(); }catch(e){}
}
function syncToggleLabels(){
  document.querySelectorAll('.toggle[data-target]').forEach(btn=>{
    const tid = btn.getAttribute('data-target');
    btn.textContent = isCollapsed(tid) ? "ÌéºÏπòÍ∏∞" : "Ï†ëÍ∏∞";
  });
}


function toggleMeta(){
  const metaFields = document.getElementById("metaFields");
  const metaBtn = document.getElementById("metaToggleBtn");
  if(!metaFields || !metaBtn) return;
  const open = metaFields.style.display !== "none";
  metaFields.style.display = open ? "none" : "block";
  metaBtn.textContent = open ? "Ï∂îÍ∞Ä Ï†ïÎ≥¥ ÏûÖÎ†•(ÏÑ†ÌÉù) ‚ñæ" : "Ï∂îÍ∞Ä Ï†ïÎ≥¥ Îã´Í∏∞ ‚ñ¥";
}
function isCollapsed(id){
  const el = $(id);
  return el ? el.style.display === "none" : false;
}
function setCollapsed(id, collapsed){
  const el = $(id);
  if(!el) return;
  el.style.display = collapsed ? "none" : "block";
}

/* =========================
   Í≥ÑÏÇ∞ Ïú†Ìã∏
========================= */
function parseOdds(v){
  if(!v) return null;
  const x = Number(String(v).replace(/,/g,".").trim());
  if(!isFinite(x) || x<=1) return null;
  return x;
}
function parsePct(v){
  if(v==null || v==="") return null;
  const x = Number(String(v).replace(/,/g,".").trim());
  if(!isFinite(x) || x<0 || x>100) return null;
  return x/100;
}
let LAST_MYPROB_SUM = null;
let LAST_MYPROB_RAW = null;
function parsePctList(str){
  // Accept: "45,28,27" or "45 28 27" or "45/28/27"
  LAST_MYPROB_SUM = null;
  LAST_MYPROB_RAW = null;
  if(!str) return null;
  const parts = String(str).trim().split(/[\s,\/|]+/).map(s=>s.trim()).filter(Boolean);
  if(parts.length !== 3) return null;
  const p1=parsePct(parts[0]), p2=parsePct(parts[1]), p3=parsePct(parts[2]);
  if(p1==null || p2==null || p3==null) return null;
  const sum = p1+p2+p3;
  if(!isFinite(sum) || sum<=0) return null;
  LAST_MYPROB_SUM = sum;
  LAST_MYPROB_RAW = [p1,p2,p3];
  // Normalize to 100% even if user input doesn't sum to 100
  return [p1/sum, p2/sum, p3/sum];
}
function parseMoney(v){
  if(!v) return null;
  const x = Number(String(v).replace(/[^\d]/g,""));
  if(!isFinite(x) || x<=0) return null;
  return x;
}

/* =========================
   ÌÖçÏä§Ìä∏ Î∂ôÏó¨ÎÑ£Í∏∞ ÌååÏÑú (MVP)
   - Ïª§ÎÆ§ÎãàÌã∞/Î∞∞ÎãπÌëú ÌÖçÏä§Ìä∏ÏóêÏÑú Î©îÏù∏/OU/Ìï∏ÎîîÎ•º ÏûêÎèô Ï∂îÏ∂ú
   - Ï†ÑÎ∂Ä ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑúÎßå Ï≤òÎ¶¨(ÏÑúÎ≤Ñ/ÎπÑÏö© 0)
========================= */
function setupPasteBox(){
  const ta = $("pasteInput");
  if(!ta) return;
  ta.addEventListener("keydown", (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key === "Enter"){
      e.preventDefault();
      if(e.shiftKey){
        // Ctrl+Shift+Enter: Î©ÄÌã∞ ÌååÏã±
        try{ parsePasteMulti(); }catch(err){ applyPaste(true); }
      }else{
        // Ctrl+Enter: Îã®Ïùº Ï†ÅÏö©+Í≥ÑÏÇ∞
        applyPaste(true);
      }
    }
  });
}

function clearPaste(){
  setVal("pasteInput", "");
  setPasteBadge("", "");
  const hint = $("pasteHint");
  if(hint) hint.innerText = "";
}

function fillPasteExample(){
  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
  const is3 = (effectiveMainMode(cfg) === "3way");
  const ex = is3
    ? "Îß®ÏãúÌã∞ vs Î¶¨Î≤ÑÌíÄ  Ïäπ 1.85 Î¨¥ 3.40 Ìå® 4.20 / Ïò§Î≤Ñ 2.5 1.95 Ïñ∏Îçî 1.85 / Ìï∏Îîî -1.5 1.90 1.95"
    : "Î†àÏù¥Ïª§Ïä§ vs ÏõåÎ¶¨Ïñ¥Ïä§ Ïäπ 1.87 Ìå® 2.03 / Ïò§Î≤Ñ 228.5 1.93 Ïñ∏Îçî 1.87 / Ìï∏Îîî -3.5 1.90 1.95";
  setVal("pasteInput", ex);
  try{ $("pasteInput").focus(); }catch(e){}
}

function setPasteBadge(okMsg, warnMsg){
  const ok = $("pasteBadgeOk");
  const warn = $("pasteBadgeWarn");
  if(ok){
    if(okMsg){ ok.style.display = "inline-flex"; ok.textContent = okMsg; }
    else{ ok.style.display = "none"; ok.textContent = ""; }
  }
  if(warn){
    if(warnMsg){ warn.style.display = "inline-flex"; warn.textContent = warnMsg; }
    else{ warn.style.display = "none"; warn.textContent = ""; }
  }
}

function normalizePasteText(s){
  if(!s) return "";
  let t = String(s).replace(/¬†/g, " ");
  t = t.replace(/\s+/g, " ").trim();
  // decimal comma -> dot (1,85)
  t = t.replace(/(\d),(\d{1,3})(?!\d)/g, (m,a,b)=>`${a}.${b}`);
  return t;
}

function extractNextNumberTokens(text, startIndex, maxCount){
  const out = [];
  const re = /[+-]?\d+(?:\.\d+)?/g;
  re.lastIndex = startIndex;
  let m;
  while((m = re.exec(text)) && out.length < maxCount){
    const v = Number(m[0]);
    if(!isFinite(v)) continue;
    out.push({ v, start: m.index, end: m.index + m[0].length, raw: m[0] });
  }
  return out;
}

function extractTeamsFromText(text){
  // "A vs B" / "A v B" / "A ÎåÄ B" ÌòïÌÉúÎ•º Í∞ÄÎ≥çÍ≤å Ï∂îÏ∂ú
  const re = /([^0-9]{2,40}?)\s*(?:vs|v|VS|ÎåÄ)\s*([^0-9]{2,40}?)(?=\s|$|\/)/;
  const m = re.exec(text);
  if(!m) return null;
  const a = m[1].replace(/[\[\]<>]/g, "").trim();
  const b = m[2].replace(/[\[\]<>]/g, "").trim();
  if(a.length < 2 || b.length < 2) return null;
  return `${a} vs ${b}`;
}

function parseOUFromText(text){
  let t = text;
  const overKW = /(?:Ïò§Î≤Ñ|over)/i;
  const underKW = /(?:Ïñ∏Îçî|under)/i;

  let over = null, under = null;
  let cutEnd = -1;

  const mo = overKW.exec(t);
  if(mo){
    const toks = extractNextNumberTokens(t, mo.index + mo[0].length, 3);
    if(toks.length >= 2){
      // Ïò§Î≤Ñ {ÎùºÏù∏} {Î∞∞Îãπ}
      const line = toks[0].v;
      const odds = toks[1].v;
      if(isFinite(line) && isFinite(odds) && odds > 1){
        over = { line, odds };
        cutEnd = Math.max(cutEnd, toks[1].end);
        t = t.slice(0, mo.index) + " " + t.slice(toks[1].end);
      }
    }else if(toks.length >= 1){
      // ÎùºÏù∏ ÎàÑÎùΩ Í∞ÄÎä•: Ïò§Î≤Ñ {Î∞∞Îãπ}
      const odds = toks[0].v;
      if(isFinite(odds) && odds > 1){
        over = { line: null, odds };
        cutEnd = Math.max(cutEnd, toks[0].end);
        t = t.slice(0, mo.index) + " " + t.slice(toks[0].end);
      }
    }
  }

  const mu = underKW.exec(t);
  if(mu){
    const toks = extractNextNumberTokens(t, mu.index + mu[0].length, 3);
    if(toks.length >= 2){
      const line = toks[0].v;
      const odds = toks[1].v;
      if(isFinite(line) && isFinite(odds) && odds > 1){
        under = { line, odds };
        cutEnd = Math.max(cutEnd, toks[1].end);
        t = t.slice(0, mu.index) + " " + t.slice(toks[1].end);
      }
    }else if(toks.length >= 1){
      const odds = toks[0].v;
      if(isFinite(odds) && odds > 1){
        under = { line: null, odds };
        cutEnd = Math.max(cutEnd, toks[0].end);
        t = t.slice(0, mu.index) + " " + t.slice(toks[0].end);
      }
    }
  }

  const full = !!(over && under && over.odds && under.odds);
  const line = (over && over.line != null) ? over.line : (under && under.line != null ? under.line : null);
  return { full, line, overOdds: over ? over.odds : null, underOdds: under ? under.odds : null, cleanedText: t };
}

function parseHCFromText(text){
  let t = text;
  const kw = /(?:Ìï∏ÎîîÏ∫°|Ìï∏Îîî|handicap|ah)/i;
  const m = kw.exec(t);
  if(!m) return { full:false, line:null, a:null, b:null, cleanedText:t };

  const toks = extractNextNumberTokens(t, m.index + m[0].length, 5);
  if(toks.length < 3) return { full:false, line:null, a:null, b:null, cleanedText:t };

  const line = toks[0].v;
  const a = toks[1].v;
  const b = toks[2].v;
  const full = (isFinite(line) && Math.abs(line) <= 50 && isFinite(a) && isFinite(b) && a > 1 && b > 1);

  if(full){
    t = t.slice(0, m.index) + " " + t.slice(toks[2].end);
    return { full, line, a, b, cleanedText:t };
  }
  return { full:false, line:null, a:null, b:null, cleanedText:t };
}

function extractOddsCandidates(text){
  const re = /[1-9]\d*(?:\.\d+)?/g;
  const out=[];
  let m;
  while((m=re.exec(text))){
    const v = Number(m[0]);
    if(!isFinite(v)) continue;
    if(v > 1 && v <= 200) out.push(v);
  }
  return out;
}

function parseMainFromText(text, is3){
  const t = text;
  if(is3){
    const re = /(?:Ìôà|Ïäπ|1)\s*[:\-]?\s*([1-9]\d*(?:\.\d+)?)[\s\S]{0,60}?(?:Î¨¥|x|draw)\s*[:\-]?\s*([1-9]\d*(?:\.\d+)?)[\s\S]{0,60}?(?:ÏõêÏ†ï|Ìå®|2)\s*[:\-]?\s*([1-9]\d*(?:\.\d+)?)/i;
    const m = re.exec(t);
    if(m){
      const h = Number(m[1]), d = Number(m[2]), a = Number(m[3]);
      if(isFinite(h) && isFinite(d) && isFinite(a) && h>1 && d>1 && a>1) return { found:true, odds:[h,d,a] };
    }
    const c = extractOddsCandidates(t);
    if(c.length >= 3) return { found:true, odds:[c[0],c[1],c[2]], extra:c.length-3 };
    return { found:false, odds:[] };
  }
  // 2-way
  const re2 = /(?:Ïäπ|Ìôà|1)\s*[:\-]?\s*([1-9]\d*(?:\.\d+)?)[\s\S]{0,60}?(?:Ìå®|ÏõêÏ†ï|2)\s*[:\-]?\s*([1-9]\d*(?:\.\d+)?)/i;
  const m2 = re2.exec(t);
  if(m2){
    const a = Number(m2[1]), b = Number(m2[2]);
    if(isFinite(a) && isFinite(b) && a>1 && b>1) return { found:true, odds:[a,b] };
  }
  const c = extractOddsCandidates(t);
  if(c.length >= 2) return { found:true, odds:[c[0],c[1]], extra:c.length-2 };
  return { found:false, odds:[] };
}

function applyPaste(autoCalc){
  const raw = val("pasteInput");
  const txt = normalizePasteText(raw);
  if(!txt){
    setPasteBadge("", "ÌÖçÏä§Ìä∏Î•º Î∂ôÏó¨ÎÑ£Ïñ¥Ï§ò.");
    return;
  }

  // 1) ÌåÄÎ™Ö ÏûêÎèô Ï∂îÏ∂ú(ÏûÖÎ†•Ïù¥ ÎπÑÏñ¥ÏûàÏùÑ ÎïåÎßå)
  try{
    if(!val("teams")){
      const teams = extractTeamsFromText(txt);
      if(teams) setVal("teams", teams);
    }
  }catch(e){}

  // 2) OU/Ìï∏Îîî Î®ºÏ†Ä Ï∂îÏ∂úÌïòÍ≥† ÌÖçÏä§Ìä∏ÏóêÏÑú Ï†úÍ±∞(Î©îÏù∏ Ïò§Ïù∏Ïãù Î∞©ÏßÄ)
  let working = txt;
  const ou = parseOUFromText_v2(working);
  working = ou.cleanedText;
  const hc = parseHCFromText_v2(working);
  working = hc.cleanedText;

  // 3) OU/Ìï∏ÎîîÍ∞Ä ÏûàÏúºÎ©¥ Î†àÎ≤® ÏûêÎèô Ï†ÑÌôò(ÏÑ†ÌÉù)
  const wantsAutoLevel = (function(){ const el=$("pasteAutoLevel"); return el ? el.checked : false; })();
  if(wantsAutoLevel && val("level") === "simple" && (ou.full || hc.full)){
    setVal("level", "mid");
    onLevelChange(true);
  }

  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;
  const modeEl = $("pasteMainMode");
  const mode = modeEl ? modeEl.value : "auto";
  const prefer3 = (cfg.main === "3way");
  const tryMain = (is3)=> parseMainFromText_robust(working, is3);

  let is3 = (mode==="3") ? true : (mode==="2") ? false : prefer3;
  let main = tryMain(is3);

  if(!main || !main.found){
    if(mode==="auto"){
      const alt = tryMain(!is3);
      if(alt && alt.found){ is3 = !is3; main = alt; }
    }
  }

  // 4) Î©îÏù∏ Î∞∞Îãπ Ï∂îÏ∂ú
  if(!main || !main.found){
    let msg = "Î©îÏù∏ Î∞∞ÎãπÏùÑ Ï∞æÏßÄ Î™ªÌñàÏñ¥.";
    if(mode==="3") msg += " Ïòà: Ïäπ 1.85 Î¨¥ 3.40 Ìå® 4.20";
    else if(mode==="2") msg += " Ïòà: Ïäπ 1.87 Ìå® 2.03";
    else msg += " Ïòà: Ïäπ 1.85 Î¨¥ 3.40 Ìå® 4.20 (3Î∞∞Îãπ) ÎòêÎäî Ïäπ 1.87 Ìå® 2.03 (2Î∞∞Îãπ)";
    setPasteBadge("", msg);
    const hint=$("pasteHint");
    if(hint) hint.innerText = "ÌåÅ: 'ÌåÄA vs ÌåÄB' Îí§Ïóê Î∞∞Îãπ Ïà´Ïûê(ÏÜåÏàòÏ†ê Ìè¨Ìï®)Í∞Ä Í∞ôÏù¥ ÏûàÏñ¥Ïïº ÏûêÎèô Ïù∏ÏãùÎèºÏöî.";
    return;
  }

  // (ÏÑ†ÌÉù) Î©îÏù∏ ÌÉÄÏûÖ Ïò§Î≤ÑÎùºÏù¥Îìú Î∞òÏòÅ (Ï∂ïÍµ¨ 2Î∞∞Îãπ Îì±)
  try{ setMainModeOverride(is3 ? "3way" : "2way"); }catch(e){}

  // 5) ÏûÖÎ†• Ï†ÅÏö©
  if(is3){
    setVal("main3OddsH", String(main.odds[0]));
    setVal("main3OddsD", String(main.odds[1]));
    setVal("main3OddsA", String(main.odds[2]));
  }else{
    setVal("main2OddsA", String(main.odds[0]));
    setVal("main2OddsB", String(main.odds[1]));
  }

  if(ou.full){
    if(ou.line != null) setVal("totalLine", String(ou.line));
    if(ou.overOdds != null) setVal("overOdds", String(ou.overOdds));
    if(ou.underOdds != null) setVal("underOdds", String(ou.underOdds));
  }
  if(hc.full){
    setVal("handicapLine", String(hc.line));
    setVal("handicapOddsA", String(hc.a));
    setVal("handicapOddsB", String(hc.b));
  }

  // ÎùºÏù∏ ÎπÑÍµê ÏûÖÎ†•ÎèÑ Í∞ôÏù¥ Ï±ÑÏõåÎëêÍ∏∞(Ìé∏Ïùò)
  try{ prefillLineCompare(); }catch(e){}

  hideResult();
  renderMarginDash();
  saveState();

  // 6) ÌîºÎìúÎ∞±
  let okMsg = `Î©îÏù∏ ${is3 ? "3Î∞∞Îãπ" : "2Î∞∞Îãπ"} ÏûÖÎ†•Îê®`;
  if(ou.full) okMsg += ` ¬∑ OU ${ou.line != null ? ou.line : ""}`;
  if(hc.full) okMsg += ` ¬∑ Ìï∏Îîî ${hc.line}`;
  setPasteBadge(okMsg, "");

  const hint = $("pasteHint");
  if(hint){
    hint.innerText = "Îã®Ï∂ïÌÇ§: Ctrl+Enter = ÏûêÎèô ÏûÖÎ†•+Í≥ÑÏÇ∞ ¬∑ Ctrl+Shift+Enter = Ïó¨Îü¨ Í≤ΩÍ∏∞ Î¶¨Ïä§Ìä∏";
  }

  try{
    track("paste_apply", { auto_calc: autoCalc?1:0, main: is3?"3":"2", has_ou: ou.full?1:0, has_hc: hc.full?1:0 });
  }catch(e){}

  if(autoCalc){
    try{ calc(); }catch(e){}
    try{ quickJump('result'); }catch(e){}
  }
}

/* =========================
   Î©ÄÌã∞ Î∂ôÏó¨ÎÑ£Í∏∞ (2Îã®Í≥Ñ)
   - Ïó¨Îü¨ Í≤ΩÍ∏∞ ÌÖçÏä§Ìä∏Î•º Ìïú Î≤àÏóê Î∂ôÏó¨ÎÑ£Í∏∞ ‚Üí Í≤ΩÍ∏∞ Î¶¨Ïä§Ìä∏ ÏûêÎèô ÏÉùÏÑ±
   - Î¶¨Ïä§Ìä∏ ÏïÑÏù¥ÌÖú ÌÅ¥Î¶≠ ‚Üí Î∂ÑÏÑùÍ∏∞ ÏûÖÎ†• ÏûêÎèô Ï†ÅÏö©(ÏÑ†ÌÉù: ÏûêÎèô Í≥ÑÏÇ∞)
   - ÏÇ¨Ïö©Ïûê ÏûÖÎ†• Ìé∏Ï∞®(ÏàúÏÑú/Íµ¨Î∂ÑÏûê/ÏïΩÏñ¥)Î•º ÏµúÎåÄÌïú Ìù°Ïàò
========================= */

function normalizePasteTextMulti(s){
  if(!s) return "";
  let t = String(s).replace(/\r\n?/g, "\n");
  t = t.replace(/\t/g, " ");
  t = t.replace(/\u00a0/g, " ");
  // decimal comma -> dot (1,85)
  t = t.replace(/(\d),(\d{1,3})(?!\d)/g, (m,a,b)=>`${a}.${b}`);
  // normalize separators
  t = t.replace(/[|ÔΩú]/g, " / ");
  t = t.split("\n").map(l=>l.replace(/\s+/g," ").trim()).join("\n");
  return t.trim();
}

function hasVsToken(s){
  return /(?:\bvs\b|\bv\b|ÎåÄ|@)/i.test(s);
}

function splitLineByRepeatedVs(line){
  // Ìïú Ï§ÑÏóê Í≤ΩÍ∏∞ Ïó¨Îü¨ Í∞úÍ∞Ä Îì§Ïñ¥Ïò® Í≤ΩÏö∞Î•º Í∞ÄÎ≥çÍ≤å Î∂ÑÎ¶¨
  // ex) A vs B 1.8 3.4 4.2  C vs D 1.9 3.2 3.8
  const parts = [];
  const re = /([^\d]{2,40}?\s*(?:vs|VS|\bv\b|V|ÎåÄ|@)\s*[^\d]{2,40}?)/g;
  let idxs = [];
  let m;
  while((m = re.exec(line))){
    idxs.push(m.index);
  }
  if(idxs.length <= 1) return [line];
  for(let i=0;i<idxs.length;i++){
    const start = idxs[i];
    const end = (i+1<idxs.length) ? idxs[i+1] : line.length;
    const seg = line.slice(start, end).trim();
    if(seg) parts.push(seg);
  }
  return parts.length ? parts : [line];
}

function splitPasteBlocks(text){
  const t = normalizePasteTextMulti(text);
  if(!t) return [];
  let lines = t.split("\n").map(l=>l.trim()).filter(Boolean);
  // 1) Ìïú Ï§ÑÏóê Í≤ΩÍ∏∞ Ïó¨Îü¨ Í∞úÎ©¥ Î∂ÑÎ¶¨
  let expanded = [];
  for(const ln of lines){
    const segs = splitLineByRepeatedVs(ln);
    for(const s of segs) expanded.push(s);
  }
  lines = expanded;

  const anyVs = lines.some(hasVsToken);
  if(!anyVs){
    // VS ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏúºÎ©¥ Ï§Ñ Îã®ÏúÑÎ°ú Ï≤òÎ¶¨
    return lines;
  }

  const blocks = [];
  let cur = [];
  for(const ln of lines){
    if(hasVsToken(ln) && cur.length && cur.some(hasVsToken)){
      blocks.push(cur.join(" / "));
      cur = [ln];
    }else{
      cur.push(ln);
    }
  }
  if(cur.length) blocks.push(cur.join(" / "));
  return blocks;
}

function findEarliestMatch(text, regexList){
  let best = null;
  for(const re of regexList){
    const m = re.exec(text);
    if(m){
      if(best == null || m.index < best.index){
        best = { m, index:m.index, re };
      }
    }
  }
  return best;
}

function parseOUFromText_v2(text){
  // Í∏∞Ï°¥ parseOUFromText ÌôïÏû•: O/U ÏïΩÏñ¥ÎèÑ ÌóàÏö©
  let t = text;
  const overMatches = [
    /Ïò§Î≤Ñ/i,
    /\bover\b/i,
    /(?:^|[\s\/])O(?=[\s\/]|$)/i,
    /O\s*\/\s*U/i,
    /\bOU\b/i
  ];
  const underMatches = [
    /Ïñ∏Îçî/i,
    /\bunder\b/i,
    /(?:^|[\s\/])U(?=[\s\/]|$)/i
  ];

  let over = null, under = null;

  const mo = findEarliestMatch(t, overMatches);
  if(mo){
    const toks = extractNextNumberTokens(t, mo.index + mo.m[0].length, 3);
    if(toks.length >= 2){
      const line = toks[0].v;
      const odds = toks[1].v;
      if(isFinite(line) && isFinite(odds) && odds > 1){
        over = { line, odds };
        t = t.slice(0, mo.index) + " " + t.slice(toks[1].end);
      }
    }else if(toks.length >= 1){
      const odds = toks[0].v;
      if(isFinite(odds) && odds > 1){
        over = { line:null, odds };
        t = t.slice(0, mo.index) + " " + t.slice(toks[0].end);
      }
    }
  }

  const mu = findEarliestMatch(t, underMatches);
  if(mu){
    const toks = extractNextNumberTokens(t, mu.index + mu.m[0].length, 3);
    if(toks.length >= 2){
      const line = toks[0].v;
      const odds = toks[1].v;
      if(isFinite(line) && isFinite(odds) && odds > 1){
        under = { line, odds };
        t = t.slice(0, mu.index) + " " + t.slice(toks[1].end);
      }
    }else if(toks.length >= 1){
      const odds = toks[0].v;
      if(isFinite(odds) && odds > 1){
        under = { line:null, odds };
        t = t.slice(0, mu.index) + " " + t.slice(toks[0].end);
      }
    }
  }

  const full = !!(over && under && over.odds && under.odds);
  const line = (over && over.line != null) ? over.line : (under && under.line != null ? under.line : null);
  return { full, line, overOdds: over ? over.odds : null, underOdds: under ? under.odds : null, cleanedText: t };
}

function parseHCFromText_v2(text){
  let t = text;
  const kw = /(?:Ìï∏ÎîîÏ∫°|Ìï∏Îîî|handicap|ah|hdp|spread|Ïä§ÌîÑÎ†àÎìú)/i;
  const m = kw.exec(t);
  if(m){
    const toks = extractNextNumberTokens(t, m.index + m[0].length, 5);
    if(toks.length >= 3){
      const line = toks[0].v;
      const a = toks[1].v;
      const b = toks[2].v;
      const full = (isFinite(line) && Math.abs(line) <= 2000 && isFinite(a) && isFinite(b) && a > 1 && b > 1);
      if(full){
        t = t.slice(0, m.index) + " " + t.slice(toks[2].end);
        return { full, line, a, b, cleanedText: t };
      }
    }
  }

  // ÌÇ§ÏõåÎìúÍ∞Ä ÏóÜÏñ¥ÎèÑ "-3.5 1.90 1.95" Í∞ôÏùÄ Ïä§ÌîÑÎ†àÎìú Ìå®ÌÑ¥ÏùÑ Í∞ÄÎ≥çÍ≤å Ïù∏Ïãù
  const re = /([+-]?\d+(?:\.\d+)?)\s+([1-9]\d*(?:\.\d+)?)\s+([1-9]\d*(?:\.\d+)?)/;
  const m2 = re.exec(t);
  if(m2){
    const line = Number(m2[1]);
    const a = Number(m2[2]);
    const b = Number(m2[3]);
    if(isFinite(line) && Math.abs(line) <= 30 && isFinite(a) && isFinite(b) && a>1 && b>1 && (String(m2[1]).startsWith("+") || String(m2[1]).startsWith("-")) ){
      const cutStart = m2.index;
      const cutEnd = m2.index + m2[0].length;
      const cleaned = t.slice(0, cutStart) + " " + t.slice(cutEnd);
      return { full:true, line, a, b, cleanedText: cleaned };
    }
  }
  return { full:false, line:null, a:null, b:null, cleanedText:t };
}

function parseMainFromText_robust(text, is3){
  // 1) Í∏∞Ï°¥ ÌÇ§ÏõåÎìú Í∏∞Î∞ò
  const r1 = parseMainFromText(text, is3);
  if(r1.found) return { ...r1, conf:"high", method:"keyword" };

  // 2) ÌåÄÎ™Ö Ïù¥ÌõÑÎ•º Ïö∞ÏÑ†
  let startIdx = 0;
  try{
    const re = /([^0-9]{2,40}?)\s*(?:vs|v|VS|ÎåÄ|@)\s*([^0-9]{2,40}?)(?=\s|$|\/)/;
    const m = re.exec(text);
    if(m) startIdx = m.index + m[0].length;
  }catch(e){}
  const after = text.slice(startIdx);
  const c = extractOddsCandidates(after);
  if(is3){
    if(c.length >= 3) return { found:true, odds:[c[0],c[1],c[2]], extra: Math.max(0,c.length-3), conf: c.length===3?"mid":"low", method:"after_team" };
  }else{
    if(c.length >= 2){
      // 2-wayÏù∏Îç∞ 3Í∞úÎ©¥ Ï§ëÍ∞Ñ(draw) ÎÅºÏñ¥ÏûàÏùÑ Ïàò ÏûàÏñ¥ÏÑú Ï≤´/ÎßàÏßÄÎßâ Ïö∞ÏÑ†
      if(c.length >= 3) return { found:true, odds:[c[0],c[2]], extra: Math.max(0,c.length-2), conf:"low", method:"skip_mid" };
      return { found:true, odds:[c[0],c[1]], extra: Math.max(0,c.length-2), conf:"mid", method:"after_team" };
    }
  }

  // 3) ÎßàÏßÄÎßâ fallback: Î¨∏Ïû• Ï†ÑÏ≤¥ÏóêÏÑú ÏàúÏ∞® Ï∂îÏ∂ú
  const c2 = extractOddsCandidates(text);
  if(is3){
    if(c2.length >= 3) return { found:true, odds:[c2[0],c2[1],c2[2]], extra: Math.max(0,c2.length-3), conf:"low", method:"fallback" };
  }else{
    if(c2.length >= 2) return { found:true, odds:[c2[0],c2[1]], extra: Math.max(0,c2.length-2), conf:"low", method:"fallback" };
  }
  return { found:false, odds:[], conf:"low", method:"none" };
}

function parseGameBlock(blockText){
  const cfg = SPORT_CFG[val("sport")] || SPORT_CFG.soccer;

  const raw = normalizePasteText(blockText);
  if(!raw) return null;

  // ÌåÄÎ™Ö Ï∂îÏ∂ú (ÏóÜÏúºÎ©¥ null)
  const teams = extractTeamsFromText(raw);

  // OU/HC Î®ºÏ†Ä Ï†úÍ±∞(Î©îÏù∏ Ïò§Ïù∏Ïãù Î∞©ÏßÄ)
  let working = raw;
  const ou = parseOUFromText_v2(working);
  working = ou.cleanedText;
  const hc = parseHCFromText_v2(working);
  working = hc.cleanedText;

  // Î©îÏù∏ ÌÉÄÏûÖ(Ïú†Ï†Ä ÏûÖÎ†• Ìé∏Ï∞® ÎåÄÏùë): ÏûêÎèô/2Î∞∞Îãπ/3Î∞∞Îãπ
  const modeEl = $("pasteMainMode");
  const mode = modeEl ? modeEl.value : "auto";
  const prefer3 = (cfg.main === "3way"); // Ï¢ÖÎ™© Í∏∞Î≥∏ ÏÑ†Ìò∏(Ï∂ïÍµ¨ 3way Îì±)
  const tryMain = (is3)=> parseMainFromText_robust(working, is3);

  let is3 = (mode==="3") ? true : (mode==="2") ? false : prefer3;
  let main = tryMain(is3);

  if(!main || !main.found){
    if(mode==="auto"){
      const alt = tryMain(!is3);
      if(alt && alt.found){ is3 = !is3; main = alt; }
    }
  }
  if(!main || !main.found) return null;

  const conf = main.conf || "low";
  const extra = main.extra || 0;
  const warn = (conf === "low" || extra >= 2);

  // ÏòàÏÉÅ ÎßàÏßÑ(Î©îÏù∏) ‚Äî Î¶¨Ïä§Ìä∏ ÎØ∏Î¶¨Î≥¥Í∏∞Ïö©
  let mainOver = null, mainMarginPct = null;
  try{
    if(is3){
      const out = compute3Way(Number(main.odds[0]), Number(main.odds[1]), Number(main.odds[2]));
      mainOver = out.over; mainMarginPct = out.marginPct;
    }else{
      const out = compute2Way(Number(main.odds[0]), Number(main.odds[1]), 0);
      mainOver = out.over; mainMarginPct = out.marginPct;
    }
  }catch(e){}

  const sig = (function(){
    const norm=(x)=>String(x??"").toLowerCase().replace(/\s+/g,"");
    const f=(n)=>{ const v=Number(n); return Number.isFinite(v)?v.toFixed(4):""; };
    const parts=[norm(val("sport")), is3?"3way":"2way", norm(teams||"")];
    if(is3){ parts.push(f(main.odds[0]), f(main.odds[1]), f(main.odds[2])); }
    else { parts.push(f(main.odds[0]), f(main.odds[1])); }
    if(ou && ou.full) parts.push("ou:"+norm(ou.line)+":"+f(ou.overOdds)+":"+f(ou.underOdds));
    if(hc && hc.full) parts.push("hc:"+norm(hc.line)+":"+f(hc.a)+":"+f(hc.b));
    return parts.join("|");
  })();

  return {
    id: Math.random().toString(36).slice(2),
    raw,
    teams,
    is3,
    mainOdds: main.odds,
    mainOver,
    mainMarginPct,
    ou,
    hc,
    conf,
    method: main.method || "",
    warn,
    extra,
    sig
  };
}


function fmtOddsArr(arr){
  return (arr||[]).map(x=>Number(x).toFixed(2)).join(" / ");
}

function confLabel(c){
  if(c === "high") return "ÎÜíÏùå";
  if(c === "mid") return "Ï§ëÍ∞Ñ";
  return "ÎÇÆÏùå";
}

function renderPasteList(games){
  const wrap = $("pasteListWrap");
  const list = $("pasteList");
  const meta = $("pasteListMeta");
  if(!wrap || !list) return;

  __PASTE_MULTI = games || [];
  if(!__PASTE_MULTI.length){
    wrap.style.display = "none";
    list.innerHTML = "";
    if(meta) meta.textContent = "";
    return;
  }

  wrap.style.display = "block";
  if(meta) meta.textContent = `${__PASTE_MULTI.length}Í∞ú Í∞êÏßÄ ¬∑ ${isPasteChainMode()?"ÌÅ¥Î¶≠=Ïó∞ÏÜç Ï†ÄÏû•":"ÌÅ¥Î¶≠=ÏõêÎ¨∏ ÌÜ†Í∏Ä"} ¬∑ Î≤ÑÌäºÏúºÎ°ú Ï¶âÏãú Ï†ÅÏö© Í∞ÄÎä•`;

  const view = __PASTE_MULTI.map((g, idx)=>({g, idx}));
  if(__PASTE_SORT==="margin"){
    view.sort((a,b)=>{
      const ma = (typeof a.g.mainMarginPct==="number") ? a.g.mainMarginPct : 9999;
      const mb = (typeof b.g.mainMarginPct==="number") ? b.g.mainMarginPct : 9999;
      return ma-mb;
    });
  }

  list.innerHTML = view.map(({g, idx})=>{
    const title = g.teams ? safeText(g.teams) : `Í≤ΩÍ∏∞ ${idx+1}`;
    const mainTxt = g.is3 ? `Î©îÏù∏(3): ${fmtOddsArr(g.mainOdds)}` : `Î©îÏù∏(2): ${fmtOddsArr(g.mainOdds)}`;
    const chips = [];
    // ÏòàÏÉÅ ÎßàÏßÑ(Î©îÏù∏)
    if(typeof g.mainMarginPct==="number"){
      const ÌåêÏ†ï = classifyMargin(val("sport"), "main", g.mainMarginPct);
      chips.push(`<span class="paste-chip ${ÌåêÏ†ï.cls==="ok"?"ok":(ÌåêÏ†ï.cls==="mid"?"warn":"warn")}">ÏòàÏÉÅ ${safeText(ÌåêÏ†ï.label)}</span>`);
    }
    chips.push(`<span class="paste-chip ${g.warn?"warn":"ok"}">Ï†ïÌôïÎèÑ ${confLabel(g.conf)}</span>`);
    if(g.extra) chips.push(`<span class="paste-chip warn">Ï∂îÍ∞Ä Ïà´Ïûê ${g.extra}Í∞ú</span>`);
    if(g.ou && g.ou.full) chips.push(`<span class="paste-chip ok">OU ${g.ou.line!=null?g.ou.line:""} ¬∑ ${Number(g.ou.overOdds).toFixed(2)}/${Number(g.ou.underOdds).toFixed(2)}</span>`);
    if(g.hc && g.hc.full) chips.push(`<span class="paste-chip ok">Ìï∏Îîî ${g.hc.line} ¬∑ ${Number(g.hc.a).toFixed(2)}/${Number(g.hc.b).toFixed(2)}</span>`);
    return `
      <div class="paste-item" id="pasteItem_${idx}">
        <div class="left" onclick="onPasteItemClick(${idx})">
          <div class="t">${title}</div>
          <div class="s">${safeText(mainTxt)}</div>
          <div class="chips">${chips.join("")}</div>
          <div class="paste-raw">${safeText(g.raw)}</div>
        </div>
        <div class="right">
          <div class="btns">
            <button class="btn primary mini" type="button" onclick="applyParsedGame(${idx}, true, false); event.stopPropagation();">Ï†ÅÏö©+Í≥ÑÏÇ∞</button>
            <button class="btn secondary mini" type="button" onclick="applyParsedGame(${idx}, false, false); event.stopPropagation();">Ï†ÅÏö©Îßå</button>
            <button class="btn ghost mini" type="button" onclick="togglePasteItem(${idx}); event.stopPropagation();">ÏõêÎ¨∏</button>
          </div>
          <div class="paste-stat" id="pasteStat_${idx}" style="display:none;"></div>
        </div>
      </div>
    `;
  }).join("");

  // Ïù¥ÎØ∏ Ï†ÄÏû•Îêú Ìï≠Î™© ÌëúÏãú
  try{ if(__PASTE_SAVED_SIGS.size===0) buildSavedSigSet(); }catch(e){}
  try{
    __PASTE_MULTI.forEach((g, idx)=>{
      if(!g) return;
      if(pasteAlreadySaved(g)){
        const el = $("pasteItem_"+idx);
        if(el) el.classList.add("is-saved");
        const stat = $("pasteStat_"+idx);
        if(stat){ stat.innerHTML = "Ï†ÄÏû•Îê®"; stat.style.display="block"; }
      }
    });
  }catch(e){}
}

function togglePasteItem(idx){
  const el = $(`pasteItem_${idx}`);
  if(!el) return;
  el.classList.toggle("is-open");
}

function clearPasteList(){
  __PASTE_MULTI = [];
  const wrap = $("pasteListWrap");
  const list = $("pasteList");
  const meta = $("pasteListMeta");
  if(list) list.innerHTML = "";
  if(meta) meta.textContent = "";
  if(wrap) wrap.style.display = "none";
  try{ track("paste_multi_clear", {}); }catch(e){}
}

function parsePasteMulti(){
  const raw = val("pasteInput");
  const t = normalizePasteTextMulti(raw);
  if(!t){
    setPasteBadge("", "ÌÖçÏä§Ìä∏Î•º Î∂ôÏó¨ÎÑ£Ïñ¥Ï§ò.");
    return;
  }
  const blocks = splitPasteBlocks(t);
  const games = [];
  for(const b of blocks){
    const g = parseGameBlock(b);
    if(g) games.push(g);
  }
  if(!games.length){
    // ÌùîÌïú Ïò§ÏûÖÎ†•: ÌôïÎ•†(%) ÎòêÎäî Î∞∞ÎãπÏù¥ ÏïÑÎãå Ïà´ÏûêÎßå Ìè¨Ìï®
    if(/%|ÌçºÏÑºÌä∏|ÌôïÎ•†/i.test(t)){
      setPasteBadge("", "ÌôïÎ•†(%)Ïù¥ ÏïÑÎãàÎùº Î∞∞Îãπ(1.85 Í∞ôÏùÄ Í∞í)Ïù¥ ÌïÑÏöîÌï¥.");
    }else{
      setPasteBadge("", "Í≤ΩÍ∏∞Î•º Ï∞æÏßÄ Î™ªÌñàÏñ¥. (ÌåÄ vs ÌåÄ + Î∞∞Îãπ Ïà´Ïûê Ìè¨Ìï® ÌïÑÏöî)");
    }
    const hint = $("pasteHint");
    if(hint) hint.innerText = "ÌåÅ: Í∞Å Í≤ΩÍ∏∞ÎßàÎã§ ‚ÄòÌåÄA vs ÌåÄB‚Äô ÎòêÎäî Ï§ÑÎ∞îÍøàÏúºÎ°ú Íµ¨Î∂ÑÌï¥Ï§ò. Ïà´ÏûêÎßå ÏûàÏñ¥ÎèÑ ÎèºÏöî. Ïòà: Îß®ÏãúÌã∞ vs Î¶¨Î≤ÑÌíÄ 1.85 3.40 4.20";
    renderPasteList([]);
    return;
  }
  setPasteBadge(`${games.length}Í≤ΩÍ∏∞ Í∞êÏßÄÎê®`, "");
  const hint = $("pasteHint");
  if(hint) hint.innerText = "Î¶¨Ïä§Ìä∏ÏóêÏÑú Í≤ΩÍ∏∞ ÏÑ†ÌÉù ‚Üí ÏûêÎèô ÏûÖÎ†•(ÏÑ†ÌÉù: Í≥ÑÏÇ∞). Ï†ïÌôïÎèÑ ÎÇÆÏùå ÌëúÏãúÍ∞Ä Îú®Î©¥ Ï†ÅÏö© ÌõÑ Ïà´ÏûêÎßå Ìïú Î≤à ÌôïÏù∏!";
  renderPasteList(games);
  try{ track("paste_multi_parse", { count: games.length, main: (SPORT_CFG[val("sport")]||SPORT_CFG.soccer).main }); }catch(e){}
}

function isPasteChainMode(){ const el=$("pasteChainMode"); return el ? el.checked : false; }
function isPasteSkipLow(){ const el=$("pasteSkipLow"); return el ? el.checked : false; }
function getPasteChainCount(){ const el=$("pasteChainCount"); const n = el ? parseInt(el.value,10) : 10; return (isFinite(n)&&n>0)? Math.min(30, Math.max(1,n)) : 10; }

function buildSavedSigSet(){
  try{
    const norm = (x)=>String(x??"").toLowerCase().replace(/\s+/g,"");
    const f = (n)=>{ const v=Number(n); return Number.isFinite(v)?v.toFixed(4):""; };
    const arr = readHistory();
    for(const h of arr){
      if(!h) continue;
      if(h.sig){ __PASTE_SAVED_SIGS.add(h.sig); continue; }
      // Íµ¨Î≤ÑÏ†Ñ ÌûàÏä§ÌÜ†Î¶¨(ÏãúÍ∑∏ÎãàÏ≤ò ÏóÜÎçò ÏãúÏ†à)ÎèÑ ÏµúÎåÄÌïú Î≥µÏõê
      try{
        const mode = h.mainMode ? h.mainMode : (((SPORT_CFG[h.sport]||SPORT_CFG.soccer).main==="3way") ? "3way" : "2way");
        const parts=[norm(h.sport), mode, norm(h.teams)];
        if(mode==="3way"){
          parts.push(f(h.inputs?.main3OddsH), f(h.inputs?.main3OddsD), f(h.inputs?.main3OddsA));
        }else{
          parts.push(f(h.inputs?.main2OddsA), f(h.inputs?.main2OddsB));
        }
        if(h.inputs?.totalLine) parts.push("ou:"+norm(h.inputs.totalLine)+":"+f(h.inputs.overOdds)+":"+f(h.inputs.underOdds));
        if(h.inputs?.handicapLine) parts.push("hc:"+norm(h.inputs.handicapLine)+":"+f(h.inputs.handicapOddsA)+":"+f(h.inputs.handicapOddsB));
        __PASTE_SAVED_SIGS.add(parts.join("|"));
      }catch(e){}
    }
  }catch(e){}
}

function setPasteItemSaved(idx, record){
  const g = __PASTE_MULTI[idx];
  if(!g) return;
  g.__saved = true;
  if(record && record.sig) __PASTE_SAVED_SIGS.add(record.sig);
  const el = $("pasteItem_"+idx);
  if(el) el.classList.add("is-saved");
  const stat = $("pasteStat_"+idx);
  if(stat){
    const m = (record && record.markets && record.markets.main && typeof record.markets.main.marginPct==="number") ? record.markets.main.marginPct : (typeof g.mainMarginPct==="number" ? g.mainMarginPct : null);
    const ev = (record && typeof record.bestEVPct==="number") ? record.bestEVPct : null;
    const parts = [];
    if(m!=null) parts.push(`ÎßàÏßÑ <b>${m.toFixed(2)}%</b>`);
    if(ev!=null) parts.push(`EV <b>${(ev>=0?"+":"-")}${Math.abs(ev).toFixed(2)}%</b>`);
    stat.innerHTML = `Ï†ÄÏû•Îê® ¬∑ ${parts.join(" ¬∑ ")}`;
    stat.style.display = "block";
  }
  // Ïó∞ÏÜç Ï†ÄÏû•/ÌÅ¥Î¶≠ Ï†ÄÏû•ÏúºÎ°ú Ï†ÄÏû•Îêú Í≤ΩÏö∞: Ïò§Îäò ÏàòÏßë Î¨∂ÏùåÏóêÎèÑ ÎàÑÏ†Å
  try{
    if(record && (isPasteChainMode() || __PASTE_CHAIN_RUNNING)){
      pushChainPackFromRecord(record);
    }
  }catch(e){}

}

function pasteAlreadySaved(g){
  if(!g) return false;
  if(g.__saved) return true;
  if(g.sig && __PASTE_SAVED_SIGS.has(g.sig)) return true;
  return false;
}

function applyParsedGame(idx, autoCalc, keepView){
  const g = __PASTE_MULTI[idx];
  if(!g) return;

  // Ïó∞ÏÜç Ï†ÄÏû•(ÎòêÎäî ÎßÅÌÅ¨ Î≥µÏõê) Ïãú: Î©îÏù∏ ÌÉÄÏûÖ Ïò§Î≤ÑÎùºÏù¥Îìú Î∞òÏòÅ
  try{ setMainModeOverride(g.is3 ? "3way" : "2way"); }catch(e){}

  // ÌåÄÎ™Ö Î∞òÏòÅ
  try{ if(g.teams) setVal("teams", g.teams); }catch(e){}

  const is3 = g.is3;
  if(is3){
    setVal("main3OddsH", String(g.mainOdds[0]));
    setVal("main3OddsD", String(g.mainOdds[1]));
    setVal("main3OddsA", String(g.mainOdds[2]));
  }else{
    setVal("main2OddsA", String(g.mainOdds[0]));
    setVal("main2OddsB", String(g.mainOdds[1]));
  }

  if(g.ou && g.ou.full){
    if(g.ou.line != null) setVal("totalLine", String(g.ou.line));
    if(g.ou.overOdds != null) setVal("overOdds", String(g.ou.overOdds));
    if(g.ou.underOdds != null) setVal("underOdds", String(g.ou.underOdds));
  }
  if(g.hc && g.hc.full){
    setVal("handicapLine", String(g.hc.line));
    setVal("handicapOddsA", String(g.hc.a));
    setVal("handicapOddsB", String(g.hc.b));
  }

  // OU/Ìï∏Îîî Í∞êÏßÄ Ïãú Î†àÎ≤® ÏûêÎèô Ï†ÑÌôò ÏòµÏÖò
  const wantsAutoLevel = (function(){ const el=$("pasteAutoLevel"); return el ? el.checked : false; })();
  if(wantsAutoLevel && val("level") === "simple" && ((g.ou && g.ou.full) || (g.hc && g.hc.full))){
    setVal("level", "mid");
    onLevelChange(true);
  }

  try{ prefillLineCompare(); }catch(e){}
  hideResult();
  renderMarginDash();
  saveState();

  try{ track("paste_multi_apply", { idx, auto_calc: autoCalc?1:0, keep_view: keepView?1:0, conf: g.conf, has_ou: g.ou&&g.ou.full?1:0, has_hc: g.hc&&g.hc.full?1:0 }); }catch(e){}

  if(autoCalc){
    try{ calc(); }catch(e){}
    // calc() ÏïàÏóêÏÑú ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû•ÍπåÏßÄ ÏàòÌñâÎê®
    try{ setPasteItemSaved(idx, LAST_RECORD); }catch(e){}
    if(!keepView){
      try{ quickJump('result'); }catch(e){}
    }
  }else{
    if(!keepView){
      try{ quickJump('main'); }catch(e){}
    }
  }
}

function onPasteItemClick(idx){
  const g = __PASTE_MULTI[idx];
  if(!g) return;
  if(isPasteChainMode()){
    if(isPasteSkipLow() && g.conf==="low"){
      toast("Ï†ïÌôïÎèÑ ÎÇÆÏùå Ìï≠Î™©ÏùÄ Ï†úÏô∏ ÏÑ§Ï†ïÏù¥ÏóêÏöî.");
      return;
    }
    if(pasteAlreadySaved(g)){
      setPasteItemSaved(idx, null);
      toast("Ïù¥ÎØ∏ Ï†ÄÏû•Îêú Ìï≠Î™©Ïù¥ÏóêÏöî.");
      return;
    }
    applyParsedGame(idx, true, true);
    return;
  }
  togglePasteItem(idx);
}

function startChainSave(){
  if(__PASTE_CHAIN_RUNNING){
    toast("Ïù¥ÎØ∏ Ïó∞ÏÜç Ï†ÄÏû• Ï§ëÏù¥ÏóêÏöî.");
    return;
  }
  if(!__PASTE_MULTI.length){
    toast("Î®ºÏ†Ä 'Ïó¨Îü¨ Í≤ΩÍ∏∞ ÎßåÎì§Í∏∞'Î°ú Î¶¨Ïä§Ìä∏Î•º ÎßåÎì§Ïñ¥Ï§ò.");
    return;
  }
  if(__PASTE_SAVED_SIGS.size===0) buildSavedSigSet();

  const n = getPasteChainCount();
  __PASTE_CHAIN_RUNNING = true;
  __PASTE_CHAIN_ABORT = false;
  const stopBtn = $("pasteChainStop");
  if(stopBtn) stopBtn.style.display = "inline-flex";

  // ÌòÑÏû¨ Ï†ïÎ†¨ Í∏∞Ï§ÄÏúºÎ°ú Ïù∏Îç±Ïä§ Î™©Î°ù ÏÉùÏÑ±
  const view = __PASTE_MULTI.map((g,i)=>({g,i}));
  if(__PASTE_SORT==="margin"){
    view.sort((a,b)=>{
      const ma = (typeof a.g.mainMarginPct==="number") ? a.g.mainMarginPct : 9999;
      const mb = (typeof b.g.mainMarginPct==="number") ? b.g.mainMarginPct : 9999;
      return ma-mb;
    });
  }
  let targets = view.map(x=>x.i);

  // Ï†ïÌôïÎèÑ ÎÇÆÏùå Ï†úÏô∏(ÏòµÏÖò)
  if(isPasteSkipLow()){
    targets = targets.filter(i => __PASTE_MULTI[i] && __PASTE_MULTI[i].conf!=="low");
  }
  // Ïù¥ÎØ∏ Ï†ÄÏû•Îêú Í≤É Ï†úÏô∏
  targets = targets.filter(i => !pasteAlreadySaved(__PASTE_MULTI[i]));

  const total = Math.min(n, targets.length);
  if(total<=0){
    toast("Ï†ÄÏû•Ìï† Ìï≠Î™©Ïù¥ ÏóÜÏñ¥Ïöî. (Ïù¥ÎØ∏ Ï†ÄÏû•Îê®/Ï†ïÌôïÎèÑ ÎÇÆÏùå Ï†úÏô∏)");
    __PASTE_CHAIN_RUNNING = false;
    if(stopBtn) stopBtn.style.display = "none";
    return;
  }

  const meta = $("pasteListMeta");
  let done = 0;

  const step = ()=>{
    if(__PASTE_CHAIN_ABORT){
      __PASTE_CHAIN_RUNNING = false;
      if(stopBtn) stopBtn.style.display = "none";
      if(meta) meta.textContent = `Ïó∞ÏÜç Ï†ÄÏû• Ï§ëÏßÄÎê® ¬∑ ${done}/${total} Ï†ÄÏû•`;
      toast(`Ïó∞ÏÜç Ï†ÄÏû• Ï§ëÏßÄ (${done}/${total})`);
      return;
    }
    if(done >= total){
      __PASTE_CHAIN_RUNNING = false;
      if(stopBtn) stopBtn.style.display = "none";
      if(meta) meta.textContent = `Ïó∞ÏÜç Ï†ÄÏû• ÏôÑÎ£å ¬∑ ${done}/${total} Ï†ÄÏû•`;
      toast(`Ïó∞ÏÜç Ï†ÄÏû• ÏôÑÎ£å (${done}/${total})`);
      try{ track("paste_chain_done", { done, total }); }catch(e){}
      return;
    }
    const idx = targets[done];
    if(meta) meta.textContent = `Ïó∞ÏÜç Ï†ÄÏû• Ï§ë... ${done+1}/${total}`;
    applyParsedGame(idx, true, true); // keepView=true
    done += 1;
    // UI/Ïä§ÌÜ†Î¶¨ÏßÄ Î∞òÏòÅ Ïó¨Ïú†
    setTimeout(step, 140);
  };

  try{ track("paste_chain_start", { target_total: total, requested: n, sort: __PASTE_SORT }); }catch(e){}
  step();
}

function stopChainSave(){
  if(!__PASTE_CHAIN_RUNNING){
    toast("ÏßÑÌñâ Ï§ëÏù∏ Ïó∞ÏÜç Ï†ÄÏû•Ïù¥ ÏóÜÏñ¥Ïöî.");
    return;
  }
  __PASTE_CHAIN_ABORT = true;
  try{ track("paste_chain_stop", {}); }catch(e){}
}

function togglePasteSort(){
  __PASTE_SORT = (__PASTE_SORT==="margin") ? "input" : "margin";
  const btns = document.querySelectorAll('.paste-list-tools .btn.ghost.mini');
  // Ï≤´ Î≤ÑÌäº ÌÖçÏä§Ìä∏Îßå Î∞îÍøà
  try{
    const head = document.querySelector('.paste-list-tools .btn.ghost.mini');
    if(head) head.textContent = (__PASTE_SORT==="margin") ? "Ï†ïÎ†¨: ÏûÖÎ†•Ïàú" : "Ï†ïÎ†¨: ÎßàÏßÑ ÎÇÆÏùÄÏàú";
  }catch(e){}
  renderPasteList(__PASTE_MULTI);
}


function pct(x){ return (x*100).toFixed(1) + "%"; }
function money(x){
  const n = Math.round(x);
  return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "Ïõê";
}
function expectedValue(stake, p, odds){
  return stake * (p*(odds-1) - (1-p));
}
function quarterKelly(p, odds){
  const b = odds - 1;
  const f = (p*odds - 1) / b;
  const q = f/4;
  return Math.max(0, Math.min(0.25, q));
}

/* 2-way + Ìë∏Ïãú Í∑ºÏÇ¨ (ÏïÑÏãúÏïà ÎùºÏù∏) */
function compute2Way(oddsA, oddsB, pushP){ // pushP: 0~1
  const ia=1/oddsA, ib=1/oddsB;
  const sum = ia+ib;
  const push = Math.max(0, Math.min(0.35, pushP || 0)); // ÏïàÏ†ÑÎ≤îÏúÑ
  const factor = (1 - push);
  const pA = (ia/sum) * factor;
  const pB = (ib/sum) * factor;
  const overAdj = sum / factor;          // push Ìè¨Ìï® Î≥¥Ï†ï Ïò§Î≤ÑÎùºÏö¥Îìú
  const marginPct = (overAdj - 1) * 100; // %
  return { over: overAdj, marginPct, probs:[pA,pB], push };
}

/* 3-way */
function compute3Way(odds1,odds2,odds3){
  const i1=1/odds1, i2=1/odds2, i3=1/odds3;
  const over=i1+i2+i3;
  const p1=i1/over, p2=i2/over, p3=i3/over;
  const marginPct=(over-1)*100;
  return { over, marginPct, probs:[p1,p2,p3] };
}

function classifyMargin(sport, type, marginPct){
  const rule = (MARGIN_RULE[sport] || MARGIN_RULE.soccer)[type] || [5,7,9];
  const [low, mid, high] = rule;
  if(marginPct <= low) return { label:`ÎßàÏßÑ ÎÇÆÏùå (${marginPct.toFixed(2)}%)`, cls:"ok" };
  if(marginPct <= mid) return { label:`Î≥¥ÌÜµ (${marginPct.toFixed(2)}%)`, cls:"mid" };
  if(marginPct <= high) return { label:`Ï£ºÏùò (${marginPct.toFixed(2)}%)`, cls:"mid" };
  return { label:`Í≥†ÎßàÏßÑ (${marginPct.toFixed(2)}%)`, cls:"bad" };
}
function clsToTextColor(cls){
  if(cls==="ok") return "good";
  if(cls==="mid") return "mid";
  return "warn";
}

/* =========================
   +EV ÌîåÎûòÍ∑∏ Ï†ÄÏû• (index ÏûêÎèôÌïÑÌÑ∞Ïö©)
========================= */
function setEvFlag(isPositive){
  const d = todayStr();
  localStorage.setItem("88_ev_date", d);
  localStorage.setItem("88_ev_positive", isPositive ? "1" : "0");
}

/* =========================
   Í≥ÑÏÇ∞ Î©îÏù∏ (Í∏∞Ï°¥ Í∏∞Îä• 100% Ïú†ÏßÄ + ÌôïÏû•)
========================= */
function levelLabel(level){
  return level==="simple" ? "Í∞ÑÎã®" : (level==="mid" ? "Ï§ëÍ∏â" : "Í≥†Í∏â");
}

function calc(){
  const sport = val("sport");
  const level = val("level");
  const cfg = SPORT_CFG[sport] || SPORT_CFG.soccer;
  const is3 = (effectiveMainMode(cfg) === "3way");

  const rows = [];
  const copyLines = [];
  copyLines.push(`[88 Ïª§ÎÆ§ÎãàÌã∞] ${cfg.name} Î∂ÑÏÑù (${levelLabel(level)})`);

  const league = val("league").trim();
  const teams  = val("teams").trim();
  if(league) copyLines.push(`Î¶¨Í∑∏: ${league}`);
  if(teams)  copyLines.push(`Í≤ΩÍ∏∞: ${teams}`);

  // Í≤∞Í≥º/ÌûàÏä§ÌÜ†Î¶¨Ïö© Î©îÌÉÄ
  const record = {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2,7),
    date: todayStr(),
    time: nowTimeStr(),
    sport, level, league, teams,
    mainMode: (effectiveMainMode(cfg) === "3way") ? "3way" : "2way",
    inputs:{},
    markets:{},
    evPositive:false,
    bestEVPct:null
  };

  // GA: Î∂ÑÏÑù ÏãúÏûë
  try{
    track("analysis_start", {
      sport,
      level,
      market_type: (is3 ? "3way" : "2way"),
      odds_count: (is3 ? 3 : 2),
      has_league: !!league,
      has_teams: !!teams
    });
  }catch(e){}


  // ---- Î©îÏù∏ ----
  let mainMargin = null;
  let mainOver = null;
  let mainProbs = null;

  if(!is3){
    const a = parseOdds(val("main2OddsA"));
    const b = parseOdds(val("main2OddsB"));
    if(a==null || b==null){ clearInvalid(); markInvalid(["main2OddsA","main2OddsB"]); return showError("Î©îÏù∏ Î∞∞ÎãπÏùÑ 1.01 Ïù¥ÏÉÅ Ïà´ÏûêÎ°ú ÏûÖÎ†•Ìï¥Ï§ò."); }

    const out = compute2Way(a,b,0);
    mainOver = out.over;
    mainMargin = out.marginPct;
    mainProbs = out.probs;

    const L2 = labels2Way(cfg);
    rows.push([`ÏäπÎ¶¨ ÌôïÎ•†(Î∞∞Îãπ Í∏∞Î∞ò¬∑Ï∂îÏ†ï, ${L2.A})`, pct(out.probs[0])]);
    rows.push([`ÏäπÎ¶¨ ÌôïÎ•†(Î∞∞Îãπ Í∏∞Î∞ò¬∑Ï∂îÏ†ï, ${L2.B})`, pct(out.probs[1])]);
    rows.push(["Ïò§Î≤ÑÎùºÏö¥Îìú(ÎßàÏßÑ Ï∂îÏ†ï)", out.over.toFixed(4)]);

    const ÌåêÏ†ï = classifyMargin(sport,"main",out.marginPct);
    rows.push(["Î©îÏù∏ ÎßàÏßÑ ÌåêÏ†ï", `<span class="${clsToTextColor(ÌåêÏ†ï.cls)}">${ÌåêÏ†ï.label}</span>`]);

    const L2b = labels2Way(cfg);
    copyLines.push(`Î©îÏù∏ Î∞∞Îãπ(${L2b.A}/${L2b.B}): ${a} / ${b}`);

    record.inputs.main2OddsA = val("main2OddsA");
    record.inputs.main2OddsB = val("main2OddsB");
    record.markets.main = { over: out.over, marginPct: out.marginPct };

    if(level !== "simple"){
      const myP = parsePct(val("myProb"));
      const stake = parseMoney(val("stake"));

      if(myP!=null){
        const evPer1 = (myP*(a-1) - (1-myP));
        rows.push([`ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†(${cfg.labels.A})`, pct(myP)]);
        rows.push(["EV(1ÏõêÎãπ)", (evPer1*100).toFixed(2) + "%"]);
        copyLines.push(`ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†(${cfg.labels.A}): ${(myP*100).toFixed(1)}%`);
        if(stake!=null){
          rows.push(["Í∏∞ÎåÄÍ∞í(EV)", money(expectedValue(stake, myP, a))]);
          copyLines.push(`Î≤†ÌåÖÍ∏à: ${money(stake)}`);
        }
        if(level === "adv"){
          const k = quarterKelly(myP, a);
          rows.push(["Í∂åÏû• ÎπÑÏ§ë(Î≥¥ÏàòÏ†Å 1/4 Kelly)", (k*100).toFixed(1) + "%"]);
        }
        rows.push(["ÌåêÎã®", evPer1>0 ? "Î∞∏Î•ò(+EV) Í∞ÄÎä•ÏÑ±" : "Î∞∏Î•ò(-EV) Í∞ÄÎä•ÏÑ±"]);

        record.bestEVPct = evPer1*100;
        record.evPositive = evPer1>0;
        setEvFlag(record.evPositive);
      }else{
        rows.push(["Tip", "Ï§ëÍ∏â/Í≥†Í∏âÏóêÏÑúÎäî 'ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†'ÏùÑ ÏûÖÎ†•ÌïòÎ©¥ EVÍ∞Ä Í≥ÑÏÇ∞Îê©ÎãàÎã§. (ÏÑ†ÌÉùÏÇ¨Ìï≠)"]);
        setEvFlag(false);
      }
    }else{
      setEvFlag(false);
    }
  }else{
    const h = parseOdds(val("main3OddsH"));
    const d = parseOdds(val("main3OddsD"));
    const a = parseOdds(val("main3OddsA"));
    if(h==null || d==null || a==null){ clearInvalid(); markInvalid(["main3OddsH","main3OddsD","main3OddsA"]); return showError("Î©îÏù∏ Î∞∞Îãπ(Ìôà/Î¨¥/ÏõêÏ†ï)ÏùÑ 1.01 Ïù¥ÏÉÅ Ïà´ÏûêÎ°ú ÏûÖÎ†•Ìï¥Ï§ò."); }

    const out = compute3Way(h,d,a);
    mainOver = out.over;
    mainMargin = out.marginPct;
    mainProbs = out.probs;

    rows.push([`ÏäπÎ¶¨ ÌôïÎ•†(Î∞∞Îãπ Í∏∞Î∞ò¬∑Ï∂îÏ†ï, ${cfg.labels.H})`, pct(out.probs[0])]);
    rows.push([`ÏäπÎ¶¨ ÌôïÎ•†(Î∞∞Îãπ Í∏∞Î∞ò¬∑Ï∂îÏ†ï, ${cfg.labels.D})`, pct(out.probs[1])]);
    rows.push([`ÏäπÎ¶¨ ÌôïÎ•†(Î∞∞Îãπ Í∏∞Î∞ò¬∑Ï∂îÏ†ï, ${cfg.labels.A})`, pct(out.probs[2])]);
    rows.push(["Ïò§Î≤ÑÎùºÏö¥Îìú(ÎßàÏßÑ Ï∂îÏ†ï)", out.over.toFixed(4)]);

    const ÌåêÏ†ï = classifyMargin(sport,"main",out.marginPct);
    rows.push(["Î©îÏù∏ ÎßàÏßÑ ÌåêÏ†ï", `<span class="${clsToTextColor(ÌåêÏ†ï.cls)}">${ÌåêÏ†ï.label}</span>`]);

    copyLines.push(`Î©îÏù∏ Î∞∞Îãπ(${cfg.labels.H}/${cfg.labels.D}/${cfg.labels.A}): ${h} / ${d} / ${a}`);

    record.inputs.main3OddsH = val("main3OddsH");
    record.inputs.main3OddsD = val("main3OddsD");
    record.inputs.main3OddsA = val("main3OddsA");
    record.markets.main = { over: out.over, marginPct: out.marginPct };

    if(level !== "simple"){
      const my = parsePctList(val("myProb"));
      const stake = parseMoney(val("stake"));

      if(my){
        const evH = (my[0]*(h-1) - (1-my[0]));
        const evD = (my[1]*(d-1) - (1-my[1]));
        const evA = (my[2]*(a-1) - (1-my[2]));

        rows.push([`ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†(${cfg.labels.H}/${cfg.labels.D}/${cfg.labels.A})`,
          `${pct(my[0])} / ${pct(my[1])} / ${pct(my[2])}`]);

        if(LAST_MYPROB_SUM && Math.abs(LAST_MYPROB_SUM-1) > 0.005){
          rows.push(["ÎÇ¥ ÌôïÎ•† Ìï©Í≥Ñ", `${(LAST_MYPROB_SUM*100).toFixed(1)}% ‚Üí 100%Î°ú ÏûêÎèô Ï†ïÍ∑úÌôî`]);
        }


        rows.push(["EV(Ìôà/Î¨¥/ÏõêÏ†ï, 1ÏõêÎãπ)", `${(evH*100).toFixed(2)}% / ${(evD*100).toFixed(2)}% / ${(evA*100).toFixed(2)}%`]);

        const best = [
          {k:cfg.labels.H, ev:evH, odds:h, p:my[0]},
          {k:cfg.labels.D, ev:evD, odds:d, p:my[1]},
          {k:cfg.labels.A, ev:evA, odds:a, p:my[2]}
        ].sort((x,y)=>y.ev-x.ev)[0];

        rows.push(["Í∞ÄÏû• ÎÜíÏùÄ EV", `${best.k} (${(best.ev*100).toFixed(2)}%)`]);
        if(stake!=null) rows.push(["Í∏∞ÎåÄÍ∞í(EV, ÏµúÍ≥† EV Í∏∞Ï§Ä)", money(expectedValue(stake, best.p, best.odds))]);

        if(level === "adv"){
          rows.push(["Í∂åÏû• ÎπÑÏ§ë(Î≥¥ÏàòÏ†Å 1/4 Kelly, ÏµúÍ≥† EV Í∏∞Ï§Ä)", (quarterKelly(best.p, best.odds)*100).toFixed(1) + "%"]);
        }
        rows.push(["ÌåêÎã®", best.ev>0 ? "Î∞∏Î•ò(+EV) Í∞ÄÎä•ÏÑ±" : "Î∞∏Î•ò(-EV) Í∞ÄÎä•ÏÑ±"]);

        record.bestEVPct = best.ev*100;
        record.evPositive = best.ev>0;
        setEvFlag(record.evPositive);

        copyLines.push(`ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†: ${(my[0]*100).toFixed(1)}% / ${(my[1]*100).toFixed(1)}% / ${(my[2]*100).toFixed(1)}%`);
        if(stake!=null) copyLines.push(`Î≤†ÌåÖÍ∏à: ${money(stake)}`);
      }else{
        rows.push(["Tip", "Ï§ëÍ∏â/Í≥†Í∏âÏóêÏÑúÎäî ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†(Ïòà: 45,28,27)ÏùÑ ÏûÖÎ†•ÌïòÎ©¥ EVÍ∞Ä Í≥ÑÏÇ∞Îê©ÎãàÎã§. (ÏÑ†ÌÉùÏÇ¨Ìï≠)"]);
        setEvFlag(false);
      }
    }else{
      setEvFlag(false);
    }
  }

  // ---- Í≥µÏú†Ïö© Ìïú Ï§Ñ ÏöîÏïΩ(+ Í≥µÏ†ïÎ∞∞Îãπ) ----
  try{
    if(typeof mainMargin === "number" && mainProbs && mainProbs.length){
      const labels = is3
        ? [cfg.labels.H||"H", cfg.labels.D||"D", cfg.labels.A||"A"]
        : [cfg.labels.A||"A", cfg.labels.B||"B"];
      const fair = mainProbs.map(p=> (p>0 ? (1/p) : null));
      const fairText = fair.map(o=> (o && isFinite(o) ? o.toFixed(2) : "-")).join(" / ");
      const evText = (typeof record.bestEVPct !== "number") ? "EV ÎØ∏ÏûÖÎ†•" : (record.bestEVPct>0 ? "+EV Í∞ÄÎä•" : "-EV Í∞ÄÎä•");
      LAST_ONE_LINE = `ÏöîÏïΩ: ÎßàÏßÑ ${mainMargin.toFixed(1)}% ¬∑ Í≥µÏ†ïÎ∞∞Îãπ(${labels.join("/")}) ${fairText} ¬∑ ${evText}`;
      copyLines.push(LAST_ONE_LINE);
    }else{
      LAST_ONE_LINE = "";
    }
  }catch(e){ LAST_ONE_LINE = ""; }

  // ---- Ïò§Î≤ÑÏñ∏Îçî (2-way + Ìë∏Ïãú Í∑ºÏÇ¨) ----
  let ouMargin = null;
  const tLine = val("totalLine").trim();
  const oOdds = parseOdds(val("overOdds"));
  const uOdds = parseOdds(val("underOdds"));
  const myOver = parsePct(val("myOverProb"));
  const ouPushPct = parsePct(val("ouPush")) ?? null; // ÏûÖÎ†• Í∞íÏù¥ %Ïù¥Î©¥ parsePctÍ∞Ä 0~1Î°ú
  // parsePct expects 0~100; but we want % input; ok

  if(tLine && oOdds!=null && uOdds!=null){
    // Ìë∏Ïãú ÌôïÎ•†: ÏûÖÎ†•Í∞í ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ Ï¢ÖÎ™© Í∏∞Î≥∏Í∞í
    let push = ouPushPct;
    if(push==null){
      const cfg2 = SPORT_CFG[sport] || SPORT_CFG.soccer;
      push = (cfg2.defaults.ouPush || 0) / 100;
    }
    const outOU = compute2Way(oOdds, uOdds, push);
    ouMargin = outOU.marginPct;

    rows.push([`Ïò§Î≤Ñ/Ïñ∏Îçî(Í∏∞Ï§Ä ${tLine}) ÏäπÎ¶¨ ÌôïÎ•†(Î∞∞Îãπ Í∏∞Î∞ò¬∑Ï∂îÏ†ï)`,
      `Ïò§Î≤Ñ ${pct(outOU.probs[0])} / Ïñ∏Îçî ${pct(outOU.probs[1])}${outOU.push>0?` / Ìë∏Ïãú ${(outOU.push*100).toFixed(1)}%`:``}`]);
    rows.push([`Ïò§Î≤Ñ/Ïñ∏Îçî Ïò§Î≤ÑÎùºÏö¥Îìú(Î≥¥Ï†ï)`, outOU.over.toFixed(4)]);
    const ÌåêÏ†ïOU = classifyMargin(sport,"ou",outOU.marginPct);
    rows.push([`Ïò§Î≤Ñ/Ïñ∏Îçî ÎßàÏßÑ ÌåêÏ†ï`, `<span class="${clsToTextColor(ÌåêÏ†ïOU.cls)}">${ÌåêÏ†ïOU.label}</span>`]);

    copyLines.push(`Ïò§Î≤ÑÏñ∏Îçî ${tLine}: Ïò§Î≤Ñ ${oOdds} / Ïñ∏Îçî ${uOdds}${outOU.push>0?` (Ìë∏Ïãú Í∑ºÏÇ¨ ${ (outOU.push*100).toFixed(1)}%)`:``}`);

    record.inputs.totalLine = val("totalLine");
    record.inputs.overOdds = val("overOdds");
    record.inputs.underOdds = val("underOdds");
    record.inputs.ouPush = val("ouPush");
    record.markets.ou = { over: outOU.over, marginPct: outOU.marginPct, push: outOU.push };

    if(level === "adv" && myOver!=null){
      const stake = parseMoney(val("stake")) || null;
      // Ìë∏Ïãú Ìè¨Ìï® EV: EV = pWin*(odds-1) - pLose + pPush*0
      const pWin = myOver;
      const pPush = outOU.push; // Í∑ºÏÇ¨
      const pLose = Math.max(0, 1 - pWin - pPush);
      const evPer1 = (pWin*(oOdds-1) - pLose);

      rows.push([`ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†(Ïò§Î≤Ñ)`, pct(myOver)]);
      rows.push([`Ïò§Î≤Ñ EV(1ÏõêÎãπ, Ìë∏Ïãú Í∑ºÏÇ¨)`, (evPer1*100).toFixed(2) + "%"]);
      if(stake!=null) rows.push([`Ïò§Î≤Ñ Í∏∞ÎåÄÍ∞í(EV)`, money(stake * evPer1)]);
      rows.push([`Ïò§Î≤Ñ Í∂åÏû• ÎπÑÏ§ë(1/4 Kelly, Ï∞∏Í≥†)`, (quarterKelly(myOver, oOdds)*100).toFixed(1) + "%"]);
      rows.push([`Ïò§Î≤Ñ ÌåêÎã®`, evPer1>0 ? "Î∞∏Î•ò(+EV) Í∞ÄÎä•ÏÑ±" : "Î∞∏Î•ò(-EV) Í∞ÄÎä•ÏÑ±"]);
    }
  }

  // ---- Ìï∏ÎîîÏ∫° (Ï†ïÎ∞Ä 2-way + Ìë∏Ïãú Í∑ºÏÇ¨) ----
  let hcMargin = null;
  const hLine = val("handicapLine").trim();
  const hOA = parseOdds(val("handicapOddsA"));
  const hOB = parseOdds(val("handicapOddsB"));
  const hcPushPct = parsePct(val("handicapPush")) ?? null;

  if(hLine && hOA!=null && hOB!=null){
    let push = hcPushPct;
    if(push==null){
      const cfg2 = SPORT_CFG[sport] || SPORT_CFG.soccer;
      push = (cfg2.defaults.hcPush || 0) / 100;
    }
    const outHC = compute2Way(hOA, hOB, push);
    hcMargin = outHC.marginPct;

    rows.push([`Ìï∏ÎîîÏ∫°(ÎùºÏù∏ ${hLine}) ÏäπÎ¶¨ ÌôïÎ•†(Î∞∞Îãπ Í∏∞Î∞ò¬∑Ï∂îÏ†ï)`,
      `${cfg.labels.A||"A"} ${pct(outHC.probs[0])} / ${cfg.labels.B||"B"} ${pct(outHC.probs[1])}${outHC.push>0?` / Ìë∏Ïãú ${(outHC.push*100).toFixed(1)}%`:``}`]);
    rows.push([`Ìï∏ÎîîÏ∫° Ïò§Î≤ÑÎùºÏö¥Îìú(Î≥¥Ï†ï)`, outHC.over.toFixed(4)]);
    const ÌåêÏ†ïHC = classifyMargin(sport,"hc",outHC.marginPct);
    rows.push([`Ìï∏ÎîîÏ∫° ÎßàÏßÑ ÌåêÏ†ï`, `<span class="${clsToTextColor(ÌåêÏ†ïHC.cls)}">${ÌåêÏ†ïHC.label}</span>`]);

    copyLines.push(`Ìï∏Îîî ${hLine}: ${cfg.labels.A||"A"} ${hOA} / ${cfg.labels.B||"B"} ${hOB}${outHC.push>0?` (Ìë∏Ïãú Í∑ºÏÇ¨ ${ (outHC.push*100).toFixed(1)}%)`:``}`);

    record.inputs.handicapLine = val("handicapLine");
    record.inputs.handicapOddsA = val("handicapOddsA");
    record.inputs.handicapOddsB = val("handicapOddsB");
    record.inputs.handicapPush = val("handicapPush");
    record.markets.hc = { over: outHC.over, marginPct: outHC.marginPct, push: outHC.push };
  }

  // ---- ÎåÄÏãúÎ≥¥Îìú/ÌûàÏä§ÌÜ†Î¶¨ Î∞òÏòÅ ----
  // (ÌëúÌòÑ/ÌÜµÍ≥ÑÏö©) ÌòÑÏû¨ Í∏∞Î°ùÏùò Î∂ÑÎ•ò Î©îÌÉÄ ‚Äî Í≥ÑÏÇ∞ Î°úÏßÅÏóêÎäî ÏòÅÌñ• ÏóÜÏùå
  record.advice = adviceKeyFromMetrics(record.bestEVPct, record.markets?.main?.marginPct);
  record.sig = (function(){
    // ÏûÖÎ†• ÏãúÍ∑∏ÎãàÏ≤ò(Ï§ëÎ≥µ Î∞©ÏßÄ/Ïó∞ÏÜç Ï†ÄÏû• ÌëúÏãúÏö©) ‚Äî Í≥ÑÏÇ∞Í∞íÏóêÎäî ÏòÅÌñ• ÏóÜÏùå
    const norm = (x)=>String(x??"").toLowerCase().replace(/\s+/g,"");
    const f2 = (n)=>{ const v = Number(n); return Number.isFinite(v) ? v.toFixed(4) : ""; };
    const parts = [];
    parts.push(norm(record.sport));
    parts.push(record.mainMode || "");
    parts.push(norm(record.teams));
    if(record.mainMode==="3way"){
      parts.push(f2(record.inputs.main3OddsH)); parts.push(f2(record.inputs.main3OddsD)); parts.push(f2(record.inputs.main3OddsA));
    }else{
      parts.push(f2(record.inputs.main2OddsA)); parts.push(f2(record.inputs.main2OddsB));
    }
    if(record.inputs.totalLine) parts.push("ou:"+norm(record.inputs.totalLine)+":"+f2(record.inputs.overOdds)+":"+f2(record.inputs.underOdds));
    if(record.inputs.handicapLine) parts.push("hc:"+norm(record.inputs.handicapLine)+":"+f2(record.inputs.handicapOddsA)+":"+f2(record.inputs.handicapOddsB));
    return parts.join("|");
  })();

  LAST_RECORD = record;

  renderResult(cfg.name, level, rows, copyLines);
  renderMarginDash({sport, main:mainMargin, ou:ouMargin, hc:hcMargin});


  // GA: Î∂ÑÏÑù ÏôÑÎ£å
  try{
    const p = {
      sport,
      level,
      market_type: (is3 ? "3way" : "2way"),
      odds_count: (is3 ? 3 : 2),
      ev_positive: record.evPositive ? 1 : 0
    };
    if (typeof mainMargin === "number") p.main_margin_pct = +mainMargin.toFixed(4);
    if (typeof mainOver === "number") p.main_overround = +mainOver.toFixed(6);
    if (typeof ouMargin === "number") p.ou_margin_pct = +ouMargin.toFixed(4);
    if (typeof hcMargin === "number") p.hc_margin_pct = +hcMargin.toFixed(4);
    if (typeof record.bestEVPct === "number") p.best_ev_pct = +record.bestEVPct.toFixed(4);
    track("analysis_complete", p);
  }catch(e){}

  // ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû•
  addHistory(record);

  // TOP3 Í∞±Ïã†
  renderTop3();

  const st = saveState();
  maybePushSnapshot(st, true);
  renderSnaps();

  // Î∂ÑÏÑù ÏôÑÎ£å Ïù¥ÌõÑ(1Ïùº 1Ìöå) Ï∂îÏ≤ú ÌåùÏóÖ ÎÖ∏Ï∂ú
  try{ maybeShowAdPopupAfterComplete(); }catch(e){}
}

/* =========================
   Í≤∞Í≥º Î†åÎçî(Í∏∞Ï°¥ Ïú†ÏßÄ)
========================= */
function renderResult(sportName, level, rows, copyLines){
  const box = $("result");

  // ---- ÏöîÏïΩ Ïπ¥Îìú(ÏÉÅÎã®) Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú ----
  const clean = (x)=>String(x ?? "").replace(/<[^>]*>/g,"").trim();
  const num = (x)=>{
    const t = clean(x).replace(/,/g,"").replace("%","");
    const n = parseFloat(t);
    return Number.isFinite(n) ? n : null;
  };

  const overRow = rows.find(([k])=>k==="Ïò§Î≤ÑÎùºÏö¥Îìú(ÎßàÏßÑ Ï∂îÏ†ï)");
  const over = overRow ? num(overRow[1]) : null;
  const marginPct = (over!=null) ? (over - 1) * 100 : null;

  // Î©îÏù∏ ÎßàÏßÑ ÌåêÏ†ï(ÎùºÎ≤®/ÏÉâÏÉÅ) Ï∂îÏ∂ú
  let marginLabel = null;
  let marginChip = "mid";
  const mRow = rows.find(([k])=>k==="Î©îÏù∏ ÎßàÏßÑ ÌåêÏ†ï");
  if(mRow){
    const raw = String(mRow[1] ?? "");
    marginLabel = clean(raw);
    const clsMatch = raw.match(/class="([^"]+)"/);
    const tcls = clsMatch ? clsMatch[1] : "";
    if(tcls.includes("good")) marginChip = "ok";
    else if(tcls.includes("warn")) marginChip = "bad";
    else marginChip = "mid";
  }

  // ÏãúÏû• ÏµúÍ≥† ÌôïÎ•†(Î©îÏù∏) Ï∂îÏ∂ú
  const probRows = rows.filter(([k])=>String(k).includes("ÏäπÎ¶¨ ÌôïÎ•†(Î∞∞Îãπ Í∏∞Î∞ò¬∑Ï∂îÏ†ï"));
  // FAIR_ODDS_KPI
  let maxProb = null;
  try{
    const pr = probRows.map(r=>({k:clean(r[0]), v:num(r[1])})).filter(x=>x.v!=null);
    if(pr.length) maxProb = pr.reduce((a,b)=> (a.v>b.v?a:b)).v;
  }catch(e){}
  let fairOdds = null;
  try{
    const fr = rows.find(([k])=>String(k).includes("Í≥µÏ†ïÎ∞∞Îãπ"));
    if(fr){
      const s = clean(fr[1]);
      const mm = s.match(/([0-9]+\.[0-9]+)/);
      if(mm) fairOdds = mm[1];
    }
  }catch(e){}

  let topProb = null;
  probRows.forEach(([k,v])=>{
    const p = num(v);
    if(p==null) return;
    const m = String(k).match(/,\s*([^)]+)\)/);
    const label = m ? m[1] : String(k);
    if(!topProb || p > topProb.p) topProb = { label, p };
  });

  // EV Ï∂îÏ∂ú(Í≥†Í∏âÎ™®ÎìúÏóêÏÑúÎßå Ï°¥Ïû¨Ìï† Ïàò ÏûàÏùå)
  const evRow = rows.find(([k])=>k==="EV(1ÏõêÎãπ)");
  const evPct = evRow ? num(evRow[1]) : null;

  // Î∞∞ÏßÄ(ÏöîÏïΩ)
  let primary = { cls: marginChip, text: marginLabel ? `Î©îÏù∏ ÎßàÏßÑ: ${marginLabel}` : "Í≤∞Í≥º ÏöîÏïΩ" };
  let secondary = null;

  if(evPct!=null){
    primary = { cls: (evPct>=0 ? "ok" : "bad"), text: `Î∞∏Î•ò(${evPct>=0?"+":"-"}EV) ${Math.abs(evPct).toFixed(2)}%` };
    if(marginLabel){
      secondary = { cls: marginChip, text: `Î©îÏù∏ ÎßàÏßÑ: ${marginLabel}${marginPct!=null ? ` (${marginPct.toFixed(1)}%)` : ""}` };
    }
  }


  // ÌïúÏ§Ñ Í≤∞Î°†(ÌëúÌòÑÏö©: Î°úÏßÅÏùÄ Î≥ÄÍ≤ΩÌïòÏßÄ ÏïäÍ≥†, Í≥ÑÏÇ∞Îêú Í∞íÏúºÎ°úÎßå ÏïàÎÇ¥)
  let conclusion = { cls:"warn", icon:"‚ö†Ô∏è", text:"Ï£ºÏùò ¬∑ ÏûÖÎ†•Í∞í/Í∑ºÍ±∞Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî" };
  if(evPct!=null){
    if(evPct >= 2){
      conclusion = { cls:"good", icon:"‚úÖ", text:`Ï∂îÏ≤ú ¬∑ +EV ${evPct.toFixed(2)}%` };
    }else if(evPct >= 0){
      conclusion = { cls:"warn", icon:"‚ö†Ô∏è", text:`Ï£ºÏùò ¬∑ ÏÜåÌè≠ +EV ${evPct.toFixed(2)}%` };
    }else{
      conclusion = { cls:"bad", icon:"‚õî", text:`PASS ¬∑ -EV ${Math.abs(evPct).toFixed(2)}%` };
    }
  }else if(marginPct!=null){
    if(marginPct <= 3){
      conclusion = { cls:"good", icon:"‚úÖ", text:`Ï∂îÏ≤ú ¬∑ ÎßàÏßÑ ÎÇÆÏùå ${marginPct.toFixed(1)}%` };
    }else if(marginPct <= 6){
      conclusion = { cls:"warn", icon:"‚ö†Ô∏è", text:`Ï£ºÏùò ¬∑ ÎßàÏßÑ Î≥¥ÌÜµ ${marginPct.toFixed(1)}%` };
    }else{
      conclusion = { cls:"bad", icon:"‚õî", text:`PASS ¬∑ ÎßàÏßÑ ÎÜíÏùå ${marginPct.toFixed(1)}%` };
    }
  }
  const adviceKey = (conclusion.cls==="good") ? "rec" : (conclusion.cls==="bad" ? "pass" : "caution");
  const trustHtml = buildTrustLineHtml(adviceKey);
  const canMark = !!(LAST_RECORD && LAST_RECORD.id);
  const reason = (()=>{
    const parts = [];
    if(evPct != null) parts.push(`EV ${(evPct>=0?"+":"")+evPct.toFixed(2)}%`);
    if(marginPct != null) parts.push(`ÎßàÏßÑ ${marginPct.toFixed(1)}%`);
    if(topProb) parts.push(`ÏãúÏû• ${topProb.label} ${topProb.p.toFixed(1)}%`);

    if(!parts.length) return "";

    let tail = "";
    if(evPct != null){
      if(evPct >= 2) tail = " ¬∑ Î∞∏Î•ò Íµ¨Í∞Ñ";
      else if(evPct >= 0) tail = " ¬∑ ÏÜåÌè≠ Î∞∏Î•ò";
      else tail = " ¬∑ -EV";
    }else if(marginPct != null){
      if(marginPct <= 3) tail = " ¬∑ ÎßàÏßÑ ÎÇÆÏùå";
      else if(marginPct <= 6) tail = " ¬∑ ÎßàÏßÑ Î≥¥ÌÜµ";
      else tail = " ¬∑ ÎßàÏßÑ ÎÜíÏùå";
    }
    return "Í∑ºÍ±∞: " + parts.join(" ¬∑ ") + tail;
  })();


    const simpleHero = `
    <div class="kpiHero">
      <div class="kpiGrid">
        <div class="kpiItem">
          <div class="kpiLabel">ÎßàÏßÑ</div>
          <div class="kpiValue">${marginPct!=null ? marginPct.toFixed(1)+"%" : "-"}</div>
        </div>
        <div class="kpiItem">
          <div class="kpiLabel">EV</div>
          <div class="kpiValue">${evPct!=null ? ((evPct>=0?"+":"-")+Math.abs(evPct).toFixed(2)+"%") : "-"}</div>
        </div>
        <div class="kpiItem">
          <div class="kpiLabel">ÏµúÍ≥†ÌôïÎ•†</div>
          <div class="kpiValue">${maxProb!=null ? maxProb.toFixed(1)+"%" : "-"}</div>
        </div>
        <div class="kpiItem">
          <div class="kpiLabel">Í≥µÏ†ïÎ∞∞Îãπ</div>
          <div class="kpiValue">${fairOdds!=null ? fairOdds : "-"}</div>
        </div>
      </div>
      <div class="kpiNote">Í∞ÑÎã® Î†àÎ≤®ÏùÄ <b>Î©îÏù∏</b>Îßå Í∏∞Ï§ÄÏúºÎ°ú Îπ†Î•¥Í≤å ÏöîÏïΩÌï©ÎãàÎã§. OU/Ìï∏ÎîîÎäî Ï§ëÍ∏âÎ∂ÄÌÑ∞ ÌôïÏù∏ÌïòÏÑ∏Ïöî.</div>
    </div>
  `;
  const hero = (level === "simple") ? simpleHero : `

    <div class="resultHero">
      <div class="heroTop">
        <div class="heroText">
          <div class="heroTitle">${sportName} ¬∑ ${levelLabel(level)} Í≤∞Í≥º</div>
          <div class="heroSub">ÏûÖÎ†•Í∞í Í∏∞Î∞ò ÏöîÏïΩ ¬∑ ÏïÑÎûò ÏÉÅÏÑ∏ÌëúÎ°ú Í∑ºÍ±∞Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî</div>
        </div>
        <div class="heroRight">
          <div class="heroBadges">
            <span class="chip big ${primary.cls}">${primary.text}</span>
            ${secondary ? `<span class="chip ${secondary.cls}">${secondary.text}</span>` : ``}
          </div>
          <div class="heroConclusion ${conclusion.cls}">
            <span class="cIcon">${conclusion.icon}</span>
            <span class="cText">${conclusion.text}</span>
          </div>
          <div class="trustLine">${trustHtml}</div>
          ${reason ? `<div class="heroReason">${reason}</div>` : ``}
          <div class="outcomeBar" ${canMark ? "" : "style=\"display:none;\""}>
            <button class="oBtn" type="button" onclick="markOutcome('W')">‚úÖ Ï†ÅÏ§ë</button>
            <button class="oBtn" type="button" onclick="markOutcome('L')">‚ùå ÎØ∏Ï†ÅÏ§ë</button>
            <button class="oBtn" type="button" onclick="markOutcome('V')">‚ö™ Ï∑®ÏÜå</button>
            <button class="oBtn" type="button" onclick="markOutcome('')">‚Ü©Ô∏é ÎØ∏Í∏∞Î°ù</button>
          </div>
        </div>
      </div>

      <div class="heroStats">
        <div class="statCard">
          <div class="statK">Î©îÏù∏ ÎßàÏßÑ</div>
          <div class="statV">${marginPct!=null ? marginPct.toFixed(1)+"%" : "‚Äî"}</div>
          <div class="statS">${over!=null ? "Ïò§Î≤ÑÎùºÏö¥Îìú "+over.toFixed(4) : "Ïò§Î≤ÑÎùºÏö¥Îìú ‚Äî"}</div>
        </div>

        <div class="statCard">
          <div class="statK">ÏãúÏû• ÏµúÍ≥†ÌôïÎ•†</div>
          <div class="statV">${topProb ? `${topProb.label} ${topProb.p.toFixed(1)}%` : "‚Äî"}</div>
          <div class="statS">Î∞∞Îãπ Ïó≠Ïàò Ï†ïÍ∑úÌôî</div>
        </div>

        <div class="statCard">
          <div class="statK">EV</div>
          <div class="statV">${evPct!=null ? ((evPct>=0?"+":"")+evPct.toFixed(2)+"%") : "ÎØ∏ÏûÖÎ†•"}</div>
          <div class="statS">${evPct!=null ? "ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•† Í∏∞Ï§Ä" : "Í≥†Í∏âÎ™®ÎìúÏóêÏÑú ÏûÖÎ†•"}</div>
        </div>
      </div>
    </div>
  
`;

  const html = rows.map(([k,v])=>{
    // vÍ∞Ä HTML Ìè¨Ìï®Ìï† Ïàò ÏûàÏúºÎãà Í∑∏ÎåÄÎ°ú
    let cls = "";
    const s = String(v);
    if(k.includes("ÌåêÎã®") && s.includes("-EV")) cls = "warn";
    if(k.includes("ÌåêÎã®") && s.includes("+EV")) cls = "good";
    return `<div class="kv"><div class="k">${k}</div><div class="v ${cls}">${v}</div></div>`;
  }).join("");

  // v2.1: Í≤∞Í≥º ÏòÅÏó≠ÏùÑ 'ÌÉ≠/Ìå®ÎÑê' Ïª¥Ìè¨ÎÑåÌä∏Î°ú Í≥†Ï†ï(HTML Íµ¨Ï°∞ÍπåÏßÄ ÌÜµÏùº)
  const tpl = document.getElementById("tplResultCard");
  if(tpl && tpl.content){
    box.innerHTML = "";
    const frag = tpl.content.cloneNode(true);
    const sum = frag.querySelector('[data-r-panel="summary"]');
    const det = frag.querySelector('[data-r-panel="detail"]');
    const meta = frag.querySelector('#resultMeta');

    const metaTxt = (evPct!=null)
      ? `EV ${(evPct>=0?"+":"")}${evPct.toFixed(2)}%`
      : (marginPct!=null ? `ÎßàÏßÑ ${marginPct.toFixed(1)}%` : "");
    if(meta) meta.textContent = metaTxt;

    if(sum) sum.innerHTML = hero;
    if(det) det.innerHTML = `
      <div class="detailHead">ÏÉÅÏÑ∏ ÏßÄÌëú</div>
      ${html}
      <hr class="sep">
      <div class="resultNote" style="font-size:12px;color:#9a9a9a;line-height:1.5;">
        ‚Äª ‚ÄúÏäπÎ¶¨ ÌôïÎ•†(Î∞∞Îãπ Í∏∞Î∞ò¬∑Ï∂îÏ†ï)‚ÄùÏùÄ Î∞∞Îãπ Ïó≠ÏàòÎ•º Ï†ïÍ∑úÌôîÌïú Í∞í(ÏãúÏû• Í∏∞Î∞ò Ï∂îÏ†ï)ÏûÖÎãàÎã§.<br>
        ‚Äª EV/ÎπÑÏ§ëÏùÄ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú ‚ÄúÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†‚Äù Í∏∞Î∞òÏùò Ï∞∏Í≥† ÏßÄÌëúÏù¥Î©∞ ÏäπÎ•†ÏùÑ Î≥¥Ïû•ÌïòÏßÄ ÏïäÏäµÎãàÎã§.<br>
        ‚Äª ÏïÑÏãúÏïà(Ìë∏Ïãú) Í∑ºÏÇ¨Îäî ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú Ìë∏Ïãú ÌôïÎ•†(ÎòêÎäî Ï¢ÖÎ™© Í∏∞Î≥∏Í∞í)Î°ú Í∑ºÏÇ¨Ìï©ÎãàÎã§.
      </div>
    `;
    box.appendChild(frag);
    initResultTabs(box);
  }else{
    // (fallback) ÌÖúÌîåÎ¶øÏù¥ ÏóÜÏùÑ Îïå Í∏∞Ï°¥ Î†åÎçî
    box.innerHTML = `
      ${hero}
      <div class="detailHead">ÏÉÅÏÑ∏ ÏßÄÌëú</div>
      ${html}
      <hr class="sep">
      <div style="font-size:12px;color:#9a9a9a;line-height:1.5;">
        ‚Äª ‚ÄúÏäπÎ¶¨ ÌôïÎ•†(Î∞∞Îãπ Í∏∞Î∞ò¬∑Ï∂îÏ†ï)‚ÄùÏùÄ Î∞∞Îãπ Ïó≠ÏàòÎ•º Ï†ïÍ∑úÌôîÌïú Í∞í(ÏãúÏû• Í∏∞Î∞ò Ï∂îÏ†ï)ÏûÖÎãàÎã§.<br>
        ‚Äª EV/ÎπÑÏ§ëÏùÄ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú ‚ÄúÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†‚Äù Í∏∞Î∞òÏùò Ï∞∏Í≥† ÏßÄÌëúÏù¥Î©∞ ÏäπÎ•†ÏùÑ Î≥¥Ïû•ÌïòÏßÄ ÏïäÏäµÎãàÎã§.<br>
        ‚Äª ÏïÑÏãúÏïà(Ìë∏Ïãú) Í∑ºÏÇ¨Îäî ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú Ìë∏Ïãú ÌôïÎ•†(ÎòêÎäî Ï¢ÖÎ™© Í∏∞Î≥∏Í∞í)Î°ú Í∑ºÏÇ¨Ìï©ÎãàÎã§.
      </div>
    `;
  }
  box.style.display = "block";
  const dock = document.getElementById("resultDock");
  if(dock) dock.style.display = "flex";

  // Ï°∞Í±¥Î∂Ä CTA Í∞ïÌôî: ÎßàÏßÑ ÎÇÆÏùå or +EVÏùº ÎïåÎßå ÏóÖÏ≤¥ Î≤ÑÌäºÏùÑ Îçî Í∞ïÌïòÍ≤å
  try{
    const vbtn = document.querySelector('a[data-cta="analysis_to_vendors"]');
    if(vbtn && LAST_RECORD && LAST_RECORD.markets && LAST_RECORD.markets.main){
      const m = +LAST_RECORD.markets.main.marginPct;
      const rule = ((MARGIN_RULE[LAST_RECORD.sport] || MARGIN_RULE.soccer).main || [5,7,9]);
      const isLow = isFinite(m) && (m <= rule[0]);
      const isBoost = !!LAST_RECORD.evPositive || isLow;
      vbtn.classList.remove("gold","secondary","primary");
      vbtn.classList.add(isBoost ? "gold" : "secondary");
      vbtn.textContent = isBoost ? "Ï∂îÏ≤ú ÏóÖÏ≤¥ Ïπ¥Îìú" : "ÏóÖÏ≤¥ Ïπ¥Îìú";
    }
  }catch(e){}

  copyLines.push(`ÎßÅÌÅ¨: ${getShareLink()}`);
  LAST_TEXT = copyLines.join("\n") + "\n\n" + rows.map(r=>`${r[0]}: ${String(r[1]).replace(/<[^>]*>/g,"")}`).join("\n");
}

// v2.1: Í≤∞Í≥º ÌÉ≠(ÏöîÏïΩ/ÏÉÅÏÑ∏) ‚Äî Íµ¨Ï°∞/ÎèôÏûë ÌÜµÏùº
function initResultTabs(root){
  if(!root) return;
  const wrap = root.querySelector('[data-role="result"]');
  if(!wrap || wrap.__tabsBound) return;
  wrap.__tabsBound = true;

  const tabs = Array.from(wrap.querySelectorAll('[data-r-tab]'));
  const panels = Array.from(wrap.querySelectorAll('[data-r-panel]'));
  if(!tabs.length || !panels.length) return;

  function setTab(name){
    tabs.forEach(btn=>{
      const on = btn.getAttribute('data-r-tab') === name;
      btn.classList.toggle('on', on);
      btn.setAttribute('aria-selected', on ? 'true' : 'false');
      btn.tabIndex = on ? 0 : -1;
    });
    panels.forEach(p=>{
      const on = p.getAttribute('data-r-panel') === name;
      p.hidden = !on;
    });
  }

  setTab('summary');

  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=> setTab(btn.getAttribute('data-r-tab')));
    btn.addEventListener('keydown', (e)=>{
      if(e.key !== 'ArrowLeft' && e.key !== 'ArrowRight') return;
      e.preventDefault();
      const i = tabs.indexOf(document.activeElement);
      if(i < 0) return;
      const ni = (e.key === 'ArrowRight') ? (i+1) % tabs.length : (i-1+tabs.length) % tabs.length;
      tabs[ni].focus();
    });
  });
}

function showError(msg){
  const dock = document.getElementById("resultDock");
  if(dock) dock.style.display = "none";
  const box = $("result");
  box.innerHTML = `<div class="kv"><div class="k">ÏïàÎÇ¥</div><div class="v warn">${msg}</div></div>`;
  box.style.display = "block";
  LAST_TEXT = `[88 Ïª§ÎÆ§ÎãàÌã∞] ÏïàÎÇ¥\n${msg}\nÎßÅÌÅ¨: ${getShareLink()}`;

  try{
    const reason = String(msg||"").replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim().slice(0,80);
    track("analysis_error", { reason });
  }catch(e){}
}
function hideResult(){
  const dock = document.getElementById("resultDock");
  if(dock) dock.style.display = "none";
  const box = $("result");
  box.style.display = "none";
  box.innerHTML = "";
  LAST_TEXT = "";
}
function resetAll(){
  [
    "league","teams",
    "main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA",
    "myProb","stake",
    "handicapLine","handicapOddsA","handicapOddsB","handicapPush",
    "totalLine","overOdds","underOdds","ouPush","myOverProb"
  ].forEach(id=>{ const el=$(id); if(el) el.value=""; });

  hideResult();
  localStorage.removeItem(LS_KEY);
  setEvFlag(false);
  renderMarginDash();
  toast("Ï¥àÍ∏∞Ìôî ÏôÑÎ£å");
}

/* =========================
   Î≥µÏÇ¨/Í≥µÏú† (Í∏∞Ï°¥ Ïú†ÏßÄ)
========================= */
async function copyResult(){
  if(!LAST_TEXT) return showError("Î®ºÏ†Ä 'Í≥ÑÏÇ∞ÌïòÍ∏∞'Î•º ÎàåÎü¨ Í≤∞Í≥ºÎ•º ÎßåÎì† Îí§ Î≥µÏÇ¨Ìï† Ïàò ÏûàÏñ¥Ïöî.");
  try{
    await navigator.clipboard.writeText(LAST_TEXT);
    toast("Í≤∞Í≥ºÍ∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.");
  }catch(e){
    prompt("ÏïÑÎûò ÎÇ¥Ïö©ÏùÑ Î≥µÏÇ¨ÌïòÏÑ∏Ïöî:", LAST_TEXT);
  }
}
async function shareResult(){
  if(!LAST_TEXT) return showError("Î®ºÏ†Ä 'Í≥ÑÏÇ∞ÌïòÍ∏∞'Î•º ÎàåÎü¨ Í≤∞Í≥ºÎ•º ÎßåÎì† Îí§ Í≥µÏú†Ìï† Ïàò ÏûàÏñ¥Ïöî.");
  try{
    if(navigator.share){
      await navigator.share({ title:"88 Ïª§ÎÆ§ÎãàÌã∞ Î∂ÑÏÑù Í≤∞Í≥º", text: LAST_TEXT });
    }else{
      await copyResult();
    }
  }catch(e){}
}

/* =========================
   UX Add-ons (non-breaking)
========================= */
function updateSaveBadge(ts){
  const el = document.getElementById("saveBadge");
  if(!el) return;
  if(!ts){
    el.innerHTML = `<span class="dot"></span>ÏûêÎèô Ï†ÄÏû•`;
    return;
  }
  const d = new Date(ts);
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  el.innerHTML = `<span class="dot"></span>ÏûêÎèô Ï†ÄÏû• ¬∑ ${hh}:${mm}`;
}

function toggleMiniGuide(){
  const body = document.getElementById("miniGuideBody");
  const pill = document.getElementById("miniGuidePill");
  if(!body || !pill) return;
  const isOpen = body.style.display === "block";
  const next = !isOpen;
  body.style.display = next ? "block" : "none";
  pill.textContent = next ? "Îã´Í∏∞" : "Ïó¥Í∏∞";
  pill.setAttribute("aria-expanded", next ? "true" : "false");
  try{ localStorage.setItem("88_mini_guide_open", next ? "1":"0"); }catch(e){}
}

function restoreMiniGuide(){
  try{
    const v = localStorage.getItem("88_mini_guide_open");
    const body = document.getElementById("miniGuideBody");
    const pill = document.getElementById("miniGuidePill");
    if(!body || !pill) return;
    const open = v === "1";
    body.style.display = open ? "block" : "none";
    pill.textContent = open ? "Îã´Í∏∞" : "Ïó¥Í∏∞";
    pill.setAttribute("aria-expanded", open ? "true" : "false");
  }catch(e){}
}

function clearInvalid(){
  document.querySelectorAll(".is-invalid").forEach(el=>el.classList.remove("is-invalid"));
}
function markInvalid(ids){
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.add("is-invalid");
  });
  const first = document.querySelector(".is-invalid");
  if(first){
    try{ first.scrollIntoView({behavior:"smooth", block:"center"}); }catch(e){}
  }
}

function quickJump(which){
  if(which==="top"){
    try{ window.scrollTo({top:0, behavior:"smooth"}); }catch(e){ window.scrollTo(0,0); }
    return;
  }
  const map = {
    main: "mainBox",
    total: "totalBox",
    handicap: "handicapBox",
    result: "result",
    history: "historyList"
  };
  const id = map[which];
  const el = document.getElementById(id);
  if(!el) return;
  if(which==="total"){ setCollapsed("totalBody", false); }
  if(which==="handicap"){ setCollapsed("handicapBody", false); }
  try{ el.scrollIntoView({behavior:"smooth", block:"start"}); }catch(e){}
}

// v2.1: ÏÉÅÎã® ÏÑπÏÖò ÌÉ≠Î∞î(Î©îÏù∏/OU/Ìï∏Îîî/Í≤∞Í≥º/ÌûàÏä§ÌÜ†Î¶¨) ‚Äî HTML Íµ¨Ï°∞/ÎèôÏûë ÌÜµÏùº
function setAppTabActive(which){
  const bar = document.getElementById("appTabbar");
  if(!bar) return;
  bar.querySelectorAll(".st-tab").forEach(btn=>{
    const on = btn.getAttribute("data-jump") === which;
    btn.classList.toggle("on", on);
    btn.setAttribute("aria-selected", on ? "true" : "false");
  });
}

function initAppTabbar(){
  const bar = document.getElementById("appTabbar");
  if(!bar || bar.__bound) return;
  bar.__bound = true;

  bar.addEventListener("click", (e)=>{
    const btn = e.target.closest(".st-tab[data-jump]");
    if(!btn) return;
    const which = btn.getAttribute("data-jump");
    if(!which) return;
    setAppTabActive(which);
    quickJump(which);
  });

  // Ïä§ÌÅ¨Î°§ ÏúÑÏπòÏóê Îî∞Îùº ÌòÑÏû¨ ÏÑπÏÖòÏùÑ ÏûêÎèô ÌïòÏù¥ÎùºÏù¥Ìä∏
  try{
    const secMap = {
      main: document.getElementById("mainBox"),
      total: document.getElementById("totalBox"),
      handicap: document.getElementById("handicapBox"),
      result: document.getElementById("result"),
      history: document.getElementById("historyList")
    };
    const keys = Object.keys(secMap).filter(k=>secMap[k]);
    if(!keys.length) return;

    const io = new IntersectionObserver((entries)=>{
      // Í∞ÄÏû• ÎßéÏù¥ Î≥¥Ïù¥Îäî ÏÑπÏÖò ÏÑ†ÌÉù
      let best = null;
      entries.forEach(en=>{
        if(!en.isIntersecting) return;
        const k = keys.find(x=>secMap[x] === en.target);
        if(!k) return;
        const score = en.intersectionRatio;
        if(!best || score > best.score) best = { which:k, score };
      });
      if(best && best.which) setAppTabActive(best.which);
    }, {
      root: null,
      threshold: [0.08, 0.18, 0.28],
      rootMargin: "-45% 0px -50% 0px"
    });

    keys.forEach(k=>{ try{ io.observe(secMap[k]); }catch(e){} });
  }catch(e){}
}

function openShareCard(){
  const modal = document.getElementById("shareCardModal");
  const resultBox = document.getElementById("result");
  if(!modal) return;
  if(!resultBox || resultBox.style.display==="none" || !resultBox.innerText.trim()){
    return showError("Î®ºÏ†Ä 'Í≥ÑÏÇ∞ÌïòÍ∏∞'Î°ú Í≤∞Í≥ºÎ•º ÎßåÎì† Îí§ Í≥µÏú† Ïπ¥ÎìúÎ•º ÏÉùÏÑ±Ìï† Ïàò ÏûàÏñ¥Ïöî.");
  }
  try{ updateBundlePromo(items); }catch(e){}
  modal.style.display = "flex";
  drawShareCard();
  // Normalize share event names across the site (index ‚Üî analysis)
  try{ track("share_open", { page_path: location.pathname }); }catch(e){}
}
function closeShareCard(){
  const modal = document.getElementById("shareCardModal");
  if(modal) modal.style.display = "none";
}

function getShareLink(){
  try{
    const u = new URL(location.origin + location.pathname);
    const st = buildPermalinkState();
    if(st) u.searchParams.set("st", st);

    // UTMÏùÄ Ï†ÄÏû•Îêú Í∞íÏùÑ Ïö∞ÏÑ† Î∂ôÏó¨ÏÑú Í≥µÏú† Î£®ÌîÑ Ïú†ÏßÄ
    try{
      if(typeof getUtmQuery === "function"){
        const qs = getUtmQuery();
        if(qs){
          const sp = new URLSearchParams(qs.replace(/^\?/,""));
          sp.forEach((v,k)=>{ if(!u.searchParams.get(k)) u.searchParams.set(k,v); });
        }
      }
    }catch(e){}

    return u.toString();
  }catch(e){
    return location.origin + location.pathname;
  }
}

function extractResultLines(){
  const box = document.getElementById("result");
  if(!box) return [];
  const kvs = box.querySelectorAll(".kv");
  const lines = [];
  kvs.forEach(kv=>{
    const k = kv.querySelector(".k")?.innerText?.trim();
    const v = kv.querySelector(".v")?.innerText?.trim();
    if(k && v) lines.push(`${k}: ${v}`);
  });
  return lines;
}

function roundRect(ctx, x, y, w, h, r, fill, stroke){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}


function getActiveTheme(){
  try{
    const t = document.documentElement.dataset.theme;
    if(t === "light" || t === "dark") return t;
  }catch(e){}
  return (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) ? "dark" : "light";
}
function getCssVar(name, fallback){
  try{
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    return v || fallback || "";
  }catch(e){ return fallback || ""; }
}
function normalizeRgb(v, fallback){
  let s = String(v||"").trim();
  if(!s) s = String(fallback||"");
  s = s.replace(/[()]/g,"").trim();
  // allow forms: "245,226,122" or "rgb(245 226 122)"
  const nums = s.match(/\d+/g);
  if(!nums || nums.length < 3) return String(fallback||"245,226,122");
  return `${nums[0]},${nums[1]},${nums[2]}`;
}
function rgbaFrom(rgb, a){
  return `rgba(${rgb},${a})`;
}
function rgbaAccent(a){
  const rgb = normalizeRgb(getCssVar("--accent-rgb", getCssVar("--accentRGB","245,226,122")), "245,226,122");
  return rgbaFrom(rgb, a);
}
function rgbaBlue(a){
  const rgb = normalizeRgb(getCssVar("--blue-rgb","90,160,255"), "90,160,255");
  return rgbaFrom(rgb, a);
}
function palette(){
  const t = getActiveTheme();
  if(t === "light"){
    return {
      t,
      bg0:"#ffffff", bg1:"#f2f6ff", bg2:"#ffffff",
      cardFill:"rgba(0,0,0,0.035)",
      cardStroke:"rgba(18,20,28,0.10)",
      text:"rgba(18,20,28,0.92)",
      text2:"rgba(18,20,28,0.76)",
      text3:"rgba(18,20,28,0.60)",
    };
  }
  return {
    t,
    bg0:"#0b0b0b", bg1:"#121212", bg2:"#07070a",
    cardFill:"rgba(255,255,255,0.06)",
    cardStroke:"rgba(255,255,255,0.10)",
    text:"rgba(255,255,255,0.92)",
    text2:"rgba(255,255,255,0.80)",
    text3:"rgba(255,255,255,0.55)",
  };
}


function drawShareCard(){
  const canvas = document.getElementById("shareCardCanvas");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;

  const pal = palette();

  // bg
  const g = ctx.createLinearGradient(0,0,W,H);
  g.addColorStop(0, pal.bg0);
  g.addColorStop(0.55, pal.bg1);
  g.addColorStop(1, pal.bg2);
  ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

  // glow
  ctx.fillStyle = rgbaAccent(pal.t === "light" ? 0.10 : 0.12);
  ctx.beginPath(); ctx.arc(W*0.60, H*0.15, 330, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = rgbaBlue(pal.t === "light" ? 0.06 : 0.08);
  ctx.beginPath(); ctx.arc(W*0.18, H*0.25, 260, 0, Math.PI*2); ctx.fill();

  // card
  const pad = 70;
  const r = 34;
  ctx.fillStyle = pal.cardFill;
  roundRect(ctx, pad, pad, W-pad*2, H-pad*2, r, true, false);
  ctx.strokeStyle = pal.cardStroke;
  ctx.lineWidth = 2;
  roundRect(ctx, pad, pad, W-pad*2, H-pad*2, r, false, true);

  // header
  ctx.fillStyle = "#f5e27a";
  ctx.font = "900 54px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText("88 Î∂ÑÏÑù Í≤∞Í≥º", pad+40, pad+95);

  ctx.fillStyle = pal.text2;
  ctx.font = "700 28px system-ui, -apple-system, Segoe UI, Roboto";
  const ts = new Date();
  ctx.fillText(ts.toLocaleString("ko-KR"), pad+40, pad+145);

  // summary one-line
  let hasSummary = false;
  try{
    const sumRaw = (LAST_ONE_LINE || "").replace(/^ÏöîÏïΩ\s*:\s*/,"").trim();
    if(sumRaw){
      const sum = sumRaw.length > 70 ? (sumRaw.slice(0,70) + "‚Ä¶") : sumRaw;
      ctx.fillStyle = pal.text;
      ctx.font = "900 24px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillText(sum, pad+40, pad+240);
      hasSummary = true;
    }
  }catch(e){ hasSummary = false; }

  // badge (EV flag)
  let badgeText = "";
  try{
    const evEl = document.getElementById("evFlag");
    if(evEl && evEl.innerText) badgeText = evEl.innerText.trim();
  }catch(e){}
  if(badgeText){
    const bx = pad+40, by = pad+170, bw = 340, bh = 54;
    ctx.fillStyle = rgbaAccent(0.18);
    roundRect(ctx, bx, by, bw, bh, 999, true, false);
    ctx.strokeStyle = rgbaAccent(0.35);
    ctx.lineWidth = 2;
    roundRect(ctx, bx, by, bw, bh, 999, false, true);
    ctx.fillStyle = "#fff";
    ctx.font = "900 26px system-ui, -apple-system, Segoe UI, Roboto";
    ctx.fillText(badgeText, bx+18, by+36);
  }

  // lines
  const lines = extractResultLines().slice(0, 12);
  let y = hasSummary ? (pad + 310) : (pad + 270);
  ctx.fillStyle = pal.text;
  ctx.font = "800 30px system-ui, -apple-system, Segoe UI, Roboto";
  lines.forEach((line)=>{
    const txt = line.length > 46 ? (line.slice(0,46) + "‚Ä¶") : line;
    ctx.fillText("‚Ä¢ " + txt, pad+40, y);
    y += 48;
  });

  // footer
  ctx.fillStyle = pal.text2;
  ctx.font = "800 26px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText("ÎßÅÌÅ¨: " + getShareLink(), pad+40, H - pad - 70);

  ctx.fillStyle = pal.text3;
  ctx.font = "700 22px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText("‚Äª ÌåêÎã® Î≥¥Ï°∞Ïö© / Í≤∞Í≥ºÎ•º Î≥¥Ïû•ÌïòÏßÄ ÏïäÏäµÎãàÎã§.", pad+40, H - pad - 30);
}

async function copyShareLink(){
  const link = getShareLink();
  try{
    await navigator.clipboard.writeText(link);
    toast("ÎßÅÌÅ¨Î•º Î≥µÏÇ¨ÌñàÏäµÎãàÎã§");
    try{ track("share_copy_link", { page_path: location.pathname }); }catch(e){}
  }catch(e){
    toast("Î≥µÏÇ¨ Ïã§Ìå®");
  }
}

async function copyShareText(){
  if(!LAST_TEXT) return showError("Î®ºÏ†Ä 'Í≥ÑÏÇ∞ÌïòÍ∏∞'Î°ú Í≤∞Í≥ºÎ•º ÎßåÎì† Îí§ Î≥µÏÇ¨Ìï† Ïàò ÏûàÏñ¥Ïöî.");
  try{
    await navigator.clipboard.writeText(LAST_TEXT + "\n" + getShareLink());
    toast("Î¨∏Íµ¨Î•º Î≥µÏÇ¨ÌñàÏäµÎãàÎã§");
    try{ track("share_copy_text", { page_path: location.pathname }); }catch(e){}
  }catch(e){
    toast("Î≥µÏÇ¨ Ïã§Ìå®");
  }
}

function downloadShareCard(){
  const canvas = document.getElementById("shareCardCanvas");
  if(!canvas) return;
  try{
    canvas.toBlob((blob)=>{
      if(!blob) return;
      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = "88-analysis-card.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 800);
      toast("Ïù¥ÎØ∏ÏßÄÎ•º Ï†ÄÏû•ÌñàÏäµÎãàÎã§");
      try{ track("share_download_image", { page_path: location.pathname }); }catch(e){}
    }, "image/png", 1.0);
  }catch(e){
    toast("Ï†ÄÏû• Ïã§Ìå®");
  }
}



/* =========================
   Ïò§Îäò ÏàòÏßë Î¨∂Ïùå Í≥µÏú† (Ïó∞ÏÜç Ï†ÄÏû•/ÌÅ¥Î¶≠ Ï†ÄÏû• ÎàÑÏ†Å)
   - ÏÑúÎ≤Ñ ÏóÜÏù¥ localStorage(Ïò§Îäò ÎÇ†Ïßú key)Ïóê Ï†ÄÏû•Îêú ÎßÅÌÅ¨Î•º Î¨∂Ïñ¥ÏÑú Í≥µÏú†
========================= */
function truncateText(s, n){
  const t = String(s||"").trim();
  if(!t) return "";
  return t.length > n ? (t.slice(0,n-1) + "‚Ä¶") : t;
}

function getBundleItems(limit){
  const items = readChainPack(todayStr());
  const clean = (items||[]).filter(x=>x && x.link);
  // dedupe by link
  const seen = new Set();
  const uniq = [];
  for(const it of clean){
    if(seen.has(it.link)) continue;
    seen.add(it.link);
    uniq.push(it);
  }
  // sort: margin asc (then recent)
  uniq.sort((a,b)=>{
    const ma = (typeof a.mainMarginPct === "number") ? a.mainMarginPct : 9999;
    const mb = (typeof b.mainMarginPct === "number") ? b.mainMarginPct : 9999;
    if(ma !== mb) return ma - mb;
    return (b.ts||0) - (a.ts||0);
  });
  return uniq.slice(0, limit || 10);
}

function bundleTop3OneLine(items){
  const top = (items||[]).slice(0,3);
  if(!top.length) return "";
  const shortTeams = (s)=>{
    const t = String(s||"").replace(/\s+/g," ").trim();
    if(!t) return "ÌåÄÎ™Ö";
    // ÎÑàÎ¨¥ Í∏∏Î©¥ Ïïû/Îí§Î•º Î≥¥Ï°¥
    if(t.length <= 14) return t;
    const parts = t.split(/\s+vs\s+|\s+VS\s+|\s+-\s+|\s+v\s+/i);
    if(parts.length>=2){
      const a = parts[0].trim();
      const b = parts[1].trim();
      const aa = a.length>8 ? a.slice(0,8)+"‚Ä¶" : a;
      const bb = b.length>8 ? b.slice(0,8)+"‚Ä¶" : b;
      return `${aa} vs ${bb}`;
    }
    return t.slice(0,13)+"‚Ä¶";
  };
  const parts = top.map((it, i)=>{
    const title = shortTeams(it.teams);
    const m = (typeof it.mainMarginPct === "number") ? it.mainMarginPct.toFixed(2)+"%" : "-";
    return `${i+1}) ${title}(${m})`;
  });
  return `TOP3: ${parts.join(" / ")}`;
}

function buildBundleText(items){
  const d = todayStr();
  const lines = [];
  lines.push(`[88ST] Ïò§Îäò ÏàòÏßë ${items.length}Í≤ΩÍ∏∞ (ÎßàÏßÑ ÎÇÆÏùÄ Ïàú) ¬∑ ${d}`);
  lines.push(`Î∂ÑÏÑùÍ∏∞: https://88st.cloud/analysis/`);
  const top3 = bundleTop3OneLine(items);
  // ÎßÅÌÅ¨ 0Í∞ú Í∑úÏπô ÎåÄÏùë: ÎåìÍ∏Ä Ïú†ÎèÑ Î≤ÑÏ†Ñ
  if(linksMode==="none" && commentOn){
    if(!compact) lines.push(commentCtaLine(channelKey));
    else lines.push(commentCtaLine(channelKey));
  }

  if(top3){
    lines.push(top3);
  }
  lines.push("");
  items.forEach((it, i)=>{
    const sportName = (SPORT_CFG[it.sport] || SPORT_CFG.soccer).name || (it.sport||"");
    const title = (it.teams && it.teams.trim()) ? it.teams.trim() : "ÌåÄÎ™Ö ÎØ∏ÏûÖÎ†•";
    const m = (typeof it.mainMarginPct === "number") ? `ÎßàÏßÑ ${it.mainMarginPct.toFixed(2)}%` : "ÎßàÏßÑ -";
    const ev = (typeof it.bestEVPct === "number") ? `EV ${(it.bestEVPct>=0?"+":"-")}${Math.abs(it.bestEVPct).toFixed(2)}%` : "EV ÎØ∏ÏûÖÎ†•";
    lines.push(`${i+1}) ${title}`);
    lines.push(`   ${sportName} ¬∑ ${m} ¬∑ ${ev}`);
    lines.push(`   ${it.link}`);
    lines.push("");
  });
  lines.push("‚Äª ÌåêÎã® Î≥¥Ï°∞Ïö© / Í≤∞Í≥ºÎ•º Î≥¥Ïû•ÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
  return lines.join("\n");
}

function buildBundleLinks(items){
  return items.map(it=>it.link).join("\n");
}

function drawBundleCard(items){
  const canvas = document.getElementById("bundleCanvas");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;

  const pal = palette();

  // bg
  const bg = ctx.createLinearGradient(0,0,W,H);
  bg.addColorStop(0, pal.bg0);
  bg.addColorStop(0.55, pal.bg1);
  bg.addColorStop(1, pal.bg2);
  ctx.fillStyle = bg; ctx.fillRect(0,0,W,H);

  // glow
  ctx.fillStyle = rgbaAccent(pal.t === "light" ? 0.10 : 0.12);
  ctx.beginPath(); ctx.arc(W*0.62, H*0.18, 330, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = rgbaBlue(pal.t === "light" ? 0.06 : 0.08);
  ctx.beginPath(); ctx.arc(W*0.18, H*0.28, 260, 0, Math.PI*2); ctx.fill();

  const pad = 70;
  const r = 34;
  ctx.fillStyle = pal.cardFill;
  roundRect(ctx, pad, pad, W-pad*2, H-pad*2, r, true, false);
  ctx.strokeStyle = pal.cardStroke;
  ctx.lineWidth = 2;
  roundRect(ctx, pad, pad, W-pad*2, H-pad*2, r, false, true);

  // header
  ctx.fillStyle = "#f5e27a";
  ctx.font = "900 50px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText("88 Ïò§Îäò ÏàòÏßë", pad+40, pad+92);

  ctx.fillStyle = pal.text2;
  ctx.font = "800 26px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText(`${todayStr()} ¬∑ ÎßàÏßÑ ÎÇÆÏùÄ Ïàú TOP${items.length}`, pad+40, pad+140);

  // TOP3 one-line
  const top3 = bundleTop3OneLine(items);
  let baseY = pad + 210;
  if(top3){
    ctx.fillStyle = pal.text3;
    ctx.font = "900 22px system-ui, -apple-system, Segoe UI, Roboto";
    const t = truncateText(top3, 54);
    ctx.fillText(t, pad+40, pad+178);
    baseY = pad + 242;
  }

  // list
  let y = baseY;
  const lineH = 74;
  items.slice(0,10).forEach((it, i)=>{
    const title = truncateText((it.teams && it.teams.trim()) ? it.teams.trim() : "ÌåÄÎ™Ö ÎØ∏ÏûÖÎ†•", 28);
    const sportName = (SPORT_CFG[it.sport] || SPORT_CFG.soccer).name || (it.sport||"");
    const m = (typeof it.mainMarginPct === "number") ? `ÎßàÏßÑ ${it.mainMarginPct.toFixed(2)}%` : "ÎßàÏßÑ -";
    const ev = (typeof it.bestEVPct === "number") ? `EV ${(it.bestEVPct>=0?"+":"-")}${Math.abs(it.bestEVPct).toFixed(2)}%` : "EV ÎØ∏ÏûÖÎ†•";

    ctx.fillStyle = "rgba(255,255,255,0.94)";
    ctx.font = "900 30px system-ui, -apple-system, Segoe UI, Roboto";
    ctx.fillText(`${i+1}. ${title}`, pad+40, y);

    ctx.fillStyle = "rgba(255,255,255,0.78)";
    ctx.font = "800 22px system-ui, -apple-system, Segoe UI, Roboto";
    ctx.fillText(`${sportName} ¬∑ ${m} ¬∑ ${ev}`, pad+40, y + 34);

    y += lineH;
  });

  // footer
  ctx.fillStyle = "rgba(255,255,255,0.70)";
  ctx.font = "800 24px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText("88st.cloud/analysis", pad+40, H - pad - 58);

  ctx.fillStyle = pal.text3;
  ctx.font = "700 20px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText("‚Äª ÌÖçÏä§Ìä∏Ïóê Í∞Å Í≤ΩÍ∏∞ Î≥µÏõê ÎßÅÌÅ¨ Ìè¨Ìï®", pad+40, H - pad - 28);
}

function openBundleShare(){
  const items = getBundleItems(10);
  if(!items.length){
    toast("Ïò§Îäò ÏàòÏßëÎêú Ìï≠Î™©Ïù¥ ÏïÑÏßÅ ÏóÜÏñ¥Ïöî. (ÌÖçÏä§Ìä∏ Î∂ôÏó¨ÎÑ£Í∏∞ÏóêÏÑú 'Ïó∞ÏÜç Ï†ÄÏû•' ÎòêÎäî 'ÌÅ¥Î¶≠=Ïó∞ÏÜç Ï†ÄÏû•'ÏùÑ ÏÇ¨Ïö©Ìï¥Ï§ò)");
    return;
  }
  const modal = document.getElementById("bundleShareModal");
  if(!modal) return;

  const titleEl = document.getElementById("bundleTitle");
  const metaEl  = document.getElementById("bundleMeta");
  const ta      = document.getElementById("bundleText");

  if(titleEl) titleEl.textContent = `Ïò§Îäò ÏàòÏßë Î¨∂Ïùå (${items.length}Í≤ΩÍ∏∞)`;
  if(ta) ta.value = buildBundleText(items);

  if(metaEl){
    const ms = items.map(it=> (typeof it.mainMarginPct === "number") ? it.mainMarginPct : null).filter(v=>v!=null);
    const min = ms.length ? Math.min(...ms) : null;
    const avg = ms.length ? (ms.reduce((a,b)=>a+b,0) / ms.length) : null;
    const pos = items.filter(it=> typeof it.bestEVPct === "number" && it.bestEVPct > 0).length;
    const pill = (txt)=>`<span class="bundle-pill">${txt}</span>`;
    const top3 = bundleTop3OneLine(items);
    metaEl.innerHTML = `<div class="bundle-mini"><b>${todayStr()}</b> ¬∑ ${items.length}Í∞ú</div>` +
      `<div class="bundle-mini">` +
        pill(min!=null?`ÏµúÏ†Ä ÎßàÏßÑ ${min.toFixed(2)}%`:`ÏµúÏ†Ä ÎßàÏßÑ -`) +
        pill(avg!=null?`ÌèâÍ∑† ÎßàÏßÑ ${avg.toFixed(2)}%`:`ÌèâÍ∑† ÎßàÏßÑ -`) +
        pill(`+EV ${pos}Í∞ú`) +
      `</div>` +
      (top3 ? `<div class="bundle-mini">${safeText(top3)}</div>` : "");
  }

  modal.style.display = "flex";
  drawBundleCard(items);
  try{ track("bundle_open", { count: items.length, page_path: location.pathname }); }catch(e){}
}

async function copyBundleTop3(){
  const items = getBundleItems(10);
  if(!items.length) return;
  const t = bundleTop3OneLine(items);
  if(!t) return;
  try{
    await navigator.clipboard.writeText(t);
    toast("TOP3 ÏöîÏïΩÏùÑ Î≥µÏÇ¨ÌñàÏäµÎãàÎã§");
    try{ track("bundle_copy_top3", { page_path: location.pathname }); }catch(e){}
  }catch(e){ toast("Î≥µÏÇ¨ Ïã§Ìå®"); }
}

function resetBundleToday(){
  if(!confirm("Ïò§Îäò ÏàòÏßë Î¨∂ÏùåÏùÑ Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?\n\n‚Ä¢ ÌûàÏä§ÌÜ†Î¶¨(Ï†ÄÏû• Í∏∞Î°ù)Îäî Ïú†ÏßÄÎê©ÎãàÎã§\n‚Ä¢ 'Ïò§Îäò ÏàòÏßë Î¨∂Ïùå'Îßå ÎπÑÏõåÏßëÎãàÎã§")) return;
  try{ localStorage.removeItem(chainPackKey(todayStr())); }catch(e){}
  try{ updateBundleButton(); }catch(e){}
  toast("Ïò§Îäò ÏàòÏßë Î¨∂ÏùåÏùÑ Ï¥àÍ∏∞ÌôîÌñàÏäµÎãàÎã§");
  try{ track("bundle_reset", { page_path: location.pathname }); }catch(e){}
  try{ closeBundleShare(); }catch(e){}
}

function closeBundleShare(){
  const modal = document.getElementById("bundleShareModal");
  if(modal) modal.style.display = "none";
}


async function copyBundleText(){
  const ta = document.getElementById("bundleText");
  if(!ta || !ta.value) return;
  try{
    await navigator.clipboard.writeText(ta.value);
    toast("Î¨∂Ïùå Î¨∏Íµ¨Î•º Î≥µÏÇ¨ÌñàÏäµÎãàÎã§");
    try{ track("bundle_copy_text", { page_path: location.pathname }); }catch(e){}
  }catch(e){ toast("Î≥µÏÇ¨ Ïã§Ìå®"); }
}

async function copyBundleLinks(){
  const items = getBundleItems(10);
  if(!items.length) return;
  const txt = buildBundleLinks(items);
  try{
    await navigator.clipboard.writeText(txt);
    toast("ÎßÅÌÅ¨Îßå Î≥µÏÇ¨ÌñàÏäµÎãàÎã§");
    try{ track("bundle_copy_links", { count: items.length, page_path: location.pathname }); }catch(e){}
  }catch(e){ toast("Î≥µÏÇ¨ Ïã§Ìå®"); }
}


/* ===== Î¨∂Ïùå ÌôçÎ≥¥Í∏Ä(Ï±ÑÎÑê/ÌÜ§) ÏûêÎèô ÏÉùÏÑ± ===== */
const BUNDLE_PROMO_LS_CH        = "88_bundle_promo_channel";
const BUNDLE_PROMO_LS_STYLE     = "88_bundle_promo_style";
const BUNDLE_PROMO_LS_LINKS     = "88_bundle_promo_links";
const BUNDLE_PROMO_LS_SHORTURL  = "88_bundle_promo_short_url";
const BUNDLE_PROMO_LS_COMPACT   = "88_bundle_promo_compact";
const BUNDLE_PROMO_LS_VENDOR    = "88_bundle_promo_vendor";
const BUNDLE_PROMO_LS_ONE_TGT   = "88_bundle_promo_one_target";
const BUNDLE_PROMO_LS_VAR       = "88_bundle_promo_variant";
const BUNDLE_PROMO_LS_PRESET    = "88_bundle_promo_preset";
const BUNDLE_PROMO_LS_COMMENT   = "88_bundle_promo_comment";
const BUNDLE_PROMO_LS_VTHR_M    = "88_bundle_promo_vthr_margin";
const BUNDLE_PROMO_LS_VTHR_EVC  = "88_bundle_promo_vthr_evcount";
const BUNDLE_PROMO_LS_ADV_OPEN  = "88_bundle_promo_adv_open";

const BUNDLE_PROMO_CHANNELS = [
  { key:"tochatsa",       label:"ÌÜ†Ï∞æÏÇ¨",                 source:"tochatsa",       medium:"community",
    preset:{ style:"promo", links:"top3", compact:false, shortUrl:false, vendor:true, oneTarget:"analysis", comment:false, enforce:{} },
    forbidden:[] },
  { key:"toto_hot",       label:"ÌÜ†ÌÜ†Ìï´",                 source:"toto_hot",       medium:"community",
    preset:{ style:"promo", links:"top3", compact:false, shortUrl:false, vendor:true, oneTarget:"analysis", comment:false, enforce:{} },
    forbidden:[] },
  { key:"mt_dajava",      label:"Î®πÌäÄÎã§ÏûêÎ∞î",             source:"mt_dajava",      medium:"community",
    preset:{ style:"info",  links:"one",  compact:true,  shortUrl:true,  vendor:false, oneTarget:"analysis", comment:false,
            enforce:{ links:true, vendor:true, style:false, compact:false, shortUrl:false, comment:false } },
    forbidden:["ÌôçÎ≥¥","Í∞ÄÏûÖ","Ïø†Ìè∞","ÏΩîÎìú","Ï∂îÏ≤ú","üéÅ"] },
  { key:"meokjab",        label:"Î®πÏû°",                   source:"meokjab",        medium:"community",
    preset:{ style:"info",  links:"one",  compact:true,  shortUrl:true,  vendor:false, oneTarget:"analysis", comment:false,
            enforce:{ links:true, vendor:true, style:false, compact:false, shortUrl:false, comment:false } },
    forbidden:["ÌôçÎ≥¥","Í∞ÄÏûÖ","Ïø†Ìè∞","ÏΩîÎìú","Ï∂îÏ≤ú","üéÅ"] },
  { key:"toto_town",      label:"ÌÜ†ÌÜ†ÌÉÄÏö¥",               source:"toto_town",      medium:"community",
    preset:{ style:"promo", links:"top3", compact:false, shortUrl:false, vendor:true, oneTarget:"analysis", comment:false, enforce:{} },
    forbidden:[] },
  { key:"chongpan_guard", label:"Ï¥ùÌåêÍµ¨Ï°∞ÎåÄ",             source:"chongpan_guard", medium:"community",
    preset:{ style:"promo", links:"top5", compact:true,  shortUrl:false, vendor:true, oneTarget:"analysis", comment:false, enforce:{} },
    forbidden:["Î¨¥Î£å"] },
  { key:"powerball_auto", label:"ÌååÏõåÎ≥ºÏò§ÌÜ†",             source:"powerball_auto", medium:"community",
    preset:{ style:"promo", links:"one",  compact:true,  shortUrl:true,  vendor:true, oneTarget:"analysis", comment:false, enforce:{} },
    forbidden:[] },
  { key:"daumde",         label:"Îã§ÏùåÎìú",                 source:"daumde",         medium:"community",
    preset:{ style:"promo", links:"top3", compact:false, shortUrl:false, vendor:true, oneTarget:"analysis", comment:false, enforce:{} },
    forbidden:[] },
  { key:"tg_freepromo",   label:"ÌÖîÎ†àÍ∑∏Îû® ÌÜ†ÌÜ†ÏûêÏú†ÌôçÎ≥¥Î∞©", source:"tg_freepromo",   medium:"telegram",
    preset:{ style:"tg",    links:"top3", compact:true,  shortUrl:false, vendor:true, oneTarget:"analysis", comment:false, enforce:{} },
    forbidden:["ÎåìÍ∏Ä"] },
  { key:"etc",            label:"Í∏∞ÌÉÄ",                   source:"etc",            medium:"community",
    preset:{ style:"promo", links:"top3", compact:false, shortUrl:false, vendor:true, oneTarget:"analysis", comment:false, enforce:{} },
    forbidden:[] }
];

function getPromoChannel(key){
  return BUNDLE_PROMO_CHANNELS.find(c=>c.key===key) || BUNDLE_PROMO_CHANNELS[0];

function getChannelPreset(channelKey){
  const ch = getPromoChannel(channelKey);
  return (ch && ch.preset) ? ch.preset : null;
}

function applyPresetToUI(channelKey, isPresetOn){
  const preset = getChannelPreset(channelKey);
  if(!preset || !isPresetOn) return { preset:null, enforced:false };

  const sty  = document.getElementById("bundlePromoStyle");
  const lnk  = document.getElementById("bundlePromoLinks");
  const sh   = document.getElementById("bundlePromoShortUrl");
  const cp   = document.getElementById("bundlePromoCompact");
  const vd   = document.getElementById("bundlePromoVendor");
  const one  = document.getElementById("bundlePromoOneTarget");
  const cm   = document.getElementById("bundlePromoComment");
  const hint = document.getElementById("bundlePresetHint");

  if(sty && preset.style) sty.value = preset.style;
  if(lnk && preset.links) lnk.value = preset.links;
  if(sh) sh.checked = !!preset.shortUrl;
  if(cp) cp.checked = !!preset.compact;
  if(vd) vd.checked = !!preset.vendor;
  if(one && preset.oneTarget) one.value = preset.oneTarget;
  if(cm) cm.checked = !!preset.comment;

  // show hint pill
  if(hint){
    const label = [];
    label.push((sty? sty.options[sty.selectedIndex].text : preset.style));
    label.push((lnk? lnk.options[lnk.selectedIndex].text : preset.links));
    if(cp && cp.checked) label.push("Ï§ÑÎ∞îÍøà ÏµúÏÜå");
    if(sh && sh.checked) label.push("URL ÏßßÍ≤å");
    if(vd && vd.checked) label.push("ÏóÖÏ≤¥ Ï°∞Í±¥Î∂Ä");
    hint.textContent = "ÌîÑÎ¶¨ÏÖã: " + label.join(" ¬∑ ");
    hint.style.display = "";
  }

  // enforce specific controls (disable) if preset.enforce flags set
  const enforce = preset.enforce || {};
  if(lnk) lnk.disabled = !!enforce.links;
  if(one) one.disabled = !!enforce.links;
  if(sty) sty.disabled = !!enforce.style;
  if(vd)  vd.disabled  = !!enforce.vendor;
  if(cm)  cm.disabled  = !!enforce.comment;
  // allow user to still tweak compact/shortUrl unless explicitly locked
  if(cp) cp.disabled = !!enforce.compact;
  if(sh) sh.disabled = !!enforce.shortUrl;

  return { preset, enforced:true };
}

function clearPresetEnforcement(){
  const lnk  = document.getElementById("bundlePromoLinks");
  const one  = document.getElementById("bundlePromoOneTarget");
  const sh   = document.getElementById("bundlePromoShortUrl");
  const cp   = document.getElementById("bundlePromoCompact");
  const sty  = document.getElementById("bundlePromoStyle");
  const vd   = document.getElementById("bundlePromoVendor");
  const cm   = document.getElementById("bundlePromoComment");
  const hint = document.getElementById("bundlePresetHint");
  if(lnk) lnk.disabled = false;
  if(one) one.disabled = false;
  if(sty) sty.disabled = false;
  if(vd)  vd.disabled = false;
  if(cm)  cm.disabled = false;
  if(sh) sh.disabled = false;
  if(cp) cp.disabled = false;
  if(hint) hint.style.display = "none";
}

function sanitizePromoText(text, channelKey, presetOn){
  if(!presetOn) return text;
  const ch = getPromoChannel(channelKey);
  const forbidden = (ch && Array.isArray(ch.forbidden)) ? ch.forbidden : [];
  if(!forbidden.length) return text;
  let out = String(text||"");
  // remove forbidden tokens (not obfuscation ‚Äî compliance-oriented)
  forbidden.forEach(tok=>{
    if(!tok) return;
    const esc = tok.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    out = out.replace(new RegExp(esc, "g"), "");
  });
  out = out.replace(/[ ]{2,}/g, " ").replace(/\n{3,}/g, "\n\n").trim();
  return out;
}

function commentCtaLine(channelKey){
  const ch = getPromoChannel(channelKey);
  const medium = (ch && ch.medium) ? ch.medium : "community";
  if(medium==="telegram"){
    return "‚Äª ÎßÅÌÅ¨ Ï†úÌïúÏù¥ ÏûàÏúºÎ©¥ ‚Äò88ST ÎßÅÌÅ¨‚ÄôÎùºÍ≥† ÎÇ®Í≤®Ï§ò. (ÎãµÍ∏ÄÎ°ú ÏïàÎÇ¥)";
  }
  return "‚Äª ÎßÅÌÅ¨ Ï†úÌïúÏù¥ ÏûàÎäî Í≤åÏãúÌåêÏù¥Î©¥ ÎåìÍ∏ÄÎ°ú ‚ÄòÎßÅÌÅ¨‚ÄôÎùºÍ≥† ÎÇ®Í∏∞Î©¥ ÏïàÎÇ¥Ìï†Í≤åÏöî.";
}
}

function promoUtm(channelKey, styleKey){
  const ch = getPromoChannel(channelKey);
  const source = ch.source || ch.key || channelKey || "community";
  const medium = ch.medium || "community";
  const camp = "bundle_w1";
  const content = `${source}_${styleKey}_${todayStr().replace(/-/g,"")}`;
  return { utm_source:source, utm_medium:medium, utm_campaign:camp, utm_content:content };
}

function stripUtmFromUrl(raw){
  try{
    const u = new URL(raw, location.origin);
    const keys = [...u.searchParams.keys()];
    for(const k of keys){
      if(/^utm_/i.test(k)) u.searchParams.delete(k);
    }
    return u.toString();
  }catch(e){ return raw; }
}

function applyUtmToUrl(raw, utm){
  try{
    const u = new URL(stripUtmFromUrl(raw), location.origin);
    for(const [k,v] of Object.entries(utm||{})){
      if(v==null || v==="") continue;
      u.searchParams.set(k, v);
    }
    return u.toString();
  }catch(e){ return raw; }
}

function fmtUrlForBoard(raw, shortUrl){
  if(!raw) return "";
  let url = String(raw);
  if(shortUrl){
    url = stripUtmFromUrl(url);
    url = url.replace(/^https?:\/\//i, "");
    url = url.replace(/\/$/,"");
  }
  return url;
}

// === 3Ï¢Ö ÌÖúÌîåÎ¶ø ÏûêÎèô ÎûúÎç§(Ï§ëÎ≥µ Î∞©ÏßÄ) ===
const PROMO_VARIANTS = 3;
const PROMO_TEMPLATES = {
  promo:{
    titles:[
      (n,d)=>`Î¨¥Î£å Î∞∞ÎãπÎ∂ÑÏÑùÍ∏∞ ¬∑ Ïò§Îäò ÎßàÏßÑ ÎÇÆÏùÄ Í≤ΩÍ∏∞ TOP${n} (Î≥µÏõê ÎßÅÌÅ¨)`,
      (n,d)=>`[Î¨¥Î£å] Ïò§Î≤ÑÎùºÏö¥Îìú(ÎßàÏßÑ) ÎÇÆÏùÄ Í≤ΩÍ∏∞ TOP${n} ¬∑ ${d}`,
      (n,d)=>`ÎßàÏßÑ ÎÇÆÏùÄ Î∞∞ÎãπÎßå Îπ†Î•¥Í≤å Ï†ïÎ¶¨ (TOP${n}) ¬∑ ${d}`
    ],
    leads:[
      ()=>`Î∞∞Îãπ 2~3Í∞ú ÏûÖÎ†•ÌïòÎ©¥ ÎßàÏßÑ/Í≥µÏ†ïÎ∞∞Îãπ/EVÎ•º Ìïú Î≤àÏóê Ï†ïÎ¶¨Ìï©ÎãàÎã§. ÏïÑÎûòÎäî Ïò§Îäò ÏàòÏßë(ÎßàÏßÑ ÎÇÆÏùÄ Ïàú)ÏûÖÎãàÎã§.`,
      ()=>`ÏòàÏ∏°Ïù¥ ÏïÑÎãàÎùº ‚ÄúÌåêÎã® ÎπÑÏö© Ï†àÍ∞ê‚ÄùÏö© Ï†ïÎ¶¨ÏûÖÎãàÎã§. ÎßÅÌÅ¨Î•º Ïó¥Î©¥ ÏûÖÎ†•/Í≤∞Í≥ºÍ∞Ä Í∑∏ÎåÄÎ°ú Î≥µÏõêÎê©ÎãàÎã§.`,
      ()=>`Ïª§ÎÆ§ÎãàÌã∞Ïóê Í∑ºÍ±∞ ÎÇ®Í∏∞Í∏∞ Ìé∏ÌïòÍ≤å ÎßåÎì§ÏóàÏäµÎãàÎã§. ÌÖçÏä§Ìä∏ Î∂ôÏó¨ÎÑ£Í∏∞ ‚Üí ÏûêÎèô Í≥ÑÏÇ∞/Ï†ÄÏû•Îê©ÎãàÎã§.`
    ],
    headers:[
      (n)=>`Ïò§Îäò ÏàòÏßë ${n}Í≤ΩÍ∏∞ (ÎßàÏßÑ ÎÇÆÏùÄ Ïàú)`,
      (n)=>`Ïò§Îäò Ï†ïÎ¶¨ ${n}Í≤ΩÍ∏∞ ¬∑ ÎßàÏßÑ Í∏∞Ï§Ä`,
      (n)=>`Ïò§Îäò TOP${n} ¬∑ ÎßàÏßÑ Ï†ïÎ†¨`
    ]
  },
  info:{
    titles:[
      (n,d)=>`Ïò§Î≤ÑÎùºÏö¥Îìú(ÎßàÏßÑ) ÎÇÆÏùÄ Í≤ΩÍ∏∞ TOP${n} Ï†ïÎ¶¨ ¬∑ ${d}`,
      (n,d)=>`Î∞∞Îãπ ‚ÄòÎπÑÏö©(ÎßàÏßÑ)‚Äô ÎÇÆÏùÄ ÎùºÏù∏ Î™®Ïùå(TOP${n}) ¬∑ ${d}`,
      (n,d)=>`ÎßàÏßÑ/Í≥µÏ†ïÎ∞∞Îãπ/EV Îπ†Î•∏ Ï≤¥ÌÅ¨(TOP${n}) ¬∑ ${d}`
    ],
    leads:[
      ()=>`ÎßàÏßÑ(Ïò§Î≤ÑÎùºÏö¥Îìú)Ïù¥ ÎÇÆÏùÑÏàòÎ°ù ÎèôÏùº Î∞∞ÎãπÏóêÏÑúÎèÑ ÎπÑÏö©Ïù¥ Ï†ÅÏùÄ Ìé∏ÏûÖÎãàÎã§. ÏïÑÎûò ÎßÅÌÅ¨Îäî Ïó¥Î©¥ ÎèôÏùº Í≤∞Í≥ºÍ∞Ä Î≥µÏõêÎê©ÎãàÎã§.`,
      ()=>`Î∞∞ÎãπÏùÑ ‚ÄòÏòàÏ∏°‚ÄôÌïòÎäî Í≤å ÏïÑÎãàÎùº, Ïà´ÏûêÎ°ú Ï†ïÎ¶¨Ìï¥ÏÑú ÌåêÎã®ÏùÑ Îπ†Î•¥Í≤å ÌïòÎäî ÎèÑÍµ¨ÏûÖÎãàÎã§. Î≥µÏõê ÎßÅÌÅ¨ Ìè¨Ìï®.`,
      ()=>`ÎßàÏßÑ/Í≥µÏ†ïÎ∞∞Îãπ/EVÎ•º Ìïú Î≤àÏóê Í≥ÑÏÇ∞Ìï©ÎãàÎã§. Ïª§ÎÆ§ÎãàÌã∞ Í≥µÏú†Ïö©ÏúºÎ°ú Î≥µÏõê ÎßÅÌÅ¨Î•º Í∞ôÏù¥ Î∂ôÏòÄÏäµÎãàÎã§.`
    ],
    headers:[
      (n)=>`TOP${n} (ÎßàÏßÑ ÎÇÆÏùÄ Ïàú)`,
      (n)=>`Ïò§Îäò Ï≤¥ÌÅ¨Ìïú TOP${n}`,
      (n)=>`ÎßàÏßÑ Í∏∞Ï§Ä TOP${n}`
    ]
  },
  tg:{
    titles:[
      (n,d)=>`Î¨¥Î£å Î∞∞Îãπ ÎßàÏßÑ(Ïò§Î≤ÑÎùºÏö¥Îìú) ¬∑ Ïò§Îäò TOP${n} (Î≥µÏõê ÎßÅÌÅ¨)`,
      (n,d)=>`Ïò§Îäò Í≤ΩÍ∏∞ Ï†ïÎ¶¨ TOP${n} ¬∑ ÎßàÏßÑ/EV (Î≥µÏõê ÎßÅÌÅ¨)`,
      (n,d)=>`ÌÖçÏä§Ìä∏ Î∂ôÏó¨ÎÑ£Í∏∞ ÏàòÏßë ¬∑ Ïò§Îäò TOP${n} (Î≥µÏõê ÎßÅÌÅ¨)`
    ],
    leads:[
      ()=>`ÌÖçÏä§Ìä∏ Î∂ôÏó¨ÎÑ£Í∏∞Î°ú ÏàòÏßëÌïú Ïò§Îäò Í≤ΩÍ∏∞Îì§ÏûÖÎãàÎã§. ÎßÅÌÅ¨ Ïó¥Î©¥ Í≤∞Í≥º Í∑∏ÎåÄÎ°ú Î≥µÏõêÎê©ÎãàÎã§.`,
      ()=>`Î¨¥Î£å Î∂ÑÏÑùÍ∏∞: ÎßàÏßÑ/Í≥µÏ†ïÎ∞∞Îãπ/EV Ï†ïÎ¶¨Ïö©. ÏïÑÎûòÎäî Ïò§Îäò ÏàòÏßë TOPÏûÖÎãàÎã§.`,
      ()=>`Ïò§Îäò Ï≤¥ÌÅ¨Ïö©ÏúºÎ°ú Ï†ïÎ¶¨Ìï¥Îëî Î¶¨Ïä§Ìä∏ Í≥µÏú†Ìï©ÎãàÎã§. Î≥µÏõê ÎßÅÌÅ¨ Ìè¨Ìï®.`
    ],
    headers:[
      (n)=>`Ïò§Îäò TOP${n} (ÎßàÏßÑ ÎÇÆÏùÄ Ïàú)`,
      (n)=>`TOP${n} Î¶¨Ïä§Ìä∏`,
      (n)=>`Ïò§Îäò ÏàòÏßë TOP${n}`
    ]
  }
};

function nextPromoVariant(){
  let prev = 0;
  try{ prev = parseInt(localStorage.getItem(BUNDLE_PROMO_LS_VAR)||"0",10) || 0; }catch(e){ prev=0; }
  const r = Math.floor(Math.random()*PROMO_VARIANTS);
  const v = (r===prev) ? ((r+1)%PROMO_VARIANTS) : r;
  try{ localStorage.setItem(BUNDLE_PROMO_LS_VAR, String(v)); }catch(e){}
  return v;
}
function currentPromoVariant(){
  let v = 0;
  try{ v = parseInt(localStorage.getItem(BUNDLE_PROMO_LS_VAR)||"0",10) || 0; }catch(e){ v=0; }
  if(v<0 || v>=PROMO_VARIANTS) v=0;
  return v;
}

function pickTemplate(styleKey, variant, n){
  const t = PROMO_TEMPLATES[styleKey] || PROMO_TEMPLATES.promo;
  const d = todayStr();
  const v = Math.max(0, Math.min(PROMO_VARIANTS-1, variant|0));
  return {
    title: t.titles[v](n,d),
    lead:  t.leads[v](),
    header: t.headers[v](n)
  };
}

// === Ï°∞Í±¥Î∂Ä ÏóÖÏ≤¥ Ìã∞Ï†Ä(1Í∞ú) ===
const PROMO_VENDOR_POOL = ["card10","card11","card8","card7"];
const PROMO_VENDOR_FIXED = ["card1","card2","card3","card4"];
const PROMO_VENDOR_DATA = {
  card1:{ title:"Ïñ¥ÎäêÎÇ†", benefit:"ÏûÖÌîå 5+2 / 10+3 / 20+4 ¬∑ Ï≤´Ï∂© 10% (Í≥†Ïï°Ï†ÑÏö©)" },
  card2:{ title:"OK Bet", benefit:"Ïã†Í∑ú 77ÎßåÏõê ¬∑ ÏΩîÏù∏ ÏûÖ/Ï∂úÍ∏à ¬∑ ÏóÖÎç∞Ïù¥Ìä∏" },
  card3:{ title:"SPEED Bet", benefit:"Ïã†Í∑ú 77ÎßåÏõê ¬∑ ÏΩîÏù∏ ÏûÖ/Ï∂úÍ∏à ¬∑ ÏóÖÎç∞Ïù¥Ìä∏" },
  card4:{ title:"VEGAS", benefit:"Í≥†Ïï°Ï†ÑÏö© ¬∑ ÏûÖÌîå ÏµúÎåÄ 30% ¬∑ Ïπ¥ÏßÄÎÖ∏ ÏûÖÌîå" },
  card7:{ title:"CAPS", benefit:"ÎØ∏Í≤ú Ï≤´Ï∂© 5% ¬∑ ÌéòÏù¥Î∞± 5% ¬∑ Ï∂úÏÑù 30ÎßåÏõê" },
  card8:{ title:"BETZY", benefit:"Ïä§Ìè¨Ï∏† Ï≤´Ï∂© 10% ¬∑ ÌéòÏù¥Î∞± 5% ¬∑ Ï∂úÏÑù 30ÎßåÏõê" },
  card10:{ title:"RED HULK", benefit:"Ïã†Í∑ú 30% ¬∑ Îß§Ï∂© 10% ¬∑ ÌéòÏù¥Î∞± 5%" },
  card11:{ title:"TOP GUN", benefit:"Ïã†Í∑ú 30% ¬∑ Îß§Ï∂© 10% ¬∑ ÌéòÏù¥Î∞± 5%" }
};

function hashStr(s){
  s = String(s||"");
  let h = 2166136261;
  for(let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h>>>0);
}

function getVendorThresholds(){
  const elM = document.getElementById("bundleVendorMargin");
  const elE = document.getElementById("bundleVendorEv");
  let m = null, e = null;
  if(elM) m = parseFloat(elM.value);
  if(elE) e = parseInt(elE.value, 10);
  if(!(m>=0)){
    const saved = localStorage.getItem(BUNDLE_PROMO_LS_VTHR_M);
    if(saved!=null) m = parseFloat(saved);
  }
  if(!(e>=0)){
    const saved = localStorage.getItem(BUNDLE_PROMO_LS_VTHR_EVC);
    if(saved!=null) e = parseInt(saved,10);
  }
  if(!(m>=0)) m = 3.2;
  if(!(e>=0)) e = 1;
  return { marginMax:m, posEvMin:e };
}

function shouldInsertVendor(items, thr){
  thr = thr || getVendorThresholds();
  const ms = (items||[]).map(it=> (typeof it.mainMarginPct==="number") ? it.mainMarginPct : null).filter(v=>v!=null);
  const min = ms.length ? Math.min(...ms) : null;
  const pos = (items||[]).filter(it=> typeof it.bestEVPct==="number" && it.bestEVPct > 0).length;
  return (min!=null && min<=thr.marginMax) || (pos>=thr.posEvMin);
}

function pickVendorId(channelKey){
  const seed = `${todayStr()}|${channelKey}|vendor`;
  const idx = hashStr(seed) % PROMO_VENDOR_POOL.length;
  return PROMO_VENDOR_POOL[idx] || "card2";
}

function vendorLine(utm, shortUrl, withLink, vendorId){
  const v = PROMO_VENDOR_DATA[vendorId] || PROMO_VENDOR_DATA.card2;
  const origin = (location && location.origin) ? location.origin : "https://88st.cloud";
  const url = applyUtmToUrl(origin.replace(/\/$/,"") + `/cert/?v=${vendorId}`, utm);
  const link = withLink ? fmtUrlForBoard(url, shortUrl) : "";
  const benefit = v.benefit ? v.benefit : "";
  if(link){
    return `üéÅ Ïù∏Ï¶ùÏóÖÏ≤¥ 1Í∞ú(Ï°∞Í±¥Î∂Ä): ${v.title} ¬∑ ${benefit} ¬∑ ${link}`;
  }
  return `üéÅ Ïù∏Ï¶ùÏóÖÏ≤¥ 1Í∞ú(Ï°∞Í±¥Î∂Ä): ${v.title} ¬∑ ${benefit}`;
}

function buildBundlePromo(items, opts){
  opts = opts || {};
  const elCh   = document.getElementById("bundlePromoChannel");
  const elSty  = document.getElementById("bundlePromoStyle");
  const elLn   = document.getElementById("bundlePromoLinks");
  const elShort= document.getElementById("bundlePromoShortUrl");
  const elComp = document.getElementById("bundlePromoCompact");
  const elVend = document.getElementById("bundlePromoVendor");
  const elOneT = document.getElementById("bundlePromoOneTarget");
  const elPreset = document.getElementById("bundlePromoPreset");
  const elComm = document.getElementById("bundlePromoComment");

  const presetOn  = !!(elPreset && elPreset.checked);
  const commentOn = !!(elComm && elComm.checked);


  const channelKey = elCh ? elCh.value : "tochatsa";
  let styleKey   = elSty ? elSty.value : "promo";
  // Ï±ÑÎÑê ÌîÑÎ¶¨ÏÖã ÏûêÎèô Ï†ÅÏö©(ÏòµÏÖò/Ï†ïÏ±Ö)
  try{
    clearPresetEnforcement();
    applyPresetToUI(channelKey, presetOn);
  }catch(e){}

  // ÌîÑÎ¶¨ÏÖã Ï†ÅÏö© Ïù¥ÌõÑ Í∞í ÎèôÍ∏∞Ìôî
  const styleKey2   = elSty ? elSty.value : "promo";
  styleKey = styleKey2;
  const linksMode  = elLn ? elLn.value : "top3";
  const shortUrl   = !!(elShort && elShort.checked);
  const compact    = !!(elComp && elComp.checked);
  const vendorOn   = !!(elVend && elVend.checked);
  const oneTarget  = elOneT ? elOneT.value : "analysis";

  const utm = promoUtm(channelKey, styleKey);
  const origin = (location && location.origin) ? location.origin : "https://88st.cloud";
  const analysisUrl = applyUtmToUrl(origin.replace(/\/$/,"") + "/analysis/", utm);

  const nTotal = Math.min(10, (items||[]).length);
  const linkN = (linksMode==="top5") ? 5 : (linksMode==="all" ? nTotal : 3);
  const tplVar = (opts.advanceVariant) ? nextPromoVariant() : currentPromoVariant();
  const tpl = pickTemplate(styleKey, tplVar, Math.min(linkN, nTotal));

  const top3 = bundleTop3OneLine(items);

  // ÎßÅÌÅ¨ Ï†ïÏ±Ö
  const allowAnyLink = (linksMode !== "none");
  const singleLinkOnly = (linksMode === "one");
  const allowItemLinks = (linksMode === "top3" || linksMode === "top5" || linksMode === "all");
  const allowAnalysisLink = allowAnyLink && (!singleLinkOnly || oneTarget==="analysis");
  const allowVendorLink = allowAnyLink && (!singleLinkOnly || oneTarget==="vendor");

  const lines = [];
  lines.push(tpl.title);

  // lead + analysis link
  if(allowAnalysisLink){
    const a = fmtUrlForBoard(analysisUrl, shortUrl);
    if(compact){
      lines.push(`${tpl.lead} ¬∑ Î∂ÑÏÑùÍ∏∞: ${a}`);
    }else{
      lines.push(tpl.lead);
      lines.push(`Î∂ÑÏÑùÍ∏∞(Î¨¥Î£å): ${a}`);
    }
  }else{
    // ÎßÅÌÅ¨ 0Í∞ú or ÎßÅÌÅ¨ 1Í∞ú(ÏóÖÏ≤¥)Ïù∏ Í≤ΩÏö∞: ÎßÅÌÅ¨ ÎåÄÏã† ÏïàÎÇ¥ Î¨∏Íµ¨
    const hint = (linksMode==="none") ? "88st[dot]cloud Ï†ëÏÜç ‚Üí /analysis" : "Î∂ÑÏÑùÍ∏∞: 88st[dot]cloud/analysis";
    if(compact) lines.push(`${tpl.lead} ¬∑ ${hint}`);
    else{
      lines.push(tpl.lead);
      lines.push(hint);
    }
  }

  if(top3){
    if(compact) lines.push(top3.replace(/^TOP3:\s*/,"TOP3: "));
    else lines.push(top3);
  }

  // Ï°∞Í±¥Î∂Ä ÏóÖÏ≤¥ Ìã∞Ï†Ä 1Í∞ú
  let vendorInserted = false;
  if(vendorOn && shouldInsertVendor(items, getVendorThresholds())){
    const vid = pickVendorId(channelKey);
    const vline = vendorLine(utm, shortUrl, allowVendorLink, vid);
    if(compact) lines.push(vline);
    else{
      lines.push("");
      lines.push(vline);
      lines.push("");
    }
    vendorInserted = true;
  }else{
    if(!compact) lines.push("");
  }

  // list header
  const header = tpl.header || `Ïò§Îäò ÏàòÏßë ${nTotal}Í≤ΩÍ∏∞`;
  if(!compact) lines.push(header);
  else lines.push(header);

  // list items
  const listItems = (items||[]).slice(0, nTotal);
  for(let i=0;i<listItems.length;i++){
    const it = listItems[i];
    const sportName = (SPORT_CFG[it.sport] || SPORT_CFG.soccer).name || (it.sport||"");
    const teams = (it.teams && String(it.teams).trim()) ? String(it.teams).trim() : `Í≤ΩÍ∏∞ ${i+1}`;
    const m = (typeof it.mainMarginPct==="number") ? `ÎßàÏßÑ ${it.mainMarginPct.toFixed(2)}%` : "ÎßàÏßÑ -";
    const ev = (typeof it.bestEVPct==="number") ? `EV ${(it.bestEVPct>=0?"+":"-")}${Math.abs(it.bestEVPct).toFixed(2)}%` : "EV ÎØ∏ÏûÖÎ†•";

    let line = (styleKey==="tg")
      ? `${i+1}) ${teams} ¬∑ ${m} ¬∑ ${ev}`
      : `${i+1}) ${teams} (${sportName}) ¬∑ ${m} ¬∑ ${ev}`;

    // ÎßÅÌÅ¨ Ìè¨Ìï® (Í≤åÏãúÌåê Í∑úÏπô ÏòµÏÖò)
    if(allowItemLinks && i < linkN){
      const link = applyUtmToUrl(it.link || "", utm);
      const f = fmtUrlForBoard(link, shortUrl);
      if(f){
        if(compact) line += ` ¬∑ ÎßÅÌÅ¨ ${f}`;
        else{
          lines.push(line);
          lines.push(`   ÎßÅÌÅ¨: ${f}`);
          if(!compact) lines.push("");
          continue;
        }
      }
    }

    lines.push(line);
    if(!compact) lines.push("");
  }

  if(!allowItemLinks){
    if(!compact) lines.push("");
    lines.push("‚Äª Î≥µÏõê ÎßÅÌÅ¨Îäî Î∂ÑÏÑùÍ∏∞ÏóêÏÑú ‚ÄòÏò§Îäò ÏàòÏßë Î¨∂Ïùå‚Äô ‚Üí ‚ÄòÎ¨∏Íµ¨/ÎßÅÌÅ¨ Î≥µÏÇ¨‚ÄôÎ°ú ÏñªÏùÑ Ïàò ÏûàÏñ¥Ïöî.");
  }else if(linkN < nTotal){
    lines.push(`‚Äª ÎßÅÌÅ¨Îäî TOP${linkN}Îßå Ìè¨Ìï®(Í≤åÏãúÌåê Í∑úÏπô/ÌïÑÌÑ∞ ÎåÄÏùë).`);
  }

  lines.push("‚Äª ÎßÅÌÅ¨ Ïó¥Î©¥ ÏûÖÎ†•/Í≤∞Í≥ºÍ∞Ä Í∑∏ÎåÄÎ°ú Î≥µÏõêÎê©ÎãàÎã§(st)");

  // compact Ï†ïÎ¶¨
  let text = lines.join("\n");
  if(compact){
    text = text.replace(/\n{2,}/g,"\n").trim();
  }else{
    text = text.replace(/\n{3,}/g,"\n\n").trim();
  }

  text = sanitizePromoText(text, channelKey, presetOn);
  return { title: tpl.title, lead: tpl.lead, text, channelKey, styleKey, linksMode, shortUrl, compact, vendorInserted, oneTarget };
}

function updateBundlePromo(items, opts){
  const ta = document.getElementById("bundlePromoText");
  if(!ta) return;
  const p = buildBundlePromo(items || getBundleItems(10), opts||{});
  ta.value = p.text || "";
}


function toggleBundlePromoAdv(){
  const box = document.getElementById("bundlePromoAdv");
  const btn = document.getElementById("btnPromoAdv");
  if(!box) return;
  const isOpen = (box.style.display !== "none");
  box.style.display = isOpen ? "none" : "";
  if(btn) btn.textContent = isOpen ? "Í≥†Í∏â" : "Í≥†Í∏â Îã´Í∏∞";
  try{ localStorage.setItem(BUNDLE_PROMO_LS_ADV_OPEN, (!isOpen)?"1":"0"); }catch(e){}
}
function regenBundlePromo(){
  try{
    const items = getBundleItems(10);
    updateBundlePromo(items, { advanceVariant:true });
    toast("ÏÉà Î¨∏Íµ¨Î°ú Î∞îÍø®Ïñ¥Ïöî");
  }catch(e){}
}

async function copyBundlePromo(){
  const items = getBundleItems(10);
  if(!items.length) return;
  const p = buildBundlePromo(items, { advanceVariant:true });
  try{
    await navigator.clipboard.writeText(p.text);
    toast("ÌôçÎ≥¥Í∏ÄÏùÑ Î≥µÏÇ¨ÌñàÏäµÎãàÎã§");
    try{ track("bundle_copy_promo", { channel: p.channelKey, tone: p.styleKey, links: p.linksMode, short_url: p.shortUrl?1:0, compact: p.compact?1:0, vendor: p.vendorInserted?1:0, page_path: location.pathname }); }catch(e){}
  }catch(e){ toast("Î≥µÏÇ¨ Ïã§Ìå®"); }
}

async function copyBundlePromoTitle(){
  const items = getBundleItems(10);
  if(!items.length) return;
  const p = buildBundlePromo(items);
  try{
    await navigator.clipboard.writeText(p.title);
    toast("Ï†úÎ™©ÏùÑ Î≥µÏÇ¨ÌñàÏäµÎãàÎã§");
    try{ track("bundle_copy_promo_title", { channel: p.channelKey, tone: p.styleKey, page_path: location.pathname }); }catch(e){}
  }catch(e){ toast("Î≥µÏÇ¨ Ïã§Ìå®"); }
}

async function copyBundlePromoLead(){
  const items = getBundleItems(10);
  if(!items.length) return;
  const p = buildBundlePromo(items);
  try{
    await navigator.clipboard.writeText(p.lead);
    toast("ÎßêÎ®∏Î¶¨Î•º Î≥µÏÇ¨ÌñàÏäµÎãàÎã§");
    try{ track("bundle_copy_promo_lead", { channel: p.channelKey, tone: p.styleKey, page_path: location.pathname }); }catch(e){}
  }catch(e){ toast("Î≥µÏÇ¨ Ïã§Ìå®"); }
}

function setupBundlePromo(){
  const sel = document.getElementById("bundlePromoChannel");
  const sty = document.getElementById("bundlePromoStyle");
  const lnk = document.getElementById("bundlePromoLinks");
  const one = document.getElementById("bundlePromoOneTarget");
  const sh  = document.getElementById("bundlePromoShortUrl");
  const cp  = document.getElementById("bundlePromoCompact");
  const vd  = document.getElementById("bundlePromoVendor");
  const ps  = document.getElementById("bundlePromoPreset");
  const cm  = document.getElementById("bundlePromoComment");
  const vM  = document.getElementById("bundleVendorMargin");
  const vE  = document.getElementById("bundleVendorEv");
  const vMv = document.getElementById("bundleVendorMarginVal");
  const vEv = document.getElementById("bundleVendorEvVal");
  const adv = document.getElementById("bundlePromoAdv");
  const advBtn = document.getElementById("btnPromoAdv");
  if(!sel || !sty || !lnk) return;

  // options (only once)
  if(!sel.options.length){
    for(const ch of BUNDLE_PROMO_CHANNELS){
      const opt = document.createElement("option");
      opt.value = ch.key;
      opt.textContent = ch.label;
      sel.appendChild(opt);
    }
  }

  const savedCh    = localStorage.getItem(BUNDLE_PROMO_LS_CH) || "tochatsa";
  const savedStyle = localStorage.getItem(BUNDLE_PROMO_LS_STYLE);
  const savedLinks = localStorage.getItem(BUNDLE_PROMO_LS_LINKS) || "top3";
  const savedShort = localStorage.getItem(BUNDLE_PROMO_LS_SHORTURL);
  const savedComp  = localStorage.getItem(BUNDLE_PROMO_LS_COMPACT);
  const savedVend  = localStorage.getItem(BUNDLE_PROMO_LS_VENDOR);
  const savedOne   = localStorage.getItem(BUNDLE_PROMO_LS_ONE_TGT) || "analysis";
  const savedPreset = localStorage.getItem(BUNDLE_PROMO_LS_PRESET);
  const savedComm   = localStorage.getItem(BUNDLE_PROMO_LS_COMMENT);
  const savedVM     = localStorage.getItem(BUNDLE_PROMO_LS_VTHR_M);
  const savedVE     = localStorage.getItem(BUNDLE_PROMO_LS_VTHR_EVC);
  const savedAdv    = localStorage.getItem(BUNDLE_PROMO_LS_ADV_OPEN);

  if([...sel.options].some(o=>o.value===savedCh)) sel.value = savedCh;

  const ch = getPromoChannel(sel.value);
  const defStyle = (ch && ch.defaultStyle) ? ch.defaultStyle : "promo";
  if(savedStyle && [...sty.options].some(o=>o.value===savedStyle)) sty.value = savedStyle;
  else sty.value = defStyle;

  // ÌîÑÎ¶¨ÏÖã ÏûêÎèô Ï†ÅÏö©(Ï¥àÍ∏∞)
  try{
    clearPresetEnforcement();
    applyPresetToUI(sel.value, !!(ps && ps.checked));
  }catch(e){}

  if([...lnk.options].some(o=>o.value===savedLinks)) lnk.value = savedLinks;

  if(one && [...one.options].some(o=>o.value===savedOne)) one.value = savedOne;

  if(sh) sh.checked = (savedShort==="1" || savedShort==="true");
  if(cp) cp.checked = (savedComp==="1"  || savedComp==="true");
  if(vd) vd.checked = (savedVend==null ? true : (savedVend==="1" || savedVend==="true"));
  if(ps) ps.checked = (savedPreset==null ? true : (savedPreset==="1" || savedPreset==="true"));
  if(cm) cm.checked = (savedComm==="1" || savedComm==="true");

  // vendor thresholds
  if(vM){
    const vm = (savedVM!=null) ? parseFloat(savedVM) : parseFloat(vM.value);
    if(vm>=0) vM.value = String(vm);
    if(vMv) vMv.textContent = parseFloat(vM.value).toFixed(1);
  }
  if(vE){
    const ve = (savedVE!=null) ? parseInt(savedVE,10) : parseInt(vE.value,10);
    if(ve>=0) vE.value = String(ve);
    if(vEv) vEv.textContent = String(parseInt(vE.value,10));
  }

  // advanced panel open state
  if(adv){
    const open = (savedAdv==="1" || savedAdv==="true");
    adv.style.display = open ? "" : "none";
    if(advBtn) advBtn.textContent = open ? "Í≥†Í∏â Îã´Í∏∞" : "Í≥†Í∏â";
  }

  // apply preset (initial)
  try{
    clearPresetEnforcement();
    applyPresetToUI(sel.value, !!(ps && ps.checked));
  }catch(e){}
  if(ps) ps.checked = (savedPreset==null ? true : (savedPreset==="1" || savedPreset==="true"));
  if(cm) cm.checked = (savedComm==="1" || savedComm==="true");
  if(vM){
    const vm = (savedVM!=null) ? parseFloat(savedVM) : parseFloat(vM.value);
    if(vm>=0) vM.value = String(vm);
  }
  if(vE){
    const ve = (savedVE!=null) ? parseInt(savedVE,10) : parseInt(vE.value,10);
    if(ve>=0) vE.value = String(ve);
  }
  if(vMv && vM) vMv.textContent = parseFloat(vM.value).toFixed(1);
  if(vEv && vE) vEv.textContent = String(parseInt(vE.value,10));
  // Í≥†Í∏â Ìå®ÎÑê ÏÉÅÌÉú Î≥µÏõê
  try{
    const adv = document.getElementById("bundlePromoAdv");
    const btn = document.getElementById("btnPromoAdv");
    const open = (savedAdv==="1" || savedAdv==="true");
    if(adv) adv.style.display = open ? "" : "none";
    if(btn) btn.textContent = open ? "Í≥†Í∏â Îã´Í∏∞" : "Í≥†Í∏â";
  }catch(e){}

  const refresh = (advanceVariant=false)=>{
    try{ localStorage.setItem(BUNDLE_PROMO_LS_CH, sel.value); }catch(e){}
    try{ localStorage.setItem(BUNDLE_PROMO_LS_STYLE, sty.value); }catch(e){}
    try{ localStorage.setItem(BUNDLE_PROMO_LS_LINKS, lnk.value); }catch(e){}
    try{ if(sh) localStorage.setItem(BUNDLE_PROMO_LS_SHORTURL, sh.checked?"1":"0"); }catch(e){}
    try{ if(cp) localStorage.setItem(BUNDLE_PROMO_LS_COMPACT,  cp.checked?"1":"0"); }catch(e){}
    try{ if(vd) localStorage.setItem(BUNDLE_PROMO_LS_VENDOR,   vd.checked?"1":"0"); }catch(e){}
    try{ if(one) localStorage.setItem(BUNDLE_PROMO_LS_ONE_TGT, one.value); }catch(e){}
    try{ if(ps) localStorage.setItem(BUNDLE_PROMO_LS_PRESET, ps.checked?"1":"0"); }catch(e){}
    try{ if(cm) localStorage.setItem(BUNDLE_PROMO_LS_COMMENT, cm.checked?"1":"0"); }catch(e){}
    try{ if(vM) localStorage.setItem(BUNDLE_PROMO_LS_VTHR_M, String(parseFloat(vM.value))); }catch(e){}
    try{ if(vE) localStorage.setItem(BUNDLE_PROMO_LS_VTHR_EVC, String(parseInt(vE.value,10))); }catch(e){}
    try{ if(vMv && vM) vMv.textContent = parseFloat(vM.value).toFixed(1); }catch(e){}
    try{ if(vEv && vE) vEv.textContent = String(parseInt(vE.value,10)); }catch(e){}

    if(one){
      one.style.display = (lnk.value==="one") ? "" : "none";
    }

    try{
      clearPresetEnforcement();
      applyPresetToUI(sel.value, !!(ps && ps.checked));
    }catch(e){}

    try{
      const items = getBundleItems(10);
      updateBundlePromo(items, { advanceVariant: !!advanceVariant });
    }catch(e){}
  };

  sel.addEventListener("change", ()=>{
    const ch2 = getPromoChannel(sel.value);
    const presetOn = !!(ps && ps.checked);
    if(!presetOn && ch2 && ch2.defaultStyle) sty.value = ch2.defaultStyle;
    refresh(true);
  });
  sty.addEventListener("change", ()=>refresh(true));
  lnk.addEventListener("change", ()=>{
    try{
      if(cm && lnk.value==="none" && localStorage.getItem(BUNDLE_PROMO_LS_COMMENT)==null) cm.checked = true;
    }catch(e){}
    refresh(true);
  });
  if(one) one.addEventListener("change", ()=>refresh(true));
  if(sh)  sh.addEventListener("change", ()=>refresh(true));
  if(cp)  cp.addEventListener("change", ()=>refresh(true));
  if(vd)  vd.addEventListener("change", ()=>refresh(true));

  refresh(false);
}


function downloadBundleCard(){
  const canvas = document.getElementById("bundleCanvas");
  if(!canvas) return;
  try{
    canvas.toBlob((blob)=>{
      if(!blob) return;
      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = "88-bundle-today.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 800);
      toast("Ïù¥ÎØ∏ÏßÄÎ•º Ï†ÄÏû•ÌñàÏäµÎãàÎã§");
      try{ track("bundle_download_image", { page_path: location.pathname }); }catch(e){}
    }, "image/png", 1.0);
  }catch(e){ toast("Ï†ÄÏû• Ïã§Ìå®"); }
}

function setupBundleBackdropClose(){
  const modal = document.getElementById("bundleShareModal");
  if(!modal) return;
  modal.addEventListener("click", (e)=>{
    if(e.target === modal) closeBundleShare();
  });
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      try{ if(modal.style.display === "flex") closeBundleShare(); }catch(err){}
    }
  });
}

function setupShareCardBackdropClose(){
  const modal = document.getElementById("shareCardModal");
  if(modal){
    modal.addEventListener("click", (e)=>{
      if(e.target === modal) closeShareCard();
    });
  }
}

/* =========================
   ÌÜ†Ïä§Ìä∏
========================= */
let toastTimer=null;
function toast(msg){
  const el=document.getElementById("toast88");
  if(!el) return;
  el.textContent=msg;
  el.style.opacity="1";
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{ el.style.opacity="0"; }, 1400);
}

/* =========================
   ÎßàÏßÑ ÎåÄÏãúÎ≥¥Îìú Î†åÎçî
========================= */
function renderMarginDash(last){
  const sport = last?.sport || val("sport") || "soccer";
  const cfg = SPORT_CFG[sport] || SPORT_CFG.soccer;

  // ÏûÖÎ†•ÏóêÏÑú Ï¶âÏÑùÏúºÎ°úÎèÑ Í≥ÑÏÇ∞ Í∞ÄÎä•(Í≥ÑÏÇ∞ Ï†ÑÏóêÎèÑ Í∏∞Î≥∏ ÌëúÏãú)
  const is3 = (cfg.main==="3way");
  let main = null;
  try{
    if(is3){
      const h=parseOdds(val("main3OddsH")), d=parseOdds(val("main3OddsD")), a=parseOdds(val("main3OddsA"));
      if(h && d && a) main = compute3Way(h,d,a).marginPct;
    }else{
      const a=parseOdds(val("main2OddsA")), b=parseOdds(val("main2OddsB"));
      if(a && b) main = compute2Way(a,b,0).marginPct;
    }
  }catch(e){}

  let ou = null;
  try{
    const o=parseOdds(val("overOdds")), u=parseOdds(val("underOdds"));
    if(o && u){
      let push = parsePct(val("ouPush"));
      if(push==null) push=(cfg.defaults.ouPush||0)/100;
      ou = compute2Way(o,u,push).marginPct;
    }
  }catch(e){}

  let hc = null;
  try{
    const a=parseOdds(val("handicapOddsA")), b=parseOdds(val("handicapOddsB"));
    if(a && b){
      let push = parsePct(val("handicapPush"));
      if(push==null) push=(cfg.defaults.hcPush||0)/100;
      hc = compute2Way(a,b,push).marginPct;
    }
  }catch(e){}

  if(last){
    if(typeof last.main === "number") main = last.main;
    if(typeof last.ou === "number") ou = last.ou;
    if(typeof last.hc === "number") hc = last.hc;
  }

  const items = [
    { key:"main", title:"Î©îÏù∏", margin: main },
    { key:"ou", title:"Ïò§Î≤Ñ/Ïñ∏Îçî", margin: ou },
    { key:"hc", title:"Ìï∏ÎîîÏ∫°", margin: hc }
  ];

  const html = items.map(it=>{
    if(typeof it.margin !== "number"){
      return `
        <div class="m-card">
          <div class="m-head">
            <div class="m-name">${it.title}</div>
            <div class="chip mid">ÎØ∏ÏûÖÎ†•</div>
          </div>
          <div class="m-lines">Î∞∞ÎãπÏùÑ ÏûÖÎ†•ÌïòÎ©¥ ÎßàÏßÑ/ÌåêÏ†ïÏù¥ ÌëúÏãúÎê©ÎãàÎã§.</div>
        </div>
      `;
    }
    const ÌåêÏ†ï = classifyMargin(sport, it.key, it.margin);
    return `
      <div class="m-card">
        <div class="m-head">
          <div class="m-name">${it.title}</div>
          <div class="chip ${ÌåêÏ†ï.cls}">${ÌåêÏ†ï.label}</div>
        </div>
        <div class="m-lines">
          Í∏∞Ï§Ä(ÎÇÆÏùå/Î≥¥ÌÜµ/Ï£ºÏùò): <b>${MARGIN_RULE[sport][it.key][0]}%</b> / <b>${MARGIN_RULE[sport][it.key][1]}%</b> / <b>${MARGIN_RULE[sport][it.key][2]}%</b>
        </div>
      </div>
    `;
  }).join("");

  const box = document.getElementById("marginDash");
  if(box) box.innerHTML = html;
}

/* =========================
   ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû•/Î≥µÏõê/ÎπÑÍµê
========================= */
function readHistory(){
  try{
    const raw = localStorage.getItem(HIST_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    return [];
  }
}
function writeHistory(arr){
  localStorage.setItem(HIST_KEY, JSON.stringify(arr.slice(0,50)));
}
function addHistory(rec){
  // ÎßàÏßÑ ÏóÜÏúºÎ©¥ Ï†ÄÏû• ÏïàÌï®? -> ÏµúÏÜå Î©îÏù∏ ÏûàÏúºÎãà Ï†ÄÏû•
  const arr = readHistory();
  arr.unshift(rec);
  writeHistory(arr);

  try{
    track("save_history", {
      sport: rec.sport,
      level: rec.level,
      market_type: (rec.mainMode ? rec.mainMode : (((SPORT_CFG[rec.sport]||SPORT_CFG.soccer).main === "3way") ? "3way" : "2way"))
    });
  }catch(e){}

  renderHistory();
  syncToggleLabels();
}
function clearHistory(){
  if(!confirm("ÌûàÏä§ÌÜ†Î¶¨Î•º Î™®Îëê ÏÇ≠Ï†úÌï†ÍπåÏöî?")) return;
  localStorage.removeItem(HIST_KEY);
  renderHistory();
  renderTop3();
  toast("ÌûàÏä§ÌÜ†Î¶¨ ÏÇ≠Ï†ú ÏôÑÎ£å");
}


/* =========================
   Ï†ïÏ∞©/Ï†ïÌôïÎèÑ Ï≤¥Í∞êÏö© UX Î†àÏù¥Ïñ¥
   - Í≥ÑÏÇ∞ Î°úÏßÅ Î≥ÄÍ≤Ω ÏóÜÏùå
   - ÏûÖÎ†• Í≤ÄÏ¶ù/Ïä§ÎÉÖÏÉ∑/ÎÇ¥ ÏÑ±Í≥º(ÏäπÌå® Í∏∞Î°ù)Îßå Ï∂îÍ∞Ä
========================= */

// ÌåêÎã®(Ï∂îÏ≤ú/Ï£ºÏùò/PASS) ÌÇ§
function adviceKeyFromMetrics(bestEVPct, mainMarginPct){
  const ev = (typeof bestEVPct==="number") ? bestEVPct : null; // %
  const m = (typeof mainMarginPct==="number") ? mainMarginPct : null; // %
  if(ev!=null){
    if(ev >= 2) return "rec";
    if(ev >= 0) return "caution";
    return "pass";
  }
  if(m!=null){
    if(m <= 3) return "rec";
    if(m <= 6) return "caution";
    return "pass";
  }
  return "caution";
}
function adviceKeyForRecord(h){
  return adviceKeyFromMetrics(h?.bestEVPct, h?.markets?.main?.marginPct);
}
function adviceInfoForKey(key){
  if(key==="rec") return { text:"Ï∂îÏ≤ú", cls:"good" };
  if(key==="pass") return { text:"PASS", cls:"bad" };
  return { text:"Ï£ºÏùò", cls:"warn" };
}

// Ïäπ/Ìå®/Ï∑®ÏÜå ÎùºÎ≤®
function outcomeInfo(v){
  if(v==="W") return { text:"‚úÖ Ï†ÅÏ§ë", cls:"win" };
  if(v==="L") return { text:"‚ùå ÎØ∏Ï†ÅÏ§ë", cls:"lose" };
  if(v==="V") return { text:"‚ö™ Ï∑®ÏÜå", cls:"void" };
  return { text:"ÎØ∏Í∏∞Î°ù", cls:"none" };
}

// ÌûàÏä§ÌÜ†Î¶¨ Í≤∞Í≥º Í∏∞Î°ù(Ïäπ/Ìå®/Ï∑®ÏÜå)
function setOutcome(id, v){
  const arr = readHistory();
  const idx = arr.findIndex(x=>x.id===id);
  if(idx<0){
    toast("ÌûàÏä§ÌÜ†Î¶¨ÏóêÏÑú Ìï≠Î™©ÏùÑ Ï∞æÏßÄ Î™ªÌñàÏñ¥Ïöî.");
    return;
  }
  const next = (v==="W"||v==="L"||v==="V") ? v : "";
  arr[idx].outcome = next || null;
  arr[idx].outcomeAt = next ? Date.now() : null;

  // advice Î©îÌÉÄÍ∞Ä ÏóÜÎçò ÏòàÏ†Ñ Ìï≠Î™©ÎèÑ Î≥¥Ï†ï
  if(!arr[idx].advice){
    arr[idx].advice = adviceKeyForRecord(arr[idx]);
  }
  writeHistory(arr);
  renderHistory();         // ÎÇ¥Î∂ÄÏóêÏÑú renderPerfBoxÎèÑ Ìò∏Ï∂úÎê®
  refreshTrustLine();
  toast(next ? "Í≤∞Í≥º Í∏∞Î°ù ÏôÑÎ£å" : "Í∏∞Î°ù Ìï¥Ï†ú ÏôÑÎ£å");
}
function markOutcome(v){
  if(!LAST_RECORD || !LAST_RECORD.id){
    toast("Î®ºÏ†Ä Í≥ÑÏÇ∞ Í≤∞Í≥ºÎ•º ÎßåÎì† Îí§ Í∏∞Î°ùÌï† Ïàò ÏûàÏñ¥Ïöî.");
    return;
  }
  setOutcome(LAST_RECORD.id, v);
}

// ÎÇ¥ ÏÑ±Í≥º ÏßëÍ≥Ñ
function computePerfStats(){
  const arr = readHistory();
  const init = ()=>({ w:0, l:0, v:0, n:0, rate:null });
  const out = { total:init(), by:{ rec:init(), caution:init(), pass:init() } };

  arr.forEach(h=>{
    const key = (h.advice || adviceKeyForRecord(h));
    const bucket = out.by[key] || out.by.caution;
    const tgtAll = out.total;

    const o = h.outcome;
    if(o==="W"){ bucket.w++; tgtAll.w++; }
    else if(o==="L"){ bucket.l++; tgtAll.l++; }
    else if(o==="V"){ bucket.v++; tgtAll.v++; }
  });

  const finalize = (b)=>{
    b.n = b.w + b.l;
    b.rate = (b.n>0) ? (b.w / b.n) : null;
    return b;
  };
  finalize(out.total);
  Object.keys(out.by).forEach(k=>finalize(out.by[k]));
  return out;
}
function pct(x){
  if(x==null) return "‚Äî";
  return Math.round(x*100) + "%";
}

// ÎÇ¥ ÏÑ±Í≥º Î∞ïÏä§ Î†åÎçî
function renderPerfBox(){
  const box = document.getElementById("perfBox");
  const grid = document.getElementById("perfGrid");
  const sub = document.getElementById("perfSub");
  const meta = document.getElementById("perfMeta");
  if(!box || !grid || !sub || !meta) return;

  const s = computePerfStats();
  const totalN = s.total.n;
  if(totalN<=0 && (s.total.v<=0)){
    box.style.display = "none";
    return;
  }
  box.style.display = "block";

  meta.textContent = `ÌëúÎ≥∏ ${totalN} ¬∑ Ï∑®ÏÜå ${s.total.v}`;
  sub.innerHTML = `ÎÇ¥Í∞Ä <b>Í≤∞Í≥º(Ï†ÅÏ§ë/ÎØ∏Ï†ÅÏ§ë)</b>Î•º Ï≤¥ÌÅ¨Ìïú Ìï≠Î™©Îßå ÏßëÍ≥ÑÎê©ÎãàÎã§. ÌëúÎ≥∏Ïù¥ Ï†ÅÏúºÎ©¥ ÏàòÏπòÎäî Ï∞∏Í≥†Ïö©ÏûÖÎãàÎã§.`;

  const makeTile = (label, key)=>{
    const b = s.by[key];
    const info = adviceInfoForKey(key);
    return `
      <div class="perf-tile">
        <div class="perf-k">${label} <span class="${info.cls}"><b>${info.text}</b></span></div>
        <div class="perf-v">${pct(b.rate)}</div>
        <div class="perf-n">n=${b.n} (Ï†ÅÏ§ë ${b.w} / ÎØ∏Ï†ÅÏ§ë ${b.l})</div>
      </div>
    `;
  };

  grid.innerHTML = `
    ${makeTile("Ï∂îÏ≤úÏùº Îïå", "rec")}
    ${makeTile("Ï£ºÏùòÏùº Îïå", "caution")}
    ${makeTile("PASSÏùº Îïå", "pass")}
  `;
}

// Í≤∞Í≥º ÏÉÅÎã®Ïóê ‚ÄúÎÇ¥ Í∏∞Î°ù Í∏∞Ï§Ä‚Äù Ïã†Î¢∞ ÎùºÏù∏
function buildTrustLineHtml(adviceKey){
  const s = computePerfStats();
  const b = s.by[adviceKey] || s.by.caution;
  const info = adviceInfoForKey(adviceKey);

  if(b.n < 10){
    return `ÎÇ¥ Í∏∞Î°ù Í∏∞Ï§Ä: <b>ÌëúÎ≥∏ Î∂ÄÏ°±</b> (ÌòÑÏû¨ n=${b.n}). ÏïÑÎûò <b>ÏÉÅÏÑ∏ ÏßÄÌëú</b>ÍπåÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî.`;
  }
  return `ÎÇ¥ Í∏∞Î°ù Í∏∞Ï§Ä: <span class="${info.cls}"><b>${info.text}</b></span> Íµ¨Í∞Ñ Ï†ÅÏ§ëÎ•† <b>${pct(b.rate)}</b> (n=${b.n}).`;
}
function refreshTrustLine(){
  const tl = document.querySelector(".trustLine");
  const hc = document.querySelector(".heroConclusion");
  if(!tl || !hc) return;
  let key = "caution";
  if(hc.classList.contains("good")) key = "rec";
  else if(hc.classList.contains("bad")) key = "pass";
  tl.innerHTML = buildTrustLineHtml(key);
}

// ===== ÏµúÍ∑º ÏûÖÎ†• Ïä§ÎÉÖÏÉ∑(ÏµúÍ∑º 5Í∞ú) =====
function readSnaps(){
  try{
    const raw = localStorage.getItem(SNAP_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}
function writeSnaps(arr){
  localStorage.setItem(SNAP_KEY, JSON.stringify(arr.slice(0,5)));
}
function stateSig(state){
  // ÎÑàÎ¨¥ Ïû¶ÏùÄ Ïä§ÎÉÖÏÉ∑ÏùÑ ÎßâÍ∏∞ ÏúÑÌïú Í∞ÑÎã® ÏãúÍ∑∏ÎãàÏ≤ò
  const keys = ["sport","level","league","teams","main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA","totalLine","overOdds","underOdds","handicapLine","handicapOddsA","handicapOddsB","myProb","myOverProb"];
  const o = {};
  keys.forEach(k=>o[k]=state?.[k] ?? "");
  return JSON.stringify(o);
}
function maybePushSnapshot(state, force){
  if(!state) return;
  try{
    const now = Date.now();
    const sig = stateSig(state);
    const metaRaw = localStorage.getItem(SNAP_META_KEY);
    const meta = metaRaw ? JSON.parse(metaRaw) : {};
    const lastAt = meta?.lastAt || 0;
    const lastSig = meta?.lastSig || "";

    if(!force){
      if(now - lastAt < 20000) return;  // 20Ï¥à Ïø®Îã§Ïö¥
      if(sig === lastSig) return;
    }

    const arr = readSnaps();
    const id = now.toString(36) + Math.random().toString(36).slice(2,6);
    arr.unshift({
      id,
      at: now,
      sport: state.sport,
      level: state.level,
      league: state.league,
      teams: state.teams,
      state
    });
    writeSnaps(arr);

    localStorage.setItem(SNAP_META_KEY, JSON.stringify({ lastAt: now, lastSig: sig }));
  }catch(e){}
}
function renderSnaps(){
  const wrap = document.getElementById("snapWrap");
  const list = document.getElementById("snapList");
  const meta = document.getElementById("snapMeta");
  if(!wrap || !list || !meta) return;

  const arr = readSnaps();
  if(!view.length){
    wrap.style.display = "none";
    return;
  }
  wrap.style.display = "block";
  meta.textContent = `Ï¥ù ${arr.length}Í∞ú`;

  list.innerHTML = arr.map(s=>{
    const d = new Date(s.at);
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    const cfg = SPORT_CFG[s.sport] || {name:s.sport||"-"};
    const lev = levelLabel(s.level);
    const label = `${hh}:${mm} ¬∑ ${cfg.name} ¬∑ ${lev}`;
    const extra = (s.teams || s.league) ? escapeHtml(s.teams || s.league) : "";
    return `<button class="snap-chip" type="button" onclick="restoreSnapshot('${s.id}')">${label}${extra?` <span class="snap-meta">¬∑ ${extra}</span>`:""}</button>`;
  }).join("");

  // Ïù¥ÎØ∏ Ï†ÄÏû•Îêú Ìï≠Î™© ÌëúÏãú
  try{ if(__PASTE_SAVED_SIGS.size===0) buildSavedSigSet(); }catch(e){}
  try{
    __PASTE_MULTI.forEach((g, idx)=>{
      if(!g) return;
      if(pasteAlreadySaved(g)){
        const el = $("pasteItem_"+idx);
        if(el) el.classList.add("is-saved");
        const stat = $("pasteStat_"+idx);
        if(stat){ stat.innerHTML = "Ï†ÄÏû•Îê®"; stat.style.display="block"; }
      }
    });
  }catch(e){}
}
function restoreSnapshot(id){
  const arr = readSnaps();
  const s = arr.find(x=>x.id===id);
  if(!s || !s.state){
    toast("Ïä§ÎÉÖÏÉ∑ÏùÑ Ï∞æÏßÄ Î™ªÌñàÏñ¥Ïöî.");
    return;
  }
  const st = s.state;

  setVal("sport", st.sport || "soccer");
  setVal("level", st.level || "simple");
  setVal("league", st.league || "");
  setVal("teams", st.teams || "");

  setVal("main2OddsA", st.main2OddsA || "");
  setVal("main2OddsB", st.main2OddsB || "");
  setVal("main3OddsH", st.main3OddsH || "");
  setVal("main3OddsD", st.main3OddsD || "");
  setVal("main3OddsA", st.main3OddsA || "");

  setVal("totalLine", st.totalLine || "");
  setVal("overOdds", st.overOdds || "");
  setVal("underOdds", st.underOdds || "");
  setVal("ouPush", st.ouPush || "");

  setVal("handicapLine", st.handicapLine || "");
  setVal("handicapOddsA", st.handicapOddsA || "");
  setVal("handicapOddsB", st.handicapOddsB || "");
  setVal("handicapPush", st.handicapPush || "");

  setVal("myProb", st.myProb || "");
  setVal("myOverProb", st.myOverProb || "");
  setVal("stake", st.stake || "");

  // ÌéºÏπ® ÏÉÅÌÉú Î≥µÏõê
  if(typeof st.handicapCollapsed==="boolean"){
    setCollapsed("handicapBody", !!st.handicapCollapsed);
  }
  if(typeof st.totalCollapsed==="boolean"){
    setCollapsed("totalBody", !!st.totalCollapsed);
  }

  onSportChange(true);
  onLevelChange(true);
  hideResult();
  renderMarginDash();
  saveState();
  toast("ÏµúÍ∑º ÏûÖÎ†•ÏùÑ Î≥µÏõêÌñàÏñ¥Ïöî.");
  try{ quickJump("main"); }catch(e){}
}

// ===== ÏûÖÎ†• Í≤ÄÏ¶ù/Í∞ÄÏù¥Îìú(Ïã§Ïàò Í∞êÏÜå) =====
let _vTimer = null;
function setupValidation(){
  const oddsIds = ["main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA","overOdds","underOdds","handicapOddsA","handicapOddsB"];
  const lineIds = ["totalLine","handicapLine"];
  const pushIds = ["ouPush","handicapPush"];
  const stakeIds = ["stake"];
  const probSingleIds = ["myOverProb"]; // single % (0~100)
  const probMultiId = "myProb"; // 2-way: single %, 3-way: "45,28,27" etc

  const allIds = oddsIds
    .concat(lineIds)
    .concat(pushIds)
    .concat(stakeIds)
    .concat([probMultiId])
    .concat(probSingleIds);

  const onAnyInput = ()=>{
    if(_vTimer) clearTimeout(_vTimer);
    _vTimer = setTimeout(()=>{ validateInputs(); }, 80);
  };

  function keepOneDot(s){
    const parts = s.split(".");
    if(parts.length<=2) return s;
    return parts[0] + "." + parts.slice(1).join("");
  }
  function keepMinusAtStart(s){
    // remove '-' not at start; keep at most one leading '-'
    s = s.replace(/(?!^)-/g,"");
    if(s.startsWith("--")) s = "-" + s.slice(2).replace(/-/g,"");
    return s;
  }

  allIds.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;

    el.addEventListener("input", (e)=>{
      const t = String(e.target.value || "");
      let s = t;

      if(oddsIds.includes(id) || pushIds.includes(id)){
        // decimal number (odds, push%) ‚Äî allow digits + dot
        s = s.replace(/,/g,".").replace(/[^\d.]/g,"");
        s = keepOneDot(s);
      }else if(lineIds.includes(id)){
        // line can be negative (e.g. -1.5)
        s = s.replace(/,/g,".").replace(/[^\d.\-]/g,"");
        s = keepMinusAtStart(s);
        s = keepOneDot(s);
      }else if(stakeIds.includes(id)){
        // integer money
        s = s.replace(/[^\d]/g,"");
      }else if(id === probMultiId){
        // allow "45,28,27" / "45 28 27" / "45/28/27" / "55"
        s = s.replace(/[^\d.,\/\s%]/g,"");
        s = s.replace(/%/g,"");
        s = s.replace(/Ôºå/g,",");
        s = s.replace(/\s+/g," ");
        // keep as-is to preserve separators
      }else if(probSingleIds.includes(id)){
        s = s.replace(/,/g,".").replace(/[^\d.]/g,"");
        s = keepOneDot(s);
      }

      e.target.value = s;
      onAnyInput();
    });

    el.addEventListener("blur", ()=>{ onAnyInput(); });
  });

  // Ï¥àÍ∏∞ Í≤ÄÏ¶ù
  validateInputs();
}
function setInvalid(id, on){
  const el = document.getElementById(id);
  if(!el) return;
  if(on) el.classList.add("invalid");
  else el.classList.remove("invalid");
}
function showInputWarn(msg){
  const box = document.getElementById("inputWarn");
  if(!box) return;
  if(!msg){
    box.style.display="none";
    box.innerHTML="";
    return;
  }
  box.style.display="block";
  box.innerHTML = msg;
}
function validateInputs(){
  // Í∏∞Î≥∏: Î™®Îì† invalid Ï†úÍ±∞
  ["main2OddsA","main2OddsB","main3OddsH","main3OddsD","main3OddsA","overOdds","underOdds","handicapOddsA","handicapOddsB","totalLine","handicapLine","myProb","myOverProb"].forEach(id=>setInvalid(id,false));

  const sport = val("sport");
  const cfg = SPORT_CFG[sport] || SPORT_CFG.soccer;
  const mainType = cfg.main;

  // Î©îÏù∏ ÌïÑÏàò Í≤ÄÏ¶ù
  let mainOk = true;
  let mainMsg = "";

  const oddsOk = (id)=>{
    const x = parseOdds(val(id));
    return (x!=null && x>=1.01 && x<=200);
  };

  if(mainType==="2way"){
    const aOk = oddsOk("main2OddsA");
    const bOk = oddsOk("main2OddsB");
    if(!aOk){ setInvalid("main2OddsA", true); mainOk=false; }
    if(!bOk){ setInvalid("main2OddsB", true); mainOk=false; }
    if(!mainOk) mainMsg = "Î©îÏù∏ Î∞∞Îãπ(2Í∞ú)ÏùÑ Î®ºÏ†Ä ÏûÖÎ†•ÌïòÏÑ∏Ïöî. Ïòà: <b>1.85</b> / <b>2.05</b>";
  }else{
    const hOk = oddsOk("main3OddsH");
    const dOk = oddsOk("main3OddsD");
    const aOk = oddsOk("main3OddsA");
    if(!hOk){ setInvalid("main3OddsH", true); mainOk=false; }
    if(!dOk){ setInvalid("main3OddsD", true); mainOk=false; }
    if(!aOk){ setInvalid("main3OddsA", true); mainOk=false; }
    if(!mainOk) mainMsg = "Î©îÏù∏ Î∞∞Îãπ(3Í∞ú)ÏùÑ Î®ºÏ†Ä ÏûÖÎ†•ÌïòÏÑ∏Ïöî. Ïòà: <b>2.10</b> / <b>3.20</b> / <b>3.40</b>";
  }

  // ÏòµÏÖò ÏûÖÎ†•(Î∂ÄÎ∂Ñ ÏûÖÎ†• Ïãú Í≤ΩÍ≥†)
  const totalAny = !!(val("totalLine") || val("overOdds") || val("underOdds"));
  const totalOk = !totalAny || (!!val("totalLine") && oddsOk("overOdds") && oddsOk("underOdds"));
  if(totalAny && !totalOk){
    if(!val("totalLine")) setInvalid("totalLine", true);
    if(!oddsOk("overOdds")) setInvalid("overOdds", true);
    if(!oddsOk("underOdds")) setInvalid("underOdds", true);
  }

  const hcAny = !!(val("handicapLine") || val("handicapOddsA") || val("handicapOddsB"));
  const hcOk = !hcAny || (!!val("handicapLine") && oddsOk("handicapOddsA") && oddsOk("handicapOddsB"));
  if(hcAny && !hcOk){
    if(!val("handicapLine")) setInvalid("handicapLine", true);
    if(!oddsOk("handicapOddsA")) setInvalid("handicapOddsA", true);
    if(!oddsOk("handicapOddsB")) setInvalid("handicapOddsB", true);
  }

  // ÌôïÎ•† ÏûÖÎ†•(Ï§ëÍ∏â/Í≥†Í∏âÏóêÏÑúÎßå ÏùòÎØ∏)
  const level = val("level");

  const probOkMyProb = ()=>{
    const t = String(val("myProb") || "").trim();
    if(!t) return true;

    // 3-way Ï¢ÖÎ™©: "45,28,27" Í∞ôÏùÄ 3Í∞ú ÏûÖÎ†•ÏùÑ Í∂åÏû•(Ìï© 100 ÏïÑÎãàÎ©¥ ÏûêÎèô Ï†ïÍ∑úÌôî)
    if(mainType !== "2way"){
      return !!parsePctList(t);
    }

    // 2-way: Îã®Ïùº Í∞í(0~100)
    return (parsePct(t) != null);
  };

  const probOkMyOver = ()=>{
    const t = String(val("myOverProb") || "").trim();
    if(!t) return true;
    return (parsePct(t) != null);
  };

  let probWarn = "";
  if(level!=="simple"){
    if(!probOkMyProb()){
      setInvalid("myProb", true);
      probWarn = (mainType !== "2way")
        ? "ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†ÏùÄ <b>ÏâºÌëú/Í≥µÎ∞±/Ïä¨ÎûòÏãú</b>Î°ú 3Í∞ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî. Ïòà: <b>45,28,27</b>"
        : "ÎÇ¥ ÏòàÏÉÅ ÌôïÎ•†ÏùÄ <b>0~100</b> ÏÇ¨Ïù¥ Ïà´ÏûêÎ°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî.";
    }
    if(!probOkMyOver()){
      setInvalid("myOverProb", true);
      if(!probWarn) probWarn = "Ïò§Î≤Ñ ÏòàÏÉÅ ÌôïÎ•†ÏùÄ <b>0~100</b> ÏÇ¨Ïù¥ Ïà´ÏûêÎ°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî.";
    }
  }

  // Î≤ÑÌäº ÌôúÏÑ±Ìôî/ÏïàÎÇ¥
  const btn = document.getElementById("btnCalc");
  if(btn) btn.disabled = !mainOk;

  const warnMsgs = [];
  if(!mainOk) warnMsgs.push(mainMsg);
  if(totalAny && !totalOk) warnMsgs.push("Ïò§Î≤Ñ¬∑Ïñ∏ÎçîÎäî <b>Í∏∞Ï§ÄÏ†ê + Ïò§Î≤Ñ/Ïñ∏Îçî Î∞∞Îãπ</b>ÏùÑ Î™®Îëê Ï±ÑÏö∞Î©¥ Î∂ÑÏÑùÎê©ÎãàÎã§.");
  if(hcAny && !hcOk) warnMsgs.push("Ìï∏ÎîîÏ∫°ÏùÄ <b>ÎùºÏù∏ + ÏñëÏ™Ω Î∞∞Îãπ</b>ÏùÑ Î™®Îëê Ï±ÑÏö∞Î©¥ Î∂ÑÏÑùÎê©ÎãàÎã§.");
  if(probWarn) warnMsgs.push(probWarn);

  showInputWarn(warnMsgs.length ? ("‚ö†Ô∏è ÏûÖÎ†• ÌôïÏù∏<br>" + warnMsgs.map(s=>"‚Ä¢ "+s).join("<br>")) : "");
  return mainOk;
}

/* ÌûàÏä§ÌÜ†Î¶¨ UI */
let pickSet = new Set();
let historyFilter = "all";

function setHistoryFilter(f, btn){
  historyFilter = f;
  // ÌïÑÌÑ∞ Î∞îÍæ∏Î©¥ ÏÑ†ÌÉùÏùÄ Ï¥àÍ∏∞Ìôî(ÌòºÎèô Î∞©ÏßÄ)
  pickSet.clear();
  const wrap = document.querySelector(".history-filters");
  if(wrap){
    wrap.querySelectorAll(".seg").forEach(x=>x.classList.remove("on"));
  }
  if(btn) btn.classList.add("on");
  renderHistory();
}
function updatePickUI(){
  const n = pickSet.size;
  const c = document.getElementById("pickCount");
  if(c) c.textContent = String(n);
  const del = document.getElementById("btnDeleteSelected");
  if(del) del.disabled = (n===0);
  const cmp = document.getElementById("btnCompare");
  if(cmp) cmp.disabled = (n!==2);
}
function deleteSelected(){
  const ids = Array.from(pickSet);
  if(ids.length===0){
    toast("ÏÇ≠Ï†úÌï† Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî");
    return;
  }
  if(!confirm(`ÏÑ†ÌÉùÌïú ${ids.length}Í∞ú Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?`)) return;

  let arr = readHistory();
  arr = arr.filter(x=>!pickSet.has(x.id));
  writeHistory(arr);
  pickSet.clear();

  renderHistory();
  renderTop3();
  toast("ÏÑ†ÌÉù ÏÇ≠Ï†ú ÏôÑÎ£å");
}



function renderHistory(){
  const list = document.getElementById("historyList");
  if(!list) return;

  const arr = readHistory();

  // ÏÑ†ÌÉù Ï†ïÎ¶¨(ÏÇ≠Ï†ú/ÌïÑÌÑ∞ Îì±ÏúºÎ°ú ÏÇ¨ÎùºÏßÑ Ìï≠Î™© Ï†úÍ±∞)
  const idset = new Set(arr.map(x=>x.id));
  pickSet = new Set(Array.from(pickSet).filter(id=>idset.has(id)));

  // ÌïÑÌÑ∞ Ï†ÅÏö©
  let view = arr;
  if(historyFilter === "rec"){
    view = arr.filter(h => (h.advice || adviceKeyForRecord(h)) === "rec");
  }else if(historyFilter === "untracked"){
    view = arr.filter(h => !h.outcome);
  }
  // v2.1: HTML Íµ¨Ï°∞ÍπåÏßÄ ÌÖúÌîåÎ¶øÏúºÎ°ú Í≥†Ï†ï
  const mountEmpty = (title, desc, mode)=>{
    const tpl = document.getElementById("tplHistoryEmpty");
    list.innerHTML = "";
    if(tpl && tpl.content){
      const frag = tpl.content.cloneNode(true);
      const t = frag.querySelector('[data-slot="title"]');
      const d = frag.querySelector('[data-slot="desc"]');
      if(t) t.textContent = title;
      if(d) d.innerHTML = desc;

      // ÌïÑÌÑ∞ Í≤∞Í≥º ÏóÜÏùåÏùº ÎïåÎäî ÏòàÏãú Î≤ÑÌäºÏùÑ Ïà®Í∏∞Í≥† Ï†ÑÏ≤¥ Î≥¥Í∏∞ Î≤ÑÌäºÏùÑ ÎÖ∏Ï∂ú
      if(mode === "filtered"){
        const btns = frag.querySelector('.demo-btns');
        if(btns) btns.style.display = "none";
        const note = frag.querySelector('.demo-note');
        if(note) note.innerHTML = `ÌïÑÌÑ∞Î•º Î∞îÍæ∏Í±∞ÎÇò <b>Ï†ÑÏ≤¥</b>Î°ú ÎêòÎèåÎ†§ Î≥¥ÏÑ∏Ïöî.`;
      }
      list.appendChild(frag);
    }else{
      list.innerHTML = `
        <div class="demo-empty">
          <div class="demo-title">${escapeHtml(title)}</div>
          <div class="demo-desc">${desc}</div>
        </div>`;
    }
  };

  if(!arr.length){
    mountEmpty("ÌûàÏä§ÌÜ†Î¶¨Í∞Ä ÎπÑÏñ¥ÏûàÏñ¥Ïöî.", "ÏïÑÎûò <b>ÏòàÏãú Î≤ÑÌäº</b>ÏùÑ ÎàåÎü¨ ÏûÖÎ†•ÏùÑ ÏûêÎèô Ï±ÑÏö∞Í≥†, Î∞îÎ°ú Í≥ÑÏÇ∞ÍπåÏßÄ Ïã§ÌñâÌï¥Î≥º Ïàò ÏûàÏñ¥Ïöî.", "empty");
    renderPerfBox();
    updatePickUI();
    initHistoryListEvents();
    return;
  }

  if(!view.length){
    mountEmpty("Ï°∞Í±¥Ïóê ÎßûÎäî Í∏∞Î°ùÏù¥ ÏóÜÏñ¥Ïöî.", "ÌïÑÌÑ∞ Ï°∞Í±¥Ïóê ÎßûÎäî Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§. <b>Ï†ÑÏ≤¥</b>Î°ú Î∞îÍæ∏Í±∞ÎÇò ÏÉàÎ°ú Í≥ÑÏÇ∞Ìï¥Î≥¥ÏÑ∏Ïöî.", "filtered");
    renderPerfBox();
    updatePickUI();
    initHistoryListEvents();
    return;
  }

  list.innerHTML = "";
  const itemTpl = document.getElementById("tplHistoryItem");
  const fragAll = document.createDocumentFragment();

  view.forEach(h=>{
    const cfg = SPORT_CFG[h.sport] || {name:h.sport||"-"};
    const mMain = h.markets?.main?.marginPct;
    const mOU = h.markets?.ou?.marginPct;
    const mHC = h.markets?.hc?.marginPct;

    const mainTag = (typeof mMain==="number") ? classifyMargin(h.sport,"main",mMain) : null;
    const ouTag = (typeof mOU==="number") ? classifyMargin(h.sport,"ou",mOU) : null;
    const hcTag = (typeof mHC==="number") ? classifyMargin(h.sport,"hc",mHC) : null;

    const evTxt = (typeof h.bestEVPct==="number") ? `${h.bestEVPct.toFixed(2)}%` : "-";
    const evCls = (h.evPositive) ? "good" : "warn";

    const adviceKey = (h.advice || adviceKeyForRecord(h));
    const adviceInfo = adviceInfoForKey(adviceKey);
    const out = outcomeInfo(h.outcome);

    let node;
    if(itemTpl && itemTpl.content){
      const one = itemTpl.content.cloneNode(true);
      node = one.querySelector('[data-role="history-item"]');
      if(node){
        node.dataset.id = h.id;
        const titleEl = node.querySelector('[data-slot="title"]');
        const subEl = node.querySelector('[data-slot="sub"]');
        const outTagEl = node.querySelector('[data-slot="outTag"]');
        const pickEl = node.querySelector('input[data-h-action="pick"]');

        if(titleEl) titleEl.textContent = `${h.time} ¬∑ ${cfg.name} ¬∑ ${levelLabel(h.level)}${h.teams?` ¬∑ ${cleanTeam(h.teams)}`:""}`;

        if(subEl) subEl.innerHTML = `
          Î©îÏù∏: ${mainTag?`<span class="${clsToTextColor(mainTag.cls)}">${mainTag.label}</span>`:"-"} /
          OU: ${ouTag?`<span class="${clsToTextColor(ouTag.cls)}">${ouTag.label}</span>`:"-"} /
          Ìï∏Îîî: ${hcTag?`<span class="${clsToTextColor(hcTag.cls)}">${hcTag.label}</span>`:"-"}
          <br>
          ÏµúÍ≥† EV: <span class="${evCls}"><b>${evTxt}</b></span> ¬∑
          ÌåêÎã®: <span class="${adviceInfo.cls}"><b>${adviceInfo.text}</b></span>
        `;

        if(outTagEl){
          outTagEl.className = `outTag ${out.cls}`;
          outTagEl.textContent = out.text;
        }

        // outcome Î≤ÑÌäº on ÏÉÅÌÉú
        node.querySelectorAll('button[data-h-action="outcome"]').forEach(btn=>{
          const v = btn.getAttribute('data-outcome') || "";
          const on = (v && h.outcome===v) || (!v && !h.outcome);
          btn.classList.toggle('on', !!on);
        });

        if(pickEl) pickEl.checked = pickSet.has(h.id);
      }
      fragAll.appendChild(one);
    }
  });

  list.appendChild(fragAll);

  renderPerfBox();
  updatePickUI();
  initHistoryListEvents();
}

// v2.1: ÌûàÏä§ÌÜ†Î¶¨ Î¶¨Ïä§Ìä∏ Ïù¥Î≤§Ìä∏(Íµ¨Ï°∞ Ïª¥Ìè¨ÎÑåÌä∏ÌôîÏóê ÎßûÏ∂ò ÏúÑÏûÑ Ï≤òÎ¶¨)
function initHistoryListEvents(){
  const list = document.getElementById("historyList");
  if(!list || list.__bound) return;
  list.__bound = true;

  // Ïπ¥Îìú ÌÅ¥Î¶≠/Î≤ÑÌäº ÌÅ¥Î¶≠
  list.addEventListener("click", (e)=>{
    const demoBtn = e.target.closest("[data-demo]");
    if(demoBtn){
      const mode = demoBtn.getAttribute("data-demo");
      if(mode === "soccer") loadDemo("soccer");
      else if(mode === "basketball") loadDemo("basketball");
      return;
    }

    const actionEl = e.target.closest("[data-h-action]");
    if(actionEl){
      const item = actionEl.closest('[data-role="history-item"]');
      const id = item?.dataset?.id;
      const act = actionEl.getAttribute("data-h-action");

      if(act === "outcome"){
        if(!id) return;
        const v = actionEl.getAttribute("data-outcome") || "";
        setOutcome(id, v);
        return;
      }
      if(act === "restoreCalc"){
        if(!id) return;
        restoreFromHistory(id, true);
        return;
      }
      if(act === "restoreOnly"){
        if(!id) return;
        restoreFromHistory(id, false);
        return;
      }
      // checkboxÎäî changeÏóêÏÑú Ï≤òÎ¶¨
      return;
    }

    const item = e.target.closest('[data-role="history-item"]');
    if(item && item.dataset.id){
      onHistoryClick(null, item.dataset.id);
    }
  });

  list.addEventListener("change", (e)=>{
    const cb = e.target.closest('input[data-h-action="pick"]');
    if(!cb) return;
    const item = cb.closest('[data-role="history-item"]');
    const id = item?.dataset?.id;
    if(!id) return;
    togglePick(id, cb.checked);
  });

  list.addEventListener("keydown", (e)=>{
    if(e.key !== "Enter" && e.key !== " ") return;
    const item = e.target.closest('[data-role="history-item"]');
    if(!item || !item.dataset.id) return;
    // Î≤ÑÌäº/Ï≤¥ÌÅ¨Î∞ïÏä§ Ìè¨Ïª§Ïä§ÏóêÏÑúÎäî Í∏∞Î≥∏ ÎèôÏûë Ïú†ÏßÄ
    if(e.target && (e.target.tagName === "BUTTON" || e.target.tagName === "INPUT")) return;
    e.preventDefault();
    onHistoryClick(null, item.dataset.id);
  });
}

/* ÌûàÏä§ÌÜ†Î¶¨ ÌÅ¥Î¶≠(ÏïÑÏù¥ÌÖú ÏòÅÏó≠) -> Ï¶âÏãú Î≥µÏõê+Ïû¨Í≥ÑÏÇ∞ */
function onHistoryClick(evt, id){
  try{ track("history_open", { page_path: location.pathname }); }catch(e){}
  // ÎÇ¥Î∂Ä Î≤ÑÌäº ÌÅ¥Î¶≠ÏùÄ stopPropagation Ï≤òÎ¶¨ÎêòÏñ¥ Ïó¨Í∏∞ Ïïà Ïò¥
  restoreFromHistory(id, true);
}

function togglePick(id, on){
  if(on) pickSet.add(id);
  else pickSet.delete(id);
  updatePickUI();
}

function restoreFromHistory(id, doCalc){
  const arr = readHistory();
  const h = arr.find(x=>x.id===id);
  if(!h) return;

  // Í∏∞Î≥∏ ÏÖÄÎ†âÌä∏
  setVal("sport", h.sport);
  setVal("level", h.level);
  onSportChange(true);
  onLevelChange(true);

  // ÌÖçÏä§Ìä∏
  setVal("league", h.league || "");
  setVal("teams", h.teams || "");

  // Î©îÏù∏
  if(h.inputs.main2OddsA!=null) setVal("main2OddsA", h.inputs.main2OddsA);
  if(h.inputs.main2OddsB!=null) setVal("main2OddsB", h.inputs.main2OddsB);
  if(h.inputs.main3OddsH!=null) setVal("main3OddsH", h.inputs.main3OddsH);
  if(h.inputs.main3OddsD!=null) setVal("main3OddsD", h.inputs.main3OddsD);
  if(h.inputs.main3OddsA!=null) setVal("main3OddsA", h.inputs.main3OddsA);

  // EV ÏûÖÎ†•
  if(h.inputs.myProb!=null) setVal("myProb", h.inputs.myProb);
  if(h.inputs.stake!=null) setVal("stake", h.inputs.stake);

  // Ìï∏Îîî
  if(h.inputs.handicapLine!=null) setVal("handicapLine", h.inputs.handicapLine);
  if(h.inputs.handicapOddsA!=null) setVal("handicapOddsA", h.inputs.handicapOddsA);
  if(h.inputs.handicapOddsB!=null) setVal("handicapOddsB", h.inputs.handicapOddsB);
  if(h.inputs.handicapPush!=null) setVal("handicapPush", h.inputs.handicapPush);

  // OU
  if(h.inputs.totalLine!=null) setVal("totalLine", h.inputs.totalLine);
  if(h.inputs.overOdds!=null) setVal("overOdds", h.inputs.overOdds);
  if(h.inputs.underOdds!=null) setVal("underOdds", h.inputs.underOdds);
  if(h.inputs.ouPush!=null) setVal("ouPush", h.inputs.ouPush);
  if(h.inputs.myOverProb!=null) setVal("myOverProb", h.inputs.myOverProb);

  saveState();
  renderMarginDash();

  // Ïä§ÌÅ¨Î°§
  scrollToCalc();

  if(doCalc){
    calc();
    toast("Î≥µÏõê ÌõÑ Ïû¨Í≥ÑÏÇ∞ ÏôÑÎ£å");
  }else{
    toast("ÏûÖÎ†• Î≥µÏõê ÏôÑÎ£å");
  }
}

/* ÎπÑÍµê Î™®Îã¨ */
function openCompare(){
  const ids = Array.from(pickSet);
  if(ids.length !== 2){
    toast("ÎπÑÍµêÌï† Ìï≠Î™© 2Í∞úÎ•º Ï≤¥ÌÅ¨Ìï¥ Ï£ºÏÑ∏Ïöî");
    return;
  }
  const arr = readHistory();
  const a = arr.find(x=>x.id===ids[0]);
  const b = arr.find(x=>x.id===ids[1]);
  if(!a || !b){
    toast("ÏÑ†ÌÉùÌïú Ìï≠Î™©ÏùÑ Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§");
    return;
  }

  const grid = document.getElementById("compareGrid");
  if(!grid) return;

  grid.innerHTML = `
    ${renderCompareCol(a, "A")}
    ${renderCompareCol(b, "B")}
  `;

  document.getElementById("compareModal").style.display="flex";
}
function closeCompare(){
  document.getElementById("compareModal").style.display="none";
}
function renderCompareCol(h, tag){
  const cfg = SPORT_CFG[h.sport] || SPORT_CFG.soccer;

  const mainM = h.markets?.main?.marginPct;
  const ouM = h.markets?.ou?.marginPct;
  const hcM = h.markets?.hc?.marginPct;

  const mainTag = (typeof mainM==="number") ? classifyMargin(h.sport,"main",mainM) : null;
  const ouTag = (typeof ouM==="number") ? classifyMargin(h.sport,"ou",ouM) : null;
  const hcTag = (typeof hcM==="number") ? classifyMargin(h.sport,"hc",hcM) : null;

  const evTxt = (typeof h.bestEVPct==="number") ? `${h.bestEVPct.toFixed(2)}%` : "-";

  return `
    <div class="compare-col">
      <div class="ct">${tag} ¬∑ ${h.time} ¬∑ ${cfg.name} ¬∑ ${levelLabel(h.level)}</div>
      <div class="line"><div class="k">Î¶¨Í∑∏</div><div class="v">${h.league?escapeHtml(h.league):"-"}</div></div>
      <div class="line"><div class="k">Í≤ΩÍ∏∞</div><div class="v">${h.teams?escapeHtml(h.teams):"-"}</div></div>
      <div class="line"><div class="k">Î©îÏù∏ ÎßàÏßÑ</div><div class="v">${mainTag?`<span class="${clsToTextColor(mainTag.cls)}">${mainTag.label}</span>`:"-"}</div></div>
      <div class="line"><div class="k">OU ÎßàÏßÑ</div><div class="v">${ouTag?`<span class="${clsToTextColor(ouTag.cls)}">${ouTag.label}</span>`:"-"}</div></div>
      <div class="line"><div class="k">Ìï∏Îîî ÎßàÏßÑ</div><div class="v">${hcTag?`<span class="${clsToTextColor(hcTag.cls)}">${hcTag.label}</span>`:"-"}</div></div>
      <div class="line"><div class="k">ÏµúÍ≥† EV</div><div class="v">${h.evPositive?`<span class="good">${evTxt}</span>`:`<span class="warn">${evTxt}</span>`}</div></div>

      <div class="mini-actions">
        <button class="restore" type="button" onclick="restoreFromHistory('${h.id}', true)">Ïù¥ Ìï≠Î™© Î≥µÏõê+Ïû¨Í≥ÑÏÇ∞</button>
        <button class="close" type="button" onclick="closeCompare()">Îã´Í∏∞</button>
      </div>
    </div>
  `;
}

/* ÏïàÏ†ÑÌïú ÌÖçÏä§Ìä∏ ÌëúÏãú */
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   TOP3 Î†åÎçî (Î©îÏù∏/OU/Ìï∏Îîî Í∞ÅÍ∞Å)
========================= */
function renderTop3(){
  const arr = readHistory().filter(x=>x.date===todayStr());
  const topMain = arr.filter(x=>typeof x.markets?.main?.marginPct==="number")
    .sort((a,b)=>a.markets.main.marginPct - b.markets.main.marginPct).slice(0,3);
  const topOU = arr.filter(x=>typeof x.markets?.ou?.marginPct==="number")
    .sort((a,b)=>a.markets.ou.marginPct - b.markets.ou.marginPct).slice(0,3);
  const topHC = arr.filter(x=>typeof x.markets?.hc?.marginPct==="number")
    .sort((a,b)=>a.markets.hc.marginPct - b.markets.hc.marginPct).slice(0,3);

  renderTopList("topMain", topMain, "main");
  renderTopList("topOU", topOU, "ou");
  renderTopList("topHC", topHC, "hc");
}
function renderTopList(id, list, type){
  const el = document.getElementById(id);
  if(!el) return;
  if(!list.length){
    el.innerHTML = "Ïò§Îäò Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.";
    return;
  }
  el.innerHTML = list.map((h,i)=>{
    const cfg = SPORT_CFG[h.sport] || SPORT_CFG.soccer;
    const m = h.markets[type].marginPct;
    const tag = classifyMargin(h.sport, type, m);
    const text = `${i+1}) ${h.time} ¬∑ ${cfg.name}${h.teams?` ¬∑ ${escapeHtml(h.teams)}`:""} ¬∑ ${tag.label}`;
    return `<div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06);">
      <a href="#calcCard" onclick="restoreFromHistory('${h.id}', true)" style="color:inherit;text-decoration:none;">
        <span class="${clsToTextColor(tag.cls)}"><b>${text}</b></span>
      </a>
    </div>`;
  }).join("").replace(/border-bottom:1px solid rgba\(255,255,255,.06\);\"><\/div>$/,"\">");
}

/* =========================
   Ï¥àÍ∏∞ Íµ¨Îèô
========================= */

/* =========================
   Î∂ÑÏÑùÍ∏∞ ÏßÑÏûÖ Í¥ëÍ≥† ÌåùÏóÖ (ÏßÄÏó∞ ÎÖ∏Ï∂ú)
   - "ÏßÑÏûÖ"Ïù¥ ÏïÑÎãàÎùº "Î∂ÑÏÑù ÏôÑÎ£å" Ïù¥ÌõÑÏóêÎßå 1Ïùº 1Ìöå ÎÖ∏Ï∂ú
   - indexÏùò ÌÅ¥Î¶≠ ÌûàÏä§ÌÜ†Î¶¨(ÏûàÏúºÎ©¥)Î°ú 2Í∞ú Ïö∞ÏÑ† ÎÖ∏Ï∂ú
========================= */

let _AD_PREPARED = false;
function prepareAdPopup(){
  if(_AD_PREPARED) return;

  // index.html ÌÅ¥Î¶≠ ÏßëÍ≥Ñ(ÏûàÏúºÎ©¥ ÌôúÏö©)
  let clickMap = {};
  try{ clickMap = JSON.parse(localStorage.getItem("88_card_clicks") || "{}") || {}; }
  catch(e){ clickMap = {}; }

  // Î©îÏù∏ ÌéòÏù¥ÏßÄ ÏÉÅÎã® Ïö∞ÏÑ† ÏóÖÏ≤¥ + Í¥ëÍ≥†Î™®Ïßë Ìè¨Ìï®
  const ads = [
    {key:"card1", title:"SPEED Bet", sub:"Í≥†Ïï°Ï†ÑÏö© ¬∑ ÏûÖÍ∏àÌîåÎü¨Ïä§ ÏßÄÏõê", href:"/speed/", badge:"Ï∂îÏ≤ú"},
    {key:"card2", title:"OK Bet", sub:"Í≥†Ïï°Ï†ÑÏö© ¬∑ ÌéòÏù¥Î∞±/Ï∂úÏÑù", href:"/ok/", badge:"Ï∂îÏ≤ú"},
    {key:"card3", title:"Ïñ¥ÎäêÎÇ†", sub:"Í≥†Ïï°Ï†ÑÏö©¬∑ ÎØ∏ÎãàÍ≤åÏûÑ ¬∑ Î¨¥Ï†úÏ†ú ", href:"/cert/", badge:"Ï∂îÏ≤ú"},
    {key:"card7", title:"Í¥ëÍ≥† Î™®Ïßë", sub:"Ïó¨Í∏∞Ïóê Í¥ëÍ≥†Í∞Ä ÎÖ∏Ï∂úÎê©ÎãàÎã§", href:"/cert/", badge:"AD"},
    {key:"card8", title:"Í¥ëÍ≥† Î™®Ïßë", sub:"Î¨∏Ïùò ÌõÑ Îì±Î°ù Í∞ÄÎä•", href:"/cert/", badge:"AD"}
  ];

  const ranked = [...ads].sort((a,b)=> Number(clickMap[b.key]||0) - Number(clickMap[a.key]||0));
  const picks = ranked.slice(0,2);

  const grid = document.getElementById("adGrid");
  if(!grid) return;

  grid.innerHTML = picks.map(x=>`
    <div class="ad-item" onclick="goAd('${x.href}')">
      <div class="name">${x.title}</div>
      <div class="sub">${x.sub}</div>
      <div class="badge">${x.badge}</div>
    </div>
  `).join("");

  _AD_PREPARED = true;
}

function maybeShowAdPopupAfterComplete(){
  const KEY = "88_analysis_adpopup_date";
  const today = new Date().toISOString().slice(0,10);

  try{ if(localStorage.getItem(KEY) === today) return; }catch(e){}

  const pop = document.getElementById("adPopup");
  if(!pop) return;

  prepareAdPopup();
  pop.style.display = "flex";

  try{ track("ad_popup_view", { page_path: location.pathname, trigger: "after_complete" }); }catch(e){}
}

function goAd(href){
  // ÌÅ¥Î¶≠ ÌõÑÏóêÎäî Ïò§Îäò ÌïòÎ£® Ïû¨ÎÖ∏Ï∂ú Î∞©ÏßÄ(1Ïùº 1Ìöå Ï†ïÏ±Ö)
  try{
    const today = new Date().toISOString().slice(0,10);
    localStorage.setItem("88_analysis_adpopup_date", today);
  }catch(e){}

  // ÏïàÏ†ÑÏû•Ïπò: javascript: ÎßÅÌÅ¨ Ï∞®Îã®
  if(typeof href !== "string") return;
  const h = href.trim();
  if(h.toLowerCase().startsWith("javascript:")) return;

  location.href = h;
}
function closeAdPopup(disableToday){
  const pop = document.getElementById("adPopup");
  if(pop) pop.style.display = "none";
  if(disableToday){
    try{
      const today = new Date().toISOString().slice(0,10);
      localStorage.setItem("88_analysis_adpopup_date", today);
    }catch(e){}
  }
}

/* ===== Demo Loader (for empty history) ===== */
function loadDemo(kind){
  try{
    if(kind==="soccer"){
      setVal("sport","soccer");
      onSportChange(true);

      setVal("level","simple");
      onLevelChange(true);

      setVal("league","ÌîÑÎ¶¨ÎØ∏Ïñ¥Î¶¨Í∑∏ (ÏòàÏãú)");
      setVal("teams","ÌôàÌåÄ vs ÏõêÏ†ïÌåÄ");

      // 3-way Î©îÏù∏ Î∞∞Îãπ
      setVal("main3OddsH","1.95");
      setVal("main3OddsD","3.55");
      setVal("main3OddsA","3.95");

      // Ïò§Î≤Ñ/Ïñ∏Îçî ÏòàÏãú
      setVal("totalLine","2.5");
      setVal("overOdds","1.90");
      setVal("underOdds","1.95");

      // Ìï∏Îîî ÏòàÏãú
      setVal("handicapLine","-0.5");
      setVal("handicapOddsA","1.88");
      setVal("handicapOddsB","1.96");

    }else if(kind==="basketball"){
      setVal("sport","basketball");
      onSportChange(true);

      setVal("level","simple");
      onLevelChange(true);

      setVal("league","NBA (ÏòàÏãú)");
      setVal("teams","ÌôàÌåÄ vs ÏõêÏ†ïÌåÄ");

      // 2-way Î©îÏù∏ Î∞∞Îãπ
      setVal("main2OddsA","1.78");
      setVal("main2OddsB","2.05");

      // Ïò§Î≤Ñ/Ïñ∏Îçî ÏòàÏãú
      setVal("totalLine","223.5");
      setVal("overOdds","1.91");
      setVal("underOdds","1.91");

      // Ìï∏Îîî ÏòàÏãú
      setVal("handicapLine","-3.5");
      setVal("handicapOddsA","1.92");
      setVal("handicapOddsB","1.90");
    }

    // Î∞îÎ°ú Í≥ÑÏÇ∞ + Í≤∞Í≥ºÎ°ú Ïù¥Îèô
    calc();
    quickJump("result");
  }catch(e){
    console.error(e);
    toast("ÏòàÏãú Î°úÎî©Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî");
  }
}

/* ===== First-Visit Onboarding (3 tooltips) ===== */
const ONB_KEY = "onboard88_analysis_v1_done";
let onbIdx = 0;
const onbSteps = [
  {
    target: "mainBox",
    title: "Î∞∞ÎãπÎ∂ÄÌÑ∞ ÏûÖÎ†•",
    body: "Î©îÏù∏ Î∞∞ÎãπÏùÑ Î®ºÏ†Ä ÏûÖÎ†•Ìï¥Ïöî. (Ï∂ïÍµ¨Îäî Ìôà/Î¨¥/ÏõêÏ†ï, Îã§Î•∏ Ï¢ÖÎ™©ÏùÄ Ïäπ/Ìå®) ‚Äî ÏûÖÎ†•ÌïòÎ©¥ ÏïÑÎûò Í≤∞Í≥ºÍ∞Ä Îçî Ï†ïÌôïÌïòÍ≤å Ï†ïÎ¶¨ÎèºÏöî."
  },
  {
    target: "btnCalc",
    title: "Í≥ÑÏÇ∞ÌïòÍ∏∞",
    body: "Î∞∞Îãπ ÏûÖÎ†• ÌõÑ <b>Í≥ÑÏÇ∞ÌïòÍ∏∞</b>Î•º ÎàåÎü¨ Í≤∞Í≥ºÎ•º ÌôïÏù∏Ìï¥Ïöî. Í≤∞Í≥ºÎäî ÏûêÎèôÏúºÎ°ú ÌûàÏä§ÌÜ†Î¶¨Ïóê Ï†ÄÏû•Îê©ÎãàÎã§."
  },
  {
    target: "historyCard",
    title: "ÌûàÏä§ÌÜ†Î¶¨Î°ú Ïû¨Í≥ÑÏÇ∞/ÎπÑÍµê",
    body: "Ï†ÄÏû•Îêú ÌûàÏä§ÌÜ†Î¶¨Î•º ÌÅ¥Î¶≠ÌïòÎ©¥ <b>ÏûÖÎ†• Î≥µÏõê + Ï¶âÏãú Ïû¨Í≥ÑÏÇ∞</b>ÎèºÏöî. Ï≤¥ÌÅ¨ 2Í∞ú ÏÑ†ÌÉù ‚Üí ÎπÑÍµê(2Í∞ú ÎÇòÎûÄÌûà)ÎèÑ Í∞ÄÎä•Ìï¥Ïöî."
  }
];

function onbHighlightClear(){
  document.querySelectorAll(".onb-highlight").forEach(el=>el.classList.remove("onb-highlight"));
}

function onbPositionPopover(targetEl){
  const pop = document.getElementById("onbPopover");
  if(!pop || !targetEl) return;

  const r = targetEl.getBoundingClientRect();
  const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
  const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

  const margin = 12;
  const popW = Math.min(340, vw - 36);
  pop.style.width = popW + "px";

  // Í∏∞Î≥∏: ÌÉÄÍ≤ü ÏïÑÎûò Ïö∞Ï∏° Ï†ïÎ†¨, Í≥µÍ∞Ñ Î∂ÄÏ°±ÌïòÎ©¥ ÏúÑÎ°ú
  let top = r.bottom + 12;
  let left = Math.min(vw - popW - margin, Math.max(margin, r.left));

  // ÏïÑÎûò Í≥µÍ∞Ñ Î∂ÄÏ°±ÌïòÎ©¥ ÏúÑÎ°ú
  const popH = pop.offsetHeight || 180;
  if(top + popH > vh - margin){
    top = Math.max(margin, r.top - popH - 12);
  }

  pop.style.top = top + "px";
  pop.style.left = left + "px";
}

function onbRender(){
  const pop = document.getElementById("onbPopover");
  const t = document.getElementById("onbTitle");
  const s = document.getElementById("onbStep");
  const b = document.getElementById("onbBody");
  if(!pop || !t || !s || !b) return;

  const step = onbSteps[onbIdx];
  const el = document.getElementById(step.target);
  if(!el){
    // ÌÉÄÍ≤üÏù¥ ÏóÜÏúºÎ©¥ Ïä§ÌÇµ
    onbNext();
    return;
  }

  onbHighlightClear();
  el.classList.add("onb-highlight");

  t.innerText = step.title;
  s.innerText = `${onbIdx+1}/${onbSteps.length}`;
  b.innerHTML = step.body;

  pop.style.display = "block";
  // ÎÇ¥Ïö©Ïù¥ Î∞îÎÄê Îí§ ÎÜíÏù¥Î•º Í≥ÑÏÇ∞ÌïòÍ∏∞ ÏúÑÌï¥ Îã§Ïùå ÌîÑÎ†àÏûÑÏóêÏÑú ÏúÑÏπò Í≥ÑÏÇ∞
  requestAnimationFrame(()=>onbPositionPopover(el));
}

function onbStart(){
  try{
    const qs = new URLSearchParams(location.search);
    if(qs.get('onboard')==='1') localStorage.removeItem(ONB_KEY);
  }catch(e){}
  if(localStorage.getItem(ONB_KEY)==="1") return;
  onbIdx = 0;
  onbRender();
  // Ïä§ÌÅ¨Î°§/Î¶¨ÏÇ¨Ïù¥Ï¶à Ïãú ÌåùÏóÖ ÏúÑÏπò Ïú†ÏßÄ
  window.addEventListener("scroll", onbOnScroll, {passive:true});
  window.addEventListener("resize", onbOnScroll, {passive:true});
  document.addEventListener("keydown", onbOnKey);
}

function onbFinish(){
  localStorage.setItem(ONB_KEY,"1");
  onbClose();
}

function onbClose(){
  const pop = document.getElementById("onbPopover");
  if(pop) pop.style.display = "none";
  onbHighlightClear();
  window.removeEventListener("scroll", onbOnScroll);
  window.removeEventListener("resize", onbOnScroll);
  document.removeEventListener("keydown", onbOnKey);
}

function onbOnScroll(){
  const step = onbSteps[onbIdx];
  const el = document.getElementById(step.target);
  if(!el) return;
  onbPositionPopover(el);
}
function onbOnKey(e){
  if(e.key==="Escape") onbSkip();
  if(e.key==="ArrowRight" || e.key==="Enter") onbNext();
  if(e.key==="ArrowLeft") onbPrev();
}

function onbNext(){
  if(onbIdx >= onbSteps.length - 1){
    onbFinish();
    return;
  }
  onbIdx++;
  // ÌÉÄÍ≤üÏù¥ ÌôîÎ©¥ Î∞ñÏù¥Î©¥ Ìï¥Îãπ ÏúÑÏπòÎ°ú Ïä§ÌÅ¨Î°§
  const el = document.getElementById(onbSteps[onbIdx].target);
  if(el){
    try{ el.scrollIntoView({behavior:"smooth", block:"center"}); }catch(e){ el.scrollIntoView(); }
    setTimeout(onbRender, 200);
  }else{
    onbRender();
  }
}

function onbPrev(){
  if(onbIdx <= 0){
    onbIdx = 0;
    onbRender();
    return;
  }
  onbIdx--;
  const el = document.getElementById(onbSteps[onbIdx].target);
  if(el){
    try{ el.scrollIntoView({behavior:"smooth", block:"center"}); }catch(e){ el.scrollIntoView(); }
    setTimeout(onbRender, 200);
  }else{
    onbRender();
  }
}

function onbSkip(){
  onbFinish();
}

function boot(){
  try{ saveUtmFromUrl(); }catch(e){}
  const restored = restoreFromPermalink();
  if(!restored) loadState();
  if(!restored && !localStorage.getItem(LS_KEY)){
    setVal("sport","soccer");
    setVal("level","simple");
  }
  onSportChange(true);
  onLevelChange(true);
  initAppTabbar();
  renderHistory();
  renderTop3();
  renderMarginDash();
  restoreMiniGuide();
  // Ï≤´ Î∞©Î¨∏Ïûê 1Ìöå Ïò®Î≥¥Îî©(3Ïä§ÌÖù)
  setTimeout(()=>{ try{ onbStart(); }catch(e){} }, 450);
  setupShareCardBackdropClose();
  setupBundleBackdropClose();
  try{ setupBundlePromo(); }catch(e){}
  try{ updateBundleButton(); }catch(e){}
  setupValidation();
  setupPasteBox();

  renderSnaps();
  renderPerfBox();
  // ÏûÖÎ†• Ï§ë Îπ®Í∞Ñ ÌïòÏù¥ÎùºÏù¥Ìä∏ ÏûêÎèô Ìï¥Ï†ú
  document.querySelectorAll("input,select").forEach(el=>{
    el.addEventListener("input", ()=>el.classList.remove("is-invalid"));
    el.addEventListener("change", ()=>el.classList.remove("is-invalid"));
  });
  // Ï†ÄÏû• Î∞∞ÏßÄ Ï¥àÍ∏∞Ìôî
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      const st = JSON.parse(raw);
      updateSaveBadge(st && st.__savedAt);
    }else{
      updateSaveBadge(null);
    }
  }catch(e){
    updateSaveBadge(null);
  }

}
boot();

/* ===== UX v3: ÏõêÌÑ∞Ïπò Î∂ôÏó¨ÎÑ£Í∏∞ + Îç∞Ïä§ÌÅ¨ÌÉë 2Ìå®ÎÑê ===== */
(function(){
  function ready(fn){
    if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", fn);
    else fn();
  }
  ready(function(){
    // 1) Î∂ôÏó¨ÎÑ£Í∏∞ Î∞ïÏä§Î•º ÌÉ≠Î∞î ÏúÑÎ°ú(Îçî Ï†ÑÎ©¥) Ïù¥Îèô
    try{
      const pasteBox = document.getElementById("pasteBox");
      const tabbar = document.getElementById("appTabbar");
      if(pasteBox && tabbar && tabbar.parentNode){
        tabbar.parentNode.insertBefore(pasteBox, tabbar);
      }
    }catch(e){}

    // 2) Í∞ÑÎã® Î†àÎ≤®: "Î∂ôÏó¨ÎÑ£ÏûêÎßàÏûê Í≥ÑÏÇ∞" ÏõêÌÑ∞Ïπò
    try{
      const ta = document.getElementById("pasteInput");
      if(ta && !ta.dataset.autoRunBound){
        ta.dataset.autoRunBound = "1";
        ta.addEventListener("paste", function(){
          setTimeout(function(){
            const lvl = (typeof val==="function") ? val("level") : (document.getElementById("level")||{}).value;
            const auto = document.getElementById("pasteAutoRun");
            if(lvl === "simple" && auto && auto.checked){
              try{ applyPaste(true); }catch(e){}
            }
          }, 60);
        });
      }
    }catch(e){}

    // 3) Îç∞Ïä§ÌÅ¨ÌÉë: Ï§ëÍ∏â/Í≥†Í∏â Í≤∞Í≥ºÎ•º Ïö∞Ï∏° sticky Ìå®ÎÑêÎ°ú Î∂ÑÎ¶¨
    try{
      const card = document.getElementById("calcCard");
      if(card && !card.querySelector(".app-layout")){
        const divider = card.querySelector(".calc-divider");
        const controls = card.querySelector(".controls-settings");
        if(divider && controls){
          const layout = document.createElement("div");
          layout.className = "app-layout is-two";
          layout.id = "appLayout";

          const left = document.createElement("div");
          left.className = "app-left";
          left.id = "appLeft";

          const right = document.createElement("div");
          right.className = "app-right";
          right.id = "appRight";

          layout.appendChild(left);
          layout.appendChild(right);

          divider.insertAdjacentElement("afterend", layout);

          // Ïù¥Îèô ÎåÄÏÉÅ: controlsÎ∂ÄÌÑ∞ footer-linksÍπåÏßÄ(Îã®, result/resultDockÎäî Ïö∞Ï∏°ÏúºÎ°ú)
          let node = controls;
          const stopEl = card.querySelector(".footer-links");
          const resultEl = document.getElementById("result");
          const dockEl = document.getElementById("resultDock");

          while(node){
            const next = node.nextSibling;

            if(node === layout) break;
            if(node === resultEl || node === dockEl){
              // Ïö∞Ï∏°ÏúºÎ°ú ÎÇòÏ§ëÏóê Ïù¥Îèô
            }else{
              left.appendChild(node);
            }

            if(node === stopEl) break;
            node = next;
          }

          if(resultEl) right.appendChild(resultEl);
          if(dockEl) right.appendChild(dockEl);
        }
      }
    }catch(e){}
  });
})();

</script>
<!-- First-Visit Onboarding Popover -->
<div aria-label="Ï≤òÏùå Ïù¥Ïö© Í∞ÄÏù¥Îìú" aria-modal="true" id="onbPopover" role="dialog">
<div class="onb-hd">
<div class="onb-title" id="onbTitle">Ï≤òÏùå Ïù¥Ïö© Í∞ÄÏù¥Îìú</div>
<div class="onb-step" id="onbStep">1/3</div>
</div>
<div class="onb-body" id="onbBody"></div>
<div class="onb-actions">
<button class="btn onb-skip" onclick="onbSkip()" type="button">Í±¥ÎÑàÎõ∞Í∏∞</button>
<button class="btn secondary" onclick="onbPrev()" type="button">Ïù¥Ï†Ñ</button>
<button class="btn primary" onclick="onbNext()" type="button">Îã§Ïùå</button>
</div>
</div><style>
  .rel-links{max-width:1080px;margin:26px auto 34px;padding:14px 14px 16px;border-radius:18px;
    border:1px solid rgba(255,255,255,.10);background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
    box-shadow:0 14px 40px rgba(0,0,0,.35);}
  .rel-links h2{margin:0 0 10px;font-size:13px;letter-spacing:.02em;color:rgba(245,226,122,.92);font-weight:900;}
  .rel-grid{display:flex;flex-wrap:wrap;gap:8px;}
  .rel-grid a{text-decoration:none;color:var(--text-2);font-size:12px;padding:8px 10px;border-radius:999px;
    border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);}
  .rel-grid a:hover{border-color:rgba(245,226,122,.25);color:rgba(245,226,122,.92);}
</style>
</body>
</html>
