import{BetaAnalyticsDataClient as e}from"@google-analytics/data";async function topKeywords({client:e,property:t,date:r}){const[n]=await e.runReport({property:t,dateRanges:[{startDate:r,endDate:r}],dimensions:[{name:"customEvent:search_term"}],metrics:[{name:"eventCount"}],dimensionFilter:{filter:{fieldName:"eventName",stringFilter:{matchType:"EXACT",value:"search"}}},orderBys:[{metric:{metricName:"eventCount"},desc:!0}],limit:10});return(n.rows||[]).map(e=>({term:e.dimensionValues?.[0]?.value||"",count:Number(e.metricValues?.[0]?.value||0)})).filter(e=>e.term&&"(not set)"!==e.term&&e.count>0)}async function topCards({client:e,property:t,date:r}){const[n]=await e.runReport({property:t,dateRanges:[{startDate:r,endDate:r}],dimensions:[{name:"customEvent:card_id"}],metrics:[{name:"eventCount"}],dimensionFilter:{filter:{fieldName:"eventName",stringFilter:{matchType:"EXACT",value:"card_open"}}},orderBys:[{metric:{metricName:"eventCount"},desc:!0}],limit:5});return(n.rows||[]).map(e=>({id:e.dimensionValues?.[0]?.value||"",count:Number(e.metricValues?.[0]?.value||0)})).filter(e=>e.id&&"(not set)"!==e.id&&e.count>0)}export default async function handler(t,r){if(r.setHeader("Access-Control-Allow-Origin","*"),r.setHeader("Access-Control-Allow-Methods","GET,OPTIONS"),r.setHeader("Access-Control-Allow-Headers","Content-Type"),"OPTIONS"!==t.method)try{const{client:n,property:a}=function clientFromEnv(){const t=process.env.GA_PROPERTY_ID,r=process.env.GA_CLIENT_EMAIL,n=process.env.GA_PRIVATE_KEY;if(!t||!r||!n)throw new Error("Missing GA env vars (GA_PROPERTY_ID / GA_CLIENT_EMAIL / GA_PRIVATE_KEY)");const a=n.replace(/\\n/g,"\n");return{client:new e({credentials:{client_email:r,private_key:a}}),property:`properties/${t}`}}(),s=t.query&&t.query.date?String(t.query.date):function kstDateString(e=new Date){return new Date(e.getTime()+324e5).toISOString().slice(0,10)}(),[o,i]=await Promise.all([topKeywords({client:n,property:a,date:s}),topCards({client:n,property:a,date:s})]);r.setHeader("Cache-Control","s-maxage=300, stale-while-revalidate=600"),r.status(200).json({date:s,keywords:o,cards:i})}catch(e){r.status(500).json({error:String(e?.message||e)})}else r.status(200).end()}