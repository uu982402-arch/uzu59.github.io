import{BetaAnalyticsDataClient as e}from"@google-analytics/data";async function runTop({client:e,property:t,date:r,eventName:n,dimName:a,limit:o}){const[i]=await e.runReport({property:t,dateRanges:[{startDate:r,endDate:r}],dimensions:[{name:a}],metrics:[{name:"eventCount"}],dimensionFilter:{filter:{fieldName:"eventName",stringFilter:{matchType:"EXACT",value:n}}},orderBys:[{metric:{metricName:"eventCount"},desc:!0}],limit:o});return(i.rows||[]).map(e=>({key:e.dimensionValues?.[0]?.value||"",count:Number(e.metricValues?.[0]?.value||0)})).filter(e=>e.key&&"(not set)"!==e.key&&e.count>0)}export async function handler(t){const r={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,OPTIONS","Access-Control-Allow-Headers":"Content-Type","Cache-Control":"public, max-age=0, s-maxage=300, stale-while-revalidate=600"};if("OPTIONS"===t.httpMethod)return{statusCode:200,headers:r,body:""};try{const{client:n,property:a}=function clientFromEnv(){const t=process.env.GA_PROPERTY_ID,r=process.env.GA_CLIENT_EMAIL,n=process.env.GA_PRIVATE_KEY;if(!t||!r||!n)throw new Error("Missing GA env vars (GA_PROPERTY_ID / GA_CLIENT_EMAIL / GA_PRIVATE_KEY)");const a=n.replace(/\\n/g,"\n");return{client:new e({credentials:{client_email:r,private_key:a}}),property:`properties/${t}`}}(),o=t.queryStringParameters?.date||function kstDateString(e=new Date){return new Date(e.getTime()+324e5).toISOString().slice(0,10)}(),i=await runTop({client:n,property:a,date:o,eventName:"search",dimName:"customEvent:search_term",limit:10}),s=await runTop({client:n,property:a,date:o,eventName:"card_open",dimName:"customEvent:card_id",limit:5});return{statusCode:200,headers:r,body:JSON.stringify({date:o,keywords:i.map(e=>({term:e.key,count:e.count})),cards:s.map(e=>({id:e.key,count:e.count}))})}}catch(e){return{statusCode:500,headers:r,body:JSON.stringify({error:String(e?.message||e)})}}}